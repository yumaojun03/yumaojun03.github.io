<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="kubernetes," />





  <link rel="alternate" href="/atom.xml" title="紫川秀的博客" type="application/atom+xml" />






<meta name="description" content="搭建kubernetes集群最大的麻烦其实不在于其复杂度(相对Openstack集群)而在于有GFW, 所以为了避免墙带来的麻烦, 也为了加深对kubernetes的理解, 这里将使用纯手工离线的方式进行部署(相应的文件我已经下载到百度云盘里面)。">
<meta name="keywords" content="kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes 1.8.7 离线部署手册(一)">
<meta property="og:url" content="https://blog.yumaojun.net/2018/01/18/kubernetes-binary-install/index.html">
<meta property="og:site_name" content="紫川秀的博客">
<meta property="og:description" content="搭建kubernetes集群最大的麻烦其实不在于其复杂度(相对Openstack集群)而在于有GFW, 所以为了避免墙带来的麻烦, 也为了加深对kubernetes的理解, 这里将使用纯手工离线的方式进行部署(相应的文件我已经下载到百度云盘里面)。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://oiw1gzfww.bkt.clouddn.com/architecture.png">
<meta property="og:updated_time" content="2018-02-03T09:40:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kubernetes 1.8.7 离线部署手册(一)">
<meta name="twitter:description" content="搭建kubernetes集群最大的麻烦其实不在于其复杂度(相对Openstack集群)而在于有GFW, 所以为了避免墙带来的麻烦, 也为了加深对kubernetes的理解, 这里将使用纯手工离线的方式进行部署(相应的文件我已经下载到百度云盘里面)。">
<meta name="twitter:image" content="http://oiw1gzfww.bkt.clouddn.com/architecture.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.yumaojun.net/2018/01/18/kubernetes-binary-install/"/>





  <title>kubernetes 1.8.7 离线部署手册(一) | 紫川秀的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">紫川秀的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">比你优秀的人不可怕,可怕的是比你优秀的人比你更努力。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.yumaojun.net/2018/01/18/kubernetes-binary-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="紫川秀">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oiw1gzfww.bkt.clouddn.com/me.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="紫川秀的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">kubernetes 1.8.7 离线部署手册(一)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-18T15:07:51+08:00">
                2018-01-18
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-02-03T17:40:07+08:00">
                2018-02-03
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/01/18/kubernetes-binary-install/" class="leancloud_visitors" data-flag-title="kubernetes 1.8.7 离线部署手册(一)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>搭建kubernetes集群最大的麻烦其实不在于其复杂度(相对Openstack集群)而在于有GFW, 所以为了避免墙带来的麻烦, 也为了加深对kubernetes的理解, 这里将使用纯手工离线的方式进行部署(相应的文件我已经下载到百度云盘里面)。<br><a id="more"></a></p>
<h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><p>下面Kubernetes集群搭建需要的版本信息:</p>
<table>
<thead>
<tr>
<th>软件</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>OS</td>
<td>CentOS Linux release 7.3.1611 (Core)</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>1.8.7</td>
</tr>
<tr>
<td>Docker</td>
<td>18.01.0-ce</td>
</tr>
<tr>
<td>Etcd</td>
<td>3.2.7</td>
</tr>
</tbody>
</table>
<p>我们将在四台CentOS系统的物理机上部署一个4个节点的kubernetes1.8.7集群(截止当前2018.1是最新版本):</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>Role</th>
<th>CPU</th>
<th>Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.204.3</td>
<td>master/node</td>
<td>2核</td>
<td>4G</td>
</tr>
<tr>
<td>192.168.204.4</td>
<td>node</td>
<td>2核</td>
<td>4G</td>
</tr>
<tr>
<td>192.168.204.6</td>
<td>node</td>
<td>2核</td>
<td>4G</td>
</tr>
<tr>
<td>192.168.204.7</td>
<td>node</td>
<td>2核</td>
<td>4G</td>
</tr>
</tbody>
</table>
<p>这里master节点同时充当node节点, 因为后面一些在部署calico网络时采用的是daemonSet, 这样才能保证master和node节点内部网络通畅。</p>
<h2 id="镜像准备"><a href="#镜像准备" class="headerlink" title="镜像准备"></a>镜像准备</h2><p>在进行集群搭建时, 由于很多镜像都需要翻墙下载, 因此请先准备一个私有仓库, 关于私有仓库的搭建请参考: <a href="/2018/01/23/harbor/" title="企业级Docker镜像仓库harbor的部署和使用">企业级Docker镜像仓库harbor的部署和使用</a>, 如果还没搭建的请搭建然后继续.</p>
<p>在后面的安装过程中需要依赖一个基础镜像: pause, 它是根POD镜像, 用于管理POD的网络, 存储等一些共享资源:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcr.io/google_containers/pause-amd64:3.0</div></pre></td></tr></table></figure></p>
<p>如果自己能翻墙就自己下载后推送到自己的私有仓库, 如果自己翻不了墙, 我已帮忙下载, 请到<a href="https://pan.baidu.com/s/1hukv5Nu" target="_blank" rel="external">国内kubernetes镜像tar包</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker load &lt; pause-amd64.tar</div><div class="line">docker tag gcr.io/google_containers/pause-amd64:3.0 &#123;PRIVATE_REGISTRIY_ADDR&#125;/&#123;PROJECT&#125;/pause-amd64:3.0</div><div class="line">docker push &#123;PRIVATE_REGISTRIY_ADDR&#125;/&#123;PROJECT&#125;/pause-amd64:3.0</div></pre></td></tr></table></figure></p>
<h2 id="集群准备"><a href="#集群准备" class="headerlink" title="集群准备"></a>集群准备</h2><p>在开始搭建集群前需要做一些基础准备:</p>
<ol>
<li><p>同步集群的时间<br>理论上systemd系统都自带了时间同步和管理的工具, 使用timedatectl命令确认下, 确保NTP synchronized为yes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver ~]<span class="comment"># timedatectl</span></div><div class="line">      Local time: 六 2018-01-20 02:47:59 EST</div><div class="line">  Universal time: 六 2018-01-20 07:47:59 UTC</div><div class="line">        RTC time: 六 2018-01-20 07:47:59</div><div class="line">       Time zone: America/New_York (EST, -0500)</div><div class="line">     NTP enabled: yes</div><div class="line">NTP synchronized: yes</div><div class="line"> RTC <span class="keyword">in</span> <span class="built_in">local</span> TZ: no</div><div class="line">      DST active: no</div><div class="line"> Last DST change: DST ended at</div><div class="line">                  日 2017-11-05 01:59:59 EDT</div><div class="line">                  日 2017-11-05 01:00:00 EST</div><div class="line"> Next DST change: DST begins (the clock jumps one hour forward) at</div><div class="line">                  日 2018-03-11 01:59:59 EST</div><div class="line">                  日 2018-03-11 03:00:00 EDT</div></pre></td></tr></table></figure>
</li>
<li><p>关闭SELinux<br>SELinux是系统上的沙盒机制, 为了尽快搭建出集群, 先关闭, 如果强调高安全, 可以等集群搭建成功后开启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 确认SELinux的配置, 如果不是disabled, 请设置成disabled, 然后从启系统</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># cat /etc/selinux/config  | grep ^SELINUX=</span></div><div class="line">SELINUX=disabled</div><div class="line"><span class="comment"># 查看当前SELinux是否已经成功关闭</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># getenforce</span></div><div class="line">Disabled</div></pre></td></tr></table></figure>
</li>
<li><p>关闭防火墙(搭建成功后可以慢慢开启)<br>systemd系统一般都采用firewalld作为防火墙, 同理如果没关闭 先关闭</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver ~]<span class="comment"># systemctl is-enabled firewalld</span></div><div class="line">disabled</div><div class="line"><span class="comment"># 如果未关闭请执行</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># systemctl stop  firewalld</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># systemctl disable  firewalld</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># systemctl is-enabled firewalld</span></div><div class="line">disabled</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h2><p>接下来进入集群的部署阶段, 部署分为如下几个阶段:</p>
<ul>
<li>CA和证书准备</li>
<li>部署kubernetes客户端工具kubectl</li>
<li>node节点的TLS证书引导(TLS Bootstrap)配置准备</li>
<li>部署ETCD</li>
<li>部署master节点</li>
<li>部署node节点</li>
<li>集群测试</li>
</ul>
<p>在进入部署之前, 先看看kubernetes组件的架构:<br><img src="http://oiw1gzfww.bkt.clouddn.com/architecture.png" alt="Kubernetes架构图"></p>
<p>Kubernetes主要由以下几个核心组件组成：</p>
<ul>
<li>etcd保存了整个集群的状态；</li>
<li>apiserver提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制；</li>
<li>controller manager负责维护集群的状态，比如故障检测、自动扩展、滚动更新等；</li>
<li>scheduler负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上；</li>
<li>kubelet负责维持容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理；</li>
<li>Container runtime负责镜像管理以及Pod和容器的真正运行（CRI）；</li>
<li>kube-proxy负责为Service提供cluster内部的服务发现和负载均衡；</li>
</ul>
<h3 id="CA和证书准备"><a href="#CA和证书准备" class="headerlink" title="CA和证书准备"></a>CA和证书准备</h3><p>kubernetes是一套分布式系统, 系统的各组件均使用TLS来进行身份的双向确认和通信加密, 本文档使用CloudFlare提供的PKI工具集 cfssl来生成Certificate Authority (CA)和管理证书(openssl已可以, 但是你需要一步一步的填写).</p>
<p>我们需要为每一个kubernetes的组件生成证书, 总结起来如下:</p>
<ul>
<li>kubectl: 用户的CLI工具, 需要为用户生成访问的证书, 这里需要为admin用户颁发1张证书</li>
<li>master: apiserver, controller manager, scheduler, etcd 这4个服务都在master节点上, 因此为他们颁发1张证书</li>
<li>node: kubelet, kube-proxy 由于kubelet的证书是动态颁发的(TLS Bootstra), 因此这里仅需要为kube-proxy颁发1张证书</li>
</ul>
<h4 id="安装cfssl工具"><a href="#安装cfssl工具" class="headerlink" title="安装cfssl工具"></a>安装cfssl工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</div><div class="line">chmod +x cfssl_linux-amd64</div><div class="line">mv cfssl_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl</div><div class="line"></div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</div><div class="line">chmod +x cfssljson_linux-amd64</div><div class="line">mv cfssljson_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssljson</div><div class="line"></div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</div><div class="line">chmod +x cfssl-certinfo_linux-amd64</div><div class="line">mv cfssl-certinfo_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl-certinfo</div></pre></td></tr></table></figure>
<h4 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h4><p>首先我们创建一个目录pki, 后面的操作都在这个目录里面进行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir pki &amp;&amp; <span class="built_in">cd</span> pki</div></pre></td></tr></table></figure></p>
<p><strong>首先创建CA的配置文件: ca-config.json</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 过期时间设置成了 87600h</span></div><div class="line">cat &gt; ca-config.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"signing"</span>: &#123;</div><div class="line">    <span class="string">"default"</span>: &#123;</div><div class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"profiles"</span>: &#123;</div><div class="line">      <span class="string">"kubernetes"</span>: &#123;</div><div class="line">        <span class="string">"usages"</span>: [</div><div class="line">            <span class="string">"signing"</span>,</div><div class="line">            <span class="string">"key encipherment"</span>,</div><div class="line">            <span class="string">"server auth"</span>,</div><div class="line">            <span class="string">"client auth"</span></div><div class="line">        ],</div><div class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>关于CA配置文件里面的参数说明:</p>
<ul>
<li>ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li>signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；</li>
<li>server auth：表示client可以用该 CA 对server提供的证书进行验证；</li>
<li>client auth：表示server可以用该CA对client提供的证书进行验证；</li>
</ul>
<p><strong>创建CA证书签名请求</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">cat &gt; ca-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>关于证书签名请求的参数说明:</p>
<ul>
<li>“CN”：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>“O”：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>
<p><strong>生成CA证书和私钥</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca</div><div class="line">$ ls ca*</div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div></pre></td></tr></table></figure></p>
<h4 id="admin用户证书"><a href="#admin用户证书" class="headerlink" title="admin用户证书"></a>admin用户证书</h4><p>后续kube-apiserver使用RBAC对客户端(如 kubelet、kube-proxy、Pod)请求进行授权；<br>kube-apiserver 预定义了一些RBAC使用的RoleBindings, 如cluster-admin将Group system:masters与Role cluster-admin 绑定，该Role授予了调用kube-apiserver的所有API的权限, 意思是凡是system:masters Group的user都拥有cluster-admin的角色。 因此我们在使用kubectl命令时候，才拥有整个集群的管理权限(后面部署了客户端工具方可查看)；<br>因此admin用户证书申请的核心是指定Group: Group system:masters, 这样该用户就有访问APIServer的所有权限的.<br>签名请求参数如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat &gt; admin-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>生成签名证书:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</div><div class="line">$ ls admin*</div><div class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</div></pre></td></tr></table></figure></p>
<h4 id="master服务证书"><a href="#master服务证书" class="headerlink" title="master服务证书"></a>master服务证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">cat &gt; kubernetes-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</div><div class="line">    <span class="string">"hosts"</span>: [</div><div class="line">      <span class="string">"127.0.0.1"</span>,</div><div class="line">      <span class="string">"192.168.204.3"</span>,</div><div class="line">      <span class="string">"10.254.0.1"</span>,</div><div class="line">      <span class="string">"kubernetes"</span>,</div><div class="line">      <span class="string">"kubernetes.default"</span>,</div><div class="line">      <span class="string">"kubernetes.default.svc"</span>,</div><div class="line">      <span class="string">"kubernetes.default.svc.cluster"</span>,</div><div class="line">      <span class="string">"kubernetes.default.svc.cluster.local"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"key"</span>: &#123;</div><div class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">        <span class="string">"size"</span>: 2048</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"names"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>参数说明:</p>
<ul>
<li>hosts: 如果hosts字段不为空则需要指定授权使用该证书的IP或域名列表，由于该证书后续被etcd集群和kubernetes master集群使用，所以上面分别指定了etcd集群、kubernetes master集群的主机IP和kubernetes服务的服务IP(一般是 kube-apiserver指定的 service-cluster-ip-range 网段的第一个IP，如 10.254.0.1)。</li>
</ul>
<p>生成签名证书:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</div><div class="line">$ ls kubernetes*</div><div class="line">kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem</div></pre></td></tr></table></figure></p>
<h4 id="node服务证书-仅kube-proxy"><a href="#node服务证书-仅kube-proxy" class="headerlink" title="node服务证书(仅kube-proxy)"></a>node服务证书(仅kube-proxy)</h4><p>kube-apiserver预定义的RoleBinding system:node-proxier 将User system:kube-proxy与Role system:node-proxier绑定，该User具有调用kube-apiserver Proxy相关 API的权限(后面部署了客户端工具后方可查看).<br>因此证书里面通过CN指定user为: system:kube-proxy, 这该证书就是具有了proxy相应的权限.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>生成证书:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</div><div class="line">$ ls kube-proxy*</div><div class="line">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</div></pre></td></tr></table></figure></p>
<h4 id="分发证书"><a href="#分发证书" class="headerlink" title="分发证书"></a>分发证书</h4><p>将上面生成好的证书分发到master和node节点, 作为kubernetes的配置文件:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 因为我是在master上生成的证书, 仅需cp到master对于目录即可</span></div><div class="line">$ mkdir -pv /etc/kubernetes/pki</div><div class="line">mkdir: 已创建目录 <span class="string">"/etc/kubernetes"</span></div><div class="line">mkdir: 已创建目录 <span class="string">"/etc/kubernetes/pki"</span></div><div class="line">$ cp ~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125; /etc/kubernetes/pki/</div><div class="line">$ ls /etc/kubernetes/pki/</div><div class="line">admin-key.pem  ca-key.pem  kube-proxy-key.pem  kubernetes-key.pem</div><div class="line">admin.pem      ca.pem      kube-proxy.pem      kubernetes.pem</div><div class="line"><span class="comment"># 在node节点上创建目录, 并且copy过去</span></div><div class="line">$ ssh  root@192.168.204.6 <span class="string">'mkdir -pv /etc/kubernetes/pki'</span></div><div class="line">$ scp  ~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125;  root@192.168.204.6:/etc/kubernetes/pki/</div></pre></td></tr></table></figure></p>
<h3 id="部署kubernetes客户端工具kubectl"><a href="#部署kubernetes客户端工具kubectl" class="headerlink" title="部署kubernetes客户端工具kubectl"></a>部署kubernetes客户端工具kubectl</h3><p>客户端工具需要下载: kubernetes-client-linux-amd64.tar.gz(1.8.7), 但是由于墙的存在, 有些无法翻墙的朋友请访问我已经下载好的地址<a href="https://pan.baidu.com/s/1eTgeS5G" target="_blank" rel="external">国内下载</a><br>获取包后进行客户端的安装:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tar -xzvf kubernetes-client-linux-amd64.tar.gz</div><div class="line">cp kubernetes/client/bin/kube* /usr/bin/</div></pre></td></tr></table></figure></p>
<p>客户端安装完成后, 需要配置访问凭证, 这里配置证书访问, 证书就是上面生成好的admin的证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://192.168.204.3:6443"</span></div><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span></div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-credentials admin \</div><div class="line">  --client-certificate=/etc/kubernetes/pki/admin.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --client-key=/etc/kubernetes/pki/admin-key.pem</div><div class="line"><span class="comment"># 设置上下文参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-context kubernetes \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=admin</div><div class="line"><span class="comment"># 设置默认上下文</span></div><div class="line">kubectl config use-context kubernetes</div></pre></td></tr></table></figure></p>
<p>生成的kubeconfig被保存到~/.kube/config文件, 该文件拥有对该集群的最高权限，请妥善保管。<br>由于我们集群的master节点还没有部署, 所以后面再进测试。</p>
<h3 id="node节点的TLS证书引导-TLS-Bootstrap-配置准备"><a href="#node节点的TLS证书引导-TLS-Bootstrap-配置准备" class="headerlink" title="node节点的TLS证书引导(TLS Bootstrap)配置准备"></a>node节点的TLS证书引导(TLS Bootstrap)配置准备</h3><p>kubelet、kube-proxy等Node机器上的进程与Master机器的kube-apiserver进程通信时需要认证和授权;<br>kubernetes 1.4开始支持由kube-apiserver为客户端生成TLS证书的<a href="https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/" target="_blank" rel="external">TLS Bootstrapping</a>功能，这样就不需要为每个客户端生成证书了; 该功能当前仅支持为kubelet生成证书;</p>
<h4 id="创建TLS-Bootstrapping-Token"><a href="#创建TLS-Bootstrapping-Token" class="headerlink" title="创建TLS Bootstrapping Token"></a>创建TLS Bootstrapping Token</h4><p>BOOTSTRAP_TOKEN 将被写入到kube-apiserver使用的token.csv文件和kubelet使用的bootstrap.kubeconfig文件.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr <span class="_">-d</span> <span class="string">' '</span>)</div><div class="line">cat &gt; token.csv &lt;&lt;EOF</div><div class="line"><span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span>,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></div><div class="line">EOF</div><div class="line">$ cat token.csv</div><div class="line"><span class="built_in">fc</span>9702212376b0c73ffc3db3d425227c,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></div></pre></td></tr></table></figure>
<h4 id="创建kubelet-bootstrapping-kubeconfig文件"><a href="#创建kubelet-bootstrapping-kubeconfig文件" class="headerlink" title="创建kubelet bootstrapping kubeconfig文件"></a>创建kubelet bootstrapping kubeconfig文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 首先确认token环境变量的值</span></div><div class="line"><span class="built_in">echo</span> <span class="variable">$BOOTSTRAP_TOKEN</span></div><div class="line"></div><div class="line"><span class="comment"># 确保KUBE_APISERVER设置正确</span></div><div class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://192.168.204.3:6443"</span></div><div class="line"></div><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</div><div class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="comment"># 设置上下文参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-context default \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kubelet-bootstrap \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="comment"># 设置默认上下文</span></div><div class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</div></pre></td></tr></table></figure>
<ul>
<li>–embed-certs 为 true 时表示将certificate-authority证书写入到生成的bootstrap.kubeconfig文件中;</li>
<li>设置客户端认证参数时没有指定秘钥和证书，后续由kube-apiserver自动生成；</li>
</ul>
<h4 id="创建kube-proxy-kubeconfig文件"><a href="#创建kube-proxy-kubeconfig文件" class="headerlink" title="创建kube-proxy kubeconfig文件"></a>创建kube-proxy kubeconfig文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://192.168.204.3:6443"</span></div><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy \</div><div class="line">  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem \</div><div class="line">  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="comment"># 设置上下文参数</span></div><div class="line">kubectl config <span class="built_in">set</span>-context default \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kube-proxy \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="comment"># 设置默认上下文</span></div><div class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</div></pre></td></tr></table></figure>
<ul>
<li>设置集群参数和客户端认证参数时 –embed-certs 都为 true，这会将 certificate-authority、client-certificate 和 client-key 指向的证书文件内容写入到生成的 kube-proxy.kubeconfig 文件中；</li>
<li>kube-proxy.pem 证书中 CN 为 system:kube-proxy，kube-apiserver 预定义的 RoleBinding cluster-admin 将User system:kube-proxy 与 Role system:node-proxier 绑定，该 Role 授予了调用 kube-apiserver Proxy 相关 API 的权限；</li>
</ul>
<h4 id="分发kubeconfig文件"><a href="#分发kubeconfig文件" class="headerlink" title="分发kubeconfig文件"></a>分发kubeconfig文件</h4><p>先确认我们刚才生成的文件, 然后将token.csv复制给master节点, bootstrap.kubeconfig和kube-proxy.kubeconfig负责给node节点<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 TLS_Bootstrapping]<span class="comment"># ls</span></div><div class="line">bootstrap.kubeconfig  kube-proxy.kubeconfig  token.csv</div><div class="line"><span class="comment"># 因为我在master节点上(注意master同时也充当node节点), 所以</span></div><div class="line">$ cp  token.csv /etc/kubernetes/</div><div class="line">$ cp ~/TLS_Bootstrapping/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; /etc/kubernetes</div><div class="line">$ scp ~/TLS_Bootstrapping/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; root@192.168.204.6:/etc/kubernetes/</div></pre></td></tr></table></figure></p>
<h3 id="部署ETCD"><a href="#部署ETCD" class="headerlink" title="部署ETCD"></a>部署ETCD</h3><p>etcd作为kubernetes集群的主数据库, 在安装kubernetes集群之前必须先安装和启动。<br>从etcd官网<a href="https://github.com/coreos/etcd/releases" target="_blank" rel="external">下载etcd的二进制文件压缩包</a>, 由于不翻墙下载速度会非常慢, 因此我已提前下载到<a href="https://pan.baidu.com/s/1eUeto22" target="_blank" rel="external">百度网盘</a></p>
<h4 id="TLS证书确认"><a href="#TLS证书确认" class="headerlink" title="TLS证书确认"></a>TLS证书确认</h4><p>需要为etcd集群创建加密通信的TLS证书, 之前创建的kubernetes证书的hosts字段列表中包含etcd部署地址的IP, 否则后续证书校验会失败;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 pki]<span class="comment"># ls /etc/kubernetes/pki/</span></div><div class="line">admin-key.pem  ca-key.pem  kube-proxy-key.pem  kubernetes-key.pem</div><div class="line">admin.pem      ca.pem      kube-proxy.pem      kubernetes.pem</div></pre></td></tr></table></figure></p>
<p>在部署TLS Etcd时我们将要使用: ca.pem, kubernetes-key.pem, kubernetes.pem</p>
<h4 id="部署与配置ETCD"><a href="#部署与配置ETCD" class="headerlink" title="部署与配置ETCD"></a>部署与配置ETCD</h4><p>从上面的百度网盘下载下etcd的二进制包, 然后开始安装:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ tar vxf etcd-v3.2.7-linux-amd64.tar.gz</div><div class="line">$ cp etcd-v3.2.7-linux-amd64/etcd* /usr/<span class="built_in">local</span>/bin/</div></pre></td></tr></table></figure></p>
<p>安装完成后配置成systemd的系统服务, 生成/usr/lib/systemd/system/etcd.service文件, 文件内容如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Etcd Server</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">Documentation=https://github.com/coreos</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">WorkingDirectory=/var/lib/etcd/</div><div class="line">EnvironmentFile=-/etc/etcd/etcd.conf</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/etcd \</div><div class="line">  --name <span class="variable">$&#123;ETCD_NAME&#125;</span> \</div><div class="line">  --cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  --peer-cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --peer-key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  --trusted-ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --peer-trusted-ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --initial-advertise-peer-urls <span class="variable">$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125;</span> \</div><div class="line">  --listen-peer-urls <span class="variable">$&#123;ETCD_LISTEN_PEER_URLS&#125;</span> \</div><div class="line">  --listen-client-urls <span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>,http://127.0.0.1:2379 \</div><div class="line">  --advertise-client-urls <span class="variable">$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125;</span> \</div><div class="line">  --initial-cluster-token <span class="variable">$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;</span> \</div><div class="line">  --initial-cluster infra1=https://192.168.204.3:2380 \</div><div class="line">  --initial-cluster-state new \</div><div class="line">  --data-dir=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span></div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>编写etcd服务的配置文件/etc/etcd/etcd.conf, 文件内容如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># [member]</span></div><div class="line">ETCD_NAME=infra1</div><div class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></div><div class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.204.3:2380"</span></div><div class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.204.3:2379"</span></div><div class="line"></div><div class="line"><span class="comment">#[cluster]</span></div><div class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.204.3:2380"</span></div><div class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></div><div class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.204.3:2379"</span></div></pre></td></tr></table></figure></p>
<h4 id="启动ETCD"><a href="#启动ETCD" class="headerlink" title="启动ETCD"></a>启动ETCD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 因为在etcd的配置文件里面我们指定了etcd数据目录为: /var/lib/etcd, 因此我们需要提前建好</span></div><div class="line">$ mkdir /var/lib/etcd</div><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> etcd</div><div class="line">systemctl start etcd</div><div class="line">systemctl status etcd</div></pre></td></tr></table></figure>
<h4 id="验证ETCD"><a href="#验证ETCD" class="headerlink" title="验证ETCD"></a>验证ETCD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">etcdctl \</div><div class="line">  --ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  cluster-health</div><div class="line">member 74c10a33d24ef135 is healthy: got healthy result from https://192.168.204.3:2379</div><div class="line">cluster is health</div></pre></td></tr></table></figure>
<h3 id="部署master节点"><a href="#部署master节点" class="headerlink" title="部署master节点"></a>部署master节点</h3><p>Master是Kubernetes的大总管，主要由apiserver、controller manager与scheduler组成, 用于管理所有node.<br>目前这三个组件需要部署在同一台机器上, 注意同时只能有一个kube-scheduler、kube-controller-manager进程处于工作状态，如果运行多个，则需要通过选举产生一个leader</p>
<h4 id="下载最新版本的二进制文件"><a href="#下载最新版本的二进制文件" class="headerlink" title="下载最新版本的二进制文件"></a>下载最新版本的二进制文件</h4><p>master的服务需要下载: kubernetes-server-linux-amd64.tar.gz(1.8.7), 但是由于墙的存在, 有些无法翻墙的朋友请访问我已经下载好的文件:<a href="https://pan.baidu.com/s/1eTgeS5G#list/path=%2F" target="_blank" rel="external">国内下载</a></p>
<p>下载完成后, 安装master服务:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ tar vxf kubernetes-server-linux-amd64.tar.gz</div><div class="line">$ cd kubernetes</div><div class="line">$ cp -r server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/local/bin/</div></pre></td></tr></table></figure></p>
<h4 id="配置和启动kube-apiserver"><a href="#配置和启动kube-apiserver" class="headerlink" title="配置和启动kube-apiserver"></a>配置和启动kube-apiserver</h4><p>service配置文件/usr/lib/systemd/system/kube-apiserver.service内容:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes API Service</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line">After=etcd.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/apiserver</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-apiserver \</div><div class="line">        <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">        <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">        <span class="variable">$KUBE_ETCD_SERVERS</span> \</div><div class="line">        <span class="variable">$KUBE_API_ADDRESS</span> \</div><div class="line">        <span class="variable">$KUBE_API_PORT</span> \</div><div class="line">        <span class="variable">$KUBELET_PORT</span> \</div><div class="line">        <span class="variable">$KUBE_ALLOW_PRIV</span> \</div><div class="line">        <span class="variable">$KUBE_SERVICE_ADDRESSES</span> \</div><div class="line">        <span class="variable">$KUBE_ADMISSION_CONTROL</span> \</div><div class="line">        <span class="variable">$KUBE_API_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line">Type=notify</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>由于master服务: kube-apiserver、kube-controller-manager、kube-scheduler、kubelet、kube-proxy有一部分相同的配置, 因此抽离了1个config来公用这些配置: /etc/kubernetes/config文件的内容为:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># kubernetes system config</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># The following values are used to configure various aspects of all</span></div><div class="line"><span class="comment"># kubernetes services, including</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#   kube-apiserver.service</span></div><div class="line"><span class="comment">#   kube-controller-manager.service</span></div><div class="line"><span class="comment">#   kube-scheduler.service</span></div><div class="line"><span class="comment">#   kubelet.service</span></div><div class="line"><span class="comment">#   kube-proxy.service</span></div><div class="line"><span class="comment"># logging to stderr means we get it in the systemd journal</span></div><div class="line">KUBE_LOGTOSTDERR=<span class="string">"--logtostderr=true"</span></div><div class="line"></div><div class="line"><span class="comment"># journal message level, 0 is debug</span></div><div class="line">KUBE_LOG_LEVEL=<span class="string">"--v=0"</span></div><div class="line"></div><div class="line"><span class="comment"># Should this cluster be allowed to run privileged docker containers</span></div><div class="line">KUBE_ALLOW_PRIV=<span class="string">"--allow-privileged=true"</span></div><div class="line"></div><div class="line"><span class="comment"># How the controller-manager, scheduler, and proxy find the apiserver</span></div><div class="line">KUBE_MASTER=<span class="string">"--master=http://192.168.204.3:8080"</span></div></pre></td></tr></table></figure></p>
<p>apiserver配置文件/etc/kubernetes/apiserver内容为:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment">## kubernetes system config</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## The following values are used to configure the kube-apiserver</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## The address on the local server to listen to.</span></div><div class="line"><span class="comment">#KUBE_API_ADDRESS="--insecure-bind-address=sz-pg-oam-docker-test-001.tendcloud.com"</span></div><div class="line">KUBE_API_ADDRESS=<span class="string">"--advertise-address=192.168.204.3 --bind-address=192.168.204.3 --insecure-bind-address=192.168.204.3"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## The port on the local server to listen on.</span></div><div class="line"><span class="comment">#KUBE_API_PORT="--port=8080"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Port minions listen on</span></div><div class="line"><span class="comment">#KUBELET_PORT="--kubelet-port=10250"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Comma separated list of nodes in the etcd cluster</span></div><div class="line">KUBE_ETCD_SERVERS=<span class="string">"--etcd-servers=https://192.168.204.3:2379"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Address range to use for services</span></div><div class="line">KUBE_SERVICE_ADDRESSES=<span class="string">"--service-cluster-ip-range=10.254.0.0/16"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## default admission control policies</span></div><div class="line">KUBE_ADMISSION_CONTROL=<span class="string">"--admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Add your own!</span></div><div class="line">KUBE_API_ARGS=<span class="string">"--authorization-mode=Node,RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --experimental-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/pki/kubernetes.pem --tls-private-key-file=/etc/kubernetes/pki/kubernetes-key.pem --client-ca-file=/etc/kubernetes/pki/ca.pem --service-account-key-file=/etc/kubernetes/pki/ca-key.pem --etcd-cafile=/etc/kubernetes/pki/ca.pem --etcd-certfile=/etc/kubernetes/pki/kubernetes.pem --etcd-keyfile=/etc/kubernetes/pki/kubernetes-key.pem --enable-swagger-ui=true --apiserver-count=3 --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-path=/var/lib/audit.log --event-ttl=1h"</span></div></pre></td></tr></table></figure></p>
<p>启动kube-apiserver<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div><div class="line">$ systemctl <span class="built_in">enable</span> kube-apiserver</div><div class="line">$ systemctl start kube-apiserver</div><div class="line">$ systemctl status kube-apiserver</div><div class="line">$ netstat -tlnup  | grep kube</div><div class="line">tcp        0      0 192.168.204.3:6443      0.0.0.0:*               LISTEN      10625/kube-apiserve</div><div class="line">tcp        0      0 192.168.204.3:8080      0.0.0.0:*               LISTEN      10625/kube-apiserve</div></pre></td></tr></table></figure></p>
<h4 id="配置和启动kube-controller-manager"><a href="#配置和启动kube-controller-manager" class="headerlink" title="配置和启动kube-controller-manager"></a>配置和启动kube-controller-manager</h4><p>创建kube-controller-manager的serivce配置文件: /usr/lib/systemd/system/kube-controller-manager.service, 内容如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Controller Manager</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/controller-manager</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-controller-manager \</div><div class="line">        <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">        <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">        <span class="variable">$KUBE_MASTER</span> \</div><div class="line">        <span class="variable">$KUBE_CONTROLLER_MANAGER_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>配置文件/etc/kubernetes/controller-manager内容如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># The following values are used to configure the kubernetes controller-manager</span></div><div class="line"></div><div class="line"><span class="comment"># defaults from config and apiserver should be adequate</span></div><div class="line"></div><div class="line"><span class="comment"># Add your own!</span></div><div class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"--address=127.0.0.1 --service-cluster-ip-range=10.254.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem  --service-account-private-key-file=/etc/kubernetes/pki/ca-key.pem --root-ca-file=/etc/kubernetes/pki/ca.pem --leader-elect=true"</span></div></pre></td></tr></table></figure></p>
<p>启动服务:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div><div class="line">$ systemctl <span class="built_in">enable</span> kube-controller-manager</div><div class="line">$ systemctl start kube-controller-manager</div><div class="line">$ netstat -tlnup | grep controll</div><div class="line">tcp        0      0 127.0.0.1:10252         0.0.0.0:*               LISTEN      10692/kube-controll</div></pre></td></tr></table></figure></p>
<h4 id="配置和启动kube-scheduler"><a href="#配置和启动kube-scheduler" class="headerlink" title="配置和启动kube-scheduler"></a>配置和启动kube-scheduler</h4><p>创建kube-scheduler的serivce配置文件/usr/lib/systemd/system/kube-scheduler.service:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Scheduler Plugin</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/scheduler</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-scheduler \</div><div class="line">            <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">            <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">            <span class="variable">$KUBE_MASTER</span> \</div><div class="line">            <span class="variable">$KUBE_SCHEDULER_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>配置文件/etc/kubernetes/scheduler:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># kubernetes scheduler config</span></div><div class="line"></div><div class="line"><span class="comment"># default config should be adequate</span></div><div class="line"></div><div class="line"><span class="comment"># Add your own!</span></div><div class="line">KUBE_SCHEDULER_ARGS=<span class="string">"--leader-elect=true --address=127.0.0.1"</span></div></pre></td></tr></table></figure></p>
<p>启动服务:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div><div class="line">$ systemctl <span class="built_in">enable</span> kube-scheduler</div><div class="line">$ systemctl start kube-scheduler</div><div class="line">$ netstat -tlnup | grep schedule</div><div class="line">tcp        0      0 127.0.0.1:10251         0.0.0.0:*               LISTEN      10745/kube-schedule</div></pre></td></tr></table></figure></p>
<h4 id="验证master节点功能"><a href="#验证master节点功能" class="headerlink" title="验证master节点功能"></a>验证master节点功能</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ netstat -tlnup | grep kube</div><div class="line">tcp        0      0 127.0.0.1:10251         0.0.0.0:*               LISTEN      10745/kube-schedule</div><div class="line">tcp        0      0 192.168.204.3:6443      0.0.0.0:*               LISTEN      10625/kube-apiserve</div><div class="line">tcp        0      0 127.0.0.1:10252         0.0.0.0:*               LISTEN      10692/kube-controll</div><div class="line">tcp        0      0 192.168.204.3:8080      0.0.0.0:*               LISTEN      10625/kube-apiserve</div><div class="line">$ kubectl get componentstatuses</div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">scheduler            Healthy   ok</div><div class="line">controller-manager   Healthy   ok</div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</div></pre></td></tr></table></figure>
<p>master安装完成后, 我们就可以额测试kubectl了, 查看上面提到的clusterrolebinding的相关权限:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">$ kubectl get clusterrolebinding system:node-proxier -o yaml</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">  creationTimestamp: 2018-01-19T01:23:53Z</div><div class="line">  labels:</div><div class="line">    kubernetes.io/bootstrapping: rbac-defaults</div><div class="line">  name: system:node-proxier</div><div class="line">  resourceVersion: <span class="string">"75"</span></div><div class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Anode-proxier</div><div class="line">  uid: 6916e382-fcb7-11e7-ad2d-fa163e1ab5c5</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: system:node-proxier</div><div class="line">subjects:</div><div class="line">- apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: User</div><div class="line">  name: system:kube-proxy</div><div class="line">$ kubectl get clusterrolebinding cluster-admin -o yaml</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">  creationTimestamp: 2018-01-19T01:23:52Z</div><div class="line">  labels:</div><div class="line">    kubernetes.io/bootstrapping: rbac-defaults</div><div class="line">  name: cluster-admin</div><div class="line">  resourceVersion: <span class="string">"72"</span></div><div class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin</div><div class="line">  uid: 69072637-fcb7-11e7-ad2d-fa163e1ab5c5</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: cluster-admin</div><div class="line">subjects:</div><div class="line">- apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: Group</div><div class="line">  name: system:masters</div></pre></td></tr></table></figure></p>
<h3 id="部署node节点"><a href="#部署node节点" class="headerlink" title="部署node节点"></a>部署node节点</h3><p>Node是主要执行容器实例的节点，可视为工作节点。他负责容器的启停。<br><strong>注意:</strong> 因为kubernetes CNI标准的推出, 容器的网络后面会通过CNI插件单独部署, 所以此时的node节点创建出来的容器是不能夸主机通信的.<br>Kubernetes node节点包含如下组件：</p>
<ul>
<li>Docker: cri的实现, docker的安装很简单。</li>
<li>kubelet: 负责维持容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理, 通过二进制安装</li>
<li>kube-proxy: 负责为Service提供cluster内部的服务发现和负载均衡, 通过二进制安装</li>
</ul>
<h4 id="证书与Bootstrap-TLS配置文件确认"><a href="#证书与Bootstrap-TLS配置文件确认" class="headerlink" title="证书与Bootstrap TLS配置文件确认"></a>证书与Bootstrap TLS配置文件确认</h4><p>如果该node节点已经分发了证书, 可以看到如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@k8s-node01 kubernetes]<span class="comment"># ls /etc/kubernetes/pki</span></div><div class="line">admin-key.pem  ca-key.pem  kubelet-client.crt  kubelet.crt  kube-proxy-key.pem  kubernetes-key.pem</div><div class="line">admin.pem      ca.pem      kubelet-client.key  kubelet.key  kube-proxy.pem      kubernetes.pem</div></pre></td></tr></table></figure></p>
<p>如果没分发证书, 到master节点将相应的证书copy过去<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -pv /etc/kubernetes/pki</div><div class="line">scp  root@192.168.204.3:~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125;  /etc/kubernetes/pki/</div><div class="line">scp  root@192.168.204.3:~/TLS_Bootstrapping/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; /etc/kubernetes/</div></pre></td></tr></table></figure></p>
<h4 id="部署docker"><a href="#部署docker" class="headerlink" title="部署docker"></a>部署docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -fsSL <span class="string">"https://get.docker.com/"</span> &gt; docker_install.sh</div><div class="line">sh docker_install.sh --mirror Aliyun</div></pre></td></tr></table></figure>
<p>同时为了加速docker官方镜像的下载速度, 配置加速器(因为私有仓库没有使用https, 因此这里同时将私有仓库地址也加上):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 注意由于自己搭建的私有仓库没有使用SSL, 如果你也是请将192.168.204.15换成你自己的仓库地址</span></div><div class="line">mkdir -p /etc/docker</div><div class="line">tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://v5d7kh0f.mirror.aliyuncs.com"</span>],</div><div class="line">  <span class="string">"insecure-registries"</span>: [<span class="string">"192.168.204.15"</span>]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>然后重启docker:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl restart docker</div><div class="line">systemctl status docker</div></pre></td></tr></table></figure></p>
<h4 id="下载最新的node节点的二进制包"><a href="#下载最新的node节点的二进制包" class="headerlink" title="下载最新的node节点的二进制包"></a>下载最新的node节点的二进制包</h4><p>node节点的二进制包: kubernetes-node-linux-amd64.tar.gz, 已下载到我们百度云盘: <a href="https://pan.baidu.com/s/1eTgeS5G#list/path=%2F" target="_blank" rel="external">国内下载</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tar vxf kubernetes-node-linux-amd64.tar.gz</div><div class="line"><span class="built_in">cd</span> kubernetes &amp;&amp; cp  ./node/bin/&#123;kube-proxy,kubelet&#125; /usr/<span class="built_in">local</span>/bin/</div></pre></td></tr></table></figure></p>
<h4 id="部署kubelet"><a href="#部署kubelet" class="headerlink" title="部署kubelet"></a>部署kubelet</h4><p>创建kubelet的service配置文件:/usr/lib/systemd/system/kubelet.service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kubelet Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=docker.service</div><div class="line">Requires=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/kubelet</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kubelet \</div><div class="line">            <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">            <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">            <span class="variable">$KUBELET_API_SERVER</span> \</div><div class="line">            <span class="variable">$KUBELET_ADDRESS</span> \</div><div class="line">            <span class="variable">$KUBELET_PORT</span> \</div><div class="line">            <span class="variable">$KUBELET_HOSTNAME</span> \</div><div class="line">            <span class="variable">$KUBE_ALLOW_PRIV</span> \</div><div class="line">            <span class="variable">$KUBELET_POD_INFRA_CONTAINER</span> \</div><div class="line">            <span class="variable">$KUBELET_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>创建kubelet的配置文件/etc/kubernetes/kubelet(<code>注意请将--pod-infra-container-image的值更换成自己私有仓库对应pause的镜像地址</code>):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment">## kubernetes kubelet (minion) config</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span></div><div class="line">KUBELET_ADDRESS=<span class="string">"--address=192.168.204.6"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## The port for the info server to serve on</span></div><div class="line"><span class="comment">#KUBELET_PORT="--port=10250"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## You may leave this blank to use the actual hostname</span></div><div class="line">KUBELET_HOSTNAME=<span class="string">"--hostname-override=192.168.204.6"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## location of the api-server</span></div><div class="line"><span class="comment">## COMMENT THIS ON KUBERNETES 1.8+</span></div><div class="line"><span class="comment"># KUBELET_API_SERVER="--api-servers=192.168.204.3:8080"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## pod infrastructure container</span></div><div class="line">KUBELET_POD_INFRA_CONTAINER=<span class="string">"--pod-infra-container-image=192.168.204.15/kubernetes/pause-amd64:3.0"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Add your own!</span></div><div class="line">KUBELET_ARGS=<span class="string">"--cgroup-driver=cgroupfs --cluster-dns=10.254.0.2 --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --cert-dir=/etc/kubernetes/pki --cluster-domain=cluster.local --hairpin-mode promiscuous-bridge --serialize-image-pulls=false --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice --allow_privileged=true"</span></div></pre></td></tr></table></figure></p>
<p><code>注意</code>: –allow_privileged=true 必须为true, 不然后面部署daemonSet的应用时会没权限, 比如下面的报错:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2月 02 01:45:43 k8s-apiserver01 kubelet[17396]: W0202 01:45:43.550410   17396 config.go:350] Pod[1] (calico-node-5cvkj_kube-system(b0<span class="built_in">cd</span>277f-07e4-11e8<span class="_">-a</span>15f-fa163ee6f9f6)) from api failed validation, ignoring: spec.containers[0].securityContext.privileged: Forbidden: disallowed by cluster policy</div></pre></td></tr></table></figure></p>
<p>kubelet 启动时向 kube-apiserver 发送 TLS bootstrapping 请求，需要先将 bootstrap token 文件中的 kubelet-bootstrap 用户赋予 system:node-bootstrapper cluster 角色(role)， 然后 kubelet 才能有权限创建认证请求(certificate signing requests):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 注意 请在master节点上执行, node节点没有配置客户端</span></div><div class="line"><span class="built_in">cd</span> /etc/kubernetes &amp;&amp; kubectl create clusterrolebinding kubelet-bootstrap \</div><div class="line">  --clusterrole=system:node-bootstrapper \</div><div class="line">  --user=kubelet-bootstrap</div></pre></td></tr></table></figure></p>
<p>启动服务:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动前手动拉取镜像</span></div><div class="line">docker pull index.tenxcloud.com/jimmy/pod-infrastructure:rhel7</div><div class="line"><span class="comment"># 关闭swap</span></div><div class="line">swapoff <span class="_">-a</span></div><div class="line"><span class="comment"># 启动服务</span></div><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> kubelet</div><div class="line">systemctl start kubelet</div><div class="line">systemctl status kubelet</div></pre></td></tr></table></figure></p>
<p>kubelet 首次启动时向kube-apiserver发送证书签名请求，必须通过后kubernetes系统才会将该Node加入到集群, 因此需要在master节点上对这些node的加入进行审计, 通过后会自动为这些node颁发证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看未授权的CSR请求</span></div><div class="line">$ kubectl get csr</div><div class="line">NAME                                                   AGE       REQUESTOR           CONDITION</div><div class="line">node-csr-D0qfDbLl4sA2uFOuEkEXt0pqYr0DjqCTNqxyaocvgq0   30m       kubelet-bootstrap   Pending</div><div class="line"><span class="comment"># 通过CSR请求</span></div><div class="line">$ kubectl certificate approve node-csr-D0qfDbLl4sA2uFOuEkEXt0pqYr0DjqCTNqxyaocvgq0</div><div class="line"><span class="comment"># 查看才加入的node</span></div><div class="line">$ kubectl get nodes</div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.204.6   Ready     &lt;none&gt;    47s       v1.8.7</div></pre></td></tr></table></figure></p>
<h4 id="部署kub-proxy"><a href="#部署kub-proxy" class="headerlink" title="部署kub-proxy"></a>部署kub-proxy</h4><p>Kube-proxy 是实现Service的关键组件, kube-proxy会在每台节点上执行, 然后监听API Server的Service与Endpoint资源对象的改变, 然后来依据变化执行iptables来实现网络的转发。</p>
<p>创建 kube-proxy 的service配置文件: /usr/lib/systemd/system/kube-proxy.service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kube-Proxy Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/proxy</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-proxy \</div><div class="line">        <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">        <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">        <span class="variable">$KUBE_MASTER</span> \</div><div class="line">        <span class="variable">$KUBE_PROXY_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>kube-proxy配置文件/etc/kubernetes/proxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># kubernetes proxy config</span></div><div class="line"></div><div class="line"><span class="comment"># default config should be adequate</span></div><div class="line"></div><div class="line"><span class="comment"># Add your own!</span></div><div class="line">KUBE_PROXY_ARGS=<span class="string">"--bind-address=192.168.204.6 --hostname-override=192.168.204.6 --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig --cluster-cidr=10.254.0.0/16"</span></div></pre></td></tr></table></figure></p>
<p>启动服务:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> kube-proxy</div><div class="line">systemctl start kube-proxy</div><div class="line">systemctl status kube-proxy</div><div class="line">$ netstat -tlnup | grep kub</div><div class="line">tcp        0      0 192.168.204.6:10250     0.0.0.0:*               LISTEN      12437/kubelet</div><div class="line">tcp        0      0 192.168.204.6:10255     0.0.0.0:*               LISTEN      12437/kubelet</div><div class="line">tcp        0      0 192.168.204.6:4194      0.0.0.0:*               LISTEN      12437/kubelet</div><div class="line">tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      12437/kubelet</div><div class="line">tcp        0      0 127.0.0.1:10249         0.0.0.0:*               LISTEN      12776/kube-proxy</div><div class="line">tcp6       0      0 :::10256                :::*                    LISTEN      12776/kube-proxy</div></pre></td></tr></table></figure></p>
<p>剩下的2个node节点: 192.168.204.和192.168.204.14, 192.168.204.3如法炮制, 然后我们在master看看所有已经添加好的node节点:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 docker]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.204.3   Ready     &lt;none&gt;    54m       v1.8.7</div><div class="line">192.168.204.4   Ready     &lt;none&gt;    3d        v1.8.7</div><div class="line">192.168.204.6   Ready     &lt;none&gt;    3d        v1.8.7</div><div class="line">192.168.204.7   Ready     &lt;none&gt;    3d        v1.8.7</div></pre></td></tr></table></figure></p>
<h3 id="集群测试"><a href="#集群测试" class="headerlink" title="集群测试"></a>集群测试</h3><p>我们通过部署一个nginx服务来验证集群是否正常工作:<br>为了加快验证的效果, 我们先在node节点上拉取nginx的镜像:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull nginx</div></pre></td></tr></table></figure></p>
<p>然后在master节点上部署服务，并暴露出来:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$ kubectl run nginx --replicas=2 --labels=<span class="string">"run=load-balancer-example"</span> --image=nginx  --port=80</div><div class="line">deployment <span class="string">"nginx"</span> created</div><div class="line">$ kubectl expose deployment nginx --type=NodePort --name=example-service</div><div class="line">service <span class="string">"example-service"</span> exposed</div><div class="line">$ kubectl describe svc example-service</div><div class="line">Name:                     example-service</div><div class="line">Namespace:                default</div><div class="line">Labels:                   run=load-balancer-example</div><div class="line">Annotations:              &lt;none&gt;</div><div class="line">Selector:                 run=load-balancer-example</div><div class="line">Type:                     NodePort</div><div class="line">IP:                       10.254.100.109</div><div class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  80/TCP</div><div class="line">TargetPort:               80/TCP</div><div class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  30924/TCP</div><div class="line">Endpoints:                172.30.52.2:80,172.30.52.3:80</div><div class="line">Session Affinity:         None</div><div class="line">External Traffic Policy:  Cluster</div><div class="line">Events:                   &lt;none&gt;</div></pre></td></tr></table></figure></p>
<p>然后访问暴露出来的服务:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 ~]<span class="comment"># curl 192.168.204.6:30924</span></div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</div><div class="line">&lt;style&gt;</div><div class="line">    body &#123;</div><div class="line">        width: 35em;</div><div class="line">        margin: 0 auto;</div><div class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</div><div class="line">    &#125;</div><div class="line">&lt;/style&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</div><div class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</div><div class="line">working. Further configuration is required.&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p&gt;For online documentation and support please refer to</div><div class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</div><div class="line">Commercial support is available at</div><div class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>经过这篇博客, 我们成功部署了一个4个节点的kubernetes 1.8.7的集群, 但是此时集群的网络, DNS, DashBoard, 监控都还没完成, 在接下来的<a href="/2018/01/27/kubernetes-binary-install-2/" title="kubernetes 1.8.7 离线部署手册(二)">kubernetes 1.8.7 离线部署手册(二)</a>中将进行这些组件的部署。</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="http://oiw1gzfww.bkt.clouddn.com/alipay.jpg" alt="紫川秀 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/07/oauth2/" rel="next" title="OAuth2.0授权机制详解">
                <i class="fa fa-chevron-left"></i> OAuth2.0授权机制详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/22/kubernetes-hpa/" rel="prev" title="如何利用kubernetes实现应用的水平扩展(HPA)">
                如何利用kubernetes实现应用的水平扩展(HPA) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjIwMy84NzY3"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://oiw1gzfww.bkt.clouddn.com/me.png"
                alt="紫川秀" />
            
              <p class="site-author-name" itemprop="name">紫川秀</p>
              <p class="site-description motion-element" itemprop="description">喜欢Linux, Coding, 文艺, 运动。 生活如此多彩，我时间挥霍不过来。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yumaojun03" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://douban.com/people/155892492" target="_blank" title="豆瓣">
                    
                      <i class="fa fa-fw fa-globe"></i>豆瓣</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.zhihu.com/people/zi-chuan-xiu-86" target="_blank" title="知乎">
                    
                      <i class="fa fa-fw fa-globe"></i>知乎</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.liaoxuefeng.com/" title="廖雪峰官网" target="_blank">廖雪峰官网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xiaorui.cc/" title="峰云,就她了" target="_blank">峰云,就她了</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境介绍"><span class="nav-number">1.</span> <span class="nav-text">环境介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#镜像准备"><span class="nav-number">2.</span> <span class="nav-text">镜像准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群准备"><span class="nav-number">3.</span> <span class="nav-text">集群准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群部署"><span class="nav-number">4.</span> <span class="nav-text">集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CA和证书准备"><span class="nav-number">4.1.</span> <span class="nav-text">CA和证书准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装cfssl工具"><span class="nav-number">4.1.1.</span> <span class="nav-text">安装cfssl工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建CA"><span class="nav-number">4.1.2.</span> <span class="nav-text">创建CA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#admin用户证书"><span class="nav-number">4.1.3.</span> <span class="nav-text">admin用户证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#master服务证书"><span class="nav-number">4.1.4.</span> <span class="nav-text">master服务证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#node服务证书-仅kube-proxy"><span class="nav-number">4.1.5.</span> <span class="nav-text">node服务证书(仅kube-proxy)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分发证书"><span class="nav-number">4.1.6.</span> <span class="nav-text">分发证书</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署kubernetes客户端工具kubectl"><span class="nav-number">4.2.</span> <span class="nav-text">部署kubernetes客户端工具kubectl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node节点的TLS证书引导-TLS-Bootstrap-配置准备"><span class="nav-number">4.3.</span> <span class="nav-text">node节点的TLS证书引导(TLS Bootstrap)配置准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建TLS-Bootstrapping-Token"><span class="nav-number">4.3.1.</span> <span class="nav-text">创建TLS Bootstrapping Token</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建kubelet-bootstrapping-kubeconfig文件"><span class="nav-number">4.3.2.</span> <span class="nav-text">创建kubelet bootstrapping kubeconfig文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建kube-proxy-kubeconfig文件"><span class="nav-number">4.3.3.</span> <span class="nav-text">创建kube-proxy kubeconfig文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分发kubeconfig文件"><span class="nav-number">4.3.4.</span> <span class="nav-text">分发kubeconfig文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署ETCD"><span class="nav-number">4.4.</span> <span class="nav-text">部署ETCD</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TLS证书确认"><span class="nav-number">4.4.1.</span> <span class="nav-text">TLS证书确认</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#部署与配置ETCD"><span class="nav-number">4.4.2.</span> <span class="nav-text">部署与配置ETCD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动ETCD"><span class="nav-number">4.4.3.</span> <span class="nav-text">启动ETCD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证ETCD"><span class="nav-number">4.4.4.</span> <span class="nav-text">验证ETCD</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署master节点"><span class="nav-number">4.5.</span> <span class="nav-text">部署master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载最新版本的二进制文件"><span class="nav-number">4.5.1.</span> <span class="nav-text">下载最新版本的二进制文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置和启动kube-apiserver"><span class="nav-number">4.5.2.</span> <span class="nav-text">配置和启动kube-apiserver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置和启动kube-controller-manager"><span class="nav-number">4.5.3.</span> <span class="nav-text">配置和启动kube-controller-manager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置和启动kube-scheduler"><span class="nav-number">4.5.4.</span> <span class="nav-text">配置和启动kube-scheduler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证master节点功能"><span class="nav-number">4.5.5.</span> <span class="nav-text">验证master节点功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署node节点"><span class="nav-number">4.6.</span> <span class="nav-text">部署node节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#证书与Bootstrap-TLS配置文件确认"><span class="nav-number">4.6.1.</span> <span class="nav-text">证书与Bootstrap TLS配置文件确认</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#部署docker"><span class="nav-number">4.6.2.</span> <span class="nav-text">部署docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#下载最新的node节点的二进制包"><span class="nav-number">4.6.3.</span> <span class="nav-text">下载最新的node节点的二进制包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#部署kubelet"><span class="nav-number">4.6.4.</span> <span class="nav-text">部署kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#部署kub-proxy"><span class="nav-number">4.6.5.</span> <span class="nav-text">部署kub-proxy</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群测试"><span class="nav-number">4.7.</span> <span class="nav-text">集群测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">紫川秀</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("51RM6PwqfSuyOFX9MxLeq5yY-gzGzoHsz", "dNQYvnf4KlnN364JVGClL7bp");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
