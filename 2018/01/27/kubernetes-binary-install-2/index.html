<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="kubernetes," />





  <link rel="alternate" href="/atom.xml" title="紫川秀的博客" type="application/atom+xml" />






<meta name="description" content="这是kubernetes集群部署的第二部分, 在上篇中我们部署了一个的kubernetes集群(4个node节点), 接下来我们将部署一些很实用的kubernetes扩展插件, 包括集群网络, 可视化, 服务发现, 集群监控。">
<meta name="keywords" content="kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes 1.8.7 离线部署手册(二)">
<meta property="og:url" content="https://blog.yumaojun.net/2018/01/27/kubernetes-binary-install-2/index.html">
<meta property="og:site_name" content="紫川秀的博客">
<meta property="og:description" content="这是kubernetes集群部署的第二部分, 在上篇中我们部署了一个的kubernetes集群(4个node节点), 接下来我们将部署一些很实用的kubernetes扩展插件, 包括集群网络, 可视化, 服务发现, 集群监控。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://oiw1gzfww.bkt.clouddn.com/k8s-dashboard.jpg">
<meta property="og:image" content="http://oiw1gzfww.bkt.clouddn.com/k8s-dash.jpg">
<meta property="og:image" content="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1517655715622&di=5bc45bbdd7bcd5f5a72a48361ab3e7b0&imgtype=0&src=http%3A%2F%2Fwww.th7.cn%2Fd%2Ffile%2Fp%2F2016%2F12%2F07%2Fd42febe8c45ad91d5923acdd2ead7173.jpg">
<meta property="og:image" content="http://oiw1gzfww.bkt.clouddn.com/heapster-test.jpg">
<meta property="og:image" content="http://oiw1gzfww.bkt.clouddn.com/heapster-grafana.jpg">
<meta property="og:image" content="http://oiw1gzfww.bkt.clouddn.com/dashboard-with-heapster.jpg">
<meta property="og:updated_time" content="2018-02-03T09:49:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kubernetes 1.8.7 离线部署手册(二)">
<meta name="twitter:description" content="这是kubernetes集群部署的第二部分, 在上篇中我们部署了一个的kubernetes集群(4个node节点), 接下来我们将部署一些很实用的kubernetes扩展插件, 包括集群网络, 可视化, 服务发现, 集群监控。">
<meta name="twitter:image" content="http://oiw1gzfww.bkt.clouddn.com/k8s-dashboard.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.yumaojun.net/2018/01/27/kubernetes-binary-install-2/"/>





  <title>kubernetes 1.8.7 离线部署手册(二) | 紫川秀的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">紫川秀的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">比你优秀的人不可怕,可怕的是比你优秀的人比你更努力。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.yumaojun.net/2018/01/27/kubernetes-binary-install-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="紫川秀">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oiw1gzfww.bkt.clouddn.com/me.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="紫川秀的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">kubernetes 1.8.7 离线部署手册(二)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-27T12:59:12+08:00">
                2018-01-27
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-02-03T17:49:24+08:00">
                2018-02-03
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/01/27/kubernetes-binary-install-2/" class="leancloud_visitors" data-flag-title="kubernetes 1.8.7 离线部署手册(二)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这是kubernetes集群部署的第二部分, 在上篇中我们部署了一个的kubernetes集群(4个node节点), 接下来我们将部署一些很实用的<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="external">kubernetes扩展插件</a>, 包括集群网络, 可视化, 服务发现, 集群监控。<br><a id="more"></a></p>
<h2 id="插件镜像准备"><a href="#插件镜像准备" class="headerlink" title="插件镜像准备"></a>插件镜像准备</h2><p>kubernetes提供诸多使用的集群插件: <a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="external">插件列表</a>, 下面我们选取如下4个进行安装:</p>
<ul>
<li>Calico:  安全的L3网络和网络策略插件,通过CNI为整体集群的网络打通。</li>
<li>CoreDNS: 为集群提供DNS服务, 用于服务发现(CoreDNS, 就是为了替换kube-dns的)</li>
<li>Dashboard: 为用户提供Web UI。</li>
<li>Heapster: 集群的监控插件, 同时也为 HPA提供指标。</li>
</ul>
<p>以下是按照以上插件需要的镜像:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># calico依赖镜像</span></div><div class="line">quay.io/calico/node:v2.6.7</div><div class="line">quay.io/calico/cni:v1.11.2</div><div class="line">quay.io/calico/kube-controllers:v1.0.3</div><div class="line"><span class="comment"># coredns依赖镜像</span></div><div class="line">coredns/coredns:1.0.4</div><div class="line"><span class="comment"># dashboard依赖镜像</span></div><div class="line">k8s.gcr.io/kubernetes-dashboard-amd64:v1.8.2</div><div class="line"><span class="comment"># heapster依赖镜像</span></div><div class="line">k8s.gcr.io/heapster-amd64:v1.5.0</div><div class="line">k8s.gcr.io/heapster-grafana-amd64:v4.4.3</div><div class="line">k8s.gcr.io/heapster-influxdb-amd64:v1.3.3</div></pre></td></tr></table></figure></p>
<p>这些镜像最后会把push到我们自己的私有仓库, 如果你还没安装私有仓库请移步: <a href="/2018/01/23/harbor/" title="企业级Docker镜像仓库harbor的部署和使用">企业级Docker镜像仓库harbor的部署和使用</a></p>
<p>如果自己能翻墙,自己下载推送到自己的私有仓库, 如果出不去, 请看这里: <a href="https://pan.baidu.com/s/1hukv5Nu" target="_blank" rel="external">百度网盘kubernetes-adds插件image</a></p>
<p><strong>加载下载的镜像到本地</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">docker load &lt; calico-node.tar</div><div class="line">docker load &lt; calico-cni.tar</div><div class="line">docker load &lt; calico-kube-controller.tar</div><div class="line">docker load &lt; coredns.tar</div><div class="line">docker load &lt; dashboard.tar</div><div class="line">docker load &lt; heapster.tar</div><div class="line">docker load &lt; heapster-grafana.tar</div><div class="line">docker load &lt; heapster-influxdb.tar</div></pre></td></tr></table></figure></p>
<p><strong>推送到私有仓库</strong><br>我私有仓库使用的是harbor, 并且已经创建了1个kubernetes的项目, 下面的操作请更换成你自己的仓库地址和项目<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coredns</span></div><div class="line">docker tag coredns/coredns:1.0.4 192.168.204.15/kubernetes/coredns:1.0.4</div><div class="line">docker push 192.168.204.15/kubernetes/coredns:1.0.4</div><div class="line"><span class="comment"># calico</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="网络插件-Calico"><a href="#网络插件-Calico" class="headerlink" title="网络插件-Calico"></a>网络插件-Calico</h2><p>Calico是一款纯<code>Layer 3</code>的数据中心网络方案(不需要Overlay网络), Calico好处是他已与各种云原生平台有良好的整合, 而Calico在每一个节点利用Linux Kernel实现高效的vRouter来负责数据的转发，而当数据中心复杂度增加时，可以用BGP route reflector来达成, 是性能最好的网络解决方案之一。<br>Calico还有一大优势：network policy。用户可以动态定义ACL规则，控制进出容器的数据包，实现业务需求, 比如租户隔离。<br>最新版本的calico已经到3.0.1, 3.0有不兼容变更, 进过几天的折腾, 问题很多, github上Issue关于3.0和k8s的问题还未得到解决, 所以我们安装2.x版本的calico。</p>
<h3 id="部署注意事项"><a href="#部署注意事项" class="headerlink" title="部署注意事项"></a>部署注意事项</h3><p>在使用Calico前当然最好撸一下官方文档，地址在这里<a href="https://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/" target="_blank" rel="external">Calico 官方文档</a>，其中部署前需要注意以下几点:</p>
<ul>
<li>官方文档中要求kubelet配置必须增加 –network-plugin=cni 选项</li>
<li>calico采用daemonSet部署时, kubelet配置必须增加 –allow_privileged=true 选项</li>
<li>kube-proxy组件必须采用iptables proxy mode 模式(1.2 以后是默认模式)</li>
<li>kubec-proxy组件不能采用 –masquerade-all 启动，因为会与 Calico policy 冲突</li>
<li>NetworkPolicy API 只要需要 Kubernetes 1.3 以上</li>
<li>启用RBAC后需要设置对应的 RoleBinding，参考<a href="https://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/hosted/" target="_blank" rel="external">官方文档 RBAC 部分</a></li>
</ul>
<h3 id="master安装calicoctl"><a href="#master安装calicoctl" class="headerlink" title="master安装calicoctl"></a>master安装calicoctl</h3><p>首先需要在master节点安装calico的客户端: calicoctl 用于稍后检查calico的网络节点状态, 到calico的<a href="https://github.com/projectcalico/calicoctl/releases" target="_blank" rel="external">Github Release</a>下载2.6版本calico对于的CLI: calicoctl 1.6.3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/projectcalico/calicoctl/releases/download/v1.6.3/calicoctl</div><div class="line">chmod +x calicoctl</div><div class="line">mv calicoctl /usr/<span class="built_in">local</span>/bin/</div><div class="line">mkdir /etc/calico</div></pre></td></tr></table></figure></p>
<p>然后配置客户端: /etc/calico/calicoctl.cfg:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: calicoApiConfig</div><div class="line">metadata:</div><div class="line">spec:</div><div class="line">  datastoreType: <span class="string">"etcdv2"</span></div><div class="line">  etcdEndpoints: <span class="string">"https://192.168.204.3:2379"</span></div><div class="line">  etcdKeyFile: <span class="string">"/etc/kubernetes/pki/kubernetes-key.pem"</span></div><div class="line">  etcdCertFile: <span class="string">"/etc/kubernetes/pki/kubernetes.pem"</span></div><div class="line">  etcdCACertFile: <span class="string">"/etc/kubernetes/pki/ca.pem"</span></div></pre></td></tr></table></figure></p>
<p>然后等集群启动后测试。</p>
<h3 id="DaemonSet安装calico插件"><a href="#DaemonSet安装calico插件" class="headerlink" title="DaemonSet安装calico插件"></a>DaemonSet安装calico插件</h3><p>这里采用<a href="https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/hosted" target="_blank" rel="external">calico standard hosted install</a>, 使用2.6的安装说明:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir calico &amp;&amp; <span class="built_in">cd</span> calico</div><div class="line">wget https://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/hosted/calico.yaml</div><div class="line">wget https://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/rbac.yaml</div></pre></td></tr></table></figure></p>
<p>rbac文件没有需要调整的, 而calico需要配置ETCD的相关参数, 因此修改calico.yaml如下2个部分:</p>
<ol>
<li><p>指定etcd的地址(ConfigMap中):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">etcd_endpoints: <span class="string">"https://192.168.204.3:2379"</span></div></pre></td></tr></table></figure>
</li>
<li><p>指定etcd的证书(ConfigMap中)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># If you&apos;re using TLS enabled etcd uncomment the following.</div><div class="line"># You must also populate the Secret below with these files.</div><div class="line">etcd_ca: &quot;/calico-secrets/etcd-ca&quot;</div><div class="line">etcd_cert: &quot;/calico-secrets/etcd-cert&quot;</div><div class="line">etcd_key: &quot;/calico-secrets/etcd-key&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>添加base64编码的证书内容(Secret中):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># Populate the following files with etcd TLS configuration if desired, but leave blank if</div><div class="line"># not using TLS for etcd.</div><div class="line"># This self-hosted install expects three files with the following names.  The values</div><div class="line"># should be base64 encoded strings of the entire contents of each file.</div><div class="line">etcd-key: $(cat /etc/kubernetes/pki/kubernetes-key.pem | base64 | tr -d &apos;\n&apos;)</div><div class="line">etcd-cert: $(cat /etc/kubernetes/pki/kubernetes.pem | base64 | tr -d &apos;\n&apos;)</div><div class="line">etcd-ca: $(cat /etc/kubernetes/pki/ca.pem | base64 | tr -d &apos;\n&apos;)</div></pre></td></tr></table></figure>
</li>
<li><p>修改3个image为自己私有仓库的地址:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">quay.io/calico/node:v2.6.7  --&gt; 192.168.204.15/kubernetes/calico/node:v2.6.7</div><div class="line">quay.io/calico/cni:v1.11.2  --&gt; 192.168.204.15/kubernetes/calico/cni:v1.11.2</div><div class="line">quay.io/calico/kube-controllers:v1.0.3 --&gt; 192.168.204.15/kubernetes/calico/kube-controllers:v1.0.3</div></pre></td></tr></table></figure>
</li>
<li><p>确认kubelet是否开启daemonSet允许权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">查看所有node节点的kubelet配置文件是否添加了该选项: --allow_privileged=true</div><div class="line">如果没添加, 添加然后重启kubelet</div></pre></td></tr></table></figure>
</li>
<li><p>最后执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">kubectl apply <span class="_">-f</span>  rbac.yaml</div><div class="line">kubectl create <span class="_">-f</span> calico.yaml</div><div class="line">[root@k8s-apiserver01 calico]<span class="comment"># kubectl get pods -n kube-system</span></div><div class="line">NAME                                       READY     STATUS    RESTARTS   AGE</div><div class="line">calico-kube-controllers-76ddc77958-pc7t2   1/1       Running   1          1d</div><div class="line">calico-node-4jr45                          2/2       Running   2          1d</div><div class="line">calico-node-5cvkj                          2/2       Running   0          1h</div><div class="line">calico-node-sllgc                          2/2       Running   0          1d</div><div class="line">calico-node-xwf7g                          2/2       Running   2          1d</div></pre></td></tr></table></figure>
</li>
<li><p>检查网络是否ok<br>现在我们4个node节点已经组成了一个bgp的网络, 先使用calicoctl来检查下个节点的状态:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 calico]<span class="comment"># calicoctl get node -o wide</span></div><div class="line">NAME              ASN       IPV4               IPV6</div><div class="line">k8s-apiserver01   (64512)   192.168.204.3/24</div><div class="line">k8s-node01        (64512)   192.168.204.4/24</div><div class="line">k8s-node02        (64512)   192.168.204.6/24</div><div class="line">k8s-node03        (64512)   192.168.204.7/24</div><div class="line"><span class="comment"># 看其他几个节点是否正常</span></div><div class="line">[root@k8s-apiserver01 calico]<span class="comment"># calicoctl node status</span></div><div class="line">Calico process is running.</div><div class="line">IPv4 BGP status</div><div class="line">+---------------+-------------------+-------+----------+-------------+</div><div class="line">| PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</div><div class="line">+---------------+-------------------+-------+----------+-------------+</div><div class="line">| 192.168.204.4 | node-to-node mesh | up    | 06:55:36 | Established |</div><div class="line">| 192.168.204.6 | node-to-node mesh | up    | 06:55:33 | Established |</div><div class="line">| 192.168.204.7 | node-to-node mesh | up    | 06:55:35 | Established |</div><div class="line">+---------------+-------------------+-------+----------+-------------+</div><div class="line"><span class="comment"># 然后我们运行几个pod, 测试不同node上的容器是否能正常通信</span></div><div class="line">[root@k8s-apiserver01 calico]<span class="comment"># cat demo.deploy.yaml</span></div><div class="line">apiVersion: apps/v1beta2</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: demo-deployment</div><div class="line">spec:</div><div class="line">  replicas: 5</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app: demo</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: demo</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: demo</div><div class="line">        image: mritd/demo</div><div class="line">        imagePullPolicy: IfNotPresent</div><div class="line">        ports:</div><div class="line">        - containerPort: 80</div><div class="line">[root@k8s-apiserver01 calico]<span class="comment"># kubectl create -f demo.deploy.yaml</span></div><div class="line">created <span class="string">"demo-deployment"</span> deployment</div><div class="line">[root@k8s-apiserver01 calico]<span class="comment"># kubectl get pods</span></div><div class="line">NAME                               READY     STATUS    RESTARTS   AGE</div><div class="line">demo-deployment-6969c5cb49-7t8nm   1/1       Running   0          1d</div><div class="line">demo-deployment-6969c5cb49-phxvz   1/1       Running   0          1d</div><div class="line">demo-deployment-6969c5cb49-v2sqs   1/1       Running   0          1d</div><div class="line">demo-deployment-6969c5cb49-z2zvf   1/1       Running   0          1d</div><div class="line">demo-deployment-6969c5cb49-zzjnf   1/1       Running   0          1d</div><div class="line"><span class="comment"># 这个时候我们到node01和node2上面看看是否有运行的demo</span></div><div class="line"><span class="comment"># node1上面的nginx</span></div><div class="line">[root@k8s-node01 ~]<span class="comment"># docker exec -it 21690463cb6f ip a</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN qlen 1</div><div class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</div><div class="line">4: eth0@<span class="keyword">if</span>44: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP</div><div class="line">    link/ether 52:02:5e:94:d3:8f brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.85.200/32 scope global eth0</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line"><span class="comment"># node2上的nginx</span></div><div class="line">[root@k8s-node02 ~]<span class="comment"># docker exec  -it 7bdeea5b982f  ip a</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN qlen 1</div><div class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</div><div class="line">4: eth0@<span class="keyword">if</span>14: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP</div><div class="line">    link/ether 0a:6d:c6:8b:62:fd brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.58.202/32 scope global eth0</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line"><span class="comment"># node2 ping node1</span></div><div class="line">[root@k8s-node02 ~]<span class="comment"># docker exec -it 7bdeea5b982f  ping 192.168.85.200</span></div><div class="line">PING 192.168.85.200 (192.168.85.200): 56 data bytes</div><div class="line">64 bytes from 192.168.85.200: seq=0 ttl=62 time=10.161 ms</div><div class="line">64 bytes from 192.168.85.200: seq=1 ttl=62 time=1.481 ms</div><div class="line">64 bytes from 192.168.85.200: seq=2 ttl=62 time=1.203 ms</div><div class="line">64 bytes from 192.168.85.200: seq=3 ttl=62 time=3.483 ms</div><div class="line"><span class="comment"># 网络插件部署成功。</span></div></pre></td></tr></table></figure>
</li>
<li><p>配置kubelet启用CNI<br>在所有节点的kubelet的配置文件中添加: –network-plugin=cni 选项<br>然后重启所有kubelet节点, 知道所有的node节点状态恢复为Ready, 才代表CNI插件部署成功, Node节点准备就绪。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.204.3   Ready     &lt;none&gt;    1d        v1.8.7</div><div class="line">192.168.204.4   Ready     &lt;none&gt;    4d        v1.8.7</div><div class="line">192.168.204.6   Ready     &lt;none&gt;    4d        v1.8.7</div><div class="line">192.168.204.7   Ready     &lt;none&gt;    4d        v1.8.7</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="服务发现插件-CoreDNS"><a href="#服务发现插件-CoreDNS" class="headerlink" title="服务发现插件-CoreDNS"></a>服务发现插件-CoreDNS</h2><p>coreDNS是kubeDNS的替代项目, 而且稳定性也比kubeDNS好, 因此这里使用CoreDNS, 该组件必须部署, 因为后面很多服务都依赖它进行服务名称的地址解析(比如后面即将部署的Dashboard)</p>
<h3 id="部署CoreDNS"><a href="#部署CoreDNS" class="headerlink" title="部署CoreDNS"></a>部署CoreDNS</h3><p>下面是官方提供的模板(官方部署文档<a href="https://github.com/coredns/deployment/tree/master/kubernetes" target="_blank" rel="external">coreDNS deploy</a>):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  name: coredns</div><div class="line">  namespace: kube-system</div><div class="line">---</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">kind: ClusterRole</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    kubernetes.io/bootstrapping: rbac-defaults</div><div class="line">  name: system:coredns</div><div class="line">rules:</div><div class="line">- apiGroups:</div><div class="line">  - <span class="string">""</span></div><div class="line">  resources:</div><div class="line">  - endpoints</div><div class="line">  - services</div><div class="line">  - pods</div><div class="line">  - namespaces</div><div class="line">  verbs:</div><div class="line">  - list</div><div class="line">  - watch</div><div class="line">---</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">  labels:</div><div class="line">    kubernetes.io/bootstrapping: rbac-defaults</div><div class="line">  name: system:coredns</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: system:coredns</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: coredns</div><div class="line">  namespace: kube-system</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  name: coredns</div><div class="line">  namespace: kube-system</div><div class="line">data:</div><div class="line">  Corefile: |</div><div class="line">    .:53 &#123;</div><div class="line">        errors</div><div class="line">        health</div><div class="line">        kubernetes CLUSTER_DOMAIN REVERSE_CIDRS &#123;</div><div class="line">          pods insecure</div><div class="line">          upstream /etc/resolv.conf</div><div class="line">          fallthrough <span class="keyword">in</span>-addr.arpa ip6.arpa</div><div class="line">        &#125;</div><div class="line">        prometheus :9153</div><div class="line">        proxy . /etc/resolv.conf</div><div class="line">        cache 30</div><div class="line">    &#125;</div><div class="line">---</div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: coredns</div><div class="line">  namespace: kube-system</div><div class="line">  labels:</div><div class="line">    k8s-app: coredns</div><div class="line">    kubernetes.io/name: <span class="string">"CoreDNS"</span></div><div class="line">spec:</div><div class="line">  replicas: 2</div><div class="line">  strategy:</div><div class="line">    <span class="built_in">type</span>: RollingUpdate</div><div class="line">    rollingUpdate:</div><div class="line">      maxUnavailable: 1</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      k8s-app: coredns</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        k8s-app: coredns</div><div class="line">    spec:</div><div class="line">      serviceAccountName: coredns</div><div class="line">      tolerations:</div><div class="line">        - key: <span class="string">"CriticalAddonsOnly"</span></div><div class="line">          operator: <span class="string">"Exists"</span></div><div class="line">      affinity:</div><div class="line">        podAntiAffinity:</div><div class="line">          preferredDuringSchedulingIgnoredDuringExecution:</div><div class="line">          - weight: 100</div><div class="line">            podAffinityTerm:</div><div class="line">              labelSelector:</div><div class="line">                matchExpressions:</div><div class="line">                - key: k8s-app</div><div class="line">                  operator: In</div><div class="line">                  values:</div><div class="line">                  - coredns</div><div class="line">              topologyKey: kubernetes.io/hostname</div><div class="line">      containers:</div><div class="line">      - name: coredns</div><div class="line">        image: coredns/coredns:1.0.4</div><div class="line">        imagePullPolicy: IfNotPresent</div><div class="line">        args: [ <span class="string">"-conf"</span>, <span class="string">"/etc/coredns/Corefile"</span> ]</div><div class="line">        volumeMounts:</div><div class="line">        - name: config-volume</div><div class="line">          mountPath: /etc/coredns</div><div class="line">        ports:</div><div class="line">        - containerPort: 53</div><div class="line">          name: dns</div><div class="line">          protocol: UDP</div><div class="line">        - containerPort: 53</div><div class="line">          name: dns-tcp</div><div class="line">          protocol: TCP</div><div class="line">        livenessProbe:</div><div class="line">          httpGet:</div><div class="line">            path: /health</div><div class="line">            port: 8080</div><div class="line">            scheme: HTTP</div><div class="line">          initialDelaySeconds: 60</div><div class="line">          timeoutSeconds: 5</div><div class="line">          successThreshold: 1</div><div class="line">          failureThreshold: 5</div><div class="line">      dnsPolicy: Default</div><div class="line">      volumes:</div><div class="line">        - name: config-volume</div><div class="line">          configMap:</div><div class="line">            name: coredns</div><div class="line">            items:</div><div class="line">            - key: Corefile</div><div class="line">              path: Corefile</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: kube-dns</div><div class="line">  namespace: kube-system</div><div class="line">  labels:</div><div class="line">    k8s-app: coredns</div><div class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></div><div class="line">    kubernetes.io/name: <span class="string">"CoreDNS"</span></div><div class="line">spec:</div><div class="line">  selector:</div><div class="line">    k8s-app: coredns</div><div class="line">  clusterIP: CLUSTER_DNS_IP</div><div class="line">  ports:</div><div class="line">  - name: dns</div><div class="line">    port: 53</div><div class="line">    protocol: UDP</div><div class="line">  - name: dns-tcp</div><div class="line">    port: 53</div><div class="line">    protocol: TCP</div></pre></td></tr></table></figure></p>
<p>修改模板中的变量:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CLUSTER_DOMAIN: 这个在node节点部署的时候已经提前指定为(--cluster-dns=10.254.0.2), 因此这里和node节点指定保持一致, 修改成 10.254.0.2 </div><div class="line">REVERSE_CIDRS: cluster.local</div><div class="line">CLUSTER_DNS_IP: in-addr.arpa ip6.arpa</div></pre></td></tr></table></figure></p>
<p>修改过后的具体文件请参考<a href="">coredns.yaml</a></p>
<p>运行:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl create <span class="_">-f</span> coredns.yaml</div></pre></td></tr></table></figure></p>
<h3 id="测试DNS是否正常"><a href="#测试DNS是否正常" class="headerlink" title="测试DNS是否正常"></a>测试DNS是否正常</h3><p>创建一个busybox的容器, 然后尝试解析内部apiserver服务的地址:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># cat pod-busybox.yaml</span></div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: busybox</div><div class="line">  namespace: default</div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">  - image: busybox</div><div class="line">    <span class="built_in">command</span>:</div><div class="line">      - sleep</div><div class="line">      - <span class="string">"3600"</span></div><div class="line">    imagePullPolicy: IfNotPresent</div><div class="line">    name: busybox</div><div class="line">  restartPolicy: Always</div><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl create -f pod-busybox.yaml</span></div><div class="line">pod <span class="string">"busybox"</span> created</div><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl exec -it busybox /bin/sh</span></div><div class="line">/ <span class="comment"># nslookup kubernetes.default</span></div><div class="line">Server:    10.254.0.2</div><div class="line">Address 1: 10.254.0.2 kube-dns.kube-system.svc.cluster.local</div><div class="line"></div><div class="line">Name:      kubernetes.default</div><div class="line">Address 1: 10.254.0.1 kubernetes.default.svc.cluster.local</div><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl delete -f pod-busybox.yaml</span></div><div class="line">pod <span class="string">"busybox"</span> deleted</div></pre></td></tr></table></figure></p>
<p>由于可以看出内部DNS已经生效.</p>
<h2 id="可视化插件-Dashborad"><a href="#可视化插件-Dashborad" class="headerlink" title="可视化插件-Dashborad"></a>可视化插件-Dashborad</h2><p>dashborad是集群的可视化插件, 最新版本(1.8.2)已经支持通过web进入容器内部进行操作, 因此几乎一切需求都可以通过这个Web UI来与kubernetes集群进行交互来完成。<br>为了增加dashboard的安全性, 从1.7过后, ashboard默认将采用最小权限安装(基于rabc的kubernetes访问的最小权限), 并且通过https访问。</p>
<p>我们使用官方的配置文件来安装，首先下载官方配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</div></pre></td></tr></table></figure></p>
<p>将镜像地址: <code>k8s.gcr.io/kubernetes-dashboard-amd64:v1.8.2</code> 修改成我们自己的地址: <code>192.168.204.15/kubernetes/dashboard:v1.8.2</code></p>
<p>然后到master节点上 创建我们的dashboard插件应用:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl create -f kubernetes-dashboard.yaml</span></div><div class="line">secret <span class="string">"kubernetes-dashboard-certs"</span> created</div><div class="line">serviceaccount <span class="string">"kubernetes-dashboard"</span> created</div><div class="line">role <span class="string">"kubernetes-dashboard-minimal"</span> created</div><div class="line">rolebinding <span class="string">"kubernetes-dashboard-minimal"</span> created</div><div class="line">deployment <span class="string">"kubernetes-dashboard"</span> created</div><div class="line">service <span class="string">"kubernetes-dashboard"</span> created</div><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl -n kube-system get svc kubernetes-dashboard</span></div><div class="line">NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</div><div class="line">kubernetes-dashboard   NodePort   10.254.75.168   &lt;none&gt;        443:32101/TCP   2m</div></pre></td></tr></table></figure></p>
<p>然后访问对用的port<br><img src="http://oiw1gzfww.bkt.clouddn.com/k8s-dashboard.jpg" alt="dashboard-login-page"></p>
<p>dashboard的登录支持kubeconfig和token两种方式:</p>
<ul>
<li>kubeconfig: 和之前生成的kubeconfig文件一样, 但是多了一个token字段, 而且是必需的参数, 所有之前CLI使用的kubeconfig是登录不了的, 需要为他生成一个token</li>
<li>token: 我们创建一个用户获取token 就可能登录, 当然你也可以将此token加入到kubeconfig文件里面使用kubeconfig文件来登录。</li>
</ul>
<p>下面我们创建一个admin用户, 然后赋予它cluster-admin角色, 使得其拥有管理kubernetes集群的权限, 我们通过admin-role.yaml来定义这些操作, 文件内容如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  name: admin-user</div><div class="line">  namespace: kube-system</div><div class="line">---</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  name: admin-user</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: cluster-admin</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: admin-user</div><div class="line">  namespace: kube-system</div></pre></td></tr></table></figure></p>
<p>创建并获取token:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl create -f admin-role.yaml</span></div><div class="line">clusterrolebinding <span class="string">"admin"</span> created</div><div class="line">serviceaccount <span class="string">"admin"</span> created</div><div class="line">[root@k8s-apiserver01 dashboard]<span class="comment"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin | awk '&#123;print $1&#125;')</span></div><div class="line">Name:         admin-token-2p7l7</div><div class="line">Namespace:    kube-system</div><div class="line">Labels:       &lt;none&gt;</div><div class="line">Annotations:  kubernetes.io/service-account.name=admin</div><div class="line">              kubernetes.io/service-account.uid=c9aad066-fe8d-11e7-8479-fa163ee6f9f6</div><div class="line"></div><div class="line">Type:  kubernetes.io/service-account-token</div><div class="line"></div><div class="line">Data</div><div class="line">====</div><div class="line">namespace:  11 bytes</div><div class="line">token:      eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi0ycDdsNyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImM5YWFkMDY2LWZlOGQtMTFlNy04NDc5LWZhMTYzZWU2ZjlmNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.dv9Rt6EA08KFvYDqHYJlHu188vwfPPxf8Yf0cOhHswOsGWhgsoq-UmugcKcq1nqiVEEXR_EXb657ftPrpKOJrt3pkS2__5FdI-h3D6mKj1-zFae-dj8y_tVi4oaHQExIoxgbrzvBVKTpNxDbzWPKf2CChzRPRWqMmAuPlxK8iSvOf11wGe5B_Fh3okObFk5p_CA1Iz9NFRfD3OSR1_9Bt13SfwdKC3oodVBjrrTB-4O00gYM1RHV54_UmhSVJJkZCfvGhfqVt0h0f1Jmihju_D1OyQY5Lp-LpHN0hP<span class="_">-a</span>8TOidmjNYmy96euiZcDPhnb932GYaA2xVzgcIag72bIzbw</div><div class="line">ca.crt:     1359 bytes</div></pre></td></tr></table></figure></p>
<p>使用获取后的token进行登录<br><img src="http://oiw1gzfww.bkt.clouddn.com/k8s-dash.jpg" alt=""></p>
<h2 id="集群监控插件-Heapster"><a href="#集群监控插件-Heapster" class="headerlink" title="集群监控插件-Heapster"></a>集群监控插件-Heapster</h2><p>Heapster是kubernetes的集群监控方案, 以下是heapster的架构:<br><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1517655715622&amp;di=5bc45bbdd7bcd5f5a72a48361ab3e7b0&amp;imgtype=0&amp;src=http%3A%2F%2Fwww.th7.cn%2Fd%2Ffile%2Fp%2F2016%2F12%2F07%2Fd42febe8c45ad91d5923acdd2ead7173.jpg" alt=""></p>
<p>这是一个很重要的组件, 他影响到以下几个kubernetes组件:</p>
<ul>
<li>dashboard: 依赖heapster获取一些指标数据, 等heapster成功部署后, dashbaord上也会进行这些指标的展示。</li>
<li>kubectl top命令: 依赖heapster提供metric数据。</li>
<li>hpa: kubernetes支持应用的水平伸缩, 但是同样依赖heapster提供的metric数据。</li>
</ul>
<p>下面将部署一套backend 为influxdb, 同时支持grafana为dashboard的heapster, 由于该组件需要多个pod协作, 并且部署时使用了名称解析服务, 所以一定要确保: calico和coreDNS部署成功才能开始部署该组件。</p>
<h3 id="部署heapser"><a href="#部署heapser" class="headerlink" title="部署heapser"></a>部署heapser</h3><p>要部署heapster需要下面这些文件:</p>
<ul>
<li><a href="https://github.com/kubernetes/heapster/tree/master/deploy/kube-config/influxdb" target="_blank" rel="external">以influxdb为后端部署heapster的文件</a></li>
<li><a href="https://github.com/kubernetes/heapster/tree/master/deploy/kube-config/rbac" target="_blank" rel="external">rbac文件</a></li>
</ul>
<p>其中rbac不需要做调整等下可以直接使用, rabc.yaml文件内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">kind: ClusterRoleBinding</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">metadata:</div><div class="line">  name: heapster</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: system:heapster</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: heapster</div><div class="line">  namespace: kube-system</div></pre></td></tr></table></figure></p>
<p>heapster.yaml: 注意修改镜像地址为你私有仓库地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  name: heapster</div><div class="line">  namespace: kube-system</div><div class="line">---</div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: heapster</div><div class="line">  namespace: kube-system</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        task: monitoring</div><div class="line">        k8s-app: heapster</div><div class="line">    spec:</div><div class="line">      serviceAccountName: heapster</div><div class="line">      containers:</div><div class="line">      - name: heapster</div><div class="line">        image: 192.168.204.15/kubernetes/heapster-amd64:v1.5.0</div><div class="line">        imagePullPolicy: IfNotPresent</div><div class="line">        <span class="built_in">command</span>:</div><div class="line">        - /heapster</div><div class="line">        - --source=kubernetes.summary_api:https://kubernetes.default</div><div class="line">        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    task: monitoring</div><div class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></div><div class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></div><div class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></div><div class="line">    kubernetes.io/name: Heapster</div><div class="line">  name: heapster</div><div class="line">  namespace: kube-system</div><div class="line">spec:</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">  ports:</div><div class="line">  - port: 80</div><div class="line">    targetPort: 8082</div><div class="line">  selector:</div><div class="line">    k8s-app: heapster</div></pre></td></tr></table></figure></p>
<ul>
<li>官方提供1.4.2, 但是addon组件已经使用到了1.5.0, 因此这里使用1.5.0版本的heapster</li>
<li>kubernetes.summary_api 使用批量采集的模式, 这也是推荐模式, 由于不知道是否默认开启, 这里手动指定下</li>
</ul>
<p>influxdb.yaml: 同样需要修改镜像地址, 其他无需修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: monitoring-influxdb</div><div class="line">  namespace: kube-system</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        task: monitoring</div><div class="line">        k8s-app: influxdb</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: influxdb</div><div class="line">        image: 192.168.204.15/kubernetes/heapster-influxdb:v1.3.3</div><div class="line">        volumeMounts:</div><div class="line">        - mountPath: /data</div><div class="line">          name: influxdb-storage</div><div class="line">      volumes:</div><div class="line">      - name: influxdb-storage</div><div class="line">        emptyDir: &#123;&#125;</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    task: monitoring</div><div class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></div><div class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></div><div class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></div><div class="line">    kubernetes.io/name: monitoring-influxdb</div><div class="line">  name: monitoring-influxdb</div><div class="line">  namespace: kube-system</div><div class="line">spec:</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">  ports:</div><div class="line">  - port: 8086</div><div class="line">    targetPort: 8086</div><div class="line">  selector:</div><div class="line">    k8s-app: influxdb</div></pre></td></tr></table></figure></p>
<p>grafana.yaml: 同样需要修改镜像地址, 其他无需修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: monitoring-grafana</div><div class="line">  namespace: kube-system</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        task: monitoring</div><div class="line">        k8s-app: grafana</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: grafana</div><div class="line">        image: 192.168.204.15/kubernetes/heapster-grafana:v4.4.3</div><div class="line">        ports:</div><div class="line">        - containerPort: 3000</div><div class="line">          protocol: TCP</div><div class="line">        volumeMounts:</div><div class="line">        - mountPath: /etc/ssl/certs</div><div class="line">          name: ca-certificates</div><div class="line">          readOnly: true</div><div class="line">        - mountPath: /var</div><div class="line">          name: grafana-storage</div><div class="line">        env:</div><div class="line">        - name: INFLUXDB_HOST</div><div class="line">          value: monitoring-influxdb</div><div class="line">        - name: GF_SERVER_HTTP_PORT</div><div class="line">          value: &quot;3000&quot;</div><div class="line">          # The following env variables are required to make Grafana accessible via</div><div class="line">          # the kubernetes api-server proxy. On production clusters, we recommend</div><div class="line">          # removing these env variables, setup auth for grafana, and expose the grafana</div><div class="line">          # service using a LoadBalancer or a public IP.</div><div class="line">        - name: GF_AUTH_BASIC_ENABLED</div><div class="line">          value: &quot;false&quot;</div><div class="line">        - name: GF_AUTH_ANONYMOUS_ENABLED</div><div class="line">          value: &quot;true&quot;</div><div class="line">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</div><div class="line">          value: Admin</div><div class="line">        - name: GF_SERVER_ROOT_URL</div><div class="line">          # If you&apos;re only using the API Server proxy, set this value instead:</div><div class="line">          # value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</div><div class="line">          value: /</div><div class="line">      volumes:</div><div class="line">      - name: ca-certificates</div><div class="line">        hostPath:</div><div class="line">          path: /etc/ssl/certs</div><div class="line">      - name: grafana-storage</div><div class="line">        emptyDir: &#123;&#125;</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</div><div class="line">    # If you are NOT using this as an addon, you should comment out this line.</div><div class="line">    kubernetes.io/cluster-service: &apos;true&apos;</div><div class="line">    kubernetes.io/name: monitoring-grafana</div><div class="line">  name: monitoring-grafana</div><div class="line">  namespace: kube-system</div><div class="line">spec:</div><div class="line">  # In a production setup, we recommend accessing Grafana through an external Loadbalancer</div><div class="line">  # or through a public IP.</div><div class="line">  # type: LoadBalancer</div><div class="line">  # You could also use NodePort to expose the service at a randomly-generated port</div><div class="line">  type: NodePort</div><div class="line">  ports:</div><div class="line">  - port: 80</div><div class="line">    targetPort: 3000</div><div class="line">  selector:</div><div class="line">    k8s-app: grafana</div></pre></td></tr></table></figure></p>
<p>然后启动heapster<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 heapster]<span class="comment"># ls</span></div><div class="line">grafana.yaml  heapster-rbac.yaml  heapster.yaml  influxdb.yaml</div><div class="line">[root@k8s-apiserver01 heapster]<span class="comment"># kubectl create -f .</span></div></pre></td></tr></table></figure></p>
<p>验证heapster服务是否启动成功:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 heapster]<span class="comment"># kubectl get svc -n kube-system</span></div><div class="line">NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</div><div class="line">heapster               NodePort    10.254.67.244    &lt;none&gt;        80:31408/TCP     1d</div><div class="line">kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP    2d</div><div class="line">kubernetes-dashboard   NodePort    10.254.227.210   &lt;none&gt;        443:31580/TCP    2d</div><div class="line">monitoring-grafana     NodePort    10.254.168.229   &lt;none&gt;        80:31708/TCP     1d</div><div class="line">monitoring-influxdb    NodePort    10.254.245.244   &lt;none&gt;        8086:31609/TCP   1d</div><div class="line">[root@k8s-apiserver01 heapster]<span class="comment"># kubectl get pods  -n kube-system</span></div><div class="line">NAME                                       READY     STATUS    RESTARTS   AGE</div><div class="line">calico-kube-controllers-76ddc77958-pc7t2   1/1       Running   1          2d</div><div class="line">calico-node-4jr45                          2/2       Running   2          2d</div><div class="line">calico-node-5cvkj                          2/2       Running   0          1d</div><div class="line">calico-node-sllgc                          2/2       Running   0          2d</div><div class="line">calico-node-xwf7g                          2/2       Running   2          2d</div><div class="line">coredns-79959c7b7f-b4jtw                   1/1       Running   0          2d</div><div class="line">coredns-79959c7b7f-ghl79                   1/1       Running   1          2d</div><div class="line">heapster-79985cdc9f-j6m42                  1/1       Running   0          1d</div><div class="line">kubernetes-dashboard-79bb795c55-x2mkx      1/1       Running   1          2d</div><div class="line">monitoring-grafana-bfbb54ddb-nn7wg         1/1       Running   0          1d</div><div class="line">monitoring-influxdb-75f476dc7b-cv5t8       1/1       Running   0          1d</div></pre></td></tr></table></figure></p>
<p>最后通过kubectl logs查看启动日志, 或者通过dashboard查看容器日志, 确保没有报错。这heapster部署成功</p>
<p><strong>注意:</strong> 由于heapster需要服务node节点的kubelet服务(其实是cadviser), 因此calico在部署的时候需要开启容器内部网络和node网络的通信, calico启动的FELIX_DEFAULTENDPOINTTOHOSTACTION环境变量设置为ACCEPT则表示开始, 但是允许容器网络和node网络互通是很危险的, 而且即使我开始了也没通:<code>由于calico使用的是bgp的方案, 而我的环境是基于Openstack的虚拟机, 在IaaS层, openstack neutro网络是不允许非neutro分配的IP地址直接出去的, 因此我找到heapster所有容器的主机, 使用一条SNAT规则, 让heapster所在的node代理其访问node节点所在网络。</code>, 如果你IaaS层没有限制, 这无需进行下面的SNAT操作:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 允许heapster所有网络 访问 node网络, 通过node为代理</span></div><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span> 192.168.135.0/24 <span class="_">-d</span> 192.168.204.0/24 -j SNAT --to-source 192.168.204.7</div><div class="line">[root@k8s-node03 ~]<span class="comment"># iptables -t nat -L -nv | grep SNAT</span></div><div class="line">    7   468 SNAT       all  --  *      *       192.168.135.0/24     192.168.204.0/24     to:192.168.204.7</div></pre></td></tr></table></figure></p>
<h3 id="验证heapster"><a href="#验证heapster" class="headerlink" title="验证heapster"></a>验证heapster</h3><p>成功部署后, 进行验证:</p>
<ol>
<li><p>heapster服务验证: 找到heapster服务的内部IP, 然后在启动一个container访问heapster服务ip, 如果正常说明heapster工作正常:<br><img src="http://oiw1gzfww.bkt.clouddn.com/heapster-test.jpg" alt=""></p>
</li>
<li><p>top命令工作正常:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 heapster]<span class="comment"># kubectl top nodes</span></div><div class="line">NAME            CPU(cores)   CPU%      MEMORY(bytes)   MEMORY%</div><div class="line">192.168.204.4   1929m        96%       1698Mi          46%</div><div class="line">192.168.204.6   1981m        99%       1822Mi          49%</div><div class="line">192.168.204.7   1274m        63%       1564Mi          42%</div><div class="line">192.168.204.3   1286m        64%       2034Mi          55%</div></pre></td></tr></table></figure>
</li>
<li><p>访问grafana: grafana通过nodePort导出后, 直接通过NodeIP进行访问, 工作正常如下图:<br><img src="http://oiw1gzfww.bkt.clouddn.com/heapster-grafana.jpg" alt=""></p>
</li>
<li><p>dashboard上可以看到相关metri的图表展示了:<br><img src="http://oiw1gzfww.bkt.clouddn.com/dashboard-with-heapster.jpg" alt=""></p>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/" target="_blank" rel="external">calico install documentation</a></li>
<li><a href="https://github.com/containernetworking/cni" target="_blank" rel="external">cni github</a></li>
<li><a href="https://github.com/coredns/deployment/tree/master/kubernetes" target="_blank" rel="external">coreDNS deploy</a></li>
<li><a href="https://github.com/kubernetes/dashboard#kubernetes-dashboard" target="_blank" rel="external">kubernetes-dashboard github</a></li>
<li><a href="https://github.com/kubernetes/dashboard/wiki/Creating-sample-user" target="_blank" rel="external">kubernetes-dashborad create sample user</a></li>
<li><a href="https://github.com/kubernetes/heapster" target="_blank" rel="external">kubernetes-heapster</a></li>
<li><a href="https://github.com/kubernetes/heapster/blob/master/docs/influxdb.md" target="_blank" rel="external">heapster influxdb backend installation</a></li>
</ul>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="http://oiw1gzfww.bkt.clouddn.com/alipay.jpg" alt="紫川秀 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/23/harbor/" rel="next" title="企业级Docker镜像仓库harbor的部署和使用">
                <i class="fa fa-chevron-left"></i> 企业级Docker镜像仓库harbor的部署和使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/02/06/kubernetes-shipping-log-with-filebeat/" rel="prev" title="使用filebeat收集kubernetes容器日志">
                使用filebeat收集kubernetes容器日志 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjIwMy84NzY3"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://oiw1gzfww.bkt.clouddn.com/me.png"
                alt="紫川秀" />
            
              <p class="site-author-name" itemprop="name">紫川秀</p>
              <p class="site-description motion-element" itemprop="description">喜欢Linux, Coding, 文艺, 运动。 生活如此多彩，我时间挥霍不过来。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">58</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yumaojun03" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://douban.com/people/155892492" target="_blank" title="豆瓣">
                    
                      <i class="fa fa-fw fa-globe"></i>豆瓣</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.zhihu.com/people/zi-chuan-xiu-86" target="_blank" title="知乎">
                    
                      <i class="fa fa-fw fa-globe"></i>知乎</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.liaoxuefeng.com/" title="廖雪峰官网" target="_blank">廖雪峰官网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xiaorui.cc/" title="峰云,就她了" target="_blank">峰云,就她了</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#插件镜像准备"><span class="nav-number">1.</span> <span class="nav-text">插件镜像准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络插件-Calico"><span class="nav-number">2.</span> <span class="nav-text">网络插件-Calico</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署注意事项"><span class="nav-number">2.1.</span> <span class="nav-text">部署注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master安装calicoctl"><span class="nav-number">2.2.</span> <span class="nav-text">master安装calicoctl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DaemonSet安装calico插件"><span class="nav-number">2.3.</span> <span class="nav-text">DaemonSet安装calico插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务发现插件-CoreDNS"><span class="nav-number">3.</span> <span class="nav-text">服务发现插件-CoreDNS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署CoreDNS"><span class="nav-number">3.1.</span> <span class="nav-text">部署CoreDNS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试DNS是否正常"><span class="nav-number">3.2.</span> <span class="nav-text">测试DNS是否正常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可视化插件-Dashborad"><span class="nav-number">4.</span> <span class="nav-text">可视化插件-Dashborad</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群监控插件-Heapster"><span class="nav-number">5.</span> <span class="nav-text">集群监控插件-Heapster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署heapser"><span class="nav-number">5.1.</span> <span class="nav-text">部署heapser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证heapster"><span class="nav-number">5.2.</span> <span class="nav-text">验证heapster</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">紫川秀</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("51RM6PwqfSuyOFX9MxLeq5yY-gzGzoHsz", "dNQYvnf4KlnN364JVGClL7bp");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
