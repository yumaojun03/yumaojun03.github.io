<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç´«å·ç§€çš„åšå®¢</title>
  <subtitle>æ¯”ä½ ä¼˜ç§€çš„äººä¸å¯æ€•,å¯æ€•çš„æ˜¯æ¯”ä½ ä¼˜ç§€çš„äººæ¯”ä½ æ›´åŠªåŠ›ã€‚</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.yumaojun.net/"/>
  <updated>2018-01-23T06:32:41.000Z</updated>
  <id>https://blog.yumaojun.net/</id>
  
  <author>
    <name>ç´«å·ç§€</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä¼ä¸šçº§Dockeré•œåƒä»“åº“harborçš„éƒ¨ç½²å’Œä½¿ç”¨</title>
    <link href="https://blog.yumaojun.net/2018/01/23/harbor/"/>
    <id>https://blog.yumaojun.net/2018/01/23/harbor/</id>
    <published>2018-01-23T01:34:05.000Z</published>
    <updated>2018-01-23T06:32:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>éƒ¨ç½²ä¼ä¸šç§æœ‰ä»“åº“å¾€å¾€æ˜¯å¾ˆæœ‰å¿…è¦çš„, ä»–å¯ä»¥å¸®åŠ©ä½ ç®¡ç†ä¼ä¸šçš„ä¸€äº›æ•æ„Ÿé•œåƒ, åŒæ—¶ç”±äºDocker Hubçš„ä¸‹è½½é€Ÿåº¦å’ŒGFWçš„åŸå› , å¾€å¾€éœ€è¦å°†ä¸€äº›æ— æ³•ç›´æ¥ä¸‹è½½çš„é•œåƒå¯¼å…¥æœ¬åœ°ç§æœ‰ä»“åº“. è€ŒHarborå°±æ˜¯éƒ¨ç½²ä¼ä¸šç§æœ‰ä»“åº“çš„ä¸€ä¸ªä¸äºŒä¹‹é€‰ã€‚<br><a id="more"></a></p>
<h2 id="Harbarç®€ä»‹"><a href="#Harbarç®€ä»‹" class="headerlink" title="Harbarç®€ä»‹"></a>Harbarç®€ä»‹</h2><p>Harboræ˜¯VMwareå…¬å¸å¼€æºäº†ä¼ä¸šçº§Registryé¡¹ç›®, å…¶çš„ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Docker registryæœåŠ¡ã€‚å®ƒä»¥Dockerå…¬å¸å¼€æºçš„registryä¸ºåŸºç¡€ï¼Œé¢å¤–æä¾›äº†å¦‚ä¸‹åŠŸèƒ½:</p>
<ul>
<li>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(Role Based Access Control)</li>
<li>åŸºäºç­–ç•¥çš„é•œåƒå¤åˆ¶(Policy based image replication)</li>
<li>é•œåƒçš„æ¼æ´æ‰«æ(Vulnerability Scanning)</li>
<li>AD/LDAPé›†æˆ(LDAP/AD support)</li>
<li>é•œåƒçš„åˆ é™¤å’Œç©ºé—´æ¸…ç†(Image deletion &amp; garbage collection)</li>
<li>å‹å¥½çš„ç®¡ç†UI(Graphical user portal)</li>
<li>å®¡è®¡æ—¥å¿—(Audit logging)</li>
<li>RESTful API</li>
<li>éƒ¨ç½²ç®€å•(Easy deployment)</li>
</ul>
<h2 id="æ¶æ„ä»‹ç»"><a href="#æ¶æ„ä»‹ç»" class="headerlink" title="æ¶æ„ä»‹ç»"></a>æ¶æ„ä»‹ç»</h2><p>è¿™é‡Œå€Ÿç”¨åˆ«äººä¸€å¼ å›¾:<br><img src="http://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadYLYqNu7t7m83nx76xPS8h4OkFTNOPhnPibbv5OvKFNyqwooccOibB5icia4UJcKBkGWMFBEDz1mNXXlw/0?wx_fmt=png" alt="Harbor Architecture"></p>
<p>Harborä¾èµ–çš„å¤–éƒ¨ç»„ä»¶:</p>
<ul>
<li>Nginx(Proxy): Harborçš„registry,UI,tokenç­‰æœåŠ¡ï¼Œé€šè¿‡ä¸€ä¸ªå‰ç½®çš„åå‘ä»£ç†ç»Ÿä¸€æ¥æ”¶æµè§ˆå™¨ã€Dockerå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘ç»™åç«¯ä¸åŒçš„æœåŠ¡ã€‚</li>
<li>Registry v2: Dockerå®˜æ–¹é•œåƒä»“åº“, è´Ÿè´£å‚¨å­˜Dockeré•œåƒï¼Œå¹¶å¤„ç†docker push/pullå‘½ä»¤ã€‚ç”±äºæˆ‘ä»¬è¦å¯¹ç”¨æˆ·è¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå³ä¸åŒç”¨æˆ·å¯¹Docker imageæœ‰ä¸åŒçš„è¯»å†™æƒé™ï¼ŒRegistryä¼šæŒ‡å‘ä¸€ä¸ªtokenæœåŠ¡ï¼Œå¼ºåˆ¶ç”¨æˆ·çš„æ¯æ¬¡docker pull/pushè¯·æ±‚éƒ½è¦æºå¸¦ä¸€ä¸ªåˆæ³•çš„token, Registryä¼šé€šè¿‡å…¬é’¥å¯¹tokenè¿›è¡Œè§£å¯†éªŒè¯ã€‚</li>
<li>Database(MySQL)ï¼šä¸ºcore servicesæä¾›æ•°æ®åº“æœåŠ¡ï¼Œè´Ÿè´£å‚¨å­˜ç”¨æˆ·æƒé™ã€å®¡è®¡æ—¥å¿—ã€Docker imageåˆ†ç»„ä¿¡æ¯ç­‰æ•°æ®ã€‚</li>
</ul>
<p>Harborè‡ªå·±ç»„ä»¶:</p>
<ul>
<li>Core services(Admin Server): è¿™æ˜¯Harborçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸»è¦æä¾›ä»¥ä¸‹æœåŠ¡ï¼š<ul>
<li>UIï¼šæä¾›å›¾å½¢åŒ–ç•Œé¢ï¼Œå¸®åŠ©ç”¨æˆ·ç®¡ç†registryä¸Šçš„é•œåƒï¼ˆimageï¼‰, å¹¶å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒã€‚</li>
<li>webhookï¼šä¸ºäº†åŠæ—¶è·å–registry ä¸ŠimageçŠ¶æ€å˜åŒ–çš„æƒ…å†µï¼Œ åœ¨Registryä¸Šé…ç½®webhookï¼ŒæŠŠçŠ¶æ€å˜åŒ–ä¼ é€’ç»™UIæ¨¡å—ã€‚</li>
<li>AuthæœåŠ¡ï¼šè´Ÿè´£æ ¹æ®ç”¨æˆ·æƒé™ç»™æ¯ä¸ªdocker push/pullå‘½ä»¤ç­¾å‘token. Docker å®¢æˆ·ç«¯å‘RegiÃ¸stryæœåŠ¡å‘èµ·çš„è¯·æ±‚,å¦‚æœä¸åŒ…å«tokenï¼Œä¼šè¢«é‡å®šå‘åˆ°è¿™é‡Œï¼Œè·å¾—tokenåå†é‡æ–°å‘Registryè¿›è¡Œè¯·æ±‚ã€‚</li>
<li>API: æä¾›Harbor RESTful API</li>
</ul>
</li>
<li>Replication Job Serviceï¼šæä¾›å¤šä¸ª Harbor å®ä¾‹ä¹‹é—´çš„é•œåƒåŒæ­¥åŠŸèƒ½ã€‚</li>
<li>Log collectorï¼šä¸ºäº†å¸®åŠ©ç›‘æ§Harborè¿è¡Œï¼Œè´Ÿè´£æ”¶é›†å…¶ä»–ç»„ä»¶çš„logï¼Œä¾›æ—¥åè¿›è¡Œåˆ†æã€‚</li>
</ul>
<h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>è¿™é‡Œä¸ä½¿ç”¨kubernetesæ¥éƒ¨ç½², åŸå› æ˜¯é•œåƒä»“åº“éå¸¸é‡è¦, å°½é‡ä¿è¯éƒ¨ç½²å’Œç»´æŠ¤çš„ç®€æ´æ€§, å› æ­¤è¿™é‡Œç›´æ¥ä½¿ç”¨composeçš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚<br>å®˜æ–¹æä¾›3ç§éƒ¨ç½²Harborçš„æ–¹å¼:</p>
<ul>
<li>åœ¨çº¿å®‰è£…: ä»Docker Hubä¸‹è½½Harborçš„é•œåƒæ¥å®‰è£…, ç”±äºDocker Hubæ¯”è¾ƒæ…¢, å»ºè®®Dockeré…ç½®å¥½åŠ é€Ÿå™¨ã€‚</li>
<li>ç¦»çº¿å®‰è£…: è¿™ç§æ–¹å¼åº”å¯¹ä¸éƒ¨ç½²ä¸»æœºæ²¡è”ç½‘çš„æƒ…å†µä½¿ç”¨ã€‚éœ€è¦æå‰ä¸‹è½½ç¦»çº¿å®‰è£…åŒ…: harbor-offline-installer-<version>.tgz åˆ°æœ¬åœ°</version></li>
<li>OVAå®‰è£…: è¿™ä¸ªä¸»è¦ç”¨vCentorç¯å¢ƒæ˜¯ä½¿ç”¨</li>
</ul>
<p>åé¢éƒ¨ç½²æ—¶ä¼šä¸ºDockeré…ç½®é•œåƒåŠ é€Ÿå™¨, å› æ­¤ä¼šé‡‡ç”¨åœ¨çº¿éƒ¨ç½²çš„æ–¹å¼, éƒ¨ç½²æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>ä¸‹è½½Harboræœ€æ–°çš„åœ¨çº¿å®‰è£…åŒ…</li>
<li>é…ç½®Harbor(harbor.cfg)</li>
<li>è¿è¡Œinstall.shæ¥å®‰è£…å’Œå¯åŠ¨Harbor</li>
</ul>
<h3 id="ç¯å¢ƒè¦æ±‚ä¸å‡†å¤‡"><a href="#ç¯å¢ƒè¦æ±‚ä¸å‡†å¤‡" class="headerlink" title="ç¯å¢ƒè¦æ±‚ä¸å‡†å¤‡"></a>ç¯å¢ƒè¦æ±‚ä¸å‡†å¤‡</h3><p>Harborä»¥å®¹å™¨çš„å½¢å¼è¿›è¡Œéƒ¨ç½², å› æ­¤å¯ä»¥è¢«éƒ¨ç½²åˆ°ä»»ä½•æ”¯æŒDockerçš„Linuxå‘è¡Œç‰ˆ, å¹¶ä¸”å…·å¤‡å¦‚ä¸‹ç¯å¢ƒ:</p>
<ul>
<li>Python2.7+</li>
<li>Docker Engine 1.10+</li>
<li>Docker Compose 1.6.0+</li>
</ul>
<p>è¿™é‡Œä½¿ç”¨CentOS7.3çš„ç³»ç»Ÿ, Python2.7ç³»ç»Ÿè‡ªå¸¦äº†, å‰©ä¸‹çš„å°±æ˜¯å®‰è£…Dockerå’ŒCompose:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@harbor01 ~]<span class="comment"># yum install docker -y</span></div><div class="line">[root@harbor01 ~]<span class="comment"># yum -y install epel-release</span></div><div class="line">[root@harbor01 ~]<span class="comment"># yum install python-pip -y</span></div><div class="line">[root@harbor01 ~]<span class="comment"># pip install docker-compose</span></div><div class="line"><span class="comment"># æŸ¥çœ‹å®‰è£…å®Œæˆçš„Dockerå’ŒComposeçš„ç‰ˆæœ¬</span></div><div class="line">[root@harbor01 ~]<span class="comment"># docker version</span></div><div class="line">Client:</div><div class="line"> Version:         1.12.6</div><div class="line"> API version:     1.24</div><div class="line"> Package version: docker-1.12.6-68.gitec8512b.el7.centos.x86_64</div><div class="line"> Go version:      go1.8.3</div><div class="line"> Git commit:      ec8512b/1.12.6</div><div class="line"> Built:           Mon Dec 11 16:08:42 2017</div><div class="line"> OS/Arch:         linux/amd64</div><div class="line">Cannot connect to the Docker daemon. Is the docker daemon running on this host?</div><div class="line">[root@harbor01 ~]<span class="comment"># pip freeze | grep compose</span></div><div class="line">docker-compose==1.18.0</div></pre></td></tr></table></figure></p>
<p>ä¸ºDockeré…ç½®åŠ é€Ÿå™¨, æ–¹ä¾¿é€šè¿‡å›½å†…é•œåƒæœåŠ¡å™¨å¿«é€Ÿæ‹‰å–Docker Hubæä¾›çš„é•œåƒ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/docker</div><div class="line">tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://v5d7kh0f.mirror.aliyuncs.com"</span>]</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">systemctl <span class="built_in">enable</span> docker</div><div class="line">systemctl start  docker</div><div class="line">systemctl status  docker</div></pre></td></tr></table></figure></p>
<p><strong>ä¸‹è½½å®‰è£…åŒ…</strong><br>åˆ°Harborçš„GitHubä»“åº“çš„<a href="https://github.com/vmware/harbor/releases" target="_blank" rel="external">Releaseé¡µé¢</a>, ä¸‹è½½æœ€æ–°çš„åœ¨çº¿å®‰è£…åŒ…(å¦‚æœä¸‹è½½ä¸äº†, è¯·ä»è¿™é‡Œä¸‹è½½<a href="https://pan.baidu.com/s/1eTDUW0a" target="_blank" rel="external">ç™¾åº¦ç½‘ç›˜Harborå®‰è£…åŒ…</a>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@harbor01 ~]<span class="comment"># wget https://storage.googleapis.com/harbor-releases/harbor-online-installer-v1.3.0.tgz</span></div><div class="line">[root@harbor01 ~]<span class="comment"># tar vxf harbor-online-installer-v1.3.0.tgz</span></div></pre></td></tr></table></figure></p>
<p><strong>é…ç½®Harbor</strong><br>harborçš„æ–‡ä»¶æ–‡ä»¶åœ¨å«: harbor.cfg, è¿™é‡Œæœ‰å‡ å¤„å¿…è¦é…ç½®éœ€è¦ä¿®æ”¹:</p>
<ul>
<li>hostname: ä¿®æ”¹æˆä½ æœ¬æœºçš„ipåœ°å€</li>
<li>db_password: æ•°æ®åº“rootå¯†ç </li>
<li><code>harbor_admin_password</code>: harboråˆå§‹ç®¡ç†å‘˜å¯†ç ä¸ºHarbor12345, è¿™é‡Œæœ€å¥½ä¿®æ”¹æˆè‡ªå·±çš„<br>å…¶ä»–è¯¦ç»†çš„å‚æ•°è¯·æŸ¥çœ‹Harborå®˜æ–¹æ–‡æ¡£(è§å‚è€ƒ)</li>
</ul>
<p><strong>å¯åŠ¨Harbor</strong><br>è§£å‹å®Œè¿‡åå†harborç›®å½•ä¸‹æœ‰ä¸€ä¸ªinstall.sh, æ‰§è¡Œå®ƒæ¥è¿›è¡Œå®‰è£…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@harbor01 harbor]<span class="comment"># ./install.sh</span></div><div class="line">[root@harbor01 harbor]<span class="comment"># docker-compose ps</span></div><div class="line">       Name                     Command               State                                Ports</div><div class="line">------------------------------------------------------------------------------------------------------------------------------</div><div class="line">harbor-adminserver   /harbor/start.sh                 Up</div><div class="line">harbor-db            /usr/<span class="built_in">local</span>/bin/docker-entr ...   Up      3306/tcp</div><div class="line">harbor-jobservice    /harbor/start.sh                 Up</div><div class="line">harbor-log           /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp</div><div class="line">harbor-ui            /harbor/start.sh                 Up</div><div class="line">nginx                nginx -g daemon off;             Up      0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:80-&gt;80/tcp</div><div class="line">registry             /entrypoint.sh serve /etc/ ...   Up      5000/tcp</div></pre></td></tr></table></figure></p>
<p>ç„¶åè®¿é—®:<br><img src="http://oiw1gzfww.bkt.clouddn.com/harbor_page.jpg" alt=""></p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>æœåŠ¡å®‰è£…å¥½äº†è¿‡å, ä¸‹é¢ä»‹ç»å¦‚ä½•é€šè¿‡Docker Clientä½¿ç”¨Harbor</p>
<h3 id="é…ç½®dockerå®¢æˆ·ç«¯ä½¿ç”¨Harbor"><a href="#é…ç½®dockerå®¢æˆ·ç«¯ä½¿ç”¨Harbor" class="headerlink" title="é…ç½®dockerå®¢æˆ·ç«¯ä½¿ç”¨Harbor"></a>é…ç½®dockerå®¢æˆ·ç«¯ä½¿ç”¨Harbor</h3><p>å› ä¸ºHarborå¼€å¯çš„æ˜¯HTTPæœåŠ¡, è€Œä¸æ˜¯HTTPS, æ‰€ä»¥è¦ä¿®æ”¹ä¸‹Dockerçš„é…ç½®:/etc/docker/daemon.json, æ·»åŠ å‚æ•°insecure-registries:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@harbor01 ~]<span class="comment"># cat /etc/docker/daemon.json</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://v5d7kh0f.mirror.aliyuncs.com"</span>],</div><div class="line">  <span class="string">"insecure-registries"</span>: [<span class="string">"192.168.204.15"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¿®æ”¹è¿‡åä»å¯docker, ç„¶åä»å¯HarboræœåŠ¡:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@harbor01 harbor]<span class="comment"># systemctl restart docker</span></div><div class="line">[root@harbor01 harbor]<span class="comment"># docker-compose stop</span></div><div class="line">Stopping harbor-jobservice  ... <span class="keyword">done</span></div><div class="line">Stopping harbor-ui          ... <span class="keyword">done</span></div><div class="line">Stopping harbor-db          ... <span class="keyword">done</span></div><div class="line">Stopping registry           ... <span class="keyword">done</span></div><div class="line">Stopping harbor-adminserver ... <span class="keyword">done</span></div><div class="line">Stopping harbor-log         ... <span class="keyword">done</span></div><div class="line">[root@harbor01 harbor]<span class="comment"># docker-compose start</span></div><div class="line">Starting <span class="built_in">log</span>         ... <span class="keyword">done</span></div><div class="line">Starting adminserver ... <span class="keyword">done</span></div><div class="line">Starting registry    ... <span class="keyword">done</span></div><div class="line">Starting ui          ... <span class="keyword">done</span></div><div class="line">Starting mysql       ... <span class="keyword">done</span></div><div class="line">Starting jobservice  ... <span class="keyword">done</span></div><div class="line">Starting proxy       ... <span class="keyword">done</span></div></pre></td></tr></table></figure></p>
<h3 id="é•œåƒçš„Pushå’ŒPull"><a href="#é•œåƒçš„Pushå’ŒPull" class="headerlink" title="é•œåƒçš„Pushå’ŒPull"></a>é•œåƒçš„Pushå’ŒPull</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@harbor01 harbor]<span class="comment"># docker login 192.168.204.15</span></div><div class="line">Username: admin</div><div class="line">Password:</div><div class="line">Login Succeeded</div></pre></td></tr></table></figure>
<p>ä¸ºäº†ä½¿ç”¨Harboræˆ‘ä»¬éœ€è¦åœ¨Harborä¸Šå»ºç«‹ä¸€ä¸ªé¡¹ç›®:kubernetes<br><img src="http://oiw1gzfww.bkt.clouddn.com/harbor-project.jpg" alt=""><br><strong><em>æ³¨æ„</em></strong>: ä¸€å®šè¦å…ˆæœ‰é¡¹ç›® ç„¶åæŒ‰ç…§192.168.204.15/{project-name}/{image-name}[:Tag] çš„æ–¹å¼æ‰“Tag<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@harbor01 ~]<span class="comment"># docker tag docker.io/nginx:latest 192.168.204.15/kubernetes/nginx:v1.10</span></div><div class="line">[root@harbor01 ~]<span class="comment"># docker push 192.168.204.15/kubernetes/nginx:v1.10</span></div><div class="line">The push refers to a repository [192.168.204.15/kubernetes/nginx]</div><div class="line">a103d141<span class="built_in">fc</span>98: Pushed</div><div class="line">73e2bd445514: Pushed</div><div class="line">2ec5c0a4cb57: Pushed</div><div class="line">v1.10: digest: sha256:926b086e1234b6ae9a11589c4cece66b267890d24d1da388c96dd8795b2ffcfb size: 948</div></pre></td></tr></table></figure></p>
<p>ç„¶ååœ¨å¦ä¸€å°æœºå™¨ä¸Šé¢æ‹‰å–é•œåƒ(è®°å¾—é…ç½®Dockerå®¢æˆ·ç«¯insecure-registrieså‚æ•°, å‚è€ƒä¸Šé¢):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~/Blogs Â» docker pull 192.168.204.15/kubernetes/nginx:v1.10                                                                                                                                                                                                   maojun@maojun-mbp</div><div class="line">v1.10: Pulling from kubernetes/nginx</div><div class="line">e7bb522d92ff: Pull complete</div><div class="line">6edc05228666: Pull complete</div><div class="line">cd866a17e81f: Pull complete</div><div class="line">Digest: sha256:926b086e1234b6ae9a11589c4cece66b267890d24d1da388c96dd8795b2ffcfb</div><div class="line">Status: Downloaded newer image for 192.168.204.15/kubernetes/nginx:v1.10</div></pre></td></tr></table></figure></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/vmware/harbor" target="_blank" rel="external">Harbor GitHub</a></li>
<li><a href="https://github.com/vmware/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="external">Harbor å®‰è£…æ‰‹å†Œ</a></li>
<li><a href="https://github.com/vmware/harbor/blob/master/docs/user_guide.md" target="_blank" rel="external">Harbor ç”¨æˆ·æ‰‹å†Œ</a></li>
<li><a href="https://toutiao.io/posts/gbqfhv/preview" target="_blank" rel="external">ç”¨ Harbor å’Œ Kubernetes æ„å»ºé«˜å¯ç”¨ä¼ä¸šçº§é•œåƒä»“åº“</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;éƒ¨ç½²ä¼ä¸šç§æœ‰ä»“åº“å¾€å¾€æ˜¯å¾ˆæœ‰å¿…è¦çš„, ä»–å¯ä»¥å¸®åŠ©ä½ ç®¡ç†ä¼ä¸šçš„ä¸€äº›æ•æ„Ÿé•œåƒ, åŒæ—¶ç”±äºDocker Hubçš„ä¸‹è½½é€Ÿåº¦å’ŒGFWçš„åŸå› , å¾€å¾€éœ€è¦å°†ä¸€äº›æ— æ³•ç›´æ¥ä¸‹è½½çš„é•œåƒå¯¼å…¥æœ¬åœ°ç§æœ‰ä»“åº“. è€ŒHarborå°±æ˜¯éƒ¨ç½²ä¼ä¸šç§æœ‰ä»“åº“çš„ä¸€ä¸ªä¸äºŒä¹‹é€‰ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.yumaojun.net/categories/%E8%BF%90%E7%BB%B4/"/>
    
      <category term="kubernetes" scheme="https://blog.yumaojun.net/categories/%E8%BF%90%E7%BB%B4/kubernetes/"/>
    
    
      <category term="harbor" scheme="https://blog.yumaojun.net/tags/harbor/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åˆ©ç”¨kuberneteså®ç°åº”ç”¨çš„æ°´å¹³æ‰©å±•(HPA)</title>
    <link href="https://blog.yumaojun.net/2018/01/22/kubernetes-heapster/"/>
    <id>https://blog.yumaojun.net/2018/01/22/kubernetes-heapster/</id>
    <published>2018-01-22T09:10:57.000Z</published>
    <updated>2018-01-22T09:41:55.000Z</updated>
    
    <content type="html"><![CDATA[<p>äº‘è®¡ç®—å…·æœ‰æ°´å¹³å¼¹æ€§çš„ç‰¹æ€§ï¼Œè¿™ä¸ªæ˜¯äº‘è®¡ç®—åŒºåˆ«äºä¼ ç»ŸITæŠ€æœ¯æ¶æ„çš„ä¸»è¦ç‰¹æ€§ã€‚å¯¹äºKubernetesä¸­çš„PODé›†ç¾¤æ¥è¯´ï¼ŒHPAå¯ä»¥å®ç°å¾ˆå¤šè‡ªåŠ¨åŒ–åŠŸèƒ½ï¼Œæ¯”å¦‚å½“PODä¸­ä¸šåŠ¡è´Ÿè½½ä¸Šå‡çš„æ—¶å€™ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„PODæ¥ä¿è¯ä¸šåŠ¡ç³»ç»Ÿç¨³å®šè¿è¡Œï¼Œå½“PODä¸­ä¸šåŠ¡è´Ÿè½½ä¸‹é™çš„æ—¶å€™ï¼Œå¯ä»¥é”€æ¯PODæ¥æé«˜èµ„æºåˆ©ç”¨ç‡ã€‚<br><a id="more"></a></p>
<h2 id="HPAä»‹ç»"><a href="#HPAä»‹ç»" class="headerlink" title="HPAä»‹ç»"></a>HPAä»‹ç»</h2><p>Horizontal Pod Autoscalingï¼Œç®€ç§°HPAï¼Œæ˜¯Kubernetesä¸­å®ç°PODæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©çš„åŠŸèƒ½ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="external">Kubernetes Horizontal Pod Autoscaler</a></li>
<li><a href="https://github.com/kubernetes/heapster/blob/master/docs/influxdb.md" target="_blank" rel="external">Run Heapster in a Kubernetes cluster with an InfluxDB backend and a Grafana UI</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;äº‘è®¡ç®—å…·æœ‰æ°´å¹³å¼¹æ€§çš„ç‰¹æ€§ï¼Œè¿™ä¸ªæ˜¯äº‘è®¡ç®—åŒºåˆ«äºä¼ ç»ŸITæŠ€æœ¯æ¶æ„çš„ä¸»è¦ç‰¹æ€§ã€‚å¯¹äºKubernetesä¸­çš„PODé›†ç¾¤æ¥è¯´ï¼ŒHPAå¯ä»¥å®ç°å¾ˆå¤šè‡ªåŠ¨åŒ–åŠŸèƒ½ï¼Œæ¯”å¦‚å½“PODä¸­ä¸šåŠ¡è´Ÿè½½ä¸Šå‡çš„æ—¶å€™ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„PODæ¥ä¿è¯ä¸šåŠ¡ç³»ç»Ÿç¨³å®šè¿è¡Œï¼Œå½“PODä¸­ä¸šåŠ¡è´Ÿè½½ä¸‹é™çš„æ—¶å€™ï¼Œå¯ä»¥é”€æ¯PODæ¥æé«˜èµ„æºåˆ©ç”¨ç‡ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.yumaojun.net/categories/%E8%BF%90%E7%BB%B4/"/>
    
      <category term="kubernetes" scheme="https://blog.yumaojun.net/categories/%E8%BF%90%E7%BB%B4/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="https://blog.yumaojun.net/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes 1.8.7 ç¦»çº¿éƒ¨ç½²æ‰‹å†Œ</title>
    <link href="https://blog.yumaojun.net/2018/01/18/kubernetes-binary-install/"/>
    <id>https://blog.yumaojun.net/2018/01/18/kubernetes-binary-install/</id>
    <published>2018-01-18T07:07:51.000Z</published>
    <updated>2018-01-22T03:15:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ­å»ºkubernetesé›†ç¾¤æœ€å¤§çš„éº»çƒ¦å…¶å®ä¸åœ¨äºå…¶å¤æ‚åº¦(ç›¸å¯¹Openstacké›†ç¾¤)è€Œåœ¨äºæœ‰GFW, æ‰€ä»¥ä¸ºäº†é¿å…å¢™å¸¦æ¥çš„éº»çƒ¦, ä¹Ÿä¸ºäº†åŠ æ·±å¯¹kubernetesçš„ç†è§£, è¿™é‡Œå°†ä½¿ç”¨çº¯æ‰‹å·¥ç¦»çº¿çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²(ç›¸åº”çš„æ–‡ä»¶æˆ‘å·²ç»ä¸‹è½½åˆ°ç™¾åº¦äº‘ç›˜é‡Œé¢)ã€‚<br><a id="more"></a></p>
<h2 id="ç¯å¢ƒä»‹ç»"><a href="#ç¯å¢ƒä»‹ç»" class="headerlink" title="ç¯å¢ƒä»‹ç»"></a>ç¯å¢ƒä»‹ç»</h2><p>ä¸‹é¢Kubernetesé›†ç¾¤æ­å»ºéœ€è¦çš„ç‰ˆæœ¬ä¿¡æ¯:</p>
<table>
<thead>
<tr>
<th>è½¯ä»¶</th>
<th>ç‰ˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>OS</td>
<td>CentOS Linux release 7.3.1611 (Core)</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>1.8.7</td>
</tr>
<tr>
<td>Docker</td>
<td>1.12.6</td>
</tr>
<tr>
<td>Etcd</td>
<td>3.2.7</td>
</tr>
<tr>
<td>Flannel</td>
<td>0.7.1</td>
</tr>
<tr>
<td>Kubernetes-dashboard</td>
<td>1.7.1</td>
</tr>
</tbody>
</table>
<p>æˆ‘ä»¬å°†åœ¨å››å°CentOSç³»ç»Ÿçš„ç‰©ç†æœºä¸Šéƒ¨ç½²1master 3nodeçš„kubernetes1.8.7é›†ç¾¤(æˆªæ­¢å½“å‰2018.1æ˜¯æœ€æ–°ç‰ˆæœ¬):</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>Role</th>
<th>CPU</th>
<th>Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.204.3</td>
<td>master</td>
<td>2æ ¸</td>
<td>4G</td>
</tr>
<tr>
<td>192.168.204.6</td>
<td>node</td>
<td>2æ ¸</td>
<td>4G</td>
</tr>
<tr>
<td>192.168.204.14</td>
<td>node</td>
<td>2æ ¸</td>
<td>4G</td>
</tr>
<tr>
<td>192.168.204.13</td>
<td>node</td>
<td>2æ ¸</td>
<td>4G</td>
</tr>
</tbody>
</table>
<h2 id="é›†ç¾¤å‡†å¤‡"><a href="#é›†ç¾¤å‡†å¤‡" class="headerlink" title="é›†ç¾¤å‡†å¤‡"></a>é›†ç¾¤å‡†å¤‡</h2><p>åœ¨å¼€å§‹æ­å»ºé›†ç¾¤å‰éœ€è¦åšä¸€äº›åŸºç¡€å‡†å¤‡:</p>
<ol>
<li><p>åŒæ­¥é›†ç¾¤çš„æ—¶é—´<br>ç†è®ºä¸Šsystemdç³»ç»Ÿéƒ½è‡ªå¸¦äº†æ—¶é—´åŒæ­¥å’Œç®¡ç†çš„å·¥å…·, ä½¿ç”¨timedatectlå‘½ä»¤ç¡®è®¤ä¸‹, ç¡®ä¿NTP synchronizedä¸ºyes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver ~]<span class="comment"># timedatectl</span></div><div class="line">      Local time: å…­ 2018-01-20 02:47:59 EST</div><div class="line">  Universal time: å…­ 2018-01-20 07:47:59 UTC</div><div class="line">        RTC time: å…­ 2018-01-20 07:47:59</div><div class="line">       Time zone: America/New_York (EST, -0500)</div><div class="line">     NTP enabled: yes</div><div class="line">NTP synchronized: yes</div><div class="line"> RTC <span class="keyword">in</span> <span class="built_in">local</span> TZ: no</div><div class="line">      DST active: no</div><div class="line"> Last DST change: DST ended at</div><div class="line">                  æ—¥ 2017-11-05 01:59:59 EDT</div><div class="line">                  æ—¥ 2017-11-05 01:00:00 EST</div><div class="line"> Next DST change: DST begins (the clock jumps one hour forward) at</div><div class="line">                  æ—¥ 2018-03-11 01:59:59 EST</div><div class="line">                  æ—¥ 2018-03-11 03:00:00 EDT</div></pre></td></tr></table></figure>
</li>
<li><p>å…³é—­SELinux<br>SELinuxæ˜¯ç³»ç»Ÿä¸Šçš„æ²™ç›’æœºåˆ¶, ä¸ºäº†å°½å¿«æ­å»ºå‡ºé›†ç¾¤, å…ˆå…³é—­, å¦‚æœå¼ºè°ƒé«˜å®‰å…¨, å¯ä»¥ç­‰é›†ç¾¤æ­å»ºæˆåŠŸåå¼€å¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ç¡®è®¤SELinuxçš„é…ç½®, å¦‚æœä¸æ˜¯disabled, è¯·è®¾ç½®æˆdisabled, ç„¶åä»å¯ç³»ç»Ÿ</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># cat /etc/selinux/config  | grep ^SELINUX=</span></div><div class="line">SELINUX=disabled</div><div class="line"><span class="comment"># æŸ¥çœ‹å½“å‰SELinuxæ˜¯å¦å·²ç»æˆåŠŸå…³é—­</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># getenforce</span></div><div class="line">Disabled</div></pre></td></tr></table></figure>
</li>
<li><p>å…³é—­é˜²ç«å¢™(æ­å»ºæˆåŠŸåå¯ä»¥æ…¢æ…¢å¼€å¯)<br>systemdç³»ç»Ÿä¸€èˆ¬éƒ½é‡‡ç”¨firewalldä½œä¸ºé˜²ç«å¢™, åŒç†å¦‚æœæ²¡å…³é—­ å…ˆå…³é—­</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver ~]<span class="comment"># systemctl is-enabled firewalld</span></div><div class="line">disabled</div><div class="line"><span class="comment"># å¦‚æœæœªå…³é—­è¯·æ‰§è¡Œ</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># systemctl stop  firewalld</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># systemctl disable  firewalld</span></div><div class="line">[root@k8s-apiserver ~]<span class="comment"># systemctl is-enabled firewalld</span></div><div class="line">disabled</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="é›†ç¾¤éƒ¨ç½²"><a href="#é›†ç¾¤éƒ¨ç½²" class="headerlink" title="é›†ç¾¤éƒ¨ç½²"></a>é›†ç¾¤éƒ¨ç½²</h2><p>æ¥ä¸‹æ¥è¿›å…¥é›†ç¾¤çš„éƒ¨ç½²é˜¶æ®µ, éƒ¨ç½²åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªé˜¶æ®µ:</p>
<ul>
<li>CAå’Œè¯ä¹¦å‡†å¤‡</li>
<li>éƒ¨ç½²kuberneteså®¢æˆ·ç«¯å·¥å…·kubectl</li>
<li>nodeèŠ‚ç‚¹çš„TLSè¯ä¹¦å¼•å¯¼(TLS Bootstrap)é…ç½®å‡†å¤‡</li>
<li>éƒ¨ç½²ETCD</li>
<li>éƒ¨ç½²masterèŠ‚ç‚¹</li>
<li>éƒ¨ç½²nodeèŠ‚ç‚¹</li>
<li>é›†ç¾¤æµ‹è¯•</li>
<li>éƒ¨ç½²dashboardåº”ç”¨</li>
</ul>
<p>åœ¨è¿›å…¥éƒ¨ç½²ä¹‹å‰, å…ˆçœ‹çœ‹kubernetesç»„ä»¶çš„æ¶æ„:<br><img src="http://oiw1gzfww.bkt.clouddn.com/architecture.png" alt="Kubernetesæ¶æ„å›¾"></p>
<p>Kubernetesä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š</p>
<ul>
<li>etcdä¿å­˜äº†æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼›</li>
<li>apiserveræä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ï¼›</li>
<li>controller managerè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰ï¼›</li>
<li>schedulerè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šï¼›</li>
<li>kubeletè´Ÿè´£ç»´æŒå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£Volumeï¼ˆCVIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†ï¼›</li>
<li>Container runtimeè´Ÿè´£é•œåƒç®¡ç†ä»¥åŠPodå’Œå®¹å™¨çš„çœŸæ­£è¿è¡Œï¼ˆCRIï¼‰ï¼›</li>
<li>kube-proxyè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼›</li>
</ul>
<h3 id="CAå’Œè¯ä¹¦å‡†å¤‡"><a href="#CAå’Œè¯ä¹¦å‡†å¤‡" class="headerlink" title="CAå’Œè¯ä¹¦å‡†å¤‡"></a>CAå’Œè¯ä¹¦å‡†å¤‡</h3><p>kubernetesæ˜¯ä¸€å¥—åˆ†å¸ƒå¼ç³»ç»Ÿ, ç³»ç»Ÿçš„å„ç»„ä»¶å‡ä½¿ç”¨TLSæ¥è¿›è¡Œèº«ä»½çš„åŒå‘ç¡®è®¤å’Œé€šä¿¡åŠ å¯†, æœ¬æ–‡æ¡£ä½¿ç”¨CloudFlareæä¾›çš„PKIå·¥å…·é›† cfsslæ¥ç”ŸæˆCertificate Authority (CA)å’Œç®¡ç†è¯ä¹¦(opensslå·²å¯ä»¥, ä½†æ˜¯ä½ éœ€è¦ä¸€æ­¥ä¸€æ­¥çš„å¡«å†™).</p>
<p>æˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸€ä¸ªkubernetesçš„ç»„ä»¶ç”Ÿæˆè¯ä¹¦, æ€»ç»“èµ·æ¥å¦‚ä¸‹:</p>
<ul>
<li>kubectl: ç”¨æˆ·çš„CLIå·¥å…·, éœ€è¦ä¸ºç”¨æˆ·ç”Ÿæˆè®¿é—®çš„è¯ä¹¦, è¿™é‡Œéœ€è¦ä¸ºadminç”¨æˆ·é¢å‘1å¼ è¯ä¹¦</li>
<li>master: apiserver, controller manager, scheduler, etcd è¿™4ä¸ªæœåŠ¡éƒ½åœ¨masterèŠ‚ç‚¹ä¸Š, å› æ­¤ä¸ºä»–ä»¬é¢å‘1å¼ è¯ä¹¦</li>
<li>node: kubelet, kube-proxy ç”±äºkubeletçš„è¯ä¹¦æ˜¯åŠ¨æ€é¢å‘çš„(TLS Bootstra), å› æ­¤è¿™é‡Œä»…éœ€è¦ä¸ºkube-proxyé¢å‘1å¼ è¯ä¹¦</li>
</ul>
<h4 id="å®‰è£…cfsslå·¥å…·"><a href="#å®‰è£…cfsslå·¥å…·" class="headerlink" title="å®‰è£…cfsslå·¥å…·"></a>å®‰è£…cfsslå·¥å…·</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</div><div class="line">chmod +x cfssl_linux-amd64</div><div class="line">mv cfssl_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl</div><div class="line"></div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</div><div class="line">chmod +x cfssljson_linux-amd64</div><div class="line">mv cfssljson_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssljson</div><div class="line"></div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</div><div class="line">chmod +x cfssl-certinfo_linux-amd64</div><div class="line">mv cfssl-certinfo_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl-certinfo</div></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºCA"><a href="#åˆ›å»ºCA" class="headerlink" title="åˆ›å»ºCA"></a>åˆ›å»ºCA</h4><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç›®å½•pki, åé¢çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªç›®å½•é‡Œé¢è¿›è¡Œ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir pki &amp;&amp; <span class="built_in">cd</span> pki</div></pre></td></tr></table></figure></p>
<p><strong>é¦–å…ˆåˆ›å»ºCAçš„é…ç½®æ–‡ä»¶: ca-config.json</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># è¿‡æœŸæ—¶é—´è®¾ç½®æˆäº† 87600h</span></div><div class="line">cat &gt; ca-config.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"signing"</span>: &#123;</div><div class="line">    <span class="string">"default"</span>: &#123;</div><div class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"profiles"</span>: &#123;</div><div class="line">      <span class="string">"kubernetes"</span>: &#123;</div><div class="line">        <span class="string">"usages"</span>: [</div><div class="line">            <span class="string">"signing"</span>,</div><div class="line">            <span class="string">"key encipherment"</span>,</div><div class="line">            <span class="string">"server auth"</span>,</div><div class="line">            <span class="string">"client auth"</span></div><div class="line">        ],</div><div class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>å…³äºCAé…ç½®æ–‡ä»¶é‡Œé¢çš„å‚æ•°è¯´æ˜:</p>
<ul>
<li>ca-config.jsonï¼šå¯ä»¥å®šä¹‰å¤šä¸ª profilesï¼Œåˆ†åˆ«æŒ‡å®šä¸åŒçš„è¿‡æœŸæ—¶é—´ã€ä½¿ç”¨åœºæ™¯ç­‰å‚æ•°ï¼›åç»­åœ¨ç­¾åè¯ä¹¦æ—¶ä½¿ç”¨æŸä¸ª profileï¼›</li>
<li>signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼›ç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼›</li>
<li>server authï¼šè¡¨ç¤ºclientå¯ä»¥ç”¨è¯¥ CA å¯¹serveræä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</li>
<li>client authï¼šè¡¨ç¤ºserverå¯ä»¥ç”¨è¯¥CAå¯¹clientæä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</li>
</ul>
<p><strong>åˆ›å»ºCAè¯ä¹¦ç­¾åè¯·æ±‚</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">cat &gt; ca-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>å…³äºè¯ä¹¦ç­¾åè¯·æ±‚çš„å‚æ•°è¯´æ˜:</p>
<ul>
<li>â€œCNâ€ï¼šCommon Nameï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼›æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›</li>
<li>â€œOâ€ï¼šOrganizationï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼›</li>
</ul>
<p><strong>ç”ŸæˆCAè¯ä¹¦å’Œç§é’¥</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca</div><div class="line">$ ls ca*</div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div></pre></td></tr></table></figure></p>
<h4 id="adminç”¨æˆ·è¯ä¹¦"><a href="#adminç”¨æˆ·è¯ä¹¦" class="headerlink" title="adminç”¨æˆ·è¯ä¹¦"></a>adminç”¨æˆ·è¯ä¹¦</h4><p>åç»­kube-apiserverä½¿ç”¨RBACå¯¹å®¢æˆ·ç«¯(å¦‚ kubeletã€kube-proxyã€Pod)è¯·æ±‚è¿›è¡Œæˆæƒï¼›<br>kube-apiserver é¢„å®šä¹‰äº†ä¸€äº›RBACä½¿ç”¨çš„RoleBindings, å¦‚cluster-adminå°†Group system:mastersä¸Role cluster-admin ç»‘å®šï¼Œè¯¥Roleæˆäºˆäº†è°ƒç”¨kube-apiserverçš„æ‰€æœ‰APIçš„æƒé™, æ„æ€æ˜¯å‡¡æ˜¯system:masters Groupçš„useréƒ½æ‹¥æœ‰cluster-adminçš„è§’è‰²ã€‚ å› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨kubectlå‘½ä»¤æ—¶å€™ï¼Œæ‰æ‹¥æœ‰æ•´ä¸ªé›†ç¾¤çš„ç®¡ç†æƒé™(åé¢éƒ¨ç½²äº†å®¢æˆ·ç«¯å·¥å…·æ–¹å¯æŸ¥çœ‹)ï¼›<br>å› æ­¤adminç”¨æˆ·è¯ä¹¦ç”³è¯·çš„æ ¸å¿ƒæ˜¯æŒ‡å®šGroup: Group system:masters, è¿™æ ·è¯¥ç”¨æˆ·å°±æœ‰è®¿é—®APIServerçš„æ‰€æœ‰æƒé™çš„.<br>ç­¾åè¯·æ±‚å‚æ•°å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat &gt; admin-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>ç”Ÿæˆç­¾åè¯ä¹¦:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</div><div class="line">$ ls admin*</div><div class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</div></pre></td></tr></table></figure></p>
<h4 id="masteræœåŠ¡è¯ä¹¦"><a href="#masteræœåŠ¡è¯ä¹¦" class="headerlink" title="masteræœåŠ¡è¯ä¹¦"></a>masteræœåŠ¡è¯ä¹¦</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">cat &gt; kubernetes-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</div><div class="line">    <span class="string">"hosts"</span>: [</div><div class="line">      <span class="string">"127.0.0.1"</span>,</div><div class="line">      <span class="string">"192.168.204.3"</span>,</div><div class="line">      <span class="string">"10.254.0.1"</span>,</div><div class="line">      <span class="string">"kubernetes"</span>,</div><div class="line">      <span class="string">"kubernetes.default"</span>,</div><div class="line">      <span class="string">"kubernetes.default.svc"</span>,</div><div class="line">      <span class="string">"kubernetes.default.svc.cluster"</span>,</div><div class="line">      <span class="string">"kubernetes.default.svc.cluster.local"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"key"</span>: &#123;</div><div class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">        <span class="string">"size"</span>: 2048</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"names"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>å‚æ•°è¯´æ˜:</p>
<ul>
<li>hosts: å¦‚æœhostså­—æ®µä¸ä¸ºç©ºåˆ™éœ€è¦æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„IPæˆ–åŸŸååˆ—è¡¨ï¼Œç”±äºè¯¥è¯ä¹¦åç»­è¢«etcdé›†ç¾¤å’Œkubernetes masteré›†ç¾¤ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸Šé¢åˆ†åˆ«æŒ‡å®šäº†etcdé›†ç¾¤ã€kubernetes masteré›†ç¾¤çš„ä¸»æœºIPå’ŒkubernetesæœåŠ¡çš„æœåŠ¡IP(ä¸€èˆ¬æ˜¯ kube-apiserveræŒ‡å®šçš„ service-cluster-ip-range ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIPï¼Œå¦‚ 10.254.0.1)ã€‚</li>
</ul>
<p>ç”Ÿæˆç­¾åè¯ä¹¦:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</div><div class="line">$ ls kubernetes*</div><div class="line">kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem</div></pre></td></tr></table></figure></p>
<h4 id="nodeæœåŠ¡è¯ä¹¦-ä»…kube-proxy"><a href="#nodeæœåŠ¡è¯ä¹¦-ä»…kube-proxy" class="headerlink" title="nodeæœåŠ¡è¯ä¹¦(ä»…kube-proxy)"></a>nodeæœåŠ¡è¯ä¹¦(ä»…kube-proxy)</h4><p>kube-apiserveré¢„å®šä¹‰çš„RoleBinding system:node-proxier å°†User system:kube-proxyä¸Role system:node-proxierç»‘å®šï¼Œè¯¥Userå…·æœ‰è°ƒç”¨kube-apiserver Proxyç›¸å…³ APIçš„æƒé™(åé¢éƒ¨ç½²äº†å®¢æˆ·ç«¯å·¥å…·åæ–¹å¯æŸ¥çœ‹).<br>å› æ­¤è¯ä¹¦é‡Œé¢é€šè¿‡CNæŒ‡å®šuserä¸º: system:kube-proxy, è¿™è¯¥è¯ä¹¦å°±æ˜¯å…·æœ‰äº†proxyç›¸åº”çš„æƒé™.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>ç”Ÿæˆè¯ä¹¦:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</div><div class="line">$ ls kube-proxy*</div><div class="line">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</div></pre></td></tr></table></figure></p>
<h4 id="åˆ†å‘è¯ä¹¦"><a href="#åˆ†å‘è¯ä¹¦" class="headerlink" title="åˆ†å‘è¯ä¹¦"></a>åˆ†å‘è¯ä¹¦</h4><p>å°†ä¸Šé¢ç”Ÿæˆå¥½çš„è¯ä¹¦åˆ†å‘åˆ°masterå’ŒnodeèŠ‚ç‚¹, ä½œä¸ºkubernetesçš„é…ç½®æ–‡ä»¶:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å› ä¸ºæˆ‘æ˜¯åœ¨masterä¸Šç”Ÿæˆçš„è¯ä¹¦, ä»…éœ€cpåˆ°masterå¯¹äºç›®å½•å³å¯</span></div><div class="line">$ mkdir -pv /etc/kubernetes/pki</div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"/etc/kubernetes"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"/etc/kubernetes/pki"</span></div><div class="line">$ cp ~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125; /etc/kubernetes/pki/</div><div class="line">$ ls /etc/kubernetes/pki/</div><div class="line">admin-key.pem  ca-key.pem  kube-proxy-key.pem  kubernetes-key.pem</div><div class="line">admin.pem      ca.pem      kube-proxy.pem      kubernetes.pem</div><div class="line"><span class="comment"># åœ¨nodeèŠ‚ç‚¹ä¸Šåˆ›å»ºç›®å½•, å¹¶ä¸”copyè¿‡å»</span></div><div class="line">$ ssh  root@192.168.204.6 <span class="string">'mkdir -pv /etc/kubernetes/pki'</span></div><div class="line">$ scp  ~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125;  root@192.168.204.6:/etc/kubernetes/pki/</div></pre></td></tr></table></figure></p>
<h3 id="éƒ¨ç½²kuberneteså®¢æˆ·ç«¯å·¥å…·kubectl"><a href="#éƒ¨ç½²kuberneteså®¢æˆ·ç«¯å·¥å…·kubectl" class="headerlink" title="éƒ¨ç½²kuberneteså®¢æˆ·ç«¯å·¥å…·kubectl"></a>éƒ¨ç½²kuberneteså®¢æˆ·ç«¯å·¥å…·kubectl</h3><p>å®¢æˆ·ç«¯å·¥å…·éœ€è¦ä¸‹è½½: kubernetes-client-linux-amd64.tar.gz(1.8.7), ä½†æ˜¯ç”±äºå¢™çš„å­˜åœ¨, æœ‰äº›æ— æ³•ç¿»å¢™çš„æœ‹å‹è¯·è®¿é—®æˆ‘å·²ç»ä¸‹è½½å¥½çš„åœ°å€<a href="https://pan.baidu.com/s/1eTgeS5G" target="_blank" rel="external">å›½å†…ä¸‹è½½</a><br>è·å–åŒ…åè¿›è¡Œå®¢æˆ·ç«¯çš„å®‰è£…:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tar -xzvf kubernetes-client-linux-amd64.tar.gz</div><div class="line">cp kubernetes/client/bin/kube* /usr/bin/</div></pre></td></tr></table></figure></p>
<p>å®¢æˆ·ç«¯å®‰è£…å®Œæˆå, éœ€è¦é…ç½®è®¿é—®å‡­è¯, è¿™é‡Œé…ç½®è¯ä¹¦è®¿é—®, è¯ä¹¦å°±æ˜¯ä¸Šé¢ç”Ÿæˆå¥½çš„adminçš„è¯ä¹¦<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://192.168.204.3:6443"</span></div><div class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span></div><div class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-credentials admin \</div><div class="line">  --client-certificate=/etc/kubernetes/pki/admin.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --client-key=/etc/kubernetes/pki/admin-key.pem</div><div class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-context kubernetes \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=admin</div><div class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></div><div class="line">kubectl config use-context kubernetes</div></pre></td></tr></table></figure></p>
<p>ç”Ÿæˆçš„kubeconfigè¢«ä¿å­˜åˆ°~/.kube/configæ–‡ä»¶, è¯¥æ–‡ä»¶æ‹¥æœ‰å¯¹è¯¥é›†ç¾¤çš„æœ€é«˜æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚</p>
<h3 id="nodeèŠ‚ç‚¹çš„TLSè¯ä¹¦å¼•å¯¼-TLS-Bootstrap-é…ç½®å‡†å¤‡"><a href="#nodeèŠ‚ç‚¹çš„TLSè¯ä¹¦å¼•å¯¼-TLS-Bootstrap-é…ç½®å‡†å¤‡" class="headerlink" title="nodeèŠ‚ç‚¹çš„TLSè¯ä¹¦å¼•å¯¼(TLS Bootstrap)é…ç½®å‡†å¤‡"></a>nodeèŠ‚ç‚¹çš„TLSè¯ä¹¦å¼•å¯¼(TLS Bootstrap)é…ç½®å‡†å¤‡</h3><p>kubeletã€kube-proxy ç­‰ Node æœºå™¨ä¸Šçš„è¿›ç¨‹ä¸ Master æœºå™¨çš„ kube-apiserver è¿›ç¨‹é€šä¿¡æ—¶éœ€è¦è®¤è¯å’Œæˆæƒ;<br>kubernetes 1.4å¼€å§‹æ”¯æŒç”±kube-apiserverä¸ºå®¢æˆ·ç«¯ç”ŸæˆTLSè¯ä¹¦çš„<a href="https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/" target="_blank" rel="external">TLS Bootstrapping</a>åŠŸèƒ½ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦äº†ï¼›è¯¥åŠŸèƒ½å½“å‰ä»…æ”¯æŒä¸º kubelet ç”Ÿæˆè¯ä¹¦;</p>
<h4 id="åˆ›å»ºTLS-Bootstrapping-Token"><a href="#åˆ›å»ºTLS-Bootstrapping-Token" class="headerlink" title="åˆ›å»ºTLS Bootstrapping Token"></a>åˆ›å»ºTLS Bootstrapping Token</h4><p>BOOTSTRAP_TOKEN å°†è¢«å†™å…¥åˆ°kube-apiserverä½¿ç”¨çš„token.csvæ–‡ä»¶å’Œkubeletä½¿ç”¨çš„bootstrap.kubeconfigæ–‡ä»¶.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr <span class="_">-d</span> <span class="string">' '</span>)</div><div class="line">cat &gt; token.csv &lt;&lt;EOF</div><div class="line"><span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span>,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></div><div class="line">EOF</div><div class="line">$ cat token.csv</div><div class="line"><span class="built_in">fc</span>9702212376b0c73ffc3db3d425227c,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></div></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶"><a href="#åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶" class="headerlink" title="åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶"></a>åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># é¦–å…ˆç¡®è®¤tokenç¯å¢ƒå˜é‡çš„å€¼</span></div><div class="line"><span class="built_in">echo</span> <span class="variable">$BOOTSTRAP_TOKEN</span></div><div class="line"></div><div class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://192.168.204.3:6443"</span></div><div class="line"></div><div class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</div><div class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-context default \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kubelet-bootstrap \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></div><div class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</div></pre></td></tr></table></figure>
<ul>
<li>â€“embed-certs ä¸º true æ—¶è¡¨ç¤ºå°† certificate-authority è¯ä¹¦å†™å…¥åˆ°ç”Ÿæˆçš„ bootstrap.kubeconfig æ–‡ä»¶ä¸­ï¼›</li>
<li>è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°æ—¶æ²¡æœ‰æŒ‡å®šç§˜é’¥å’Œè¯ä¹¦ï¼Œåç»­ç”± kube-apiserver è‡ªåŠ¨ç”Ÿæˆï¼›</li>
</ul>
<h4 id="åˆ›å»ºkube-proxy-kubeconfigæ–‡ä»¶"><a href="#åˆ›å»ºkube-proxy-kubeconfigæ–‡ä»¶" class="headerlink" title="åˆ›å»ºkube-proxy kubeconfigæ–‡ä»¶"></a>åˆ›å»ºkube-proxy kubeconfigæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://192.168.204.3:6443"</span></div><div class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy \</div><div class="line">  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem \</div><div class="line">  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem \</div><div class="line">  --embed-certs=<span class="literal">true</span> \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></div><div class="line">kubectl config <span class="built_in">set</span>-context default \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kube-proxy \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></div><div class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</div></pre></td></tr></table></figure>
<ul>
<li>è®¾ç½®é›†ç¾¤å‚æ•°å’Œå®¢æˆ·ç«¯è®¤è¯å‚æ•°æ—¶ â€“embed-certs éƒ½ä¸º trueï¼Œè¿™ä¼šå°† certificate-authorityã€client-certificate å’Œ client-key æŒ‡å‘çš„è¯ä¹¦æ–‡ä»¶å†…å®¹å†™å…¥åˆ°ç”Ÿæˆçš„ kube-proxy.kubeconfig æ–‡ä»¶ä¸­ï¼›</li>
<li>kube-proxy.pem è¯ä¹¦ä¸­ CN ä¸º system:kube-proxyï¼Œkube-apiserver é¢„å®šä¹‰çš„ RoleBinding cluster-admin å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</li>
</ul>
<h4 id="åˆ†å‘kubeconfigæ–‡ä»¶"><a href="#åˆ†å‘kubeconfigæ–‡ä»¶" class="headerlink" title="åˆ†å‘kubeconfigæ–‡ä»¶"></a>åˆ†å‘kubeconfigæ–‡ä»¶</h4><p>å…ˆç¡®è®¤æˆ‘ä»¬åˆšæ‰ç”Ÿæˆçš„æ–‡ä»¶, ç„¶åå°†token.csvå¤åˆ¶ç»™masterèŠ‚ç‚¹, bootstrap.kubeconfigå’Œkube-proxy.kubeconfigè´Ÿè´£ç»™nodeèŠ‚ç‚¹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 TLS_Bootstrapping]<span class="comment"># ls</span></div><div class="line">bootstrap.kubeconfig  kube-proxy.kubeconfig  token.csv</div><div class="line"><span class="comment"># å› ä¸ºæˆ‘åœ¨masterèŠ‚ç‚¹ä¸Š, æ‰€ä»¥</span></div><div class="line">$ cp  token.csv /etc/kubernetes/</div><div class="line">$ scp ~/TLS_Bootstrapping/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; root@192.168.204.6:/etc/kubernetes/</div></pre></td></tr></table></figure></p>
<h3 id="éƒ¨ç½²ETCD"><a href="#éƒ¨ç½²ETCD" class="headerlink" title="éƒ¨ç½²ETCD"></a>éƒ¨ç½²ETCD</h3><p>etcdä½œä¸ºkubernetesé›†ç¾¤çš„ä¸»æ•°æ®åº“, åœ¨å®‰è£…kubernetesé›†ç¾¤ä¹‹å‰å¿…é¡»å…ˆå®‰è£…å’Œå¯åŠ¨ã€‚<br>ä»etcdå®˜ç½‘<a href="https://github.com/coreos/etcd/releases" target="_blank" rel="external">ä¸‹è½½etcdçš„äºŒè¿›åˆ¶æ–‡ä»¶å‹ç¼©åŒ…</a>, ç”±äºä¸ç¿»å¢™ä¸‹è½½é€Ÿåº¦ä¼šéå¸¸æ…¢, å› æ­¤æˆ‘å·²æå‰ä¸‹è½½åˆ°<a href="https://pan.baidu.com/s/1eUeto22" target="_blank" rel="external">ç™¾åº¦ç½‘ç›˜</a></p>
<h4 id="TLSè¯ä¹¦ç¡®è®¤"><a href="#TLSè¯ä¹¦ç¡®è®¤" class="headerlink" title="TLSè¯ä¹¦ç¡®è®¤"></a>TLSè¯ä¹¦ç¡®è®¤</h4><p>éœ€è¦ä¸ºetcdé›†ç¾¤åˆ›å»ºåŠ å¯†é€šä¿¡çš„TLSè¯ä¹¦, ä¹‹å‰åˆ›å»ºçš„kubernetesè¯ä¹¦çš„hostså­—æ®µåˆ—è¡¨ä¸­åŒ…å«etcdéƒ¨ç½²åœ°å€çš„IP, å¦åˆ™åç»­è¯ä¹¦æ ¡éªŒä¼šå¤±è´¥;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 pki]<span class="comment"># ls /etc/kubernetes/pki/</span></div><div class="line">admin-key.pem  ca-key.pem  kube-proxy-key.pem  kubernetes-key.pem</div><div class="line">admin.pem      ca.pem      kube-proxy.pem      kubernetes.pem</div></pre></td></tr></table></figure></p>
<p>åœ¨éƒ¨ç½²TLS Etcdæ—¶æˆ‘ä»¬å°†è¦ä½¿ç”¨: ca.pem, kubernetes-key.pem, kubernetes.pem</p>
<h4 id="éƒ¨ç½²ä¸é…ç½®ETCD"><a href="#éƒ¨ç½²ä¸é…ç½®ETCD" class="headerlink" title="éƒ¨ç½²ä¸é…ç½®ETCD"></a>éƒ¨ç½²ä¸é…ç½®ETCD</h4><p>ä»ä¸Šé¢çš„ç™¾åº¦ç½‘ç›˜ä¸‹è½½ä¸‹etcdçš„äºŒè¿›åˆ¶åŒ…, ç„¶åå¼€å§‹å®‰è£…:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ tar vxf etcd-v3.2.7-linux-amd64.tar.gz</div><div class="line">$ cp etcd-v3.2.7-linux-amd64/etcd* /usr/<span class="built_in">local</span>/bin/</div></pre></td></tr></table></figure></p>
<p>å®‰è£…å®Œæˆåé…ç½®æˆsystemdçš„ç³»ç»ŸæœåŠ¡, ç”Ÿæˆ/usr/lib/systemd/system/etcd.serviceæ–‡ä»¶, æ–‡ä»¶å†…å®¹å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Etcd Server</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">Documentation=https://github.com/coreos</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">WorkingDirectory=/var/lib/etcd/</div><div class="line">EnvironmentFile=-/etc/etcd/etcd.conf</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/etcd \</div><div class="line">  --name <span class="variable">$&#123;ETCD_NAME&#125;</span> \</div><div class="line">  --cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  --peer-cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --peer-key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  --trusted-ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --peer-trusted-ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --initial-advertise-peer-urls <span class="variable">$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125;</span> \</div><div class="line">  --listen-peer-urls <span class="variable">$&#123;ETCD_LISTEN_PEER_URLS&#125;</span> \</div><div class="line">  --listen-client-urls <span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>,http://127.0.0.1:2379 \</div><div class="line">  --advertise-client-urls <span class="variable">$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125;</span> \</div><div class="line">  --initial-cluster-token <span class="variable">$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;</span> \</div><div class="line">  --initial-cluster infra1=https://192.168.204.3:2380 \</div><div class="line">  --initial-cluster-state new \</div><div class="line">  --data-dir=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span></div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>ç¼–å†™etcdæœåŠ¡çš„é…ç½®æ–‡ä»¶/etc/etcd/etcd.conf, æ–‡ä»¶å†…å®¹å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># [member]</span></div><div class="line">ETCD_NAME=infra1</div><div class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></div><div class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.204.3:2380"</span></div><div class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.204.3:2379"</span></div><div class="line"></div><div class="line"><span class="comment">#[cluster]</span></div><div class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.204.3:2380"</span></div><div class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></div><div class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.204.3:2379"</span></div></pre></td></tr></table></figure></p>
<h4 id="å¯åŠ¨ETCD"><a href="#å¯åŠ¨ETCD" class="headerlink" title="å¯åŠ¨ETCD"></a>å¯åŠ¨ETCD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å› ä¸ºåœ¨etcdçš„é…ç½®æ–‡ä»¶é‡Œé¢æˆ‘ä»¬æŒ‡å®šäº†etcdæ•°æ®ç›®å½•ä¸º: /var/lib/etcd, å› æ­¤æˆ‘ä»¬éœ€è¦æå‰å»ºå¥½</span></div><div class="line">$ mkdir /var/lib/etcd</div><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> etcd</div><div class="line">systemctl start etcd</div><div class="line">systemctl status etcd</div></pre></td></tr></table></figure>
<h4 id="éªŒè¯ETCD"><a href="#éªŒè¯ETCD" class="headerlink" title="éªŒè¯ETCD"></a>éªŒè¯ETCD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">etcdctl \</div><div class="line">  --ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  cluster-health</div><div class="line">member 74c10a33d24ef135 is healthy: got healthy result from https://192.168.204.3:2379</div><div class="line">cluster is health</div></pre></td></tr></table></figure>
<h3 id="éƒ¨ç½²masterèŠ‚ç‚¹"><a href="#éƒ¨ç½²masterèŠ‚ç‚¹" class="headerlink" title="éƒ¨ç½²masterèŠ‚ç‚¹"></a>éƒ¨ç½²masterèŠ‚ç‚¹</h3><p>Masteræ˜¯Kubernetesçš„å¤§æ€»ç®¡ï¼Œä¸»è¦ç”±apiserverã€controller managerä¸schedulerç»„æˆ, ç”¨äºç®¡ç†æ‰€æœ‰node.<br>ç›®å‰è¿™ä¸‰ä¸ªç»„ä»¶éœ€è¦éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Š, æ³¨æ„åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªkube-schedulerã€kube-controller-managerè¿›ç¨‹å¤„äºå·¥ä½œçŠ¶æ€ï¼Œå¦‚æœè¿è¡Œå¤šä¸ªï¼Œåˆ™éœ€è¦é€šè¿‡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªleader</p>
<h4 id="ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶"></a>ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶</h4><p>masterçš„æœåŠ¡éœ€è¦ä¸‹è½½: kubernetes-server-linux-amd64.tar.gz(1.8.7), ä½†æ˜¯ç”±äºå¢™çš„å­˜åœ¨, æœ‰äº›æ— æ³•ç¿»å¢™çš„æœ‹å‹è¯·è®¿é—®æˆ‘å·²ç»ä¸‹è½½å¥½çš„æ–‡ä»¶:<a href="https://pan.baidu.com/s/1eTgeS5G#list/path=%2F" target="_blank" rel="external">å›½å†…ä¸‹è½½</a></p>
<p>ä¸‹è½½å®Œæˆå, å®‰è£…masteræœåŠ¡:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ tar vxf kubernetes-server-linux-amd64.tar.gz</div><div class="line">$ cd kubernetes</div><div class="line">$ cp -r server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/local/bin/</div></pre></td></tr></table></figure></p>
<h4 id="é…ç½®å’Œå¯åŠ¨kube-apiserver"><a href="#é…ç½®å’Œå¯åŠ¨kube-apiserver" class="headerlink" title="é…ç½®å’Œå¯åŠ¨kube-apiserver"></a>é…ç½®å’Œå¯åŠ¨kube-apiserver</h4><p>serviceé…ç½®æ–‡ä»¶/usr/lib/systemd/system/kube-apiserver.serviceå†…å®¹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes API Service</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line">After=etcd.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/apiserver</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-apiserver \</div><div class="line">        <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">        <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">        <span class="variable">$KUBE_ETCD_SERVERS</span> \</div><div class="line">        <span class="variable">$KUBE_API_ADDRESS</span> \</div><div class="line">        <span class="variable">$KUBE_API_PORT</span> \</div><div class="line">        <span class="variable">$KUBELET_PORT</span> \</div><div class="line">        <span class="variable">$KUBE_ALLOW_PRIV</span> \</div><div class="line">        <span class="variable">$KUBE_SERVICE_ADDRESSES</span> \</div><div class="line">        <span class="variable">$KUBE_ADMISSION_CONTROL</span> \</div><div class="line">        <span class="variable">$KUBE_API_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line">Type=notify</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>ç”±äºmasteræœåŠ¡: kube-apiserverã€kube-controller-managerã€kube-schedulerã€kubeletã€kube-proxyæœ‰ä¸€éƒ¨åˆ†ç›¸åŒçš„é…ç½®, å› æ­¤æŠ½ç¦»äº†1ä¸ªconfigæ¥å…¬ç”¨è¿™äº›é…ç½®: /etc/kubernetes/configæ–‡ä»¶çš„å†…å®¹ä¸º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># kubernetes system config</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># The following values are used to configure various aspects of all</span></div><div class="line"><span class="comment"># kubernetes services, including</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#   kube-apiserver.service</span></div><div class="line"><span class="comment">#   kube-controller-manager.service</span></div><div class="line"><span class="comment">#   kube-scheduler.service</span></div><div class="line"><span class="comment">#   kubelet.service</span></div><div class="line"><span class="comment">#   kube-proxy.service</span></div><div class="line"><span class="comment"># logging to stderr means we get it in the systemd journal</span></div><div class="line">KUBE_LOGTOSTDERR=<span class="string">"--logtostderr=true"</span></div><div class="line"></div><div class="line"><span class="comment"># journal message level, 0 is debug</span></div><div class="line">KUBE_LOG_LEVEL=<span class="string">"--v=0"</span></div><div class="line"></div><div class="line"><span class="comment"># Should this cluster be allowed to run privileged docker containers</span></div><div class="line">KUBE_ALLOW_PRIV=<span class="string">"--allow-privileged=true"</span></div><div class="line"></div><div class="line"><span class="comment"># How the controller-manager, scheduler, and proxy find the apiserver</span></div><div class="line">KUBE_MASTER=<span class="string">"--master=http://192.168.204.3:8080"</span></div></pre></td></tr></table></figure></p>
<p>apiserveré…ç½®æ–‡ä»¶/etc/kubernetes/apiserverå†…å®¹ä¸º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment">## kubernetes system config</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## The following values are used to configure the kube-apiserver</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## The address on the local server to listen to.</span></div><div class="line"><span class="comment">#KUBE_API_ADDRESS="--insecure-bind-address=sz-pg-oam-docker-test-001.tendcloud.com"</span></div><div class="line">KUBE_API_ADDRESS=<span class="string">"--advertise-address=192.168.204.3 --bind-address=192.168.204.3 --insecure-bind-address=192.168.204.3"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## The port on the local server to listen on.</span></div><div class="line"><span class="comment">#KUBE_API_PORT="--port=8080"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Port minions listen on</span></div><div class="line"><span class="comment">#KUBELET_PORT="--kubelet-port=10250"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Comma separated list of nodes in the etcd cluster</span></div><div class="line">KUBE_ETCD_SERVERS=<span class="string">"--etcd-servers=https://192.168.204.3:2379"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Address range to use for services</span></div><div class="line">KUBE_SERVICE_ADDRESSES=<span class="string">"--service-cluster-ip-range=10.254.0.0/16"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## default admission control policies</span></div><div class="line">KUBE_ADMISSION_CONTROL=<span class="string">"--admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Add your own!</span></div><div class="line">KUBE_API_ARGS=<span class="string">"--authorization-mode=Node,RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --experimental-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/pki/kubernetes.pem --tls-private-key-file=/etc/kubernetes/pki/kubernetes-key.pem --client-ca-file=/etc/kubernetes/pki/ca.pem --service-account-key-file=/etc/kubernetes/pki/ca-key.pem --etcd-cafile=/etc/kubernetes/pki/ca.pem --etcd-certfile=/etc/kubernetes/pki/kubernetes.pem --etcd-keyfile=/etc/kubernetes/pki/kubernetes-key.pem --enable-swagger-ui=true --apiserver-count=3 --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-path=/var/lib/audit.log --event-ttl=1h"</span></div></pre></td></tr></table></figure></p>
<p>å¯åŠ¨kube-apiserver<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div><div class="line">$ systemctl <span class="built_in">enable</span> kube-apiserver</div><div class="line">$ systemctl start kube-apiserver</div><div class="line">$ systemctl status kube-apiserver</div><div class="line">$ netstat -tlnup  | grep kube</div><div class="line">tcp        0      0 192.168.204.3:6443      0.0.0.0:*               LISTEN      10625/kube-apiserve</div><div class="line">tcp        0      0 192.168.204.3:8080      0.0.0.0:*               LISTEN      10625/kube-apiserve</div></pre></td></tr></table></figure></p>
<h4 id="é…ç½®å’Œå¯åŠ¨kube-controller-manager"><a href="#é…ç½®å’Œå¯åŠ¨kube-controller-manager" class="headerlink" title="é…ç½®å’Œå¯åŠ¨kube-controller-manager"></a>é…ç½®å’Œå¯åŠ¨kube-controller-manager</h4><p>åˆ›å»ºkube-controller-managerçš„serivceé…ç½®æ–‡ä»¶: /usr/lib/systemd/system/kube-controller-manager.service, å†…å®¹å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Controller Manager</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/controller-manager</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-controller-manager \</div><div class="line">        <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">        <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">        <span class="variable">$KUBE_MASTER</span> \</div><div class="line">        <span class="variable">$KUBE_CONTROLLER_MANAGER_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>é…ç½®æ–‡ä»¶/etc/kubernetes/controller-managerå†…å®¹å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># The following values are used to configure the kubernetes controller-manager</span></div><div class="line"></div><div class="line"><span class="comment"># defaults from config and apiserver should be adequate</span></div><div class="line"></div><div class="line"><span class="comment"># Add your own!</span></div><div class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"--address=127.0.0.1 --service-cluster-ip-range=10.254.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem  --service-account-private-key-file=/etc/kubernetes/pki/ca-key.pem --root-ca-file=/etc/kubernetes/pki/ca.pem --leader-elect=true"</span></div></pre></td></tr></table></figure></p>
<p>å¯åŠ¨æœåŠ¡:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div><div class="line">$ systemctl <span class="built_in">enable</span> kube-controller-manager</div><div class="line">$ systemctl start kube-controller-manager</div><div class="line">$ netstat -tlnup | grep controll</div><div class="line">tcp        0      0 127.0.0.1:10252         0.0.0.0:*               LISTEN      10692/kube-controll</div></pre></td></tr></table></figure></p>
<h4 id="é…ç½®å’Œå¯åŠ¨kube-scheduler"><a href="#é…ç½®å’Œå¯åŠ¨kube-scheduler" class="headerlink" title="é…ç½®å’Œå¯åŠ¨kube-scheduler"></a>é…ç½®å’Œå¯åŠ¨kube-scheduler</h4><p>åˆ›å»ºkube-schedulerçš„serivceé…ç½®æ–‡ä»¶/usr/lib/systemd/system/kube-scheduler.service:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Scheduler Plugin</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/scheduler</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-scheduler \</div><div class="line">            <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">            <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">            <span class="variable">$KUBE_MASTER</span> \</div><div class="line">            <span class="variable">$KUBE_SCHEDULER_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>é…ç½®æ–‡ä»¶/etc/kubernetes/scheduler:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># kubernetes scheduler config</span></div><div class="line"></div><div class="line"><span class="comment"># default config should be adequate</span></div><div class="line"></div><div class="line"><span class="comment"># Add your own!</span></div><div class="line">KUBE_SCHEDULER_ARGS=<span class="string">"--leader-elect=true --address=127.0.0.1"</span></div></pre></td></tr></table></figure></p>
<p>å¯åŠ¨æœåŠ¡:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div><div class="line">$ systemctl <span class="built_in">enable</span> kube-scheduler</div><div class="line">$ systemctl start kube-scheduler</div><div class="line">$ netstat -tlnup | grep schedule</div><div class="line">tcp        0      0 127.0.0.1:10251         0.0.0.0:*               LISTEN      10745/kube-schedule</div></pre></td></tr></table></figure></p>
<h4 id="éªŒè¯masterèŠ‚ç‚¹åŠŸèƒ½"><a href="#éªŒè¯masterèŠ‚ç‚¹åŠŸèƒ½" class="headerlink" title="éªŒè¯masterèŠ‚ç‚¹åŠŸèƒ½"></a>éªŒè¯masterèŠ‚ç‚¹åŠŸèƒ½</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ netstat -tlnup | grep kube</div><div class="line">tcp        0      0 127.0.0.1:10251         0.0.0.0:*               LISTEN      10745/kube-schedule</div><div class="line">tcp        0      0 192.168.204.3:6443      0.0.0.0:*               LISTEN      10625/kube-apiserve</div><div class="line">tcp        0      0 127.0.0.1:10252         0.0.0.0:*               LISTEN      10692/kube-controll</div><div class="line">tcp        0      0 192.168.204.3:8080      0.0.0.0:*               LISTEN      10625/kube-apiserve</div><div class="line">$ kubectl get componentstatuses</div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">scheduler            Healthy   ok</div><div class="line">controller-manager   Healthy   ok</div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</div></pre></td></tr></table></figure>
<p>masterå®‰è£…å®Œæˆå, å¯ä»¥æŸ¥çœ‹ä¸‹ä¸Šé¢æåˆ°çš„clusterrolebindingçš„ç›¸å…³æƒé™:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">$ kubectl get clusterrolebinding system:node-proxier -o yaml</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">  creationTimestamp: 2018-01-19T01:23:53Z</div><div class="line">  labels:</div><div class="line">    kubernetes.io/bootstrapping: rbac-defaults</div><div class="line">  name: system:node-proxier</div><div class="line">  resourceVersion: <span class="string">"75"</span></div><div class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Anode-proxier</div><div class="line">  uid: 6916e382-fcb7-11e7-ad2d-fa163e1ab5c5</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: system:node-proxier</div><div class="line">subjects:</div><div class="line">- apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: User</div><div class="line">  name: system:kube-proxy</div><div class="line">$ kubectl get clusterrolebinding cluster-admin -o yaml</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">  creationTimestamp: 2018-01-19T01:23:52Z</div><div class="line">  labels:</div><div class="line">    kubernetes.io/bootstrapping: rbac-defaults</div><div class="line">  name: cluster-admin</div><div class="line">  resourceVersion: <span class="string">"72"</span></div><div class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin</div><div class="line">  uid: 69072637-fcb7-11e7-ad2d-fa163e1ab5c5</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: cluster-admin</div><div class="line">subjects:</div><div class="line">- apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: Group</div><div class="line">  name: system:masters</div></pre></td></tr></table></figure></p>
<h3 id="éƒ¨ç½²nodeèŠ‚ç‚¹"><a href="#éƒ¨ç½²nodeèŠ‚ç‚¹" class="headerlink" title="éƒ¨ç½²nodeèŠ‚ç‚¹"></a>éƒ¨ç½²nodeèŠ‚ç‚¹</h3><p>Nodeæ˜¯ä¸»è¦æ‰§è¡Œå®¹å™¨å®ä¾‹çš„èŠ‚ç‚¹ï¼Œå¯è§†ä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚<br>Kubernetes nodeèŠ‚ç‚¹åŒ…å«å¦‚ä¸‹ç»„ä»¶ï¼š</p>
<ul>
<li>Flanneld: flannelæ˜¯å®¹å™¨çš„ç½‘ç»œæ’ä»¶, è´Ÿè´£è·¨å®¿ä¸»æœºçš„å®¹å™¨çš„ç½‘ç»œé€šä¿¡ã€‚</li>
<li>Docker1.12.6: criçš„å®ç°, dockerçš„å®‰è£…å¾ˆç®€å•, ä½†æ˜¯éœ€è¦æ³¨æ„dockerçš„é…ç½®ã€‚</li>
<li>kubelet: è´Ÿè´£ç»´æŒå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£Volumeï¼ˆCVIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†, é€šè¿‡äºŒè¿›åˆ¶å®‰è£…</li>
<li>kube-proxy: è´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡, é€šè¿‡äºŒè¿›åˆ¶å®‰è£…</li>
</ul>
<h4 id="è¯ä¹¦ä¸Bootstrap-TLSé…ç½®æ–‡ä»¶ç¡®è®¤"><a href="#è¯ä¹¦ä¸Bootstrap-TLSé…ç½®æ–‡ä»¶ç¡®è®¤" class="headerlink" title="è¯ä¹¦ä¸Bootstrap TLSé…ç½®æ–‡ä»¶ç¡®è®¤"></a>è¯ä¹¦ä¸Bootstrap TLSé…ç½®æ–‡ä»¶ç¡®è®¤</h4><p>å¦‚æœè¯¥nodeèŠ‚ç‚¹å·²ç»åˆ†å‘äº†è¯ä¹¦, å¯ä»¥çœ‹åˆ°å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@k8s-node01 kubernetes]<span class="comment"># ls /etc/kubernetes/pki</span></div><div class="line">admin-key.pem  ca-key.pem  kubelet-client.crt  kubelet.crt  kube-proxy-key.pem  kubernetes-key.pem</div><div class="line">admin.pem      ca.pem      kubelet-client.key  kubelet.key  kube-proxy.pem      kubernetes.pem</div></pre></td></tr></table></figure></p>
<p>å¦‚æœæ²¡åˆ†å‘è¯ä¹¦, åˆ°masterèŠ‚ç‚¹å°†ç›¸åº”çš„è¯ä¹¦copyè¿‡å»<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ mkdir /etc/kubernetes</div><div class="line">$ scp  root@192.168.204.3:~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125;  /etc/kubernetes/pki/</div><div class="line">$ scp  root@192.168.204.3:~/TLS_Bootstrapping/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; /etc/kubernetes/</div></pre></td></tr></table></figure></p>
<h4 id="éƒ¨ç½²dockerå’Œflanneld"><a href="#éƒ¨ç½²dockerå’Œflanneld" class="headerlink" title="éƒ¨ç½²dockerå’Œflanneld"></a>éƒ¨ç½²dockerå’Œflanneld</h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£…dockerå’Œflannel<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install -y docker</div><div class="line">yum install -y flannel</div></pre></td></tr></table></figure></p>
<p>serviceé…ç½®æ–‡ä»¶/usr/lib/systemd/system/flanneld.serviceçš„ä¿®æ”¹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Flanneld overlay address etcd agent</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">After=etcd.service</div><div class="line">Before=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">EnvironmentFile=/etc/sysconfig/flanneld</div><div class="line">EnvironmentFile=-/etc/sysconfig/docker-network</div><div class="line">ExecStart=/usr/bin/flanneld-start \</div><div class="line">  -etcd-endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</div><div class="line">  -etcd-prefix=<span class="variable">$&#123;ETCD_PREFIX&#125;</span> \</div><div class="line">  <span class="variable">$FLANNEL_OPTIONS</span></div><div class="line">ExecStartPost=/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS <span class="_">-d</span> /run/flannel/docker</div><div class="line">Restart=on-failure</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">RequiredBy=docker.service</div></pre></td></tr></table></figure></p>
<p>/etc/sysconfig/flanneldé…ç½®æ–‡ä»¶:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Flanneld configuration options  </span></div><div class="line"></div><div class="line"><span class="comment"># etcd url location.  Point this to the server where etcd runs</span></div><div class="line">ETCD_ENDPOINTS=<span class="string">"https://192.168.204.3:2379"</span></div><div class="line"></div><div class="line"><span class="comment"># etcd config key.  This is the configuration key that flannel queries</span></div><div class="line"><span class="comment"># For address range assignment</span></div><div class="line">ETCD_PREFIX=<span class="string">"/kube-centos/network"</span></div><div class="line"></div><div class="line"><span class="comment"># Any additional options that you want to pass</span></div><div class="line">FLANNEL_OPTIONS=<span class="string">"-etcd-cafile=/etc/kubernetes/pki/ca.pem -etcd-certfile=/etc/kubernetes/pki/kubernetes.pem -etcd-keyfile=/etc/kubernetes/pki/kubernetes-key.pem"</span></div></pre></td></tr></table></figure></p>
<p>åœ¨etcdä¸­åˆ›å»ºç½‘ç»œé…ç½®(å› ä¸ºnodeèŠ‚ç‚¹ä¸Šæ²¡å®‰è£…etcdå®¢æˆ·ç«¯, å› æ­¤ä¸‹é¢çš„æ“ä½œåœ¨masterèŠ‚ç‚¹ä¸Šè¿›è¡Œ):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">etcdctl --endpoints=https://192.168.204.3:2379 \</div><div class="line">  --ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  mkdir /kube-centos/network</div><div class="line">etcdctl --endpoints=https://192.168.204.3:2379 \</div><div class="line">  --ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  mk /kube-centos/network/config <span class="string">'&#123;"Network":"172.30.0.0/16","SubnetLen":24,"Backend":&#123;"Type":"vxlan"&#125;&#125;'</span></div></pre></td></tr></table></figure></p>
<p>å¯åŠ¨flannel:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> flanneld</div><div class="line">systemctl start flanneld</div><div class="line">systemctl status flanneld</div></pre></td></tr></table></figure></p>
<p>éªŒè¯flannelæ­£å¸¸å·¥ä½œ(æŸ¥çœ‹etcdæ˜¯å¦æœ‰ç½‘ç»œé…ç½®ç”Ÿæˆ,åœ¨masterèŠ‚ç‚¹ä¸Šæ“ä½œ):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ etcdctl --endpoints=https://192.168.204.3:2379 \</div><div class="line">  --ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  ls /kube-centos/network/subnets</div><div class="line">/kube-centos/network/subnets/172.30.52.0-24</div><div class="line">$ etcdctl --endpoints=https://192.168.204.3:2379 \</div><div class="line">  --ca-file=/etc/kubernetes/pki/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/pki/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/pki/kubernetes-key.pem \</div><div class="line">  get /kube-centos/network/config</div><div class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>,<span class="string">"SubnetLen"</span>:24,<span class="string">"Backend"</span>:&#123;<span class="string">"Type"</span>:<span class="string">"host-gw"</span>&#125;&#125;</div><div class="line">$ etcdctl --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</div><div class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  get /kube-centos/network/subnets/172.30.52.0-24</div><div class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"192.168.204.6"</span>,<span class="string">"BackendType"</span>:<span class="string">"host-gw"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>é…ç½®dockerä½¿ç”¨flannelç½‘ç»œæ’ä»¶:<br>systemctlå‘½ä»¤å¯åŠ¨flanneldåï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œ./mk-docker-opts.sh -iç”Ÿæˆ/run/flannel/subnet.envæ–‡ä»¶, åŒæ—¶flanneldå¯åŠ¨æ˜¯è¿˜ç”Ÿæˆäº†ä¸€ä¸ªdockerçš„é…ç½®æ–‡ä»¶:-/run/flannel/docker æˆ‘ä»¬ä¿®æ”¹dockerå¯åŠ¨çš„é…ç½®æ–‡ä»¶/usr/lib/systemd/system/docker.serviceåŠ å…¥è¯¥æ–‡ä»¶å³å¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">EnvironmentFile=-/run/flannel/docker</div><div class="line">EnvironmentFile=-/run/flannel/subnet.env</div></pre></td></tr></table></figure></p>
<p>åŒæ—¶ä¸ºäº†åŠ é€Ÿdockerå®˜æ–¹é•œåƒçš„ä¸‹è½½é€Ÿåº¦, é…ç½®åŠ é€Ÿå™¨:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/docker</div><div class="line">tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://v5d7kh0f.mirror.aliyuncs.com"</span>]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>ç„¶åé‡å¯docker:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl restart docker</div><div class="line">systemctl status docker</div></pre></td></tr></table></figure></p>
<h4 id="ä¸‹è½½æœ€æ–°çš„nodeèŠ‚ç‚¹çš„äºŒè¿›åˆ¶åŒ…"><a href="#ä¸‹è½½æœ€æ–°çš„nodeèŠ‚ç‚¹çš„äºŒè¿›åˆ¶åŒ…" class="headerlink" title="ä¸‹è½½æœ€æ–°çš„nodeèŠ‚ç‚¹çš„äºŒè¿›åˆ¶åŒ…"></a>ä¸‹è½½æœ€æ–°çš„nodeèŠ‚ç‚¹çš„äºŒè¿›åˆ¶åŒ…</h4><p>nodeèŠ‚ç‚¹çš„äºŒè¿›åˆ¶åŒ…: kubernetes-node-linux-amd64.tar.gz, å·²ä¸‹è½½åˆ°æˆ‘ä»¬ç™¾åº¦äº‘ç›˜: <a href="https://pan.baidu.com/s/1eTgeS5G#list/path=%2F" target="_blank" rel="external">å›½å†…ä¸‹è½½</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ tar vxf kubernetes-node-linux-amd64.tar.gz</div><div class="line">$ <span class="built_in">cd</span> kubernetes</div><div class="line">$ cp  ./node/bin/&#123;kube-proxy,kubelet&#125; /usr/<span class="built_in">local</span>/bin/</div></pre></td></tr></table></figure></p>
<h4 id="éƒ¨ç½²kubelet"><a href="#éƒ¨ç½²kubelet" class="headerlink" title="éƒ¨ç½²kubelet"></a>éƒ¨ç½²kubelet</h4><p>åˆ›å»ºkubeletçš„serviceé…ç½®æ–‡ä»¶:/usr/lib/systemd/system/kubelet.service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kubelet Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=docker.service</div><div class="line">Requires=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/kubelet</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kubelet \</div><div class="line">            <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">            <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">            <span class="variable">$KUBELET_API_SERVER</span> \</div><div class="line">            <span class="variable">$KUBELET_ADDRESS</span> \</div><div class="line">            <span class="variable">$KUBELET_PORT</span> \</div><div class="line">            <span class="variable">$KUBELET_HOSTNAME</span> \</div><div class="line">            <span class="variable">$KUBE_ALLOW_PRIV</span> \</div><div class="line">            <span class="variable">$KUBELET_POD_INFRA_CONTAINER</span> \</div><div class="line">            <span class="variable">$KUBELET_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>åˆ›å»ºkubeletçš„é…ç½®æ–‡ä»¶/etc/kubernetes/kubelet:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment">## kubernetes kubelet (minion) config</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span></div><div class="line">KUBELET_ADDRESS=<span class="string">"--address=192.168.204.6"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## The port for the info server to serve on</span></div><div class="line"><span class="comment">#KUBELET_PORT="--port=10250"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## You may leave this blank to use the actual hostname</span></div><div class="line">KUBELET_HOSTNAME=<span class="string">"--hostname-override=192.168.204.6"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## location of the api-server</span></div><div class="line"><span class="comment">## COMMENT THIS ON KUBERNETES 1.8+</span></div><div class="line"><span class="comment"># KUBELET_API_SERVER="--api-servers=192.168.204.3:8080"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## pod infrastructure container</span></div><div class="line">KUBELET_POD_INFRA_CONTAINER=<span class="string">"--pod-infra-container-image=index.tenxcloud.com/jimmy/pod-infrastructure:rhel7"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Add your own!</span></div><div class="line">KUBELET_ARGS=<span class="string">"--cgroup-driver=systemd --cluster-dns=10.254.0.2 --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --cert-dir=/etc/kubernetes/pki --cluster-domain=cluster.local --hairpin-mode promiscuous-bridge --serialize-image-pulls=false --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice"</span></div></pre></td></tr></table></figure></p>
<p>kubelet å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS bootstrapping è¯·æ±‚ï¼Œéœ€è¦å…ˆå°† bootstrap token æ–‡ä»¶ä¸­çš„ kubelet-bootstrap ç”¨æˆ·èµ‹äºˆ system:node-bootstrapper cluster è§’è‰²(role)ï¼Œ ç„¶å kubelet æ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚(certificate signing requests):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æ³¨æ„ è¯·åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ, nodeèŠ‚ç‚¹æ²¡æœ‰é…ç½®å®¢æˆ·ç«¯</span></div><div class="line"><span class="built_in">cd</span> /etc/kubernetes</div><div class="line">kubectl create clusterrolebinding kubelet-bootstrap \</div><div class="line">  --clusterrole=system:node-bootstrapper \</div><div class="line">  --user=kubelet-bootstrap</div></pre></td></tr></table></figure></p>
<p>å¯åŠ¨æœåŠ¡:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å¯åŠ¨å‰æ‰‹åŠ¨æ‹‰å–é•œåƒ</span></div><div class="line">docker pull index.tenxcloud.com/jimmy/pod-infrastructure:rhel7</div><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> kubelet</div><div class="line">systemctl start kubelet</div><div class="line">systemctl status kubelet</div></pre></td></tr></table></figure></p>
<p>kubelet é¦–æ¬¡å¯åŠ¨æ—¶å‘kube-apiserverå‘é€è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œå¿…é¡»é€šè¿‡åkubernetesç³»ç»Ÿæ‰ä¼šå°†è¯¥NodeåŠ å…¥åˆ°é›†ç¾¤, å› æ­¤éœ€è¦åœ¨masterèŠ‚ç‚¹ä¸Šå¯¹è¿™äº›nodeçš„åŠ å…¥è¿›è¡Œå®¡è®¡, é€šè¿‡åä¼šè‡ªåŠ¨ä¸ºè¿™äº›nodeé¢å‘è¯ä¹¦<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æŸ¥çœ‹æœªæˆæƒçš„CSRè¯·æ±‚</span></div><div class="line">$ kubectl get csr</div><div class="line">NAME                                                   AGE       REQUESTOR           CONDITION</div><div class="line">node-csr-D0qfDbLl4sA2uFOuEkEXt0pqYr0DjqCTNqxyaocvgq0   30m       kubelet-bootstrap   Pending</div><div class="line"><span class="comment"># é€šè¿‡CSRè¯·æ±‚</span></div><div class="line">$ kubectl certificate approve node-csr-D0qfDbLl4sA2uFOuEkEXt0pqYr0DjqCTNqxyaocvgq0</div><div class="line"><span class="comment"># æŸ¥çœ‹æ‰åŠ å…¥çš„node</span></div><div class="line">$ kubectl get nodes</div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.204.6   Ready     &lt;none&gt;    47s       v1.8.7</div></pre></td></tr></table></figure></p>
<h4 id="éƒ¨ç½²kub-proxy"><a href="#éƒ¨ç½²kub-proxy" class="headerlink" title="éƒ¨ç½²kub-proxy"></a>éƒ¨ç½²kub-proxy</h4><p>åˆ›å»º kube-proxy çš„serviceé…ç½®æ–‡ä»¶: /usr/lib/systemd/system/kube-proxy.service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kube-Proxy Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/proxy</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-proxy \</div><div class="line">        <span class="variable">$KUBE_LOGTOSTDERR</span> \</div><div class="line">        <span class="variable">$KUBE_LOG_LEVEL</span> \</div><div class="line">        <span class="variable">$KUBE_MASTER</span> \</div><div class="line">        <span class="variable">$KUBE_PROXY_ARGS</span></div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>kube-proxyé…ç½®æ–‡ä»¶/etc/kubernetes/proxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># kubernetes proxy config</span></div><div class="line"></div><div class="line"><span class="comment"># default config should be adequate</span></div><div class="line"></div><div class="line"><span class="comment"># Add your own!</span></div><div class="line">KUBE_PROXY_ARGS=<span class="string">"--bind-address=192.168.204.6 --hostname-override=192.168.204.6 --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig --cluster-cidr=10.254.0.0/16"</span></div></pre></td></tr></table></figure></p>
<p>å¯åŠ¨æœåŠ¡:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> kube-proxy</div><div class="line">systemctl start kube-proxy</div><div class="line">systemctl status kube-proxy</div><div class="line">$ netstat -tlnup | grep kub</div><div class="line">tcp        0      0 192.168.204.6:10250     0.0.0.0:*               LISTEN      12437/kubelet</div><div class="line">tcp        0      0 192.168.204.6:10255     0.0.0.0:*               LISTEN      12437/kubelet</div><div class="line">tcp        0      0 192.168.204.6:4194      0.0.0.0:*               LISTEN      12437/kubelet</div><div class="line">tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      12437/kubelet</div><div class="line">tcp        0      0 127.0.0.1:10249         0.0.0.0:*               LISTEN      12776/kube-proxy</div><div class="line">tcp6       0      0 :::10256                :::*                    LISTEN      12776/kube-proxy</div></pre></td></tr></table></figure></p>
<p>å‰©ä¸‹çš„2ä¸ªnodeèŠ‚ç‚¹: 192.168.204.13å’Œ192.168.204.14 å¦‚æ³•ç‚®åˆ¶, ç„¶åæˆ‘ä»¬åœ¨masterçœ‹çœ‹æ‰€æœ‰å·²ç»æ·»åŠ å¥½çš„nodeèŠ‚ç‚¹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME             STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.204.13   Ready     &lt;none&gt;    6s        v1.8.7</div><div class="line">192.168.204.14   Ready     &lt;none&gt;    32m       v1.8.7</div><div class="line">192.168.204.6    Ready     &lt;none&gt;    18h       v1.8.7</div></pre></td></tr></table></figure></p>
<h3 id="é›†ç¾¤æµ‹è¯•"><a href="#é›†ç¾¤æµ‹è¯•" class="headerlink" title="é›†ç¾¤æµ‹è¯•"></a>é›†ç¾¤æµ‹è¯•</h3><p>æˆ‘ä»¬é€šè¿‡éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡æ¥éªŒè¯é›†ç¾¤æ˜¯å¦æ­£å¸¸å·¥ä½œ:<br>ä¸ºäº†åŠ å¿«éªŒè¯çš„æ•ˆæœ, æˆ‘ä»¬å…ˆåœ¨nodeèŠ‚ç‚¹ä¸Šæ‹‰å–nginxçš„é•œåƒ:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull nginx</div></pre></td></tr></table></figure></p>
<p>ç„¶ååœ¨masterèŠ‚ç‚¹ä¸Šéƒ¨ç½²æœåŠ¡ï¼Œå¹¶æš´éœ²å‡ºæ¥:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$ kubectl run nginx --replicas=2 --labels=<span class="string">"run=load-balancer-example"</span> --image=nginx  --port=80</div><div class="line">deployment <span class="string">"nginx"</span> created</div><div class="line">$ kubectl expose deployment nginx --type=NodePort --name=example-service</div><div class="line">service <span class="string">"example-service"</span> exposed</div><div class="line">$ kubectl describe svc example-service</div><div class="line">Name:                     example-service</div><div class="line">Namespace:                default</div><div class="line">Labels:                   run=load-balancer-example</div><div class="line">Annotations:              &lt;none&gt;</div><div class="line">Selector:                 run=load-balancer-example</div><div class="line">Type:                     NodePort</div><div class="line">IP:                       10.254.100.109</div><div class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  80/TCP</div><div class="line">TargetPort:               80/TCP</div><div class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  30924/TCP</div><div class="line">Endpoints:                172.30.52.2:80,172.30.52.3:80</div><div class="line">Session Affinity:         None</div><div class="line">External Traffic Policy:  Cluster</div><div class="line">Events:                   &lt;none&gt;</div></pre></td></tr></table></figure></p>
<p>ç„¶åè®¿é—®æš´éœ²å‡ºæ¥çš„æœåŠ¡:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 ~]<span class="comment"># curl 192.168.204.6:30924</span></div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</div><div class="line">&lt;style&gt;</div><div class="line">    body &#123;</div><div class="line">        width: 35em;</div><div class="line">        margin: 0 auto;</div><div class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</div><div class="line">    &#125;</div><div class="line">&lt;/style&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</div><div class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</div><div class="line">working. Further configuration is required.&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p&gt;For online documentation and support please refer to</div><div class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</div><div class="line">Commercial support is available at</div><div class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h3 id="éƒ¨ç½²dashboardåº”ç”¨"><a href="#éƒ¨ç½²dashboardåº”ç”¨" class="headerlink" title="éƒ¨ç½²dashboardåº”ç”¨"></a>éƒ¨ç½²dashboardåº”ç”¨</h3><p>è¿™é‡Œä¸æ˜¯1.7.1çš„dashboard, yamlæ–‡ä»¶å†…å®¹å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Copyright 2017 The Kubernetes Authors.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></div><div class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></div><div class="line"><span class="comment"># You may obtain a copy of the License at</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></div><div class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></div><div class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div><div class="line"><span class="comment"># See the License for the specific language governing permissions and</span></div><div class="line"><span class="comment"># limitations under the License.</span></div><div class="line"></div><div class="line"><span class="comment"># Configuration to deploy release version of the Dashboard UI compatible with</span></div><div class="line"><span class="comment"># Kubernetes 1.7.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Example usage: kubectl create -f &lt;this_file&gt;</span></div><div class="line"></div><div class="line"><span class="comment"># ------------------- Dashboard Secret ------------------- #</span></div><div class="line"></div><div class="line">apiVersion: v1</div><div class="line">kind: Secret</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    k8s-app: kubernetes-dashboard</div><div class="line">  name: kubernetes-dashboard-certs</div><div class="line">  namespace: kube-system</div><div class="line"><span class="built_in">type</span>: Opaque</div><div class="line"></div><div class="line">---</div><div class="line"><span class="comment"># ------------------- Dashboard Service Account ------------------- #</span></div><div class="line"></div><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    k8s-app: kubernetes-dashboard</div><div class="line">  name: kubernetes-dashboard</div><div class="line">  namespace: kube-system</div><div class="line"></div><div class="line">---</div><div class="line"><span class="comment"># ------------------- Dashboard Role &amp; Role Binding ------------------- #</span></div><div class="line"></div><div class="line">kind: Role</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">metadata:</div><div class="line">  name: kubernetes-dashboard-minimal</div><div class="line">  namespace: kube-system</div><div class="line">rules:</div><div class="line">  <span class="comment"># Allow Dashboard to create and watch for changes of 'kubernetes-dashboard-key-holder' secret.</span></div><div class="line">- apiGroups: [<span class="string">""</span>]</div><div class="line">  resources: [<span class="string">"secrets"</span>]</div><div class="line">  verbs: [<span class="string">"create"</span>, <span class="string">"watch"</span>]</div><div class="line">- apiGroups: [<span class="string">""</span>]</div><div class="line">  resources: [<span class="string">"secrets"</span>]</div><div class="line">  <span class="comment"># Allow Dashboard to get, update and delete 'kubernetes-dashboard-key-holder' secret.</span></div><div class="line">  resourceNames: [<span class="string">"kubernetes-dashboard-key-holder"</span>, <span class="string">"kubernetes-dashboard-certs"</span>]</div><div class="line">  verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>, <span class="string">"delete"</span>]</div><div class="line">  <span class="comment"># Allow Dashboard to get metrics from heapster.</span></div><div class="line">- apiGroups: [<span class="string">""</span>]</div><div class="line">  resources: [<span class="string">"services"</span>]</div><div class="line">  resourceNames: [<span class="string">"heapster"</span>]</div><div class="line">  verbs: [<span class="string">"proxy"</span>]</div><div class="line"></div><div class="line">---</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">kind: RoleBinding</div><div class="line">metadata:</div><div class="line">  name: kubernetes-dashboard-minimal</div><div class="line">  namespace: kube-system</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: Role</div><div class="line">  name: kubernetes-dashboard-minimal</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: kubernetes-dashboard</div><div class="line">  namespace: kube-system</div><div class="line"></div><div class="line">---</div><div class="line"><span class="comment"># ------------------- Dashboard Deployment ------------------- #</span></div><div class="line"></div><div class="line">kind: Deployment</div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    k8s-app: kubernetes-dashboard</div><div class="line">  name: kubernetes-dashboard</div><div class="line">  namespace: kube-system</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  revisionHistoryLimit: 10</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      k8s-app: kubernetes-dashboard</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        k8s-app: kubernetes-dashboard</div><div class="line">    spec:</div><div class="line">      initContainers:</div><div class="line">      - name: kubernetes-dashboard-init</div><div class="line">        image: index.tenxcloud.com/jimmy/kubernetes-dashboard-init-amd64:v1.0.1</div><div class="line">        volumeMounts:</div><div class="line">        - name: kubernetes-dashboard-certs</div><div class="line">          mountPath: /certs</div><div class="line">      containers:</div><div class="line">      - name: kubernetes-dashboard</div><div class="line">        image: index.tenxcloud.com/jimmy/kubernetes-dashboard-amd64:v1.7.1</div><div class="line">        ports:</div><div class="line">        - containerPort: 8443</div><div class="line">          protocol: TCP</div><div class="line">        args:</div><div class="line">          - --tls-key-file=/certs/dashboard.key</div><div class="line">          - --tls-cert-file=/certs/dashboard.crt</div><div class="line">          <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host</span></div><div class="line">          <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></div><div class="line">          <span class="comment"># to it. Uncomment only if the default does not work.</span></div><div class="line">          <span class="comment"># - --apiserver-host=http://my-address:port</span></div><div class="line">        volumeMounts:</div><div class="line">        - name: kubernetes-dashboard-certs</div><div class="line">          mountPath: /certs</div><div class="line">          <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">          <span class="comment"># Create on-disk volume to store exec logs</span></div><div class="line">        - mountPath: /tmp</div><div class="line">          name: tmp-volume</div><div class="line">        livenessProbe:</div><div class="line">          httpGet:</div><div class="line">            scheme: HTTPS</div><div class="line">            path: /</div><div class="line">            port: 8443</div><div class="line">          initialDelaySeconds: 30</div><div class="line">          timeoutSeconds: 30</div><div class="line">      volumes:</div><div class="line">      - name: kubernetes-dashboard-certs</div><div class="line">        secret:</div><div class="line">          secretName: kubernetes-dashboard-certs</div><div class="line">      - name: tmp-volume</div><div class="line">        emptyDir: &#123;&#125;</div><div class="line">      serviceAccountName: kubernetes-dashboard</div><div class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></div><div class="line">      tolerations:</div><div class="line">      - key: node-role.kubernetes.io/master</div><div class="line">        effect: NoSchedule</div><div class="line"></div><div class="line">---</div><div class="line"><span class="comment"># ------------------- Dashboard Service ------------------- #</span></div><div class="line"></div><div class="line">kind: Service</div><div class="line">apiVersion: v1</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    k8s-app: kubernetes-dashboard</div><div class="line">  name: kubernetes-dashboard</div><div class="line">  namespace: kube-system</div><div class="line">spec:</div><div class="line">  ports:</div><div class="line">    - port: 443</div><div class="line">      targetPort: 8443</div><div class="line">  selector:</div><div class="line">    k8s-app: kubernetes-dashboard</div><div class="line">  <span class="built_in">type</span>: NodePort</div></pre></td></tr></table></figure></p>
<p>ä¸ºäº†åŠ å¿«è®¿é—®, å…ˆåœ¨nodeèŠ‚ç‚¹ä¸Šæå‰æ‹‰å–é•œåƒ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker pull index.tenxcloud.com/jimmy/kubernetes-dashboard-init-amd64:v1.0.1</div><div class="line">docker pull index.tenxcloud.com/jimmy/kubernetes-dashboard-amd64:v1.7.1</div></pre></td></tr></table></figure></p>
<p>ç„¶ååˆ°masterèŠ‚ç‚¹ä¸Š åˆ›å»ºåº”ç”¨:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl create -f kubernetes-dashboard.yaml</span></div><div class="line">secret <span class="string">"kubernetes-dashboard-certs"</span> created</div><div class="line">serviceaccount <span class="string">"kubernetes-dashboard"</span> created</div><div class="line">role <span class="string">"kubernetes-dashboard-minimal"</span> created</div><div class="line">rolebinding <span class="string">"kubernetes-dashboard-minimal"</span> created</div><div class="line">deployment <span class="string">"kubernetes-dashboard"</span> created</div><div class="line">service <span class="string">"kubernetes-dashboard"</span> created</div><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl -n kube-system get svc kubernetes-dashboard</span></div><div class="line">NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</div><div class="line">kubernetes-dashboard   NodePort   10.254.75.168   &lt;none&gt;        443:32101/TCP   2m</div></pre></td></tr></table></figure></p>
<p>ç„¶åè®¿é—®å¯¹ç”¨çš„port<br><img src="http://oiw1gzfww.bkt.clouddn.com/k8s-dashboard.jpg" alt="dashboard-login-page"></p>
<p>ç™»é™†dashboardçš„æ—¶å€™æ”¯æŒkubeconfigå’Œtokenä¸¤ç§è®¤è¯æ–¹å¼ï¼Œkubeconfigä¸­ä¹Ÿä¾èµ–tokenå­—æ®µ, å› æ­¤ä¹‹å‰ä¸ºadminç”¨æˆ·ç”Ÿæˆçš„é‚£ä¸ªé…ç½®ä¹Ÿç¼ºå°‘token, æ‰€æœ‰ä¹‹å‰CLIä½¿ç”¨çš„kubeconfigæ˜¯ç™»å½•ä¸äº†çš„, ä¸‹æ˜¯ç”Ÿæˆtokençš„æ“ä½œ:<br>é¦–å…ˆæˆ‘ä»¬å¾—åˆ›å»ºä¸€ä¸ªadminè§’è‰²çš„è´¦å·, æ¯”å¦‚å°±å«admin, æˆ‘ä»¬é€šè¿‡ admin-role.yamlè¿›è¡Œåˆ›å»º, å†…å®¹å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">kind: ClusterRoleBinding</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">metadata:</div><div class="line">  name: admin</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">roleRef:</div><div class="line">  kind: ClusterRole</div><div class="line">  name: cluster-admin</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: admin</div><div class="line">  namespace: kube-system</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  name: admin</div><div class="line">  namespace: kube-system</div><div class="line">  labels:</div><div class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></div><div class="line">    addonmanager.kubernetes.io/mode: Reconcile</div></pre></td></tr></table></figure></p>
<p>åˆ›å»ºå¹¶è·å–token:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl create -f admin-role.yaml</span></div><div class="line">clusterrolebinding <span class="string">"admin"</span> created</div><div class="line">serviceaccount <span class="string">"admin"</span> created</div><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl -n kube-system get secret|grep admin-token</span></div><div class="line">admin-token-2p7l7                  kubernetes.io/service-account-token   3         21s</div><div class="line">[root@k8s-apiserver01 apps]<span class="comment"># kubectl -n kube-system describe secret admin-token-2p7l7</span></div><div class="line">Name:         admin-token-2p7l7</div><div class="line">Namespace:    kube-system</div><div class="line">Labels:       &lt;none&gt;</div><div class="line">Annotations:  kubernetes.io/service-account.name=admin</div><div class="line">              kubernetes.io/service-account.uid=c9aad066-fe8d-11e7-8479-fa163ee6f9f6</div><div class="line"></div><div class="line">Type:  kubernetes.io/service-account-token</div><div class="line"></div><div class="line">Data</div><div class="line">====</div><div class="line">ca.crt:     1359 bytes</div><div class="line">namespace:  11 bytes</div><div class="line">token:      eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi0ycDdsNyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImM5YWFkMDY2LWZlOGQtMTFlNy04NDc5LWZhMTYzZWU2ZjlmNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.dv9Rt6EA08KFvYDqHYJlHu188vwfPPxf8Yf0cOhHswOsGWhgsoq-UmugcKcq1nqiVEEXR_EXb657ftPrpKOJrt3pkS2__5FdI-h3D6mKj1-zFae-dj8y_tVi4oaHQExIoxgbrzvBVKTpNxDbzWPKf2CChzRPRWqMmAuPlxK8iSvOf11wGe5B_Fh3okObFk5p_CA1Iz9NFRfD3OSR1_9Bt13SfwdKC3oodVBjrrTB-4O00gYM1RHV54_UmhSVJJkZCfvGhfqVt0h0f1Jmihju_D1OyQY5Lp-LpHN0hP<span class="_">-a</span>8TOidmjNYmy96euiZcDPhnb932GYaA2xVzgcIag72bIzbw</div></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨è·å–åçš„tokenè¿›è¡Œç™»å½•<br><img src="http://oiw1gzfww.bkt.clouddn.com/k8s-dash.jpg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ­å»ºkubernetesé›†ç¾¤æœ€å¤§çš„éº»çƒ¦å…¶å®ä¸åœ¨äºå…¶å¤æ‚åº¦(ç›¸å¯¹Openstacké›†ç¾¤)è€Œåœ¨äºæœ‰GFW, æ‰€ä»¥ä¸ºäº†é¿å…å¢™å¸¦æ¥çš„éº»çƒ¦, ä¹Ÿä¸ºäº†åŠ æ·±å¯¹kubernetesçš„ç†è§£, è¿™é‡Œå°†ä½¿ç”¨çº¯æ‰‹å·¥ç¦»çº¿çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²(ç›¸åº”çš„æ–‡ä»¶æˆ‘å·²ç»ä¸‹è½½åˆ°ç™¾åº¦äº‘ç›˜é‡Œé¢)ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.yumaojun.net/categories/%E8%BF%90%E7%BB%B4/"/>
    
      <category term="kubernetes" scheme="https://blog.yumaojun.net/categories/%E8%BF%90%E7%BB%B4/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="https://blog.yumaojun.net/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>OAuth2.0æˆæƒæœºåˆ¶è¯¦è§£</title>
    <link href="https://blog.yumaojun.net/2017/12/07/oauth2/"/>
    <id>https://blog.yumaojun.net/2017/12/07/oauth2/</id>
    <published>2017-12-07T07:13:08.000Z</published>
    <updated>2017-12-11T14:48:55.000Z</updated>
    
    <content type="html"><![CDATA[<p>å½“ä»Šäº’è”ç½‘çš„åŠŸèƒ½å¯è°“æ˜¯äº”èŠ±å…«é—¨, è€Œå¾ˆå¤šæœåŠ¡éœ€è¦ä¾èµ–ç”¨æˆ·å·²æœ‰çš„æ•°æ®æ‰èƒ½æä¾›æœåŠ¡, æ¯”å¦‚äº‘å†²å°, éœ€è¦è®¿é—®ç”¨æˆ·äº‘ç›˜é‡Œé¢çš„ç…§ç‰‡æ•°æ®, å†æ¯”å¦‚ciæœåŠ¡, éœ€è¦è®¿é—®ç”¨æˆ·ä»£ç ä»“åº“é‡Œé¢çš„é¡¹ç›®æ•°æ®ã€‚å¦‚ä½•å®‰å…¨å¾—å°†ç”¨æˆ·çš„æ•°æ®æš´éœ²ç»™ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚, è€ŒOAuthçš„å‡ºç°å°±æ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„ã€‚<br><a id="more"></a></p>
<h2 id="ä¼ ç»Ÿè®¤è¯çš„é—®é¢˜"><a href="#ä¼ ç»Ÿè®¤è¯çš„é—®é¢˜" class="headerlink" title="ä¼ ç»Ÿè®¤è¯çš„é—®é¢˜"></a>ä¼ ç»Ÿè®¤è¯çš„é—®é¢˜</h2><p>åœ¨ä¼ ç»Ÿçš„<code>client-server</code>èº«ä»½è®¤è¯æ¨¡å‹ä¸­, å®¢æˆ·ç«¯é€šè¿‡èµ„æºæ‰€æœ‰è€…(resource owner)çš„å‡­è¯æ¥è®¿é—®æœåŠ¡ç«¯çš„å—ä¿æŠ¤çš„èµ„æºï¼Œ ä¸ºäº†è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®å—é™èµ„æºï¼Œ åˆ™ç¬¬ä¸‰æ–¹åº”ç”¨å¿…é¡»åˆ†äº«èµ„æºæ‰€æœ‰è€…çš„å‡­è¯,<br>è¿™å°±äº§ç”Ÿäº†ä¸€äº›é—®é¢˜å’Œå±€é™æ€§ï¼š</p>
<ol>
<li>Third-party appéƒ½éœ€è¦å­˜å‚¨resource ownerçš„å‡­è¯(credentials), ä»¥å¤‡å°†æ¥ä¹‹ç”¨, è€Œcredentialså¾€å¾€éƒ½æ˜¯æ˜æ–‡</li>
<li>serverså¿…é¡»æ”¯æŒcredentialè®¤è¯ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·å/å¯†ç çš„è®¤è¯</li>
<li>Third-party appè·å–çš„è®¿é—®resource ownerçš„æ‰€æœ‰èµ„æºçš„æƒé™ï¼Œå¹¶ä¸”æ— æ—¶é—´å’Œå­é›†é™åˆ¶</li>
<li>resource ownerä¸èƒ½å•ç‹¬æ’¤é”€æŸä¸€ä¸ªThird-party appçš„èµ„æºè®¿é—®æƒé™ï¼Œè€Œæ’¤é”€æ–¹æ³•åªèƒ½é€šè¿‡ä¿®æ”¹credentialå®Œæˆï¼Œè¿™å°†æ’¤é”€æ‰æ‰€æœ‰Third-party appçš„èµ„æºè®¿é—®æƒé™</li>
<li>ä»»ä½•ä¸€ä¸ª Third-party app çš„å¯†ç æ³„éœ²ï¼Œéƒ½å°†å¯¼è‡´ç”¨æˆ·æ•°æ®çš„æ³„éœ²</li>
</ol>
<p>ä¸¾ä¸€ä¸ªç®€å•ä¸€ç‚¹çš„æ —å­:</p>
<blockquote>
<p>ä½ æœ‰ä¸€åº§åˆ«å¢…, è¿™ä¸ªåˆ«å¢…æ˜¯ä½ çš„èµ„äº§, æ¸…æ´å…¬å¸æä¾›åˆ«å¢…æ¸…æ´æœåŠ¡(ç¬¬ä¸‰æ–¹æœåŠ¡å•†), å›­è‰ºå…¬å¸æä¾›ä¿®å‰ªèŠ±å›­çš„æœåŠ¡(ç¬¬ä¸‰æ–¹æœåŠ¡å•†), è€Œè¿›å…¥ä½ åˆ«å¢…çš„å‡­è¯å°±æ˜¯åˆ«å¢…çš„é’¥åŒ™, å¦‚æœä½ ç›´æ¥å°†é’¥åŒ™(èµ„äº§è®¿é—®å‡­è¯)ç»™è¿™2ä¸ªæœåŠ¡å•†, è¿™æ˜¯å¾ˆå±é™©çš„, å› ä¸ºä»–ä»¬ä¹Ÿå¯ä»¥å¤åˆ¶ä½ çš„é’¥åŒ™, æ­¤æ—¶ä½ çš„åˆ«å¢…çš„å®‰å…¨ä½“ç³»å°±å´©å¡Œäº†, å‡å¦‚ä½ çœŸçš„å¾ˆä¿¡ä»»ä»–ä»¬, ä½†æ˜¯å¦‚æœå›­è‰ºå…¬å¸çš„äººæœ‰é—®é¢˜, ä»–å¯èƒ½ç›—èµ°äº†ä½ ç»™ä»–çš„é’¥åŒ™, æ­¤æ—¶å’‹åŠ, å”¯æœ‰æ¢é”, ä½†æ˜¯é”æ¢äº† åˆ«å¢…çš„æ¸…æ´æœåŠ¡ä¹Ÿä¼šå—åˆ°å½±å“, å› æ­¤ä½ ä¼šå‘ç° æŠŠé’¥åŒ™ç›´æ¥ç»™ç¬¬ä¸‰æ–¹æ˜¯å¾ˆä¸å®‰å…¨çš„, ä¼šå¼•å‘å¾ˆå¤šå®‰å…¨éšæ‚£é—®é¢˜ã€‚</p>
</blockquote>
<h2 id="OAuth2çš„è§£å†³æ€è·¯"><a href="#OAuth2çš„è§£å†³æ€è·¯" class="headerlink" title="OAuth2çš„è§£å†³æ€è·¯"></a>OAuth2çš„è§£å†³æ€è·¯</h2><p>å¯¹äºä¸Šé¢çš„æ —å­, å½“æœ‰å¤šä¸ªç¬¬ä¸‰æ–¹æœåŠ¡å•†è¦è®¿é—®æˆ‘ä»¬çš„èµ„æºæ—¶(è¿›å…¥åˆ«å¢…), ä»…é€šè¿‡1æŠŠé”çš„æ–¹å¼æ¥ä¿è¯èµ„äº§çš„å®‰å…¨è®¿é—®æ˜¯å¾ˆæˆé—®é¢˜çš„, å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€å±‚ä¸­é—´å±‚æ¥ç®¡ç†è¿™äº›äººçš„è®¿é—®æƒé™, å¸¸è§çš„åšæ³•æ˜¯æ‹›ä¸€ä¸ªç®¡å®¶, æ¯æ¬¡è®¿é—®æ—¶ç”±ç®¡å®¶è¯¢é—®åˆ«å¢…ä¸»äººè¿›è¡Œæˆæƒã€‚</p>
<p>OAuthçš„å®ç°æ–¹å¼ä¸æ­¤ç±»ä¼¼, OAuthåœ¨â€å®¢æˆ·ç«¯â€(ç¬¬ä¸‰æ–¹æœåŠ¡)ä¸â€æœåŠ¡æä¾›å•†â€(ç”¨æˆ·è‡ªå·±çš„èµ„äº§æœåŠ¡)ä¹‹é—´ï¼Œè®¾ç½®äº†ä¸€ä¸ªæˆæƒå±‚(ç±»ä¼¼äºä¸Šé¢çš„ç®¡å®¶)ã€‚â€å®¢æˆ·ç«¯â€ä¸èƒ½ç›´æ¥ç™»å½•â€æœåŠ¡æä¾›å•†â€(ç¬¬ä¸‰æ–¹æ— æ³•ç›´æ¥è¿›å…¥åˆ«å¢…), åªèƒ½ç™»å½•æˆæƒå±‚(è¯¢é—®ç®¡å®¶)ï¼Œä»¥æ­¤å°†ç”¨æˆ·(èµ„äº§çš„ä¸»äºº)ä¸å®¢æˆ·ç«¯(ç¬¬ä¸‰æ–¹)åŒºåˆ†å¼€æ¥ã€‚</p>
<p>â€œå®¢æˆ·ç«¯â€ç™»å½•æˆæƒå±‚æ‰€ç”¨çš„ä»¤ç‰Œ(token), ä¸ç”¨æˆ·çš„å¯†ç ä¸åŒã€‚ç”¨æˆ·å¯ä»¥åœ¨ç™»å½•çš„æ—¶å€™ï¼ŒæŒ‡å®šæˆæƒå±‚ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸã€‚â€å®¢æˆ·ç«¯â€ç™»å½•æˆæƒå±‚ä»¥åï¼Œâ€æœåŠ¡æä¾›å•†â€æ ¹æ®ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸï¼Œå‘â€å®¢æˆ·ç«¯â€å¼€æ”¾ç”¨æˆ·èµ„äº§è®¿é—®çš„æƒé™ã€‚</p>
<p>å…·ä½“è¿‡ç¨‹å¯ä»¥ç”¨ä»¥ä¸‹è¿™å¼ å›¾æ¥æè¿°(å›¾ä¸­clientå°±ä»£è¡¨ä¸­é—´å±‚):<br><img src="http://oiw1gzfww.bkt.clouddn.com/layer_oauth2.0.png" alt=""></p>
<h2 id="OAuth2ç®€ä»‹"><a href="#OAuth2ç®€ä»‹" class="headerlink" title="OAuth2ç®€ä»‹"></a>OAuth2ç®€ä»‹</h2><p>OAuth(å¼€æ”¾æˆæƒ)æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå…è®¸ç”¨æˆ·è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è¯¥ç”¨æˆ·åœ¨æŸä¸€ç½‘ç«™ä¸Šå­˜å‚¨çš„ç§å¯†çš„èµ„æº(å¦‚ç…§ç‰‡ï¼Œè§†é¢‘ï¼Œè”ç³»äººåˆ—è¡¨)ï¼Œè€Œæ— éœ€å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚</p>
<p>OAuth1.0åœ¨2007å¹´çš„12æœˆåº•å‘å¸ƒå¹¶è¿…é€Ÿæˆä¸ºå·¥ä¸šæ ‡å‡†, åœ¨OAuth1.0ä¸­é€šè¿‡HMACå’Œtoken secretåŠ å¯†å¹¶å‘é€çš„æ–¹å¼ä¸ºç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä¸€ä¸ªæœ‰æ•ˆæœŸéå¸¸é•¿çš„token(å…¸å‹çš„æ˜¯ä¸€å¹´æœ‰æ•ˆæœŸæˆ–è€…æ— æœ‰æ•ˆæœŸé™åˆ¶)ã€‚</p>
<p>OAuth2.0åœ¨2012å¹´10æœˆåè®®æ­£å¼å‘å¸ƒä¸ºRFC 6749. ç°åœ¨å¾ˆå¤šå¼€æ”¾å¹³å°éƒ½æ˜¯ä½¿ç”¨çš„OAuth 2.0åè®®ä½œä¸ºæ”¯æ’‘ã€‚æ¯”å¦‚ç™¾åº¦å¼€å‘å¹³å°, å¾®è–„å¼€æ”¾å¹³å°, å¾®ä¿¡å¼€æ”¾å¹³å°, Googleä»¥åŠFacebookçš„å¼€æ”¾æœåŠ¡, æ˜¾ç„¶OAuth2.0å·²ç»æˆä¸ºäº†ä¸‹ä¸€ä»£çš„â€œç”¨æˆ·éªŒè¯å’Œæˆæƒâ€çš„äº’è”ç½‘æ ‡å‡†åè®®ã€‚ä½†æ˜¯, å€¼å¾—æ³¨æ„çš„æ˜¯OAuth 2.0 çš„å‡ºç°ï¼Œå°†å®Œå…¨å–ä»£OAuth 1.0, å¹¶ä¸”2.0å®Œå…¨ä¸å…¼å®¹1.0ï¼Œ æ‰€æœ‰1.0å°†åºŸå¼ƒã€‚</p>
<p>ç›¸å¯¹äºOAuth1.0ä¸­å‘è¡Œä¸€ä¸ªæœ‰æ•ˆæœŸéå¸¸é•¿çš„token, OAuth2.0é‡‡ç”¨çŸ­æœ‰æ•ˆæœŸtoken(access token)å’Œé•¿ç”Ÿå‘½å‘¨æœŸ(refresh token)çš„æ–¹å¼, è¿™å°†å…è®¸å®¢æˆ·ç«¯æ— éœ€ç”¨æˆ·å†æ¬¡æ“ä½œè€Œè·å–ä¸€ä¸ªæ–°çš„access tokenï¼Œå¹¶ä¸”ä¹Ÿé™åˆ¶äº†access tokençš„æœ‰æ•ˆæœŸã€‚</p>
<p>OAuth2.0å°†è§’è‰²è¿›è¡Œäº†æ‹†åˆ†, åˆ†ä¸º:</p>
<ul>
<li>Authorization Server: è´Ÿè´£è·å–ç”¨æˆ·çš„æˆæƒå¹¶ä¸”å‘å¸ƒtoken</li>
<li>Resource Server: è´Ÿè´£å¤„ç†API calls</li>
</ul>
<p>åœ¨æ‰©å±•æ€§ä¸Šå¾—åˆ°äº†è¿›ä¸€æ­¥æå‡, è€Œä¸”è¿™ç§æ–¹å¼æå…¶æ–¹ä¾¿å¼€å‘åˆ†å¸ƒå¼åº”ç”¨, æ˜¯å¾®æœåŠ¡æ—¶ä»£æˆæƒä¸­å¿ƒçš„ä¸äºŒä¹‹é€‰ã€‚</p>
<h2 id="OAuth2çš„åº”ç”¨åœºæ™¯"><a href="#OAuth2çš„åº”ç”¨åœºæ™¯" class="headerlink" title="OAuth2çš„åº”ç”¨åœºæ™¯"></a>OAuth2çš„åº”ç”¨åœºæ™¯</h2><p>ç°åœ¨å¾ˆå¤šç½‘ç«™éƒ½å…è®¸é€šè¿‡Google, QQ, æ–°æµª, å¾®ä¿¡ç­‰è´¦å·ç›´æ¥ç™»å½•ç½‘ç«™ï¼Œè¿™å°±æ˜¯OAuthæœ€å¸¸è§çš„ä¸€ç§ä½¿ç”¨åœºæ™¯ï¼Œä»–è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ä½ å­˜å‚¨åœ¨QQæˆ–è€…å¾®ä¿¡ä¸Šçš„ç”¨æˆ·ä¿¡æ¯, æ¯”å¦‚æ‹‰å‹¾ç½‘:<br><img src="http://oiw1gzfww.bkt.clouddn.com/lagou_oauth2.0.png" alt=""><br>å½“ä½ ç‚¹å‡»ä»»æ„ä¸€ä¸ªæ—¶, éƒ½å°†ä¼šè·³è½¬åˆ°ä»–ä»¬çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œè®¤è¯, æ‰€ä»¥ç¬¬ä¸‰æ–¹åº”ç”¨æ˜¯ä¸ä¼šè·å–ç”¨æˆ·çš„credential(ç”¨æˆ·åå’Œå¯†ç ), å¹¶ä¸”å¯ä»¥é€‰æ‹©å“ªäº›èµ„æºè¢«è®¿é—®ï¼Œ è€Œä¸”è®¿é—®ä¹Ÿæ˜¯æœ‰æ—¶æ•ˆæ€§çš„ï¼Œ ä¸€èˆ¬åœ¨1å°æ—¶æˆ–è€…2ä¸ªå°æ—¶å è®¿é—®tokenå°±ä¼šè¿‡æœŸã€‚<br><img src="http://oiw1gzfww.bkt.clouddn.com/lagou1_oauth2.0.png" alt=""></p>
<p>å‡¡æ˜¯ç”¨æˆ·è‡ªå·±çš„æ•°æ®, éƒ½å¯ä»¥é€šè¿‡OAuth2æ¥å¼€æ”¾ç»™ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®, ä¸Šé¢è¿™ç§é€šè¿‡è®¿é—®ç”¨æˆ·çš„profileä¿¡æ¯å®ç°ç¬¬ä¸‰æ–¹ç™»å½•ä»…ä»…æ˜¯æ¯”è¾ƒæ™®éè€Œå·², ä½ ä¹Ÿå¯ä»¥åˆ†äº«ä½ å¯¹èµ„æºçš„å…¶ä»–æƒé™, æ¯”å¦‚å¾®è–„å¯ä»¥è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ç”¨æˆ·å‘è¡¨å¾®è–„,ä»¥åŠåˆ†äº«å¾®è–„:<br><img src="http://www.sinaimg.cn/blog/developer/wiki/OAuth2_intro.png" alt=""></p>
<p>æ€»ä¹‹é€šè¿‡OAuth2.0ç”¨æˆ·å¯ä»¥é€‰æ‹©æ€§çš„æš´éœ²è‡ªå·±çš„ä¿¡æ¯, ç”šè‡³æ˜¯APIçš„è®¿é—®æƒé™ã€‚æ¯”å¦‚æˆæƒæŸäº›ç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥åˆ é™¤ä½ çš„å¾®è–„ä¿¡æ¯ã€‚</p>
<h2 id="OAuth2çš„æˆæƒæµç¨‹"><a href="#OAuth2çš„æˆæƒæµç¨‹" class="headerlink" title="OAuth2çš„æˆæƒæµç¨‹"></a>OAuth2çš„æˆæƒæµç¨‹</h2><p>åœ¨OAuth 2.0å®šä¹‰äº†4ç§è§’è‰²ï¼Œä»¥ä¸Šé¢æåˆ°çš„åº”ç”¨åœºæ™¯çš„ä¾‹å­è¿›è¡Œè¯´æ˜:</p>
<ul>
<li>Resource Owner: èµ„æºæ‰€æœ‰è€…ï¼Œè¿™é‡ŒæŒ‡çš„QQçš„æœ€ç»ˆç”¨æˆ·æˆ‘ï¼Œ  è€Œèµ„æºæŒ‡æˆ‘å­˜å‚¨åœ¨QQæœåŠ¡é‡Œé¢çš„ä¸€äº›ä¸ªäººä¿¡æ¯: æ˜µç§°ã€å¤´åƒã€æ€§åˆ«ç­‰ã€‚</li>
<li>Resource Server: èµ„æºæœåŠ¡å™¨ï¼ŒåŠä¿å­˜æˆ‘qqæ˜µç§°ã€å¤´åƒã€æ€§åˆ«è¿™äº›èµ„æºçš„åç«¯æœåŠ¡, ä¸€èˆ¬éœ€è¦é€šè¿‡access_tokenæ¥è®¿é—®è¿™äº›å—ä¿æŠ¤çš„èµ„æºã€‚</li>
<li>Client: ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œ è¿™é‡ŒæŒ‡ä»£æ‹‰é’©ç½‘</li>
<li>Authorization Server: æˆæƒæœåŠ¡å™¨ï¼Œè¿™é‡ŒæŒ‡qqçš„æˆæƒæœåŠ¡å™¨, åŠæä¾›æˆæƒç¡®è®¤é¡µé¢çš„åç«¯æˆæƒæœåŠ¡ã€‚å½“ç”¨æˆ·è®¤è¯å’ŒæˆæƒæˆåŠŸå,ç”±è¯¥æœåŠ¡å‘client(ç¬¬ä¸‰æ–¹åº”ç”¨)é¢å‘access_token</li>
</ul>
<h3 id="æˆæƒæµç¨‹"><a href="#æˆæƒæµç¨‹" class="headerlink" title="æˆæƒæµç¨‹"></a>æˆæƒæµç¨‹</h3><p>å›´ç»•ç€è¿™4ä¸ªæ¦‚å¿µ, æˆ‘ä»¬æ¥è¯´æ˜ä¸‹OAuth2.0çš„æˆæƒæµç¨‹:<br><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b10000_10000&amp;sec=1512645676&amp;di=8e090cb8fcd158a0f7a78e264f026635&amp;src=http://img2.shangxueba.com/img/kaifa/20140904/10/5BC0114C4E4C04866AADE7D26D2A83A4.bmp" alt=""></p>
<ol>
<li>ç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚èµ„æºæ‰€æœ‰è€…æˆæƒ, æˆæƒè¯·æ±‚å¾€å¾€é€šè¿‡ä¸­è½¬åˆ°æˆæƒæœåŠ¡æ¥éªŒè¯èµ„æºæ‰€æœ‰è€…çš„èº«ä»½, æ¯”å¦‚åº”ç”¨åœºæ™¯é‡Œé¢é‚£äº›éœ€è¦ç”¨æˆ·ç™»å½•çš„é¡µé¢</li>
<li>ç¬¬ä¸‰æ–¹åº”ç”¨è·å¾—èµ„æºæ‰€æœ‰è€…çš„æˆæƒ, æ¯”å¦‚åº”ç”¨åœºæ™¯é‡Œé¢éœ€è¦ç”¨æˆ·ç‚¹å‡»çš„æˆæƒæŒ‰é’®, OAuth2å®šä¹‰äº†4ç§æˆæƒçš„æ–¹å¼,ç®€ç§°æˆæƒæ¨¡å¼, åé¢é©¬ä¸Šè®²åˆ°,å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ‰©å±•è‡ªå·±çš„æˆæƒæ¨¡å¼ã€‚</li>
<li>ç¬¬ä¸‰æ–¹åº”ç”¨æ ¹æ®ç”¨æˆ·çš„æˆæƒ å‘æˆæƒæœåŠ¡ è¯·æ±‚è®¿é—®èµ„æºçš„token</li>
<li>æˆæƒæœåŠ¡ æ ¹æ®ç”¨æˆ·çš„æˆæƒ è¿”å›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®èµ„æºçš„token</li>
<li>ç¬¬ä¸‰æ–¹åº”ç”¨æ ¹æ®è·å–åˆ°çš„token å‘èµ„æºæœåŠ¡ è¯·æ±‚èµ„æº</li>
<li>èµ„æºæœåŠ¡ å“åº”èµ„æºç»™ç¬¬ä¸‰æ–¹åº”ç”¨</li>
</ol>
<p>ç”±æ­¤å¯è§æµç¨‹çš„å…³é”®åœ¨äºç¬¬äºŒéƒ¨(2), å› ä¸ºè¿™é‡Œæ˜¯Authorization layer, å®ƒå†³å®šäº†ç”¨æˆ·æä¾›çš„æˆæƒæ‰¹å‡†ä¿¡æ¯ä»¥ä½•ç§å½¢å¼è¿”å›ç»™clientè®©å…¶å‡­å€Ÿæ­¤ä¿¡æ¯è·å–è®¿é—®ä»¤ç‰Œ(access token)</p>
<h3 id="å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼"><a href="#å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼" class="headerlink" title="å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼"></a>å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼</h3><p>æˆæƒè®¸å¯(Authorization Grant)æ˜¯ä¸€ä¸ªä»£è¡¨èµ„æºæ‰€æœ‰è€…è®¿é—®è‡ªå·±èµ„æºçš„ä¸€ç§å‡­è¯, ç”¨äºç¬¬ä¸‰æ–¹åº”ç”¨ç”³è¯·è®¿é—®ä»¤ç‰Œ(access token), oauthå®šä¹‰äº†4ç§æˆæƒæ¨¡å¼:</p>
<ul>
<li>æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰</li>
<li>ç®€åŒ–æ¨¡å¼ï¼ˆimplicitï¼‰</li>
<li>å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰</li>
<li>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰</li>
</ul>
<p>æ¯ä¸€ç§æ¨¡å¼åº”å¯¹ä¸åŒçš„æˆæƒåœºæ™¯, å¦‚æœoauthå®šä¹‰çš„è¿™4ç§æ¨¡å¼æ— æ³•æ»¡è¶³ä½ çš„æˆæƒéœ€æ±‚, ä½ å¯ä»¥è‡ªå®šä¹‰ä¸€ç§æˆæƒæ¨¡å¼è¿›è¡Œå®ç°, å› æ­¤çµæ´»æ€§ä¸Šæœ‰å¾ˆå¤§çš„ä¿è¯ã€‚</p>
<h4 id="æˆæƒç æ¨¡å¼"><a href="#æˆæƒç æ¨¡å¼" class="headerlink" title="æˆæƒç æ¨¡å¼"></a>æˆæƒç æ¨¡å¼</h4><p>æˆæƒç æ¨¡å¼(authorization code)æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†çš„æˆæƒæ¨¡å¼, ä¹Ÿæ˜¯å„å¤§å¼€æ”¾å¹³å°ä¸»è¦ä½¿ç”¨çš„æ¨¡å¼, å®ƒçš„ç‰¹ç‚¹å°±æ˜¯åœ¨clientä¸resource ownerç›´æ¥åŠ å…¥ä¸€å±‚æˆæƒæœåŠ¡(authorization server)ä½œä¸ºä¸­ä»‹, è§„é¿äº†resource ownerå’Œclientç›´æ¥äº¤äº’äº§ç”Ÿçš„å®‰å…¨éšæ‚£, è¯¥æ¨¡å¼å®Œç¾çš„è§£å†³äº†ä¹‹å‰æåˆ°çš„ä¼ ç»Ÿ<code>client-server</code>è®¤è¯æ¨¡å¼ä¸­çš„ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®èµ„äº§æ‰€æœ‰è€…æ•°æ®çš„éš¾é¢˜ã€‚</p>
<p>åº”ç”¨åœºæ™¯: ç¬¬ä¸‰æ–¹åº”ç”¨éœ€è¦è®¿é—®èµ„äº§æ‰€æœ‰è€…çš„æ•°æ®ã€‚å¹¶ä¸”ç¬¬ä¸‰æ–¹åº”ç”¨æœ‰è‡ªå·±çš„æœåŠ¡ç«¯, ä¹Ÿå°±æ˜¯å¸¸è§çš„<code>Server-Side Application</code><br>å…¸å‹åº”ç”¨: ç¬¬ä¸‰æ–¹ç™»å½•, æ¯”å¦‚ä¸Šé¢æåˆ°çš„åœºæ™¯<br>æµç¨‹å›¾:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">+----------+</div><div class="line">| Resource |</div><div class="line">|   Owner  |</div><div class="line">|          |</div><div class="line">+----------+</div><div class="line">     ^</div><div class="line">     |</div><div class="line">    (B)</div><div class="line">+----|-----+          Client Identifier      +---------------+</div><div class="line">|         -+----(A)-- &amp; Redirection URI ----&gt;|               |</div><div class="line">|  User-   |                                 | Authorization |</div><div class="line">|  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |</div><div class="line">|          |                                 |               |</div><div class="line">|         -+----(C)-- Authorization Code ---&lt;|               |</div><div class="line">+-|----|---+                                 +---------------+</div><div class="line">  |    |                                         ^      v</div><div class="line">(A)  (C)                                         |      |</div><div class="line">  |    |                                         |      |</div><div class="line">  ^    v                                         |      |</div><div class="line">+---------+                                      |      |</div><div class="line">|         |&gt;---(D)-- Authorization Code ---------&apos;      |</div><div class="line">|  Client |          &amp; Redirection URI                  |</div><div class="line">|         |                                             |</div><div class="line">|         |&lt;---(E)----- Access Token -------------------&apos;</div><div class="line">+---------+       (w/ Optional Refresh Token)</div></pre></td></tr></table></figure></p>
<p><strong>A. ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®æˆæƒæœåŠ¡å™¨, ä¸€èˆ¬æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨æ”¾ç½®é“¾æ¥, å°†ç”¨æˆ·å¼•å¯¼è‡³ç›¸åº”çš„æˆæƒæœåŠ¡å™¨</strong><br>æ¯”å¦‚ä»¥ä¸Šé¢æ‹‰å‹¾ä¸ºä¾‹, ä»–ä¼šæ”¾ç½®æœ‰å¯èƒ½å­˜å‚¨ç”¨æˆ·profileä¿¡æ¯çš„æˆæƒæœåŠ¡å™¨çš„è®¿é—®åœ°å€:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/oauth20/auth_sinaWeiboProvider.html"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">class</span>=<span class="string">"icon_wb"</span> <span class="attr">title</span>=<span class="string">"ä½¿ç”¨æ–°æµªå¾®åšå¸å·ç™»å½•"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/oauth20/auth_qqProvider.html"</span> <span class="attr">class</span>=<span class="string">"icon_qq"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">title</span>=<span class="string">"ä½¿ç”¨è…¾è®¯QQå¸å·ç™»å½•"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/oauth20/auth_weixinProvider.html"</span> <span class="attr">class</span>=<span class="string">"icon_weixin"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">title</span>=<span class="string">"ä½¿ç”¨å¾®ä¿¡å¸å·ç™»å½•"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>æ¯”å¦‚æˆ‘è®©æ‹‰å‹¾ç½‘è¯»å–æˆ‘å­˜å‚¨åœ¨å¾®åšä¸Šé¢çš„ç”¨æˆ·èµ„æ–™, å› æ­¤æˆ‘ä¼šè¢«å¼•å¯¼è‡³å¾®åšçš„æˆæƒæœåŠ¡,è¿›è¡Œæˆæƒ, åŒæ—¶æ‹‰å‹¾ç½‘ä¼šå¸¦ä¸Šè‡ªå·±åœ¨å¾®åšå¼€æ”¾å¹³å°æ³¨å†Œçš„å®¢æˆ·ç«¯ä¿¡æ¯, å¦‚ä¸‹å›¾:<br><img src="http://oiw1gzfww.bkt.clouddn.com/weibo_oaut2.png" alt=""><br>è€Œå…·ä½“çš„æˆæƒè¯·æ±‚æ ¼å¼å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz</div><div class="line">    &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1</div><div class="line">Host: server.example.com</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­çš„å‚æ•°:</p>
<ul>
<li>response_typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸ºâ€codeâ€</li>
<li>client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„IDï¼Œå¿…é€‰é¡¹</li>
<li>redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¯é€‰é¡¹</li>
<li>scopeï¼šè¡¨ç¤ºç”³è¯·çš„æƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</li>
<li>stateï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚</li>
</ul>
<p><strong>B. ç”¨æˆ·æˆæƒ</strong><br>ç°åœ¨æˆ‘å·²ç»åˆ°äº†å¾®è–„çš„æˆæƒæœåŠ¡é¡µé¢, éœ€è¦æˆ‘å¯¹æ‹‰å‹¾ç½‘è®¿é—®çš„ç›¸åº”æ•°æ®è¿›è¡Œæˆæƒ, å› æ­¤æˆ‘éœ€è¦ç™»å½•, ç„¶åè¿›è¡Œæˆæƒ:</p>
<ol>
<li>ç™»å½•<br><img src="http://oiw1gzfww.bkt.clouddn.com/weibo_login_oauth2.png" alt=""></li>
<li>æˆæƒ<br><img src="http://oiw1gzfww.bkt.clouddn.com/weibo_auth2.png" alt=""></li>
</ol>
<p>ç„¶åæˆ‘ç‚¹å‡»è¿æ¥(å…¶å®è¿™ä¸ªæŒ‰é’®æ”¹æˆæˆæƒæ¯”è¾ƒåˆé€‚, å…¶ä»–oauthå¯¹äºçš„è¿™é‡Œä¹ŸåŸºæœ¬éƒ½å«æˆæƒ), æ­¤æ—¶æˆ‘å®Œæˆäº†æˆ‘å¯¹æ‹‰å‹¾ç½‘å“åº”æƒé™çš„æˆæƒã€‚</p>
<p><strong>C. Authorization server å°†ç”¨æˆ·å¯¼å‘ç¬¬ä¸‰æ–¹åº”ç”¨(æ‹‰å‹¾ç½‘)ç«¯äº‹å…ˆæŒ‡å®šçš„â€é‡å®šå‘URIâ€(A æ­¥éª¤ä¸­ä¼ å…¥çš„redirection_uri),åŒæ—¶é™„ä¸Šä¸€ä¸ªæˆæƒç </strong><br><img src="http://oiw1gzfww.bkt.clouddn.com/oauth2_redirect.png" alt=""><br>ä»ä¸Šå›¾ä¸­çš„refererå¯ä»¥çœ‹å‡º, è·³è½¬æ˜¯æ¥è‡ªå¾®åšçš„æˆæƒæœåŠ¡å™¨çš„, å¹¶ä¸”<code>query string</code>æºå¸¦è¿™code</p>
<p>å…·ä½“æ ¼å¼å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 302 Found</div><div class="line">Location: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA</div><div class="line">          &amp;state=xyz</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­å‚æ•°:</p>
<ul>
<li>codeï¼šè¡¨ç¤ºæˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚è¯¥ç çš„æœ‰æ•ˆæœŸåº”è¯¥å¾ˆçŸ­ï¼Œé€šå¸¸è®¾ä¸º10åˆ†é’Ÿï¼Œå®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨è¯¥ç ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šè¢«æˆæƒæœåŠ¡å™¨æ‹’ç»ã€‚è¯¥ç ä¸å®¢æˆ·ç«¯IDå’Œé‡å®šå‘URIï¼Œæ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚</li>
<li>stateï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°ã€‚</li>
</ul>
<p><strong>D. ç¬¬ä¸‰æ–¹åº”ç”¨(æ‹‰å‹¾ç½‘)åƒAuthorization serverè¯·æ±‚token</strong><br>è¿™ä¸€æ­¥åœ¨æ‹‰å‹¾ç½‘çš„åå°æœåŠ¡å™¨è¿›è¡Œ, ä»ç•Œé¢ä¸Šæ˜¯çœ‹ä¸åˆ°, å…·ä½“è¿‡ç¨‹ä¸º: æ‹‰å‹¾ç½‘è·å–åˆ°codeè¿‡å, ä»¥codeå‘å¾®åšæ”¶å–æœåŠ¡å™¨è¯·æ±‚, æ¢å–å¯ä»¥è®¿é—®å¾®åšèµ„æºæœåŠ¡çš„token.<br>è¯·æ±‚çš„æ ·ä¾‹å¤§è‡´å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">POST /token HTTP/1.1</div><div class="line">Host: server.example.com</div><div class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</div><div class="line">Content-Type: application/x-www-form-urlencoded</div><div class="line"></div><div class="line">grant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA</div><div class="line">&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­å‚æ•°:</p>
<ul>
<li>grant_typeï¼šè¡¨ç¤ºä½¿ç”¨çš„æˆæƒæ¨¡å¼ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸ºâ€<code>authorization_code</code>â€œã€‚</li>
<li>codeï¼šè¡¨ç¤ºä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚</li>
<li>redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¿…é€‰é¡¹ï¼Œä¸”å¿…é¡»ä¸Aæ­¥éª¤ä¸­çš„è¯¥å‚æ•°å€¼ä¿æŒä¸€è‡´ã€‚</li>
<li>client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯IDï¼Œå¿…é€‰é¡¹ã€‚</li>
</ul>
<p><strong>E. Authorization serveréªŒè¯codeåˆæ³•è¿‡åè¿”å›token</strong><br>è¿”å›çš„tokenæ•°æ®æ ·ä¾‹å¤§è‡´å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Type: application/json;charset=UTF-8</div><div class="line">Cache-Control: no-store</div><div class="line">Pragma: no-cache</div><div class="line"></div><div class="line">&#123;</div><div class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</div><div class="line">  &quot;token_type&quot;:&quot;example&quot;,</div><div class="line">  &quot;expires_in&quot;:3600,</div><div class="line">  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,</div><div class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­å‚æ•°:</p>
<ul>
<li>access_tokenï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚</li>
<li>token_typeï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ï¼Œå¯ä»¥æ˜¯bearerç±»å‹æˆ–macç±»å‹ã€‚</li>
<li>expires_inï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li>
<li>refresh_tokenï¼šè¡¨ç¤ºæ›´æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œï¼Œå¯é€‰é¡¹ã€‚</li>
<li>scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚</li>
</ul>
<h4 id="ç®€åŒ–æ¨¡å¼"><a href="#ç®€åŒ–æ¨¡å¼" class="headerlink" title="ç®€åŒ–æ¨¡å¼"></a>ç®€åŒ–æ¨¡å¼</h4><p>é‡‡ç”¨Implicit Grantæ–¹å¼è·å–Access Tokençš„æˆæƒéªŒè¯æµç¨‹åˆè¢«ç§°ä¸ºUser-Agent Flow, å®ƒä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†â€æˆæƒç â€è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚</p>
<p>åº”ç”¨åœºæ™¯: é€‚ç”¨äºæ‰€æœ‰æ— Serverç«¯é…åˆçš„åº”ç”¨(ç”±äºåº”ç”¨å¾€å¾€ä½äºä¸€ä¸ªUser Agenté‡Œï¼Œå¦‚æµè§ˆå™¨é‡Œé¢ï¼Œå› æ­¤è¿™ç±»åº”ç”¨åœ¨æŸäº›å¹³å°ä¸‹åˆè¢«ç§°ä¸º<code>Client-Side Application</code>), å¦‚æ‰‹æœº/æ¡Œé¢å®¢æˆ·ç«¯ç¨‹åºã€æµè§ˆå™¨æ’ä»¶ç­‰ï¼Œä»¥åŠåŸºäºJavaScriptç­‰è„šæœ¬å®¢æˆ·ç«¯è„šæœ¬è¯­è¨€å®ç°çš„åº”ç”¨ï¼Œä»–ä»¬çš„ä¸€ä¸ªå…±åŒç‰¹ç‚¹æ˜¯ï¼Œæ— æœåŠ¡ç«¯,æ— æ³•ç›‘å¬ç«¯å£ç›´æ¥æ”¶åˆ°å›è°ƒtoken, å¹¶ä¸”åº”ç”¨æ— æ³•å¦¥å–„ä¿ç®¡å…¶åº”ç”¨å¯†é’¥(App Secret Key), å¦‚æœé‡‡å–Authorization Codeæ¨¡å¼ï¼Œåˆ™ä¼šå­˜åœ¨æ³„æ¼å…¶åº”ç”¨å¯†é’¥(api_scret)çš„å¯èƒ½æ€§<br>å…¸å‹åº”ç”¨: æš‚æ—¶æ²¡çœ‹åˆ°ç›¸å…³åº”ç”¨ä½¿ç”¨è¯¥æ¨¡å¼<br>æµç¨‹å›¾:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">+----------+</div><div class="line">| Resource |</div><div class="line">|  Owner   |</div><div class="line">|          |</div><div class="line">+----------+</div><div class="line">    ^</div><div class="line">    |</div><div class="line">    (B)</div><div class="line">+----|-----+          Client Identifier     +---------------+</div><div class="line">|         -+----(A)-- &amp; Redirection URI ---&gt;|               |</div><div class="line">|  User-   |                                | Authorization |</div><div class="line">|  Agent  -|----(B)-- User authenticates --&gt;|     Server    |</div><div class="line">|          |                                |               |</div><div class="line">|          |&lt;---(C)--- Redirection URI ----&lt;|               |</div><div class="line">|          |          with Access Token     +---------------+</div><div class="line">|          |            in Fragment</div><div class="line">|          |                                +---------------+</div><div class="line">|          |----(D)--- Redirection URI ----&gt;|   Web-Hosted  |</div><div class="line">|          |          without Fragment      |     Client    |</div><div class="line">|          |                                |    Resource   |</div><div class="line">|     (F)  |&lt;---(E)------- Script ---------&lt;|               |</div><div class="line">|          |                                +---------------+</div><div class="line">+-|--------+</div><div class="line">  |    |</div><div class="line">(A)  (G) Access Token</div><div class="line">  |    |</div><div class="line">  ^    v</div><div class="line">+---------+</div><div class="line">|         |</div><div class="line">|  Client |</div><div class="line">|         |</div><div class="line">+---------+</div></pre></td></tr></table></figure></p>
<p><strong>A. å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨</strong><br>å’Œä¹‹å‰çš„auth codeæ¨¡å¼æ¯”èµ·æ¥, ä»…ä»…æ˜¯response_typeå˜æˆäº†token, å…¶ä»–è¿‡ç¨‹ä¸å˜ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">GET /authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz</div><div class="line">    &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1</div><div class="line">Host: server.example.com</div></pre></td></tr></table></figure></p>
<p><strong>B. ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒ</strong><br>è¿™éƒ¨åˆ†åŒauth codeæ¨¡å¼ä¸€æ ·</p>
<p><strong>C. å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„â€é‡å®šå‘URIâ€ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œ</strong><br>è¿™é‡Œæœ€å¤§çš„åŒºåˆ«å°±æ˜¯: ç›´æ¥è¿”å›token, è€Œä¸æ˜¯code.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 302 Found</div><div class="line">Location: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA</div><div class="line">          &amp;state=xyz&amp;token_type=example&amp;expires_in=3600</div></pre></td></tr></table></figure></p>
<p>æ³¨æ„è¿™é‡Œçš„è¿™ä¸ªå›è°ƒåœ°å€, åœ¨æˆæƒç æ¨¡å¼ä¸‹ è¯¥åœ°å€ä»¥åŠquery stringéƒ½æ˜¯éœ€è¦æœåŠ¡ç«¯å¤„ç†çš„, ä½†æ˜¯åœ¨ç®€åŒ–æ¨¡å¼ä¸‹, æ˜¯æ²¡æœ‰æœåŠ¡ç«¯ç¨‹åºå‚åŠ çš„, å› æ­¤ç®€åŒ–æ¨¡å¼ä¸‹è¯¥callback urlä»…ä»…æ˜¯ä¸€ä¸ªé™æ€é¡µé¢åœ°å€.<br>å› æ­¤åœ¨ç®€åŒ–æ¨¡å¼ä¸‹, éœ€è¦é€šè¿‡æµè§ˆå™¨è·å–åˆ°callback urlä¸­çš„å‚æ•°, è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ¥ä¸‹æ¥2æ­¥çš„åŸå› ã€‚</p>
<p><strong>D. æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚</strong><br>æµè§ˆå™¨å‘Web-Hostedè¯·æ±‚è·å–tokençš„è„šæœ¬ä»£ç </p>
<p><strong>E. èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚</strong><br>Web-Hostedè¿”å›ç»™æµè§ˆå™¨(user-agent)ä¸€æ®µæå‰access tokençš„è„šæœ¬</p>
<p><strong>F.æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚</strong><br>æµè§ˆå™¨æ‰§è¡Œè¯¥è„šæœ¬, æå–å‡ºaccess token</p>
<p>æ³¨æ„åœ¨è¯¥æ¨¡å¼çš„å®ç°è¿‡ç¨‹ä¸­, Då’ŒEæ­¥ä¸€èˆ¬éƒ½ä¼šçœç•¥æ‰, å› ä¸ºWeb-Hosted Client Resourceæä¾›çš„è¿™æ®µtokenæå–è„šæœ¬, å®¢æˆ·ç«¯å¯ä»¥è‡ªå·±å®ç°:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt; </div><div class="line">    function callback(user) </div><div class="line">    &#123;</div><div class="line">      var userName = document.getElementById('userName');</div><div class="line">      var greetingText = document.createTextNode('Greetings, '+ user.openid + '.');</div><div class="line">      userName.appendChild(greetingText);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //åº”ç”¨çš„APPIDï¼Œè¯·æ”¹ä¸ºä½ è‡ªå·±çš„</div><div class="line">    var appID = "YOUR_APP_ID";</div><div class="line">    //æˆåŠŸæˆæƒåçš„å›è°ƒåœ°å€ï¼Œè¯·æ”¹ä¸ºä½ è‡ªå·±çš„</div><div class="line">    var redirectURI = "http://qzs.qq.com/qzone/openapi/success.html";</div><div class="line"></div><div class="line">    //æ„é€ è¯·æ±‚</div><div class="line">    if (window.location.hash.length == 0) </div><div class="line">    &#123;</div><div class="line">      var path = 'https://graph.qq.com/oauth2.0/authorize?';</div><div class="line">      var queryParams = ['client_id=' + appID,'redirect_uri=' + redirectURI,'</div><div class="line">      scope=' + 'get_user_info,list_album,upload_pic,add_feeds,do_like','response_type=token'];</div><div class="line"></div><div class="line">      var query = queryParams.join('&amp;');</div><div class="line">      var url = path + query;</div><div class="line">      window.open(url);</div><div class="line">    &#125;</div><div class="line">    else </div><div class="line">    &#123;</div><div class="line">      //è·å–access token(ç›´æ¥è·å–urlå‚æ•°é‡Œé¢çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯access token)</div><div class="line">      var accessToken = window.location.hash.substring(1);</div><div class="line">      //ä½¿ç”¨Access Tokenæ¥è·å–ç”¨æˆ·çš„OpenID</div><div class="line">      var path = "https://graph.qq.com/oauth2.0/me?";</div><div class="line">      var queryParams = [accessToken, 'callback=callback'];</div><div class="line">      var query = queryParams.join('&amp;');</div><div class="line">      var url = path + query;</div><div class="line">      var script = document.createElement('script');</div><div class="line">      script.src = url;</div><div class="line">      document.body.appendChild(script);        </div><div class="line">    &#125;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<p><strong>G.æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯</strong><br>æµè§ˆå™¨å°†access tokenäº¤ç»™å®¢æˆ·ç«¯, å…¸å‹çš„åŠæ³•å°±æ˜¯å°†tokenå­˜å…¥æµè§ˆå™¨, ç­‰å¾…clientè·å–ã€‚</p>
<h4 id="å¯†ç æ¨¡å¼"><a href="#å¯†ç æ¨¡å¼" class="headerlink" title="å¯†ç æ¨¡å¼"></a>å¯†ç æ¨¡å¼</h4><p>å¯†ç æ¨¡å¼(Resource Owner Password Credentials Grant)ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯(ç¬¬ä¸‰æ–¹åº”ç”¨)ç›´æ¥æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯, å‘â€æœåŠ¡å•†æä¾›å•†â€ç´¢è¦æˆæƒã€‚<br>åœ¨è¿™ç§æ¨¡å¼ä¸­, ç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯(ç¬¬ä¸‰æ–¹åº”ç”¨)é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªè‘—åå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚</p>
<p>åº”ç”¨åœºæ™¯: ç¬¬è¯¥åº”ç”¨ç»å¯¹ä¿¡ä»»<br>å…¸å‹åº”ç”¨: åº”ç”¨ç¨‹åºè‡ªå·±çš„dashboardç¨‹åº<br>æµç¨‹å›¾:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">+----------+</div><div class="line">| Resource |</div><div class="line">|  Owner   |</div><div class="line">|          |</div><div class="line">+----------+</div><div class="line">    v</div><div class="line">    |    Resource Owner</div><div class="line">    (A) Password Credentials</div><div class="line">    |</div><div class="line">    v</div><div class="line">+---------+                                  +---------------+</div><div class="line">|         |&gt;--(B)---- Resource Owner -------&gt;|               |</div><div class="line">|         |         Password Credentials     | Authorization |</div><div class="line">| Client  |                                  |     Server    |</div><div class="line">|         |&lt;--(C)---- Access Token ---------&lt;|               |</div><div class="line">|         |    (w/ Optional Refresh Token)   |               |</div><div class="line">+---------+                                  +---------------+</div></pre></td></tr></table></figure></p>
<p><strong>A. ç”¨æˆ·å‘ç¬¬ä¸‰æ–¹åº”ç”¨æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç </strong><br>ç”¨æˆ·å°†è‡ªå·±çš„å¯†ç ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚</p>
<p><strong>B. ç¬¬ä¸‰æ–¹åº”ç”¨å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œ</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">POST /token HTTP/1.1</div><div class="line">Host: server.example.com</div><div class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</div><div class="line">Content-Type: application/x-www-form-urlencoded</div><div class="line"></div><div class="line">grant_type=password&amp;username=johndoe&amp;password=A3ddj3w</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­å‚æ•°:</p>
<ul>
<li>grant_type: è¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸ºâ€passwordâ€ï¼Œå¿…é€‰é¡¹ã€‚</li>
<li>username: è¡¨ç¤ºç”¨æˆ·åï¼Œå¿…é€‰é¡¹ã€‚</li>
<li>password: è¡¨ç¤ºç”¨æˆ·çš„å¯†ç ï¼Œå¿…é€‰é¡¹ã€‚</li>
<li>scope: è¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ã€‚</li>
</ul>
<p><strong>C. è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œ</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Type: application/json;charset=UTF-8</div><div class="line">Cache-Control: no-store</div><div class="line">Pragma: no-cache</div><div class="line"></div><div class="line">&#123;</div><div class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</div><div class="line">  &quot;token_type&quot;:&quot;example&quot;,</div><div class="line">  &quot;expires_in&quot;:3600,</div><div class="line">  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,</div><div class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­å‚æ•°:</p>
<ul>
<li>access_tokenï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚</li>
<li>token_typeï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ï¼Œå¯ä»¥æ˜¯bearerç±»å‹æˆ–macç±»å‹ã€‚</li>
<li>expires_inï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li>
<li>refresh_tokenï¼šè¡¨ç¤ºæ›´æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œï¼Œå¯é€‰é¡¹ã€‚</li>
<li>scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚</li>
</ul>
<h4 id="å®¢æˆ·ç«¯æ¨¡å¼"><a href="#å®¢æˆ·ç«¯æ¨¡å¼" class="headerlink" title="å®¢æˆ·ç«¯æ¨¡å¼"></a>å®¢æˆ·ç«¯æ¨¡å¼</h4><p>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘â€æœåŠ¡æä¾›å•†â€è¿›è¡Œè®¤è¯ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚â€æœåŠ¡æä¾›å•†â€æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚</p>
<p>åº”ç”¨åœºæ™¯: <br>å…¸å‹åº”ç”¨: å†…éƒ¨æœåŠ¡, Resource Server A å’Œ Resource Server B çš„è®¿é—®é—®é¢˜ã€‚<br>æµç¨‹å›¾:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">+---------+                                  +---------------+</div><div class="line">|         |                                  |               |</div><div class="line">|         |&gt;--(A)- Client Authentication ---&gt;| Authorization |</div><div class="line">| Client  |                                  |     Server    |</div><div class="line">|         |&lt;--(B)---- Access Token ---------&lt;|               |</div><div class="line">|         |                                  |               |</div><div class="line">+---------+                                  +---------------+</div></pre></td></tr></table></figure></p>
<p><strong>A. å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚</strong><br>å®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨clientå‡­è¯è·å–tokne<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">POST /token HTTP/1.1</div><div class="line">Host: server.example.com</div><div class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</div><div class="line">Content-Type: application/x-www-form-urlencoded</div><div class="line"></div><div class="line">grant_type=client_credentials</div></pre></td></tr></table></figure></p>
<p><strong>B. è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚</strong><br>æˆæƒæœåŠ¡ç›´æ¥è¿”å›token<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Type: application/json;charset=UTF-8</div><div class="line">Cache-Control: no-store</div><div class="line">Pragma: no-cache</div><div class="line"></div><div class="line">&#123;</div><div class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</div><div class="line">  &quot;token_type&quot;:&quot;example&quot;,</div><div class="line">  &quot;expires_in&quot;:3600,</div><div class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="http://wiki.open.qq.com/wiki/website/%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5_Client-side" target="_blank" rel="external">è…¾è®¯å¼€å‘å¹³å°-å¼€å‘æ”»ç•¥_Client-side</a></li>
<li><a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="external">OAuth2.0 RFCæ–‡æ¡£</a></li>
<li><a href="https://tools.ietf.org/html/rfc7636#ref-BCP195" target="_blank" rel="external">PKCE æ‰©å±•RFCæ–‡æ¡£</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å½“ä»Šäº’è”ç½‘çš„åŠŸèƒ½å¯è°“æ˜¯äº”èŠ±å…«é—¨, è€Œå¾ˆå¤šæœåŠ¡éœ€è¦ä¾èµ–ç”¨æˆ·å·²æœ‰çš„æ•°æ®æ‰èƒ½æä¾›æœåŠ¡, æ¯”å¦‚äº‘å†²å°, éœ€è¦è®¿é—®ç”¨æˆ·äº‘ç›˜é‡Œé¢çš„ç…§ç‰‡æ•°æ®, å†æ¯”å¦‚ciæœåŠ¡, éœ€è¦è®¿é—®ç”¨æˆ·ä»£ç ä»“åº“é‡Œé¢çš„é¡¹ç›®æ•°æ®ã€‚å¦‚ä½•å®‰å…¨å¾—å°†ç”¨æˆ·çš„æ•°æ®æš´éœ²ç»™ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚, è€ŒOAuthçš„å‡ºç°å°±æ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="åè®®è¯¦è§£" scheme="https://blog.yumaojun.net/categories/%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"/>
    
      <category term="OAUTH2" scheme="https://blog.yumaojun.net/categories/%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/OAUTH2/"/>
    
    
      <category term="oauth2" scheme="https://blog.yumaojun.net/tags/oauth2/"/>
    
  </entry>
  
  <entry>
    <title>Golangæ—¥å¿—ä¹‹logrusçš„ä½¿ç”¨</title>
    <link href="https://blog.yumaojun.net/2017/11/27/golang-log/"/>
    <id>https://blog.yumaojun.net/2017/11/27/golang-log/</id>
    <published>2017-11-27T05:04:55.000Z</published>
    <updated>2017-12-06T09:35:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºæ ‡å‡†åº“çš„æ—¥å¿—åº“ç¼ºå°‘Log Level, å¦‚æœåŸºäºæ ‡å‡†åº“æ‰©å±•è‡ªå·±çš„loggerä¹Ÿéœ€è¦èŠ±ä¸€ç‚¹æ—¶é—´, çœ‹githubçš„ä¸Šå¾ˆå¤šå¼€æºé¡¹ç›®éƒ½ä½¿ç”¨ä¸€ä¸ªå«logrusçš„æ¨¡å—, äºæ˜¯ç ”ç©¶äº†ä¸‹, å‘ç°å®ƒå…·æœ‰é«˜åº¦çš„çµæ´»æ€§, è€Œä¸”å·²ç»æœ‰å¾ˆå¤šå†™å¥½äº†çš„æ’ä»¶, æ¯”å¦‚å’Œlogstachå¯¹æ¥çš„æ’ä»¶,æ‰€ä»¥é¡¹ç›®åé¢å°±åˆ‡æ¢æ—¥å¿—æ¨¡å—ä¸ºlogrus, è¿™ç¯‡åšå®¢å°±æ˜¯ä»‹ç»æˆ‘ä»¬ä½¿ç”¨logrusæ—¶é‡åˆ°çš„å‘, ä»¥åŠä¸€äº›è§£å†³ä¹‹é“ã€‚<br><a id="more"></a></p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><a href="https://github.com/sirupsen/logrus" target="_blank" rel="external">logrus</a>åœ¨githubä¸Šç›¸å½“å—æ¬¢è¿, æˆªæ­¢ç›®å‰ä¸ºæ­¢å·²ç»6k+çš„staräº†, åœ¨å¾ˆå¤šå¼€æºé¡¹ç›®ä¸­è¢«ä½¿ç”¨, æ¯”å¦‚docker, prometheusç­‰ä½¿ç”¨è¯¥åº“è¿›è¡Œæ—¥å¿—è®°å½•.<br>å®˜æ–¹å£°ç§°APIå®Œå…¨å…¼å®¹æ ‡å‡†åŒ…logger, é¡¹ç›®åœ°å€: <a href="https://github.com/sirupsen/logrus" target="_blank" rel="external">logrus github åœ°å€</a>, å› æ­¤å¦‚æœä½ ä¹‹å‰é¡¹ç›®ä½¿ç”¨çš„æ ‡å‡†åº“é‚£ä¹ˆå¯ä»¥æ— ç¼è¿ç§».<br>logrusæ˜¯ä¸€ä¸ªç»“æ„åŒ–çš„ã€å¯æ’æ‹”çš„æ—¥å¿—è®°å½•å™¨, ä½ å¯ä»¥é€šè¿‡æ’ä»¶å°†ä½ çš„æ—¥å¿—å‘å¾€ä»»æ„åœ°æ–¹, æ¯”å¦‚æ–‡ä»¶, æ ‡å‡†è¾“å‡º, logstash, influxdb, â€¦ã€‚è¿™æ­£å¼å®ƒæœ€å¸å¼•äººçš„åœ°æ–¹ã€‚</p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>logrusæœ‰6ä¸ªæ—¥å¿—ç­‰çº§, åˆ†åˆ«ä¸º: Debug,Info,Warn,Error,Fatal,Panic, ç»è¿‡ç®€å•çš„é…ç½®å°±å¯ä»¥ä½¿ç”¨äº†ã€‚<br>logrusæœ‰2ç§formater, åˆ†åˆ«æ˜¯: JSONFormatter, TextFormatter, å½“ç„¶å¦‚æœä½ è§‰å¾—éƒ½ä¸æ˜¯ä½ æƒ³è¦çš„, å¯ä»¥é€šè¿‡å®ç°Formatteræ¥å£å®šåˆ¶è‡ªå·±çš„formater</p>
<h3 id="åŸºç¡€ä½¿ç”¨"><a href="#åŸºç¡€ä½¿ç”¨" class="headerlink" title="åŸºç¡€ä½¿ç”¨"></a>åŸºç¡€ä½¿ç”¨</h3><p>å½“åˆå§‹åŒ–å¥½logruså, å¯ä»¥ç›´æ¥è°ƒç”¨Debugç­‰è¿›è¡Œæ—¥å¿—è®°å½•ã€‚<br>WithFieldsæ˜¯ä¸€ä¸ªå¾ˆå¥½ç”¨çš„åŠŸèƒ½, å®ƒç”¨äºè®°å½•ä½ è¿™æ¡messageçš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯, æ¯”å¦‚ä½ å¯ä»¥è®°å½•æ˜¯æœ‰é‚£ä¸ªè®¿é—®è§¦å‘çš„(request_id)</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"github.com/sirupsen/logrus"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	logrus.WithFields(logrus.Fields&#123;<span class="string">"animal"</span>: <span class="string">"walrus"</span>,<span class="string">"size"</span>: <span class="number">10</span>&#125;).Info(<span class="string">"A group of walrus emerges from the ocean"</span>)</div><div class="line">	logrus.WithFields(logrus.Fields&#123;<span class="string">"request_id"</span>: <span class="string">"requestA"</span>&#125;).Warn(<span class="string">"The group's number increased tremendously!"</span>)</div><div class="line">	logrus.WithFields(logrus.Fields&#123;<span class="string">"request_id"</span>: <span class="string">"requestB"</span>&#125;).Fatal(<span class="string">"The ice breaks!"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// ä»¥JSONæ ¼å¼ä¸ºè¾“å‡ºï¼Œä»£æ›¿é»˜è®¤çš„ASCIIæ ¼å¼</span></div><div class="line">	logrus.SetFormatter(&amp;logrus.JSONFormatter&#123;&#125;)</div><div class="line">	<span class="comment">// ä»¥Stdoutä¸ºè¾“å‡ºï¼Œä»£æ›¿é»˜è®¤çš„stderr</span></div><div class="line">	logrus.SetOutput(os.Stdout)</div><div class="line">	<span class="comment">// è®¾ç½®æ—¥å¿—ç­‰çº§</span></div><div class="line">	logrus.SetLevel(logrus.WarnLevel)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨Logger"><a href="#ä½¿ç”¨Logger" class="headerlink" title="ä½¿ç”¨Logger"></a>ä½¿ç”¨Logger</h3><p>loggeræ˜¯ä¸€ç§ç›¸å¯¹é«˜çº§çš„ç”¨æ³•, å¯¹äºä¸€ä¸ªå¤§å‹é¡¹ç›®, å¾€å¾€éœ€è¦ä¸€ä¸ªå…¨å±€çš„loggerå¯¹è±¡, ç”¨äºè®°å½•é¡¹ç›®æ‰€æœ‰çš„æ—¥å¿—</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">logger := logrus.New()</div><div class="line">logger.Formatter = &amp;logrus.JSONFormatter&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// Use logrus for standard log output</span></div><div class="line"><span class="comment">// Note that `log` here references stdlib's log</span></div><div class="line"><span class="comment">// Not logrus imported under the name `log`.</span></div><div class="line">log.SetOutput(logger.Writer())</div></pre></td></tr></table></figure>
<h3 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h3><p>å®˜æ–¹æœ‰å¾ˆå¤šç°æˆçš„Hook, å¯ä»¥å®ç° è®°å½•æ—¥å¿—åˆ°æ–‡ä»¶(æ—¥å¿—æ–‡ä»¶è½®è½¬), è®°å½•åˆ°kafka, è®°å½•åˆ°influxDB, è®°å½•åˆ°MySQLâ€¦</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> (</div><div class="line">  log <span class="string">"github.com/sirupsen/logrus"</span></div><div class="line">  <span class="string">"gopkg.in/gemnasium/logrus-airbrake-hook.v2"</span> <span class="comment">// the package is named "aibrake"</span></div><div class="line">  logrus_syslog <span class="string">"github.com/sirupsen/logrus/hooks/syslog"</span></div><div class="line">  <span class="string">"log/syslog"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line"></div><div class="line">  <span class="comment">// Use the Airbrake hook to report errors that have Error severity or above to</span></div><div class="line">  <span class="comment">// an exception tracker. You can create custom hooks, see the Hooks section.</span></div><div class="line">  log.AddHook(airbrake.NewHook(<span class="number">123</span>, <span class="string">"xyz"</span>, <span class="string">"production"</span>))</div><div class="line"></div><div class="line">  hook, err := logrus_syslog.NewSyslogHook(<span class="string">"udp"</span>, <span class="string">"localhost:514"</span>, syslog.LOG_INFO, <span class="string">""</span>)</div><div class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">    log.Error(<span class="string">"Unable to connect to local syslog daemon"</span>)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    log.AddHook(hook)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä¸‹é¢è¿™ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬é‡åˆ°çš„æœ€éƒé—·çš„é—®é¢˜, å› ä¸ºå°±è¿æ ‡å‡†åº“éƒ½å·²ç»å®ç°çš„åŠŸèƒ½,æ²¡æƒ³åˆ°logrusä¼šä¸æä¾›ã€‚</p>
<h3 id="ä¸è®°å½•æ–‡ä»¶åå’Œè¡Œå·"><a href="#ä¸è®°å½•æ–‡ä»¶åå’Œè¡Œå·" class="headerlink" title="ä¸è®°å½•æ–‡ä»¶åå’Œè¡Œå·"></a>ä¸è®°å½•æ–‡ä»¶åå’Œè¡Œå·</h3><p>ä½¿ç”¨logrusæœ‰ä¸€ä¸ªå¾ˆè¦å‘½çš„é—®é¢˜: ä¸ä¼šè®°å½•æ—¥å¿—æ‰“å°çš„è¡Œå·å’Œæ–‡ä»¶å, è¿™åœ¨æ’é”™æ—¶ä¼šæ˜¾å¾—å¾ˆä¸æ–¹ä¾¿, è€Œgithubä¸Šå…³äº<a href="https://github.com/sirupsen/logrus/issues/63" target="_blank" rel="external">log filename and line number</a>çš„issueå·²ç»æŒ‚äº†3å¹´äº†, å¤§å®¶è§£å†³çš„åŠæ³•å¤§è‡´ä¸º2ç±»:</p>
<ul>
<li><p>è‡ªå·±å†™hookæ¥è®°å½•</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ContextHook <span class="keyword">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(hook ContextHook)</span> <span class="title">Levels</span><span class="params">()</span> []<span class="title">log</span>.<span class="title">Level</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> log.AllLevels</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(hook ContextHook)</span> <span class="title">Fire</span><span class="params">(entry *log.Entry)</span> <span class="title">error</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> pc, file, line, ok := runtime.Caller(<span class="number">8</span>); ok &#123;</div><div class="line">        funcName := runtime.FuncForPC(pc).Name()</div><div class="line"></div><div class="line">        entry.Data[<span class="string">"file"</span>] = path.Base(file)</div><div class="line">        entry.Data[<span class="string">"func"</span>] = path.Base(funcName)</div><div class="line">        entry.Data[<span class="string">"line"</span>] = line</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    log.AddHook(ContextHook&#123;&#125;)</div><div class="line">        â€¦</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡è£…é¥°å™¨æ¨¡å¼æ¥åŒ…è£…ä¸€å±‚</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> logger</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"runtime"</span></div><div class="line">	<span class="string">"strings"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/Sirupsen/logrus"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">/* truncated */</span></div><div class="line"></div><div class="line"><span class="comment">// Decorate appends line, file and function context to the logger and returns a function to call before</span></div><div class="line"><span class="comment">// each log</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Decorate</span><span class="params">(logger *logrus.Entry)</span> <span class="title">func</span><span class="params">()</span> *<span class="title">logrus</span>.<span class="title">Entry</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> *<span class="title">logrus</span>.<span class="title">Entry</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> pc, f, line, ok := runtime.Caller(<span class="number">1</span>); ok &#123;</div><div class="line">			fnName := runtime.FuncForPC(pc).Name()</div><div class="line">			file := strings.Split(f, <span class="string">"mobilebid"</span>)[<span class="number">1</span>]</div><div class="line">			caller := fmt.Sprintf(<span class="string">"%s:%v %s"</span>, file, line, fnName)</div><div class="line"></div><div class="line">			<span class="keyword">return</span> logrus.WithField(<span class="string">"caller"</span>, caller)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> logger</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Log appends line, file and function context to the logger</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Log</span><span class="params">()</span> *<span class="title">logrus</span>.<span class="title">Entry</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> pc, f, line, ok := runtime.Caller(<span class="number">1</span>); ok &#123;</div><div class="line">		fnName := runtime.FuncForPC(pc).Name()</div><div class="line">		file := strings.Split(f, <span class="string">"mobilebid"</span>)[<span class="number">1</span>]</div><div class="line">		caller := fmt.Sprintf(<span class="string">"%s:%v %s"</span>, file, line, fnName)</div><div class="line"></div><div class="line">		<span class="keyword">return</span> logrus.WithField(<span class="string">"caller"</span>, caller)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;logrus.Entry&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>ä¸ªäººåå‘äºè‡ªå·±å®ç°ä¸€ä¸ªhookçš„å¤„ç†æ–¹å¼, è¿™ä¹Ÿæ˜¯ä½œè€…æ¯”è¾ƒè®¤å¯çš„ä¸€ç§æ–¹å¼, ä½œè€…åŸè¯æ˜¯è¿™æ ·è¯´çš„<code>Yes, unless someone can prove a negligible performance impact I think this should be a hook.</code>,  å› æ­¤æˆ‘æµ‹è¯•äº†ä¸Šé¢é‚£æ®µè‡ªå·±å®ç°ContextHookçš„ä»£ç , å¾ˆé—æ†¾, å±…ç„¶æ²¡æˆåŠŸ, å› æ­¤ä¸å¾—ä¸è‡ªå·±å†™ä¸€ä¸ªContextHook, é¡ºä¾¿äº†è§£ä¸‹è·å–filenameå’Œline numberçš„åŸç†ã€‚</p>
<h3 id="è·å–æ–‡ä»¶åå’Œè¡Œå·çš„åŸç†"><a href="#è·å–æ–‡ä»¶åå’Œè¡Œå·çš„åŸç†" class="headerlink" title="è·å–æ–‡ä»¶åå’Œè¡Œå·çš„åŸç†"></a>è·å–æ–‡ä»¶åå’Œè¡Œå·çš„åŸç†</h3><p>åœ¨runtimeé‡Œé¢æœ‰ä¸€ä¸ªcallerå‡½æ•°, æºç é‡Œé¢æ˜¯è¿™æ ·æè¿°callerçš„:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Caller reports file and line number information about function invocations on the calling goroutine&apos;s stack. </div><div class="line">The argument skip is the number of stack frames to ascend, with 0 identifying the caller of Caller.  </div><div class="line">(For historical reasons the meaning of skip differs between Caller and Callers.) </div><div class="line">The return values report the program counter, file name, and line number within the file of the corresponding call. </div><div class="line">The boolean ok is false if it was not possible to recover the information.</div></pre></td></tr></table></figure></p>
<p>ç®€è€Œè¨€ä¹‹, æˆ‘ä»¬é€šè¿‡callerå¯ä»¥è¿½è¸ªæ¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨çš„æ–‡ä»¶å’Œè¡Œå·ä¿¡æ¯, ä½†æ˜¯æˆ‘ä»¬çš„å‡½æ•°è°ƒç”¨é“¾å¾€å¾€æœ‰æ·±, è€Œæˆ‘ä»¬éœ€è¦çš„ä»…ä»…æ˜¯è®°å½•æ—¥å¿—æ—¶çš„é‚£ä¸€å±‚çš„å‡½æ•°è°ƒç”¨ä¿¡æ¯ã€‚å¦‚ä½•æ‰¾åˆ°è¿™ä¸€å±‚å–ƒ?<br>æˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸€å±‚éƒ½æ‰“å°å‡ºæ¥, çœ‹çœ‹æœ‰å•¥è§„å¾‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 98</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 134</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/logger.go: 181</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/cmd/openauth/cmd/service.go: 55</div><div class="line">...</div><div class="line"></div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 98</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 134</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 182</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/logger.go: 118</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/api/http/handler/init.go: 42</div><div class="line">...</div><div class="line"></div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 98</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 144</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/logger.go: 189</div><div class="line">/Users/maojun/GoWorkDir/src/openauth/api/http/server.go: 71</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå‰é¢å‡ æ¬¡è°ƒç”¨é“¾, éƒ½è¢«logrusè‡ªå·±ä½¿ç”¨äº†, å› æ­¤æˆ‘ä»¬ä»…éœ€è¦é™¤å»logrusè°ƒç”¨é“¾çš„å‡½æ•°, ç„¶åç¬¬ä¸€ä¸ªè¢«æ‰¾åˆ°çš„å°±æ˜¯æˆ‘ä»¬è®°å½•æ—¥å¿—çš„è°ƒç”¨äº†, æ¯”å¦‚æœ€åä¸€ä¸ª: http/server.go: 71, æˆ‘åœ¨è¿™é‡Œè°ƒç”¨logrus: logger.Debug(â€œmsgâ€)</p>
<p>é‚£ä¹ˆlogrusçš„è°ƒç”¨é“¾æœ€å¤šæœ‰å‡ å±‚å–ƒï¼Ÿæˆ‘ä»¬æ‰§è¡Œå¤šå°‘æ¬¡é€’å½’æ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬è‡ªå·±çš„debug callï¼Ÿ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cmd/service.go: 55 [logger.Debug()] ---&gt; logrus/logger.go: 181 [entry.Debug()] ---&gt; logrus/entry.go: 134 [entry.log()] ---&gt; logrus/entry.go: 98 [entry.Logger.Hooks.Fire()]</div><div class="line">handler/init.go: 42 [logger.Debugf()] ---&gt; logrus/logger.go: 118 [entry.Debug()]  ---&gt; logrus/entry.go: 182 [logger.releaseEntry()] ---&gt; logrus/entry.go: 134 [entry.log()] ---&gt; logrus/entry.go: 98 [entry.Logger.Hooks.Fire()]</div></pre></td></tr></table></figure></p>
<p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå½“æˆ‘ä»¬ä½¿ç”¨(Debug, Debugf, Debugln), åº•å±‚è°ƒç”¨é“¾çš„é•¿åº¦å¤§è‡´ä¸º3~4å±‚, å› æ­¤æˆ‘ä»¬æœ€å°‘éœ€è¦é€’å½’5æ¬¡æ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬è‡ªå·±çš„debug call.</p>
<p>æœ€åæ‰¾åˆ°äº†è®°å½•ä¸‹æ¥å°±okäº†ã€‚</p>
<h3 id="è‡ªå·±å®ç°ä¸€ä¸ªContextHook"><a href="#è‡ªå·±å®ç°ä¸€ä¸ªContextHook" class="headerlink" title="è‡ªå·±å®ç°ä¸€ä¸ªContextHook"></a>è‡ªå·±å®ç°ä¸€ä¸ªContextHook</h3><p>å¦‚ä½•å®ç°ä¸€ä¸ªlogrusçš„hookå–ƒ?<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// A hook to be fired when logging on the logging levels returned from</span></div><div class="line"><span class="comment">// `Levels()` on your implementation of the interface. Note that this is not</span></div><div class="line"><span class="comment">// fired in a goroutine or a channel with workers, you should handle such</span></div><div class="line"><span class="comment">// functionality yourself if your call is non-blocking and you don't wish for</span></div><div class="line"><span class="comment">// the logging calls for levels returned from `Levels()` to block.</span></div><div class="line"><span class="keyword">type</span> Hook <span class="keyword">interface</span> &#123;</div><div class="line">	Levels() []Level</div><div class="line">	Fire(*Entry) error</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸€ä¸ªEntryä¸ºä¸€æ¡æ—¥å¿—è®°å½•, æˆ‘ä»¬çš„Hookéœ€è¦åšçš„å°±æ˜¯åœ¨æ¯ä¸€ä¸ªæ¡çš„æ—¥å¿—è®°å½•é‡Œé¢æ·»åŠ è°ƒç”¨æ—¶çš„æ–‡ä»¶åå’Œè¡Œå·. æ ¸å¿ƒå°±æ˜¯å®ç°è‡ªå·±çš„Fireæ–¹æ³•, ä»¥ä¸‹æ˜¯å‚è€ƒå®ç°:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> hooks</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"runtime"</span></div><div class="line">	<span class="string">"strings"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/sirupsen/logrus"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// ContextHook for log the call context</span></div><div class="line"><span class="keyword">type</span> contextHook <span class="keyword">struct</span> &#123;</div><div class="line">	Field  <span class="keyword">string</span></div><div class="line">	Skip   <span class="keyword">int</span></div><div class="line">	levels []logrus.Level</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewContextHook use to make an hook</span></div><div class="line"><span class="comment">// æ ¹æ®ä¸Šé¢çš„æ¨æ–­, æˆ‘ä»¬é€’å½’æ·±åº¦å¯ä»¥è®¾ç½®åˆ°5å³å¯.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewContextHook</span><span class="params">(levels ...logrus.Level)</span> <span class="title">logrus</span>.<span class="title">Hook</span></span> &#123;</div><div class="line">	hook := contextHook&#123;</div><div class="line">		Field:  <span class="string">"source"</span>,</div><div class="line">		Skip:   <span class="number">5</span>,</div><div class="line">		levels: levels,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(hook.levels) == <span class="number">0</span> &#123;</div><div class="line">		hook.levels = logrus.AllLevels</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;hook</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Levels implement levels</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(hook contextHook)</span> <span class="title">Levels</span><span class="params">()</span> []<span class="title">logrus</span>.<span class="title">Level</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> logrus.AllLevels</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Fire implement fire</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(hook contextHook)</span> <span class="title">Fire</span><span class="params">(entry *logrus.Entry)</span> <span class="title">error</span></span> &#123;</div><div class="line">	entry.Data[hook.Field] = findCaller(hook.Skip)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// å¯¹callerè¿›è¡Œé€’å½’æŸ¥è¯¢, ç›´åˆ°æ‰¾åˆ°élogrusåŒ…äº§ç”Ÿçš„ç¬¬ä¸€ä¸ªè°ƒç”¨.</span></div><div class="line"><span class="comment">// å› ä¸ºfilenameæˆ‘è·å–åˆ°äº†ä¸Šå±‚ç›®å½•å, å› æ­¤æ‰€æœ‰logrusåŒ…çš„è°ƒç”¨çš„æ–‡ä»¶åéƒ½æ˜¯ logrus/...</span></div><div class="line"><span class="comment">// å› æ­¤é€šè¿‡æ’é™¤logruså¼€å¤´çš„æ–‡ä»¶å, å°±å¯ä»¥æ’é™¤æ‰€æœ‰logrusåŒ…çš„è‡ªå·±çš„å‡½æ•°è°ƒç”¨</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">findCaller</span><span class="params">(skip <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	file := <span class="string">""</span></div><div class="line">	line := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">		file, line = getCaller(skip + i)</div><div class="line">		<span class="keyword">if</span> !strings.HasPrefix(file, <span class="string">"logrus"</span>) &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%s:%d"</span>, file, line)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// è¿™é‡Œå…¶å®å¯ä»¥è·å–å‡½æ•°åç§°çš„: fnName := runtime.FuncForPC(pc).Name()</span></div><div class="line"><span class="comment">// ä½†æ˜¯æˆ‘è§‰å¾—æœ‰ æ–‡ä»¶åå’Œè¡Œå·å°±å¤Ÿå®šä½é—®é¢˜, å› æ­¤å¿½ç•¥äº†callerè¿”å›çš„ç¬¬ä¸€ä¸ªå€¼:pc</span></div><div class="line"><span class="comment">// åœ¨æ ‡å‡†åº“logé‡Œé¢æˆ‘ä»¬å¯ä»¥é€‰æ‹©è®°å½•æ–‡ä»¶çš„å…¨è·¯å¾„æˆ–è€…æ–‡ä»¶å, ä½†æ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹æˆå¹¶å‘æœ€åˆé€‚çš„,</span></div><div class="line"><span class="comment">// å› ä¸ºæ–‡ä»¶çš„å…¨è·¯å¾„å¾€å¾€å¾ˆé•¿, è€Œæ–‡ä»¶ååœ¨å¤šä¸ªåŒ…ä¸­å¾€å¾€æœ‰é‡å¤, å› æ­¤è¿™é‡Œé€‰æ‹©å¤šå–ä¸€å±‚, å–åˆ°æ–‡ä»¶æ‰€åœ¨çš„ä¸Šå±‚ç›®å½•é‚£å±‚.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getCaller</span><span class="params">(skip <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	_, file, line, ok := runtime.Caller(skip)</div><div class="line">	fmt.Println(file)</div><div class="line">	fmt.Println(line)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, <span class="number">0</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	n := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(file) - <span class="number">1</span>; i &gt; <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> file[i] == <span class="string">'/'</span> &#123;</div><div class="line">			n++</div><div class="line">			<span class="keyword">if</span> n &gt;= <span class="number">2</span> &#123;</div><div class="line">				file = file[i+<span class="number">1</span>:]</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> file, line</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å› ä¸ºæ ‡å‡†åº“çš„æ—¥å¿—åº“ç¼ºå°‘Log Level, å¦‚æœåŸºäºæ ‡å‡†åº“æ‰©å±•è‡ªå·±çš„loggerä¹Ÿéœ€è¦èŠ±ä¸€ç‚¹æ—¶é—´, çœ‹githubçš„ä¸Šå¾ˆå¤šå¼€æºé¡¹ç›®éƒ½ä½¿ç”¨ä¸€ä¸ªå«logrusçš„æ¨¡å—, äºæ˜¯ç ”ç©¶äº†ä¸‹, å‘ç°å®ƒå…·æœ‰é«˜åº¦çš„çµæ´»æ€§, è€Œä¸”å·²ç»æœ‰å¾ˆå¤šå†™å¥½äº†çš„æ’ä»¶, æ¯”å¦‚å’Œlogstachå¯¹æ¥çš„æ’ä»¶,æ‰€ä»¥é¡¹ç›®åé¢å°±åˆ‡æ¢æ—¥å¿—æ¨¡å—ä¸ºlogrus, è¿™ç¯‡åšå®¢å°±æ˜¯ä»‹ç»æˆ‘ä»¬ä½¿ç”¨logrusæ—¶é‡åˆ°çš„å‘, ä»¥åŠä¸€äº›è§£å†³ä¹‹é“ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="log" scheme="https://blog.yumaojun.net/tags/log/"/>
    
  </entry>
  
  <entry>
    <title>MongoDBä»‹ç»ä¸Golangé©±åŠ¨ä½¿ç”¨</title>
    <link href="https://blog.yumaojun.net/2017/11/22/golang-mongodb/"/>
    <id>https://blog.yumaojun.net/2017/11/22/golang-mongodb/</id>
    <published>2017-11-22T05:37:45.000Z</published>
    <updated>2017-11-24T01:55:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šç¯‡åšå®¢ä¸­ä»‹ç»äº†NoSQLä»¥åŠæ–‡æ¡£æ•°æ®åº“, è¿™ç¯‡åšå®¢ä»‹ç»å½“ä¸‹æœ€æµè¡Œçš„æ–‡æ¡£æ•°æ®åº“:MongoDBã€‚<br><a id="more"></a></p>
<h2 id="MongoDBç®€ä»‹"><a href="#MongoDBç®€ä»‹" class="headerlink" title="MongoDBç®€ä»‹"></a>MongoDBç®€ä»‹</h2><p>mongodbæ˜¯ä¸€ä¸ªåŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“ã€‚ç”±C++è¯­è¨€ç¼–å†™ã€‚æ—¨åœ¨ä¸ºWEBåº”ç”¨æä¾›å¯æ‰©å±•çš„é«˜æ€§èƒ½æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚å®ƒæ˜¯ä¸€ä¸ªä»‹äºå…³ç³»æ•°æ®åº“å’Œéå…³ç³»æ•°æ®åº“ä¹‹é—´çš„äº§å“ï¼Œæ˜¯éå…³ç³»æ•°æ®åº“å½“ä¸­åŠŸèƒ½æœ€ä¸°å¯Œï¼Œæœ€åƒå…³ç³»æ•°æ®åº“çš„ã€‚</p>
<p>mongodbè¢«å„ç§è§„æ¨¡çš„å…¬å¸ã€å„ä¸ªè¡Œä¸šã€ä»¥åŠå„ç§åº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨, å®ƒæ˜¯çµæ´»çš„æ•°æ®åº“, éšç€åº”ç”¨ç¨‹åºçš„å‘å±•, mongodbèƒ½é€‚åº”ç¨‹åºschemaçš„å¿«é€Ÿæ”¹å˜(schema free), åŒæ—¶è¿˜æä¾›å¼€å‘äººå‘˜æ‰€æœŸæœ›çš„ä¼ ç»Ÿæ•°æ®åº“çš„åŠŸèƒ½ï¼Œæ¯”å¦‚äºŒçº§ç´¢å¼•ï¼Œå®Œæ•´çš„æŸ¥è¯¢è¯­è¨€å’Œä¸¥æ ¼çš„ä¸€è‡´æ€§ã€‚</p>
<p>mongodbæœ‰ç€ä¸€ä¸ªä¸°å¯Œçš„å®¢æˆ·ç«¯ç”Ÿæ€ç³»ç»Ÿ, åŒ…æ‹¬hadoopçš„é›†æˆ, å®˜æ–¹æä¾›10å¤šç§ç¼–ç¨‹è¯­è¨€çš„é©±åŠ¨, è€Œç”¨æˆ·ç¤¾åŒºæä¾›é«˜è¾¾40å¤šç§çš„é©±åŠ¨, åé¢ä¼šä¸“é—¨ä»‹ç»Golangçš„MongoDBé©±åŠ¨<code>mgo</code>çš„ä½¿ç”¨ã€‚</p>
<p>mongodbçš„æµè¡Œç¦»ä¸å¼€ä»–çš„è¿™äº›ä¼˜ç‚¹:</p>
<ul>
<li>json: é¢å‘jsonçš„æ–‡æ¡£å­˜å‚¨ï¼Œæ“ä½œèµ·æ¥æ¯”è¾ƒç®€å•å’Œå®¹æ˜“, åº•å±‚å­˜å‚¨ä¸ºBson(äºŒè¿›åˆ¶çš„json)</li>
<li>schema free: ç‰¹åˆ«é€‚åˆå­˜å‚¨åŠç»“æ„åŒ–çš„æ•°æ®ã€‚</li>
<li>performance: c++ç¼–å†™, æ”¯æŒå…¨æ–‡ç´¢å¼•, åŸºäºå†…å­˜æ˜ å°„æŠ€æœ¯(Memory-mapped files)</li>
<li>scalable: Replication, Auto-sharding</li>
<li>query: æ”¯æŒä¸°å¯Œçš„æŸ¥è¯¢è¡¨è¾¾å¼ã€‚æŸ¥è¯¢æŒ‡ä»¤ä½¿ç”¨JSONå½¢å¼çš„æ ‡è®°ï¼Œå¯è½»æ˜“æŸ¥è¯¢æ–‡æ¡£ä¸­å†…åµŒçš„å¯¹è±¡åŠæ•°ç»„, å¹¶ä¸”å¾ˆé«˜æ•ˆ(queries run in parallel on all shards)</li>
<li>map/reduce: Mapå‡½æ•°å’ŒReduceå‡½æ•°æ˜¯ä½¿ç”¨Javascriptç¼–å†™çš„, å¹¶å¯ä»¥é€šè¿‡db.runCommandæˆ–mapreduceå‘½ä»¤æ¥æ‰§è¡ŒMapReduceæ“ä½œã€‚</li>
<li>udf: å¯ä»¥ç”¨Javascriptç¼–å†™æŸä¸ªå‡½æ•°ï¼Œç›´æ¥åœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥æŠŠå‡½æ•°çš„å®šä¹‰å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œä¸‹æ¬¡ç›´æ¥è°ƒç”¨å³å¯ã€‚</li>
<li>file storage: GridFSæ˜¯MongoDBä¸­çš„ä¸€ä¸ªå†…ç½®åŠŸèƒ½ï¼Œå¯ä»¥ç”¨äºå­˜æ”¾å¤§é‡å°æ–‡ä»¶ã€‚</li>
<li>suport many language: æ”¯æŒå„ç§ç¼–ç¨‹è¯­è¨€:RUBYï¼ŒPYTHONï¼ŒJAVAï¼ŒC++ï¼ŒPHPï¼ŒC#ç­‰å¤šç§è¯­è¨€ã€‚</li>
<li>opensource: å¼€æºä½†æ˜¯èƒŒåæœ‰å•†ä¸šå…¬å¸æ”¯æŒ(10gen), å½“ç„¶ä¹Ÿæœ‰ä¼ä¸šç‰ˆã€‚</li>
<li>docs: å®Œå–„çš„æ–‡æ¡£, æ— è®ºæ˜¯æ¶æ„, å®‰è£…, ä½¿ç”¨è¿˜æ˜¯å…¶ä»–, å®˜æ–¹æä¾›å®Œå–„çš„æ–‡æ¡£æ”¯æŒã€‚å¹¶ä¸”å®‰è£…ç®€å•ã€‚</li>
</ul>
<p>å› ä¸ºmongoæ–‡æ¡£å¾ˆå®Œå–„, å› æ­¤å®‰è£…è¯·çœ‹<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" target="_blank" rel="external">mongod unbuntu å®‰è£…æ–‡æ¡£</a>ã€‚å½“å‰ç¨³å®šç‰ˆä¸º3.4, åé¢çš„æµ‹è¯•éƒ½æ˜¯åŸºäº3.4ç‰ˆæœ¬è¿›è¡Œè¯´æ˜çš„ã€‚<br>ä¸ºäº†æ–¹ä¾¿æˆ‘ä½¿ç”¨dockerè¿›è¡Œå®‰è£…:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp $ docker pull mongo:3.4</div><div class="line"><span class="comment"># å¦‚æœä½ éœ€è¦æŠŠæ•°æ®æ–‡ä»¶æŒ‚è½½å‡ºå», é˜²æ­¢ä¸¢å¤±å¯ä»¥:</span></div><div class="line"><span class="comment"># docker run -p 27017:27017 -v $PWD/db:/data/db -d mongo:3.4</span></div><div class="line"><span class="comment"># ä½†æ˜¯æˆ‘æœ¬èº«å°±æ˜¯æµ‹è¯•ç¯å¢ƒ, å®¹å™¨åˆ äº†å°±è®©ä»–åˆ äº†å§:</span></div><div class="line">docker run -p 27017:27017 <span class="_">-d</span> mongo:3.4</div><div class="line">19ceeb4814632f089a0a78bb98af83d9fb49cb377aae2534d67881851bf6644e</div><div class="line"><span class="comment"># è¿›å…¥å®¹å™¨æµ‹è¯•ä¸‹mongo shellæ˜¯å¦æ­£å¸¸:</span></div><div class="line">maojun@maojun-mbp $ docker <span class="built_in">exec</span> -it 19c /bin/bash</div><div class="line">root@19ceeb481463:/<span class="comment"># mongo</span></div><div class="line">MongoDB shell version v3.4.10</div><div class="line">connecting to: mongodb://127.0.0.1:27017</div><div class="line">MongoDB server version: 3.4.10</div><div class="line">Welcome to the MongoDB shell.</div><div class="line">For interactive <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</div><div class="line">For more comprehensive documentation, see</div><div class="line">	http://docs.mongodb.org/</div><div class="line">Questions? Try the support group</div><div class="line">	http://groups.google.com/group/mongodb-user</div><div class="line">&gt; db</div><div class="line"><span class="built_in">test</span></div></pre></td></tr></table></figure></p>
<h2 id="åŸºç¡€æ¦‚å¿µè§£æ"><a href="#åŸºç¡€æ¦‚å¿µè§£æ" class="headerlink" title="åŸºç¡€æ¦‚å¿µè§£æ"></a>åŸºç¡€æ¦‚å¿µè§£æ</h2><p>ä¸ç®¡æˆ‘ä»¬å­¦ä¹ ä»€ä¹ˆæ•°æ®åº“éƒ½åº”è¯¥å­¦ä¹ å…¶ä¸­çš„åŸºç¡€æ¦‚å¿µ, åœ¨mongodbä¸­åŸºæœ¬çš„æ¦‚å¿µæ˜¯æ–‡æ¡£ã€é›†åˆã€æ•°æ®åº“, å¦‚æœå¯¹æ¯”ä¼ ç»Ÿæ•°æ®åº“çš„è¡¨, é‚£ä¹ˆä¸‹é¢è¿™å¼ å›¾å¯ä»¥å¸®ç»„æˆ‘ä»¬å¿«é€Ÿç†è§£MongoDBé‡Œé¢è¿™äº›åŸºæœ¬æ¦‚å¿µ:<br><img src="http://oiw1gzfww.bkt.clouddn.com/mongo_data_vs_table_data.png" alt=""></p>
<h3 id="æ•°æ®åº“-DB"><a href="#æ•°æ®åº“-DB" class="headerlink" title="æ•°æ®åº“(DB)"></a>æ•°æ®åº“(DB)</h3><p>å¯¹åº”äºä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“, DBå°±æ˜¯è¡¨çš„é›†åˆ, è€ŒMongoé‡Œé¢DBæ˜¯Collectionsçš„é›†åˆã€‚<br>ä½†æ˜¯å¯¹äºä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“è€Œè¨€, åœ¨ä½¿ç”¨ä¸Šæœ‰ç•¥å¾®çš„åŒºåˆ«:</p>
<ul>
<li>åŠ¨æ€åˆ›å»º: mongodbçš„dbä¸ç”¨å•ç‹¬åˆ›å»º, å¦‚æœä½¿ç”¨æ—¶æ²¡æœ‰å°±ä¼šè¢«è‡ªåŠ¨åˆ›å»ºã€‚</li>
<li>ä½¿ç”¨æ–¹å¼: é€šè¿‡ <code>show dbs</code>æŸ¥çœ‹æ•°æ®åº“, é€šè¿‡ <code>use dbName</code>åˆ‡æ¢æ•°æ®åº“, é€šè¿‡<code>db</code>æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„æ•°æ®åº“, é€šè¿‡<code>show collections</code>æŸ¥çœ‹æ‰€æœ‰çš„é›†åˆ(è¡¨)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt; show dbs</div><div class="line">admin    0.078GB</div><div class="line">gateway  0.078GB</div><div class="line"><span class="built_in">local</span>    0.078GB</div><div class="line">&gt;</div><div class="line">&gt; use gateway</div><div class="line">switched to db gateway</div><div class="line">&gt;</div><div class="line">&gt; show collections;</div><div class="line">students</div><div class="line">&gt;</div><div class="line">&gt; db</div><div class="line">gateway</div><div class="line">&gt;</div></pre></td></tr></table></figure>
<h3 id="æ–‡æ¡£-Document"><a href="#æ–‡æ¡£-Document" class="headerlink" title="æ–‡æ¡£(Document)"></a>æ–‡æ¡£(Document)</h3><p>æ–‡æ¡£æ˜¯MongoDBé‡Œé¢æœ€é‡è¦çš„æ¦‚å¿µ, ä½ å¯ä»¥å°†å®ƒç†è§£ä¸ºå…³ç³»å‹æ•°æ®çš„ä¸­Row,ä¸€ä¸ªæ–‡æ¡£ç›¸å½“äºmysqlä¸­çš„ä¸€è¡Œ, æ–‡æ¡£ç»„ç»‡çš„æ ¼å¼æ˜¯Jsoné£æ ¼, å¦‚ä¸‹:<br><img src="http://oiw1gzfww.bkt.clouddn.com/document_mongo.png" alt=""></p>
<p>ä½†æ˜¯mongodbå¹¶ä¸ä¼šå­˜å‚¨çš„Json, è€Œæ˜¯å­˜å‚¨çš„Bson(Jsonçš„äºŒè¿›åˆ¶æ ¼å¼), å½“æˆ‘ä»¬æŸ¥çœ‹æ—¶Bsonä¼šè‡ªåŠ¨è½¬æ¢æˆJson, ä¸ºäº†è¿½è¸ªæ¯ä¸€ä¸ª Document, æ¯ä¸€ä¸ªDocumentéƒ½æœ‰ä¸€ä¸ªéšè—çš„id å­—æ®µï¼Œ è¿™å°±å¥½åƒmyslqçš„row_id,  å®ƒæ˜¯Mongodbé‡Œé¢çš„ä¸»é”®ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„æ —å­:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; db.students.<span class="function"><span class="title">find</span></span>()</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a162b109d83b8def7401002"</span>), <span class="string">"name"</span> : <span class="string">"Bob"</span>, <span class="string">"age"</span> : 22 &#125;</div></pre></td></tr></table></figure></p>
<h3 id="é›†åˆ-Collection"><a href="#é›†åˆ-Collection" class="headerlink" title="é›†åˆ(Collection)"></a>é›†åˆ(Collection)</h3><p>documentçš„å®¹å™¨, ä¸€ç»„ç›¸å…³çš„documentç»„æˆçš„ä¸€ä¸ªé›†åˆå°±å«<code>collection</code>, å› æ­¤collectionç›¸å½“äºmysqlä¸­çš„table, å¦‚ä¸‹:<br><img src="http://oiw1gzfww.bkt.clouddn.com/collection_mongo.png" alt=""></p>
<p>é›†åˆå­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œé›†åˆæ²¡æœ‰å›ºå®šçš„ç»“æ„(æ–‡æ¡£ä¸éœ€è¦è®¾ç½®ç›¸åŒçš„å­—æ®µï¼Œå¹¶ä¸”ç›¸åŒçš„å­—æ®µä¸éœ€è¦ç›¸åŒçš„æ•°æ®ç±»å‹)ï¼Œè¿™æ„å‘³ç€ä½ åœ¨å¯¹é›†åˆå¯ä»¥æ’å…¥ä¸åŒæ ¼å¼å’Œç±»å‹çš„æ•°æ®ï¼Œä½†é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬æ’å…¥é›†åˆçš„æ•°æ®éƒ½ä¼šæœ‰ä¸€å®šçš„å…³è”æ€§ã€‚è¿™ä¸å…³ç³»å‹æ•°æ®åº“æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œä¹Ÿæ˜¯MongoDBéå¸¸çªå‡ºçš„ç‰¹ç‚¹, è¯¥ç‰¹æ€§è¢«ç§°ä½œ<code>schema free</code>ã€‚</p>
<p>æ¯”å¦‚:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; db.students.<span class="function"><span class="title">find</span></span>()</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a162b109d83b8def7401002"</span>), <span class="string">"name"</span> : <span class="string">"Bob"</span>, <span class="string">"age"</span> : 22 &#125;</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a162b829d83b8def7401003"</span>), <span class="string">"name"</span> : <span class="string">"Bob"</span>, <span class="string">"money"</span> : 99 &#125;</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a162bbd9d83b8def7401004"</span>), <span class="string">"name"</span> : <span class="string">"Bob"</span>, <span class="string">"location"</span> : <span class="string">"chengdu"</span> &#125;</div></pre></td></tr></table></figure></p>
<h2 id="mongo-shellçš„ä½¿ç”¨"><a href="#mongo-shellçš„ä½¿ç”¨" class="headerlink" title="mongo shellçš„ä½¿ç”¨"></a>mongo shellçš„ä½¿ç”¨</h2><p>æ­£å¸¸å®‰è£…å®ŒMongoDBè¿‡åä¼šå®‰è£…<code>mongodb-org-shell</code>åŒ…, å®ƒæ˜¯mongoDBçš„å®¢æˆ·ç«¯å·¥å…·, æˆ‘ä»¬ä½¿ç”¨å®ƒå’ŒMongoDBè¿›è¡Œäº¤äº’(å°±åƒMySQLçš„å®¢æˆ·ç«¯å·¥å…·ä¸€æ ·).<br>é€šè¿‡helpæŸ¥çœ‹mongo-shellçš„ä½¿ç”¨æ–¹æ³•:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="built_in">help</span></div><div class="line">	db.help()                    <span class="built_in">help</span> on db methods</div><div class="line">	db.mycoll.help()             <span class="built_in">help</span> on collection methods</div><div class="line">	sh.help()                    sharding helpers</div><div class="line">	rs.help()                    replica <span class="built_in">set</span> helpers</div><div class="line">	<span class="built_in">help</span> admin                   administrative <span class="built_in">help</span></div><div class="line">	<span class="built_in">help</span> connect                 connecting to a db <span class="built_in">help</span></div><div class="line">	<span class="built_in">help</span> keys                    key shortcuts</div><div class="line">	<span class="built_in">help</span> misc                    misc things to know</div><div class="line">	<span class="built_in">help</span> mr                      mapreduce</div><div class="line"></div><div class="line">	show dbs                     show database names</div><div class="line">	show collections             show collections <span class="keyword">in</span> current database</div><div class="line">	show users                   show users <span class="keyword">in</span> current database</div><div class="line">	show profile                 show most recent system.profile entries with time &gt;= 1ms</div><div class="line">	show logs                    show the accessible logger names</div><div class="line">	show <span class="built_in">log</span> [name]              prints out the last segment of <span class="built_in">log</span> <span class="keyword">in</span> memory, <span class="string">'global'</span> is default</div><div class="line">	use &lt;db_name&gt;                <span class="built_in">set</span> current database</div><div class="line">	db.foo.find()                list objects <span class="keyword">in</span> collection foo</div><div class="line">	db.foo.find( &#123; a : 1 &#125; )     list objects <span class="keyword">in</span> foo <span class="built_in">where</span> a == 1</div><div class="line">	it                           result of the last line evaluated; use to further iterate</div><div class="line">	DBQuery.shellBatchSize = x   <span class="built_in">set</span> default number of items to display on shell</div><div class="line">	<span class="built_in">exit</span>                         quit the mongo shell</div><div class="line">&gt;</div></pre></td></tr></table></figure></p>
<p>ä¸‹é¢å°†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨mongoå®¢æˆ·ç«¯å¯¹æ•°æ®è¿›è¡ŒåŸºæœ¬çš„å¢åˆ æ”¹æŸ¥</p>
<h3 id="æ·»åŠ æ•°æ®"><a href="#æ·»åŠ æ•°æ®" class="headerlink" title="æ·»åŠ æ•°æ®"></a>æ·»åŠ æ•°æ®</h3><p>è¯­æ³•: db.mycoll.insert(document)<br>ç”¨æ³•: åœ¨insertå‡½æ•°å†…ä¼ å…¥ä½ éœ€è¦è®°å½•çš„jsonã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; db.students.insert(&#123;<span class="string">"name"</span>: <span class="string">"Bob"</span>, <span class="string">"age"</span>: 22&#125;)</div><div class="line">WriteResult(&#123; <span class="string">"nInserted"</span> : 1 &#125;)</div></pre></td></tr></table></figure></p>
<h3 id="æŸ¥çœ‹æ•°æ®"><a href="#æŸ¥çœ‹æ•°æ®" class="headerlink" title="æŸ¥çœ‹æ•°æ®"></a>æŸ¥çœ‹æ•°æ®</h3><p>è¯­æ³•: db.mycoll.find(query, projection)<br>å‚æ•°: </p>
<ul>
<li>query: å¯é€‰ï¼Œä½¿ç”¨æŸ¥è¯¢æ“ä½œç¬¦æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ </li>
<li>projection: å¯é€‰ï¼Œä½¿ç”¨æŠ•å½±æ“ä½œç¬¦æŒ‡å®šè¿”å›çš„é”®ã€‚æŸ¥è¯¢æ—¶è¿”å›æ–‡æ¡£ä¸­æ‰€æœ‰é”®å€¼ï¼Œ åªéœ€çœç•¥è¯¥å‚æ•°å³å¯ï¼ˆé»˜è®¤çœç•¥ï¼‰</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰</span></div><div class="line">&gt; db.students.<span class="function"><span class="title">find</span></span>()</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a1632029d83b8def7401005"</span>), <span class="string">"name"</span> : <span class="string">"Bob"</span>, <span class="string">"age"</span> : 22 &#125;</div><div class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šæŸä¸ª</span></div><div class="line">&gt; db.students.find(&#123;<span class="string">"name"</span>: <span class="string">"Bob"</span>&#125;);</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a1632029d83b8def7401005"</span>), <span class="string">"name"</span> : <span class="string">"Bob"</span>, <span class="string">"age"</span> : 22 &#125;</div><div class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šå­—æ®µ(æ³¨æ„ 1:ä»£è¡¨è¦å±•ç°è¯¥å­—æ®µ, 0: ä»£è¡¨ä¸å±•ç°è¯¥å­—æ®µ, é»˜è®¤"_id"ä¸ºè¦å±•ç¤º)</span></div><div class="line">&gt; db.students.find(&#123;<span class="string">"name"</span>: <span class="string">"Bob"</span>&#125;, &#123;<span class="string">"age"</span>: 1, <span class="string">"_id"</span>: 0&#125;);</div><div class="line">&#123; <span class="string">"age"</span> : 22 &#125;</div></pre></td></tr></table></figure>
<p>æ˜¯ä¸æ˜¯å¾ˆç®€å•, æ¥çœ‹çœ‹é«˜çº§ç‚¹çš„æŸ¥è¯¢è¯­æ³•:</p>
<blockquote>
<p>æ¡ä»¶æ¯”è¾ƒ</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">æ“ä½œ</th>
<th style="text-align:center">æè¿°</th>
<th style="text-align:right">è¯­æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">$gt</td>
<td style="text-align:center">grant than</td>
<td style="text-align:right">{field: {$gt: value}}</td>
</tr>
<tr>
<td style="text-align:left">$gte</td>
<td style="text-align:center">grant than equal</td>
<td style="text-align:right">{field: {$gte: value}}</td>
</tr>
<tr>
<td style="text-align:left">$lt</td>
<td style="text-align:center">less than</td>
<td style="text-align:right">{field: {$lt: value}}</td>
</tr>
<tr>
<td style="text-align:left">$lte</td>
<td style="text-align:center">less than equal</td>
<td style="text-align:right">{field: {$lte: value}}</td>
</tr>
<tr>
<td style="text-align:left">$eq</td>
<td style="text-align:center">equal</td>
<td style="text-align:right">{field: {$eq: value}}</td>
</tr>
<tr>
<td style="text-align:left">$ne</td>
<td style="text-align:center">not equal</td>
<td style="text-align:right">{field: {$ne: value}}</td>
</tr>
<tr>
<td style="text-align:left">$in</td>
<td style="text-align:center">in</td>
<td style="text-align:right">{field: {field:  {$in:  [value, value, â€¦]}}</td>
</tr>
<tr>
<td style="text-align:left">$nin</td>
<td style="text-align:center">not in</td>
<td style="text-align:right">{field: {field:  {$nin:  [value, value, â€¦]}}</td>
</tr>
</tbody>
</table>
<blockquote>
<p>æ¡ä»¶ç»„åˆ</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">æ“ä½œ</th>
<th style="text-align:center">æè¿°</th>
<th style="text-align:right">è¯­æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">$or</td>
<td style="text-align:center">æˆ–</td>
<td style="text-align:right">{$or: [{<expression1>}, {<expression2>}, â€¦}</expression2></expression1></td>
</tr>
<tr>
<td style="text-align:left">$and</td>
<td style="text-align:center">ä¸</td>
<td style="text-align:right">{$and: [{<expression1>}, {<expression2>}, â€¦}</expression2></expression1></td>
</tr>
<tr>
<td style="text-align:left">$not</td>
<td style="text-align:center">é</td>
<td style="text-align:right"></td>
</tr>
<tr>
<td style="text-align:left">$nor</td>
<td style="text-align:center">å</td>
</tr>
</tbody>
</table>
<blockquote>
<p>å…ƒç´ æŸ¥è¯¢</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">æ“ä½œ</th>
<th style="text-align:center">æè¿°</th>
<th style="text-align:right">è¯­æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">$exists</td>
<td style="text-align:center">exist</td>
<td style="text-align:right">{filed:  {$exists: <boolean>}</boolean></td>
</tr>
<tr>
<td style="text-align:left">$mod</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">$type</td>
<td style="text-align:center">è¿”å›æŒ‡å®š å­—æ®µç±»å‹çš„æ–‡æ¡£</td>
<td style="text-align:right">{filed: {$type: <bson type="">}}, 1. Double 2. String 3.Object 4. Array 5 Binary data â€¦</bson></td>
</tr>
</tbody>
</table>
<h3 id="ä¿®æ”¹æ•°æ®"><a href="#ä¿®æ”¹æ•°æ®" class="headerlink" title="ä¿®æ”¹æ•°æ®"></a>ä¿®æ”¹æ•°æ®</h3><p>è¯­æ³•: db.mycoll.update(query, object[, upsert_bool, multi_bool])<br>å‚æ•°: </p>
<ul>
<li>query: updateçš„æŸ¥è¯¢æ¡ä»¶ï¼Œç±»ä¼¼sql updateæŸ¥è¯¢å†…whereåé¢çš„ã€‚</li>
<li>update: updateçš„å¯¹è±¡å’Œä¸€äº›æ›´æ–°çš„æ“ä½œç¬¦ï¼ˆå¦‚$,$incâ€¦ï¼‰ç­‰ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºsql updateæŸ¥è¯¢å†…setåé¢çš„ã€‚ </li>
<li>upsert: å¯é€‰ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼Œå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNew,trueä¸ºæ’å…¥ï¼Œé»˜è®¤æ˜¯falseï¼Œä¸æ’å…¥ã€‚</li>
<li>multi: å¯é€‰ï¼Œmongodb é»˜è®¤æ˜¯false,åªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°ä¸ºtrue,å°±æŠŠæŒ‰æ¡ä»¶æŸ¥å‡ºæ¥å¤šæ¡è®°å½•å…¨éƒ¨æ›´æ–°ã€‚</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æˆ‘ä»¬å…ˆçœ‹çœ‹æœ‰å“ªäº›æ•°æ®</span></div><div class="line">&gt; db.students.<span class="function"><span class="title">find</span></span>()</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a1632029d83b8def7401005"</span>), <span class="string">"name"</span> : <span class="string">"Bob"</span>, <span class="string">"age"</span> : 22 &#125;</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a16c89f4da8732f195b4000"</span>), <span class="string">"name"</span> : <span class="string">"Aollen"</span>, <span class="string">"age"</span> : 21 &#125;</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a16c8b74da8732f195b4001"</span>), <span class="string">"name"</span> : <span class="string">"tom"</span>, <span class="string">"age"</span> : 20 &#125;</div><div class="line"><span class="comment"># æ›´æ–°æŒ‡å®šå¯¹è±¡</span></div><div class="line">&gt; db.students.update(&#123;<span class="string">"name"</span>: <span class="string">"Bob"</span>&#125;, &#123;<span class="variable">$set</span>:&#123;<span class="string">"age"</span>: 32&#125;&#125;)</div><div class="line">WriteResult(&#123; <span class="string">"nMatched"</span> : 1, <span class="string">"nUpserted"</span> : 0, <span class="string">"nModified"</span> : 1 &#125;)</div><div class="line"><span class="comment"># æŒ‰æ¡ä»¶æ›´æ–°åŒ¹é…åˆ°çš„ç¬¬ä¸€æ¡(SQL Where)</span></div><div class="line">&gt; db.students.update(&#123;<span class="string">"age"</span>: &#123;<span class="variable">$gt</span>: 20&#125;&#125;, &#123;<span class="variable">$set</span>:&#123;<span class="string">"age"</span>: 30&#125;&#125;)</div><div class="line">WriteResult(&#123; <span class="string">"nMatched"</span> : 1, <span class="string">"nUpserted"</span> : 0, <span class="string">"nModified"</span> : 1 &#125;)</div><div class="line"><span class="comment"># æŒ‰æ¡ä»¶æ›´æ–°åŒ¹é…åˆ°çš„æ‰€æœ‰(SQL Where)</span></div><div class="line">&gt; db.students.update(&#123;<span class="string">"age"</span>: &#123;<span class="variable">$gt</span>: 20&#125;&#125;, &#123;<span class="variable">$set</span>:&#123;<span class="string">"age"</span>: 30&#125;&#125;, <span class="literal">false</span>, <span class="literal">true</span>)</div><div class="line">WriteResult(&#123; <span class="string">"nMatched"</span> : 2, <span class="string">"nUpserted"</span> : 0, <span class="string">"nModified"</span> : 1 &#125;)</div></pre></td></tr></table></figure>
<p>é«˜çº§ç‚¹çš„è¯­æ³•:</p>
<ul>
<li>æ›´æ–°ç¬¬ä¸€ä¸ªè¢«åŒ¹é…åˆ°çš„æ–‡æ¡£: db.mycoll.updateOne(filter, update, \<optional params="">), å¯é€‰å‚æ•°: upsert, w, wtimeout, j</optional></li>
<li>æ›´æ–°æ‰€æœ‰è¢«åŒ¹é…åˆ°çš„æ–‡æ¡£: db.mycoll.updateMany(filter, update, \<optional params="">),  å¯é€‰å‚æ•°: upsert, w, wtimeout, j</optional></li>
</ul>
<h3 id="åˆ é™¤æ•°æ®"><a href="#åˆ é™¤æ•°æ®" class="headerlink" title="åˆ é™¤æ•°æ®"></a>åˆ é™¤æ•°æ®</h3><p>è¯­æ³•: db.mycoll.remove(\<query>)</query></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># åˆ é™¤æŒ‡å®šçš„å¯¹è±¡</span></div><div class="line">&gt; db.students.remove(&#123;<span class="string">"name"</span>: <span class="string">"Bob"</span>&#125;)</div><div class="line">WriteResult(&#123; <span class="string">"nRemoved"</span> : 1 &#125;)</div><div class="line"><span class="comment"># åˆ é™¤è¯¥collectioné‡Œé¢çš„æ‰€æœ‰å¯¹è±¡</span></div><div class="line">&gt; db.students.remove(&#123;&#125;)</div><div class="line">WriteResult(&#123; <span class="string">"nRemoved"</span> : 2 &#125;)</div></pre></td></tr></table></figure>
<h2 id="mongo-golangé©±åŠ¨mgoçš„ä½¿ç”¨"><a href="#mongo-golangé©±åŠ¨mgoçš„ä½¿ç”¨" class="headerlink" title="mongo golangé©±åŠ¨mgoçš„ä½¿ç”¨"></a>mongo golangé©±åŠ¨mgoçš„ä½¿ç”¨</h2><p>åœ¨mongodbçš„é©±åŠ¨é‡Œé¢Golangé©±åŠ¨æ¨èä½¿ç”¨<code>mgo</code>.<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">go get gopkg.in/mgo.v2</div></pre></td></tr></table></figure></p>
<p>åœ¨ä½¿ç”¨ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹çœ‹è¿æ¥MongoDBçš„URI Format: <code>mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</code><br>å‚æ•°è¯´æ˜:</p>
<ul>
<li>mongodb:// è¿™æ˜¯å›ºå®šçš„æ ¼å¼ï¼Œå¿…é¡»è¦æŒ‡å®šã€‚</li>
<li>username:password@ å¯é€‰é¡¹ï¼Œå¦‚æœè®¾ç½®ï¼Œåœ¨è¿æ¥æ•°æ®åº“æœåŠ¡å™¨ä¹‹åï¼Œé©±åŠ¨éƒ½ä¼šå°è¯•ç™»é™†è¿™ä¸ªæ•°æ®åº“</li>
<li>host1 å¿…é¡»çš„æŒ‡å®šè‡³å°‘ä¸€ä¸ªhost, host1 æ˜¯è¿™ä¸ªURIå”¯ä¸€è¦å¡«å†™çš„ã€‚å®ƒæŒ‡å®šäº†è¦è¿æ¥æœåŠ¡å™¨çš„åœ°å€ã€‚å¦‚æœè¦è¿æ¥å¤åˆ¶é›†ï¼Œè¯·æŒ‡å®šå¤šä¸ªä¸»æœºåœ°å€ã€‚</li>
<li>portX å¯é€‰çš„æŒ‡å®šç«¯å£ï¼Œå¦‚æœä¸å¡«ï¼Œé»˜è®¤ä¸º27017</li>
<li>/database å¦‚æœæŒ‡å®šusername:password@ï¼Œè¿æ¥å¹¶éªŒè¯ç™»é™†æŒ‡å®šæ•°æ®åº“ã€‚è‹¥ä¸æŒ‡å®šï¼Œé»˜è®¤æ‰“å¼€ test æ•°æ®åº“ã€‚</li>
<li>?options æ˜¯è¿æ¥é€‰é¡¹ã€‚å¦‚æœä¸ä½¿ç”¨/databaseï¼Œåˆ™å‰é¢éœ€è¦åŠ ä¸Š/ã€‚æ‰€æœ‰è¿æ¥é€‰é¡¹éƒ½æ˜¯é”®å€¼å¯¹name=valueï¼Œé”®å€¼å¯¹ä¹‹é—´é€šè¿‡&amp;æˆ–;ï¼ˆåˆ†å·ï¼‰éš”å¼€</li>
</ul>
<p>ä¸‹é¢ä¸¾2ä¸ªç®€å•å¾—æ —å­, å› ä¸ºç­‰ä¸‹å›ä½¿ç”¨åˆ°:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ç”¨æˆ·: admin å¯†ç : 123456 åœ°å€: localhost æ•°æ®åº“: test</span></div><div class="line">mongodb://admin:123456@localhost:27017/<span class="built_in">test</span></div><div class="line"><span class="comment"># ä»¥å®‰å…¨æ¨¡å¼è¿æ¥åˆ°replica setï¼Œå¹¶ä¸”ç­‰å¾…è‡³å°‘ä¸¤ä¸ªå¤åˆ¶æœåŠ¡å™¨æˆåŠŸå†™å…¥ï¼Œè¶…æ—¶æ—¶é—´è®¾ç½®ä¸º2ç§’ã€‚</span></div><div class="line">mongodb://host1,host2,host3/?safe=<span class="literal">true</span>;w=2;wtimeoutMS=2000</div></pre></td></tr></table></figure></p>
<p>å¦‚æœæƒ³è¦äº†è§£å…³äºæ­¤æ›´è¯¦ç»†çš„æ–‡æ¡£, è¯·æŸ¥çœ‹:</p>
<ul>
<li><a href="https://docs.mongodb.com/manual/reference/connection-string/" target="_blank" rel="external">MongoDBå®˜æ–¹æ–‡æ¡£å…³äºconnection-stringçš„è¯¦è§£</a></li>
<li><a href="http://www.runoob.com/mongodb/mongodb-connections.html" target="_blank" rel="external">èœé¸Ÿå­¦é™¢MongoDBè¿æ¥</a></li>
</ul>
<h3 id="åŸºæœ¬æ —å­"><a href="#åŸºæœ¬æ —å­" class="headerlink" title="åŸºæœ¬æ —å­"></a>åŸºæœ¬æ —å­</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆäº†è§£<code>mgo</code>ä¸€äº›æœ€åŸºæœ¬çš„ç”¨æ³•:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line"></div><div class="line">	<span class="string">"gopkg.in/mgo.v2"</span></div><div class="line">	<span class="string">"gopkg.in/mgo.v2/bson"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Person is test</span></div><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name  <span class="keyword">string</span></div><div class="line">	Phone <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	session, err := mgo.Dial(<span class="string">"mongodb://127.0.0.1:27017/"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">	<span class="comment">// Optional. Switch the session to a monotonic behavior.</span></div><div class="line">	session.SetMode(mgo.Monotonic, <span class="literal">true</span>)</div><div class="line"></div><div class="line">	c := session.DB(<span class="string">"test"</span>).C(<span class="string">"people"</span>)</div><div class="line">	err = c.Insert(&amp;Person&#123;<span class="string">"Ale"</span>, <span class="string">"+55 53 8116 9639"</span>&#125;,</div><div class="line">		&amp;Person&#123;<span class="string">"Cla"</span>, <span class="string">"+55 53 8402 8510"</span>&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	result := Person&#123;&#125;</div><div class="line">	err = c.Find(bson.M&#123;<span class="string">"name"</span>: <span class="string">"Ale"</span>&#125;).One(&amp;result)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"Phone:"</span>, result.Phone)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æœ€ç»ˆæˆ‘ä»¬ç”¨mongo-shellè¿æ¥æ•°æ®åº“, éªŒè¯ä¸‹ç¨‹åºæ˜¯å¦ç”Ÿæ•ˆ:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; db.people.<span class="function"><span class="title">find</span></span>()</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a16dd323bde4bd3cde02654"</span>), <span class="string">"name"</span> : <span class="string">"Ale"</span>, <span class="string">"phone"</span> : <span class="string">"+55 53 8116 9639"</span> &#125;</div><div class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5a16dd323bde4bd3cde02655"</span>), <span class="string">"name"</span> : <span class="string">"Cla"</span>, <span class="string">"phone"</span> : <span class="string">"+55 53 8402 8510"</span> &#125;</div></pre></td></tr></table></figure></p>
<h3 id="å¾®æœåŠ¡æ —å­"><a href="#å¾®æœåŠ¡æ —å­" class="headerlink" title="å¾®æœåŠ¡æ —å­"></a>å¾®æœåŠ¡æ —å­</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºäºMongoDBçš„å¾®æœåŠ¡çš„æ —å­:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/julienschmidt/httprouter"</span></div><div class="line">	<span class="string">"gopkg.in/mgo.v2"</span></div><div class="line">	<span class="string">"gopkg.in/mgo.v2/bson"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ErrorWithJSON</span><span class="params">(w http.ResponseWriter, message <span class="keyword">string</span>, code <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json; charset=utf-8"</span>)</div><div class="line">	w.WriteHeader(code)</div><div class="line">	fmt.Fprintf(w, <span class="string">"&#123;message: %q&#125;"</span>, message)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ResponseWithJSON</span><span class="params">(w http.ResponseWriter, json []<span class="keyword">byte</span>, code <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json; charset=utf-8"</span>)</div><div class="line">	w.WriteHeader(code)</div><div class="line">	w.Write(json)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Book <span class="keyword">struct</span> &#123;</div><div class="line">	ISBN    <span class="keyword">string</span>   <span class="string">`json:"isbn"`</span></div><div class="line">	Title   <span class="keyword">string</span>   <span class="string">`json:"title"`</span></div><div class="line">	Authors []<span class="keyword">string</span> <span class="string">`json:"authors"`</span></div><div class="line">	Price   <span class="keyword">string</span>   <span class="string">`json:"price"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	session, err := mgo.Dial(<span class="string">"localhost:27017"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">	session.SetMode(mgo.Monotonic, <span class="literal">true</span>)</div><div class="line">	ensureIndex(session)</div><div class="line"></div><div class="line">	router := httprouter.New()</div><div class="line">	router.GET(<span class="string">"/books"</span>, allBooks(session))</div><div class="line">	router.POST(<span class="string">"/books"</span>, addBook(session))</div><div class="line">	router.GET(<span class="string">"/books/:isbn"</span>, bookByISBN(session))</div><div class="line">	router.PUT(<span class="string">"/books/:isbn"</span>, updateBook(session))</div><div class="line">	router.DELETE(<span class="string">"/books/:isbn"</span>, deleteBook(session))</div><div class="line"></div><div class="line">	http.ListenAndServe(<span class="string">"localhost:8080"</span>, router)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ensureIndex</span><span class="params">(s *mgo.Session)</span></span> &#123;</div><div class="line">	session := s.Copy()</div><div class="line">	<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">	c := session.DB(<span class="string">"store"</span>).C(<span class="string">"books"</span>)</div><div class="line"></div><div class="line">	index := mgo.Index&#123;</div><div class="line">		Key:        []<span class="keyword">string</span>&#123;<span class="string">"isbn"</span>&#125;,</div><div class="line">		Unique:     <span class="literal">true</span>,</div><div class="line">		DropDups:   <span class="literal">true</span>,</div><div class="line">		Background: <span class="literal">true</span>,</div><div class="line">		Sparse:     <span class="literal">true</span>,</div><div class="line">	&#125;</div><div class="line">	err := c.EnsureIndex(index)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">allBooks</span><span class="params">(s *mgo.Session)</span> <span class="title">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">		session := s.Copy()</div><div class="line">		<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">		c := session.DB(<span class="string">"store"</span>).C(<span class="string">"books"</span>)</div><div class="line"></div><div class="line">		<span class="keyword">var</span> books []Book</div><div class="line">		err := c.Find(bson.M&#123;&#125;).All(&amp;books)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			ErrorWithJSON(w, <span class="string">"Database error"</span>, http.StatusInternalServerError)</div><div class="line">			log.Println(<span class="string">"Failed get all books: "</span>, err)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		respBody, err := json.MarshalIndent(books, <span class="string">""</span>, <span class="string">"  "</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			log.Fatal(err)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		ResponseWithJSON(w, respBody, http.StatusOK)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">addBook</span><span class="params">(s *mgo.Session)</span> <span class="title">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">		session := s.Copy()</div><div class="line">		<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">		<span class="keyword">var</span> book Book</div><div class="line">		decoder := json.NewDecoder(r.Body)</div><div class="line">		err := decoder.Decode(&amp;book)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			ErrorWithJSON(w, <span class="string">"Incorrect body"</span>, http.StatusBadRequest)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		c := session.DB(<span class="string">"store"</span>).C(<span class="string">"books"</span>)</div><div class="line"></div><div class="line">		err = c.Insert(book)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> mgo.IsDup(err) &#123;</div><div class="line">				ErrorWithJSON(w, <span class="string">"Book with this ISBN already exists"</span>, http.StatusBadRequest)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			ErrorWithJSON(w, <span class="string">"Database error"</span>, http.StatusInternalServerError)</div><div class="line">			log.Println(<span class="string">"Failed insert book: "</span>, err)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</div><div class="line">		w.Header().Set(<span class="string">"Location"</span>, r.URL.Path+<span class="string">"/"</span>+book.ISBN)</div><div class="line">		w.WriteHeader(http.StatusCreated)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">bookByISBN</span><span class="params">(s *mgo.Session)</span> <span class="title">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">		session := s.Copy()</div><div class="line">		<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">		isbn := ps.ByName(<span class="string">"isbn"</span>)</div><div class="line"></div><div class="line">		c := session.DB(<span class="string">"store"</span>).C(<span class="string">"books"</span>)</div><div class="line"></div><div class="line">		<span class="keyword">var</span> book Book</div><div class="line">		err := c.Find(bson.M&#123;<span class="string">"isbn"</span>: isbn&#125;).One(&amp;book)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			ErrorWithJSON(w, <span class="string">"Database error"</span>, http.StatusInternalServerError)</div><div class="line">			log.Println(<span class="string">"Failed find book: "</span>, err)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> book.ISBN == <span class="string">""</span> &#123;</div><div class="line">			ErrorWithJSON(w, <span class="string">"Book not found"</span>, http.StatusNotFound)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		respBody, err := json.MarshalIndent(book, <span class="string">""</span>, <span class="string">"  "</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			log.Fatal(err)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		ResponseWithJSON(w, respBody, http.StatusOK)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateBook</span><span class="params">(s *mgo.Session)</span> <span class="title">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">		session := s.Copy()</div><div class="line">		<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">		isbn := ps.ByName(<span class="string">"isbn"</span>)</div><div class="line"></div><div class="line">		<span class="keyword">var</span> book Book</div><div class="line">		decoder := json.NewDecoder(r.Body)</div><div class="line">		err := decoder.Decode(&amp;book)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			ErrorWithJSON(w, <span class="string">"Incorrect body"</span>, http.StatusBadRequest)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		c := session.DB(<span class="string">"store"</span>).C(<span class="string">"books"</span>)</div><div class="line"></div><div class="line">		err = c.Update(bson.M&#123;<span class="string">"isbn"</span>: isbn&#125;, &amp;book)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">switch</span> err &#123;</div><div class="line">			<span class="keyword">default</span>:</div><div class="line">				ErrorWithJSON(w, <span class="string">"Database error"</span>, http.StatusInternalServerError)</div><div class="line">				log.Println(<span class="string">"Failed update book: "</span>, err)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			<span class="keyword">case</span> mgo.ErrNotFound:</div><div class="line">				ErrorWithJSON(w, <span class="string">"Book not found"</span>, http.StatusNotFound)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		w.WriteHeader(http.StatusNoContent)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteBook</span><span class="params">(s *mgo.Session)</span> <span class="title">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</div><div class="line">		session := s.Copy()</div><div class="line">		<span class="keyword">defer</span> session.Close()</div><div class="line"></div><div class="line">		isbn := ps.ByName(<span class="string">"isbn"</span>)</div><div class="line"></div><div class="line">		c := session.DB(<span class="string">"store"</span>).C(<span class="string">"books"</span>)</div><div class="line"></div><div class="line">		err := c.Remove(bson.M&#123;<span class="string">"isbn"</span>: isbn&#125;)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">switch</span> err &#123;</div><div class="line">			<span class="keyword">default</span>:</div><div class="line">				ErrorWithJSON(w, <span class="string">"Database error"</span>, http.StatusInternalServerError)</div><div class="line">				log.Println(<span class="string">"Failed delete book: "</span>, err)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			<span class="keyword">case</span> mgo.ErrNotFound:</div><div class="line">				ErrorWithJSON(w, <span class="string">"Book not found"</span>, http.StatusNotFound)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		w.WriteHeader(http.StatusNoContent)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æµ‹è¯•:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># åˆ›å»ºä¸€æœ¬book</span></div><div class="line"> maojun@maojun-mbp $ curl -X POST \</div><div class="line">&gt;   http://localhost:8080/books \</div><div class="line">&gt;   -H <span class="string">'content-type: application/json'</span> \</div><div class="line">&gt;   <span class="_">-d</span> <span class="string">'&#123;"isbn": "aabbxx", "title": "test titile", "authors":["bob", "aollen"], "price": "100"&#125;'</span></div><div class="line"><span class="comment"># æŸ¥çœ‹åˆ›å»ºçš„bookåˆ—è¡¨</span></div><div class="line"> maojun@maojun-mbp $ curl -X GET http://localhost:8080/books</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"isbn"</span>: <span class="string">"aabbxx"</span>,</div><div class="line">    <span class="string">"title"</span>: <span class="string">"test titile"</span>,</div><div class="line">    <span class="string">"authors"</span>: [</div><div class="line">      <span class="string">"bob"</span>,</div><div class="line">      <span class="string">"aollen"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"price"</span>: <span class="string">"100"</span></div><div class="line">  &#125;</div><div class="line">]</div><div class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šçš„book</span></div><div class="line"> maojun@maojun-mbp $ curl -X GET http://localhost:8080/books/aabbxx</div><div class="line">&#123;</div><div class="line">  <span class="string">"isbn"</span>: <span class="string">"aabbxx"</span>,</div><div class="line">  <span class="string">"title"</span>: <span class="string">"test titile"</span>,</div><div class="line">  <span class="string">"authors"</span>: [</div><div class="line">    <span class="string">"bob"</span>,</div><div class="line">    <span class="string">"aollen"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"price"</span>: <span class="string">"100"</span></div><div class="line">&#125;</div><div class="line"><span class="comment"># æ›´æ–°æŒ‡å®šçš„book</span></div><div class="line"> maojun@maojun-mbp $ curl -X PUT \</div><div class="line">&gt;   http://localhost:8080/books/aabbxx \</div><div class="line">&gt;   -H <span class="string">'content-type: application/json'</span> \</div><div class="line">&gt;   <span class="_">-d</span> <span class="string">'&#123;"isbn": "aabbxx", "price": "99"&#125;'</span></div><div class="line"><span class="comment"># åˆ é™¤æŒ‡å®šçš„book</span></div><div class="line"> âœ˜ maojun@maojun-mbp $ curl -X DELETE http://localhost:8080/books/aabbxx</div></pre></td></tr></table></figure></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://docs.mongodb.com/manual/" target="_blank" rel="external">mongodbä½¿ç”¨æ‰‹å†Œ</a><br><a href="https://www.mongodb.com/zh/mongodb-architecture" target="_blank" rel="external">mongodbæ¶æ„æ–‡æ¡£</a><br><a href="http://www.runoob.com/mongodb/mongodb-tutorial.html" target="_blank" rel="external">èœé¸Ÿå­¦é™¢mongodbæ•™ç¨‹</a><br><a href="http://labix.org/mgo" target="_blank" rel="external">mgoæ–‡æ¡£</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¸Šç¯‡åšå®¢ä¸­ä»‹ç»äº†NoSQLä»¥åŠæ–‡æ¡£æ•°æ®åº“, è¿™ç¯‡åšå®¢ä»‹ç»å½“ä¸‹æœ€æµè¡Œçš„æ–‡æ¡£æ•°æ®åº“:MongoDBã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="mongodb" scheme="https://blog.yumaojun.net/tags/mongodb/"/>
    
  </entry>
  
  <entry>
    <title>æ„å»ºGolangç¨‹åºæœ€å°Dockeré•œåƒ</title>
    <link href="https://blog.yumaojun.net/2017/11/20/golang-mini-docker-image/"/>
    <id>https://blog.yumaojun.net/2017/11/20/golang-mini-docker-image/</id>
    <published>2017-11-20T01:26:22.000Z</published>
    <updated>2017-11-20T14:50:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>åº”ç”¨å®¹å™¨åŒ–æ–¹ä¾¿äº†éƒ¨ç½²ï¼Œé¿å…å®é™…ä¸­å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´è€Œå¯¼è‡´çš„éƒ¨ç½²å›°éš¾, è€Œä¸”ï¼Œå®¹å™¨åŒ–ä¹‹åè¿˜å¯ä»¥å¯¹åº”ç”¨æ‰€ä½¿ç”¨çš„CPUã€å†…å­˜ç­‰èµ„æºåšé™åˆ¶ï¼Œè¿™äº›éƒ½æ˜¯å®¹å™¨åŒ–ä¹‹åçš„å¯ä»¥å¸¦æ¥çš„æ–¹ä¾¿ã€‚è¿™ç¯‡æ–‡ç« å°†ä¼šå°†å¦‚ä½•build Dockeré•œåƒ(æœ€å°åŒ–build), å®¹å™¨åŒ–ä½ çš„Golangåº”ç”¨ã€‚<br><a id="more"></a></p>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦æ„å»ºå°çš„é•œåƒ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æ„å»ºå°çš„é•œåƒ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æ„å»ºå°çš„é•œåƒ"></a>ä¸ºä»€ä¹ˆéœ€è¦æ„å»ºå°çš„é•œåƒ</h2><p>æˆ‘ä»¬çŸ¥é“æ„å»ºä¸€ä¸ªDockeré•œåƒçš„æ—¶å€™å¾€å¾€éœ€è¦å¼•å…¥ä¸€äº›ç¨‹åºä¾èµ–çš„ä¸œè¥¿ï¼Œæœ€å¸¸è§çš„å°±æ˜¯å¼•å…¥ä¸€ä¸ªåŸºç¡€æ“ä½œç³»ç»Ÿé•œåƒï¼Œä½†è¿™æ ·å¾€å¾€ä¼šä½¿å¾—ç¼–è¯‘å‡ºæ¥çš„é•œåƒç‰¹åˆ«å¤§ã€‚å°±æ‹¿Pythonæ¥è¯´, ä¹‹å‰buildçš„é•œåƒä¸€èˆ¬éƒ½å¤§äº600M, å¦‚æœè¿™ä¸ªé¡¹ç›®æ˜¯å†…éƒ¨é¡¹ç›®, å…¶å®é—®é¢˜ä¸å¤§, å› ä¸ºå†…ç½‘ä¸€èˆ¬ä¹Ÿä¼šæ­å»ºé•œåƒä»“åº“, å†…ç½‘æ•°æ®ä¹Ÿå¿«, ä½†æ˜¯å¦‚æœæ˜¯å¼€æºé¡¹ç›®, é•œåƒè¿‡å¤§å°±æ˜¯ä¸ªé—®é¢˜ã€‚å¯¹æ‹‰å–è€…å¸¦å®½è¦æ±‚è¾ƒé«˜, è€ŒDocker hubçš„é€Ÿåº¦å¤§å®¶ä¹Ÿéƒ½çŸ¥é“, å½“ç„¶å¦‚æœä½ ä½¿ç”¨é•œåƒåŠ é€Ÿä½“éªŒä¼šå¥½å¾ˆå¤šã€‚ä½†æ˜¯å¦‚æœèƒ½åšåˆ°æŠŠé•œåƒå˜å°, åšåˆ°å‡ M, å‡ åMé‚£ä¹ˆå¯¹äºä½ é¡¹ç›®çš„ä½¿ç”¨è€…æ¥è¯´ä½“éªŒä¼šå¥½å¾ˆå¤š.</p>
<p>å› ä¸ºGoæ˜¯é™æ€ç¼–è¯‘è¯­è¨€, å¯ä»¥åšåˆ°0ä¾èµ–, å› æ­¤å¯ä»¥æ„å»ºå¾ˆå°çš„ç¨‹åºé•œåƒ, ä½†æ˜¯å…¶å®è¿˜æ˜¯æœ‰äº›å°æ’æ›², è¿™ä¹Ÿå°±æ˜¯è¿™ç¯‡æ–‡ç« å‡ºç°çš„åŸå› .</p>
<h2 id="ç¨‹åºæ ·ä¾‹"><a href="#ç¨‹åºæ ·ä¾‹" class="headerlink" title="ç¨‹åºæ ·ä¾‹"></a>ç¨‹åºæ ·ä¾‹</h2><p>è¿™é‡Œä»¥ä¸€ä¸ªç®€å•çš„hello worldçš„WEB APIç¨‹åºä¸ºä¾‹:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// greeter hello world example</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">greeter</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"hello world!"</span>))</div><div class="line">	w.WriteHeader(http.StatusOK)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/"</span>, greeter)</div><div class="line">	addr := <span class="string">"0.0.0.0:8080"</span></div><div class="line">	log.Printf(<span class="string">"start service at: %s ... \n"</span>, addr)</div><div class="line">	err := http.ListenAndServe(addr, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"ListenAndServe: "</span>, err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æœ€ç»ˆä¼šæŠŠè¿™ä¸ªç¨‹åºæ‰“åŒ…æˆä¸€ä¸ªæœ€å°çš„dockeré•œåƒè¿›è¡Œå‘å¸ƒ, è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ ·ä¸€ä¸ªé•œåƒbuildå‡ºæ¥è¿‡ååˆ°åº•æœ‰å¤šå¤§ã€‚</p>
<h2 id="ç¼–è¯‘æ—¶çš„é—®é¢˜"><a href="#ç¼–è¯‘æ—¶çš„é—®é¢˜" class="headerlink" title="ç¼–è¯‘æ—¶çš„é—®é¢˜"></a>ç¼–è¯‘æ—¶çš„é—®é¢˜</h2><p>ç¼–è¯‘æ—¶çš„ä¸»è¦é—®é¢˜å°±æ˜¯å¦‚æœå°†Golangç¨‹åºç¼–è¯‘æˆä¸€ä¸ªçœŸæ­£æ²¡æœ‰ä¾èµ–çš„äºŒè¿›åˆ¶ç¨‹åº, ä¹Ÿè®¸æœ‰äººä¼šé—®Goæœ¬èº«ä¸å°±æ˜¯é™æ€ç¼–è¯‘å—ï¼Ÿè¿™é‡Œå°±éœ€è¦èŠèŠGolangé‡Œé¢CGOäº†ã€‚</p>
<ol>
<li><p>å…³äº<code>-installsuffix cgo</code>å‚æ•°<br>Go1.5ç‰ˆæœ¬ä¹‹å‰ï¼ŒGoé‡Œé¢çš„ä¸€äº›åº“å‡½æ•°æ˜¯ç”¨Cå®ç°çš„(ç½‘ç»œæ–¹é¢çš„å±…å¤š), ä¹Ÿå°±æ˜¯CGOã€‚å¦‚æœä½ çš„ä»£ç ä¸­ä½¿ç”¨äº†è¿™äº›Cå®ç°çš„åº“å‡½æ•°ï¼Œé‚£ä½ å°±è¦åŠ ä¸Š<code>-installsuffix cgo</code>è¿™ä¸ªå‚æ•°ï¼Œè®©å®ƒç¼–è¯‘çš„æ—¶å€™å»CGOé‡Œé¢æ‰¾ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ã€‚ä½†æ˜¯Go1.5ç‰ˆæœ¬å¼€å§‹å®ç°äº†è‡ªä¸¾ï¼Œæ‰€æœ‰çš„æ ‡å‡†åº“éƒ½æ˜¯ç”¨Goä»£ç å®ç°ï¼Œå°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜äº†ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ çš„Goç‰ˆæœ¬æ˜¯1.5ä¹‹å‰çš„ï¼Œæœ€å¥½åŠ ä¸Šè¿™ä¸ªå‚æ•°ï¼Œå½“ç„¶å¦‚æœä½ çš„ä»£ç ä¸­æ²¡ç”¨ä½¿ç”¨Cå®ç°çš„åº“ï¼Œé‚£ä¸åŠ ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚å¦‚æœä½ çš„Goæ˜¯1.5åŠä¹‹åçš„ç‰ˆæœ¬ï¼Œå°±ä¸éœ€è¦å†åŠ è¿™ä¸ªå‚æ•°äº†ã€‚</p>
</li>
<li><p>å…³äº<code>CGO_ENABLED=0</code>å‚æ•°<br>CGO_ENABLED=0è¡¨ç¤ºé™æ€ç¼–è¯‘cgo, ä¸ä¼šlinkç³»ç»Ÿä¸Šçš„ä¸€äº›åŠ¨æ€é“¾æ¥åº“, å¦‚æœæƒ³è¦ç¼–è¯‘çš„äºŒè¿›åˆ¶åŒ…æ­£åœ¨æ— ä¾èµ–, è¿™éœ€è¦ç¦ç”¨CGO</p>
</li>
</ol>
<p>æœ‰äº†ä¸Šé¢2ç‚¹, æˆ‘ä»¬ä¸€èˆ¬ä¼šè¿™æ ·buildæˆ‘ä»¬çš„ç¨‹åº:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å¦‚æœGolang&lt;1.5</span></div><div class="line">CGO_ENABLED=0 GOOS=linux go build <span class="_">-a</span> -v -installsuffix cgo -o app .</div><div class="line"><span class="comment"># å¦‚æœGolang&gt;1.5</span></div><div class="line">CGO_ENABLED=0 GOOS=linux go build <span class="_">-a</span> -v -o app .</div></pre></td></tr></table></figure></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">maojun@maojun-mbp $ du -sh app</div><div class="line">5.8M	app</div></pre></td></tr></table></figure>
<p>è¿™æ ·æˆ‘ä»¬å°±ç¼–è¯‘å¥½äº†ä¸€ä¸ª0ä¾èµ–çš„äºŒè¿›åˆ¶åŒ…, æ‰“å‡ºæ¥çš„åŒ…5.8M, æ¥ä¸‹æ¥æˆ‘ä»¬å°†åŸºäºå®ƒåˆ¶é€ dockeré•œåƒã€‚</p>
<h2 id="å¦‚ä½•é€‰æ‹©é•œåƒçš„Baseä¾èµ–"><a href="#å¦‚ä½•é€‰æ‹©é•œåƒçš„Baseä¾èµ–" class="headerlink" title="å¦‚ä½•é€‰æ‹©é•œåƒçš„Baseä¾èµ–"></a>å¦‚ä½•é€‰æ‹©é•œåƒçš„Baseä¾èµ–</h2><p>åœ¨é€‰æ‹©æˆ‘ä»¬æ‰“åŒ…å¥½çš„äºŒè¿›åˆ¶åŒ…çš„è¿è¡Œä¾èµ–æ—¶, æˆ‘ä¸€èˆ¬ä¼šæœ‰è¿™3ç§è€ƒè™‘:</p>
<ul>
<li>scratch: å®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒ, å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç©ºé•œåƒã€‚ä½†æ˜¯å®ƒå´æ˜¯éå¸¸é‡è¦ã€‚æˆ‘ä»¬çŸ¥é“Dockerfileæ–‡ä»¶å¿…é¡»ä»¥FROMå¼€å¤´ï¼Œä½†å¦‚æœæˆ‘ä»¬çš„é•œåƒçœŸçš„æ˜¯ä¸ä¾èµ–ä»»ä½•å…¶ä»–ä¸œè¥¿çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥FROM scratchã€‚åœ¨Docker 1.5.0ä¹‹åï¼ŒFROM scratchå·²ç»å˜æˆä¸€ä¸ªç©ºæ“ä½œ(no-op)ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¼šå†å•ç‹¬å ä¸€å±‚äº†, å½“ç„¶ä¾èµ–è¿™å±‚çš„å¤§å°ä¹Ÿå°±ä¸º0äº†, å› æ­¤åŸºäºæ­¤å¯ä»¥æ„å»ºæœ€å°é•œåƒã€‚</li>
<li>alpine: Alpine Linuxæ˜¯ä¸€ä¸ªç¤¾åŒºå¼€å‘çš„é¢å‘å®‰å…¨åº”ç”¨çš„è½»é‡çº§Linuxå‘è¡Œç‰ˆ, é€‚åˆç”¨æ¥åšDockeré•œåƒã€è·¯ç”±å™¨ã€é˜²ç«å¢™ã€VPNsã€VoIP ç›’å­ ä»¥åŠæœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿï¼ŒåŸºäº<code>uClibc</code>å’Œ<code>Busybox</code>, å¤§å°åªæœ‰3.97Mã€‚</li>
<li>ubuntu: è¿™ä¸ªä¸ç”¨å¤šåšä»‹ç»äº†, å¦‚æœä½ ä¿¡ä¸è¿‡alpineè¿™ä¹Ÿç®—ä¸€ä¸ªä¸é”™çš„é€‰æ‹©, ubuntu16.04çš„é•œåƒå¤§å°ä¸º128Mã€‚</li>
</ul>
<p>æˆ‘ä»¬é€‰æ‹©<code>alpine</code>ä½œä¸ºbaseä¾èµ–, å› ä¸ºå®ƒè¶³å¤Ÿå°, è€Œä¸”æ˜¯ä¸€ä¸ªlinux, æœ‰shellç¯å¢ƒ, ä»¥å¤‡æœ‰æ—¶éœ€è¦è¿›å…¥å®¹å™¨ã€‚å®Œæ•´çš„Dockerfileå¦‚ä¸‹:<br><figure class="highlight docker"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> alpine:latest</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> app /</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/app"</span>]</span></div></pre></td></tr></table></figure></p>
<h2 id="æœ€ç»ˆé•œåƒå¤§å°"><a href="#æœ€ç»ˆé•œåƒå¤§å°" class="headerlink" title="æœ€ç»ˆé•œåƒå¤§å°"></a>æœ€ç»ˆé•œåƒå¤§å°</h2><p>åŸºäºåˆšæ‰å†™å¥½çš„dockerfileè¿›è¡Œbuild:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> maojun@maojun-mbp $ docker build -t app:v0.0.1 .</div><div class="line">Sending build context to Docker daemon  6.094MB</div><div class="line">Step 1/3 : FROM alpine:latest</div><div class="line"> ---&gt; 053cde6e8953</div><div class="line">Step 2/3 : ADD app /</div><div class="line"> ---&gt; 765750f573f1</div><div class="line">Step 3/3 : CMD /app</div><div class="line"> ---&gt; Running <span class="keyword">in</span> cb62cfd2ad1e</div><div class="line"> ---&gt; 188a3189d4f8</div><div class="line">Removing intermediate container cb62cfd2ad1e</div><div class="line">Successfully built 188a3189d4f8</div><div class="line">Successfully tagged app:v0.0.1</div></pre></td></tr></table></figure></p>
<p>buildå‡ºæ¥çš„imageå¤§å°:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app                              v0.0.1              188a3189d4f8        2 minutes ago       10.1MB</div></pre></td></tr></table></figure></p>
<p>æœ€åæˆ‘ä»¬æµ‹è¯•ä¸‹buildçš„é•œåƒæ˜¯å¦å¯ä»¥æ­£å¸¸ä½¿ç”¨:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> maojun@maojun-mbp $ docker run -itd -p 8080:8080 app:v0.0.1</div><div class="line">9fe96a7868679f8be4e34905755dcd93343a70b9a0424791de2482647e69b2d8</div><div class="line"> maojun@maojun-mbp $ docker ps</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</div><div class="line">9fe96a786867        app:v0.0.1          <span class="string">"/app"</span>                   4 seconds ago       Up 2 seconds        0.0.0.0:8080-&gt;8080/tcp   hungry_kilby</div><div class="line"> maojun@maojun-mbp $ curl localhost:8080</div><div class="line">hello world!%</div></pre></td></tr></table></figure></p>
<p>æœ€ç»ˆé•œåƒå¤§å°: 10.1M, å¹¶ä¸”å¸¦æœ‰shell, å¦‚æœä½ ä½¿ç”¨<code>scratch</code>æ„å»ºä¼°è®¡åªæœ‰6Må¤šç‚¹, ä½†æ˜¯å®ç”¨æ€§å¯èƒ½ä¼šæœ‰æ‰€é™ä½ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åº”ç”¨å®¹å™¨åŒ–æ–¹ä¾¿äº†éƒ¨ç½²ï¼Œé¿å…å®é™…ä¸­å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´è€Œå¯¼è‡´çš„éƒ¨ç½²å›°éš¾, è€Œä¸”ï¼Œå®¹å™¨åŒ–ä¹‹åè¿˜å¯ä»¥å¯¹åº”ç”¨æ‰€ä½¿ç”¨çš„CPUã€å†…å­˜ç­‰èµ„æºåšé™åˆ¶ï¼Œè¿™äº›éƒ½æ˜¯å®¹å™¨åŒ–ä¹‹åçš„å¯ä»¥å¸¦æ¥çš„æ–¹ä¾¿ã€‚è¿™ç¯‡æ–‡ç« å°†ä¼šå°†å¦‚ä½•build Dockeré•œåƒ(æœ€å°åŒ–build), å®¹å™¨åŒ–ä½ çš„Golangåº”ç”¨ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="build" scheme="https://blog.yumaojun.net/tags/build/"/>
    
  </entry>
  
  <entry>
    <title>Golangç¨‹åºç‰ˆæœ¬ç®¡ç†</title>
    <link href="https://blog.yumaojun.net/2017/11/19/golang-cli-version/"/>
    <id>https://blog.yumaojun.net/2017/11/19/golang-cli-version/</id>
    <published>2017-11-19T06:45:15.000Z</published>
    <updated>2017-11-19T15:32:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>é¡¹ç›®åœ¨å®Œæˆåå¾€å¾€éƒ½éœ€è¦ç‰ˆæœ¬åŒ–, è€ŒGolangé¡¹ç›®å¾€å¾€äº¤ä»˜çš„æ˜¯ç¼–è¯‘è¿‡åçš„äºŒè¿›åˆ¶åŒ…, å¦‚ä½•é€šè¿‡äºŒè¿›åˆ¶åŒ…çŸ¥é“é¡¹ç›®çš„ç‰ˆæœ¬, å°±åƒdockerçš„versionå‘½ä»¤ä¸€æ ·æ¥ ?<br><a id="more"></a></p>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬ç®¡ç†"><a href="#ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬ç®¡ç†" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬ç®¡ç†"></a>ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬ç®¡ç†</h2><p>ç‰ˆæœ¬ç®¡ç†ä¸»è¦ç”¨äºå¯¹è¿è¡Œç¨‹åºçš„ç‰ˆæœ¬è¿½è¸ª,ä»è€Œå¯ä»¥ç®¡ç†çº¿ä¸ŠæœåŠ¡çš„è¿è¡Œç‰ˆæœ¬,é¿å…å„ä¸ªç‰ˆæœ¬çš„æœåŠ¡ç¨‹åºæ··æ·†.è¿™é‡Œé€šå¸¸çš„åšæ³•ä¸ºåœ¨ç¨‹åºä¸­åŸ‹å…¥ç‰ˆæœ¬æ ‡å¿—,åŒæ—¶è¯¥ç‰ˆæœ¬å·ä¼šå¯¹åº”åˆ°gitä¸Šçš„tagæˆ–releaseç‰ˆæœ¬.ä»è€Œå¯¹çº¿ä¸ŠæœåŠ¡æ›´æ”¹æœ‰ä¸€ä¸ªæ›´å…¨é¢çš„ä¿¡æ¯è¯´æ˜ã€‚</p>
<p>æ¯”å¦‚dockerçš„ç‰ˆæœ¬ä¿¡æ¯:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> maojun@maojun-mbp $ docker version</div><div class="line">Client:</div><div class="line"> Version:      17.09.0-ce</div><div class="line"> API version:  1.32</div><div class="line"> Go version:   go1.8.3</div><div class="line"> Git commit:   afdb6d4</div><div class="line"> Built:        Tue Sep 26 22:40:09 2017</div><div class="line"> OS/Arch:      darwin/amd64</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="GUNé£æ ¼ç‰ˆæœ¬å‘½åæ–¹å¼å’Œè§„åˆ™"><a href="#GUNé£æ ¼ç‰ˆæœ¬å‘½åæ–¹å¼å’Œè§„åˆ™" class="headerlink" title="GUNé£æ ¼ç‰ˆæœ¬å‘½åæ–¹å¼å’Œè§„åˆ™"></a>GUNé£æ ¼ç‰ˆæœ¬å‘½åæ–¹å¼å’Œè§„åˆ™</h2><p>è¿™é‡Œå°†ä»‹ç»åŸºäºGNUé£æ ¼çš„ä¸€ç§ç‰ˆæœ¬å‘½åæ–¹å¼, è¿™ä¹Ÿæ˜¯å½“ä»Šä¸»æµçš„ç‰ˆæœ¬å‘½åæ–¹å¼, å¾ˆå¤šå¼€æºé¡¹ç›®çš„ç‰ˆæœ¬å‘½åéƒ½éµå¾ªæ­¤é£æ ¼ã€‚<br>GUNé£æ ¼ç‰ˆæœ¬å‘½åé£æ ¼:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Major_Version_Number.Minor_Version_Number[.Revision_Number[.Build_Number]] </div><div class="line">ä¸»ç‰ˆæœ¬å·.å­ç‰ˆæœ¬å·[.ä¿®æ­£ç‰ˆæœ¬å·[.ç¼–è¯‘ç‰ˆæœ¬å·]]</div><div class="line">ç¤ºä¾‹ : 1.2.1, 2.0, 5.0.0.build-13124</div></pre></td></tr></table></figure></p>
<ul>
<li>Major: å…·æœ‰ç›¸åŒåç§°ä½†ä¸åŒä¸»ç‰ˆæœ¬å·çš„ç¨‹åºé›†ä¸å¯äº’æ¢ã€‚ä¾‹å¦‚ï¼Œè¿™é€‚ç”¨äºå¯¹äº§å“çš„å¤§é‡é‡å†™ï¼Œè¿™äº›é‡å†™ä½¿å¾—æ— æ³•å®ç°å‘åå…¼å®¹æ€§ã€‚</li>
<li>Minor: å¦‚æœä¸¤ä¸ªç¨‹åºé›†çš„åç§°å’Œä¸»ç‰ˆæœ¬å·ç›¸åŒï¼Œè€Œæ¬¡ç‰ˆæœ¬å·ä¸åŒï¼Œè¿™æŒ‡ç¤ºæ˜¾è‘—å¢å¼ºï¼Œä½†ç…§é¡¾åˆ°äº†å‘åå…¼å®¹æ€§ã€‚ä¾‹å¦‚ï¼Œè¿™é€‚ç”¨äºäº§å“çš„ä¿®æ­£ç‰ˆæˆ–å®Œå…¨å‘åå…¼å®¹çš„æ–°ç‰ˆæœ¬ã€‚</li>
<li>Revision: åç§°ã€ä¸»ç‰ˆæœ¬å·å’Œæ¬¡ç‰ˆæœ¬å·éƒ½ç›¸åŒä½†ä¿®è®¢å·ä¸åŒçš„ç¨‹åºé›†åº”æ˜¯å®Œå…¨å¯äº’æ¢çš„ã€‚è¿™é€‚ç”¨äºä¿®å¤ä»¥å‰å‘å¸ƒçš„ç¨‹åºé›†ä¸­çš„å®‰å…¨æ¼æ´ã€‚</li>
<li>Build: å†…éƒ¨ç‰ˆæœ¬å·çš„ä¸åŒè¡¨ç¤ºå¯¹ç›¸åŒæºæ‰€ä½œçš„é‡æ–°ç¼–è¯‘ã€‚è¿™é€‚åˆäºæ›´æ”¹å¤„ç†å™¨ã€å¹³å°æˆ–ç¼–è¯‘å™¨çš„æƒ…å†µã€‚</li>
</ul>
<p>ç‰ˆæœ¬å·çš„å˜åŒ–ä¸€èˆ¬éµå¾ªå¦‚ä¸‹è§„åˆ™:</p>
<ul>
<li>é¡¹ç›®åˆç‰ˆæœ¬   : ç‰ˆæœ¬å·å¯ä»¥ä¸º 0.1 æˆ– 0.1.0, ä¹Ÿå¯ä»¥ä¸º 1.0 æˆ– 1.0.0.</li>
<li>ä¿®æ­£ç‰ˆæœ¬å·å¢åŠ : å½“é¡¹ç›®åœ¨è¿›è¡Œäº†å±€éƒ¨ä¿®æ”¹æˆ– bug ä¿®æ­£æ—¶ï¼Œä¸»ç‰ˆæœ¬å·å’Œå­ç‰ˆæœ¬å·éƒ½ä¸å˜,ä¿®æ­£ç‰ˆæœ¬å·åŠ 1.</li>
<li>å­ç‰ˆæœ¬å·å¢åŠ   : å½“é¡¹ç›®åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šå¢åŠ äº†éƒ¨åˆ†åŠŸèƒ½æ—¶ï¼Œä¸»ç‰ˆæœ¬å·ä¸å˜ï¼Œå­ç‰ˆæœ¬å·åŠ  1ï¼Œä¿®æ­£ç‰ˆæœ¬å·å¤ä½ä¸º 0ï¼Œå› è€Œå¯ä»¥è¢«å¿½ç•¥æ‰.</li>
<li>ä¸»ç‰ˆæœ¬å·å¢åŠ   : å½“é¡¹ç›®åœ¨è¿›è¡Œäº†é‡å¤§ä¿®æ”¹æˆ–å±€éƒ¨ä¿®æ­£ç´¯ç§¯è¾ƒå¤šï¼Œè€Œå¯¼è‡´é¡¹ç›®æ•´ä½“å‘ç”Ÿå…¨å±€å˜åŒ–æ—¶.</li>
<li>ç¼–è¯‘ç‰ˆæœ¬å·å˜åŒ– : ç¼–è¯‘ç‰ˆæœ¬å·ä¸€èˆ¬æ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬åªå®šä¹‰å…¶æ ¼å¼ï¼Œå¹¶ä¸è¿›è¡Œäººä¸ºæ§åˆ¶</li>
</ul>
<h2 id="å¦‚ä½•åŸ‹å…¥ç‰ˆæœ¬ä¿¡æ¯"><a href="#å¦‚ä½•åŸ‹å…¥ç‰ˆæœ¬ä¿¡æ¯" class="headerlink" title="å¦‚ä½•åŸ‹å…¥ç‰ˆæœ¬ä¿¡æ¯"></a>å¦‚ä½•åŸ‹å…¥ç‰ˆæœ¬ä¿¡æ¯</h2><p>å†™C/C++ä»£ç æ—¶ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­é¢„å®šä¹‰ä¸€äº›ç‰ˆæœ¬å®å®šä¹‰ï¼Œç„¶åå†ç¼–è¯‘æ—¶ä»å¤–éƒ¨ä¼ å…¥æ•°æ®ä½œä¸ºç‰ˆæœ¬å·, golangä»£ç ä¸æ”¯æŒå®å®šä¹‰, ä½†æ˜¯go buildæ—¶æä¾›äº†ä¸€ä¸ªä¸ä¹‹ç›¸ä¼¼çš„åŠŸèƒ½å‚æ•°:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-ldflags <span class="string">'flag list'</span></div><div class="line">	arguments to pass on each go tool link invocation.</div></pre></td></tr></table></figure></p>
<p>ç„¶åæŸ¥çœ‹<a href="https://golang.org/cmd/link/" target="_blank" rel="external">go tool linkçš„ç›¸å…³æ–‡æ¡£</a>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-X importpath.name=value</div><div class="line">	Set the value of the string variable <span class="keyword">in</span> importpath named name to value.</div><div class="line">	Note that before Go 1.5 this option took two separate arguments.</div><div class="line">	Now it takes one argument split on the first = sign.</div></pre></td></tr></table></figure></p>
<p>æŒ‰ç…§æ–‡æ¡£ä¸­çš„è¯´æ˜åº”è¯¥æ˜¯åœ¨buildæ—¶ï¼Œé€šè¿‡-ldflagsè®¾å®šlinkerçš„å‚æ•°ã€‚ ç„¶åå†é€šè¿‡linkerçš„-Xæ¥ä¿®æ”¹æŒ‡å®šè·¯å¾„ä¸‹é¢çš„å˜é‡å€¼<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"> </div><div class="line"><span class="keyword">import</span> ( </div><div class="line"> <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"> </div><div class="line"><span class="keyword">var</span> (</div><div class="line">    VERSION</div><div class="line">)</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123; </div><div class="line"> fmt.Printf(<span class="string">"Version:[%s]\n"</span>, VERSION)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘æ—¶ä¼ å…¥å˜é‡:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ go build -ldflags <span class="string">"-X main.VERSION=v1.0.0-alpha1"</span> main.go</div><div class="line">$ ./main</div><div class="line">Version:[v1.0.0-alpha1]</div></pre></td></tr></table></figure></p>
<h2 id="æœ€ç»ˆæ ·ä¾‹"><a href="#æœ€ç»ˆæ ·ä¾‹" class="headerlink" title="æœ€ç»ˆæ ·ä¾‹"></a>æœ€ç»ˆæ ·ä¾‹</h2><p>å¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨é¡¹ç›®å…¥å£æ–‡ä»¶å¤„åŸ‹å…¥ç‰ˆæœ¬ä¿¡æ¯, å¯¹é¡¹ç›®å…¥å£ä¾µå…¥å¤ªå¤§, å› æ­¤ä½ ä¼šçœ‹åˆ°ä¸€äº›å¥½çš„å¼€æºé¡¹ç›®ä¸‹éƒ½æœ‰ä¸€ä¸ªä¸“é—¨çš„versionåŒ…, ç”±å®ƒæ¥è´Ÿè´£æ¥æ”¶åŸ‹å…¥çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚</p>
<p>æœ€ç»ˆç¤ºä¾‹è¯·å‚è€ƒ: <a href="https://github.com/yumaojun03/golang/tree/master/version-example" target="_blank" rel="external">Golangç¨‹åºç‰ˆæœ¬ç®¡ç†ä»£ç ç¤ºä¾‹</a><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> maojun@maojun-mbp $ ./version-example -v</div><div class="line">Version   : v0.0.1-alpha.0</div><div class="line">Build Time: 2017-11-19 23:28:12</div><div class="line">Git Branch: master</div><div class="line">Git Commit: 83de09af3f96007726edd5b308ed989476b9f358</div><div class="line">Go Version: go1.9 linux/amd64</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¡¹ç›®åœ¨å®Œæˆåå¾€å¾€éƒ½éœ€è¦ç‰ˆæœ¬åŒ–, è€ŒGolangé¡¹ç›®å¾€å¾€äº¤ä»˜çš„æ˜¯ç¼–è¯‘è¿‡åçš„äºŒè¿›åˆ¶åŒ…, å¦‚ä½•é€šè¿‡äºŒè¿›åˆ¶åŒ…çŸ¥é“é¡¹ç›®çš„ç‰ˆæœ¬, å°±åƒdockerçš„versionå‘½ä»¤ä¸€æ ·æ¥ ?&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="build" scheme="https://blog.yumaojun.net/tags/build/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®åº“åˆ†ç±»ä»¥åŠNoSQLä»‹ç»</title>
    <link href="https://blog.yumaojun.net/2017/11/05/mongodb-introduce/"/>
    <id>https://blog.yumaojun.net/2017/11/05/mongodb-introduce/</id>
    <published>2017-11-05T08:59:52.000Z</published>
    <updated>2017-11-19T06:38:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç”±äºé¡¹ç›®éœ€è¦å­˜å‚¨ä¸€äº›æ— ç»“æ„çš„æ•°æ®, è¿™äº›æ•°æ®ä¸»è¦ä»¥æ–‡æœ¬ä¸ºä¸», åŒæ—¶è¿˜éœ€æ”¯æŒä¸€äº›æ–‡æœ¬åˆ†æ, å’‹ä¸€å¬ä¼¼ä¹ESæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©, ä½†æ˜¯è¿™äº›æ— ç»“æ„çš„æ•°æ®åŒæ—¶ä¹Ÿéœ€è¦è¢«ç®¡ç†, ä¹Ÿå°±æ˜¯è¿™äº›æ•°æ®å¯èƒ½ç»å¸¸å˜æ›´, è¡¡é‡å†ä¸‰, æœ€åè¿˜æ˜¯é€‰æ‹©äº†Mongo, æ¯•ç«Ÿç°é˜¶æ®µæ˜¯ä»¥æ•°æ®çš„å­˜å‚¨å’Œç®¡ç†ä¸ºä¸», åˆ†æå¹¶æ²¡æœ‰é‚£ä¹ˆå¼ºçš„éœ€æ±‚ã€‚æ•´ç¯‡æ–‡ç« ä»¥å¤§æ•°æ®å­˜å‚¨é—®é¢˜ä¸ºå¼•, ä¸€æ­¥æ­¥å¼•å‡ºNoSQLé¢†åŸŸæ–‡æ¡£æ•°æ®çš„ä»£è¡¨MongoDBã€‚<br><a id="more"></a></p>
<h2 id="å¤§æ•°æ®å­˜å‚¨é—®é¢˜"><a href="#å¤§æ•°æ®å­˜å‚¨é—®é¢˜" class="headerlink" title="å¤§æ•°æ®å­˜å‚¨é—®é¢˜"></a>å¤§æ•°æ®å­˜å‚¨é—®é¢˜</h2><p>E.F.Coddåœ¨1970å¹´é¦–æ¬¡æå‡ºäº†æ•°æ®åº“ç³»ç»Ÿçš„å…³ç³»æ¨¡å‹ï¼Œä»æ­¤å¼€åˆ›äº†æ•°æ®åº“å…³ç³»æ–¹æ³•å’Œå…³ç³»æ•°æ®ç†è®ºçš„ç ”ç©¶ï¼Œä¸ºæ•°æ®åº“æŠ€æœ¯å¥ å®šäº†ç†è®ºåŸºç¡€ï¼Œæ•°æ®åº“æŠ€æœ¯ä¹Ÿå¼€å§‹è“¬å‹ƒå‘å±•ã€‚è€Œéšç€å‡ å¤§æ•°æ®åº“å‚å•†é™†ç»­å‘å¸ƒçš„å•†ä¸šæ•°æ®åº“ç®¡ç†ç³»ç»Ÿå‡ ä¹éƒ½æ”¯æŒå…³ç³»æ•°æ®æ¨¡å‹ï¼Œæ•°æ®åº“æŠ€æœ¯é€æ¸ç»Ÿä¸€åˆ°ä»¥å…³ç³»å‹æ•°æ®åº“ä¸ºä¸»å¯¼ã€‚å…³ç³»æ¨¡å‹æœ‰æ‰å®çš„æ•°å­¦ç†è®ºåšåŸºç¡€, å¹¶ä¸”ç»è¿‡é•¿æ—¶é—´çš„å®è·µ, ä½¿å¾—å…¶åœ¨æ•°æ®å­˜å‚¨ä¸ç®¡ç†é¢†åŸŸå æ®ç»Ÿæ²»åœ°ä½ã€‚</p>
<p>2001å¹´åï¼Œäº’è”ç½‘æŠ€æœ¯è¿…é€Ÿå‘å±•ï¼Œæ•°æ®é‡è¿…é€Ÿè†¨èƒ€å¹¶å¹¶å¤§ï¼Œäººç±»é€æ­¥è¿›å…¥å¤§æ•°æ®æ—¶ä»£ã€‚å¤§æ•°æ®ç»™ä¼ ç»Ÿçš„æ•°æ®ç®¡ç†æ–¹å¼å¸¦æ¥äº†ä¸¥å³»çš„æŒ‘æˆ˜ï¼Œå…³ç³»å‹æ•°æ®åº“åœ¨å®¹é‡ï¼Œæ€§èƒ½ï¼Œæˆæœ¬ç­‰å¤šæ–¹é¢éƒ½éš¾ä»¥æ»¡è¶³å¤§æ•°æ®ç®¡ç†çš„éœ€æ±‚ã€‚NoSQLæ•°æ®åº“é€šè¿‡æŠ˜ä¸­å…³ç³»å‹æ•°æ®åº“ä¸¥æ ¼çš„æ•°æ®ä¸€è‡´æ€§ç®¡ç†ï¼Œåœ¨å¯æ‰©å±•æ€§ã€æ¨¡å‹çµæ´»æ€§ã€ç»æµæ€§å’Œè®¿é—®æ€§ç­‰æ–¹é¢è·å¾—äº†å¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œå¯ä»¥æ›´å¥½åœ°é€‚åº”å¤§æ•°æ®åº”ç”¨çš„éœ€æ±‚ï¼Œæˆä¸ºå¤§æ•°æ®æ—¶ä»£æœ€é‡è¦çš„æ•°æ®ç®¡ç†æŠ€æœ¯ã€‚</p>
<p>å›´ç»•å¤§æ•°æ®çš„å­˜å‚¨é—®é¢˜, æˆ‘ä»¬ä¾æ¬¡è®¨è®ºä¸‹æ•°æ®åº“çš„å‡ å¤§åˆ†ç±»: RDBMS, NewSQL, NoSQLã€‚</p>
<h3 id="RDBMS"><a href="#RDBMS" class="headerlink" title="RDBMS"></a>RDBMS</h3><p>åœ¨ç°ä»£çš„è®¡ç®—ç³»ç»Ÿä¸Šæ¯å¤©ç½‘ç»œä¸Šéƒ½ä¼šäº§ç”Ÿåºå¤§çš„æ•°æ®é‡ã€‚è¿™äº›æ•°æ®æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ç”±å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(RDMBSs)æ¥å¤„ç†ã€‚ 1970å¹´ E.F.Coddâ€™sæå‡ºçš„å…³ç³»æ¨¡å‹çš„è®ºæ–‡ â€œA relational model of data for large shared data banksâ€ï¼Œè¿™ä½¿å¾—æ•°æ®å»ºæ¨¡å’Œåº”ç”¨ç¨‹åºç¼–ç¨‹æ›´åŠ ç®€å•ã€‚<br>é€šè¿‡åº”ç”¨å®è·µè¯æ˜ï¼Œå…³ç³»æ¨¡å‹æ˜¯éå¸¸é€‚åˆäºå®¢æˆ·æœåŠ¡å™¨ç¼–ç¨‹ï¼Œè¿œè¿œè¶…å‡ºé¢„æœŸçš„åˆ©ç›Šï¼Œä»Šå¤©å®ƒæ˜¯ç»“æ„åŒ–æ•°æ®å­˜å‚¨åœ¨ç½‘ç»œå’Œå•†åŠ¡åº”ç”¨çš„ä¸»å¯¼æŠ€æœ¯ã€‚</p>
<blockquote>
<p>ä»€ä¹ˆæ˜¯RDBMSï¼Ÿ</p>
</blockquote>
<p>RDBMSå…¨ç§°æ˜¯<code>Relational Database Management System</code>, åŠå…³ç³»å‹æ•°æ®ç®¡ç†ç³»ç»Ÿ, ä»–é‡‡ç”¨å…³ç³»æ¨¡å‹æ¥å­˜å‚¨æ•°æ®,å…³ç³»æ¨¡å‹æ˜¯æŠŠå¤æ‚çš„æ•°æ®ç»“æ„å½’ç»“ä¸ºç®€å•çš„äºŒå…ƒå…³ç³»(å³äºŒç»´è¡¨æ ¼å½¢å¼), åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå¯¹æ•°æ®çš„æ“ä½œå‡ ä¹å…¨éƒ¨å»ºç«‹åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªå…³ç³»è¡¨æ ¼ä¸Šï¼Œé€šè¿‡å¯¹è¿™äº›å…³è”çš„è¡¨æ ¼åˆ†ç±»ã€åˆå¹¶ã€è¿æ¥æˆ–é€‰å–ç­‰è¿ç®—æ¥å®ç°æ•°æ®åº“çš„ç®¡ç†ã€‚</p>
<blockquote>
<p>å…³ç³»å‹æ•°æ®çš„ç‰¹ç‚¹(ACID)</p>
</blockquote>
<p>å…³ç³»å‹æ•°æ®åº“éµå¾ªACIDè§„åˆ™, ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„äº‹ç‰©æ¨¡å‹(transaction), äº‹ç‰©è¿™ä¸ªæ¦‚å¿µå’Œç°å®ä¸–ç•Œä¸­çš„äº¤æ˜“å¾ˆç±»ä¼¼, å®ƒæœ‰å¦‚ä¸‹4ä¸ªç‰¹æ€§:</p>
<ul>
<li>A(Atomicity)<br>åŸå­æ€§å¾ˆå®¹æ˜“ç†è§£ï¼Œä¹Ÿå°±æ˜¯è¯´äº‹åŠ¡é‡Œçš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨åšå®Œï¼Œè¦ä¹ˆéƒ½ä¸åšï¼Œäº‹åŠ¡æˆåŠŸçš„æ¡ä»¶æ˜¯äº‹åŠ¡é‡Œçš„æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸï¼Œåªè¦æœ‰ä¸€ä¸ªæ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å°±å¤±è´¥ï¼Œéœ€è¦å›æ»šã€‚<br>æ¯”å¦‚é“¶è¡Œè½¬è´¦ï¼Œä»Aè´¦æˆ·è½¬100å…ƒè‡³Bè´¦æˆ·ï¼Œåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š1ï¼‰ä»Aè´¦æˆ·å–100å…ƒï¼›2ï¼‰å­˜å…¥100å…ƒè‡³Bè´¦æˆ·ã€‚è¿™ä¸¤æ­¥è¦ä¹ˆä¸€èµ·å®Œæˆï¼Œè¦ä¹ˆä¸€èµ·ä¸å®Œæˆï¼Œå¦‚æœåªå®Œæˆç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥å¤±è´¥ï¼Œé’±ä¼šè«åå…¶å¦™å°‘äº†100å…ƒã€‚</li>
<li>C(Consistency)<br>ä¸€è‡´æ€§ä¹Ÿæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®åº“è¦ä¸€ç›´å¤„äºä¸€è‡´çš„çŠ¶æ€ï¼Œäº‹åŠ¡çš„è¿è¡Œä¸ä¼šæ”¹å˜æ•°æ®åº“åŸæœ¬çš„ä¸€è‡´æ€§çº¦æŸã€‚<br>ä¾‹å¦‚ç°æœ‰å®Œæ•´æ€§çº¦æŸa+b=10ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡æ”¹å˜äº†aï¼Œé‚£ä¹ˆå¿…é¡»å¾—æ”¹å˜bï¼Œä½¿å¾—äº‹åŠ¡ç»“æŸåä¾ç„¶æ»¡è¶³a+b=10ï¼Œå¦åˆ™äº‹åŠ¡å¤±è´¥ã€‚</li>
<li>I(Isolation)<br>æ‰€è°“çš„ç‹¬ç«‹æ€§æ˜¯æŒ‡å¹¶å‘çš„äº‹åŠ¡ä¹‹é—´ä¸ä¼šäº’ç›¸å½±å“ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡è¦è®¿é—®çš„æ•°æ®æ­£åœ¨è¢«å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹ï¼Œåªè¦å¦å¤–ä¸€ä¸ªäº‹åŠ¡æœªæäº¤ï¼Œå®ƒæ‰€è®¿é—®çš„æ•°æ®å°±ä¸å—æœªæäº¤äº‹åŠ¡çš„å½±å“ã€‚<br>æ¯”å¦‚ç°æœ‰æœ‰ä¸ªäº¤æ˜“æ˜¯ä»Aè´¦æˆ·è½¬100å…ƒè‡³Bè´¦æˆ·ï¼Œåœ¨è¿™ä¸ªäº¤æ˜“è¿˜æœªå®Œæˆçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ­¤æ—¶BæŸ¥è¯¢è‡ªå·±çš„è´¦æˆ·ï¼Œæ˜¯çœ‹ä¸åˆ°æ–°å¢åŠ çš„100å…ƒçš„ã€‚</li>
<li>D(Durability)<br>æŒä¹…æ€§æ˜¯æŒ‡ä¸€æ—¦äº‹åŠ¡æäº¤åï¼Œå®ƒæ‰€åšçš„ä¿®æ”¹å°†ä¼šæ°¸ä¹…çš„ä¿å­˜åœ¨æ•°æ®åº“ä¸Šï¼Œå³ä½¿å‡ºç°å®•æœºä¹Ÿä¸ä¼šä¸¢å¤±ã€‚<br>æ¯”å¦‚Aè´¦æˆ·æ”¶åˆ°äº†100å…ƒåˆ°è´¦, åªè¦åˆ°è´¦è¿™ä¸ªäº‹ç‰©å®Œæˆ, æ•°æ®å°±å·²ç»åˆ°æ•°æ®åº“é‡Œé¢äº†, å³ä½¿æ­¤æ—¶å®•æœºå¯¹Aç”¨æˆ·çš„èµ„äº§ä¹Ÿæ²¡æœ‰å½±å“ã€‚</li>
</ul>
<blockquote>
<p>å…¸å‹çš„äº§å“</p>
</blockquote>
<p>å…³ç³»å‹æ•°æ®åº“è¯ç”Ÿ40å¤šå¹´äº†ï¼Œä»ç†è®ºäº§ç”Ÿå‘å±•åˆ°ç°å®äº§å“, RDBMSå¾ˆå¤šäº§å“åº”è¯¥éƒ½æ˜¯è€³ç†Ÿèƒ½è¯¦çš„:</p>
<ul>
<li>Oracle</li>
<li>MySQL</li>
<li>PostgreSQL</li>
<li>SQLServer</li>
</ul>
<blockquote>
<p>å¤§æ•°æ®å­˜å‚¨æ—¶é¢ä¸´çš„é—®é¢˜</p>
</blockquote>
<p>å…³ç³»å‹æ•°æ®åº“ä¸¥æ ¼ACIDåŸåˆ™, å› æ­¤åœ¨æ‰©å±•æ€§ä¸Šè¡¨ç°ä¸æ˜¯ç‰¹åˆ«å¥½, é¢å¯¹å¤§è§„æ¨¡çš„æ•°æ®æ—¶, åœ¨è¯»å’Œå†™ä¸Šé¢ä¼šå‡ºç°ä¸¥é‡ç“¶é¢ˆã€‚æƒ³è¦æå‡å…¶æ€§èƒ½, å¾€å¾€éœ€è¦ä»ä¸šåŠ¡å±‚è¿›è¡Œå¤„ç†, è¿›è¡Œæ•°æ®çš„Shardingã€‚<br>shardingæœ‰2ä¸ªç»´åº¦: æ°´å¹³åˆ‡åˆ†å’Œå‚ç›´åˆ‡åˆ†:</p>
<ul>
<li>æ°´å¹³åˆ‡åˆ†: æ ¹æ®è¡¨ä¸­çš„æ•°æ®çš„é€»è¾‘å…³ç³»ï¼Œå°†åŒä¸€å¼ è¡¨çš„æ•°æ®ï¼ŒæŒ‰ç…§æŸç§æ¡ä»¶åˆ‡åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ä¸»æœºä¸Š</li>
<li>å‚ç›´åˆ‡åˆ†: æŒ‰ç…§ä¸åŒçš„è¡¨æˆ–è€…schemaï¼Œæ¥åˆ‡åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ä¸»æœºä¸Š</li>
</ul>
<p>åˆ‡ç‰‡(sharding)ä¼šå¢åŠ æ•´ä¸ªç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œè€Œä¸”åˆ‡ç‰‡æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ï¼Œä¸åº”ç”¨æœ¬èº«æœ‰è¿™å¯†åˆ‡çš„å…³ç³»ï¼Œæ‰€ä»¥å¯¹äºä¸ä½†å¢å¤§çš„æ•°æ®è€Œè¨€ï¼Œåˆ‡ç‰‡å¹¶ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³å¤§æ•°æ®å­˜å‚¨é—®é¢˜ã€‚</p>
<h3 id="NewSQL"><a href="#NewSQL" class="headerlink" title="NewSQL"></a>NewSQL</h3><p>ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®æƒ³è¦åšåˆ°é«˜æ‰©å±•, é«˜æ€§èƒ½, é«˜å¯é æ€§æ˜¯å¾ˆå¤æ‚çš„, ä½†æ˜¯å½“ä½ çš„ç¡®æƒ³è¦ä¸€ç§è¿™ç§æ ·çš„æ•°æ®åº“æ—¶, NewSQLå¯èƒ½æ˜¯ä½ ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚</p>
<blockquote>
<p>ä»€ä¹ˆæ˜¯NewSQLï¼Ÿ</p>
</blockquote>
<p>è¿™æ˜¯ä¸€ä¸ªä¸­é—´äº§ç‰©, æ˜¯ä¸€ç§å®Œå…¨ä¸åŒçš„æ•°æ®åº“æ¶æ„, NewSQLæœ¯è¯­æœ€æ—©åœ¨2011å¹´ç”±Matthew Aslettåˆ›é€ , NewSQLçš„è®¾è®¡ç«‹è¶³äºä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå¼•è¿›ä¸€äº›æ–°æŠ€æœ¯ï¼Œä»è€Œè¾¾åˆ°å¯æ‰©å±•å’Œé«˜æ€§èƒ½çš„ç›®çš„, è€Œç¼ºç‚¹æ˜¯æ²¡æœ‰æä¾›å¼ºä¸€è‡´æ€§, å®ƒä»¬ä¸å¯ä»¥è¢«ä½¿ç”¨åœ¨å¼ºä¸€è‡´æ€§ç¯å¢ƒä¸‹ã€‚<br>NewSQLå…·æœ‰NoSQLçš„æµ·é‡æ•°æ®å­˜å‚¨ç®¡ç†èƒ½åŠ›,åŒæ—¶è¿˜æ”¯æŒä¼ ç»Ÿæ•°æ®åº“çš„ACIDå’ŒSQLèƒ½åŠ›(å•ä¸ªèŠ‚ç‚¹ä¸Šçš„ACIDèƒ½åŠ›), ä½†æ˜¯åœ¨ç°å®ä½¿ç”¨ä¸­è¿˜æ²¡æ™®åŠå¼€æ¥, è¿˜æ²¡è¢«å¤§è§„æ¨¡ä½¿ç”¨ã€‚</p>
<blockquote>
<p>NewSQLçš„ç‰¹ç‚¹</p>
</blockquote>
<p>NewSQLå…·ä½“å’ŒRDBMSä¸€æ ·çš„å•ä¸ªèŠ‚ç‚¹ä¸Šçš„ACIDèƒ½åŠ›, åŒæ—¶åˆå…·æœ‰NoSQLä¸€æ ·çš„å¾ˆå¼ºçš„æ‰©å±•èƒ½åŠ›(å®ƒåœ¨æ•´ä¸ªé›†ç¾¤ä¸Šéµå¾ªBASEè§„åˆ™, å…³äºBASEåœ¨åé¢NoSQLä¸­å†åšä»‹ç»)ã€‚</p>
<blockquote>
<p>å…¸å‹çš„NewSQLäº§å“</p>
</blockquote>
<p>æˆ‘è¿„ä»Šä¹Ÿæ²¡æœ‰ä½¿ç”¨è¿‡NewSQLäº§å“, ä»¥ä¸‹æ˜¯æˆ‘æ‰€çŸ¥çš„å…³äºNewSQLçš„ç»å…¸äº§å“:</p>
<ul>
<li>Google spanner: Googleçš„å…¨çƒçº§çš„åˆ†å¸ƒå¼æ•°æ®åº“(Globally-Distributed Database)</li>
<li>CockroachDB: å‚è€ƒGoole spannerå®ç°çš„å¼€æºç‰ˆ</li>
</ul>
<blockquote>
<p>å¦‚ä½•è§£å†³å¤§æ•°æ®å­˜å‚¨é—®é¢˜ï¼Ÿ</p>
</blockquote>
<p>NewSQLåŸºäºNoSQLçš„BASEåŸåˆ™, æ„å»ºå¯ä»¥æ¨ªå‘æ‰©å±•çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è§£å†³å¤§æ•°æ®çš„å­˜å‚¨å’Œç®¡ç†é—®é¢˜ã€‚</p>
<h3 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h3><p>ä»Šå¤©æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹å¹³å°(å¦‚ï¼šGoogle,Facebookç­‰), å¯ä»¥å¾ˆå®¹æ˜“çš„è®¿é—®å’ŒæŠ“å–æ•°æ®ã€‚ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ï¼Œç¤¾äº¤ç½‘ç»œï¼Œåœ°ç†ä½ç½®ï¼Œç”¨æˆ·ç”Ÿæˆçš„æ•°æ®å’Œç”¨æˆ·æ“ä½œæ—¥å¿—å·²ç»æˆå€çš„å¢åŠ ã€‚æˆ‘ä»¬å¦‚æœè¦å¯¹è¿™äº›ç”¨æˆ·æ•°æ®è¿›è¡ŒæŒ–æ˜ï¼Œé‚£SQLæ•°æ®åº“å·²ç»ä¸é€‚åˆè¿™äº›åº”ç”¨äº†, NoSQLæ•°æ®åº“çš„å‘å±•ä¹Ÿå´èƒ½å¾ˆå¥½çš„å¤„ç†è¿™äº›å¤§çš„æ•°æ®ã€‚</p>
<blockquote>
<p>ä»€ä¹ˆæ˜¯NoSQLï¼Ÿ</p>
</blockquote>
<p>NoSQL(NoSQL = Not Only SQL)ï¼Œæ„å³â€œä¸ä»…ä»…æ˜¯SQLâ€ï¼Œæ˜¯ä¸€é¡¹å…¨æ–°çš„æ•°æ®åº“é©å‘½æ€§è¿åŠ¨ï¼Œæ—©æœŸå°±æœ‰äººæå‡ºï¼Œå‘å±•è‡³2009å¹´è¶‹åŠ¿è¶Šå‘é«˜æ¶¨ã€‚NoSQLçš„æ‹¥æŠ¤è€…ä»¬æå€¡è¿ç”¨éå…³ç³»å‹çš„æ•°æ®å­˜å‚¨ï¼Œç›¸å¯¹äºé“ºå¤©ç›–åœ°çš„å…³ç³»å‹æ•°æ®åº“è¿ç”¨ï¼Œè¿™ä¸€æ¦‚å¿µæ— ç–‘æ˜¯ä¸€ç§å…¨æ–°çš„æ€ç»´çš„æ³¨å…¥</p>
<blockquote>
<p>NoSQLçš„ç‰¹ç‚¹(BASE)</p>
</blockquote>
<p>BASEçš„å…¨ç§°æ˜¯Basically Available, Soft-state, Eventually Consistentã€‚ ç”±<code>Eric Brewer</code>å®šä¹‰ã€‚ACIDå¼ºè°ƒå¼ºä¸€è‡´æ€§(CAPä¸­çš„C), è€ŒBASEåˆ™å¼ºè°ƒåŸºæœ¬å¯ç”¨æ€§(CAPä¸­çš„Aï¼‰ï¼Œåœ¨BASEæ€æƒ³çš„æ‰©å±•ä¸‹ï¼Œå°±å‡ºç°äº†NoSQLã€‚<br>BASEæ˜¯NoSQLæ•°æ®åº“é€šå¸¸å¯¹å¯ç”¨æ€§åŠä¸€è‡´æ€§çš„å¼±è¦æ±‚åŸåˆ™:</p>
<ul>
<li>Basically Availble: åŸºæœ¬å¯ç”¨</li>
<li>Soft-state: è½¯çŠ¶æ€/æŸ”æ€§äº‹åŠ¡ã€‚ â€œSoft stateâ€ å¯ä»¥ç†è§£ä¸ºâ€æ— è¿æ¥â€çš„, è€Œ â€œHard stateâ€ æ˜¯â€é¢å‘è¿æ¥â€çš„</li>
<li>Eventual Consistency: æœ€ç»ˆä¸€è‡´æ€§ æœ€ç»ˆä¸€è‡´æ€§ï¼Œ ä¹Ÿæ˜¯æ˜¯ ACID çš„æœ€ç»ˆç›®çš„ã€‚</li>
</ul>
<p>BASEæ˜¯ç›¸å¯¹ACIDè€Œè¨€çš„, ä¸‹é¢æ˜¯å¯¹æ¯”è¡¨:</p>
<table>
<thead>
<tr>
<th style="text-align:left">ACID</th>
<th style="text-align:right">BASE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AåŸå­æ€§(Atomicity)</td>
<td style="text-align:right">åŸºæœ¬å¯ç”¨(Basically Available)</td>
</tr>
<tr>
<td style="text-align:left">ä¸€è‡´æ€§(Consistency)</td>
<td style="text-align:right">è½¯çŠ¶æ€/æŸ”æ€§äº‹åŠ¡(Soft state)</td>
</tr>
<tr>
<td style="text-align:left">éš”ç¦»æ€§(Isolation)</td>
<td style="text-align:right">æœ€ç»ˆä¸€è‡´æ€§ (Eventual consistency)</td>
</tr>
<tr>
<td style="text-align:left">æŒä¹…æ€§ (Durable)</td>
<td style="text-align:right">æ”¯æŒ</td>
</tr>
</tbody>
</table>
<blockquote>
<p>å…¸å‹çš„NoSQLäº§å“</p>
</blockquote>
<p>NoSQLæ˜¯å®ç°æ–¹å¼å„ä¸ç›¸åŒï¼Œä¸‹é¢ä¸»è¦ä»‹ç» ä¸»æµçš„NoSQLæµæ´¾, æƒ³è¦äº†è§£æ›´å…·ä½“çš„ä¿¡æ¯è¯·ç‚¹å‡»<a href="http://www.nosql-database.org/" target="_blank" rel="external">å…³äºæ‰€æœ‰NoSQLä»‹ç»çš„ä¸€ä¸ªç½‘ç«™</a>:</p>
<ul>
<li><p>åˆ—å¼æ•°æ®æ¨¡å‹<br>æ•°æ®æ¨¡å‹ï¼š çœ‹åˆ°ä¹Ÿæ˜¯è¡¨, ä½†æ˜¯ä¸æ”¯æŒé“¾æ¥æŸ¥è¯¢, å› ä¸ºæ•°æ®å­˜å‚¨ä»¥åˆ—ä¸ºå•ä½(column), è€Œå…³ç³»æ•°æ®åº“æ˜¯ä»¥è¡Œä¸ºå­˜å‚¨å•ä½çš„<br>åº”ç”¨åœºæ™¯ï¼š åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šæä¾›æ”¯æŒéšæœºè¯»å†™çš„åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨<br>å…¸å‹äº§å“ï¼š Hbaseã€ Hypertableã€ Bigtableã€ Cassandra<br>ä¼˜ç‚¹ï¼š å¿«é€ŸæŸ¥è¯¢ã€ é«˜æ‰©å±•æ€§ã€æ˜“äºå®ç°åˆ†å¸ƒå¼æ‰©å±•</p>
</li>
<li><p>æ–‡æ¡£æ•°æ®æ¨¡å‹ ï¼š<br>æ•°æ®æ¨¡å‹ï¼š ä»‹äºé”®å€¼å­˜å‚¨kv)å’Œå…³ç³»å‹å­˜å‚¨(row),æ¯ä¸€è¡Œæ•°æ®ç»„ç»‡ä¸ºä¸€ä¸ªæ–‡æ¡£, ä»¥æ–‡æ¡£ä¸ºå­˜å‚¨å•ä½<br>åº”ç”¨åœºæ™¯ï¼š éå¼ºäº‹ç‰©éœ€æ±‚çš„webåº”ç”¨<br>å…¸å‹äº§å“ï¼š MongoDBã€ ElasticSearch(å¼¹æ€§æœç´¢ï¼Œå­˜å‚¨webæ—¥å¿—)<br>ä¼˜ç‚¹ï¼šã€€æ•°æ®æ¨¡å‹æ— éœ€äº‹å…ˆå®šä¹‰</p>
</li>
<li><p>é”®å€¼æ•°æ®æ¨¡å‹ ï¼š<br>æ•°æ®æ¨¡å‹ï¼š æ¨¡å‹ç®€å•, æ˜“äºå®ç°, æ“ä½œç®€å•(get set del)<br>åº”ç”¨åœºæ™¯ï¼š å†…å®¹ç¼“å­˜, ç”¨äºå¤§é‡å¹¶è¡Œæ•°æ®è®¿é—®, é«˜è´Ÿè½½åœºæ™¯<br>åº”ç”¨äº§å“ï¼š  DynamoDB, Riak, Redis<br>ä¼˜ç‚¹ï¼š  hashçš„ä¼˜ç‚¹ï¼Œ æŸ¥è¯¢è¿…é€Ÿ</p>
</li>
<li><p>å›¾å¼æ•°æ®æ¨¡å‹ ï¼š<br>æ•°æ®æ¨¡å‹ï¼š å›¾å¼ç»“æ„<br>åº”ç”¨åœºæ™¯ï¼š ç¤¾äº¤ç½‘ç»œã€ æ¨èç³»ç»Ÿã€ å…³ç³»å›¾è°±<br>å…¸å‹äº§å“ï¼š Neo4J<br>ä¼˜ç‚¹ï¼š é€‚ç”¨äºå›¾å¼æŠ€æœ¯åœºæ™¯</p>
</li>
</ul>
<blockquote>
<p>å¦‚ä½•è§£å†³å¤§æ•°æ®å­˜å‚¨é—®é¢˜ï¼Ÿ</p>
</blockquote>
<p>é€šè¿‡åˆ†å¸ƒå¼è§£å†³</p>
<h3 id="RDBMS-vs-NoSQL"><a href="#RDBMS-vs-NoSQL" class="headerlink" title="RDBMS vs NoSQL"></a>RDBMS vs NoSQL</h3><p>RDBMSçš„ç‰¹ç‚¹:</p>
<ul>
<li>é«˜åº¦ç»„ç»‡åŒ–ç»“æ„åŒ–æ•°æ® </li>
<li>ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€</li>
<li>æ•°æ®å’Œå…³ç³»éƒ½å­˜å‚¨åœ¨å•ç‹¬çš„è¡¨ä¸­ã€‚ </li>
<li>æ•°æ®æ“çºµè¯­è¨€ï¼Œæ•°æ®å®šä¹‰è¯­è¨€ </li>
<li>ä¸¥æ ¼çš„ä¸€è‡´æ€§</li>
<li>åŸºäºäº‹åŠ¡</li>
</ul>
<p>NoSQLçš„ç‰¹ç‚¹: </p>
<ul>
<li>ä»£è¡¨ç€ä¸ä»…ä»…æ˜¯SQL</li>
<li>æ²¡æœ‰å£°æ˜æ€§æŸ¥è¯¢è¯­è¨€</li>
<li>æ²¡æœ‰é¢„å®šä¹‰çš„æ¨¡å¼, æ¶æ„çš„çµæ´»æ€§ï¼Œæ”¯æŒåŠç»“æ„åŒ–æ•°æ®</li>
<li>é”®å€¼å¯¹å­˜å‚¨ï¼Œåˆ—å­˜å‚¨ï¼Œæ–‡æ¡£å­˜å‚¨ï¼Œå›¾å½¢æ•°æ®åº“</li>
<li>æœ€ç»ˆä¸€è‡´æ€§ï¼Œè€ŒéACIDå±æ€§</li>
<li>éç»“æ„åŒ–å’Œä¸å¯é¢„çŸ¥çš„æ•°æ®</li>
<li>åˆ†å¸ƒå¼è®¡ç®—, CAPå®šç† </li>
<li>é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨æ€§å’Œå¯ä¼¸ç¼©æ€§, é«˜æ°´å¹³æ‰©å±•èƒ½åŠ›å’Œä½æˆæœ¬çš„ä½ç«¯ç¡¬ä»¶é›†ç¾¤</li>
<li>åŠŸèƒ½ç›¸å¯¹ç®€å•, æ²¡æœ‰ç»Ÿä¸€çš„æŸ¥è¯¢è¯­è¨€, æœ‰é™çš„æŸ¥è¯¢åŠŸèƒ½</li>
<li>æœ€ç»ˆä¸€è‡´æ˜¯ä¸ç›´è§‚çš„ç¨‹åº</li>
</ul>
<h2 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h2><p>å¯¹äºæ•°æ®æœ¬èº«è€Œè¨€, æˆ‘ä»¬å¾€å¾€å°†å…¶åˆ†ä¸ºç»“æ„åŒ–æ•°æ®, åŠç»“æ„åŒ–æ•°æ®, ä»¥åŠéç»“æ„åŒ–æ•°æ®, ä½†æ˜¯å¯¹äºå‚¨å­˜æ—¶æ•°æ®çš„ç»„ç»‡æˆ‘ä»¬æ‰ç§°å…¶ä¸ºæ•°æ®æ¨¡å‹, å¸¸è§çš„æ•°æ®æ¨¡å‹æœ‰: å…³ç³»æ¨¡å‹, æ–‡æ¡£æ¨¡å‹, å¥å€¼æ¨¡å‹, ä»¥åŠåˆ—å¼æ¨¡å¼ã€‚</p>
<h3 id="ç”¨æˆ·ä¾§æ•°æ®"><a href="#ç”¨æˆ·ä¾§æ•°æ®" class="headerlink" title="ç”¨æˆ·ä¾§æ•°æ®"></a>ç”¨æˆ·ä¾§æ•°æ®</h3><p>éšç€ç½‘ç»œæŠ€æœ¯çš„å‘å±•ï¼Œç‰¹åˆ«æ˜¯Internetå’ŒIntranetæŠ€æœ¯çš„é£å¿«å‘å±•ï¼Œä½¿å¾—éç»“æ„åŒ–æ•°æ®çš„æ•°é‡æ—¥è¶‹å¢å¤§ã€‚è¿™æ—¶ï¼Œä¸»è¦ç”¨äºç®¡ç†ç»“æ„åŒ–æ•°æ®çš„å…³ç³»æ•°æ®åº“çš„å±€é™æ€§æš´éœ²åœ°è¶Šæ¥è¶Šæ˜æ˜¾ã€‚å› è€Œï¼Œæ•°æ®åº“æŠ€æœ¯ç›¸åº”åœ°è¿›å…¥äº†â€œåå…³ç³»æ•°æ®åº“æ—¶ä»£â€ï¼Œå‘å±•è¿›å…¥åŸºäºç½‘ç»œåº”ç”¨çš„éç»“æ„åŒ–æ•°æ®åº“æ—¶ä»£ã€‚<br><img src="http://www.runoob.com/wp-content/uploads/2013/10/bigdata.png" alt=""></p>
<blockquote>
<p>ç»“æ„åŒ–æ•°æ®(structured data)</p>
</blockquote>
<p>ç»“æ„åŒ–æ•°æ®, å³è¡Œæ•°æ®,å­˜å‚¨åœ¨æ•°æ®åº“é‡Œ,å¯ä»¥ç”¨äºŒç»´è¡¨ç»“æ„æ¥é€»è¾‘è¡¨è¾¾å®ç°çš„æ•°æ®ã€‚<br>ç»“æ„åŒ–æ•°æ®, <code>å…ˆçŸ¥ç»“æ„, å†æœ‰æ•°æ®</code>ã€‚ æˆ‘ä»¬æ ¹æ®æ•°æ®çš„ç»“æ„é¢„å…ˆå»ºç«‹å¥½äºŒç»´è¡¨, ç­‰æ•°æ®æ¥çš„æ—¶å€™, å¡«å…¥å³å¯ã€‚å› æ­¤ç»“æ„åŒ–çš„æ•°æ®å¾€å¾€æ˜¯å¯å»ºæ¨¡, æ ‡å‡†åŒ–çš„æ•°æ®, ç»“æ„åŒ–çš„æ•°æ®å¾ˆæ–¹ä¾¿ç¨‹åºä½¿ç”¨, å› ä¸ºç»“æ„å·²çŸ¥ã€‚</p>
<p>ç»“æ„åŒ–æ•°æ®æœ€å¤§çš„é—®é¢˜, å°±å½“æ•°æ®çš„ç»“æ„å‘ç”Ÿå˜åŒ–æ—¶, æˆ‘ä»¬éœ€è¦è°ƒæ•´æ•°æ®çš„ç»“æ„, ä¸€èˆ¬å°±æ„å‘³ç€æ•°æ®åº“è¡¨ç»“æ„çš„éœ€è¦å˜åŠ¨ã€‚è¿™ä½¿å¾—æ•°æ®åœ¨å­˜å‚¨æ—¶æœ‰ä¸¥æ ¼çš„è¦æ±‚(éœ€è¦å®šä¹‰schema)ã€‚<br>ç»“æ„åŒ–æ•°æ®: å¯ä»¥è¢«æå‰å»ºæ¨¡çš„æ•°æ®(å®šä¹‰schema)</p>
<blockquote>
<p>åŠç»“æ„åŒ–æ•°æ®(semi-structured data)</p>
</blockquote>
<p>æ‰€è°“åŠç»“æ„åŒ–æ•°æ®ï¼Œå°±æ˜¯ä»‹äºå®Œå…¨ç»“æ„åŒ–æ•°æ®(å¦‚å…³ç³»å‹æ•°æ®åº“ã€é¢å‘å¯¹è±¡æ•°æ®åº“ä¸­çš„æ•°æ®)å’Œå®Œå…¨æ— ç»“æ„çš„æ•°æ®(å¦‚å£°éŸ³ã€å›¾åƒæ–‡ä»¶ç­‰)ä¹‹é—´çš„æ•°æ®ï¼ŒHTMLæ–‡æ¡£å°±å±äºåŠç»“æ„åŒ–æ•°æ®ã€‚å®ƒä¸€èˆ¬æ˜¯è‡ªæè¿°çš„ï¼Œæ•°æ®çš„ç»“æ„å’Œå†…å®¹æ··åœ¨ä¸€èµ·ï¼Œæ²¡æœ‰æ˜æ˜¾çš„åŒºåˆ†ã€‚<br>æ‰€ä»¥å¯¹äºåŠç»“æ„åŒ–çš„æ•°æ®, æ•°æ®çš„ç»“æ„è¦ç­‰æ•°æ®è·å¾—åæ‰çŸ¥é“, ä¹Ÿå°±æ˜¯<code>å…ˆæœ‰æ•°æ®, åçŸ¥ç»“æ„</code>ã€‚æ•´ä¸ªäº’è”ç½‘ä¸Šè¿™ç±»æ•°æ®æ˜¯å¾ˆå¤šçš„, å› ä¸ºhtmlå°±æ˜¯åŠç»“æ„åŒ–çš„æ•°æ®ã€‚</p>
<p>ç›¸å¯¹äºç»“æ„åŒ–çš„æ•°æ®, åŠç»“æ„åŒ–æ•°æ®æ— éœ€å®šä¹‰æ•°æ®çš„ç»“æ„(schema free), ä½¿å¾—å…¶åœ¨å­˜å‚¨ä¸Šè¡¨ç°å‡ºå¼ºå¤§çš„çµæ´»æ€§ã€‚<br>åŠç»“æ„åŒ–æ•°æ®:  HTML, JSON, XML</p>
<blockquote>
<p>éç»“æ„åŒ–æ•°æ®(unstructured data)</p>
</blockquote>
<p>ç›¸å¯¹äºç»“æ„åŒ–æ•°æ®è€Œè¨€ï¼Œä¸æ–¹ä¾¿ç”¨æ•°æ®åº“äºŒç»´é€»è¾‘è¡¨æ¥è¡¨ç°çš„æ•°æ®å³ç§°ä¸ºéç»“æ„åŒ–æ•°æ®ã€‚<br>éç»“æ„åŒ–æ•°æ®åº“æ˜¯æŒ‡å…¶å­—æ®µé•¿åº¦å¯å˜ï¼Œå¹¶ä¸”æ¯ä¸ªå­—æ®µçš„è®°å½•åˆå¯ä»¥ç”±å¯é‡å¤æˆ–ä¸å¯é‡å¤çš„å­å­—æ®µæ„æˆçš„æ•°æ®åº“ï¼Œç”¨å®ƒä¸ä»…å¯ä»¥å¤„ç†ç»“æ„åŒ–æ•°æ®(å¦‚æ•°å­—ã€ç¬¦å·ç­‰ä¿¡æ¯), è€Œä¸”æ›´é€‚åˆå¤„ç†éç»“æ„åŒ–æ•°æ®ï¼ˆå…¨æ–‡æ–‡æœ¬ã€å›¾è±¡ã€å£°éŸ³ã€å½±è§†ã€è¶…åª’ä½“ç­‰ä¿¡æ¯)ã€‚</p>
<p>éç»“æ„åŒ–WEBæ•°æ®åº“ä¸»è¦æ˜¯é’ˆå¯¹éç»“æ„åŒ–æ•°æ®è€Œäº§ç”Ÿçš„ï¼Œä¸ä»¥å¾€æµè¡Œçš„å…³ç³»æ•°æ®åº“ç›¸æ¯”ï¼Œå…¶æœ€å¤§åŒºåˆ«åœ¨äºå®ƒçªç ´äº†å…³ç³»æ•°æ®åº“ç»“æ„å®šä¹‰ä¸æ˜“æ”¹å˜å’Œæ•°æ®å®šé•¿çš„é™åˆ¶ï¼Œæ”¯æŒé‡å¤å­—æ®µã€å­å­—æ®µä»¥åŠå˜é•¿å­—æ®µå¹¶å®ç°äº†å¯¹å˜é•¿æ•°æ®å’Œé‡å¤å­—æ®µè¿›è¡Œå¤„ç†å’Œæ•°æ®é¡¹çš„å˜é•¿å­˜å‚¨ç®¡ç†ï¼Œåœ¨å¤„ç†è¿ç»­ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…¨æ–‡ä¿¡æ¯ï¼‰å’Œéç»“æ„åŒ–ä¿¡æ¯ï¼ˆåŒ…æ‹¬å„ç§å¤šåª’ä½“ä¿¡æ¯ï¼‰ä¸­æœ‰ç€ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“æ‰€æ— æ³•æ¯”æ‹Ÿçš„ä¼˜åŠ¿ã€‚<br>éç»“æ„åŒ–æ•°æ®: æ‰€æœ‰æ ¼å¼çš„åŠå…¬æ–‡æ¡£ã€æ–‡æœ¬ã€å›¾ç‰‡ã€XMLã€HTMLã€å„ç±»æŠ¥è¡¨ã€å›¾åƒå’ŒéŸ³é¢‘/è§†é¢‘ä¿¡æ¯ç­‰ç­‰ã€‚</p>
<h3 id="å­˜å‚¨æ—¶æ•°æ®"><a href="#å­˜å‚¨æ—¶æ•°æ®" class="headerlink" title="å­˜å‚¨æ—¶æ•°æ®"></a>å­˜å‚¨æ—¶æ•°æ®</h3><p>æ•°æ®å­˜å‚¨æ¨¡å‹å€¼æ•°æ®å­˜å‚¨æ—¶å¦‚ä½•ç»„ç»‡</p>
<h4 id="å…³ç³»æ¨¡å‹"><a href="#å…³ç³»æ¨¡å‹" class="headerlink" title="å…³ç³»æ¨¡å‹"></a>å…³ç³»æ¨¡å‹</h4><p>å…³ç³»æ¨¡å‹: æ–°å®šä¹‰åˆ—, ç„¶åé€šè¿‡è¡Œçš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨, ä»¥äºŒç»´è¡¨æ¥è¡¨ç¤ºå®ä½“ä¸å®ä½“ä¹‹é—´çš„è”ç³»ï¼Œåœ¨æ•°æ®å»ºæ¨¡æ—¶éœ€è¦å¯¹æ•°æ®å¯¹è±¡è¿›è¡Œæ‹†åˆ†ï¼Œå†å°†å„è‡ªçš„ä¿¡æ¯å­˜åˆ°å¯¹åº”çš„è¡¨é‡Œï¼Œåœ¨éœ€è¦æ—¶å†å°†å„ä¸ªè¡¨è¿æ¥èµ·æ¥ã€‚<br><img src="http://oiw1gzfww.bkt.clouddn.com/relationship_data.jpeg" alt=""></p>
<p>åœ¨å…³ç³»æ¨¡å‹å½“ä¸­ï¼Œå¤šä¸ªè¡¨ä¸­çš„ä¸åŒè®°å½•ç»å¸¸â€œäº¤é”™è¿æ¥â€ï¼Œä¸€äº›æ•°æ®ä¼šè¢«å¤šæ¡è®°å½•å…±äº«ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯å‡å°‘äº†é‡å¤æ•°æ®çš„å‡ºç°ï¼Œä½†æ˜¯è¿™æ ·ä¸å¥½çš„åœ°æ–¹å°±æ˜¯ä¸€æ—¦å…¶ä¸­æŸä¸€æ¡é“¾æ¥çš„è®°å½•å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆä¸å…¶ç›¸å…³çš„è®°å½•å’Œè¡¨éƒ½ä¼šè¢«é”ä½ä»¥é˜²æ­¢éä¸€è‡´æ€§çš„å‡ºç°ã€‚ ACIDäº‹åŠ¡åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­æ˜¯å¾ˆå¤æ‚çš„ï¼Œå› ä¸ºæ•°æ®ä¼šæ‰©æ•£ã€‚å³ä¾¿æ˜¯å•ä¸€æ¡è®°å½•ï¼Œè¿™å¤æ‚çš„å…±äº«æ•°æ®å†…éƒ¨å…³ç³»ç½‘çš„å­˜åœ¨ï¼Œä¹Ÿä½¿å¾—å…³ç³»å‹æ•°æ®åœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´çš„ä¼ é€’å˜å¾—å¤æ‚è€Œç¼“æ…¢ï¼ŒåŒæ—¶è®©è¯»å’Œå†™æ“ä½œçš„æ€§èƒ½å˜å·®ã€‚<br>å½“å­˜å‚¨ç©ºé—´æ˜‚è´µåˆç¨€å°‘æ—¶ï¼ŒæŠ˜ä¸­çš„æƒè¡¡æ–¹æ¡ˆæ˜¯å¾ˆå¿…è¦çš„ã€‚ç„¶è€Œï¼Œå¦‚ä»Šå­˜å‚¨ç©ºé—´çš„ä»·æ ¼è·Ÿ40å¹´å‰ç›¸æ¯”å·²ç»å¤§å¤§çš„ä¸‹é™äº†ï¼Œå¾ˆå¤šæ—¶å€™è®¡ç®—æŠ˜ä¸­æ–¹æ¡ˆå·²ç»å®Œå…¨æ²¡æœ‰å¿…è¦ã€‚ä½¿ç”¨æ›´å¤šçš„å­˜å‚¨ç©ºé—´æ¥æ¢å–æ›´å¥½çš„æ“ä½œæ€§èƒ½ï¼Œæˆ–è€…æ˜¯å°†å·¥ä½œè´Ÿè½½åˆ†é…åˆ°å¤šå°æœºå™¨ä¸Šï¼Œè¿™æ‰æ˜¯å¦‚ä»Šåº”ç”¨ä¸Šæ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h4 id="æ–‡æ¡£æ¨¡å‹"><a href="#æ–‡æ¡£æ¨¡å‹" class="headerlink" title="æ–‡æ¡£æ¨¡å‹"></a>æ–‡æ¡£æ¨¡å‹</h4><p>æ–‡æ¡£æ•°æ®: å°†ä¸€ä¸ªæ•°æ®è®°å½•(recordæˆ–è€…row)ä½œä¸ºå•ä½è¿›è¡Œå­˜å‚¨, æ— éœ€å®šä¹‰è¡Œã€‚ä¹Ÿå¯ä»¥è®¤ä¸ºä¸€ä¸ªæ–‡æ¡£å°±æ˜¯å…³ç³»æ•°æ®åº“çš„ä¸€è¡Œã€‚<br><img src="http://oiw1gzfww.bkt.clouddn.com/document_data.png" alt=""></p>
<p>ä½¿ç”¨â€œæ–‡æ¡£â€è¿™ä¸ªè¯ä¼¼ä¹è®©äººè§‰å¾—å¥‡æ€ªï¼Œä½†æ˜¯å…¶å®â€æ–‡æ¡£å‹æ•°æ®æ¨¡å‹â€çœŸçš„å’Œä¼ ç»Ÿæ„ä¹‰çš„æ–‡å­—â€æ–‡æ¡£â€æ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚ä»–ä¸æ˜¯ä¹¦ã€ä¿¡æˆ–è€…æ–‡ç« ï¼Œè¿™é‡Œè¯´çš„â€æ–‡æ¡£â€å…¶å®æ˜¯ä¸€ä¸ªæ•°æ®è®°å½•, è¿™ä¸ªè®°å½•èƒ½å¤Ÿå¯¹åŒ…å«çš„æ•°æ®ç±»å‹å’Œå†…å®¹è¿›è¡Œâ€œè‡ªæˆ‘æè¿°â€ã€‚XMLæ–‡æ¡£ã€HTMLæ–‡æ¡£å’ŒJSON æ–‡æ¡£å°±å±äºè¿™ä¸€ç±», å› æ­¤æˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ‰€æœ‰åŠç»“æ„åŒ–çš„æ•°æ®éƒ½å±äºæ–‡æ¡£æ•°æ®, è€Œç°åœ¨ä¸»è¦çš„æ–‡æ¡£æ•°æ®åº“è¿˜æ˜¯ä»¥Jsonä½œä¸ºæ–‡æ¡£ä¸ºä¸».<br>å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®æ˜¯ä¸è§„åˆ™çš„ï¼Œæ¯ä¸€æ¡è®°å½•åŒ…å«äº†æ‰€æœ‰çš„æœ‰å…³è¯¥è®°å½•çš„ä¿¡æ¯è€Œæ²¡æœ‰ä»»ä½•å¤–éƒ¨çš„å¼•ç”¨, è¿™æ¡è®°å½•å°±æ˜¯â€œè‡ªåŒ…å«â€çš„ã€‚è¿™å°±ä½¿å¾—è®°å½•å¾ˆå®¹æ˜“å®Œå…¨ç§»åŠ¨åˆ°å…¶ä»–æœåŠ¡å™¨, å› ä¸ºè¿™æ¡è®°å½•çš„æ‰€æœ‰ä¿¡æ¯éƒ½åŒ…å«åœ¨é‡Œé¢äº†, ä¸éœ€è¦è€ƒè™‘è¿˜æœ‰ä¿¡æ¯åœ¨åˆ«çš„è¡¨æ²¡æœ‰ä¸€èµ·è¿ç§»èµ°ã€‚åŒæ—¶ï¼Œå› ä¸ºåœ¨ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œåªæœ‰è¢«ç§»åŠ¨çš„é‚£ä¸€æ¡è®°å½•<br>éœ€è¦æ“ä½œè€Œä¸åƒå…³ç³»å‹ä¸­æ¯ä¸ªæœ‰è”ç³»çš„è¡¨éƒ½éœ€è¦é”ä½æ¥ä¿è¯ä¸€è‡´æ€§ï¼Œè¿™æ ·ä¸€æ¥ACIDçš„ä¿è¯å°±ä¼šå˜å¾—æ›´å¿«é€Ÿ, è¯»å†™çš„é€Ÿåº¦ä¹Ÿä¼šæœ‰å¾ˆå¤§çš„æå‡ã€‚</p>
<h4 id="å¥å€¼æ¨¡å‹"><a href="#å¥å€¼æ¨¡å‹" class="headerlink" title="å¥å€¼æ¨¡å‹"></a>å¥å€¼æ¨¡å‹</h4><p>å¥å€¼æ¨¡å‹: å®ƒçš„æ•°æ®æŒ‰ç…§é”®å€¼å¯¹çš„å½¢å¼è¿›è¡Œç»„ç»‡,ç´¢å¼•å’Œå­˜å‚¨ã€‚KVå­˜å‚¨éå¸¸é€‚åˆä¸æ¶‰åŠè¿‡å¤šæ•°æ®å…³ç³»ä¸šåŠ¡å…³ç³»çš„ä¸šåŠ¡æ•°æ®ï¼ŒåŒæ—¶èƒ½æœ‰æ•ˆå‡å°‘è¯»å†™ç£ç›˜çš„æ¬¡æ•°ï¼Œæ¯”SQLæ•°æ®åº“å­˜å‚¨æ‹¥æœ‰æ›´å¥½çš„è¯»å†™æ€§èƒ½ã€‚<br><img src="http://oiw1gzfww.bkt.clouddn.com/key_value_data.jpeg" alt=""></p>
<h4 id="åˆ—å¼æ¨¡å‹"><a href="#åˆ—å¼æ¨¡å‹" class="headerlink" title="åˆ—å¼æ¨¡å‹"></a>åˆ—å¼æ¨¡å‹</h4><p>åˆ—å¼å­˜å‚¨: ä»¥åˆ—ç›¸å…³å­˜å‚¨æ¶æ„è¿›è¡Œæ•°æ®å­˜å‚¨ã€‚åˆ—å¼å­˜å‚¨ä»¥æµçš„æ–¹å¼åœ¨åˆ—ä¸­å­˜å‚¨æ‰€æœ‰çš„æ•°æ®ï¼Œä¸»è¦é€‚åˆä¸æ‰¹é‡æ•°æ®å¤„ç†å’Œå³å¸­æŸ¥è¯¢ã€‚<br><img src="http://oiw1gzfww.bkt.clouddn.com/column_data.gif" alt=""></p>
<p>ç”±äºæŸ¥è¯¢éœ€è¦è¯»å–çš„blockså°‘, æ‰€ä»¥æŸ¥è¯¢å¿«, å› ä¸ºåŒä¸€ç±»å‹çš„åˆ—å­˜å‚¨åœ¨ä¸€èµ·, æ‰€ä»¥æ•°æ®å‹ç¼©æ¯”é«˜, Loadå¿«ã€‚ å®ƒç®€åŒ–æ•°æ®å»ºæ¨¡çš„å¤æ‚æ€§ã€‚ä½†æ˜¯æ’å…¥æ›´æ–°æ…¢ï¼Œä¸å¤ªé€‚åˆæ•°æ®è€æ˜¯å˜åŒ–ï¼Œå®ƒæ˜¯æŒ‰åˆ—å­˜å‚¨çš„ã€‚ åˆ—å¼å­˜å‚¨å¾ˆé€‚åˆåšæ•°æ®ä»“åº“ï¼Œå®ƒä¸é€‚åˆOLTPã€‚</p>
<h2 id="CAPå®šç†"><a href="#CAPå®šç†" class="headerlink" title="CAPå®šç†"></a>CAPå®šç†</h2><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­, <code>CAPå®šç†(CAP theorem)</code>, åˆè¢«ç§°ä½œ<code>å¸ƒé²å°”å®šç†(Brewer&#39;s theorem)</code>, å®ƒæŒ‡å‡ºå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—ç³»ç»Ÿæ¥è¯´ï¼Œä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ç‚¹:</p>
<ul>
<li>ä¸€è‡´æ€§(Consistency) (æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ®)</li>
<li>å¯ç”¨æ€§(Availability) (ä¿è¯æ¯ä¸ªè¯·æ±‚ä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥éƒ½æœ‰å“åº”)</li>
<li>åˆ†éš”å®¹å¿(Partition tolerance) (ç³»ç»Ÿä¸­ä»»æ„ä¿¡æ¯çš„ä¸¢å¤±æˆ–å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿçš„ç»§ç»­è¿ä½œ)</li>
</ul>
<p>CAPç†è®ºçš„æ ¸å¿ƒæ˜¯ï¼šä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶å¾ˆå¥½çš„æ»¡è¶³ä¸€è‡´æ€§ï¼Œå¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§è¿™ä¸‰ä¸ªéœ€æ±‚ï¼Œæœ€å¤šåªèƒ½åŒæ—¶è¾ƒå¥½çš„æ»¡è¶³ä¸¤ä¸ªã€‚<br>å› æ­¤ï¼Œæ ¹æ®CAPåŸç†å°†NoSQLæ•°æ®åº“åˆ†æˆäº†æ»¡è¶³CAåŸåˆ™ã€æ»¡è¶³CPåŸåˆ™å’Œæ»¡è¶³APåŸåˆ™ä¸‰ å¤§ç±»ï¼š</p>
<ul>
<li>CA å•ç‚¹é›†ç¾¤ï¼Œæ»¡è¶³ä¸€è‡´æ€§ï¼Œå¯ç”¨æ€§çš„ç³»ç»Ÿï¼Œé€šå¸¸åœ¨å¯æ‰©å±•æ€§ä¸Šä¸å¤ªå¼ºå¤§ã€‚</li>
<li>CP æ»¡è¶³ä¸€è‡´æ€§ï¼Œåˆ†åŒºå®¹å¿æ€§çš„ç³»ç»Ÿï¼Œé€šå¸¸æ€§èƒ½ä¸æ˜¯ç‰¹åˆ«é«˜ã€‚</li>
<li>AP æ»¡è¶³å¯ç”¨æ€§ï¼Œåˆ†åŒºå®¹å¿æ€§çš„ç³»ç»Ÿï¼Œé€šå¸¸å¯èƒ½å¯¹ä¸€è‡´æ€§è¦æ±‚ä½ä¸€äº›ã€‚</li>
</ul>
<p><strong>å®šç†</strong>: ä»»ä½•åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ—¶æ»¡è¶³3ç‚¹(Consistency, Availability, Partition tolerance)ä¸­çš„2ç‚¹, åŒæ—¶æ»¡è¶³3ç‚¹çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ä¸å­˜åœ¨çš„<br><strong>å¿ å‘Š</strong>ï¼šæ¶æ„å¸ˆä¸è¦å°†ç²¾åŠ›æµªè´¹åœ¨å¦‚ä½•è®¾è®¡èƒ½æ»¡è¶³ä¸‰è€…çš„å®Œç¾åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œè€Œæ˜¯åº”è¯¥è¿›è¡Œå–èˆã€‚</p>
<h3 id="CAPä¸æ•°æ®åº“"><a href="#CAPä¸æ•°æ®åº“" class="headerlink" title="CAPä¸æ•°æ®åº“"></a>CAPä¸æ•°æ®åº“</h3><p>RDBMSæ»¡è¶³çš„æ˜¯ACIDè§„åˆ™, è€ŒACIDè§„åˆ™æ»¡è¶³çš„å°±æ˜¯CAPé‡Œé¢çš„<code>CA</code>, å› æ­¤æ‰©å±•æ€§ä¸å¼º.<br>NewSQL/NoSQLæ»¡è¶³çš„æ˜¯BASEè§„åˆ™, è€ŒBASEè§„åˆ™å°±æ˜¯é™ä½ä¸€è‡´æ€§æˆ–è€…å¯ç”¨æ€§æ¥æå‡ç³»ç»Ÿæ€§èƒ½, å°±æ˜¯CAPé‡Œé¢çš„<code>CP</code>/<code>AP</code></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨ç†è§£äº†ä¸Šé¢æ‰€æœ‰çš„æ¦‚å¿µè¿‡å, å°±èƒ½çœ‹æ‡‚è¿™å¼ CAPçš„å›¾äº†:<br><img src="http://oiw1gzfww.bkt.clouddn.com/cap_thorem.jpg" alt=""></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.mongodb.com/zh/mongodb-architecture" target="_blank" rel="external">MongoDB Architectureå®˜æ–¹ä¸­æ–‡ä»‹ç»</a><br><a href="https://www.zhihu.com/question/25535889" target="_blank" rel="external">elasticsearch(lucene)å¯ä»¥ä»£æ›¿NoSQL(mongodb)å—ï¼Ÿ</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç”±äºé¡¹ç›®éœ€è¦å­˜å‚¨ä¸€äº›æ— ç»“æ„çš„æ•°æ®, è¿™äº›æ•°æ®ä¸»è¦ä»¥æ–‡æœ¬ä¸ºä¸», åŒæ—¶è¿˜éœ€æ”¯æŒä¸€äº›æ–‡æœ¬åˆ†æ, å’‹ä¸€å¬ä¼¼ä¹ESæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©, ä½†æ˜¯è¿™äº›æ— ç»“æ„çš„æ•°æ®åŒæ—¶ä¹Ÿéœ€è¦è¢«ç®¡ç†, ä¹Ÿå°±æ˜¯è¿™äº›æ•°æ®å¯èƒ½ç»å¸¸å˜æ›´, è¡¡é‡å†ä¸‰, æœ€åè¿˜æ˜¯é€‰æ‹©äº†Mongo, æ¯•ç«Ÿç°é˜¶æ®µæ˜¯ä»¥æ•°æ®çš„å­˜å‚¨å’Œç®¡ç†ä¸ºä¸», åˆ†æå¹¶æ²¡æœ‰é‚£ä¹ˆå¼ºçš„éœ€æ±‚ã€‚æ•´ç¯‡æ–‡ç« ä»¥å¤§æ•°æ®å­˜å‚¨é—®é¢˜ä¸ºå¼•, ä¸€æ­¥æ­¥å¼•å‡ºNoSQLé¢†åŸŸæ–‡æ¡£æ•°æ®çš„ä»£è¡¨MongoDBã€‚&lt;br&gt;
    
    </summary>
    
      <category term="æ•°æ®åº“" scheme="https://blog.yumaojun.net/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="æ–‡æ¡£æ•°æ®åº“" scheme="https://blog.yumaojun.net/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="mongodb" scheme="https://blog.yumaojun.net/tags/mongodb/"/>
    
  </entry>
  
  <entry>
    <title>å¯¹æ¯”RESTfulä¸SOAPï¼Œæ·±å…¥ç†è§£RESTful</title>
    <link href="https://blog.yumaojun.net/2017/10/03/restful-vs-soap/"/>
    <id>https://blog.yumaojun.net/2017/10/03/restful-vs-soap/</id>
    <published>2017-10-03T00:51:04.000Z</published>
    <updated>2017-10-03T01:46:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ–‡ç« å¼€å§‹å‰è¯·æ€è€ƒå¦‚ä¸‹é—®é¢˜: RESTæ˜¯å•¥? SOAPæ˜¯å•¥ï¼Ÿä¸ºä»€ä¹ˆä¼šäº§ç”Ÿä»–ä»¬ï¼Ÿä»¥åŠä»–ä»¬éƒ½æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿä»–ä»¬åˆ°åº•æœ‰å“ªäº›ä¸åŒï¼Ÿæˆ‘ä»¬ä»€ä¹ˆæ—¶å€™é€‰æ‹©RESTï¼Œä»€ä¹ˆæ—¶å€™é€‰æ‹©SOAP. åœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡å¯¹æ¯”ä»–ä»¬æ¥è§£ç­”å‰é¢æå‡ºçš„é—®é¢˜.<br><a id="more"></a></p>
<h2 id="è¯ç”Ÿ"><a href="#è¯ç”Ÿ" class="headerlink" title="è¯ç”Ÿ"></a>è¯ç”Ÿ</h2><p>åœ¨åå¤šå¹´å‰ æœ‰2ç§å¾ˆé‡è¦æ„å»ºweb serviceçš„æ–¹æ³•: RESTful å’Œ SOAP, SOAPçš„å‡ºç°çº¦ä¸ºæ¯”RESTfulæ—©ä¸€äº›ï¼Œåœ¨å¼€å§‹ä¹‹åˆä»–ä»¬å¹¶æ²¡æœ‰åˆ†åŒ–ï¼Œä»ç„¶å…±å­˜æ¥è§£å†³ä¸åŒçš„éœ€æ±‚ã€‚ä½†æ˜¯ç°åœ¨RESTfulç››è¡Œï¼ŒSOAPæ—¥æ¸æ²¡è½ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥äº†è§£ä¸‹ä»–ä»¬çš„å‰ä¸–ä»Šç”Ÿ.</p>
<p>RESTfulå‡ºç”Ÿåœ¨å­¦æœ¯ç•Œ,æœ‰ç€æ‹¥æŠ±å¼€æ”¾ç½‘ç»œçš„å“²å­¦,è€ŒSOAPæ˜¯å¤§å‹è½¯ä»¶å…¬å¸ä¸ºäº†è§£å†³ä¼ä¸šå¸‚åœºçš„éœ€è¦è€Œäº§å‡ºçš„ã€‚è™½ç„¶ç°åœ¨RESTç››è¡Œï¼Œä½†æ˜¯SOAPçš„ç¡®ä¹Ÿæœ‰ä»–çš„ä¼˜ç‚¹ï¼Œæ‰€æœ‰æˆ‘ä»¬éœ€è¦æ¯”è¾ƒè¿™ä¸¤ä¸ªåè®®ï¼Œåšæ­£ç¡®çš„å–èˆ.</p>
<h2 id="RESTfulç®€ä»‹"><a href="#RESTfulç®€ä»‹" class="headerlink" title="RESTfulç®€ä»‹"></a>RESTfulç®€ä»‹</h2><p>RESTè¿™ä¸ªè¯ï¼Œæ˜¯<a href="http://en.wikipedia.org/wiki/Roy_Fielding" target="_blank" rel="external">Roy Thomas Fielding</a>åœ¨ä»–2000å¹´çš„<a href="http://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm" target="_blank" rel="external">åšå£«è®ºæ–‡</a>ä¸­æå‡ºçš„ã€‚å®ƒæ˜¯â€œRepresentational State Transferâ€çš„ç¼©å†™ã€‚ä»–è¿™æ¬¡è®ºæ–‡çš„ä¸»é¢˜æ˜¯æ¢è®¨å‡ ç§åŸºäºç½‘ç»œçš„è½¯ä»¶è®¾è®¡æ¶æ„å’Œé£æ ¼ï¼Œ è€ŒRESTè¢«å…·ä½“æè¿°æ˜¯åœ¨ä»–è®ºæ–‡çš„ç¬¬5ç« ã€‚åœ¨è¿™ä¸ªç« èŠ‚ä¸­ï¼Œä»–æ˜¯è¿™æ ·æ€»ç»“RESTçš„:</p>
<blockquote>
<p>provides a set of architectural constraints that, when applied as a whole, emphasizes scalability of component interactions, generality of interfaces, independent deployment of components, and intermediary components to reduce interaction latency, enforce security, and encapsulate legacy systems.</p>
</blockquote>
<p>å®ƒæä¾›äº†ä¸€ç»„ä½“ç³»çº¦æŸï¼Œå…·ä½“æœ‰è¿™ä¹ˆå‡ ç‚¹: </p>
<ul>
<li>æ•´ä½“å…³è”æ€§</li>
<li>å¼ºè°ƒç»„ä»¶äº¤äº’çš„å¯ä¼¸ç¼©æ€§</li>
<li>ç»„ä»¶çš„ç‹¬ç«‹éƒ¨ç½²</li>
<li>ä¸€èˆ¬æ€§çš„æ¥å£</li>
<li>ä½¿ç”¨ä¸­é—´ä»¶æ¥å‡å°‘äº¤æ¢å»¶è¿Ÿ</li>
<li>æ‰§è¡Œå®‰å…¨</li>
</ul>
<p>æ‰€ä»¥,RESTå¯ä»¥è¢«æè¿°ä¸ºä¸€ç§æ„å»ºWebæœåŠ¡æ‰€åº”è¯¥éµå¾ªçš„ä¸€ç»„ç‰¹å®šçº¦æŸ(providerå’Œcustomerä¹‹é—´çš„):</p>
<ul>
<li>client ç«¯å’Œserverç«¯çš„ å…³æ³¨ç‚¹çš„åˆ†ç¦»: clientä¸ç”¨å…³æ³¨ æ•°æ®çš„å­˜å‚¨ï¼Œ è€Œserverç«¯ä¸å¿…å…³æ³¨ç”¨æˆ·ç•Œé¢ã€‚ä½¿å¾—client å’Œ server è§£è€¦ï¼Œä»è€Œå–å¾—é«˜æ‰©å±•æ€§</li>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡å¿…é¡»æ— çŠ¶æ€: æœåŠ¡å™¨ä¸åº”è¯¥å­˜å‚¨ä»»ä½•  å’Œclientsä¹‹é—´äº¤äº’çš„ä¸Šä¸‹æ–‡ä¿¡æ¯, é™¤äº†ç”¨äºç»´æŠ¤è®¤è¯çš„ä¼šè¯ä¿¡æ¯ã€‚</li>
<li>å®¢æˆ·åº”è¯¥èƒ½å¤Ÿç¼“å­˜å“åº”: æ‰€æœ‰æœåŠ¡å™¨å“åº”åº”è¯¥åŒ…å«è¶³å¤Ÿçš„ç¼“å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚å®¢æˆ·ç«¯å¯ä»¥ä¾é è¿™äº›ä¿¡æ¯å†³å®šæ˜¯å¦é€‚åˆç¼“å­˜å“åº”ã€‚</li>
<li>è¿æ¥å¯ä»¥å‘ç”Ÿåœ¨å¤šä¸ªé€šä¿¡å±‚: æœåŠ¡ç«¯ä¸åº”è¯¥åŒºåˆ† å®¢æˆ·ç«¯ æ˜¯å¦ç›´æ¥è¿æ¥serverï¼Œè¿˜æ˜¯é€šè¿‡ä¸­é—´ä»£ç†æ¥è¿æ¥server</li>
</ul>
<p>Fieldingæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äººï¼Œä»–æ˜¯HTTPåè®®ï¼ˆ1.0ç‰ˆå’Œ1.1ç‰ˆï¼‰çš„ä¸»è¦è®¾è®¡è€…ã€ApacheæœåŠ¡å™¨è½¯ä»¶çš„ä½œè€…ä¹‹ä¸€ã€ApacheåŸºé‡‘ä¼šçš„ç¬¬ä¸€ä»»ä¸»å¸­ã€‚æ‰€ä»¥ï¼Œä»–çš„è¿™ç¯‡è®ºæ–‡ä¸€ç»å‘è¡¨ï¼Œå°±å¼•èµ·äº†å…³æ³¨ï¼Œå¹¶ä¸”ç«‹å³å¯¹äº’è”ç½‘å¼€å‘äº§ç”Ÿäº†æ·±è¿œçš„å½±å“ã€‚</p>
<p>æ€»ä½“æ¥è¯´RESTå°±æ˜¯webçš„ä¸€ç§æŠ½è±¡ï¼ŒRESTåº”è¯¥å…è®¸ä»»ä½•customer ä»¥åŒä¸€ç§æ–¹å¼ä¸APIè¿›è¡Œäº¤äº’ï¼Œ è€Œä¸éœ€è¦çŸ¥é“å…¶åé¢çš„å·¥ä½œåŸç†ã€‚</p>
<h2 id="SOAPç®€ä»‹"><a href="#SOAPç®€ä»‹" class="headerlink" title="SOAPç®€ä»‹"></a>SOAPç®€ä»‹</h2><p>SOAP, æ˜¯â€œSimple Object Access Protocolâ€çš„ç¼©å†™, æ˜¯1998å¹´ä¸€ç¾¤äººå’Œå¾®è½¯åˆä½œè€Œäº§ç”Ÿçš„ã€‚å…¶ä¸­çš„ä¸€ä¸ªäººå«æˆ´å¤«Â·ç»´çº³,ä»–æ˜¯<code>XML-RPC</code>(ä¸€ç§ä½¿ç”¨xmlä½œä¸º æ ‡å‡†çš„æ¶ˆæ¯è½½ä½“ çš„ è¿œç¨‹è¿‡ç¨‹è°ƒç”¨)çš„åˆ›é€ è€…, ä¹Ÿæ­£æ˜¯è¿™é¡¹åˆ›é€ å¯¼è‡´çš„SOAPçš„äº§ç”Ÿï¼Œå°½ç®¡è¢«å¾®è½¯,IBMå’Œå…¶ä»–å…¬å¸æ”¯æŒï¼Œä½†æ˜¯SOAPç›´åˆ°2003å¹´æ‰è¢«W3Cæ­£å¼æ‰¿è®¤ã€‚</p>
<p>ä½¿ç”¨SOAP WebæœåŠ¡ç¬¦åˆä¸€ç»„ç‰¹å¾ï¼Œä½¿åˆ†å¸ƒå¼å¯¹è±¡ä¹‹é—´çš„é€šä¿¡æˆä¸ºäº†å¯èƒ½:</p>
<ul>
<li>åè®®æ˜¯å¯æ‰©å±•çš„: æ‰©å±•çš„åŸºæœ¬åŠŸèƒ½å¯ä»¥æ„å»ºå’Œä½¿ç”¨è€Œä¸å½±å“ä¸»è¦ç‰¹å¾</li>
<li>æ¶ˆæ¯å†…å®¹åº”è¯¥ç‹¬ç«‹äºä¼ è¾“æœºåˆ¶: SOAPä¸ä»…å¯ä»¥é€šè¿‡HTTPä¼ è¾“æ¶ˆæ¯å†…å®¹ï¼Œè€Œä¸”å…¶ä»–ä¼ è¾“åè®®ä¹Ÿæ”¯æŒæ¯”å¦‚ï¼šSMTPã€‚SMTPè¢«ç”¨æ¥æä¾›å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„å¼‚æ­¥é€šä¿¡ã€‚</li>
<li>åº•å±‚ç¼–ç¨‹æ¨¡å‹è§£è€¦: åœ¨é€»è¾‘ä¸Š SOAPçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å¼€å‘æ—¶å®Œå…¨ç‹¬ç«‹çš„ã€‚</li>
</ul>
<p>SAOPåœ¨ä»–åˆšå‡ºä¸–çš„å‰å‡ å¹´ï¼Œéå¸¸ç››è¡Œï¼Œä½†æ˜¯éšåä¸€ç›´èµ°ä¸‹å¡è·¯ï¼Œä½†æ˜¯SAOPç°åœ¨ä»ç„¶åˆ«ä¸€äº›ä¼ä¸šçº§çš„ç¯å¢ƒä½¿ç”¨ç€ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä¼ä¸šçº§çš„éœ€æ±‚é‡Œé¢,ä¸åŒæœåŠ¡ä¹‹é—´çš„é€šä¿¡éœ€è¦éµå¾ªä¸€å¥—è§„åˆ™å’Œçº¦æŸã€‚æ­£æ˜¯å› ä¸ºå®ƒéµå¾ªå¯¹è±¡ã€è§„åˆ™å’Œçº¦æŸ,æ‰€ä»¥SOAPæ˜¯ä¸€ä¸ªæ¯”RESTæ›´ä¸¥æ ¼çš„åè®®ã€‚</p>
<p>SOAPåœ¨è¾ƒå¤§çš„ç»„ç»‡ä¸­èµ¢å¾—äº†æ”¯æŒ,ä¸»è¦åŸå› æ˜¯å½“æ—¶å¾®è½¯çš„æ”¯æŒï¼Œä»¥åŠå¸‚åœºç”±å¾®è½¯ä¸»å¯¼ã€‚<code>Windows Communication Foundation(WCF)</code>,ä»¥å¾®è½¯å¹³å°ä½œä¸ºæ ¸å¿ƒå¼€å‘, ç›´åˆ°ä»Šå¤©ä»ç„¶æ”¯æŒSOAPï¼Œ è€Œå…¶ä»–æ–¹å¼å®ç°çš„SAOPçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ¡†æ¶æœ‰<code>PHP Zend Framework</code>å’Œ<code>Apache CXF</code></p>
<h2 id="REST-vs-SOAP"><a href="#REST-vs-SOAP" class="headerlink" title="REST vs SOAP"></a>REST vs SOAP</h2><ul>
<li>è®¾è®¡å“²å­¦<br>SOAPä¸»è¦æ˜¯æä¾›äº†ä¸€ç§è¿œç¨‹è®¿é—®å’Œæ“ä½œå¯¹è±¡çš„æ–¹å¼ï¼Œè€ŒRESTåˆ™å…³æ³¨èµ„æºå¯ä»¥è¢«æ‰§è¡Œçš„æ“ä½œã€‚ç”±æ­¤å¯è§SAOPæ›´å…³æ³¨åŠŸèƒ½ï¼Œè€ŒRESTæ›´å…³æ³¨èµ„æºï¼Œè¿™ä¸»è¦ä¸ä»–ä»¬çš„è®¾è®¡å“²å­¦å’Œå‡ºç”Ÿæœ‰å…³(å‰é¢å·²ç»æåŠ), æ­£æ˜¯ç”±äºè¿™äº›åŒºåˆ«ï¼ŒRESTä¸»è¦è¢«ç”¨æ¥è®¾è®¡æš´éœ²äºäº’è”ç½‘çš„å…¬ç½‘APIï¼Œè€Œç”±äºRESTç»§æ‰¿äº†HTTPçš„æ“ä½œï¼Œæ›´ä½¿å¾—å®ƒæˆä¸ºæ„å»ºå¼€æ”¾çš„WEB APIçš„ä¸äºŒä¹‹é€‰ã€‚</li>
<li>äº’è”ç½‘å…¬å¸æ”¯æŒ<br>RESTfulå¾ˆæµè¡Œçš„ä¸€ä¸ªä¸»è¦åŸå› æ˜¯äº’è”ç½‘å·¨å¤´çš„ä½¿ç”¨ï¼Œä»¥åŠè¿™äº›äº’è”ç½‘å·¨å¤´çš„é¼“åŠ±å’Œæ¨è</li>
<li>å¸¦å®½æ¶ˆè€—<br>åœ¨ä½ ä¸éœ€è¦å°†ä¸€ç»„å¯¹è±¡å…¨æ˜ å°„ç»™å®¢æˆ·ç«¯çš„åœºæ™¯ä¸­ï¼Œ RESTæ°¸è¿œéƒ½è¦ä¼˜äºSOAPï¼Œ è€Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ å®Œå…¨æ²¡æœ‰å¿…è¦å°†æœåŠ¡å™¨ç«¯çš„ä¸€ç»„å¯¹è±¡å…¨æ˜ å°„ç»™å®¢æˆ·ç«¯ã€‚è€Œå¯¹è±¡çš„æ¥å›æ˜ å°„æ˜¯æå…·æ¶ˆè€—å¸¦å®½çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºå•¥è¯´SOAPæ¯”è¾ƒé‡çš„åŸå› æ‰€åœ¨ã€‚ æ‰€ä»¥å°½é‡é¿å…ä½¿ç”¨SOAPï¼Œ ç‰¹åˆ«æ˜¯å½“ä½ çš„å¸¦å®½èµ„æºéå¸¸çè´µçš„æƒ…å½¢ä¸‹ï¼Œæ¯”å¦‚ç§»åŠ¨app</li>
<li>æ˜“ç”¨æ€§<br>è¿™æ˜¯æœ€é‡è¦çš„åŸå› , RESTæ¯”SOAPç®€å•, å­¦ä¹ å’Œä½¿ç”¨RESTful APIçš„ä»£ä»·æä½ï¼Œè¿™ä½¿å¾—å¼€å‘RESTfulAPIçš„æ—¶é—´ä¸Šæ¯”SOAPçŸ­ã€‚RESTfulé€šè¿‡HTTPçš„æ–¹æ³•æ¥æ“ä½œèµ„æºï¼Œé€šè¿‡jsonæ¥äº¤æ¢æ•°æ®ï¼Œ æ— è®ºæ˜¯HTTPåè®®ä¸Šçš„ä½¿ç”¨ç®€å•(request url and get response), è¿˜æ˜¯æ•°æ®äº¤æ¢æ ¼å¼Jsonçš„æµè¡Œï¼Œå½“ç„¶Jsonçš„æµè¡Œä¸»è¦æ˜¯å› ä¸ºjavascript, éƒ½ä½¿å¾—RESTæ¯”SOAPæ›´æ˜“äºè¢«äººä»¬æ¥æ”¶å’Œä½¿ç”¨ã€‚</li>
<li>æ•æ·æ€§<br>ç”±äºRESTè½»çº¦æŸ(è¿™ä¸ªä¸»è¦æ˜¯æ— çŠ¶æ€çš„è®¾è®¡)ï¼Œ è€ŒSOAPé‡çº¦æŸï¼Œ ä½¿å¾—RESTæ›´åŠ çµæ´»ï¼Œå½“WEB APIæœ‰å˜åŒ–æ—¶ ä¼ä¸šå¯ä»¥å¿«é€Ÿçš„é€‚ç”¨ã€‚</li>
</ul>
<h2 id="æ·±å…¥RESTful"><a href="#æ·±å…¥RESTful" class="headerlink" title="æ·±å…¥RESTful"></a>æ·±å…¥RESTful</h2><p>åœ¨å¯¹RESTfulçš„å‰ä¸–ä»Šç”Ÿï¼Œ ä»¥åŠå¦‚ä½•PKæ‰SOAPçš„ äº†è§£ä¸‹ï¼Œ RESTfulçš„å…·ä½“æ¦‚å¿µ ä¹Ÿå°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œ å¦‚æœæ›´æ·±å…¥äº†è§£RESTfulçš„æ¦‚å¿µï¼Œå¯è§å‚è€ƒåé¢Fieldingçš„åšå£«ç”Ÿè®ºæ–‡ç¬¬5ç« ï¼Œæ–‡ç« æœ€åæœ‰è¿æ¥ã€‚</p>
<h3 id="åç§°"><a href="#åç§°" class="headerlink" title="åç§°"></a>åç§°</h3><p>åç§°å¾€å¾€éƒ½éå¸¸é‡è¦, å› ä¸ºå®ƒæ˜¯å¯¹è¿™ä¸ªäº‹ç‰©çš„é«˜åº¦æŠ½è±¡,æ¯”å¦‚Docker, ä»–çš„è‹±æ–‡æ„è¯†æ˜¯ç å¤´çš„æ¬è¿å·¥ï¼Œè€ŒDockerçœŸæ­£çš„ç”¨é€”æ˜¯è½¯ä»¶çš„æ¬è¿å·¥ï¼Œæ‰€ä»¥æ˜¯ä¸æ˜¯å¾ˆæœ‰æ„æ€ã€‚<br>Fieldingå°†ä»–å¯¹äº’è”ç½‘è½¯ä»¶çš„æ¶æ„åŸåˆ™ï¼Œå®šåä¸ºRESTï¼Œå³Representational State Transferçš„ç¼©å†™ã€‚è¿™ä¸ªè¯ç»„çš„ç¿»è¯‘æ˜¯â€è¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚<br>å› æ­¤è¦ç†è§£RESTfulåˆ°åº•æ˜¯ä¸€ç§å•¥æ ·çš„äº’è”ç½‘è½¯ä»¶è®¾è®¡é£æ ¼ï¼Œç†è§£å¥½Representational State Transfer è¿™ç»„å•è¯æ˜¯ç¬¬ä¸€æ­¥ã€‚</p>
<p>è¿™å•è¯ä¸­åŒ…å«äº†é‚£äº›ä¿¡æ¯å–ƒ? RESTçš„åç§°â€è¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ä¸­ï¼Œçœç•¥äº†ä¸»è¯­ã€‚â€è¡¨ç°å±‚â€å…¶å®æŒ‡çš„æ˜¯â€èµ„æºâ€(Resources)çš„â€è¡¨ç°å±‚â€ã€‚å› æ­¤å°±æœ‰3ä¸ªè¦ç´ ï¼šèµ„æºã€è¡¨ç°ã€è½¬æ¢.</p>
<h3 id="Resource-èµ„æº"><a href="#Resource-èµ„æº" class="headerlink" title="Resource(èµ„æº)"></a>Resource(èµ„æº)</h3><p>æ‰€è°“â€èµ„æºâ€ï¼Œå°±æ˜¯ç½‘ç»œä¸Šçš„ä¸€ä¸ªå®ä½“ï¼Œæˆ–è€…è¯´æ˜¯ç½‘ç»œä¸Šçš„ä¸€ä¸ªå…·ä½“ä¿¡æ¯ã€‚å®ƒå¯ä»¥æ˜¯ä¸€æ®µæ–‡æœ¬ã€ä¸€å¼ å›¾ç‰‡ã€ä¸€é¦–æ­Œæ›²ã€ä¸€ç§æœåŠ¡ï¼Œæ€»ä¹‹å°±æ˜¯ä¸€ä¸ªå…·ä½“çš„å®åœ¨ã€‚ä½ å¯ä»¥ç”¨ä¸€ä¸ªURI(ç»Ÿä¸€èµ„æºå®šä½ç¬¦)æŒ‡å‘å®ƒï¼Œæ¯ç§èµ„æºå¯¹åº”ä¸€ä¸ªç‰¹å®šçš„URIã€‚è¦è·å–è¿™ä¸ªèµ„æºï¼Œè®¿é—®å®ƒçš„URIå°±å¯ä»¥ï¼Œå› æ­¤URIå°±æˆäº†æ¯ä¸€ä¸ªèµ„æºçš„åœ°å€æˆ–ç‹¬ä¸€æ— äºŒçš„è¯†åˆ«ç¬¦ã€‚</p>
<p>äººä»¬å¾€å¾€å®¹æ˜“æŠŠ<code>RUI</code>å’Œ<code>URL</code>ææ··ï¼Œå®é™…ä¸Šä»–ä»¬çš„ç¡®æ˜¯æŒ‡åŒä¸€ç§äº‹ç‰©(èµ„æº), åªæ˜¯ç«™çš„è§’åº¦ä¸åŒ, è€Œå«æ³•ä¸åŒè€Œå·²: ç«™åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å«è®¿é—®èµ„æºçš„è·¯å¾„å«URL, ç«™åœ¨æœåŠ¡å™¨ æˆ‘ä»¬å®šä¹‰èµ„æºçš„è·¯å¾„å« RUI</p>
<p>è€Œæ•´ä¸ªäº’è”ç½‘ å°±æ˜¯ç”±è¿™äº›èµ„æºç»„åˆè€Œæˆçš„.</p>
<h3 id="Representational-è¡¨ç°å±‚"><a href="#Representational-è¡¨ç°å±‚" class="headerlink" title="Representational(è¡¨ç°å±‚)"></a>Representational(è¡¨ç°å±‚)</h3><p>â€œèµ„æºâ€æ˜¯ä¸€ç§ä¿¡æ¯å®ä½“, å®ƒå¯ä»¥æœ‰å¤šç§å¤–åœ¨è¡¨ç°å½¢å¼. æˆ‘ä»¬æŠŠâ€èµ„æºâ€å…·ä½“å‘ˆç°å‡ºæ¥çš„å½¢å¼, å«åšå®ƒçš„<code>è¡¨ç°å±‚(Representation)</code>.<br>æ¯”å¦‚ï¼Œæ–‡æœ¬å¯ä»¥ç”¨txtæ ¼å¼è¡¨ç°ï¼Œä¹Ÿå¯ä»¥ç”¨HTMLæ ¼å¼ã€XMLæ ¼å¼ã€JSONæ ¼å¼è¡¨ç°ï¼Œç”šè‡³å¯ä»¥é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼›å›¾ç‰‡å¯ä»¥ç”¨JPGæ ¼å¼è¡¨ç°ï¼Œä¹Ÿå¯ä»¥ç”¨PNGæ ¼å¼è¡¨ç°ã€‚</p>
<p>URIåªä»£è¡¨èµ„æºçš„å®ä½“ï¼Œä¸ä»£è¡¨å®ƒçš„å½¢å¼ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œæœ‰äº›ç½‘å€æœ€åçš„â€.htmlâ€åç¼€åæ˜¯ä¸å¿…è¦çš„ï¼Œå› ä¸ºè¿™ä¸ªåç¼€åè¡¨ç¤ºæ ¼å¼, å±äº<code>è¡¨ç°å±‚</code>èŒƒç•´ï¼Œè€ŒURIåº”è¯¥åªä»£è¡¨èµ„æºçš„ä½ç½®ã€‚å®ƒçš„å…·ä½“è¡¨ç°å½¢å¼ï¼Œåº”è¯¥åœ¨HTTPè¯·æ±‚çš„å¤´ä¿¡æ¯ä¸­ç”¨<code>Accept</code>å’Œ<code>Content-Type</code>å­—æ®µæŒ‡å®šï¼Œè¿™ä¸¤ä¸ªå­—æ®µæ‰æ˜¯å¯¹<code>è¡¨ç°å±‚</code>çš„æè¿°ã€‚</p>
<h3 id="State-Transfer-çŠ¶æ€è½¬æ¢"><a href="#State-Transfer-çŠ¶æ€è½¬æ¢" class="headerlink" title="State Transfer(çŠ¶æ€è½¬æ¢)"></a>State Transfer(çŠ¶æ€è½¬æ¢)</h3><p>è®¿é—®ä¸€ä¸ªç½‘ç«™, å°±ä»£è¡¨äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ä¸€ä¸ªäº’åŠ¨è¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒåŠ¿å¿…æ¶‰åŠåˆ°æ•°æ®å’ŒçŠ¶æ€çš„å˜åŒ–ã€‚</p>
<p>äº’è”ç½‘é€šä¿¡åè®®HTTPåè®®, æ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®ã€‚è¿™æ„å‘³ç€, æ‰€æœ‰çš„çŠ¶æ€éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚å› æ­¤, å¦‚æœå®¢æˆ·ç«¯æƒ³è¦æ“ä½œæœåŠ¡å™¨, å¿…é¡»é€šè¿‡æŸç§æ‰‹æ®µè®©æœåŠ¡å™¨ç«¯å‘ç”Ÿ<code>çŠ¶æ€è½¬åŒ–(State Transfer)</code>. è€Œè¿™ç§è½¬åŒ–æ˜¯å»ºç«‹åœ¨è¡¨ç°å±‚ä¹‹ä¸Šçš„ï¼Œæ‰€ä»¥å°±æ˜¯â€è¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚</p>
<p>å®¢æˆ·ç«¯ç”¨åˆ°çš„æ‰‹æ®µï¼Œåªèƒ½æ˜¯HTTPåè®®ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯HTTPåè®®é‡Œé¢ï¼Œå››ä¸ªè¡¨ç¤ºæ“ä½œæ–¹å¼çš„åŠ¨è¯ï¼šGETã€POSTã€PUTã€DELETEã€‚å®ƒä»¬åˆ†åˆ«å¯¹åº”å››ç§åŸºæœ¬æ“ä½œï¼šGETç”¨æ¥è·å–èµ„æºï¼ŒPOSTç”¨æ¥æ–°å»ºèµ„æºï¼ˆä¹Ÿå¯ä»¥ç”¨äºæ›´æ–°èµ„æºï¼‰ï¼ŒPUTç”¨æ¥æ›´æ–°èµ„æºï¼ŒDELETEç”¨æ¥åˆ é™¤èµ„æºã€‚</p>
<h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><ul>
<li><a href="http://www.restapitutorial.com/" target="_blank" rel="external">RESTful tutorial</a></li>
<li><a href="http://nordicapis.com/rest-better-than-soap-yes-use-cases/" target="_blank" rel="external">REST vs SOAP</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2011/09/restful.html" target="_blank" rel="external">é˜®ä¸€å³°åšå®¢</a></li>
<li><a href="http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm" target="_blank" rel="external">Fieldingè®ºæ–‡å¯¹RESTfulå…·ä½“æè¿°</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨æ–‡ç« å¼€å§‹å‰è¯·æ€è€ƒå¦‚ä¸‹é—®é¢˜: RESTæ˜¯å•¥? SOAPæ˜¯å•¥ï¼Ÿä¸ºä»€ä¹ˆä¼šäº§ç”Ÿä»–ä»¬ï¼Ÿä»¥åŠä»–ä»¬éƒ½æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿä»–ä»¬åˆ°åº•æœ‰å“ªäº›ä¸åŒï¼Ÿæˆ‘ä»¬ä»€ä¹ˆæ—¶å€™é€‰æ‹©RESTï¼Œä»€ä¹ˆæ—¶å€™é€‰æ‹©SOAP. åœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡å¯¹æ¯”ä»–ä»¬æ¥è§£ç­”å‰é¢æå‡ºçš„é—®é¢˜.&lt;br&gt;
    
    </summary>
    
      <category term="ç¨‹åºè®¾è®¡" scheme="https://blog.yumaojun.net/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
      <category term="RESTful API" scheme="https://blog.yumaojun.net/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/RESTful-API/"/>
    
    
      <category term="restful" scheme="https://blog.yumaojun.net/tags/restful/"/>
    
  </entry>
  
  <entry>
    <title>Goè¯­è¨€JSONè¯¦è§£</title>
    <link href="https://blog.yumaojun.net/2017/10/03/golang-json/"/>
    <id>https://blog.yumaojun.net/2017/10/03/golang-json/</id>
    <published>2017-10-03T00:44:19.000Z</published>
    <updated>2017-11-03T07:39:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å‰æˆ‘ä»¬çœ‹åˆ°å¾ˆå¤šçš„å¼€æ”¾å¹³å°ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯é‡‡ç”¨äº†JSONä½œä¸ºä»–ä»¬çš„æ•°æ®äº¤äº’çš„æ ¼å¼ã€‚æ—¢ç„¶JSONåœ¨Webå¼€å‘ä¸­å¦‚æ­¤é‡è¦ï¼Œé‚£ä¹ˆGoè¯­è¨€å¯¹JSONæ”¯æŒçš„æ€ä¹ˆæ ·å‘¢ï¼ŸGoè¯­è¨€çš„æ ‡å‡†åº“å·²ç»éå¸¸å¥½çš„æ”¯æŒäº†JSONï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„å¯¹JSONæ•°æ®è¿›è¡Œç¼–ã€è§£ç çš„å·¥ä½œã€‚å¦‚æœæœ‰æ›´çµæ´»çš„éœ€æ±‚ä¹Ÿæœ‰ä¸é”™çš„ç¬¬ä¸‰æ–¹åº“æä¾›æ”¯æŒã€‚è¿™ç¯‡æ–‡ç« å°†å…¨é¢è§£è¯»Golangä¸­JSONçš„ä½¿ç”¨ã€‚<br><a id="more"></a></p>
<h2 id="JSONç®€ä»‹"><a href="#JSONç®€ä»‹" class="headerlink" title="JSONç®€ä»‹"></a>JSONç®€ä»‹</h2><p>JSONï¼ˆJavascript Object Notationï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢è¯­è¨€ï¼Œä»¥æ–‡å­—ä¸ºåŸºç¡€ï¼Œå…·æœ‰è‡ªæˆ‘æè¿°æ€§ä¸”æ˜“äºè®©äººé˜…è¯»ã€‚å°½ç®¡JSONæ˜¯Javascript <a href="http://www.ecma-international.org/publications/files/ecma-st/ECMA-262.pdf" target="_blank" rel="external">Standard ECMA-262 3rd Edition â€“ December 1999</a>çš„ä¸€ä¸ªå­é›†ï¼Œä½†JSONæ˜¯ç‹¬ç«‹äºè¯­è¨€çš„æ–‡æœ¬æ ¼å¼ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ç±»ä¼¼äºCè¯­è¨€å®¶æ—çš„ä¸€äº›ä¹ æƒ¯, è¿™äº›ç‰¹æ€§ä½¿JSONæˆä¸ºç†æƒ³çš„æ•°æ®äº¤æ¢è¯­è¨€ã€‚</p>
<p>JSONä¸XMLæœ€å¤§çš„ä¸åŒåœ¨äºXMLæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ ‡è®°è¯­è¨€ï¼Œè€ŒJSONä¸æ˜¯ã€‚JSONç”±äºæ¯”XMLæ›´å°ã€æ›´å¿«ï¼Œæ›´æ˜“è§£æ,ä»¥åŠæµè§ˆå™¨çš„å†…å»ºå¿«é€Ÿè§£ææ”¯æŒ,ä½¿å¾—å…¶æ›´é€‚ç”¨äºç½‘ç»œæ•°æ®ä¼ è¾“é¢†åŸŸã€‚</p>
<p>åœ¨è®²è§£JSONçš„æ•°æ®ç»“æ„ä¹‹å‰, æˆ‘ä»¬å…ˆæ¥ä¸€æ®µç®€å•çš„æ ·ä¾‹JSONæ•°æ®:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="attr">"precision"</span>: <span class="string">"zip"</span>,</div><div class="line">        <span class="attr">"Latitude"</span>:  <span class="number">37.7668</span>,</div><div class="line">        <span class="attr">"Longitude"</span>: <span class="number">-122.3959</span>,</div><div class="line">        <span class="attr">"Address"</span>:   <span class="string">""</span>,</div><div class="line">        <span class="attr">"City"</span>:      <span class="string">"SAN FRANCISCO"</span>,</div><div class="line">        <span class="attr">"State"</span>:     <span class="string">"CA"</span>,</div><div class="line">        <span class="attr">"Zip"</span>:       <span class="string">"94107"</span>,</div><div class="line">        <span class="attr">"Country"</span>:   <span class="string">"US"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="attr">"precision"</span>: <span class="string">"zip"</span>,</div><div class="line">        <span class="attr">"Latitude"</span>:  <span class="number">37.371991</span>,</div><div class="line">        <span class="attr">"Longitude"</span>: <span class="number">-122.026020</span>,</div><div class="line">        <span class="attr">"Address"</span>:   <span class="string">""</span>,</div><div class="line">        <span class="attr">"City"</span>:      <span class="string">"SUNNYVALE"</span>,</div><div class="line">        <span class="attr">"State"</span>:     <span class="string">"CA"</span>,</div><div class="line">        <span class="attr">"Zip"</span>:       <span class="string">"94085"</span>,</div><div class="line">        <span class="attr">"Country"</span>:   <span class="string">"US"</span></div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>JSONå»ºæ„äºä¸¤ç§ç»“æ„:</p>
<ul>
<li>é”®å€¼å¯¹çš„é›†åˆ(A collection of name/value pairs): åœ¨ä¸åŒçš„è¯­è¨€ä¸­, ä»–ä»¬è¢«ç†è§£ä¸º: object(Javascript), struct(Golang), Dictinary(Python), ä»¥åŠå“ˆå¸Œè¡¨(hash table), æœ‰é”®åˆ—è¡¨(keyed list), æˆ–è€…å…³è”æ•°ç»„(associative array).<br><img src="http://json.org/object.gif" alt=""></li>
<li>å€¼çš„æœ‰åºåˆ—è¡¨(An ordered list of values): åœ¨å¤§éƒ¨åˆ†è¯­è¨€ä¸­ï¼Œå®ƒè¢«ç†è§£ä¸ºæ•°ç»„(array).<br><img src="http://json.org/array.gif" alt=""></li>
</ul>
<p>å…¶ä¸­å€¼å¯ä»¥åŒ…å«å¦‚ä¸‹ç±»å‹, å¹¶ä¸”è¿™äº›ç»“æ„å¯ä»¥åµŒå¥—:</p>
<ul>
<li>å­—ç¬¦ä¸²(string): ç”±åŒå¼•å·åŒ…å›´çš„ä»»æ„æ•°é‡Unicodeå­—ç¬¦çš„é›†åˆï¼Œä½¿ç”¨åæ–œçº¿è½¬ä¹‰, ä¸€ä¸ªå­—ç¬¦(character)å³ä¸€ä¸ªå•ç‹¬çš„å­—ç¬¦ä¸²(character string)</li>
<li>æ•°å€¼(number): åŒæ—¶åŒ…å«æ•´æ•°å’Œæµ®ç‚¹æ•°</li>
<li>å¸ƒå°”å€¼(booleans): å¸ƒå°”å€¼åŒ…å«: trueå’Œfalse</li>
<li>ç©º(null): ç©º</li>
<li>å¯¹è±¡(object): é”®å€¼å¯¹çš„é›†åˆ</li>
<li>æ•°ç»„(array): å€¼çš„æœ‰åºåˆ—è¡¨<br><img src="http://json.org/value.gif" alt=""></li>
</ul>
<p>è¿™äº›éƒ½æ˜¯å¸¸è§çš„æ•°æ®ç»“æ„ã€‚äº‹å®ä¸Šå¤§éƒ¨åˆ†ç°ä»£è®¡ç®—æœºè¯­è¨€éƒ½ä»¥æŸç§å½¢å¼æ”¯æŒå®ƒä»¬ã€‚è¿™ä½¿å¾—ä¸€ç§æ•°æ®æ ¼å¼åœ¨åŒæ ·åŸºäºè¿™äº›ç»“æ„çš„ç¼–ç¨‹è¯­è¨€ä¹‹é—´äº¤æ¢æˆä¸ºå¯èƒ½ã€‚</p>
<h2 id="JSONä¸Goæ•°æ®ç»“æ„æ˜ å°„"><a href="#JSONä¸Goæ•°æ®ç»“æ„æ˜ å°„" class="headerlink" title="JSONä¸Goæ•°æ®ç»“æ„æ˜ å°„"></a>JSONä¸Goæ•°æ®ç»“æ„æ˜ å°„</h2><p>JSONæ ¼å¼å¯ä»¥ç®—æˆ‘ä»¬æ—¥å¸¸æœ€å¸¸ç”¨çš„åºåˆ—åŒ–æ ¼å¼ä¹‹ä¸€äº†, Goè¯­è¨€ä½œä¸ºä¸€ä¸ªç”±Googleå¼€å‘, å·ç§°äº’è”ç½‘çš„Cè¯­è¨€çš„è¯­è¨€, è‡ªç„¶ä¹Ÿå¯¹JSONæ ¼å¼æ”¯æŒå¾ˆå¥½ã€‚<br>Golangçš„æ ‡å‡†åº“<code>encoding/json</code>å®ç°çš„JSONæ ‡å‡†(RFC 4627)çš„ç¼–ç å’Œè§£ç , å¯ä»¥è®©æˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œ<code>JSON</code>æ•°æ®çš„è½¬æ¢. </p>
<p>å…·ä½“è¯¦æƒ…å¯ä»¥å‚è€ƒæ ‡å‡†åº“<code>Marshal</code>å’Œ<code>Unmarshal</code>å‡½æ•°çš„æ³¨é‡Š, ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ•°æ®å…³ç³»æ˜ å°„æ€»ç»“:</p>
<table>
<thead>
<tr>
<th>Golang Type</th>
<th style="text-align:center">JSON Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool</td>
<td style="text-align:center">booleans</td>
<td style="text-align:center">true or false</td>
</tr>
<tr>
<td>int, float</td>
<td style="text-align:center">numbers</td>
<td style="text-align:center">å¯¹äºgolangæ‰€æœ‰çš„æ•°å€¼ç±»å‹</td>
</tr>
<tr>
<td>string</td>
<td style="text-align:center">strings</td>
<td style="text-align:center">å­—ç¬¦ä¸²ä¼šè½¬æ¢æˆ<code>UTF-8</code>è¿›è¡Œè¾“å‡ºï¼Œæ— æ³•è½¬æ¢çš„ä¼šæ‰“å°å¯¹åº”çš„<code>unicode</code>å€¼ã€‚è€Œä¸”ä¸ºäº†é˜²æ­¢æµè§ˆå™¨æŠŠjsonè¾“å‡ºå½“åšhtmlï¼Œ â€œ&lt;â€ã€â€&gt;â€ ä»¥åŠ â€œ&amp;â€ ä¼šè¢«è½¬ä¹‰ä¸º â€œ\u003câ€ã€â€\u003eâ€ å’Œ â€œ\u0026â€</td>
</tr>
<tr>
<td>array,slice</td>
<td style="text-align:center">arrays</td>
<td style="text-align:center">Publish Acknowledgment</td>
</tr>
<tr>
<td>struct</td>
<td style="text-align:center">objects</td>
<td style="text-align:center">åªæœ‰å¯¼å‡ºçš„å­—æ®µ(ä»¥å¤§å†™å­—æ¯å¼€å¤´)æ‰ä¼šåœ¨è¾“å‡ºä¸­</td>
</tr>
<tr>
<td>nil</td>
<td style="text-align:center">null</td>
<td style="text-align:center">ç©º</td>
</tr>
</tbody>
</table>
<p>Goè¯­è¨€æ˜¯ä¸ªå¼ºç±»å‹è¯­è¨€ï¼Œå¯¹æ ¼å¼è¦æ±‚æå…¶ä¸¥æ ¼è€ŒJSONæ ¼å¼è™½ç„¶ä¹Ÿæœ‰ç±»å‹ï¼Œä½†æ˜¯å¹¶ä¸ç¨³å®šï¼ŒGoè¯­è¨€åœ¨è§£ææ¥æºä¸ºéå¼ºç±»å‹è¯­è¨€æ—¶æ¯”å¦‚PHP,Pythonç­‰åºåˆ—åŒ–çš„JSONæ—¶ï¼Œç»å¸¸é‡åˆ°ä¸€äº›é—®é¢˜è¯¸å¦‚å­—æ®µç±»å‹å˜åŒ–å¯¼è‡´æ— æ³•æ­£å¸¸è§£æçš„æƒ…å†µï¼Œå¯¼è‡´æœåŠ¡ä¸ç¨³å®šã€‚æ‰€ä»¥åœ¨åšJSONç›¸å…³è§£ç å’Œç¼–ç çš„è¿‡ç¨‹ä¸­, éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é¡¹:</p>
<ul>
<li>Goè¯­è¨€ä¸­ä¸€äº›ç‰¹æ®Šçš„ç±»å‹ï¼Œæ¯”å¦‚Channelã€complexã€functionæ˜¯ä¸èƒ½è¢«è§£ææˆJSONçš„.</li>
<li>JSONå¯¹è±¡åªæ”¯æŒstringä½œä¸ºkeyï¼Œæ‰€ä»¥è¦ç¼–ç ä¸€ä¸ªmapï¼Œé‚£ä¹ˆå¿…é¡»æ˜¯map[string]Tè¿™ç§ç±»å‹(Tæ˜¯Goè¯­è¨€ä¸­ä»»æ„çš„ç±»å‹)</li>
<li>åµŒå¥—çš„æ•°æ®æ˜¯ä¸èƒ½ç¼–ç çš„ï¼Œä¸ç„¶ä¼šè®©JSONç¼–ç è¿›å…¥æ­»å¾ªç¯</li>
<li>æŒ‡é’ˆåœ¨ç¼–ç çš„æ—¶å€™ä¼šè¾“å‡ºæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œè€Œç©ºæŒ‡é’ˆä¼šè¾“å‡ºnull</li>
</ul>
<h2 id="æ ‡å‡†åº“è§£è¯»"><a href="#æ ‡å‡†åº“è§£è¯»" class="headerlink" title="æ ‡å‡†åº“è§£è¯»"></a>æ ‡å‡†åº“è§£è¯»</h2><p>åœ¨ä½¿ç”¨æ ‡å‡†åº“è¿›è¡Œjsonæ“ä½œä¹‹å‰, å…ˆç®€å•äº†è§£ä¸‹æ ‡å‡†åº“æä¾›äº†é‚£äº›å¯¹JSONçš„æ“ä½œ, ä»¥ä¸‹è§£è¯»ä¸»è¦æ¥æºäºGoDoc</p>
<h3 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h3><ul>
<li>Compact: ç”¨äºJSONå­—ç¬¦ä¸²çš„æ‹¼æ¥, æ‹¼æ¥æ—¶ä¼šæ ¡éªŒåé¢çš„å­—ç¬¦ä¸²æ˜¯å¦æ˜¯åˆæ³•json, å¦‚æœä¸æ˜¯ä¼šæŠ¥é”™, ä½†å¯¹å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦(htmlä¸å®‰å…¨å­—ç¬¦,æ¯”å¦‚ä¸Šé¢æåˆ°çš„â€&lt;â€ â€œ&gt;â€ç­‰)ä¸è¿›è¡Œè½¬ä¹‰.</li>
<li>HTMLEscape: å’ŒCompactç›¸å¯¹, æ‹¼æ¥JSONå­—ç¬¦ä¸²æ—¶ä¼šè¿›è¡Œç‰¹æ®Šå­—ç¬¦è½¬ä¹‰, è½¬ä¹‰æˆwebå®‰å…¨çš„å­—ç¬¦.</li>
<li>Valid: æ ¡éªŒæ•°æ®æ˜¯å¦æ˜¯åˆæ³•çš„JSONç¼–ç æ•°æ®, å¾€å¾€ç”¨äºæ•°æ®æ ¼å¼æ ¡éªŒ.</li>
<li>Marshal: ç”¨äºç¼–ç JSON.</li>
<li>Indent: ç”¨äºJSONçš„æ ¼å¼åŒ–è¾“å‡º, æœ€å¸¸è§çš„ç”¨æ³•æ˜¯å®šä¹‰JSONçš„ç¼©è¿›,æ¯”å¦‚2ä¸ªç©ºæ ¼çš„ç¼©è¿›.</li>
<li>MarshalIndent: ç¼–ç JSONå,å¸¦æ ¼å¼åŒ–çš„è¾“å‡º.</li>
<li>Unmarshal: ç”¨äºè§£ç JSON.</li>
</ul>
<h3 id="æ¥å£"><a href="#æ¥å£" class="headerlink" title="æ¥å£"></a>æ¥å£</h3><ul>
<li>Unmarshaler: ç”¨äºè‡ªå®šä¹‰è§£ç jsonæ–¹æ³•</li>
<li>Marshaler: ç”¨äºè‡ªå®šä¹‰ç¼–ç jsonçš„æ–¹æ³•</li>
</ul>
<h3 id="ç»“æ„ä½“"><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h3><ul>
<li>Decoder: ä»ä¸€ä¸ªè¾“å…¥æµè¯»å–æ•°æ®å¹¶ä¸”è§£æjson</li>
<li>Encoder: æŠŠä¸€ä¸ªç¼–ç åçš„jsonå€¼å†™å‡ºç»™ä¸€ä¸ªè¾“å‡ºæµ</li>
<li>Number: JSONé‡Œé¢çš„numberç±»å‹</li>
<li>RawMessage: æ˜¯ä¸€ç§å·²ç»è¢«ç¼–ç çš„jsonå­—ç¬¦ä¸², å®ƒå®ç°äº†Marshalerå’ŒUnmarshaler, å¯ä»¥ç”¨æ¥å»¶è¿Ÿè§£æéƒ¨åˆ†json</li>
<li>Token: ä¸€ä¸ªç©ºinterface,  æŒæœ‰ä¸€ç§Jsonæ˜ å°„çš„Goå†…éƒ¨æ•°æ®ç»“æ„çš„å€¼</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Delim, for the four JSON delimiters [ ] &#123; &#125;</div><div class="line">bool, for JSON booleans</div><div class="line">float64, for JSON numbers</div><div class="line">Number, for JSON numbers</div><div class="line">string, for JSON string literals</div><div class="line">nil, for JSON null</div></pre></td></tr></table></figure>
<h3 id="å¼‚å¸¸"><a href="#å¼‚å¸¸" class="headerlink" title="å¼‚å¸¸"></a>å¼‚å¸¸</h3><ul>
<li>InvalidUTF8Error: ç”¨äºå…¼å®¹golang1.2ç‰ˆæœ¬ä¹‹å‰, 1.2è¿‡åä¸ä¼šæœ‰è¯¥å¼‚å¸¸</li>
<li>InvalidUnmarshalError: è¡¨ç¤ºè§£ç jsonæ—¶ä¼ é€’äº†ä¸€ä¸ªéæ³•çš„å‚æ•°, æ¯”å¦‚ä¸€ä¸ªç©ºæŒ‡é’ˆ</li>
<li>MarshalerError: Marshalerå¼‚å¸¸ </li>
<li>SyntaxError: jsonçš„è¯­æ³•é”™è¯¯</li>
<li>UnmarshalFieldError: é™çº§, æœªä½¿ç”¨, ä¸ºäº†å…¼å®¹ä¿ç•™</li>
<li>UnmarshalTypeError: è§£ç æ—¶ é‡åˆ°ä¸è®¤è¯†çš„jsonç±»å‹, è¡¨æ˜ä¼ å…¥çš„jsonçš„ç±»å‹æ— æ³•è¢«è½¬æ¢æˆGolangå¯¹åº”çš„ç±»å‹, æ¯”å¦‚JSON RFCå¢åŠ æ–°çš„JSONç±»å‹ å°±ä¼šé‡åˆ°è¿™æ ·çš„é”™è¯¯</li>
<li>UnsupportedTypeError: ç¼–ç æ—¶ é‡åˆ°ä¸è®¤è¯†çš„Golangç±»å‹, ä¸çŸ¥é“è¯¥Golangçš„æ•°æ®ç±»å‹åº”è¯¥è¢«æ˜ å°„æˆé‚£ç§jsonç±»å‹, æ¯”å¦‚è‡ªå®šä¹‰çš„ç±»å‹(æœªå®ç° marshaleræ¥å£)</li>
<li>UnsupportedValueError: åŒä¸Š, é‡åˆ°ä¸è®¤è¯†çš„jsonç±»å‹, æ¯”å¦‚ ä½ éœ€è¦å°†golangé‡Œé¢çš„â€aâ€ç¼–ç¨‹æˆjsoné‡Œé¢ä¸å­˜åœ¨çš„ç±»å‹</li>
</ul>
<h2 id="Struct-Tag"><a href="#Struct-Tag" class="headerlink" title="Struct Tag"></a>Struct Tag</h2><p>åœ¨JSONçš„è§£æè¿‡ç¨‹ä¸­<code>Struct Tag</code>è¢«é¢‘ç¹ä½¿ç”¨, å› æ­¤åœ¨è¿›è¡ŒçœŸæ­£çš„è§£æä¹‹å‰, ä»‹ç»ä¸‹Golangä¸­çš„<code>Struct Tag</code>,åœ¨golangä¸­, å‘½åéƒ½æ˜¯æ¨èéƒ½æ˜¯ç”¨é©¼å³°æ–¹å¼, å¹¶ä¸”åœ¨é¦–å­—æ¯å¤§å°å†™æœ‰ç‰¹æ®Šçš„è¯­æ³•å«ä¹‰(å¤§å†™å˜é‡å¯ä»¥å¯¼å‡ºåŒ…, å°å†™å˜é‡åŒ…ç§æœ‰)ã€‚ä½†æ˜¯ç”±äºç»å¸¸éœ€è¦å’Œå…¶å®ƒçš„ç³»ç»Ÿè¿›è¡Œæ•°æ®äº¤äº’, ä¾‹å¦‚è½¬æˆjsonæ ¼å¼, å­˜å‚¨åˆ°mongodbå•Šç­‰ç­‰ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœç”¨å±æ€§åæ¥ä½œä¸ºé”®å€¼å¯èƒ½ä¸ä¸€å®šä¼šç¬¦åˆé¡¹ç›®è¦æ±‚, æ¯”å¦‚ä¸æ˜¯ç”¨<code>Struct Tag</code>æ—¶, JSONè§£æå‡ºæ¥çš„ç»“æœæ˜¯è¿™æ ·çš„:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// User is test for json</span></div><div class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</div><div class="line">	ID   <span class="keyword">string</span></div><div class="line">	Name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	u := User&#123;ID: <span class="string">"user001"</span>, Name: <span class="string">"tom"</span>&#125;</div><div class="line">	jsonU, _ := json.Marshal(u)</div><div class="line">	fmt.Println(<span class="keyword">string</span>(jsonU))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºå†…å®¹å¦‚ä¸‹:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"ID"</span>:<span class="string">"user001"</span>,<span class="attr">"Name"</span>:<span class="string">"tom"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>æ˜¾ç„¶å¦‚æœè¿™æ ·è§£æJSONä¼šå¤ªæ­»æ¿, æ— æ³•é¢å¯¹çµæ´»çš„ä¸šåŠ¡, è€Œå…·ä½“å¦‚ä½•è½¬æ¢åº”è¯¥äº¤ç»™æˆ‘ä»¬è‡ªå·±æ§åˆ¶, è€Œ<code>Struct Tag</code>å°±æ˜¯ç”¨æ¥å¹²è¿™ä¸ªäº‹å„¿çš„ã€‚<br><code>Struct Tag</code>é‡‡ç”¨ <figure class="highlight plain"><figcaption><span>è·Ÿéšåœ¨Struct Fieldåé¢ã€‚</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">é‚£`Struct Tag`çš„å·¥ä½œåŸç†æ˜¯å’‹æ ·çš„? éœ€è¦ç”¨åˆ°Tagä¸­çš„å†…å®¹æ—¶, å’‹æ ·å»è·å–å–ƒ? å…¶å®æ˜¯ä½¿ç”¨åå°„(reflect)ä¸­çš„æ–¹æ³•æ¥è·å–çš„:</div><div class="line">```golang</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">	&quot;fmt&quot;</div><div class="line">	&quot;reflect&quot;</div><div class="line">)</div><div class="line"></div><div class="line">// User is test for json</div><div class="line">type User struct &#123;</div><div class="line">	ID   string `json:&quot;json_id&quot; bson:&quot;bson_id&quot; custom:&quot;my_id&quot;`</div><div class="line">	Name string `json:&quot;json_name&quot; bson:&quot;bson_name&quot; custom:&quot;my_name&quot;`</div><div class="line">&#125;</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">	u := &amp;User&#123;ID: &quot;user001&quot;, Name: &quot;tom&quot;&#125;</div><div class="line">	t := reflect.TypeOf(u)</div><div class="line"></div><div class="line">	// è·å–ç¬¬ä¸€ä¸ªå­—æ®µçš„Struct Tagçš„å€¼</div><div class="line">	f0 := t.Elem().Field(0)</div><div class="line">	fmt.Println(f0.Tag.Get(&quot;json&quot;))</div><div class="line">	fmt.Println(f0.Tag.Get(&quot;bson&quot;))</div><div class="line">	fmt.Println(f0.Tag.Get(&quot;custom&quot;))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">json_id</div><div class="line">bson_id</div><div class="line">my_id</div></pre></td></tr></table></figure></p>
<h2 id="è§£æJSON"><a href="#è§£æJSON" class="headerlink" title="è§£æJSON"></a>è§£æJSON</h2><p>é€šè¿‡æ ‡å‡†åº“æä¾›çš„Unmarshalå‡½æ•°æ¥è§£æJSON, ä½†æ˜¯æ ‡å‡†åº“åœ¨è§£ææœªçŸ¥æ ¼å¼çš„JSONæ—¶æ¯”è¾ƒéº»çƒ¦, éœ€è¦è§£æåˆ°interface{},ç„¶åæ–­è¨€, å› æ­¤å¦‚æœæƒ³è¦çµæ´»çš„è§£æJSONå¯ä»¥ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“,æ¯”å¦‚<code>jsonitor</code></p>
<h3 id="è§£æå·²çŸ¥JSON"><a href="#è§£æå·²çŸ¥JSON" class="headerlink" title="è§£æå·²çŸ¥JSON"></a>è§£æå·²çŸ¥JSON</h3><p>ä¹‹å‰ä»‹ç»äº†Golangä¸­çš„<code>Struct Tag</code>, è€Œæ ‡å‡†åº“<code>encoding/json</code>å°±æ˜¯åˆ©ç”¨<code>Stuct Tag</code>å¯ä»¥è½»æ¾å®ç°JSONç¼–è§£ç è¿‡ç¨‹ä¸­çš„ä¸€äº›è‡ªå®šä¹‰è½¬æ¢, è€Œå…³äºJSON <code>Struct Tag</code>å…·ä½“çš„å€¼, æ ‡å‡†åº“æ–‡æ¡£é‡Œé¢æœ‰ç›¸åº”çš„æè¿°, è¿™é‡Œä½œç®€å•çš„æ¦‚è¿°:</p>
<ul>
<li>Json Struct Tag æ ¼å¼ä¸º<code>json: &quot;filed_name,argument&quot;</code></li>
<li>filed_name ä¸ºç”¨æˆ·è‡ªå®šä¹‰çš„éœ€è¦è½¬æ¢çš„å­—æ®µå, å¦‚æœä¸ºâ€-â€œè¡¨ç¤º è½¬æ¢æ—¶ç›´æ¥å¿½ç•¥å­—æ®µ</li>
<li>argument è¡¨ç¤ºè¯¥å­—æ®µè½¬æ¢æ—¶çš„ä¸€äº›é¢å¤–çš„å‚æ•°<ul>
<li>omitempty è¡¨ç¤ºå¦‚æœä¸ºç©ºç½®åˆ™å¿½ç•¥å­—æ®µ</li>
<li>jsonæ•°æ®ç±»å‹, æ¯”å¦‚string, numbers, è¡¨ç¤ºåœ¨è½¬æ¢æ—¶, è°ƒæ•´æˆå¯¹åº”çš„æ•°æ®ç±»å‹</li>
</ul>
</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Product _</span></div><div class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</div><div class="line">	Name      <span class="keyword">string</span>  <span class="string">`json:"name"`</span></div><div class="line">	ProductID <span class="keyword">int64</span>   <span class="string">`json:"product_id,string"`</span></div><div class="line">	Number    <span class="keyword">int</span>     <span class="string">`json:"number,string"`</span></div><div class="line">	Price     <span class="keyword">float64</span> <span class="string">`json:"price,string"`</span></div><div class="line">	IsOnSale  <span class="keyword">bool</span>    <span class="string">`json:"is_on_sale,string"`</span></div><div class="line">	Test      <span class="keyword">string</span>  <span class="string">`json:"-"`</span></div><div class="line">	OMTest    <span class="keyword">string</span>  <span class="string">`json:"om_test,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	str := <span class="string">`&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125;`</span></div><div class="line">	p := Product&#123;&#125;</div><div class="line"></div><div class="line">	json.Unmarshal([]<span class="keyword">byte</span>(str), &amp;p)</div><div class="line">	fmt.Println(p)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="built_in">test</span> 1 110011 0.01 <span class="literal">true</span>  &#125;</div></pre></td></tr></table></figure></p>
<h3 id="è§£ææœªçŸ¥JSON"><a href="#è§£ææœªçŸ¥JSON" class="headerlink" title="è§£ææœªçŸ¥JSON"></a>è§£ææœªçŸ¥JSON</h3><p>ä¸Šé¢é‚£ç§è§£ææ–¹å¼æ˜¯åœ¨æˆ‘ä»¬çŸ¥æ™“è¢«è§£æçš„JSONæ•°æ®çš„ç»“æ„çš„å‰æä¸‹é‡‡å–çš„æ–¹æ¡ˆ, å¦‚æœæˆ‘ä»¬ä¸çŸ¥é“è¢«è§£æçš„æ•°æ®çš„æ ¼å¼, åˆåº”è¯¥å¦‚ä½•æ¥è§£æå‘¢?<br>æˆ‘ä»¬çŸ¥é“interface{}å¯ä»¥ç”¨æ¥å­˜å‚¨ä»»æ„æ•°æ®ç±»å‹çš„å¯¹è±¡ï¼Œè¿™ç§æ•°æ®ç»“æ„æ­£å¥½ç”¨äºå­˜å‚¨è§£æçš„æœªçŸ¥ç»“æ„çš„jsonæ•°æ®çš„ç»“æœã€‚JSONåŒ…ä¸­é‡‡ç”¨map[string]interface{}å’Œ[]interface{}ç»“æ„æ¥å­˜å‚¨ä»»æ„çš„JSONå¯¹è±¡å’Œæ•°ç»„ã€‚</p>
<ol>
<li>è§£æåˆ°interface{}<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Product _</span></div><div class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</div><div class="line">	Name      <span class="keyword">string</span>  <span class="string">`json:"name"`</span></div><div class="line">	ProductID <span class="keyword">int64</span>   <span class="string">`json:"product_id,string"`</span></div><div class="line">	Number    <span class="keyword">int</span>     <span class="string">`json:"number,string"`</span></div><div class="line">	Price     <span class="keyword">float64</span> <span class="string">`json:"price,string"`</span></div><div class="line">	IsOnSale  <span class="keyword">bool</span>    <span class="string">`json:"is_on_sale,string"`</span></div><div class="line">	Test      <span class="keyword">string</span>  <span class="string">`json:"-"`</span></div><div class="line">	OMTest    <span class="keyword">string</span>  <span class="string">`json:"om_test,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// å‡è®¾æˆ‘ä»¬å¹¶ä¸çŸ¥é“è¿™ä¸ªJSONçš„æ ¼å¼, æˆ‘ä»¬å¯ä»¥å°†ä»–è§£æåˆ°interface&#123;&#125;</span></div><div class="line">	str := <span class="string">`&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125;`</span></div><div class="line">	<span class="keyword">var</span> p <span class="keyword">interface</span>&#123;&#125;</div><div class="line">	json.Unmarshal([]<span class="keyword">byte</span>(str), &amp;p)</div><div class="line"></div><div class="line">	<span class="comment">// ç°åœ¨æˆ‘ä»¬éœ€è¦ä»è¿™ä¸ªinterface&#123;&#125;è§£æå‡ºé‡Œé¢çš„æ•°æ®</span></div><div class="line">	m := p.(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</div><div class="line">		<span class="keyword">switch</span> vv := v.(<span class="keyword">type</span>) &#123;</div><div class="line">		<span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">			fmt.Printf(<span class="string">"%s is string, value: %s\n"</span>, k, vv)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">int</span>:</div><div class="line">			fmt.Printf(<span class="string">"%s is int, value: %d\n"</span>, k, vv)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">int64</span>:</div><div class="line">			fmt.Printf(<span class="string">"%s is int64, value: %d\n"</span>, k, vv)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">bool</span>:</div><div class="line">			fmt.Printf(<span class="string">"%s is bool, vaule: %v"</span>, k, vv)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			fmt.Printf(<span class="string">"%s is unknow type\n"</span>, k)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>è¾“å‡ºç»“æœ:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">name is string, value: <span class="built_in">test</span></div><div class="line">product_id is string, value: 1</div><div class="line">number is string, value: 110011</div><div class="line">price is string, value: 0.01</div><div class="line">is_on_sale is string, value: <span class="literal">true</span></div></pre></td></tr></table></figure></p>
<ol>
<li>ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“<code>jsonitor</code>è¿›è¡Œè§£æ<br>å¤§é‡çš„ç±»å‹æ–­è¨€æ˜¯ä¸æ˜¯è®©ä½ è§‰å¾—å¾ˆçƒ¦, å¦‚æœæ˜¯å¤šå±‚interface{}åµŒå¥—é‚£ä¹ˆæ–­è¨€éœ€è¦æ›´å¤š, å› æ­¤å°±æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹JSONè§£æåº“å‡ºç°, ä»–ä»¬å°½é‡é‡‡ç”¨æµå¼è¿­ä»£è§£æ, è¿™é‡Œæˆ‘ç”¨è¿‡çš„æ¯”è¾ƒä¸é”™çš„æ˜¯é™¶æ–‡çš„<code>jsonitor</code>:<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/json-iterator/go"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Product _</span></div><div class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</div><div class="line">	Name      <span class="keyword">string</span>  <span class="string">`json:"name"`</span></div><div class="line">	ProductID <span class="keyword">int64</span>   <span class="string">`json:"product_id,string"`</span></div><div class="line">	Number    <span class="keyword">int</span>     <span class="string">`json:"number,string"`</span></div><div class="line">	Price     <span class="keyword">float64</span> <span class="string">`json:"price,string"`</span></div><div class="line">	IsOnSale  <span class="keyword">bool</span>    <span class="string">`json:"is_on_sale,string"`</span></div><div class="line">	Test      <span class="keyword">string</span>  <span class="string">`json:"-"`</span></div><div class="line">	OMTest    <span class="keyword">string</span>  <span class="string">`json:"om_test,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	str := <span class="string">`&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125;`</span></div><div class="line">	fmt.Println(jsoniter.Get([]<span class="keyword">byte</span>(str), <span class="string">"price"</span>).ToFloat64())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="è‡ªå®šä¹‰è§£æ"><a href="#è‡ªå®šä¹‰è§£æ" class="headerlink" title="è‡ªå®šä¹‰è§£æ"></a>è‡ªå®šä¹‰è§£æ</h3><p>structå®ç°Unmarshaleræ¥å£, ä¾¿å¯ä»¥å®ç°è§£æJSONçš„è¿‡ç¨‹,<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Product _</span></div><div class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</div><div class="line">	Name      <span class="keyword">string</span>  <span class="string">`json:"name"`</span></div><div class="line">	ProductID <span class="keyword">int64</span>   <span class="string">`json:"product_id,string"`</span></div><div class="line">	Number    <span class="keyword">int</span>     <span class="string">`json:"number,string"`</span></div><div class="line">	Price     <span class="keyword">float64</span> <span class="string">`json:"price,string"`</span></div><div class="line">	IsOnSale  <span class="keyword">bool</span>    <span class="string">`json:"is_on_sale,string"`</span></div><div class="line">	Test      <span class="keyword">string</span>  <span class="string">`json:"-"`</span></div><div class="line">	OMTest    <span class="keyword">string</span>  <span class="string">`json:"om_test,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// UnmarshalJSON è‡ªå®šä¹‰è§£æ</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Product)</span> <span class="title">UnmarshalJSON</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// ç¤ºä¾‹ä»£ç ä½¿ç”¨jsonitorä»£ä¸ºè§£æ</span></div><div class="line">	p.Price = <span class="number">0.01</span></div><div class="line">	p.Number = <span class="number">1100</span></div><div class="line">	p.Name = <span class="string">"my_test_name"</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MarshalJSON è‡ªå®šä¹‰ç¼–ç </span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Product)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="comment">// è‡ªå·±ç¼–ç json</span></div><div class="line">	<span class="keyword">return</span> []<span class="keyword">byte</span>(<span class="string">`&#123;"test":"name_test"&#125;`</span>), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	str := <span class="string">`&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125;`</span></div><div class="line">	p := Product&#123;&#125;</div><div class="line"></div><div class="line">	json.Unmarshal([]<span class="keyword">byte</span>(str), &amp;p)</div><div class="line">	fmt.Println(p)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ç”ŸæˆJSON"><a href="#ç”ŸæˆJSON" class="headerlink" title="ç”ŸæˆJSON"></a>ç”ŸæˆJSON</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ ‡å‡†åº“jsonå°†Strucåºåˆ—åŒ–æˆJSONä¹Ÿå¯ä»¥è‡ªå®šä¹‰åºåˆ—åŒ–çš„æ–¹æ³•</p>
<h3 id="é€šè¿‡structç”ŸæˆJSON"><a href="#é€šè¿‡structç”ŸæˆJSON" class="headerlink" title="é€šè¿‡structç”ŸæˆJSON"></a>é€šè¿‡structç”ŸæˆJSON</h3><p>ä¸Šé¢åœ¨ä»‹ç»JSONè§£æçš„æ—¶å€™å·²ç»ä»‹ç»äº†å…³äºJSONçš„<code>Struct Tag</code>äº†, å› æ­¤ç›´æ¥å‚è€ƒä»£ç :<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Product _</span></div><div class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</div><div class="line">	Name      <span class="keyword">string</span>  <span class="string">`json:"name"`</span></div><div class="line">	ProductID <span class="keyword">int64</span>   <span class="string">`json:"product_id,string"`</span></div><div class="line">	Number    <span class="keyword">int</span>     <span class="string">`json:"number,string"`</span></div><div class="line">	Price     <span class="keyword">float64</span> <span class="string">`json:"price,string"`</span></div><div class="line">	IsOnSale  <span class="keyword">bool</span>    <span class="string">`json:"is_on_sale,string"`</span></div><div class="line">	Test      <span class="keyword">string</span>  <span class="string">`json:"-"`</span></div><div class="line">	OMTest    <span class="keyword">string</span>  <span class="string">`json:"om_test,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	p := &amp;Product&#123;</div><div class="line">		Name:      <span class="string">"test"</span>,</div><div class="line">		ProductID: <span class="number">01</span>,</div><div class="line">		Number:    <span class="number">110011</span>,</div><div class="line">		Price:     <span class="number">0.01</span>,</div><div class="line">		IsOnSale:  <span class="literal">true</span>,</div><div class="line">		Test:      <span class="string">"test"</span>,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	jsonP, _ := json.Marshal(p)</div><div class="line">	fmt.Println(<span class="keyword">string</span>(jsonP))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"name"</span>:<span class="string">"test"</span>,<span class="attr">"product_id"</span>:<span class="string">"1"</span>,<span class="attr">"number"</span>:<span class="string">"110011"</span>,<span class="attr">"price"</span>:<span class="string">"0.01"</span>,<span class="attr">"is_on_sale"</span>:<span class="string">"true"</span>&#125;</div></pre></td></tr></table></figure></p>
<h3 id="è‡ªå®šä¹‰ç”Ÿæˆ"><a href="#è‡ªå®šä¹‰ç”Ÿæˆ" class="headerlink" title="è‡ªå®šä¹‰ç”Ÿæˆ"></a>è‡ªå®šä¹‰ç”Ÿæˆ</h3><p>Structå®ç°Marshaleræ¥å£, ä¾¿å¯ä»¥è‡ªå®šä¹‰ç¼–ç è¿‡ç¨‹<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Product _</span></div><div class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</div><div class="line">	Name      <span class="keyword">string</span>  <span class="string">`json:"name"`</span></div><div class="line">	ProductID <span class="keyword">int64</span>   <span class="string">`json:"product_id,string"`</span></div><div class="line">	Number    <span class="keyword">int</span>     <span class="string">`json:"number,string"`</span></div><div class="line">	Price     <span class="keyword">float64</span> <span class="string">`json:"price,string"`</span></div><div class="line">	IsOnSale  <span class="keyword">bool</span>    <span class="string">`json:"is_on_sale,string"`</span></div><div class="line">	Test      <span class="keyword">string</span>  <span class="string">`json:"-"`</span></div><div class="line">	OMTest    <span class="keyword">string</span>  <span class="string">`json:"om_test,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// UnmarshalJSON è‡ªå®šä¹‰è§£æ</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Product)</span> <span class="title">UnmarshalJSON</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// ç¤ºä¾‹ä»£ç ä½¿ç”¨jsonitorä»£ä¸ºè§£æ</span></div><div class="line">	p.Price = <span class="number">0.01</span></div><div class="line">	p.Number = <span class="number">1100</span></div><div class="line">	p.Name = <span class="string">"my_test_name"</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MarshalJSON è‡ªå®šä¹‰ç¼–ç </span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Product)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="comment">// è‡ªå·±ç¼–ç json</span></div><div class="line">	<span class="keyword">return</span> []<span class="keyword">byte</span>(<span class="string">`&#123;"test":"name_test"&#125;`</span>), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	p := &amp;Product&#123;</div><div class="line">		Name:      <span class="string">"test"</span>,</div><div class="line">		ProductID: <span class="number">01</span>,</div><div class="line">		Number:    <span class="number">110011</span>,</div><div class="line">		Price:     <span class="number">0.01</span>,</div><div class="line">		IsOnSale:  <span class="literal">true</span>,</div><div class="line">		Test:      <span class="string">"test"</span>,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	jsonP, _ := json.Marshal(p)</div><div class="line">	fmt.Println(<span class="keyword">string</span>(jsonP))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="http://json.org/json-zh.html" target="_blank" rel="external">JSONå®˜æ–¹ä»‹ç»</a></li>
<li><a href="https://tools.ietf.org/html/rfc4627" target="_blank" rel="external">JSON RFC4672</a></li>
<li><a href="https://godoc.org/encoding/json" target="_blank" rel="external">encoding/json godoc</a></li>
<li><a href="https://blog.golang.org/json-and-go" target="_blank" rel="external">Go Blog: JSON and Go</a></li>
<li><a href="http://blog.csdn.net/impressionw/article/details/74731888" target="_blank" rel="external">Golangä¸­ä½¿ç”¨JSONçš„ä¸€äº›å°æŠ€å·§</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å‰æˆ‘ä»¬çœ‹åˆ°å¾ˆå¤šçš„å¼€æ”¾å¹³å°ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯é‡‡ç”¨äº†JSONä½œä¸ºä»–ä»¬çš„æ•°æ®äº¤äº’çš„æ ¼å¼ã€‚æ—¢ç„¶JSONåœ¨Webå¼€å‘ä¸­å¦‚æ­¤é‡è¦ï¼Œé‚£ä¹ˆGoè¯­è¨€å¯¹JSONæ”¯æŒçš„æ€ä¹ˆæ ·å‘¢ï¼ŸGoè¯­è¨€çš„æ ‡å‡†åº“å·²ç»éå¸¸å¥½çš„æ”¯æŒäº†JSONï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„å¯¹JSONæ•°æ®è¿›è¡Œç¼–ã€è§£ç çš„å·¥ä½œã€‚å¦‚æœæœ‰æ›´çµæ´»çš„éœ€æ±‚ä¹Ÿæœ‰ä¸é”™çš„ç¬¬ä¸‰æ–¹åº“æä¾›æ”¯æŒã€‚è¿™ç¯‡æ–‡ç« å°†å…¨é¢è§£è¯»Golangä¸­JSONçš„ä½¿ç”¨ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="json" scheme="https://blog.yumaojun.net/tags/json/"/>
    
  </entry>
  
  <entry>
    <title>gRPCåŸºäºæ‹¦æˆªå™¨æ¨¡å¼çš„è®¤è¯</title>
    <link href="https://blog.yumaojun.net/2017/08/07/grpc-auth/"/>
    <id>https://blog.yumaojun.net/2017/08/07/grpc-auth/</id>
    <published>2017-08-06T23:16:35.000Z</published>
    <updated>2017-08-08T03:15:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>gRPCçš„æœåŠ¡ç«¯éœ€è¦ä¸è®¤è¯å¹³å°å¯¹æ¥, ä¹‹å‰ä½¿ç”¨httpæ—¶é€šè¿‡ä¸­é—´ä»¶çš„å½¢å¼è¿›è¡Œå®ç°, å› æ­¤è¿™ç¯‡æ–‡ç« ä¸»è¦éªŒè¯gRPCä¸­èƒ½å¦ä»¥ä¸­é—´ä»¶çš„å½¢å¼å®ç°gRPCçš„è®¤è¯ã€‚<br><a id="more"></a></p>
<h2 id="è®¤è¯æ–¹å¼"><a href="#è®¤è¯æ–¹å¼" class="headerlink" title="è®¤è¯æ–¹å¼"></a>è®¤è¯æ–¹å¼</h2><p>gRPC é»˜è®¤æä¾›äº†ä¸¤ç§è®¤è¯æ–¹å¼ï¼š</p>
<ul>
<li>åŸºäºSSL/TLSè®¤è¯æ–¹å¼</li>
<li>è¿œç¨‹è°ƒç”¨è®¤è¯æ–¹å¼<br>ä¸ºäº†ä¿è¯API Gatewayä¸åç«¯gRPCæœåŠ¡é€šä¿¡çš„å®‰å…¨åŒæ—¶ä¿è¯tokenå®‰å…¨, ä»¥ä¸Š2ç§æ–¹å¼åŒæ—¶ä½¿ç”¨ã€‚</li>
</ul>
<h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><p>æˆ‘éœ€è¦éªŒè¯çš„æµç¨‹å¤§è‡´å¦‚ä¸‹(ä¸Openstackçš„è®¤è¯æµç¨‹ä¸€æ ·):<br><img src="http://oiw1gzfww.bkt.clouddn.com/auth-flow.png" alt=""><br>å®Œæ•´çš„ä»£ç†ç¤ºä¾‹: <a href="https://github.com/yumaojun03/golang/tree/master/grpc-auth" target="_blank" rel="external">grpcä¸­é—´ä»¶è®¤è¯</a></p>
<p>åœ¨è¿›è¡Œcodingå‰, æˆ‘ä»¬éœ€è¦ä¸ºæœåŠ¡ç«¯ç”ŸæˆTLSéœ€è¦çš„è¯ä¹¦:</p>
<ul>
<li><p>è‡ªå»ºCA</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ç”ŸæˆCAè‡ªå·±çš„ç§é’¥</span></div><div class="line">$(<span class="built_in">umask</span> 077; openssl genrsa -out private/cakey.pem 2048)</div><div class="line"><span class="comment"># è‡ªç­¾10å¹´</span></div><div class="line"><span class="variable">$openssl</span> req -new -x509 -key private/cakey.pem -out cacert.pem</div><div class="line">Country Name (2 letter code) [AU]:CN</div><div class="line">State or Province Name (full name) [Some-State]:SiChuan</div><div class="line">Locality Name (eg, city) []:ChengDu</div><div class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:defineIOT Ltd</div><div class="line">Organizational Unit Name (eg, section) []:Tec</div><div class="line">Common Name (e.g. server FQDN or YOUR name) []:ca</div><div class="line">Email Address []:yumaojun03@gmail.com</div><div class="line"><span class="comment"># åˆå§‹åŒ–è‡ªå»ºCAçš„ä¸€éƒ¨åˆ†æ–‡ä»¶</span></div><div class="line"><span class="variable">$mkdir</span> certs newcerts crl</div><div class="line"><span class="variable">$touch</span> index.txt</div><div class="line"><span class="variable">$touch</span> serial</div><div class="line"><span class="variable">$echo</span> 01 &gt; serial</div></pre></td></tr></table></figure>
</li>
<li><p>ç­¾å‘æœåŠ¡ç«¯è¯ä¹¦</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ç”Ÿæˆserverè‡ªå·±çš„ç§é’¥</span></div><div class="line"><span class="variable">$openssl</span> genrsa -out server1.key 2048</div><div class="line"><span class="comment"># ç”Ÿæˆè¯ä¹¦ç­¾è¯è¯·æ±‚</span></div><div class="line"><span class="variable">$openssl</span> req -new -key server1.key -out server1.csr</div><div class="line">Country Name (2 letter code) [AU]:CN</div><div class="line">State or Province Name (full name) [Some-State]:Chengdu</div><div class="line">Locality Name (eg, city) []:Chengdu</div><div class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:defineIOT Ltd</div><div class="line">Organizational Unit Name (eg, section) []:Tec</div><div class="line">Common Name (e.g. server FQDN or YOUR name) []:server1</div><div class="line">Email Address []:yumaojun03@gmail.com</div><div class="line"></div><div class="line">Please enter the following <span class="string">'extra'</span> attributes</div><div class="line">to be sent with your certificate request</div><div class="line">A challenge password []:</div><div class="line">An optional company name []:</div><div class="line"><span class="comment"># å› ä¸ºæˆ‘CAå°±åœ¨æœ¬æœåŠ¡å™¨ä¸Š,ç›´æ¥ç­¾å‘è¯ä¹¦</span></div><div class="line"><span class="variable">$openssl</span> ca -in GoWorkDir/src/golang/grpc-auth/keys/server1.csr -out server1.pem -days 3650</div><div class="line">Using configuration from /System/Library/OpenSSL/openssl.cnf</div><div class="line">Check that the request matches the signature</div><div class="line">Signature ok</div><div class="line">The stateOrProvinceName field needed to be the same <span class="keyword">in</span> the</div><div class="line">CA certificate (SiChuan) and the request (Chengdu)</div><div class="line"><span class="comment"># å°†ç­¾å¥½çš„è¯ä¹¦äº¤ç»™server</span></div><div class="line"><span class="variable">$mv</span> server1.pem GoWorkDir/src/golang/grpc-auth/keys</div><div class="line"><span class="comment"># serverç«¯çš„è¯ä¹¦å‡†å¤‡å®Œæˆ</span></div><div class="line"><span class="variable">$ll</span> GoWorkDir/src/golang/grpc-auth/keys</div><div class="line">total 40</div><div class="line">-rw-r--r--  1 maojun  staff   1.6K  8  8 09:15 cacert.pem</div><div class="line">-rw-r--r--  1 maojun  staff   1.0K  8  8 09:27 server1.csr</div><div class="line">-rw-r--r--  1 maojun  staff   1.6K  8  7 21:21 server1.key</div><div class="line">-rw-r--r--  1 maojun  staff   4.5K  8  8 09:28 server1.pem</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><p>ç”Ÿæˆå¥‘çº¦æ–‡ä»¶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$protoc</span> --go_out=plugins=grpc:. hello.proto</div></pre></td></tr></table></figure></p>
<p>ç›®å½•ç»“æ„å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$tree</span> .</div><div class="line">.</div><div class="line">â”œâ”€â”€ client</div><div class="line">â”‚Â Â  â””â”€â”€ main.go</div><div class="line">â”œâ”€â”€ keys</div><div class="line">â”‚Â Â  â”œâ”€â”€ cacert.pem</div><div class="line">â”‚Â Â  â”œâ”€â”€ server1.csr</div><div class="line">â”‚Â Â  â”œâ”€â”€ server1.key</div><div class="line">â”‚Â Â  â””â”€â”€ server1.pem</div><div class="line">â”œâ”€â”€ proto</div><div class="line">â”‚Â Â  â”œâ”€â”€ hello.pb.go</div><div class="line">â”‚Â Â  â””â”€â”€ hello.proto</div><div class="line">â””â”€â”€ server</div><div class="line">    â””â”€â”€ main.go</div></pre></td></tr></table></figure></p>
<h3 id="tls"><a href="#tls" class="headerlink" title="tls"></a>tls</h3><p>å…ˆçœ‹credentials.goä¸­å…³äºé€šè¿‡TLSåˆ›å»ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸å…³å‡½æ•°<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewClientTLSFromFile ä¼ å…¥å®¢æˆ·ç«¯å»ºç«‹TLSè¿æ¥æ—¶éœ€è¦çš„è¯ä¹¦, è¿™é‡Œä¸»è¦æŒ‡CAçš„è¯ä¹¦</span></div><div class="line"><span class="comment">// serverNameOverride ä»…ä»…ç”±äºæµ‹è¯•, é€šå¸¸ä¼ å…¥""</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClientTLSFromFile</span><span class="params">(certFile, serverNameOverride <span class="keyword">string</span>)</span> <span class="params">(TransportCredentials, error)</span></span> &#123;</div><div class="line">        b, err := ioutil.ReadFile(certFile)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">        &#125;</div><div class="line">        cp := x509.NewCertPool()</div><div class="line">        <span class="keyword">if</span> !cp.AppendCertsFromPEM(b) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"credentials: failed to append certificates"</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> NewTLS(&amp;tls.Config&#123;ServerName: serverNameOverride, RootCAs: cp&#125;), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewServerTLSFromFile ä¼ å…¥æœåŠ¡ç«¯å»ºç«‹TLSè¿æ¥æ—¶éœ€è¦çš„è¯ä¹¦, è¿™é‡Œä¸»è¦æŒ‡æœåŠ¡ç«¯çš„è¯ä¹¦å’Œç§é’¥</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServerTLSFromFile</span><span class="params">(certFile, keyFile <span class="keyword">string</span>)</span> <span class="params">(TransportCredentials, error)</span></span> &#123;</div><div class="line">        cert, err := tls.LoadX509KeyPair(certFile, keyFile)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> NewTLS(&amp;tls.Config&#123;Certificates: []tls.Certificate&#123;cert&#125;&#125;), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å› æ­¤æˆ‘ä»¬è‡ªå»ºä¸€ä¸ªCA, ç„¶åç”Ÿæˆserverç«¯çš„è¯ä¹¦å°±å¯ä»¥ä½¿ç”¨è¿™ç»„å‡½æ•°æ¥å®ŒæˆTLSçš„å»ºç«‹äº†</p>
<h4 id="æœåŠ¡ç«¯TLSå¯åŠ¨"><a href="#æœåŠ¡ç«¯TLSå¯åŠ¨" class="headerlink" title="æœåŠ¡ç«¯TLSå¯åŠ¨"></a>æœåŠ¡ç«¯TLSå¯åŠ¨</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"net"</span></div><div class="line"></div><div class="line">	pb <span class="string">"golang/grpc-auth/proto"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/net/context"</span></div><div class="line">	<span class="string">"google.golang.org/grpc"</span></div><div class="line">	<span class="string">"google.golang.org/grpc/credentials"</span> <span class="comment">// å¼•å…¥grpcè®¤è¯åŒ…</span></div><div class="line">	<span class="string">"google.golang.org/grpc/grpclog"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	<span class="comment">// Address gRPCæœåŠ¡åœ°å€</span></div><div class="line">	Address = <span class="string">"127.0.0.1:50052"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// å®šä¹‰helloServiceå¹¶å®ç°çº¦å®šçš„æ¥å£</span></div><div class="line"><span class="keyword">type</span> helloService <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// HelloService ...</span></div><div class="line"><span class="keyword">var</span> HelloService = helloService&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h helloService)</span> <span class="title">SayHello</span><span class="params">(ctx context.Context, in *pb.HelloRequest)</span> <span class="params">(*pb.HelloResponse, error)</span></span> &#123;</div><div class="line">	resp := <span class="built_in">new</span>(pb.HelloResponse)</div><div class="line">	resp.Message = <span class="string">"Hello "</span> + in.Name + <span class="string">"."</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> resp, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	listen, err := net.Listen(<span class="string">"tcp"</span>, Address)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalf(<span class="string">"failed to listen: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// TLSè®¤è¯</span></div><div class="line">	creds, err := credentials.NewServerTLSFromFile(<span class="string">"../keys/server1.pem"</span>, <span class="string">"../keys/server1.key"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalf(<span class="string">"Failed to generate credentials %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// å®ä¾‹åŒ–grpc Server, å¹¶å¼€å¯TLSè®¤è¯</span></div><div class="line">	s := grpc.NewServer(grpc.Creds(creds))</div><div class="line"></div><div class="line">	<span class="comment">// æ³¨å†ŒHelloService</span></div><div class="line">	pb.RegisterHelloServer(s, HelloService)</div><div class="line"></div><div class="line">	grpclog.Println(<span class="string">"Listen on "</span> + Address + <span class="string">" with TLS"</span>)</div><div class="line"></div><div class="line">	s.Serve(listen)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="å®¢æˆ·ç«¯å¸¦è¯ä¹¦è°ƒç”¨"><a href="#å®¢æˆ·ç«¯å¸¦è¯ä¹¦è°ƒç”¨" class="headerlink" title="å®¢æˆ·ç«¯å¸¦è¯ä¹¦è°ƒç”¨"></a>å®¢æˆ·ç«¯å¸¦è¯ä¹¦è°ƒç”¨</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	pb <span class="string">"golang/grpc-auth/proto"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/net/context"</span></div><div class="line">	<span class="string">"google.golang.org/grpc"</span></div><div class="line">	<span class="string">"google.golang.org/grpc/credentials"</span> <span class="comment">// å¼•å…¥grpcè®¤è¯åŒ…</span></div><div class="line">	<span class="string">"google.golang.org/grpc/grpclog"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	<span class="comment">// Address gRPCæœåŠ¡åœ°å€</span></div><div class="line">	Address = <span class="string">"127.0.0.1:50052"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// TLSè¿æ¥</span></div><div class="line">	creds, err := credentials.NewClientTLSFromFile(<span class="string">"../keys/cacert.pem"</span>, <span class="string">"server1"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalf(<span class="string">"Failed to create TLS credentials %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	conn, err := grpc.Dial(Address, grpc.WithTransportCredentials(creds))</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalln(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">defer</span> conn.Close()</div><div class="line"></div><div class="line">	<span class="comment">// åˆå§‹åŒ–å®¢æˆ·ç«¯</span></div><div class="line">	c := pb.NewHelloClient(conn)</div><div class="line"></div><div class="line">	<span class="comment">// è°ƒç”¨æ–¹æ³•</span></div><div class="line">	reqBody := <span class="built_in">new</span>(pb.HelloRequest)</div><div class="line">	reqBody.Name = <span class="string">"gRPC"</span></div><div class="line">	r, err := c.SayHello(context.Background(), reqBody)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalln(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	grpclog.Println(r.Message)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è®¤è¯æ‹¦æˆªå™¨"><a href="#è®¤è¯æ‹¦æˆªå™¨" class="headerlink" title="è®¤è¯æ‹¦æˆªå™¨"></a>è®¤è¯æ‹¦æˆªå™¨</h3><p>è®¤è¯åŒ…å«2éƒ¨åˆ†:</p>
<ul>
<li>æœåŠ¡ç«¯è®¤è¯token</li>
<li>å®¢æˆ·ç«¯æºå¸¦token</li>
</ul>
<h4 id="æœåŠ¡ç«¯è®¤è¯token"><a href="#æœåŠ¡ç«¯è®¤è¯token" class="headerlink" title="æœåŠ¡ç«¯è®¤è¯token"></a>æœåŠ¡ç«¯è®¤è¯token</h4><p>æ‹¦æˆªå™¨éƒ¨åˆ†çš„æºç åœ¨interceptor.goä¸­, æˆ‘ä»…å…³æ³¨æ™®é€šrpc, å¯¹äºæµå¼rpcçš„æ‹¦æˆªå™¨ä¸åšè¯´æ˜, ä»¥ä¸‹æ˜¯ç›¸å…³å‡½æ•°:</p>
<ul>
<li>å®¢æˆ·ç«¯æ‹¦æˆªå™¨</li>
<li>æœåŠ¡ç«¯æ‹¦æˆªå™¨<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UnaryClientInterceptoræ‹¦æˆªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œçš„éæµå¼RPC. inovkerå°±æ˜¯çœŸæ­£çš„RPCçš„handler,</span></div><div class="line"><span class="comment">// æ‹¦æˆªå™¨çš„è´£ä»»å°±æ˜¯å®Œæˆè‡ªå·±çš„é€»è¾‘åè°ƒç”¨è¯¥handler, è®©è¯·æ±‚ç»§ç»­RPCçš„å·¥ä½œ </span></div><div class="line"><span class="keyword">type</span> UnaryClientInterceptor <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, method <span class="keyword">string</span>, req, reply <span class="keyword">interface</span>&#123;&#125;, cc *ClientConn, invoker UnaryInvoker, opts ...CallOption)</span> <span class="title">error</span></span></div><div class="line"></div><div class="line">// <span class="title">UnaryServerInterceptor</span> æä¾›äº†ä¸€ä¸ªåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ<span class="title">unary</span> <span class="title">RPC</span>çš„é’©å­, </div><div class="line">// <span class="title">info</span> åŒ…å«æ‹¦æˆªå™¨å¯ä»¥æ“ä½œçš„<span class="title">RPC</span>çš„æ‰€æœ‰ä¿¡æ¯ã€‚</div><div class="line">// <span class="title">handler</span> æ˜¯æœåŠ¡æ–¹æ³•å®ç°çš„ä¸€ä¸ªåŒ…è£…å™¨, è€Œæ‹¦æˆªå™¨çš„è´£ä»»å°±æ˜¯è°ƒç”¨è¯¥<span class="title">handler</span>å®Œæˆ<span class="title">RPC</span>, è®©è¯·æ±‚ç»§ç»­<span class="title">RPC</span>çš„å·¥ä½œ</div><div class="line"><span class="title">type</span> <span class="title">UnaryServerInterceptor</span> <span class="title">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *UnaryServerInfo, handler UnaryHandler)</span> <span class="params">(resp <span class="keyword">interface</span>&#123;&#125;, err error)</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>å› æ­¤æˆ‘ä»¬æƒ³è¦åœ¨æœåŠ¡ç«¯å®ç°è¯·æ±‚çš„è®¤è¯åŠŸèƒ½, ä»…éœ€è¦å®ç°ä¸€ä¸ªè‡ªå·±çš„UnaryServerInterceptorå‡½æ•°, å¹¶ä¸”åœ¨serverå¯åŠ¨æ—¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒå³å¯</p>
<p>æ€»ä½“éœ€è¦3æ­¥:</p>
<ul>
<li>è‡ªå®šä¹‰authå‡½æ•°,å®ç°è®¤è¯é€»è¾‘</li>
<li>å®šä¹‰ä¸€ä¸ªä½¿ç”¨è‡ªå®šä¹‰è®¤è¯(auth)çš„æ‹¦æˆªå™¨</li>
<li>serverå¯åŠ¨æ—¶éšå‚æ•°ä¼ å…¥</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"net"</span></div><div class="line"></div><div class="line">	pb <span class="string">"golang/grpc-auth/proto"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/net/context"</span></div><div class="line">	<span class="string">"google.golang.org/grpc"</span></div><div class="line">	<span class="string">"google.golang.org/grpc/codes"</span>       <span class="comment">// grpc å“åº”çŠ¶æ€ç </span></div><div class="line">	<span class="string">"google.golang.org/grpc/credentials"</span> <span class="comment">// grpcè®¤è¯åŒ…</span></div><div class="line">	<span class="string">"google.golang.org/grpc/grpclog"</span></div><div class="line">	<span class="string">"google.golang.org/grpc/metadata"</span> <span class="comment">// grpc metadataåŒ…</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	<span class="comment">// Address gRPCæœåŠ¡åœ°å€</span></div><div class="line">	Address = <span class="string">"127.0.0.1:50052"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// å®šä¹‰helloServiceå¹¶å®ç°çº¦å®šçš„æ¥å£</span></div><div class="line"><span class="keyword">type</span> helloService <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// HelloService ...</span></div><div class="line"><span class="keyword">var</span> HelloService = helloService&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h helloService)</span> <span class="title">SayHello</span><span class="params">(ctx context.Context, in *pb.HelloRequest)</span> <span class="params">(*pb.HelloResponse, error)</span></span> &#123;</div><div class="line">	resp := <span class="built_in">new</span>(pb.HelloResponse)</div><div class="line">	resp.Message = <span class="string">"Hello "</span> + in.Name + <span class="string">"."</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> resp, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// auth éªŒè¯Token</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">auth</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span> &#123;</div><div class="line">	md, ok := metadata.FromContext(ctx)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> grpc.Errorf(codes.Unauthenticated, <span class="string">"æ— Tokenè®¤è¯ä¿¡æ¯"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		appid  <span class="keyword">string</span></div><div class="line">		appkey <span class="keyword">string</span></div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> val, ok := md[<span class="string">"appid"</span>]; ok &#123;</div><div class="line">		appid = val[<span class="number">0</span>]</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> val, ok := md[<span class="string">"appkey"</span>]; ok &#123;</div><div class="line">		appkey = val[<span class="number">0</span>]</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	grpclog.Printf(<span class="string">"appid: %s, appkey: %s\n"</span>, appid, appkey)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> appid != <span class="string">"101010"</span> || appkey != <span class="string">"i am key"</span> &#123;</div><div class="line">		<span class="keyword">return</span> grpc.Errorf(codes.Unauthenticated, <span class="string">"Tokenè®¤è¯ä¿¡æ¯æ— æ•ˆ: appid=%s, appkey=%s"</span>, appid, appkey)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	listen, err := net.Listen(<span class="string">"tcp"</span>, Address)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalf(<span class="string">"Failed to listen: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> opts []grpc.ServerOption</div><div class="line"></div><div class="line">	<span class="comment">// TLSè®¤è¯</span></div><div class="line">	creds, err := credentials.NewServerTLSFromFile(<span class="string">"../keys/server1.pem"</span>, <span class="string">"../keys/server1.key"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalf(<span class="string">"Failed to generate credentials %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	opts = <span class="built_in">append</span>(opts, grpc.Creds(creds))</div><div class="line"></div><div class="line">	<span class="comment">// æ³¨å†Œinterceptor</span></div><div class="line">	<span class="keyword">var</span> interceptor grpc.UnaryServerInterceptor</div><div class="line">	interceptor = <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler)</span> <span class="params">(resp <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</div><div class="line">		err = auth(ctx)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// ç»§ç»­å¤„ç†è¯·æ±‚</span></div><div class="line">		<span class="keyword">return</span> handler(ctx, req)</div><div class="line">	&#125;</div><div class="line">	opts = <span class="built_in">append</span>(opts, grpc.UnaryInterceptor(interceptor))</div><div class="line"></div><div class="line">	<span class="comment">// å®ä¾‹åŒ–grpc Server</span></div><div class="line">	s := grpc.NewServer(opts...)</div><div class="line"></div><div class="line">	<span class="comment">// æ³¨å†ŒHelloService</span></div><div class="line">	pb.RegisterHelloServer(s, HelloService)</div><div class="line"></div><div class="line">	grpclog.Println(<span class="string">"Listen on "</span> + Address + <span class="string">" with TLS + Token + Interceptor"</span>)</div><div class="line"></div><div class="line">	s.Serve(listen)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="å®¢æˆ·ç«¯æºå¸¦token"><a href="#å®¢æˆ·ç«¯æºå¸¦token" class="headerlink" title="å®¢æˆ·ç«¯æºå¸¦token"></a>å®¢æˆ·ç«¯æºå¸¦token</h4><p>è€Œè‡³äºå®¢æˆ·ç«¯å¦‚ä½•åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼ é€’è‡ªå·±çš„tokenä¿¡æ¯, æœ‰æ¯”å®¢æˆ·ç«¯æ‹¦æˆªå™¨æ›´æ–¹ä¾¿çš„æ–¹å¼, å› ä¸ºcredentialsä¸­æœ‰æä¾›è¿™æ ·çš„æ¥å£<br>è¿™éƒ¨åˆ†ä»£ç åœ¨credentials.goä¸­<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PerRPCCredentials ä¸ºè®¤è¯å®šä¹‰äº†ä¸€ä¸ªé€šç”¨æ¥å£, æ¯æ¬¡RPCè°ƒç”¨éƒ½éœ€è¦æä¾›å®‰å…¨ä¿¡æ¯(æ¯”å¦‚oauth2çš„token)</span></div><div class="line"><span class="keyword">type</span> PerRPCCredentials <span class="keyword">interface</span> &#123;</div><div class="line">        <span class="comment">// GetRequestMetadata è·å–å½“å‰è¯·æ±‚çš„å…ƒæ•°æ®, å¦‚æœéœ€è¦å¯ä»¥åˆ·æ–°tokens.</span></div><div class="line">        <span class="comment">// è¯¥æ–¹æ³•åœ¨è¯·æ±‚è¢«ä¼ è¾“ä¹‹å‰è°ƒç”¨, è€Œæ•°æ®éœ€è¦æ”¾åœ¨headeré‡Œé¢æˆ–è€…å…¶ä»–contextä¸­.</span></div><div class="line">        <span class="comment">// uriä»£è¡¨è¯·æ±‚æ¡ç›®çš„URI</span></div><div class="line">        <span class="comment">// åœ¨åº•å±‚å®ç°çš„æ”¯æŒä¸‹, ctxå¯ä»¥ç”¨äºè¶…æ—¶å’Œå–æ¶ˆ</span></div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> å®šä¹‰é™å®šé”®çš„é›†åˆï¼Œè€Œä¸æ˜¯å°†å…¶ä¿ç•™ä¸ºä»»æ„å­—ç¬¦ä¸²ã€‚</span></div><div class="line">        GetRequestMetadata(ctx context.Context, uri ...<span class="keyword">string</span>) (<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>, error)</div><div class="line">        <span class="comment">// RequireTransportSecurity è¡¨æ˜è®¤è¯è¿‡ç¨‹æ˜¯å¦éœ€è¦å®‰å…¨ä¼ è¾“(æ˜¯å¦å¼€å¯TLS)</span></div><div class="line">        RequireTransportSecurity() <span class="keyword">bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å› æ­¤å¯ä»¥çœ‹å‡ºæˆ‘ä»¬ä»…éœ€è¦å®ç°GetRequestMetadataå’ŒRequireTransportSecurityå³å¯, é€šè¿‡GetRequestMetadataæ–¹æ³•å°†éœ€è¦çš„tokenä¼ é€’ç»™å®¢æˆ·ç«¯å³å¯ã€‚</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	pb <span class="string">"golang/grpc-auth/proto"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/net/context"</span></div><div class="line">	<span class="string">"google.golang.org/grpc"</span></div><div class="line">	<span class="string">"google.golang.org/grpc/credentials"</span> <span class="comment">// å¼•å…¥grpcè®¤è¯åŒ…</span></div><div class="line">	<span class="string">"google.golang.org/grpc/grpclog"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	<span class="comment">// Address gRPCæœåŠ¡åœ°å€</span></div><div class="line">	Address = <span class="string">"127.0.0.1:50052"</span></div><div class="line"></div><div class="line">	<span class="comment">// OpenTLS æ˜¯å¦å¼€å¯TLSè®¤è¯</span></div><div class="line">	OpenTLS = <span class="literal">true</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// customCredential è‡ªå®šä¹‰è®¤è¯</span></div><div class="line"><span class="keyword">type</span> customCredential <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c customCredential)</span> <span class="title">GetRequestMetadata</span><span class="params">(ctx context.Context, uri ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</div><div class="line">		<span class="string">"appid"</span>:  <span class="string">"101010"</span>,</div><div class="line">		<span class="string">"appkey"</span>: <span class="string">"i am key"</span>,</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c customCredential)</span> <span class="title">RequireTransportSecurity</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> OpenTLS &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	<span class="keyword">var</span> opts []grpc.DialOption</div><div class="line"></div><div class="line">	<span class="keyword">if</span> OpenTLS &#123;</div><div class="line">		<span class="comment">// TLSè¿æ¥</span></div><div class="line">		creds, err := credentials.NewClientTLSFromFile(<span class="string">"../keys/cacert.pem"</span>, <span class="string">"server1"</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			grpclog.Fatalf(<span class="string">"Failed to create TLS credentials %v"</span>, err)</div><div class="line">		&#125;</div><div class="line">		opts = <span class="built_in">append</span>(opts, grpc.WithTransportCredentials(creds))</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		opts = <span class="built_in">append</span>(opts, grpc.WithInsecure())</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// æŒ‡å®šè‡ªå®šä¹‰è®¤è¯</span></div><div class="line">	opts = <span class="built_in">append</span>(opts, grpc.WithPerRPCCredentials(<span class="built_in">new</span>(customCredential)))</div><div class="line"></div><div class="line">	conn, err := grpc.Dial(Address, opts...)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalln(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">defer</span> conn.Close()</div><div class="line"></div><div class="line">	<span class="comment">// åˆå§‹åŒ–å®¢æˆ·ç«¯</span></div><div class="line">	c := pb.NewHelloClient(conn)</div><div class="line"></div><div class="line">	<span class="comment">// è°ƒç”¨æ–¹æ³•</span></div><div class="line">	reqBody := <span class="built_in">new</span>(pb.HelloRequest)</div><div class="line">	reqBody.Name = <span class="string">"gRPC"</span></div><div class="line">	r, err := c.SayHello(context.Background(), reqBody)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Fatalln(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	grpclog.Println(r.Message)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>é’ˆå¯¹ä»¥ä¸ŠåŠŸèƒ½åšæµ‹è¯•</p>
<h3 id="æ­£å¸¸æµ‹è¯•"><a href="#æ­£å¸¸æµ‹è¯•" class="headerlink" title="æ­£å¸¸æµ‹è¯•"></a>æ­£å¸¸æµ‹è¯•</h3><p>å¸¦è¯ä¹¦å’Œåˆæ³•tokençš„è¯·æ±‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go</div><div class="line">2017/08/08 10:36:10 Listen on 127.0.0.1:50052 with TLS + Token + Interceptor</div><div class="line">2017/08/08 10:36:13 appid: 101010, appkey: i am key</div></pre></td></tr></table></figure></p>
<p>è¯·æ±‚æˆåŠŸ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go</div><div class="line">2017/08/08 10:36:13 Hello gRPC.</div></pre></td></tr></table></figure></p>
<h3 id="å¼‚å¸¸æµ‹è¯•"><a href="#å¼‚å¸¸æµ‹è¯•" class="headerlink" title="å¼‚å¸¸æµ‹è¯•"></a>å¼‚å¸¸æµ‹è¯•</h3><p>ä¸å¸¦è¯ä¹¦çš„è¯·æ±‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go</div><div class="line">2017/08/08 11:05:36 Listen on 127.0.0.1:50052 with TLS + Token + Interceptor</div><div class="line">2017/08/08 11:05:38 grpc: Server.Serve failed to complete security handshake from <span class="string">"127.0.0.1:56310"</span>: tls: first record does not look like a TLS handshake</div></pre></td></tr></table></figure></p>
<p>è¯·æ±‚å¤±è´¥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go</div><div class="line">2017/08/08 11:05:38 transport: http2Client.notifyError got notified that the client transport was broken unexpected EOF.</div><div class="line">2017/08/08 11:05:38 rpc error: code = Internal desc = transport is closing</div><div class="line"><span class="built_in">exit</span> status 1</div></pre></td></tr></table></figure></p>
<p>å¸¦è¯ä¹¦ä½†tokenä¸åˆæ³•<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go</div><div class="line">2017/08/08 11:08:36 rpc error: code = Unauthenticated desc = Tokenè®¤è¯ä¿¡æ¯æ— æ•ˆ: appid=101010, appkey=i am key1</div><div class="line"><span class="built_in">exit</span> status 1</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;gRPCçš„æœåŠ¡ç«¯éœ€è¦ä¸è®¤è¯å¹³å°å¯¹æ¥, ä¹‹å‰ä½¿ç”¨httpæ—¶é€šè¿‡ä¸­é—´ä»¶çš„å½¢å¼è¿›è¡Œå®ç°, å› æ­¤è¿™ç¯‡æ–‡ç« ä¸»è¦éªŒè¯gRPCä¸­èƒ½å¦ä»¥ä¸­é—´ä»¶çš„å½¢å¼å®ç°gRPCçš„è®¤è¯ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="gRPC" scheme="https://blog.yumaojun.net/tags/gRPC/"/>
    
      <category term="APIGateway" scheme="https://blog.yumaojun.net/tags/APIGateway/"/>
    
  </entry>
  
  <entry>
    <title>Golang HTTPæœåŠ¡ä¼˜é›…é‡å¯</title>
    <link href="https://blog.yumaojun.net/2017/08/06/http-graceful/"/>
    <id>https://blog.yumaojun.net/2017/08/06/http-graceful/</id>
    <published>2017-08-06T06:36:42.000Z</published>
    <updated>2017-08-08T08:52:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>RESTful API Gatewayæ˜¯ä¸€ä¸ªé«˜ç¨³å®šæ€§çš„ç»„ä»¶, å› æ­¤éœ€è¦æœ‰åƒNginx Reloadé‚£æ ·å¹³æ»‘å‡çº§çš„èƒ½åŠ›, å³å…³é—­æ­£åœ¨è¿è¡Œçš„è€ç¨‹åºï¼Œå¹¶å¯åŠ¨æ–°ç¨‹åºã€‚<br><a id="more"></a></p>
<h2 id="æ ‡å‡†åº“çš„çš„å®ç°"><a href="#æ ‡å‡†åº“çš„çš„å®ç°" class="headerlink" title="æ ‡å‡†åº“çš„çš„å®ç°"></a>æ ‡å‡†åº“çš„çš„å®ç°</h2><p>Goåœ¨1.8å¯¹net/httpè¿›è¡Œäº†æ›´æ–°, æä¾›äº†httpæœåŠ¡ä¼˜é›…å…³é—­çš„èƒ½åŠ›ã€‚</p>
<h3 id="å®˜æ–¹è¯´æ˜"><a href="#å®˜æ–¹è¯´æ˜" class="headerlink" title="å®˜æ–¹è¯´æ˜"></a>å®˜æ–¹è¯´æ˜</h3><p>æˆ‘ä»¬çœ‹ä¸‹server.goä¸­å…³äºColseæ–¹æ³•çš„æè¿°:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Closeå°†ä¼šç«‹å³å…³é—­æ‰€æœ‰æ´»è·ƒçš„ç›‘å¬å™¨ä»¥åŠæ‰€æœ‰è¿æ¥,æ¯”å¦‚æ–°è¿æ¥,æ´»è·ƒè¿æ¥, ç©ºé—²è¿æ¥</span></div><div class="line"><span class="comment">// å¦‚æœæƒ³ä¼˜é›…å…³é—­æœåŠ¡, è¯·ä½¿ç”¨Shutdown</span></div><div class="line"><span class="comment">// æ³¨æ„closeå¹¶ä¸å°è¯•å…³é—­æˆ–è€…ç­‰å¾…hijackedè¿æ¥ï¼Œå¦‚WebSockets</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">        srv.mu.Lock()</div><div class="line">        <span class="keyword">defer</span> srv.mu.Unlock()</div><div class="line">        srv.closeDoneChanLocked()</div><div class="line">        err := srv.closeListenersLocked()</div><div class="line">        <span class="keyword">for</span> c := <span class="keyword">range</span> srv.activeConn &#123;</div><div class="line">                c.rwc.Close()</div><div class="line">                <span class="built_in">delete</span>(srv.activeConn, c)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯¹æ¯”closeæ–¹æ³•, æˆ‘ä»¬çœ‹ä¸‹Shutdownåˆ°åº•å¤šåšäº†ä»€ä¹ˆå·¥ä½œ:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Shutdownä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨,å®šæœŸå·¡æ£€é‚£äº›ç©ºé—²è¿æ¥, ç„¶åæŠŠè¿™äº›ç©ºé—²è¿æ¥å…³é—­</span></div><div class="line"><span class="comment">// è€Œè¿™ä¸ªå·¡æ£€æ—¶é—´å°±æ˜¯shutdownPollInterval, å¯ä»¥çœ‹å‡ºé»˜è®¤ä¸º500æ¯«ç§’</span></div><div class="line"><span class="comment">// </span></div><div class="line"><span class="comment">// æˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸æ¶‰åŠæŠ•ç¥¨çš„æœ€ç†æƒ³è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶å®ƒçš„æ¶ˆè€—ä¹Ÿå¾ˆå°‘(ä¸æ¶‰åŠä»»ä½•äº’æ–¥é”),</span></div><div class="line"><span class="comment">// ä½†æ˜¯æ˜¯ç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ ã€‚</span></div><div class="line"><span class="keyword">var</span> shutdownPollInterval = <span class="number">500</span> * time.Millisecond</div><div class="line"></div><div class="line"><span class="comment">// Shutdown å°†æ— ä¸­æ–­çš„å…³é—­æ­£åœ¨æ´»è·ƒçš„è¿æ¥ï¼Œç„¶åå¹³æ»‘çš„åœæ­¢æœåŠ¡ã€‚å¤„ç†æµç¨‹å¦‚ä¸‹:</span></div><div class="line"><span class="comment">// 1) é¦–å…ˆå…³é—­æ‰€æœ‰çš„ç›‘å¬</span></div><div class="line"><span class="comment">// 2) ç„¶åå…³é—­æ‰€æœ‰çš„ç©ºé—²è¿æ¥</span></div><div class="line"><span class="comment">// 3) ç„¶åæ— é™æœŸç­‰å¾…è¿æ¥å¤„ç†å®Œæ¯•è½¬ä¸ºç©ºé—²ï¼Œå¹¶å…³é—­</span></div><div class="line"><span class="comment">// 4) å¦‚æœæä¾›äº† å¸¦æœ‰è¶…æ—¶çš„Contextï¼Œå°†åœ¨æœåŠ¡å…³é—­å‰è¿”å› Contextçš„è¶…æ—¶é”™è¯¯</span></div><div class="line"><span class="comment">// </span></div><div class="line"><span class="comment">// Shutdown å¹¶ä¸å°è¯•å…³é—­æˆ–è€…ç­‰å¾… hijackedè¿æ¥ï¼Œ</span></div><div class="line"><span class="comment">// å¦‚ WebSocketsã€‚å¦‚æœéœ€è¦çš„è¯è°ƒç”¨è€…éœ€è¦åˆ†åˆ«å¤„ç†è¯¸å¦‚é•¿è¿æ¥ç±»å‹çš„ç­‰å¾…å’Œå…³é—­ã€‚</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span> <span class="title">Shutdown</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span> &#123;</div><div class="line">        atomic.AddInt32(&amp;srv.inShutdown, <span class="number">1</span>)</div><div class="line">        <span class="keyword">defer</span> atomic.AddInt32(&amp;srv.inShutdown, <span class="number">-1</span>)</div><div class="line"></div><div class="line">        srv.mu.Lock()</div><div class="line">        lnerr := srv.closeListenersLocked()</div><div class="line">        srv.closeDoneChanLocked()</div><div class="line">        srv.mu.Unlock()</div><div class="line"></div><div class="line">        ticker := time.NewTicker(shutdownPollInterval)</div><div class="line">        <span class="keyword">defer</span> ticker.Stop()</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">                <span class="keyword">if</span> srv.closeIdleConns() &#123;</div><div class="line">                        <span class="keyword">return</span> lnerr</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">select</span> &#123;</div><div class="line">                <span class="keyword">case</span> &lt;-ctx.Done():</div><div class="line">                        <span class="keyword">return</span> ctx.Err()</div><div class="line">                <span class="keyword">case</span> &lt;-ticker.C:</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ç®€å•æ ·ä¾‹"><a href="#ç®€å•æ ·ä¾‹" class="headerlink" title="ç®€å•æ ·ä¾‹"></a>ç®€å•æ ·ä¾‹</h3><p>æ ¹æ®ä¸Šé¢çš„åˆ†æ, æˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„æ —å­è¿›è¡Œæµ‹è¯•(Githubåœ°å€: <a href="https://github.com/yumaojun03/golang/blob/master/http-graceful/main.go" target="_blank" rel="external">HTTP Graceful</a>)<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"context"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"os/signal"</span></div><div class="line">	<span class="string">"syscall"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">		<span class="comment">// for test active connection</span></div><div class="line">		time.Sleep(time.Second * <span class="number">2</span>)</div><div class="line">		fmt.Fprintf(w, <span class="string">"Hello World, %v\n"</span>, time.Now())</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	s := &amp;http.Server&#123;</div><div class="line">		Addr:           <span class="string">":8080"</span>,</div><div class="line">		Handler:        http.DefaultServeMux,</div><div class="line">		ReadTimeout:    <span class="number">10</span> * time.Second,</div><div class="line">		WriteTimeout:   <span class="number">10</span> * time.Second,</div><div class="line">		MaxHeaderBytes: <span class="number">1</span> &lt;&lt; <span class="number">20</span>,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		log.Printf(<span class="string">"server start at: 127.0.0.1:8080"</span>)</div><div class="line">		log.Println(s.ListenAndServe())</div><div class="line">		log.Println(<span class="string">"server shutdown"</span>)</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// Handle SIGINT, SIGTERM, SIGKILL, SIGHUP, SIGQUIT</span></div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</div><div class="line">	signal.Notify(ch, syscall.SIGTERM, syscall.SIGINT, syscall.SIGKILL, syscall.SIGHUP, syscall.SIGQUIT)</div><div class="line">	log.Println(&lt;-ch)</div><div class="line"></div><div class="line">	<span class="comment">// Stop the service gracefully.</span></div><div class="line">	ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</div><div class="line">	<span class="keyword">defer</span> cancel()</div><div class="line">	log.Println(s.Shutdown(ctx))</div><div class="line"></div><div class="line">	<span class="comment">// Wait gorotine print shutdown message</span></div><div class="line">	time.Sleep(time.Second * <span class="number">10</span>)</div><div class="line">	log.Println(<span class="string">"done."</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>å¯åŠ¨æœåŠ¡ç«¯, å¹¶å…³æ³¨æ—¥å¿—:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go</div><div class="line">2017/08/06 16:06:47 server start at: 127.0.0.1:8080</div><div class="line">^C2017/08/06 16:07:10 interrupt</div><div class="line">2017/08/06 16:07:10 http: Server closed</div><div class="line">2017/08/06 16:07:10 server shutdown</div><div class="line">2017/08/06 16:07:11 &lt;nil&gt;</div><div class="line">2017/08/06 16:07:21 done.</div></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨curlå‘èµ·ä¸€æ¬¡è¯·æ±‚, åœ¨è¯·æ±‚ä¸ºç»“æŸå‰å…³é—­æœåŠ¡<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$curl</span> localhost:8080</div><div class="line">Hello World, 2017-08-06 16:07:11.341038687 +0800 CST</div><div class="line"><span class="variable">$curl</span> localhost:8080</div><div class="line">curl: (7) Failed to connect to localhost port 8080: Connection refused</div></pre></td></tr></table></figure></p>
<p>ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡º:</p>
<ol>
<li>æ­£åœ¨è¿›è¡Œè®¿é—®çš„è¯·æ±‚ä¸ä¼šè¢«å…³é—­, ç»§ç»­æ­£å¸¸å“åº”</li>
<li>æ–°å¢çš„è¯·æ±‚åˆ™æ‹’ç»è®¿é—®</li>
</ol>
<p>å› æ­¤HTTPçš„Shutdownçš„ç¡®å¯ä»¥èµ·åˆ°ä¼˜é›…å…³é—­æœåŠ¡çš„ä½œç”¨ã€‚</p>
<h2 id="ç¬¬ä¸‰æ–¹å®ç°"><a href="#ç¬¬ä¸‰æ–¹å®ç°" class="headerlink" title="ç¬¬ä¸‰æ–¹å®ç°"></a>ç¬¬ä¸‰æ–¹å®ç°</h2><p>å®˜æ–¹ä»…ä»…å®ç°äº†ä¼˜é›…çš„å…³é—­, å¹¶æ²¡æœ‰å®ç°ä¼˜é›…é‡å¯, æƒ³è¦å®ç°åƒNginxé‚£æ ·ä¼˜é›…é‡å¯, è¿˜æœ‰å¾ˆå¤šå·¥ä½œè¦åš, æœ‰ä¸ªä¸é”™çš„ç¬¬ä¸‰æ–¹åº“å·²ç»å®ç°äº†è¯¥èƒ½åŠ›, ä»£ç†è´¨é‡ä¹Ÿä¸é”™, å€¼å¾—ä½¿ç”¨<br>å…·ä½“å¯ä»¥å‚è€ƒ<a href="https://segmentfault.com/a/1190000004445975" target="_blank" rel="external">Golangå¼€å‘æ”¯æŒå¹³æ»‘å‡çº§ï¼ˆä¼˜é›…é‡å¯ï¼‰çš„HTTPæœåŠ¡</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;RESTful API Gatewayæ˜¯ä¸€ä¸ªé«˜ç¨³å®šæ€§çš„ç»„ä»¶, å› æ­¤éœ€è¦æœ‰åƒNginx Reloadé‚£æ ·å¹³æ»‘å‡çº§çš„èƒ½åŠ›, å³å…³é—­æ­£åœ¨è¿è¡Œçš„è€ç¨‹åºï¼Œå¹¶å¯åŠ¨æ–°ç¨‹åºã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="HTTP" scheme="https://blog.yumaojun.net/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>gRPCæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</title>
    <link href="https://blog.yumaojun.net/2017/08/02/api-gateway-service-discovery-and-lb/"/>
    <id>https://blog.yumaojun.net/2017/08/02/api-gateway-service-discovery-and-lb/</id>
    <published>2017-08-02T01:48:56.000Z</published>
    <updated>2017-08-08T03:15:37.000Z</updated>
    
    <content type="html"><![CDATA[<p>APIç½‘å…³éœ€è¦å®ç°æœåŠ¡çš„è‡ªåŠ¨å‘ç°å’Œè´Ÿè½½å‡è¡¡, ç”±äºåé¢çš„æœåŠ¡åŸºæœ¬éƒ½é‡‡ç”¨gRPCå®ç°, å› æ­¤éœ€è¦éªŒè¯gRPCå¦‚ä½•å®ç°è¿™2ä¸ªåŠŸèƒ½ã€‚<br><a id="more"></a></p>
<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>æ„å»ºé«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„é€šä¿¡æœåŠ¡ï¼Œé€šå¸¸é‡‡ç”¨æœåŠ¡æ³¨å†Œä¸å‘ç°ã€è´Ÿè½½å‡è¡¡å’Œå®¹é”™å¤„ç†ç­‰æœºåˆ¶å®ç°ã€‚gRPCåœ¨è®¾è®¡æ—¶å·²æœ‰è€ƒè™‘, å®˜æ–¹ä¹Ÿæä¾›äº†ä¸€äº›åŸºæœ¬å®ç°, ä½†æ˜¯å¦‚ä½•å›´ç»•å®˜æ–¹è®¾è®¡å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡å´å¹¶ä¸å®¹æ˜“, æˆ‘ä¼šå›´ç»•ä»¥ä¸‹å‡ ç‚¹è¿›è¡Œå±•å¼€:</p>
<ul>
<li>è§£è¯»å®˜æ–¹æ–‡æ¡£: <a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md" target="_blank" rel="external">Load Balancing in gRPC</a></li>
<li>è´Ÿè½½å‡è¡¡éƒ¨åˆ†æºç è§£è¯»</li>
<li>ä»£ç å®ç°,å‚è€ƒ<a href="https://github.com/wothing/wonaming" target="_blank" rel="external">wonaming</a></li>
</ul>
<h2 id="å®˜æ–¹è®¾è®¡"><a href="#å®˜æ–¹è®¾è®¡" class="headerlink" title="å®˜æ–¹è®¾è®¡"></a>å®˜æ–¹è®¾è®¡</h2><p>å®˜æ–¹è¿™ç¯‡æ–‡æ¡£ä¸»è¦æ˜¯é˜è¿°å¦‚ä½•åˆ©ç”¨gRPCè®¾è®¡è´Ÿè½½å‡è¡¡ã€‚</p>
<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>å€¼å¾—æ³¨æ„çš„æ˜¯gGRCçš„è´Ÿè½½å‡è¡¡æ˜¯ä»¥callä¸ºåŸºç¡€, è€Œä¸æ˜¯ä»¥è¿æ¥ä¸ºåŸºç¡€, ä¹Ÿå°±æ˜¯è¯´åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„ä¸åŒè¯·æ±‚ ä¼šè¢«åˆ†æ‘Šåˆ°åé¢è¯¥æœåŠ¡çš„é›†ç¾¤ä¸Šé¢ã€‚</p>
<h3 id="è´Ÿè½½å‡è¡¡çš„æ–¹æ³•"><a href="#è´Ÿè½½å‡è¡¡çš„æ–¹æ³•" class="headerlink" title="è´Ÿè½½å‡è¡¡çš„æ–¹æ³•"></a>è´Ÿè½½å‡è¡¡çš„æ–¹æ³•</h3><p>åœ¨è®¨è®ºä»»ä½•gRPCçš„ç»†èŠ‚ä¹‹å‰, å…ˆè®¤è¯†ä¸‹å¸¸ç”¨è´Ÿè½½å‡è¡¡çš„æ–¹æ³•:</p>
<ol>
<li><p>ä»£ç†æ¨¡å¼(Proxy Model)<br><img src="http://oiw1gzfww.bkt.clouddn.com/classic-lb.png" alt=""><br>ä»£ç†æ¨¡å¼çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ä½äºæœåŠ¡å¤–éƒ¨, å€ŸåŠ©å…¶ä»–å·¥å…·å®ç°ã€‚å®ƒä¸€èˆ¬ä½äºæ¶ˆè´¹è€…å’ŒæœåŠ¡æä¾›è€…ä¹‹é—´, æ¯”å¦‚ä¸“é—¨çš„ç¡¬ä»¶è®¾å¤‡F5, æˆ–è€…è½¯ä»¶HAProxy,Nginxç­‰, LBä¸Šæœ‰æ‰€æœ‰æœåŠ¡çš„åœ°å€æ˜ å°„è¡¨ï¼Œé€šå¸¸ç”±è¿ç»´é…ç½®æ³¨å†Œï¼Œå½“æœåŠ¡æ¶ˆè´¹æ–¹è°ƒç”¨æŸä¸ªç›®æ ‡æœåŠ¡æ—¶ï¼Œå®ƒå‘LBå‘èµ·è¯·æ±‚ï¼Œç”±LBä»¥æŸç§ç­–ç•¥ï¼Œæ¯”å¦‚è½®è¯¢(Round-Robin)åšè´Ÿè½½å‡è¡¡åå°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡æœåŠ¡ã€‚LBä¸€èˆ¬å…·å¤‡å¥åº·æ£€æŸ¥èƒ½åŠ›ï¼Œèƒ½è‡ªåŠ¨æ‘˜é™¤ä¸å¥åº·çš„æœåŠ¡å®ä¾‹ã€‚<br>è¯¥æ–¹æ¡ˆçš„é—®é¢˜:</p>
<ul>
<li>é…ç½®ä¸æ–¹ä¾¿: åŸºæœ¬éƒ½ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–è€…UIçš„æ–¹å¼æ“ä½œ, å¹¶æ²¡æœ‰å‹å¥½çš„APIè°ƒç”¨, ä¸æ–¹ä¾¿é›†æˆ</li>
<li>æ‰©å±•æ€§: é¢„ç•™çš„æ‰©å±•ç©ºé—´ä¸è¶³, ä¸èƒ½å¾ˆå¥½çš„æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ‰©å±•åŠŸèƒ½, ä½†Nginxé™¤å¤–</li>
<li>æ€§èƒ½æŸè€—: ç”±äºéœ€è¦å¤åˆ¶è¯·æ±‚å’Œå“åº”, ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½æŸè€—, å¯¹äºå­˜å‚¨è¿™ç§é‡æœåŠ¡å°±ä¸é€‚ç”¨äº†</li>
</ul>
</li>
<li><p>åŸºäºå®¢æˆ·ç«¯æ¨¡å¼(Balancing-aware Client)<br><img src="http://oiw1gzfww.bkt.clouddn.com/internal-lb01.png" alt=""><br>é’ˆå¯¹ç¬¬ä¸€ä¸ªæ–¹æ¡ˆçš„ä¸è¶³ï¼Œæ­¤æ–¹æ¡ˆå°†LBçš„åŠŸèƒ½é›†æˆåˆ°æœåŠ¡æ¶ˆè´¹æ–¹è¿›ç¨‹é‡Œï¼Œä¹Ÿè¢«ç§°ä¸ºè½¯è´Ÿè½½æˆ–è€…å®¢æˆ·ç«¯è´Ÿè½½æ–¹æ¡ˆ, å› æ­¤å®¢æˆ·ç«¯ä¼šç•¥ç°é‡ä¸€äº›, æ¯”å¦‚å®¢æˆ·ç«¯ä¼šåŒ…å«å¾ˆå¤šè°ƒåº¦ç­–ç•¥(Round Robin, Random, etc)ç”¨äºä»serveråˆ—è¡¨ä¸­æŒ‘é€‰åˆé€‚çš„serverè¿›è¡Œè°ƒåº¦ã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹, æœåŠ¡å™¨åˆ—è¡¨å°†åœ¨å®¢æˆ·ç«¯ä¸­é™æ€é…ç½®, ç”±åç§°è§£æç³»ç»Ÿå’Œå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨æä¾›, åœ¨ä»»ä½•æƒ…å†µä¸‹, å®¢æˆ·ç«¯è´Ÿè´£ä»åˆ—è¡¨ä¸­é€‰å–æœ€åˆé€‚çš„serverè¿›è¡Œè°ƒåº¦ã€‚<br>å…·ä½“çš„å®ç°è¿‡ç¨‹å¦‚ä¸‹:</p>
<ul>
<li>æœåŠ¡æä¾›æ–¹å¯åŠ¨æ—¶ï¼Œé¦–å…ˆå°†æœåŠ¡åœ°å€æ³¨å†Œåˆ°æœåŠ¡æ³¨å†Œè¡¨ï¼ŒåŒæ—¶å®šæœŸæŠ¥å¿ƒè·³åˆ°æœåŠ¡æ³¨å†Œè¡¨ä»¥è¡¨æ˜æœåŠ¡çš„å­˜æ´»çŠ¶æ€ï¼Œç›¸å½“äºå¥åº·æ£€æŸ¥</li>
<li>æœåŠ¡æ¶ˆè´¹æ–¹è¦è®¿é—®æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒé€šè¿‡å†…ç½®çš„LBç»„ä»¶å‘æœåŠ¡æ³¨å†Œè¡¨æŸ¥è¯¢ï¼ŒåŒæ—¶ç¼“å­˜å¹¶å®šæœŸåˆ·æ–°ç›®æ ‡æœåŠ¡åœ°å€åˆ—è¡¨ï¼Œç„¶åä»¥æŸç§è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©ä¸€ä¸ªç›®æ ‡æœåŠ¡åœ°å€ï¼Œæœ€åå‘ç›®æ ‡æœåŠ¡å‘èµ·è¯·æ±‚ã€‚LBå’ŒæœåŠ¡å‘ç°èƒ½åŠ›è¢«åˆ†æ•£åˆ°æ¯ä¸€ä¸ªæœåŠ¡æ¶ˆè´¹è€…çš„è¿›ç¨‹å†…éƒ¨ï¼ŒåŒæ—¶æœåŠ¡æ¶ˆè´¹æ–¹å’ŒæœåŠ¡æä¾›æ–¹ä¹‹é—´æ˜¯ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰é¢å¤–å¼€é”€ï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ã€‚</li>
</ul>
</li>
</ol>
<p>è¯¥æ–¹æ¡ˆä¸»è¦é—®é¢˜ï¼š</p>
<ul>
<li>å¼€å‘æˆæœ¬ï¼Œç¼–å†™å’Œç»´æŠ¤å¤šç§è¯­è¨€æˆ–å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡ç­–ç•¥, ä¼šæœ‰å†—ä½™, è€Œä¸”ä¹Ÿå¢åŠ äº†å¼€å‘æˆæœ¬å’Œç»´æŠ¤æˆæœ¬ã€‚</li>
<li>å¢åŠ å®¢æˆ·ç«¯å¤æ‚æ€§ï¼Œè¿™äº›è´Ÿè½½å‡è¡¡ç­–ç•¥ æœ‰å¯èƒ½è¿˜éœ€è¦å’ŒæœåŠ¡ç«¯è¿›è¡Œä¸€äº›é¢å¤–çš„é€šä¿¡, æ¯”å¦‚ç›‘æ§çŠ¶æ€æ£€æŸ¥, è´Ÿè½½ä¿¡æ¯, å®ƒå°†ä½¿å¾—å®¢æˆ·ç«¯ä»£ç å¤æ‚åŒ–ã€‚ </li>
</ul>
<ol>
<li>å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨<br><img src="http://oiw1gzfww.bkt.clouddn.com/external-lb.png" alt=""><br>é’ˆå¯¹å®¢æˆ·ç«¯è¿‡é‡çš„é—®é¢˜, æœ‰äº†ç¬¬ä¸‰ç§æ–¹å¼: å¤æ‚çš„è°ƒåº¦ç®—æ³•ç‹¬ç«‹æˆLB, ç”±å¤–éƒ¨æä¾›ã€‚è€Œå®¢æˆ·ç«¯ä¿æŒç®€å•å’Œå¯ç§»æ¤,ä»…å®ç°ä¸€äº›åŸºæœ¬çš„serveræŒ‘é€‰ç®—æ³•æ¯”å¦‚ Round Robin, è€Œå®¢æˆ·ç«¯ä¾èµ–LBæä¾›è´Ÿè½½å‡è¡¡çš„é…ç½®å’Œå®¢æˆ·ç«¯éœ€è¦å‘é€è¯·æ±‚çš„serveråˆ—è¡¨, LBéœ€è¦æ ¹æ®éœ€è¦æ›´æ–°serveråˆ—è¡¨,ä»¥å¹³è¡¡è´Ÿè½½, å¤„ç†serverä¸å¯ç”¨æˆ–è€…å¥åº·é—®é¢˜.</li>
</ol>
<h3 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h3><p>gRPCä¸»è¦é‡‡ç”¨å¤–éƒ¨è´Ÿè½½å‡è¡¡çš„æ–¹å¼, å› gRPCå®ç°äº†ç®€å•æœåŠ¡æŒ‘é€‰ç®—æ³•: Round Robin, åŒæ—¶ä¹Ÿæä¾›äº†ä¸€ç§å¤–éƒ¨LBç®—æ³•çš„å‚è€ƒå®ç°: grpclb, å®˜æ–¹å¹¶ä¸å»ºè®® å†å¾€é‡Œé¢æ·»åŠ æ›´å¤šçš„ç®—å‘, è€Œæ›´å¤šçš„ç®—æ³•éœ€è¦é€šè¿‡å¤–éƒ¨LBæä¾›å®ç°ã€‚</p>
<p>å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹:<br><img src="https://github.com/grpc/grpc/raw/master/doc/images/load-balancing.png" alt=""></p>
<ol>
<li>æœåŠ¡å¯åŠ¨ågRPCå®¢æˆ·ç«¯å‘å‘½åæœåŠ¡å™¨å‘å‡ºåç§°è§£æè¯·æ±‚ï¼Œåç§°å°†è§£æä¸ºä¸€ä¸ªæˆ–å¤šä¸ªIPåœ°å€ï¼Œæ¯ä¸ªIPåœ°å€æ ‡ç¤ºå®ƒæ˜¯æœåŠ¡å™¨åœ°å€è¿˜æ˜¯è´Ÿè½½å‡è¡¡å™¨åœ°å€ï¼Œä»¥åŠæ ‡ç¤ºè¦ä½¿ç”¨é‚£ä¸ªå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç­–ç•¥æˆ–æœåŠ¡é…ç½®ã€‚è€Œå®¢æˆ·ç«¯æä¾›çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰round_robinå’Œgrpclb</li>
<li>å®¢æˆ·ç«¯å®ä¾‹åŒ–è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå¦‚æœè§£æè¿”å›çš„åœ°å€æ˜¯è´Ÿè½½å‡è¡¡å™¨åœ°å€ï¼Œåˆ™å®¢æˆ·ç«¯å°†ä½¿ç”¨grpclbç­–ç•¥ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡é…ç½®è¯·æ±‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥,å¦‚æœæ²¡æœ‰ä»æœåŠ¡é…ç½®æ–‡ä»¶ä¸­è§£æåˆ°è´Ÿè½½å‡è¡¡ç­–ç•¥, åˆ™å®¢æˆ·ç«¯ä¼šé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡åœ°å€ã€‚</li>
<li>è´Ÿè½½å‡è¡¡ç­–ç•¥ä¸ºæ¯ä¸ªæœåŠ¡å™¨åœ°å€åˆ›å»ºä¸€ä¸ªå­é€šé“ï¼ˆchannelï¼‰ã€‚</li>
<li>å½“æœ‰rpcè¯·æ±‚æ—¶ï¼Œè´Ÿè½½å‡è¡¡ç­–ç•¥å†³å®šé‚£ä¸ªå­é€šé“å³grpcæœåŠ¡å™¨å°†æ¥æ”¶è¯·æ±‚ï¼Œå½“å¯ç”¨æœåŠ¡å™¨ä¸ºç©ºæ—¶å®¢æˆ·ç«¯çš„è¯·æ±‚å°†è¢«é˜»å¡ã€‚</li>
</ol>
<h2 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h2><p>ä¸»è¦çœ‹å®˜æ–¹å¦‚ä½•å®ç°round robinè¿™ä¸ªè´Ÿè½½å‡è¡¡å™¨å’Œè´Ÿè½½å‡è¡¡å·¥ä½œæµç¨‹ã€‚</p>
<h3 id="å»ºç«‹è¿æ¥"><a href="#å»ºç«‹è¿æ¥" class="headerlink" title="å»ºç«‹è¿æ¥"></a>å»ºç«‹è¿æ¥</h3><p>åœ¨clientconn.goçš„DialContextå‡½æ•°ä¸­æè¿°äº†å®¢æˆ·ç«¯è¿æ¥è¿æ¥çš„è¿‡ç¨‹<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ctx: ä¸Šä¸‹æ–‡ç”¨äºå¤„ç†è¯·æ±‚å–æ¶ˆå’Œè¯·æ±‚è¶…æ—¶ç­‰æƒ…å†µ</span></div><div class="line"><span class="comment">// target: é€šè¿‡è¿™ä¸ªå»ºç«‹è¿æ¥, å¦‚æœé‡‡ç”¨è´Ÿè½½å‡è¡¡æ¨¡å¼, ä»–ä»£è¡¨watcheråœ°å€, ç”¨äºwatchæœåŠ¡ç«¯åœ°å€å˜åŒ–</span></div><div class="line"><span class="comment">// opts: å…¶ä»–å»ºç«‹è¿æ¥æ—¶çš„å‚æ•°</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DialContext</span><span class="params">(ctx context.Context, target <span class="keyword">string</span>, opts ...DialOption)</span> <span class="params">(conn *ClientConn, err error)</span></span> &#123;</div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> addrs []Address</div><div class="line">  <span class="keyword">if</span> cc.dopts.balancer == <span class="literal">nil</span> &#123;</div><div class="line">    <span class="comment">//å¦‚æœæ²¡æœ‰è®¾ç½®è´Ÿè½½å‡è¡¡å™¨ï¼Œåˆ™ç›´æ¥è¿æ¥</span></div><div class="line">    addrs = <span class="built_in">append</span>(addrs, Address&#123;Addr: target&#125;)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">var</span> credsClone credentials.TransportCredentials</div><div class="line">    <span class="keyword">if</span> creds != <span class="literal">nil</span> &#123;</div><div class="line">      credsClone = creds.Clone()</div><div class="line">    &#125;</div><div class="line">    config := BalancerConfig&#123;</div><div class="line">      DialCreds: credsClone,</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//å¯åŠ¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨,startå‡½æ•°ä¼šå¯åŠ¨ä¸€ä¸ªwatchç›‘å¬åœ°å€çš„å˜åŒ–.</span></div><div class="line">    <span class="keyword">if</span> err := cc.dopts.balancer.Start(target, config); err != <span class="literal">nil</span> &#123;</div><div class="line">      waitC &lt;- err</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Notifyè¿”å›ä¸€ä¸ªé€šé“ï¼Œåœ¨æ¯æ¬¡æœåŠ¡å™¨åœ°å€å˜åŒ–åçš„æœ€æ–°åœ°å€ä¿¡æ¯.</span></div><div class="line">    ch := cc.dopts.balancer.Notify()</div><div class="line">    <span class="keyword">if</span> ch == <span class="literal">nil</span> &#123;</div><div class="line">      <span class="comment">// There is no name resolver installed.</span></div><div class="line">      addrs = <span class="built_in">append</span>(addrs, Address&#123;Addr: target&#125;)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      addrs, ok = &lt;-ch</div><div class="line">      <span class="keyword">if</span> !ok || <span class="built_in">len</span>(addrs) == <span class="number">0</span> &#123;</div><div class="line">        waitC &lt;- errNoAddr</div><div class="line">        <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//å¯¹æ¯ä¸€ä¸ªåœ°å€è¿›è¡Œè¿æ¥, å› ä¸ºè¿™æ˜¯å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œæ‰€ä»¥éœ€è¦å¯¹æ‰€æœ‰åœ°å€æ“ä½œ.</span></div><div class="line">  <span class="keyword">for</span> _, a := <span class="keyword">range</span> addrs &#123;</div><div class="line">    <span class="keyword">if</span> err := cc.resetAddrConn(a, <span class="literal">false</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">      waitC &lt;- err</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">close</span>(waitC)</div><div class="line">&#125;()</div><div class="line">.............. <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line"><span class="keyword">if</span> ok &#123;</div><div class="line">  <span class="comment">//è¿™é‡Œå¼€å¯ä¸€ä¸ªç›‘å¬goroutineï¼Œä¸»è¦æ˜¯ç›‘å¬æœåŠ¡å™¨åœ°å€å˜åŒ–å¹¶å¯¹æ–°çš„åœ°å€å»ºç«‹è¿æ¥ï¼Œå¯¹è€çš„åœ°å€å…³é—­è¿æ¥</span></div><div class="line">  <span class="keyword">go</span> cc.lbWatcher()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»é‡Œé¢å¯ä»¥çœ‹å‡ºå…³äºè´Ÿè½½å‡è¡¡éƒ¨åˆ†, ä½¿ç”¨balancerçš„Startæ¥å¯åŠ¨åœ°å€ç›‘å¬, Notifyæ¥è·å–åœ°å€å˜åŒ–, å› æ­¤æ ¸å¿ƒæ˜¯ç†è§£Balanceræ¥å£ã€‚</p>
<h3 id="è´Ÿè½½å‡è¡¡æ¥å£"><a href="#è´Ÿè½½å‡è¡¡æ¥å£" class="headerlink" title="è´Ÿè½½å‡è¡¡æ¥å£"></a>è´Ÿè½½å‡è¡¡æ¥å£</h3><p>åœ¨balancer.goä¸­æœ‰å…³äºæ­¤çš„å®šä¹‰:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Balancer ä¸ºRPCsé€‰æ‹©ç½‘ç»œåœ°å€(backend service) </span></div><div class="line"><span class="keyword">type</span> Balancer <span class="keyword">interface</span> &#123;</div><div class="line">  <span class="comment">//å¯åŠ¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡ï¼Œå†…éƒ¨ä¼šå¯åŠ¨ä¸€ä¸ªåç§°æœåŠ¡å™¨çš„watcherï¼Œä¸æ–­ç›‘å¬åœ°å€çš„å˜åŒ–</span></div><div class="line">	Start(target <span class="keyword">string</span>, config BalancerConfig) error</div><div class="line">  <span class="comment">// é€šçŸ¥Balancer gRPCé€šè¿‡è¯¥åœ°å€å»ºç«‹äº†ä¸€ä¸ªå’Œserverçš„è¿æ¥, è¿”å›ä¸€ä¸ªdownçš„å‡½æ•°, å½“è¿æ¥æ–­å¼€æˆ–è€…ä¸¢å¤±ä¼šè¢«è°ƒç”¨ã€‚</span></div><div class="line">	Up(addr Address) (down <span class="function"><span class="keyword">func</span><span class="params">(error)</span>)</span></div><div class="line">  // è·å¾—ä¸‹ä¸€æ¬¡è¿æ¥æœåŠ¡å™¨çš„åœ°å€</div><div class="line">  // 1) å¦‚æœè¿”å›ä¸€ä¸ªå·²ç»å»ºç«‹è¿æ¥çš„åœ°å€, <span class="title">RPC</span>å°†åŸºäºè¯¥è¿æ¥ç›´æ¥è¿›è¡Œè°ƒç”¨</div><div class="line">  // 2) å¦‚æœè¿”å›ä¸€ä¸ªæ­£åœ¨è¿æ¥å»ºç«‹ä¸­çš„åœ°å€<span class="params">(Notifyåˆå§‹åŒ–æ—¶å‘ç”Ÿè¿‡æ¥çš„)</span>,ä½†æ˜¯è¿˜æœªå®Œæˆè¿æ¥å»ºç«‹ï¼Œ<span class="title">RPC</span>è°ƒç”¨å¯èƒ½ä¼šå¤±è´¥æˆ–è€…æˆåŠŸ</div><div class="line">  // 3) å¦‚æœè¿”å›ä¸€ä¸ªä¸å­˜åœ¨çš„è¿æ¥, ä¼šå½“åšä¸€ä¸ªé”™è¯¯å’Œå¤±è´¥çš„ç›¸åº”çš„<span class="title">RPC</span></div><div class="line">  // å› æ­¤å¦‚æœæƒ³è¦å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„<span class="title">Balancer</span>, å»ºè®®éµå¾ªå¦‚ä¸‹è§„åˆ™</div><div class="line">  // 1) å¦‚æœ<span class="title">opts</span>.<span class="title">BlockingWait</span>ä¸º<span class="title">true</span>, éœ€è¦è¿”å›ä¸€ä¸ªå·²ç»å»ºç«‹è¿æ¥çš„åœ°å€æˆ–è€…é˜»å¡åˆ°ç›´åˆ°æœ‰å»ºç«‹è¿æ¥çš„åœ°å€æ—¶è¿”å›, å½“é˜»å¡æ—¶</div><div class="line">  //    éœ€è¦æ£€æµ‹è¶…æ—¶æˆ–è€…å–æ¶ˆè¯¥<span class="title">RPC</span></div><div class="line">  // 2) å¦‚æœ<span class="title">opts</span>.<span class="title">BlockingWait</span>ä¸º<span class="title">false</span>, å®ƒåº”è¯¥ç«‹å³é€šè¿‡é€šçŸ¥æœºåˆ¶<span class="params">(Nofify)</span>è¿”å›ä¸€ä¸ªåœ°å€ï¼Œè€Œä¸æ˜¯é˜»å¡ã€‚</div><div class="line">  //</div><div class="line">  // <span class="title">put</span>ç”¨äºæ”¶é›†å’ŒæŠ¥å‘Š<span class="title">RPC</span>çš„çŠ¶æ€ç»™è¿œç¨‹çš„<span class="title">LB</span></div><div class="line">	<span class="title">Get</span><span class="params">(ctx context.Context, opts BalancerGetOptions)</span> <span class="params">(addr Address, put <span class="keyword">func</span>()</span>, <span class="title">err</span> <span class="title">error</span>)</div><div class="line">  // è¿”å›ä¸€ä¸ª<span class="title">channel</span>ç”¨äºå®æ—¶è·å–éœ€è¦å»ºç«‹è¿æ¥çš„åœ°å€åˆ—è¡¨, è¿™äº›åœ°å€å¯èƒ½æ¥æºäºä¸€ä¸ª<span class="title">name</span> <span class="title">resover</span>æˆ–è€…ä¸€ä¸ª<span class="title">remote</span> <span class="title">LB</span>, </div><div class="line">  // <span class="title">gRPC</span>å°†ä¸ä¹‹å‰ä¿å­˜çš„è¿æ¥åœ°å€è¿›è¡Œæ¯”è¾ƒ, å¦‚æœè¯¥åœ°å€åˆ—è¡¨æœ‰æ–°å¢çš„, <span class="title">gRPC</span>å¯¹æ–°å¢çš„åœ°å€è¿›è¡Œè¿æ¥, å¦‚æœè¯¥åœ°å€æœ‰å‡å°‘, <span class="title">gRPC</span>ä¼šä¼˜é›…å…³é—­è¿™</div><div class="line">  // å‡å°‘çš„è¿æ¥, å¦‚æœæ²¡å˜åŒ–, <span class="title">gRPC</span>æ— åŠ¨ä½œ, æ³¨æ„<span class="title">channel</span>é‡Œé¢è¿”å›çš„ä¸€ä¸ª å®Œæ•´çš„åœ°å€åˆ—è¡¨, è€Œä¸æ˜¯å¢é‡ã€‚</div><div class="line">	<span class="title">Notify</span><span class="params">()</span> &lt;-<span class="title">chan</span> []<span class="title">Address</span></div><div class="line">	//å…³é—­è´Ÿè½½å‡è¡¡å™¨</div><div class="line">	<span class="title">Close</span><span class="params">()</span> <span class="title">error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="å®˜æ–¹å®ç°"><a href="#å®˜æ–¹å®ç°" class="headerlink" title="å®˜æ–¹å®ç°"></a>å®˜æ–¹å®ç°</h3><p>å®˜æ–¹çš„Round Robinå°±æ˜¯Balanceræ¥å£çš„ä¸€ä¸ªå®ç°, ä½†æ˜¯åœ¨çœ‹ä»–å¦‚ä½•å®ç°Startå’ŒNotifyä¹‹å‰, å…ˆçœ‹çœ‹åç§°è§£ææœåŠ¡çš„æ¥å£å®šä¹‰.</p>
<h4 id="åç§°è§£ææœåŠ¡"><a href="#åç§°è§£ææœåŠ¡" class="headerlink" title="åç§°è§£ææœåŠ¡"></a>åç§°è§£ææœåŠ¡</h4><p>åç§°è§£ææœåŠ¡: naming.go, è¯¥åŒ…å®šä¹‰äº†gRPCåç§°è§£ææœåŠ¡çš„APIå’Œç›¸å…³æ•°æ®ç»“æ„<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Operation å®šä¹‰äº†åç§°è§£ææ—¶ç›¸åº”çš„åŠ¨ä½œ.</span></div><div class="line"><span class="keyword">type</span> Operation <span class="keyword">uint8</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	<span class="comment">// Add è¡¨ç¤ºæ–°å¢åœ°å€çš„æ“ä½œ</span></div><div class="line">	Add Operation = <span class="literal">iota</span></div><div class="line">	<span class="comment">// Delete è¡¨ç¤ºéœ€è¦åˆ é™¤ä¸€ä¸ªå·²å­˜åœ¨åœ°å€çš„æ“ä½œ </span></div><div class="line">	Delete</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Update defines a name resolution update. Notice that it is not valid having both</span></div><div class="line"><span class="comment">// empty string Addr and nil Metadata in an Update.</span></div><div class="line"><span class="keyword">type</span> Update <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// å…·ä½“çš„æ›´æ–°åŠ¨ä½œ, æ¯”å¦‚ä¸Šé¢å®šä¹‰çš„Addæˆ–è€…Delete</span></div><div class="line">	Op Operation</div><div class="line">  <span class="comment">// éœ€è¦æ›´æ–°çš„åœ°å€, å¦‚æœä¸ºç©ºå­—ç¬¦ä¸², è¡¨ç¤ºè¿™å„¿æ²¡æœ‰åœ°å€éœ€è¦æ›´æ–°</span></div><div class="line">	Addr <span class="keyword">string</span></div><div class="line">  <span class="comment">// ç”¨äºæè¿°updatedæ“ä½œæ—¶çš„ä¸€äº›metaæ•°æ®, å¦‚æœæ˜¯è‡ªå·±å®ç°åç§°è§£ææœåŠ¡Metadataæ˜¯ä¸éœ€è¦ä¼ å…¥çš„ã€‚</span></div><div class="line">	Metadata <span class="keyword">interface</span>&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Resolver creates a Watcher for a target to track its resolution changes.</span></div><div class="line"><span class="keyword">type</span> Resolver <span class="keyword">interface</span> &#123;</div><div class="line">  <span class="comment">// é€šè¿‡ä¸€ä¸ªåå­—å¾—åˆ°ä¸€ä¸ªwatcherï¼Œç›‘å¬æœåŠ¡å™¨åœ°å€å˜åŒ–ã€‚	</span></div><div class="line">	Resolve(target <span class="keyword">string</span>) (Watcher, error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Watcher watches for the updates on the specified target.</span></div><div class="line"><span class="keyword">type</span> Watcher <span class="keyword">interface</span> &#123;</div><div class="line">	<span class="comment">// Next blocks until an update or error happens. It may return one or more</span></div><div class="line">	<span class="comment">// updates. The first call should get the full set of the results. It should</span></div><div class="line">	<span class="comment">// return an error if and only if Watcher cannot recover.</span></div><div class="line">  <span class="comment">// å¾—åˆ°ä¸‹æ¬¡æ›´æ–°çš„åœ°å€</span></div><div class="line">	Next() ([]*Update, error)</div><div class="line">	<span class="comment">// Close closes the Watcher.</span></div><div class="line">	Close()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="round-robin-balancer"><a href="#round-robin-balancer" class="headerlink" title="round robin balancer"></a>round robin balancer</h4><p>åœ¨äº†è§£äº†åç§°è§£ææœåŠ¡æ¥å£è¿‡å, çœ‹çœ‹round robinçš„å…·ä½“å®ç°:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> roundRobin <span class="keyword">struct</span> &#123;</div><div class="line">	r      naming.Resolver</div><div class="line">	w      naming.Watcher</div><div class="line">	addrs  []*addrInfo <span class="comment">// å®¢æˆ·ç«¯åº”è¯¥è¿æ¥çš„æ‰€æœ‰åœ°å€</span></div><div class="line">	mu     sync.Mutex</div><div class="line">	addrCh <span class="keyword">chan</span> []Address <span class="comment">// æœåŠ¡åœ°å€åˆ—è¡¨æ›´æ–°é€šçŸ¥channel</span></div><div class="line">	next   <span class="keyword">int</span>            <span class="comment">// index of the next address to return for Get()</span></div><div class="line">	waitCh <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;  <span class="comment">// the channel to block when there is no connected address available</span></div><div class="line">	done   <span class="keyword">bool</span>           <span class="comment">// The Balancer is closed.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rr *roundRobin)</span> <span class="title">Start</span><span class="params">(target <span class="keyword">string</span>, config BalancerConfig)</span> <span class="title">error</span></span> &#123;</div><div class="line">	rr.mu.Lock()</div><div class="line">	<span class="keyword">defer</span> rr.mu.Unlock()</div><div class="line">	<span class="keyword">if</span> rr.done &#123;</div><div class="line">		<span class="keyword">return</span> ErrClientConnClosing</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> rr.r == <span class="literal">nil</span> &#123;</div><div class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰ä½¿ç”¨åç§°è§£ææœåŠ¡, å°†ä¸ä¼šè¿›è¡Œåç§°è§£æ, åœ¨è¿™ç§æƒ…å†µä¸‹targetå°†ä¼šä½œä¸ºå”¯ä¸€å¯ç”¨çš„åœ°å€è¢«æ”¾å…¥</span></div><div class="line">    <span class="comment">// rr.addrs è¢«å®¢æˆ·ç«¯ä½¿ç”¨, æ­¤æ—¶addrChå°†æ²¡æœ‰åœ°å€, å§‹ç»ˆä¸ºnil</span></div><div class="line">		rr.addrs = <span class="built_in">append</span>(rr.addrs, &amp;addrInfo&#123;addr: Address&#123;Addr: target&#125;&#125;)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">  <span class="comment">// å¦‚æœåç§°è§£ææœåŠ¡å­˜åœ¨å°†ä¼šè°ƒç”¨åç§°è§£ææœåŠ¡çš„Resolveæ–¹æ³•, ç”Ÿæˆä¸€ä¸ªwatcher</span></div><div class="line">	w, err := rr.r.Resolve(target)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	rr.w = w</div><div class="line">	rr.addrCh = <span class="built_in">make</span>(<span class="keyword">chan</span> []Address)</div><div class="line">  <span class="comment">// å¯ä¸€ä¸ªGoroutineæ¥ä¸“é—¨æ›´æ–°åœ°å€åˆ°addrCh</span></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="keyword">if</span> err := rr.watchAddrUpdates(); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rr *roundRobin)</span> <span class="title">watchAddrUpdates</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">  <span class="comment">// è·å–éœ€è¦æ›´æ–°çš„åœ°å€</span></div><div class="line">	updates, err := rr.w.Next()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		grpclog.Printf(<span class="string">"grpc: the naming watcher stops working due to %v.\n"</span>, err)</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	rr.mu.Lock()</div><div class="line">	<span class="keyword">defer</span> rr.mu.Unlock()</div><div class="line">	<span class="keyword">for</span> _, update := <span class="keyword">range</span> updates &#123;</div><div class="line">		addr := Address&#123;</div><div class="line">			Addr:     update.Addr,</div><div class="line">			Metadata: update.Metadata,</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">switch</span> update.Op &#123;</div><div class="line">    <span class="comment">// å¦‚æœåœ°å€æ²¡æœ‰é‡å¤, åˆ™æ·»åŠ åˆ°åœ°å€åˆ—è¡¨ä¸­å»(rr.addrs)</span></div><div class="line">		<span class="keyword">case</span> naming.Add:</div><div class="line">			<span class="keyword">var</span> exist <span class="keyword">bool</span></div><div class="line">			<span class="keyword">for</span> _, v := <span class="keyword">range</span> rr.addrs &#123;</div><div class="line">				<span class="keyword">if</span> addr == v.addr &#123;</div><div class="line">					exist = <span class="literal">true</span></div><div class="line">					grpclog.Println(<span class="string">"grpc: The name resolver wanted to add an existing address: "</span>, addr)</div><div class="line">					<span class="keyword">break</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> exist &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			rr.addrs = <span class="built_in">append</span>(rr.addrs, &amp;addrInfo&#123;addr: addr&#125;)</div><div class="line">    <span class="comment">// ä»åœ°å€åˆ—è¡¨ä¸­(rr.addrs)ç§»é™¤å·²ç»å­˜åœ¨çš„åœ°å€</span></div><div class="line">		<span class="keyword">case</span> naming.Delete:</div><div class="line">			<span class="keyword">for</span> i, v := <span class="keyword">range</span> rr.addrs &#123;</div><div class="line">				<span class="keyword">if</span> addr == v.addr &#123;</div><div class="line">					<span class="built_in">copy</span>(rr.addrs[i:], rr.addrs[i+<span class="number">1</span>:])</div><div class="line">					rr.addrs = rr.addrs[:<span class="built_in">len</span>(rr.addrs)<span class="number">-1</span>]</div><div class="line">					<span class="keyword">break</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			grpclog.Println(<span class="string">"Unknown update.Op "</span>, update.Op)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Make a copy of rr.addrs and write it onto rr.addrCh so that gRPC internals gets notified.</span></div><div class="line">	open := <span class="built_in">make</span>([]Address, <span class="built_in">len</span>(rr.addrs))</div><div class="line">	<span class="keyword">for</span> i, v := <span class="keyword">range</span> rr.addrs &#123;</div><div class="line">		open[i] = v.addr</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> rr.done &#123;</div><div class="line">		<span class="keyword">return</span> ErrClientConnClosing</div><div class="line">	&#125;</div><div class="line">	rr.addrCh &lt;- open</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ç›´æ¥è¿”å›åœ°å€å˜æ›´çš„channel(æ³¨æ„åœ°å€ä¸æ˜¯å¢é‡æ˜¯å…¨é‡)</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rr *roundRobin)</span> <span class="title">Notify</span><span class="params">()</span> &lt;-<span class="title">chan</span> []<span class="title">Address</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> rr.addrCh</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>æ ¹æ®gRPCå®˜æ–¹æä¾›çš„è®¾è®¡æ€è·¯ï¼ŒåŸºäºè¿›ç¨‹å†…LBæ–¹æ¡ˆ(å³ç¬¬2ä¸ªæ¡ˆï¼Œé˜¿é‡Œå¼€æºçš„æœåŠ¡æ¡†æ¶ Dubbo ä¹Ÿæ˜¯é‡‡ç”¨ç±»ä¼¼æœºåˆ¶)ï¼Œç»“åˆåˆ†å¸ƒå¼ä¸€è‡´çš„ç»„ä»¶ï¼ˆå¦‚Zookeeperã€Consulã€Etcdï¼‰ï¼Œå¯æ‰¾åˆ°gRPCæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡çš„å¯è¡Œè§£å†³æ–¹æ¡ˆã€‚<br>æ ¹æ®å®˜æ–¹å·²ç»å®ç°Round Robinè´Ÿè½½å‡è¡¡å™¨, æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°ä¸€ä¸ªåå­—æœåŠ¡å™¨çš„æ¥å£ï¼Œç„¶åå°è£…åˆ°è¿™ä¸ªè´Ÿè½½å‡è¡¡å™¨ä¸­ï¼Œè¿™æ ·å°±ä¸éœ€è¦è‡ªå·±å®ç°æ•´ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚<br>æ¥ä¸‹æ¥æˆ‘ä»¬ç»“åˆetcdv3å®ç°ä¸€ä¸ªåè¯è§£ææœåŠ¡, å®Œæ•´ç¤ºä¾‹ä»£ç†: <a href="https://github.com/yumaojun03/golang/tree/master/grpc" target="_blank" rel="external">gRPC LBç¤ºä¾‹ä»£ç </a></p>
<h3 id="å®ç°åç§°è§£ææœåŠ¡"><a href="#å®ç°åç§°è§£ææœåŠ¡" class="headerlink" title="å®ç°åç§°è§£ææœåŠ¡"></a>å®ç°åç§°è§£ææœåŠ¡</h3><ul>
<li>é¦–å…ˆå®šä¹‰ä¸€ä¸ªresolver, resolverè¦æ±‚è¿”å›ä¸€ä¸ªå®ç°äº†watcheræ¥å£çš„å¯¹è±¡, è€Œwatcheréœ€è¦æœ‰æœåŠ¡åç§°å’Œetcdå®¢æˆ·ç«¯æ‰èƒ½è§£æå‡ºçœŸæ­£çš„æœåŠ¡åœ°å€: resolver.go</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">package lb</div><div class="line"></div><div class="line">import (</div><div class="line">    "errors"</div><div class="line">    "fmt</div><div class="line">    "strings"</div><div class="line"></div><div class="line">    etcd3 "github.com/coreos/etcd/clientv3"</div><div class="line">    "google.golang.org/grpc/naming"</div><div class="line">)</div><div class="line"></div><div class="line">// resolver is the implementaion of grpc.naming.Resolver</div><div class="line">type resolver struct &#123;</div><div class="line">    serviceName string // service name to resolve</div><div class="line">&#125;</div><div class="line"></div><div class="line">// NewResolver return resolver with service name</div><div class="line">func NewResolver(serviceName string) *resolver &#123;</div><div class="line">    return &amp;resolver&#123;serviceName: serviceName&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Resolve to resolve the service from etcd, target is the dial address of etcd</div><div class="line">// target example: "http://127.0.0.1:2379,http://127.0.0.1:12379,http://127.0.0.1:22379"</div><div class="line">func (re *resolver) Resolve(target string) (naming.Watcher, error) &#123;</div><div class="line">    if re.serviceName == "" &#123;</div><div class="line">        return nil, errors.New("grpclb: no service name provided")</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // generate etcd client</div><div class="line">    client, err := etcd3.New(etcd3.Config&#123;</div><div class="line">        Endpoints: strings.Split(target, ","),</div><div class="line">    &#125;)</div><div class="line">    if err != nil &#123;</div><div class="line">        return nil, fmt.Errorf("grpclb: creat etcd3 client failed: %s", err.Error())</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Return watcher</div><div class="line">    return &amp;watcher&#123;re: re, client: *client&#125;, nil</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>watcheræŒæœ‰æœåŠ¡åç§°å’Œetcdå®¢æˆ·ç«¯,ä»…éœ€è¦è°ƒç”¨etcdå®¢æˆ·ç«¯æŸ¥å‡ºè¯¥æœåŠ¡çš„åœ°å€åˆ—è¡¨å³å¯, æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨etcdå®ç°ä¸€ä¸ªwatcher(å®ç°Nextå’ŒColseæ–¹æ³•): watcher.go<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> lb</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    etcd3 <span class="string">"github.com/coreos/etcd/clientv3"</span></div><div class="line">    <span class="string">"golang.org/x/net/context"</span></div><div class="line">    <span class="string">"google.golang.org/grpc/naming"</span></div><div class="line">    <span class="string">"github.com/coreos/etcd/mvcc/mvccpb"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// watcher is the implementaion of grpc.naming.Watcher</span></div><div class="line"><span class="keyword">type</span> watcher <span class="keyword">struct</span> &#123;</div><div class="line">    re            *resolver <span class="comment">// re: Etcd Resolver</span></div><div class="line">    client        etcd3.Client</div><div class="line">    isInitialized <span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Close do nothing</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *watcher)</span> <span class="title">Close</span><span class="params">()</span></span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Next to return the updates</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *watcher)</span> <span class="title">Next</span><span class="params">()</span> <span class="params">([]*naming.Update, error)</span></span> &#123;</div><div class="line">    <span class="comment">// prefix is the etcd prefix/value to watch</span></div><div class="line">    prefix := fmt.Sprintf(<span class="string">"/%s/%s/"</span>, Prefix, w.re.serviceName)</div><div class="line"></div><div class="line">    <span class="comment">// check if is initialized</span></div><div class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡åŠåˆå§‹åŒ–æ—¶éœ€è¦è¿”å›ä¸€ä¸ªå…¨é‡çš„åœ°å€ç”¨äºæ›´æ–°</span></div><div class="line">    <span class="keyword">if</span> !w.isInitialized &#123;</div><div class="line">        <span class="comment">// query addresses from etcd</span></div><div class="line">        resp, err := w.client.Get(context.Background(), prefix, etcd3.WithPrefix())</div><div class="line">        w.isInitialized = <span class="literal">true</span></div><div class="line">        <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">            addrs := extractAddrs(resp)</div><div class="line">            <span class="comment">//if not empty, return the updates or watcher new dir</span></div><div class="line">            <span class="keyword">if</span> l := <span class="built_in">len</span>(addrs); l != <span class="number">0</span> &#123;</div><div class="line">                updates := <span class="built_in">make</span>([]*naming.Update, l)</div><div class="line">                <span class="keyword">for</span> i := <span class="keyword">range</span> addrs &#123;</div><div class="line">                    updates[i] = &amp;naming.Update&#123;Op: naming.Add, Addr: addrs[i]&#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> updates, <span class="literal">nil</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// generate etcd Watcher</span></div><div class="line">    <span class="comment">// åˆå§‹åŒ–å ç›‘å¬å˜é‡å³å¯</span></div><div class="line">    rch := w.client.Watch(context.Background(), prefix, etcd3.WithPrefix())</div><div class="line">    <span class="keyword">for</span> wresp := <span class="keyword">range</span> rch &#123;</div><div class="line">        <span class="keyword">for</span> _, ev := <span class="keyword">range</span> wresp.Events &#123;</div><div class="line">            <span class="keyword">switch</span> ev.Type &#123;</div><div class="line">            <span class="keyword">case</span> mvccpb.PUT:</div><div class="line">                <span class="keyword">return</span> []*naming.Update&#123;&#123;Op: naming.Add, Addr: <span class="keyword">string</span>(ev.Kv.Value)&#125;&#125;, <span class="literal">nil</span></div><div class="line">            <span class="keyword">case</span> mvccpb.DELETE:</div><div class="line">                <span class="keyword">return</span> []*naming.Update&#123;&#123;Op: naming.Delete, Addr: <span class="keyword">string</span>(ev.Kv.Value)&#125;&#125;, <span class="literal">nil</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">extractAddrs</span><span class="params">(resp *etcd3.GetResponse)</span> []<span class="title">string</span></span> &#123;</div><div class="line">    addrs := []<span class="keyword">string</span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> resp == <span class="literal">nil</span> || resp.Kvs == <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span> addrs</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> resp.Kvs &#123;</div><div class="line">        <span class="keyword">if</span> v := resp.Kvs[i].Value; v != <span class="literal">nil</span> &#123;</div><div class="line">            addrs = <span class="built_in">append</span>(addrs, <span class="keyword">string</span>(v))</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> addrs</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="å®ç°æœåŠ¡çš„æ³¨å†Œ"><a href="#å®ç°æœåŠ¡çš„æ³¨å†Œ" class="headerlink" title="å®ç°æœåŠ¡çš„æ³¨å†Œ"></a>å®ç°æœåŠ¡çš„æ³¨å†Œ</h3><p>åç§°è§£æåšå®Œäº†, éœ€è¦æœåŠ¡å°†åœ°å€æ³¨å†Œåˆ°etcdç›¸åº”çš„åœ°å€ä¸‹<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> lb</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"strings"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line"></div><div class="line">	etcd3 <span class="string">"github.com/coreos/etcd/clientv3"</span></div><div class="line">	<span class="string">"github.com/coreos/etcd/etcdserver/api/v3rpc/rpctypes"</span></div><div class="line">	<span class="string">"golang.org/x/net/context"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// Prefix should start and end with no slash</span></div><div class="line"><span class="keyword">var</span> Prefix = <span class="string">"etcd3_naming"</span></div><div class="line"><span class="keyword">var</span> client etcd3.Client</div><div class="line"><span class="keyword">var</span> serviceKey <span class="keyword">string</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> stopSignal = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="comment">// Register</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Register</span><span class="params">(name <span class="keyword">string</span>, host <span class="keyword">string</span>, port <span class="keyword">int</span>, target <span class="keyword">string</span>, interval time.Duration, ttl <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	serviceValue := fmt.Sprintf(<span class="string">"%s:%d"</span>, host, port)</div><div class="line">	serviceKey = fmt.Sprintf(<span class="string">"/%s/%s/%s"</span>, Prefix, name, serviceValue)</div><div class="line"></div><div class="line">	<span class="comment">// get endpoints for register dial address</span></div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	client, err := etcd3.New(etcd3.Config&#123;</div><div class="line">		Endpoints: strings.Split(target, <span class="string">","</span>),</div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"grpclb: create etcd3 client failed: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="comment">// invoke self-register with ticker</span></div><div class="line">		ticker := time.NewTicker(interval)</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="comment">// minimum lease TTL is ttl-second</span></div><div class="line">			resp, _ := client.Grant(context.TODO(), <span class="keyword">int64</span>(ttl))</div><div class="line">			<span class="comment">// å¦‚æœç¬¬ä¸€æ¬¡æ³¨å†Œè¯¥keyå°†ä¸å­˜åœ¨, éœ€è¦å»ºç«‹key, å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ³¨å†Œ, åˆ™åˆ·æ–°è¯¥keyçš„å€¼</span></div><div class="line">			_, err := client.Get(context.Background(), serviceKey)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">if</span> err == rpctypes.ErrKeyNotFound &#123;</div><div class="line">					<span class="keyword">if</span> _, err := client.Put(context.TODO(), serviceKey, serviceValue, etcd3.WithLease(resp.ID)); err != <span class="literal">nil</span> &#123;</div><div class="line">						log.Printf(<span class="string">"grpclb: set service '%s' with ttl to etcd3 failed: %s"</span>, name, err.Error())</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					log.Printf(<span class="string">"grpclb: service '%s' connect to etcd3 failed: %s"</span>, name, err.Error())</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// refresh set to true for not notifying the watcher</span></div><div class="line">				<span class="keyword">if</span> _, err := client.Put(context.Background(), serviceKey, serviceValue, etcd3.WithLease(resp.ID)); err != <span class="literal">nil</span> &#123;</div><div class="line">					log.Printf(<span class="string">"grpclb: refresh service '%s' with ttl to etcd3 failed: %s"</span>, name, err.Error())</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">select</span> &#123;</div><div class="line">			<span class="keyword">case</span> &lt;-stopSignal:</div><div class="line">				<span class="keyword">return</span></div><div class="line">			<span class="keyword">case</span> &lt;-ticker.C:</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// UnRegister delete registered service from etcd</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnRegister</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	stopSignal &lt;- <span class="literal">true</span></div><div class="line">	stopSignal = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>) <span class="comment">// just a hack to avoid multi UnRegister deadlock</span></div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	<span class="keyword">if</span> _, err := client.Delete(context.Background(), serviceKey); err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Printf(<span class="string">"grpclb: deregister '%s' failed: %s"</span>, serviceKey, err.Error())</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		log.Printf(<span class="string">"grpclb: deregister '%s' ok."</span>, serviceKey)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="å®ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯"><a href="#å®ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯" class="headerlink" title="å®ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯"></a>å®ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯</h3><ul>
<li><p>å®šä¹‰æœåŠ¡æ¥å£å¥‘çº¦: hello.proto</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">syntax = &quot;proto3&quot;;</div><div class="line"></div><div class="line">option java_multiple_files = true;</div><div class="line">option java_package = &quot;com.midea.jr.test.grpc&quot;;</div><div class="line">option java_outer_classname = &quot;HelloWorldProto&quot;;</div><div class="line">option objc_class_prefix = &quot;HLW&quot;;</div><div class="line"></div><div class="line">package helloworld;</div><div class="line"></div><div class="line">// The greeting service definition.</div><div class="line">service Greeter &#123;</div><div class="line">    //   Sends a greeting</div><div class="line">    rpc SayHello (HelloRequest) returns (HelloReply) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// The request message containing the user&apos;s name.</div><div class="line">message HelloRequest &#123;</div><div class="line">    string name = 1;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// The response message containing the greetings</div><div class="line">message HelloReply &#123;</div><div class="line">    string message = 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>æœåŠ¡ç«¯å¯åŠ¨æ—¶éœ€è¦æ³¨å†Œ</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"os/signal"</span></div><div class="line">	<span class="string">"syscall"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/net/context"</span></div><div class="line">	<span class="string">"google.golang.org/grpc"</span></div><div class="line"></div><div class="line">	pb <span class="string">"golang/grpc/example/pb"</span></div><div class="line">	grpclb <span class="string">"golang/grpc/lb"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	serv = flag.String(<span class="string">"service"</span>, <span class="string">"hello_service"</span>, <span class="string">"service name"</span>)</div><div class="line">	port = flag.Int(<span class="string">"port"</span>, <span class="number">50001</span>, <span class="string">"listening port"</span>)</div><div class="line">	reg  = flag.String(<span class="string">"reg"</span>, <span class="string">"http://192.168.204.7:2379"</span>, <span class="string">"register etcd address"</span>)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	flag.Parse()</div><div class="line"></div><div class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, fmt.Sprintf(<span class="string">"0.0.0.0:%d"</span>, *port))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	err = grpclb.Register(*serv, <span class="string">"127.0.0.1"</span>, *port, *reg, time.Second*<span class="number">10</span>, <span class="number">15</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</div><div class="line">	signal.Notify(ch, syscall.SIGTERM, syscall.SIGINT, syscall.SIGKILL, syscall.SIGHUP, syscall.SIGQUIT)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		s := &lt;-ch</div><div class="line">		log.Printf(<span class="string">"receive signal '%v'"</span>, s)</div><div class="line">		grpclb.UnRegister()</div><div class="line">		os.Exit(<span class="number">1</span>)</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	log.Printf(<span class="string">"starting hello service at %d"</span>, *port)</div><div class="line">	s := grpc.NewServer()</div><div class="line">	pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)</div><div class="line">	s.Serve(lis)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// server is used to implement helloworld.GreeterServer.</span></div><div class="line"><span class="keyword">type</span> server <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// SayHello implements helloworld.GreeterServer</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span> <span class="title">SayHello</span><span class="params">(ctx context.Context, in *pb.HelloRequest)</span> <span class="params">(*pb.HelloReply, error)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"%v: Receive is %s\n"</span>, time.Now(), in.Name)</div><div class="line">	<span class="keyword">return</span> &amp;pb.HelloReply&#123;Message: <span class="string">"Hello "</span> + in.Name&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>å®¢æˆ·ç«¯ä½¿ç”¨round robinè´Ÿè½½å‡è¡¡å™¨</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line"></div><div class="line">	pb <span class="string">"golang/grpc/example/pb"</span></div><div class="line">	grpclb <span class="string">"golang/grpc/lb"</span></div><div class="line">	<span class="string">"strconv"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/net/context"</span></div><div class="line">	<span class="string">"google.golang.org/grpc"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	serv = flag.String(<span class="string">"service"</span>, <span class="string">"hello_service"</span>, <span class="string">"service name"</span>)</div><div class="line">	reg  = flag.String(<span class="string">"reg"</span>, <span class="string">"http://192.168.204.7:2379"</span>, <span class="string">"register etcd address"</span>)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	flag.Parse()</div><div class="line">	r := grpclb.NewResolver(*serv)</div><div class="line">	b := grpc.RoundRobin(r)</div><div class="line"></div><div class="line">	ctx, _ := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</div><div class="line">	conn, err := grpc.DialContext(ctx, *reg, grpc.WithInsecure(), grpc.WithBalancer(b))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ticker := time.NewTicker(<span class="number">1</span> * time.Second)</div><div class="line">	<span class="keyword">for</span> t := <span class="keyword">range</span> ticker.C &#123;</div><div class="line">		client := pb.NewGreeterClient(conn)</div><div class="line">		resp, err := client.SayHello(context.Background(), &amp;pb.HelloRequest&#123;Name: <span class="string">"world "</span> + strconv.Itoa(t.Second())&#125;)</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"%v: Reply is %s\n"</span>, t, resp.Message)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>å¯åŠ¨3ä¸ªæœåŠ¡ç«¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go -port 50001</div><div class="line">2017/08/05 10:57:20 starting hello service at 50001</div><div class="line">2017-08-05 11:02:00.81258994 +0800 CST: Receive is world 0</div><div class="line">2017-08-05 11:02:03.812191776 +0800 CST: Receive is world 3</div><div class="line">2017-08-05 11:02:06.812970792 +0800 CST: Receive is world 6</div><div class="line">2017-08-05 11:02:09.809401404 +0800 CST: Receive is world 9</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go -port 50002</div><div class="line">2017/08/05 10:58:13 starting hello service at 50002</div><div class="line">2017-08-05 11:02:01.812108579 +0800 CST: Receive is world 1</div><div class="line">2017-08-05 11:02:04.811493797 +0800 CST: Receive is world 4</div><div class="line">2017-08-05 11:02:07.808267481 +0800 CST: Receive is world 7</div><div class="line">2017-08-05 11:02:10.808644591 +0800 CST: Receive is world 10</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go -port 50003</div><div class="line">2017/08/05 10:58:42 starting hello service at 50003</div><div class="line">2017-08-05 11:02:02.811818858 +0800 CST: Receive is world 2</div><div class="line">2017-08-05 11:02:05.812063511 +0800 CST: Receive is world 5</div><div class="line">2017-08-05 11:02:08.812688805 +0800 CST: Receive is world 8</div><div class="line">2017-08-05 11:02:11.811770723 +0800 CST: Receive is world 11</div></pre></td></tr></table></figure>
<p>å¯åŠ¨å®¢æˆ·ç«¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="variable">$go</span> run main.go</div><div class="line">2017-08-05 11:02:00.812164403 +0800 CST: Reply is Hello world 0</div><div class="line">2017-08-05 11:02:01.811569222 +0800 CST: Reply is Hello world 1</div><div class="line">2017-08-05 11:02:02.811516841 +0800 CST: Reply is Hello world 2</div><div class="line">2017-08-05 11:02:03.811806037 +0800 CST: Reply is Hello world 3</div><div class="line">2017-08-05 11:02:04.811077475 +0800 CST: Reply is Hello world 4</div><div class="line">2017-08-05 11:02:05.811687449 +0800 CST: Reply is Hello world 5</div><div class="line">2017-08-05 11:02:06.812519507 +0800 CST: Reply is Hello world 6</div><div class="line">2017-08-05 11:02:07.807912824 +0800 CST: Reply is Hello world 7</div><div class="line">2017-08-05 11:02:08.812355134 +0800 CST: Reply is Hello world 8</div><div class="line">2017-08-05 11:02:09.809015778 +0800 CST: Reply is Hello world 9</div><div class="line">2017-08-05 11:02:10.808287335 +0800 CST: Reply is Hello world 10</div><div class="line">2017-08-05 11:02:11.81142561 +0800 CST: Reply is Hello world 11</div></pre></td></tr></table></figure></p>
<p>æœ€åæˆ‘ä»¬çœ‹çœ‹etcdé‡Œé¢æˆ‘ä»¬æ³¨å†Œçš„æœåŠ¡:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@etcd-node01:~<span class="comment"># etcdctl get --prefix  --endpoints=192.168.204.7:2379 "/etcd3_naming"</span></div><div class="line">/etcd3_naming/hello_service/127.0.0.1:50001</div><div class="line">127.0.0.1:50001</div><div class="line">/etcd3_naming/hello_service/127.0.0.1:50002</div><div class="line">127.0.0.1:50002</div><div class="line">/etcd3_naming/hello_service/127.0.0.1:50003</div><div class="line">127.0.0.1:50003</div></pre></td></tr></table></figure></p>
<p>å‰©ä¸‹äº†åœæ‰ä¸€äº›æœåŠ¡,å®¢æˆ·ç«¯æ˜¯å¦æ­£å¸¸å°±ä½ ä»¬è‡ªå·±æµ‹è¯•äº†ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;APIç½‘å…³éœ€è¦å®ç°æœåŠ¡çš„è‡ªåŠ¨å‘ç°å’Œè´Ÿè½½å‡è¡¡, ç”±äºåé¢çš„æœåŠ¡åŸºæœ¬éƒ½é‡‡ç”¨gRPCå®ç°, å› æ­¤éœ€è¦éªŒè¯gRPCå¦‚ä½•å®ç°è¿™2ä¸ªåŠŸèƒ½ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="gRPC" scheme="https://blog.yumaojun.net/tags/gRPC/"/>
    
      <category term="APIGateway" scheme="https://blog.yumaojun.net/tags/APIGateway/"/>
    
  </entry>
  
  <entry>
    <title>å¾®æœåŠ¡ä¹‹API Gateway</title>
    <link href="https://blog.yumaojun.net/2017/08/01/api-gateway/"/>
    <id>https://blog.yumaojun.net/2017/08/01/api-gateway/</id>
    <published>2017-08-01T02:01:45.000Z</published>
    <updated>2017-08-08T03:17:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¾®æœåŠ¡æ¶æ„ä¸­é‚£äº›å•ä½“å¾®æœåŠ¡å…³æ³¨ä¸è‡ªèº«é¢†åŸŸ, è€ŒAPIGatewayå…³æ³¨æœåŠ¡å…¨è²Œ, æ‰€ä»¥ä»–æ˜¯ä¸€ä¸ªç»Ÿç­¹è€…, å¾ˆå¤šå…¨å±€éƒ½éœ€è¦çš„åŠŸèƒ½éœ€è¦åœ¨APIGatewayå¤„è¿›è¡Œå®ç°, è¿™ç¯‡æ–‡ç« æ˜¯è®¾è®¡ä¸€ä¸ªAPI Gatewayçš„æ¦‚è¿°, è®²è¿°APIç½‘å…³çš„éœ€æ±‚ã€ä»·å€¼ã€ä»¥åŠè®¾è®¡è¦æ±‚ã€‚<br><a id="more"></a></p>
<h2 id="SOAè®¾è®¡æ–¹æ³•"><a href="#SOAè®¾è®¡æ–¹æ³•" class="headerlink" title="SOAè®¾è®¡æ–¹æ³•"></a>SOAè®¾è®¡æ–¹æ³•</h2><p>SOAæ˜¯ä¸€ç§æ¶æ„çš„è®¾è®¡æ–¹æ³•, å…¨ç§°æ˜¯Service-Oriented Architecture(é¢å‘æœåŠ¡çš„æ¶æ„)ï¼Œå®ƒå°†åº”ç”¨ç¨‹åºçš„ä¸åŒåŠŸèƒ½å•å…ƒæ‹†è§£æˆç‹¬ç«‹çš„æœåŠ¡, å¤šä¸ªæœåŠ¡ç›´æ¥é€šè¿‡è‰¯å¥½çš„æ¥å£å’Œå¥‘çº¦è”ç³»èµ·æ¥,é‡‡ç”¨ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚</p>
<p>SOAå¯ä»¥è®©è½¯ä»¶æ¶æ„è¾¾åˆ°æ¾è€¦åˆ, å¯ä»¥ç”¨æ¥åº”å¯¹è‡ƒè‚¿çš„å•ä½“åº”ç”¨, æ¯”å¦‚å¤šä¸ªç»ˆç«¯ç”¨æˆ·åº”ç”¨ç¨‹åºå¯ä»¥å…±äº«åŒä¸€ä¸ªæœåŠ¡, å®ƒçš„ç›®æ ‡æ˜¯åœ¨ä¸å½±å“å…¶ä»–ä»»ä½•äººçš„æƒ…å†µä¸‹é€æ˜åœ°æ›¿æ¢ä¸€ä¸ªæœåŠ¡,åªè¦æ›¿æ¢ä¹‹åçš„æœåŠ¡çš„å¤–éƒ¨æ¥å£æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–å³å¯ã€‚è¿™ç§æ€§è´¨èƒ½å¤Ÿå¤§å¤§ç®€åŒ–è½¯ä»¶ç»´æŠ¤ç”šè‡³æ˜¯è½¯ä»¶é‡å†™çš„è¿‡ç¨‹ã€‚</p>
<p>ä»…ä»…è¾¾åˆ°æ¾è€¦åˆæ˜¯ä¸å¤Ÿçš„, æ¾è€¦åˆä¼šå¸¦æ¥å¤æ‚æ€§é—®é¢˜, å› æ­¤åŒæ—¶ä¹Ÿéœ€è¦é«˜å†…èš, APIç½‘å…³å°±æ˜¯ç”¨æ¥åšè¿™ä¸ªçš„, å› æ­¤<code>å¯¹å¤–</code>é‡‡ç”¨é«˜å†…èšçš„è¡¨ç°å½¢å¼æ¥é™ä½å¤æ‚æ€§, <code>å¯¹å†…</code>é‡‡ç”¨æ¾è€¦åˆçš„å®ç°æ–¹å¼æ¥åº”å¯¹å¿«é€Ÿå˜åŒ–çš„éœ€æ±‚ã€‚</p>
<h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><p>APIç½‘å…³çš„æµè¡Œï¼Œæºäºè¿‘å‡ å¹´æ¥ï¼Œç§»åŠ¨åº”ç”¨ä¸ä¼ä¸šé—´äº’è”éœ€æ±‚çš„å…´èµ·ã€‚ç§»åŠ¨åº”ç”¨ã€ä¼ä¸šäº’è”ï¼Œä½¿å¾—åå°æœåŠ¡æ”¯æŒçš„å¯¹è±¡ï¼Œä»ä»¥å‰å•ä¸€çš„Webåº”ç”¨ï¼Œæ‰©å±•åˆ°å¤šç§ä½¿ç”¨åœºæ™¯ï¼Œä¸”æ¯ç§ä½¿ç”¨åœºæ™¯å¯¹åå°æœåŠ¡çš„è¦æ±‚éƒ½ä¸å°½ç›¸åŒã€‚è¿™ä¸ä»…å¢åŠ äº†åå°æœåŠ¡çš„å“åº”é‡ï¼Œè¿˜å¢åŠ äº†åå°æœåŠ¡çš„å¤æ‚æ€§ã€‚éšç€å¾®æœåŠ¡æ¶æ„æ¦‚å¿µçš„æå‡ºï¼ŒAPIç½‘å…³æˆä¸ºäº†å¾®æœåŠ¡æ¶æ„çš„ä¸€ä¸ªæ ‡é…ç»„ä»¶ã€‚</p>
<p>å®ƒç”¨äºå¤„ç†å¾ˆå¤šé€šç”¨çš„é—®é¢˜, æ¯”å¦‚è®¿é—®è®¤è¯ã€æŠ¥æ–‡è½¬æ¢ã€è®¿é—®ç»Ÿè®¡ã€æœåŠ¡å‘ç°ã€é™æµç­‰ç­‰ã€‚</p>
<h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><p>ç‹å»¶ç‚¯åœ¨<a href="https://mp.weixin.qq.com/s?__biz=MzI5MDEzMzg5Nw==&amp;mid=2660393016&amp;idx=1&amp;sn=78596df454773ebfcbcdb62b56d5b6f1&amp;scene=21#wechat_redirect" target="_blank" rel="external">è°ˆAPIç½‘å…³çš„èƒŒæ™¯ã€æ¶æ„ä»¥åŠè½åœ°æ–¹æ¡ˆ</a>æœ‰å¦‚ä¸‹5ç§åœºæ™¯ä»‹ç»:</p>
<ul>
<li>é¢å‘Web Appçš„ç½‘å…³<br>è¿™ç±»åœºæ™¯ï¼Œåœ¨ç‰©ç†å½¢æ€ä¸Šç±»ä¼¼å‰åç«¯åˆ†ç¦»ï¼Œæ­¤æ—¶çš„Web Appå·²ç»ä¸æ˜¯å…¨åŠŸèƒ½çš„Web Appï¼Œè€Œæ˜¯æ ¹æ®åœºæ™¯å®šåˆ¶ã€åœºæ™¯åŒ–çš„Appã€‚</li>
<li>é¢å‘MobileAppçš„ç½‘å…³<br>è¿™ç±»åœºæ™¯ï¼Œç§»åŠ¨Appæ˜¯åç«¯Serviceçš„ä½¿ç”¨è€…ï¼Œæ­¤æ—¶çš„APIGWè¿˜éœ€è¦æ‰¿æ‹…ä¸€éƒ¨åˆ†MDMï¼ˆæ­¤å¤„æ˜¯æŒ‡ç§»åŠ¨è®¾å¤‡ç®¡ç†ï¼Œä¸æ˜¯ä¸»æ•°æ®ç®¡ç†ï¼‰çš„èŒèƒ½ã€‚</li>
<li>é¢å‘PartnerOpenAPIçš„ç½‘å…³<br>è¿™ç±»åœºæ™¯ï¼Œä¸»è¦ä¸ºäº†æ»¡è¶³ä¸šåŠ¡å½¢æ€å¯¹å¤–å¼€æ”¾ï¼Œä¸ä¼ä¸šå¤–éƒ¨åˆä½œä¼™ä¼´å»ºç«‹ç”Ÿæ€åœˆï¼Œæ­¤æ—¶çš„API GWéœ€è¦å¢åŠ é…é¢ã€æµæ§ã€ä»¤ç‰Œç­‰ä¸€ç³»åˆ—å®‰å…¨ç®¡æ§åŠŸèƒ½ã€‚</li>
<li>é¢å‘PartnerExternalAPIçš„ç½‘å…³<br>è¿™ç±»åœºæ™¯ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ»¡è¶³ä¼ä¸šè‡ªèº«ä¸šåŠ¡çš„éœ€è¦ï¼Œå®ç°å¯¹ä¼ä¸šè‡ªæœ‰ä¸šåŠ¡çš„æ˜ å°„ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ä½¿ç”¨ã€Œåˆä½œæ–¹è´¦å·ç™»å½•ã€ã€ã€Œä½¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°æ”¯ä»˜ã€ç­‰ç­‰ã€‚æ­¤æ—¶çš„APIGWå°±éœ€è¦åœ¨è¾¹ç•Œä¸Šï¼Œä¸ºä¼ä¸šå†…éƒ¨Service ç»Ÿä¸€è°ƒç”¨å¤–éƒ¨çš„APIåšç»Ÿä¸€çš„è®¤è¯ã€æˆæƒã€ä»¥åŠè®¿é—®æ§åˆ¶ã€‚</li>
<li>é¢å‘IoTSmartDeviceçš„ç½‘å…³<br>è¿™ç±»åœºæ™¯ä¸»è¦åœ¨ä¼ ç»Ÿä¼ä¸šï¼Œå°¤å…¶æ˜¯å·¥ä¸šä¼ä¸šï¼Œä¼ æ„Ÿå™¨ã€ç‰©ç†è®¾å¤‡ä»å·¥ä¸šæ§åˆ¶åè®®å‘IPè½¬æ¢ï¼Œå¯¼è‡´ç‰©ç†é“¾è·¯ä¸Šä¼šå­˜åœ¨ä¸€éƒ¨åˆ†å…¬ç½‘é“¾è·¯ã€‚æ­¤æ—¶çš„API GWæ‰€éœ€è¦æ»¡è¶³çš„ã€Œå†…å¤–å…¼ä¿®ã€çš„åŒå‘æ•°æ®æµï¼Œè®¾å¤‡ä¸€èˆ¬é€šè¿‡ä¸€ä¸ªã€Œå®¢æˆ·ä¾§ã€çš„é›†ä¸­ç½‘å…³åœ¨å’Œä¼ä¸šçš„æ¥å…¥ç½‘å…³è¿›è¡Œé€šä¿¡ã€‚</li>
</ul>
<p>åœ¨æˆ‘ä»¬è®²çš„å¾®æœåŠ¡æ¶æ„ä¸‹çš„APIç½‘å…³ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å‰ä¸¤ç§ä½¿ç”¨åœºæ™¯ã€‚å³ï¼Œä¸»è¦æ˜¯æŠŠä¼ä¸šå†…éƒ¨çš„APIèƒ½åŠ›ï¼Œæš´éœ²ç»™å…¶ä»–åº”ç”¨æˆ–åˆä½œä¼™ä¼´ä½¿ç”¨ã€‚</p>
<h2 id="ç½‘å…³çš„ä»·å€¼"><a href="#ç½‘å…³çš„ä»·å€¼" class="headerlink" title="ç½‘å…³çš„ä»·å€¼"></a>ç½‘å…³çš„ä»·å€¼</h2><p>ç½‘å…³å±‚ä½œä¸ºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„ä¸€å±‚æŒ¡æ¿ï¼Œä¸»è¦èµ·åˆ°äº†ä¸‰å¤§ç±»ä½œç”¨:</p>
<ul>
<li>å†…å¤–éš”ç¦»: å¼ºè°ƒå®‰å…¨æ€§, ä¼ä¸šç³»ç»Ÿçš„è¾¹ç•Œ,éš”ç¦»å¤–ç½‘ç¯å¢ƒå’Œå†…ç½‘ç¯å¢ƒã€‚</li>
<li>æœåŠ¡è§£è€¦: æœ‰äº†ç½‘å…³å’ŒæœåŠ¡å±‚çš„è§£è€¦, ä½¿å¾—å¾®æœåŠ¡ç³»ç»Ÿçš„å„æ–¹èƒ½å¤Ÿç‹¬ç«‹ã€è‡ªç”±ã€é«˜æ•ˆã€çµæ´»åœ°è°ƒæ•´ï¼Œè€Œä¸ç”¨æ‹…å¿ƒç»™å…¶ä»–æ–¹é¢å¸¦æ¥å½±å“, ä¾¿äºå„ä¸ªå›¢é˜Ÿå·¥ä½œçš„ç‹¬ç«‹æ€§ã€‚</li>
<li>è¾…åŠ©åŠŸèƒ½: æä¾›äº†ä¸€ä¸ªåœ°ç‚¹ï¼Œæ–¹ä¾¿é€šè¿‡æ‰©å±•æœºåˆ¶å¯¹è¯·æ±‚è¿›è¡Œä¸€ç³»åˆ—åŠ å·¥å’Œå¤„ç†ã€‚</li>
</ul>
<h3 id="å†…å¤–éš”ç¦»"><a href="#å†…å¤–éš”ç¦»" class="headerlink" title="å†…å¤–éš”ç¦»"></a>å†…å¤–éš”ç¦»</h3><p><img src="http://oiw1gzfww.bkt.clouddn.com/api-gateway-securety.png" alt="å†…å¤–éš”ç¦»"><br>ä¼ä¸šä¸ºäº†ä¿æŠ¤å†…éƒ¨ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œå†…ç½‘ä¸å¤–ç½‘éƒ½æ˜¯éš”ç¦»çš„ï¼Œä¼ä¸šçš„æœåŠ¡åº”ç”¨éƒ½æ˜¯è¿è¡Œåœ¨å†…ç½‘ç¯å¢ƒä¸­ï¼Œä¸ºäº†å®‰å…¨çš„è€ƒé‡ï¼Œä¸€èˆ¬éƒ½ä¸å…è®¸å¤–éƒ¨ç›´æ¥è®¿é—®ã€‚APIç½‘å…³éƒ¨ç½²åœ¨é˜²ç«å¢™å¤–é¢ï¼Œèµ·åˆ°ä¸€å±‚æŒ¡æ¿ä½œç”¨ï¼Œå†…éƒ¨ç³»ç»Ÿåªæ¥å—APIç½‘å…³è½¬å‘è¿‡æ¥çš„è¯·æ±‚ã€‚ç½‘å…³é€šè¿‡ç™½åå•æˆ–æ ¡éªŒè§„åˆ™ï¼Œå¯¹è®¿é—®è¿›è¡Œäº†åˆæ­¥çš„è¿‡æ»¤ã€‚ç›¸æ¯”é˜²ç«å¢™ï¼Œè¿™ç§è½¯ä»¶å®ç°çš„è¿‡æ»¤è§„åˆ™ï¼Œæ›´åŠ åŠ¨æ€çµæ´»ã€‚<br>åœ¨å®‰å…¨çš„è§’åº¦è€Œè¨€, æ­¤æ—¶ç½‘å…³å……å½“ç€åº”ç”¨é˜²ç«å¢™çš„ä½œç”¨(WAF)ã€‚</p>
<h3 id="æœåŠ¡è§£è€¦"><a href="#æœåŠ¡è§£è€¦" class="headerlink" title="æœåŠ¡è§£è€¦"></a>æœåŠ¡è§£è€¦</h3><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œæ•´ä¸ªç¯å¢ƒåŒ…æ‹¬æœåŠ¡çš„æä¾›è€…ã€æœåŠ¡çš„æ¶ˆè´¹è€…ã€æœåŠ¡è¿ç»´äººå‘˜ã€å®‰å…¨ç®¡ç†äººå‘˜ç­‰ï¼Œæ¯ä¸ªè§’è‰²çš„èŒè´£å’Œè¿°æ±‚éƒ½ä¸åŒã€‚ä¾‹å¦‚ï¼šæœåŠ¡æ¶ˆè´¹è€…å·²ç»éœ€è¦æå‡ºä¸€äº›æ–°çš„æœåŠ¡éœ€æ±‚ï¼Œä»¥å¿«é€Ÿåº”å¯¹ä¸šåŠ¡å˜åŒ–ï¼›æœåŠ¡æä¾›è€…ï¼Œä½œä¸ºä¸šåŠ¡æœåŠ¡çš„æ²‰æ·€æ–¹ï¼Œå¸Œæœ›ä¿æŒæœåŠ¡çš„é€šç”¨æ€§ä¸ç¨³å®šæ€§ï¼Œå¾ˆéš¾åº”å¯¹å¿«é€Ÿçš„å˜åŒ–ã€‚æœ‰äº†APIç½‘å…³è¿™ä¸€å±‚ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£è€¦å„æ–¹çš„ç›¸äº’ä¾èµ–å…³ç³»ï¼Œè®©å„æ–¹æ›´åŠ ä¸“æ³¨è‡ªå·±çš„ç›®æ ‡ã€‚</p>
<ul>
<li>è§£è€¦åŠŸèƒ½ä¸éåŠŸèƒ½<br>ä¼ä¸šåœ¨æŠŠæœåŠ¡æä¾›ç»™å¤–éƒ¨è®¿é—®æ—¶ï¼Œé™¤äº†å®ç°ä¸šåŠ¡é€»è¾‘åŠŸèƒ½å¤–ï¼Œè¿˜é¢ä¸´è®¸å¤šéåŠŸèƒ½æ€§çš„è¦æ±‚ã€‚ä¾‹å¦‚ï¼šéœ€è¦é˜²èŒƒé»‘å®¢æ”»å‡»ï¼Œéœ€è¦åº”å¯¹çªå‘çš„è®¿é—®é‡ã€éœ€è¦ç¡®è®¤ç”¨æˆ·çš„æƒé™ï¼Œéœ€è¦å¯¹è®¿é—®è¿›è¡Œç›‘æ§ç­‰ã€‚è¿™äº›éåŠŸèƒ½é€»è¾‘ï¼Œä¸èƒ½ä¸ä¸šåŠ¡é€»è¾‘çš„å¼€å‘æ··åœ¨ä¸€èµ·ï¼Œéœ€è¦æœ‰ä¸“ä¸šçš„äººå‘˜ç”šè‡³ä¸“ä¸šçš„å›¢é˜Ÿæ¥å¤„ç†ã€‚</li>
<li>è§£è€¦å®¢æˆ·ç«¯ä¸æœåŠ¡æä¾›è€…<br>å®¢æˆ·ç«¯ä¸æœåŠ¡æä¾›è€…åˆ†å±äºä¸åŒçš„å›¢é˜Ÿï¼Œå·¥ä½œæ€§è´¨è¦æ±‚ä¹Ÿä¸ç›¸åŒã€‚å¯¹äºæœåŠ¡æä¾›è€…æ¥è¯´ï¼Œä»–ä¸»è¦çš„èŒè´£æ˜¯å¯¹ä¸šåŠ¡è¿›è¡ŒæŠ½è±¡ï¼Œæä¾›å¯å¤ç”¨çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œä»–ä»¬éœ€è¦å¯¹ä¸šåŠ¡æ¨¡å‹è¿›è¡Œæ·±å…¥çš„æ€è€ƒå’Œæ²‰æ·€ï¼Œä¸èƒ½è½»æ˜“ä¸ºäº†å“åº”å¤–éƒ¨çš„éœ€æ±‚è€Œç ´åä¸šåŠ¡æ¨¡å‹çš„ç¨³å®šæ€§ã€‚è€Œä¸šåŠ¡çš„å¿«é€Ÿå˜åŒ–ï¼Œåˆè¦æ±‚ä¼ä¸šå¿«é€Ÿæä¾›æ¥å£æ¥æ»¡è¶³å®¢æˆ·ç«¯éœ€æ±‚ã€‚è¿™å°±éœ€è¦ä¸€ä¸ªä¸­é—´å±‚ï¼Œæ¥å¯¹æœåŠ¡å±‚çš„æ¥å£è¿›è¡Œå°è£…ï¼Œä»¥åŠæ—¶å“åº”å®¢æˆ·ç«¯çš„éœ€æ±‚ã€‚<br>é€šè¿‡è§£è€¦ï¼ŒæœåŠ¡å±‚å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ¥å£ã€åè®®å’ŒæŠ¥æ–‡æ ¼å¼æ¥æš´éœ²æœåŠ¡ï¼Œè€Œä¸å¿…è€ƒè™‘å®¢æˆ·ç«¯çš„å¤šç§å½¢æ€ã€‚<br>é‚£ä¹ˆ ç½‘å…³å±‚æ˜¯å¦éœ€è¦å®ç°æœåŠ¡çš„ç¼–æ’ï¼Ÿ<br>åœ¨ä»‹ç»APIç½‘å…³çš„ä¸€äº›æ–‡ç« ä¸­ï¼Œæåˆ°äº†ç½‘å…³å±‚çš„æœåŠ¡ç¼–æ’èƒ½åŠ›ã€‚ä»è§£è€¦çš„è§’åº¦å‡ºå‘ï¼ŒæœåŠ¡çš„ç¼–æ’ä¸é€‚åˆåœ¨ç½‘å…³å±‚è¿›è¡Œã€‚å¯¹æœåŠ¡çš„ç¼–æ’ï¼Œå…¶å®æ˜¯æä¾›äº†ä¸€ç§ä¸šåŠ¡èƒ½åŠ›ï¼Œå¦‚æœæŠŠæœåŠ¡çš„ç¼–æ’æ”¾åœ¨äº†ç½‘å…³å±‚ï¼Œå®é™…ä¸Šæ˜¯æŠŠä¸€éƒ¨åˆ†ä¸šåŠ¡èƒ½åŠ›æ”¾åœ¨äº†ç½‘å…³å±‚ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒæœåŠ¡å±‚ã€ç½‘å…³å±‚éƒ½æœ‰ä¸€äº›ä¸šåŠ¡èƒ½åŠ›ï¼Œé€ æˆå›¢é˜ŸèŒè´£çš„ä¸æ¸…ï¼Œä¹Ÿä¸åˆ©äºä¸šåŠ¡èƒ½åŠ›çš„æ²‰æ·€ã€‚</li>
</ul>
<h3 id="è¾…åŠ©åŠŸèƒ½"><a href="#è¾…åŠ©åŠŸèƒ½" class="headerlink" title="è¾…åŠ©åŠŸèƒ½"></a>è¾…åŠ©åŠŸèƒ½</h3><p>ç½‘å…³å±‚é™¤äº†è¯·æ±‚çš„è·¯ç”±ã€è½¬å‘å¤–ï¼Œè¿˜éœ€è¦è´Ÿè´£å®‰å…¨ã€é‰´æƒã€é™æµã€ç›‘æ§ç­‰ã€‚è¿™äº›åŠŸèƒ½çš„å®ç°æ–¹å¼ï¼Œå¾€å¾€éšç€ä¸šåŠ¡çš„å˜åŒ–ä¸æ–­è°ƒæ•´ã€‚ä¾‹å¦‚æƒé™æ§åˆ¶æ–¹é¢ï¼Œæ—©æœŸå¯èƒ½åªéœ€è¦ç®€å•çš„ç”¨æˆ·+å¯†ç æ–¹å¼ï¼Œåç»­ç”¨æˆ·é‡å¤§äº†åï¼Œå¯èƒ½ä¼šä½¿ç”¨é«˜æ€§èƒ½çš„ç¬¬ä¸‰æ–¹è§£å†³æ–¹æ¡ˆã€‚åˆä¾‹å¦‚ï¼Œé’ˆå¯¹ä¸åŒçš„ç›‘æ§æ–¹æ¡ˆï¼Œéœ€è¦è®°å½•ä¸åŒçš„æ—¥å¿—æ–‡ä»¶ã€‚<br>æ‰€ä»¥ï¼Œè¿™äº›èƒ½åŠ›ä¸èƒ½ä¸€å¼€å§‹å°±å›ºåŒ–åœ¨ç½‘å…³å¹³å°ä¸Šï¼Œè€Œåº”è¯¥æ˜¯ä¸€ç§å¯é…ç½®çš„æ–¹å¼ï¼Œä¾¿äºä¿®æ”¹å’Œæ›¿æ¢ã€‚è¿™å°±è¦æ±‚ç½‘å…³å±‚æä¾›ä¸€å¥—æœºåˆ¶ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ”¯æŒè¿™ç§åŠ¨æ€æ‰©å±•ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ‰äº†APIç½‘å…³å, ä¼šæœ‰ä»¥ä¸‹ä¼˜ç‚¹</p>
<ul>
<li>ç½‘å…³å±‚å¯¹å¤–éƒ¨å’Œå†…éƒ¨è¿›è¡Œäº†éš”ç¦»ï¼Œä¿éšœäº†åå°æœåŠ¡çš„å®‰å…¨æ€§ã€‚</li>
<li>å¯¹å¤–è®¿é—®æ§åˆ¶ç”±ç½‘ç»œå±‚é¢è½¬æ¢æˆäº†è¿ç»´å±‚é¢ï¼Œå‡å°‘å˜æ›´çš„æµç¨‹å’Œé”™è¯¯æˆæœ¬</li>
<li>å‡å°‘å®¢æˆ·ç«¯ä¸æœåŠ¡çš„è€¦åˆï¼ŒæœåŠ¡å¯ä»¥ç‹¬ç«‹å‘å±•ã€‚é€šè¿‡ç½‘å…³å±‚æ¥åšæ˜ å°„ã€‚</li>
<li>é€šè¿‡ç½‘å…³å±‚èšåˆï¼Œå‡å°‘å¤–éƒ¨è®¿é—®çš„é¢‘æ¬¡ï¼Œæå‡è®¿é—®æ•ˆç‡ã€‚</li>
<li>èŠ‚çº¦åç«¯æœåŠ¡å¼€å‘æˆæœ¬ï¼Œå‡å°‘ä¸Šçº¿é£é™©ã€‚</li>
<li>ä¸ºæœåŠ¡ç†”æ–­ï¼Œç°åº¦å‘å¸ƒï¼Œçº¿ä¸Šæµ‹è¯•æä¾›ç®€å•æ–¹æ¡ˆã€‚</li>
<li>ä¾¿äºæ‰©å±•ã€‚</li>
</ul>
<h2 id="è®¾è®¡è¦æ±‚"><a href="#è®¾è®¡è¦æ±‚" class="headerlink" title="è®¾è®¡è¦æ±‚"></a>è®¾è®¡è¦æ±‚</h2><p>é‚£ä¹ˆAPIç½‘å…³åœ¨è®¾è®¡æ—¶éœ€è¦è€ƒè™‘åˆ°é‚£äº›ç‚¹å–ƒï¼Ÿ</p>
<h3 id="é«˜æ€§èƒ½"><a href="#é«˜æ€§èƒ½" class="headerlink" title="é«˜æ€§èƒ½"></a>é«˜æ€§èƒ½</h3><p>ç½‘å…³ä½œä¸ºåº”ç”¨è®¿é—®çš„å”¯ä¸€å…¥å£, æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šç»è¿‡APIç½‘å…³è¿›è¡Œè½¬å‘, å¯æƒ³è€ŒçŸ¥, å¯¹APIç½‘å…³çš„è®¿é—®å‹åŠ›æ˜¯å·¨å¤§çš„ã€‚å› æ­¤APIç½‘å…³å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜, æ€§èƒ½ä¸Šè‡³å°‘ä¸èƒ½æ¯”nginxå¼±å¤ªå¤š, å› æ­¤ä¸šå†…ä½¿ç”¨nginx + luaçš„æ¯”è¾ƒå¤šã€‚</p>
<h3 id="é«˜å¯ç”¨"><a href="#é«˜å¯ç”¨" class="headerlink" title="é«˜å¯ç”¨"></a>é«˜å¯ç”¨</h3><p>APIç½‘å…³ä½œä¸ºé€»è¾‘ä¸Šçš„å•ç‚¹ï¼Œä¸€æ—¦å‘ç”Ÿé—®é¢˜ï¼Œå°†é€ æˆæ‰€æœ‰æœåŠ¡çš„ä¸å¯ç”¨ï¼Œå¯¹ä¼ä¸šæ¥è¯´å¯èƒ½é€ æˆçš„è‡´å‘½çš„å½±å“ã€‚è®¡ç®—çŸ­æ—¶é—´çš„ä¸å¯ç”¨ï¼Œä¹Ÿä¼šç»™ä¼ä¸šå¸¦æ¥ç›´æ¥çš„ç»æµæŸå¤±ã€‚æ‰€ä»¥ï¼Œå¦‚ä½•ä¿è¯APIç½‘å…³çš„7*24å°æ—¶çš„ç¨³å®šè¿è¡Œ, å› æ­¤ ç½‘å…³åœ¨å®ç°æ—¶ä¸€å®šè¦è€ƒè™‘æ¨ªå‘æ‰©å±•å’ŒAPIçƒ­æ›´æ–°çš„èƒ½åŠ›, é¿å…APIç½‘å…³å®•æœºã€‚</p>
<h3 id="é«˜æ‰©å±•"><a href="#é«˜æ‰©å±•" class="headerlink" title="é«˜æ‰©å±•"></a>é«˜æ‰©å±•</h3><p>å‰é¢è¯´åˆ°, ä¸€äº›éä¸šåŠ¡åŠŸèƒ½çš„éœ€æ±‚éœ€è¦ç½‘å…³æä¾›, æ¯”å¦‚: ä¾‹å¦‚æ—¥å¿—ã€å®‰å…¨ã€è´Ÿè½½å‡è¡¡ç­–ç•¥ã€é‰´æƒç­‰, è¿™å°±éœ€è¦ç½‘å…³å±‚æä¾›è¿™æ ·ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—å¯ä»¥çµæ´»åœ°è¿›è¡Œè¿™äº›è°ƒæ•´å’Œå˜åŒ–ï¼Œè€Œä¸ç”¨é¢‘ç¹å¯¹ç½‘å…³å±‚è¿›è¡Œæ”¹åŠ¨ï¼Œç¡®ä¿ç½‘å…³å±‚çš„ç¨³å®šæ€§ã€‚æ¯”å¦‚nginxé‡‡ç”¨æ¨¡å—æ¥è¿›è¡Œæ‰©å±•, å¹¶ä¸”æ”¯æŒæ¨¡å—çš„åŠ¨æ€åŠ è½½ã€‚</p>
<h3 id="é«˜è¿ç»´"><a href="#é«˜è¿ç»´" class="headerlink" title="é«˜è¿ç»´"></a>é«˜è¿ç»´</h3><p>APIåœ¨ä¸Šçº¿ã€å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œéƒ½éœ€è¦æ¶‰åŠåˆ°ç½‘å…³å±‚çš„é…åˆï¼Œä¾‹å¦‚ï¼Œéœ€è¦ç½‘å…³å±‚çŸ¥é“APIå‘å¸ƒçš„åœ°å€ï¼ŒAPIçš„æ¥å£å½¢å¼ã€æŠ¥æ–‡æ ¼å¼ï¼Œä¹Ÿéœ€è¦ç½‘å…³å±‚å¯¹åå°APIè¿›è¡Œå°è£…ã€‚åœ¨APIè°ƒæ•´åï¼Œéœ€è¦ä½œå‡ºç›¸åº”çš„ä¿®æ”¹ã€‚æ‰€ä»¥ï¼ŒAPIç½‘å…³è®¾è®¡æ—¶ï¼Œéœ€è¦æ˜ç¡®ç½‘å…³å±‚ä¸æœåŠ¡å±‚çš„èŒè´£åˆ‡åˆ†ä¸åä½œæ¨¡å¼ï¼Œä½¿å¾—APIçš„ç®¡ç†ã€å‘å¸ƒæ›´åŠ é«˜æ•ˆã€‚</p>
<h2 id="è½åœ°æ–¹æ¡ˆ"><a href="#è½åœ°æ–¹æ¡ˆ" class="headerlink" title="è½åœ°æ–¹æ¡ˆ"></a>è½åœ°æ–¹æ¡ˆ</h2><p>é’ˆå¯¹ä»¥ä¸Šçš„éœ€è¦, å¦‚ä½•è®¾è®¡ä¸€æ¬¾è¿˜é è°±çš„APIç½‘å…³å–ƒ?</p>
<h3 id="è®¾è®¡åŸåˆ™"><a href="#è®¾è®¡åŸåˆ™" class="headerlink" title="è®¾è®¡åŸåˆ™"></a>è®¾è®¡åŸåˆ™</h3><ul>
<li>é«˜æ€§èƒ½: é‡‡ç”¨Golangæ¥è¿›è¡Œå¼€å‘, ç¡®ä¿æ€§èƒ½</li>
<li>é«˜å¯ç”¨: 1. ç½‘å…³å±‚é‡‡ç”¨æ— çŠ¶æ€è®¾è®¡, å°†è®¤è¯æ¨¡å—ç‹¬ç«‹å¤„ç† 2. ä¼˜é›…ä¸‹çº¿, é‡‡ç”¨go çš„gracefulåšå¤„ç†</li>
<li>é«˜æ‰©å±•: é‡‡ç”¨httpä¸­é—´ä»¶çš„æ–¹å¼, æä¾›çµæ´»çš„æ‰©å±•èƒ½åŠ›</li>
</ul>
<h3 id="åŠŸèƒ½ç‚¹"><a href="#åŠŸèƒ½ç‚¹" class="headerlink" title="åŠŸèƒ½ç‚¹"></a>åŠŸèƒ½ç‚¹</h3><p>ä¸€ä¸ªå®Œæ•´çš„APIç½‘å…³åº”è¯¥å…·æœ‰å¦‚ä¸‹å‡ æ–¹é¢çš„åŠŸèƒ½:</p>
<ul>
<li>æœåŠ¡å‘ç°, è´Ÿè½½å‡è¡¡, æœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥<br>API Gatewayéœ€è¦çŸ¥é“æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„IPå’Œç«¯å£ã€‚åœ¨ä¼ ç»Ÿåº”ç”¨ä¸­ï¼Œä½ å¯èƒ½ä¼šç¡¬ç¼–ç è¿™äº›åœ°å€ï¼Œä½†æ˜¯åœ¨ç°åœ¨äº‘åŸºç¡€çš„å¾®æœåŠ¡åº”ç”¨ä¸­ï¼Œè¿™å°†æ˜¯ä¸ªç®€å•çš„é—®é¢˜ã€‚åŸºç¡€æœåŠ¡é€šå¸¸ä¼šé‡‡ç”¨é™æ€åœ°å€ï¼Œå¯ä»¥é‡‡ç”¨æ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡æ¥æŒ‡å®šã€‚ä½†æ˜¯ï¼Œæ¢æµ‹åº”ç”¨æœåŠ¡çš„åœ°å€å°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ã€‚åº”ç”¨æœåŠ¡é€šå¸¸åŠ¨æ€åˆ†é…åœ°å€å’Œç«¯å£ã€‚åŒæ ·çš„ï¼Œç”±äºæ‰©å±•æˆ–è€…å‡çº§ï¼ŒæœåŠ¡çš„å®ä¾‹ä¹Ÿä¼šåŠ¨æ€çš„æ”¹å˜ã€‚å› æ­¤ï¼ŒAPI Gatewayéœ€è¦é‡‡ç”¨ç³»ç»Ÿçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œè¦ä¹ˆé‡‡ç”¨æœåŠ¡ç«¯å‘ç°ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘ç°ã€‚å¦‚æœé‡‡ç”¨å®¢æˆ·ç«¯å‘ç°æœåŠ¡ï¼ŒAPI Gatewayå¿…é¡»è¦å»æŸ¥è¯¢æœåŠ¡æ³¨å†Œå¤„ï¼Œä¹Ÿå°±æ˜¯å¾®æœåŠ¡å®ä¾‹åœ°å€çš„æ•°æ®åº“ã€‚<br>å‘ç°äº†å¤šä¸ªå¾®æœåŠ¡çš„å®ä¾‹è¿‡å, éœ€è¦é‡‡ç”¨è´Ÿè½½å‡è¡¡æœºåˆ¶è¿›è¡Œè°ƒåº¦, å¹¶ä¸”éœ€è¦æ£€æŸ¥æœåŠ¡çŠ¶æ€, å½“æœåŠ¡ç¦»çº¿æ—¶, è¯·æ±‚å°†ä¸ä¼šè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚</li>
<li>ç†”æ–­æ¨¡å¼<br>ä¹Ÿå«circuit breakæ¨¡å¼ï¼Œå®ƒå¯ä»¥å°†å®¢æˆ·ç«¯ä»æ— å“åº”æœåŠ¡çš„æ— å°½ç­‰å¾…ä¸­åœæ­¢ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡çš„é”™è¯¯ç‡è¶…è¿‡é¢„è®¾å€¼ï¼Œå°†ä¸­æ–­æœåŠ¡ï¼Œå¹¶ä¸”åœ¨ä¸€æ®µæ—¶é—´å†…æ‰€æœ‰è¯·æ±‚ç«‹åˆ»å¤±æ•ˆã€‚<br>å…·ä½“å¯ä»¥å‚è€ƒ: <a href="https://eacdy.gitbooks.io/spring-cloud-book/content/2%20Spring%20Cloud/2.4%20%E7%86%94%E6%96%AD%E5%99%A8.html" target="_blank" rel="external">ç†”æ–­å™¨</a></li>
<li>é€Ÿç‡é™åˆ¶<br>æ— è®ºå¦‚ä½• ä½ åç«¯çš„æœåŠ¡èµ„æºä¸å¯èƒ½æ— é™åŠ¨æ€æ‰©å±•, ç»ˆæœ‰è¯», ä¸ºäº†ä¿æŠ¤åç«¯æœåŠ¡ä¸è¢«å‡»å®, å¯ä»¥åœ¨ç½‘å…³å±‚åšè®¿é—®é€Ÿç‡çš„é™åˆ¶ã€‚</li>
<li>åŸºäºIPçš„è®¿é—®æ§åˆ¶<br>è¿™ä¸ªæ˜¯WAFçš„åŸºæœ¬åŠŸèƒ½, é¿å…DOS, å°é”æŸä¸ªIPçš„æ¶æ„è®¿é—®ã€‚</li>
<li>åè®®è½¬æ¢<br>ç½‘å…³æä¾›RESTfulçš„HTTPçš„æ¥å£, ä½†æ˜¯åç«¯ å¯èƒ½æä¾›æœåŠ¡çš„åè®®å¯èƒ½å„ä¸ç›¸åŒé€š, æ¯”å¦‚gRPC, HTTP, MQ, ç­‰ã€‚å› æ­¤ç½‘å…³åº”è¯¥èƒ½é€‚é…å¤šåè®®çš„æ”¯æŒã€‚</li>
<li>è¯·æ±‚è·¯ç”±<br>åŸºäºURLçš„è·¯ç”±åŠŸèƒ½</li>
<li>APIä½¿ç”¨ç»Ÿè®¡<br>è®°å½•API Metricå¦‚è¯·æ±‚æ¬¡æ•°ã€è¯·æ±‚å¤§å°ã€å“åº”çŠ¶æ€å’Œå»¶è¿Ÿï¼Œå¯è§†åŒ–API Metric</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://blog.dreamfever.me/api-gateway/" target="_blank" rel="external">æµ…è°ˆ API Gateway</a><br><a href="http://www.yantinglam.com/2016/12/15/Microservices-2016-12-15-API-Gateway-of-micro-service/" target="_blank" rel="external">å¾®æœåŠ¡æ¶æ„ä¸­çš„API Gateway</a><br><a href="http://dockone.io/article/482" target="_blank" rel="external">å¾®æœåŠ¡å®æˆ˜ï¼ˆäºŒï¼‰ï¼šä½¿ç”¨API Gateway</a><br><a href="https://mp.weixin.qq.com/s/RuN5RfQfksQZRPACloqHEq" target="_blank" rel="external">ä¼ä¸šçº§APIç½‘å…³çš„è®¾è®¡</a><br><a href="https://baike.baidu.com/item/%E9%9D%A2%E5%90%91%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/8258990?fr=aladdin&amp;fromid=5577988&amp;fromtitle=SOA%E6%9E%B6%E6%9E%84" target="_blank" rel="external">é¢å‘æœåŠ¡æ¶æ„</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¾®æœåŠ¡æ¶æ„ä¸­é‚£äº›å•ä½“å¾®æœåŠ¡å…³æ³¨ä¸è‡ªèº«é¢†åŸŸ, è€ŒAPIGatewayå…³æ³¨æœåŠ¡å…¨è²Œ, æ‰€ä»¥ä»–æ˜¯ä¸€ä¸ªç»Ÿç­¹è€…, å¾ˆå¤šå…¨å±€éƒ½éœ€è¦çš„åŠŸèƒ½éœ€è¦åœ¨APIGatewayå¤„è¿›è¡Œå®ç°, è¿™ç¯‡æ–‡ç« æ˜¯è®¾è®¡ä¸€ä¸ªAPI Gatewayçš„æ¦‚è¿°, è®²è¿°APIç½‘å…³çš„éœ€æ±‚ã€ä»·å€¼ã€ä»¥åŠè®¾è®¡è¦æ±‚ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¾®æœåŠ¡" scheme="https://blog.yumaojun.net/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
      <category term="APIGateway" scheme="https://blog.yumaojun.net/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/APIGateway/"/>
    
    
      <category term="APIGateway" scheme="https://blog.yumaojun.net/tags/APIGateway/"/>
    
  </entry>
  
  <entry>
    <title>IOTæ¶æ„</title>
    <link href="https://blog.yumaojun.net/2017/07/17/iot-architecture/"/>
    <id>https://blog.yumaojun.net/2017/07/17/iot-architecture/</id>
    <published>2017-07-17T08:58:05.000Z</published>
    <updated>2017-08-08T03:15:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å¼€å‘äº†ä¸€æ¬¡IOTç»„ä»¶, åœ¨æ­¤æœŸé—´ä¹Ÿå‚è€ƒäº†ä¸‹å…¶ä»–IOTå¹³å°çš„è®¾è®¡æ¶æ„, æœ‰æ‰€æ„Ÿæƒ³, å› æ­¤å°†å…¶è®°å½•ä¸‹æ¥, å’Œå¤§å®¶åˆ†äº«, æ¬¢è¿äº¤æµã€‚<br><a id="more"></a></p>
<h2 id="IOTæ˜¯ä»€ä¹ˆ"><a href="#IOTæ˜¯ä»€ä¹ˆ" class="headerlink" title="IOTæ˜¯ä»€ä¹ˆ"></a>IOTæ˜¯ä»€ä¹ˆ</h2><p>IoTæ˜¯Internet of Thingsçš„ç¼©å†™, å®ƒæ˜¯äº’è”ç½‘ä»äººå‘ç‰©çš„å»¶ä¼¸, æ ¸å¿ƒå’ŒåŸºç¡€ä»ç„¶æ˜¯äº’è”ç½‘æŠ€æœ¯ï¼Œæ˜¯äº’è”ç½‘æŠ€æœ¯åŸºç¡€ä¸Šçš„å»¶ä¼¸å’Œæ‰©å±•ã€‚ å®ƒå°†å„ç§ä¿¡æ¯ä¼ æ„Ÿè®¾å¤‡ï¼Œå¦‚å°„é¢‘è¯†åˆ«è£…ç½®ã€çº¢å¤–æ„Ÿåº”å™¨ã€å…¨çƒå®šä½ç³»ç»Ÿã€æ¿€å…‰æ‰«æå™¨ç­‰ç§ç§è£…ç½®, æŒ‰çº¦å®šçš„åè®®, å°†ä»»ä½•ç‰©å“ä¸äº’è”ç½‘ç›¸è¿æ¥, è¾¾åˆ°ç‰©å“ä¹‹é—´è¿›è¡Œä¿¡æ¯äº¤æ¢å’Œé€šè®¯çš„ç›®çš„ï¼Œä»¥å®ç°æ™ºèƒ½åŒ–è¯†åˆ«ã€å®šä½ã€è¿½è¸ªã€ç›‘æ§å’Œç®¡ç†ç­‰ã€‚<br>IOTä¹Ÿå°†åŠ é€ŸAIçš„è§‰é†’, å®ƒå°†ä¸‡ç‰©äº’è”, å†åŠ ä¸Šæˆç†Ÿçš„å¤§æ•°æ®å¤„ç†, æ·±åº¦å­¦ä¹ çš„åº”ç”¨ ä¼šè®©ä¸‡ç‰©éƒ½å¸¦æœ‰çµæ€§, è¿™æ˜¯å¤šä¹ˆå®å¤§çš„ä¸€ä¸ªæ—¶ä»£, 2016è¢«ç§°ä¸ºAIçš„å…ƒå¹´, éšç€IOTçš„åŠ é€Ÿ, æˆ‘ä»¬å°†æ˜¯è¿™æ ·ä¸€ä¸ªæ—¶ä»£çš„è§è¯è€…,è§è¯AIè§‰é†’çš„ç¬¬ä¸€ä»£äººã€‚<br>ä¸‹é¢æ˜¯ä¸€å¼ ç‰©è”ç½‘åœ¨å·¥ä¸šå¼•ç”¨çš„ä¸€å¼ å›¾<br><img src="http://www.mr-wu.cn/wp-content/uploads/2015/12/The-internet-of-things.jpg" alt="åº”ç”¨åœºæ™¯"><br>è¿™æ ·çœ‹æ¥æœªæ¥å¾ˆç¾å¥½, ä½†æ˜¯ç°å®å¾ˆæ®‹é…·, å¦‚ä½•å®ç°è½åœ°ä¸€å¥—å¯é çš„IOTæ–¹æ¡ˆä»»ç„¶æ˜¯ä¸ªéš¾é¢˜, åœ¨å‚è€ƒäº†ä¸€äº›å›½å¤–çš„æ–¹æ¡ˆè¿‡å, ç»“åˆè‡ªå·±çš„å®è·µ, ç»™å‡ºäº†ä¸€ç§æˆ‘è®¤ä¸ºçš„å¯è½åˆ°çš„IOTæ–¹æ¡ˆæ¶æ„ã€‚</p>
<h2 id="IOTçš„éš¾ç‚¹"><a href="#IOTçš„éš¾ç‚¹" class="headerlink" title="IOTçš„éš¾ç‚¹"></a>IOTçš„éš¾ç‚¹</h2><p>IOTåœ¨è½åœ°è¿‡ç¨‹ä¸­æœ‰è¯¸å¤šéš¾ç‚¹, å›½å†…å¾ˆå¤šIOTä¹Ÿæ˜¯åˆšèµ·æ­¥çš„çŠ¶æ€, èƒ½å‚è€ƒçš„å°±å›½å¤–å‡ å®¶äº‘çš„å¤§å‚å•†ã€‚</p>
<h3 id="æ¶‰åŠæŠ€æœ¯ä¼—å¤š"><a href="#æ¶‰åŠæŠ€æœ¯ä¼—å¤š" class="headerlink" title="æ¶‰åŠæŠ€æœ¯ä¼—å¤š"></a>æ¶‰åŠæŠ€æœ¯ä¼—å¤š</h3><p>IOTæ¶‰åŠåˆ°å¾ˆå¤šæŠ€æœ¯, ä¸‹é¢ä¸€å¼ å›¾ ä»å‡ ä¸ªç»´åº¦å±•ç¤ºäº†IOTæ¶‰åŠåˆ°çš„ä¸€äº›æŠ€æœ¯ç‚¹:<br><img src="http://oiw1gzfww.bkt.clouddn.com/iot-tech.png" alt="æŠ€æœ¯ä½“ç³»"><br>ä»æŠ€æœ¯ä¸Šçœ‹, æ¶‰åŠä¼—å¤šæŠ€æœ¯, å› æ­¤å¯¹å¼€å‘è€…æœ‰ä¸€å®šçš„è¦æ±‚, æ‹›äººæ˜¯ä¸ªé—®é¢˜ã€‚</p>
<h3 id="æ¶æ„éš¾è®¾è®¡"><a href="#æ¶æ„éš¾è®¾è®¡" class="headerlink" title="æ¶æ„éš¾è®¾è®¡"></a>æ¶æ„éš¾è®¾è®¡</h3><p>IOTé¢å¯¹çš„æ˜¯ä¸‡ç‰©, åœ¨ä¸‡ç‰©æ¥å…¥æ—¶éœ€è¦è€ƒè™‘åˆ° æ•°æ®çš„å®‰å…¨, é“¾æ¥çš„ç®¡ç†, æµ·é‡æµæ•°æ®ä¸Šä¼ , æµ·é‡æ•°æ®çš„å­˜å‚¨ ç®¡ç† åˆ†æã€‚ç»¼åˆæ¥è¯´ æ¶æ„è®¾è®¡å¿…é¡»æ»¡è¶³: æµ·é‡ã€é€šç”¨ã€å¯æ‰©å±•ã€ç®€å• å› æ­¤è¿™æ˜¯ä¸€å¥—åºå¤§çµæ´»çš„ç³»ç»Ÿ, è€Œè¿™æ ·çš„ç³»ç»Ÿ å¾€å¾€äº‘å‚å•†æ¯”è¾ƒæœ‰ç»éªŒ, æ¯”å¦‚Openstackçš„è®¾è®¡å°±æ˜¯ä¸€ä¸ªä¸é”™çš„æ¶æ„ã€‚<br>æ•´ä½“è€Œè¨€IOTçš„æ¶æ„åº”è¯¥å±äºå¾®æœåŠ¡æ¶æ„, å¾®æœåŠ¡æ¶æ„çš„è®¾è®¡å’Œå¼€å‘ å¾€å¾€éƒ½æ˜¯æŠŠåŒåˆƒå‰‘, å¦‚æœåˆ’ä¸æ¸…æœåŠ¡çš„è¾¹ç•Œ(é¢†åŸŸåˆ’åˆ†)å’Œè§„èŒƒä¸äº†æœåŠ¡äº¤äº’çš„æµç¨‹å’Œæ–¹å¼, é‚£ä¹ˆè¿™æ ·çš„æ¶æ„ä¹Ÿæ˜¯ä¸€ä¸ªç¾éš¾, æœ€ç»ˆé€ æˆ ç†ä¸æ–­å‰ªè¿˜ä¹±çš„ä¸€ä¸ªå±€é¢ã€‚<br>ä¸‹é¢æ˜¯ä¸€å¼ åŸºç¡€çš„IOTæ¶æ„å›¾, èƒ½å¾ˆå¥½çš„æè¿°IOTä¸­æ ¸å¿ƒçš„å…³é”®ç‚¹:<br><img src="http://www.eeiot.com/Public/Upload/attached/image/20150529/20150529151253_23315.jpg" alt="åŸºäºMQTTçš„ç‰©è”ç½‘æ¶æ„"></p>
<h2 id="æ¶æ„æ¦‚è¿°"><a href="#æ¶æ„æ¦‚è¿°" class="headerlink" title="æ¶æ„æ¦‚è¿°"></a>æ¶æ„æ¦‚è¿°</h2><p>å†å¤æ‚çš„äº‹å„¿, ä¹Ÿéœ€è¦æŠ“ä½å…¶æ ¸å¿ƒç‚¹ æ‰èƒ½æœ‰æ•ˆå±•å¼€ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“è¿™ä¸ªæ¶æ„çš„ç²¾é«“æ˜¯å•¥, åœ¨å›´ç»•é‚£æ ¸å¿ƒç‚¹ã€‚<br>å‚è€ƒä¸Šé¢é‚£å¼ æ¶æ„å›¾, æˆ‘ä»¬å¯ä»¥ç†è§£IOTçš„æ ¸å¿ƒåœ¨å®Œæˆè¿™æ ·å‡ ä»¶äº‹:</p>
<ul>
<li>è¿æ¥è®¾å¤‡</li>
<li>è®¾å¤‡æ•°æ®åˆ†æ</li>
<li>è®¾å¤‡æ•°æ®è¿è¥ä¸å¯è§†åŒ–</li>
</ul>
<p>æ ¸å¿ƒä¹‹å¤–æ˜¯ä»¥ä¸‹å‘¨è¾¹æœåŠ¡, ç”¨äºæå‡å’Œæ‰©å±•åŠŸèƒ½:</p>
<ul>
<li>åŠŸèƒ½å¹³å°: æ¯”å¦‚æ¶ˆæ¯é€šçŸ¥, æä¾›å¯¹å¹³å°æ ¸å¿ƒåŠŸèƒ½ä»¥å¤–çš„ä¸€äº›è¡¥å……ã€‚</li>
</ul>
<h2 id="æ¶æ„è¯¦è§£"><a href="#æ¶æ„è¯¦è§£" class="headerlink" title="æ¶æ„è¯¦è§£"></a>æ¶æ„è¯¦è§£</h2><p>åœ¨å‚è€ƒäº†AWSå’ŒAzureçš„IOTè¿‡å, ç»“åˆè‡ªå·±çš„è®¤è¯†,æ€»ç»“å‡ºæ¥çš„IOTæ¶æ„å›¾ã€‚<br><img src="http://oiw1gzfww.bkt.clouddn.com/iot-define.png" alt="iotæ¶æ„å›¾"><br>æŒ‰ç…§é¢†åŸŸå¯¹æ¨¡å—è¿›è¡Œåˆ’åˆ†, ä¸»è¦ç”±å‡ ä¸‹å‡ ä¸ªæ¨¡å—ç»„æˆ:</p>
<ul>
<li>è¿æ¥è®¾å¤‡: <ul>
<li>æœ¬åœ°: è´Ÿè´£è®¾å¤‡æ•°æ®çš„é‡‡é›†ä¸ŠæŠ¥ä¸åå‘æ§åˆ¶ã€‚</li>
<li>äº‘ç«¯: å°†æ‰€æœ‰è®¾å¤‡æ¥å…¥äº‘ï¼Œæ¥æ”¶æ•°æ®ï¼ŒåŒæ—¶è´Ÿè´£ç®¡ç†è¿™äº›è®¾å¤‡çš„æˆæƒå’Œé™åˆ¶ </li>
</ul>
</li>
<li>æ•°æ®åˆ†æ: é€šè¿‡æä¾› ç¦»çº¿è®¡ç®—æˆ–è€…åœ¨çº¿è®¡ç®—çš„å¯ç¼–ç¨‹æ¥å£ ä¸ºç”¨æˆ·æä¾›æ•°æ®åˆ†æçš„èƒ½åŠ›</li>
<li>æ•°æ®å¯è§†åŒ–ä¸è¿è¥: é‡‡é›†ä¸ŠæŠ¥çš„æ•°æ®ä»¥åŠåˆ†æè¿‡åçš„æ•°æ®çš„å¯è§†åŒ–, æ•°æ®æ ‡è®°, æ•°æ®æˆæƒç­‰å¸¦ä¸šåŠ¡æ€§è´¨çš„æ•°æ®ç®¡ç†ã€‚</li>
<li>APIç½‘å…³: è´Ÿè´£è¯·æ±‚çš„ç»Ÿä¸€ä»£ç†, å±è”½æ‰å†…éƒ¨ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚</li>
<li>ç”¨æˆ·ç®¡ç†: ç»Ÿä¸€çš„ç”¨æˆ·ä½“ç³» ç”¨äºç”¨æˆ·ç®¡ç†, æƒé™ç®¡ç† </li>
</ul>
<h3 id="æ¦‚å¿µç®€ä»‹"><a href="#æ¦‚å¿µç®€ä»‹" class="headerlink" title="æ¦‚å¿µç®€ä»‹"></a>æ¦‚å¿µç®€ä»‹</h3><p>æ•´ä¸ªæ¶æ„ä¸­ è®¾è®¡åˆ°å¦‚ä¸‹ä¸€äº›æ¦‚å¿µ:</p>
<ul>
<li>ä¸šåŠ¡æ¦‚å¿µ: ä¸æ•°æ®ç›¸å…³, ç”¨æˆ·è‡ªå·±å®šä¹‰çš„<ol>
<li>è®¾å¤‡(device): ç”¨æˆ·çš„éœ€è¦æ¥å…¥äº’è”ç½‘çš„å®ä½“è®¾å¤‡</li>
</ol>
</li>
<li>ç³»ç»Ÿæ¦‚å¿µ: ä¸ç³»ç»Ÿç»„ä»¶ç›¸å…³, é€šè¿‡ç³»ç»Ÿç»„ä»¶æ¥æ¥å…¥çš„æ•°æ®çš„ç»„ä»¶<ol>
<li>ä»£ç†(agent): è·å–è®¾å¤‡ä¿¡æ¯å’Œæ§åˆ¶è®¾å¤‡çš„ä»£ç†</li>
<li>è®¾å¤‡ç½‘å…³ä»£ç†(device-gateway-proxy): ä»£ç†device-gatewayéªŒè¯è®¾å¤‡, ä»£ç†è®¾å¤‡ä¸äº‘ç«¯é€šä¿¡</li>
<li>è®¾å¤‡ç½‘å…³(device-gateway): äº‘ç«¯è®¾å¤‡ç½‘å…³, ç®¡ç†è®¾å¤‡æ¥å…¥<br>æ•´ä¸ªç³»ç»Ÿå¯¹äºä¸åŒè§’è‰²çš„åˆ’åˆ†:</li>
<li>è¶…çº§ç®¡ç†å‘˜: å…·æœ‰ç³»ç»Ÿå·²ç»æ•°æ®çš„æ‰€æœ‰æƒé™</li>
<li>è®¾å¤‡ç®¡ç†å‘˜: è´Ÿè´£å°†è®¾å¤‡åŠ å…¥ç³»ç»Ÿ, æŸ¥çœ‹è®¾å¤‡çš„æ•°æ®, ä»¥åŠä»¥è®¾å¤‡ä¸ºç»´åº¦çš„æ•°æ®æƒé™åˆ†é…</li>
<li>æ•°æ®è¿è¥å‘˜: è´Ÿè´£ç‚¹ä½æ•°æ®çš„å¤šç»´åº¦ç®¡ç†(åŸºç¡€ç»´åº¦æ˜¯è®¾å¤‡), ä»¥ä¸šåŠ¡ä¸ºç»´åº¦çš„æ•°æ®æƒé™åˆ†é…</li>
<li>ç®—æ³•ç®¡ç†å‘˜: è´Ÿè´£ç®¡ç†å’Œè¿è¡Œç›¸åº”ç»´åº¦çš„ç®—æ³•(åŸºç¡€ç»´åº¦æ˜¯è®¾å¤‡), ä»¥åŠæ•°æ®çš„æŸ¥çœ‹æƒé™</li>
<li>æ™®é€šç”¨æˆ·æˆ–è€…ç¬¬ä¸‰æ–¹å¼€å‘è€…: è´Ÿè´£ç‚¹ä½æ•°æ®çš„å¤šç»´åº¦æŸ¥çœ‹(åŸºç¡€ç»´åº¦æ˜¯è®¾å¤‡)</li>
</ol>
</li>
</ul>
<h3 id="è®¾å¤‡è¿æ¥"><a href="#è®¾å¤‡è¿æ¥" class="headerlink" title="è®¾å¤‡è¿æ¥"></a>è®¾å¤‡è¿æ¥</h3><p>è®¾å¤‡çš„è¿æ¥åˆ†ä¸º2éƒ¨åˆ†äº‘ç«¯å’Œæœ¬åœ°2éƒ¨åˆ†æ„æˆ, ç”±äºäº‘ç«¯å’Œæœ¬åœ°ç½‘ç»œçš„å·®å¼‚, éœ€è¦è€ƒè™‘:</p>
<ul>
<li>ç½‘ç»œçš„å®‰å…¨</li>
<li>ç½‘ç»œçš„ä¸ç¨³å®š<br>ä¸ºäº†æ–¹ä¾¿æœ¬åœ°è®¾å¤‡ä¸äº‘ç«¯ç›¸è¿, éœ€è¦çº¦å®šä¸€ä¸ªåè®®, å› æ­¤éœ€è¦è€ƒè™‘:</li>
<li>é€šä¿¡åè®®çš„å¤šé€‚é…: æ¯”å¦‚MQTT, HTTP, CoAPç­‰</li>
<li>æ•°æ®æ ¼å¼å®šä¹‰<br>ç”±äºæœ¬åœ°ç½‘ç»œçš„å¤æ‚å¤šå˜æ€§, æˆ‘ä»¬å¯èƒ½éœ€è¦é¢å¯¹ä¸åŒçš„åœºæ™¯:</li>
<li>è®¾å¤‡èƒ½ç›´æ¥è”ç½‘ä¸ŠæŠ¥æ•°æ®</li>
<li>è®¾å¤‡æ— æ³•è”ç½‘, éœ€è¦å°†æ•°æ®å‘ç”Ÿç»™æœ¬åœ°ä¸€ä¸ªç½‘å…³ä»£ç†, ç”±ç½‘å…³ä»£ç†ç»Ÿä¸€ä¸ŠæŠ¥æ•°æ®<br>è®¾å¤‡è¿æ¥çš„ä¸€ä¸ªæ¶æ„ç¤ºæ„å›¾:<br><img src="http://oiw1gzfww.bkt.clouddn.com/local_agent_arch.png" alt="è®¾å¤‡è¿æ¥"></li>
</ul>
<h4 id="æœ¬åœ°"><a href="#æœ¬åœ°" class="headerlink" title="æœ¬åœ°"></a>æœ¬åœ°</h4><p>æœ¬åœ°ä¼šè´Ÿè´£è®¾å¤‡æ•°æ®çš„é‡‡é›†ä¸ŠæŠ¥ä»¥åŠæ§åˆ¶, è¿™äº›åŠŸèƒ½ç”±ä¸€ä¸ªagentè´Ÿè´£å®Œæˆ, å®ƒåŠŸèƒ½æ–¹å‘å¦‚ä¸‹:</p>
<ul>
<li>æ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥: é…ç½®äº‘ç«¯å‡­è¯, æŒ‰ç…§çº¦å®šåè®®ä¸ŠæŠ¥è®¾å¤‡æ•°æ®ã€‚</li>
<li>æ¥æ”¶äº‘ç«¯æ§åˆ¶: å‘äº‘ç«¯æ±‡æŠ¥æ§åˆ¶æŒ‡ä»¤, æ¥æ”¶äº‘ç«¯å‘èµ·çš„æ§åˆ¶,ä»¥åŠè¿”å›æ‰§è¡Œç»“æœã€‚</li>
</ul>
<h5 id="è®¾å¤‡ä»£ç†-agent"><a href="#è®¾å¤‡ä»£ç†-agent" class="headerlink" title="è®¾å¤‡ä»£ç†(agent)"></a>è®¾å¤‡ä»£ç†(agent)</h5><p>è®¾å¤‡ä»£ç†è´Ÿè´£æ”¶é›†è®¾å¤‡çš„æ•°æ®, ç„¶åä¸ŠæŠ¥ç»™äº‘ç«¯ç½‘å…³, agentä½äºæ•°æ®ç¬¬ä¸€çº¿, éœ€è¦è€ƒè™‘è‰¯å¥½çš„æ‰©å±•æ€§, å› æ­¤é€‚åˆé‡‡ç”¨ æ’ä»¶å¼ é©±åŠ¨å¼€å‘æ¨¡å¼ã€‚<br>é‡‡é›†å™¨éœ€è¦ä»äº‘ç«¯è·å–è¯ä¹¦, é…ç½®äº‘ç«¯è®¾å¤‡ç¼–å·, ç„¶åæŒ‰ç…§æŒ‡å®šçš„æŠ¥æ–‡æ ¼å¼ å°†æ•°æ®ä¸ŠæŠ¥ç»™äº‘ç«¯ã€‚æ¯”å¦‚äº‘ç«¯è§„èŒƒçš„æ•°æ®ä¸ŠæŠ¥æ ¼å¼,ä»¥influxDBçš„æ•°æ®å†™å…¥æ ¼å¼ä¸ºä¾‹è¯´æ˜:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">measurement[,tag_key1=tag_value1...] field_key=field_value[,field_key2=field_value2] [timestamp]</div><div class="line"></div><div class="line">1. ä¸€ç±»è®¾å¤‡ä¸€ä¸ªåº“, æ¯”å¦‚è½¦, æ¯”å¦‚é£æœº, ä¸€ä¸ªåº“é‡Œé¢å­˜æ”¾æ‰€æœ‰è¿™ç±»è®¾å¤‡çš„æŒ‡æ ‡, ä¸€ç»„ç›¸å…³çš„æŒ‡æ ‡ä¸€ä¸ªç»„, æ¯”å¦‚å˜é€Ÿå™¨, é½¿è½®ç®±, ç®—æ³•è®¡ç®—çš„å¹³å‡é£é€Ÿ</div><div class="line">2. æ‰€æœ‰ä¸æ•°æ®æ— å…³çš„æ•°æ® å‡ä»¥æ ‡ç­¾çš„æ–¹å¼å½•å…¥, è¿™äº›Tagåˆ†ä¸º2ç±»: 1.ç³»ç»Ÿæ ‡ç­¾: device-id, collector-id 2. ç”¨æˆ·è‡ªå®šä¹‰æ ‡ç­¾</div></pre></td></tr></table></figure></p>
<p>agentæ ¸å¿ƒåŠŸèƒ½ç‚¹æ¦‚è¿°:</p>
<ul>
<li>æ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥<ol>
<li>æ•°æ®é‡‡é›†: ä»¥æ’ä»¶çš„å½¢å¼, æ”¯æŒå¤šåè®®é€‚é…,  é»˜è®¤æƒ…å†µä¸‹ åªè¦æ•°æ®ç¬¦åˆè§„èŒƒ å°±å¯ä»¥ä¸ŠæŠ¥</li>
<li>æ•°æ®å¤„ç†: å¦‚ä½•æ•°æ®ä¸ç¬¦åˆè§„èŒƒ, éœ€è¦ç¼–å†™ æ•°æ®å¤„ç†æ’ä»¶, å¤„ç†æˆåˆæ³•è§„åˆ™</li>
<li>èšåˆæ•°æ®: å¦‚æœæ•°æ®é‡è¿‡å¤§, å¯ä»¥ç¼–å†™èšåˆæ’ä»¶, å¯¹æ•°æ®è¿›è¡Œèšåˆ, æ¯”å¦‚é’ˆå¯¹è®¾å¤‡éœ‡é¢‘æ•°æ®ã€‚</li>
<li>æ•°æ®ä¸ŠæŠ¥: ç»å†æ‰€æœ‰ä»¥ä¸Šæ­¥éª¤è¿‡å, å°†æ•°æ®é€šè¿‡è®¾å¤‡çš„æ•°æ®ä¸ŠæŠ¥ç®¡é“ä¸ŠæŠ¥äº‘ç«¯</li>
</ol>
</li>
<li>è®¾å¤‡æ§åˆ¶:<ol>
<li>æ§åˆ¶æŒ‡ä»¤ä¸ŠæŠ¥: agentå¯åŠ¨æ—¶éœ€è¦å°† å·²ç»å®ç°çš„æ§åˆ¶æŒ‡ä»¤é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“å‘äº‘ç«¯æ±‡æŠ¥ã€‚</li>
<li>æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤: agentè®¢é˜…æ§åˆ¶ä¸‹å‘ç®¡é“, å½“æœ‰å‘½ä»¤åˆ°æ¥æ—¶, ç«‹é©¬æ‰§è¡Œ, å¹¶ä¸”å°†ç»“æœå†™å›æ§åˆ¶ä¸Šä¼ ç®¡é“ã€‚</li>
</ol>
</li>
<li>å¼‚å¸¸å¤„ç†:<ol>
<li>è®¾å¤‡ä¸‹çº¿å¼‚å¸¸: ç”±äºè®¾å¤‡ä¸‹çº¿æ— æ³•å’Œè®¾å¤‡å»ºç«‹è¿æ¥, æ— æ³•é‡‡é›†æ•°æ®(DeviceOffLineError), é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ä¸ŠæŠ¥</li>
<li>ç‚¹ä½é‡‡é›†å¼‚å¸¸: ç”±äºè®¾å¤‡æ²¡æœ‰è¯¥ç‚¹ä½, æ— æ³•è·å–åˆ°è¯¥ç‚¹ä½æ•°æ®(NoPointError), é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ä¸ŠæŠ¥</li>
</ol>
</li>
<li>agentæ§åˆ¶:<ol>
<li>ä»£ç†é…ç½®: é€šè¿‡æ§åˆ¶ä¸‹å‘é€šé“, ä¸‹å‘ä»£ç†é…ç½®.</li>
<li>ä»£ç†é‡å¯: é€šè¿‡æ§åˆ¶ä¸‹å‘é€šé“, å¾—çŸ¥ä»£ç†é‡æ–°é€šçŸ¥, é‡å¯ä»£ç†.</li>
<li>çŠ¶æ€ä¸ŠæŠ¥: é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“, æ±‡æŠ¥ä»£ç†çŠ¶æ€</li>
</ol>
</li>
<li>agentå¼‚å¸¸:<ol>
<li>ä»£ç†è¿è¡Œå¼‚å¸¸: ä»£ç†å¼‚å¸¸ä¸‹çº¿åŠæ—¶é€šçŸ¥äº‘ç«¯(AgentRuntimeError)</li>
</ol>
</li>
</ul>
<h5 id="ç½‘å…³ä»£ç†-device-gateway-proxy"><a href="#ç½‘å…³ä»£ç†-device-gateway-proxy" class="headerlink" title="ç½‘å…³ä»£ç†(device-gateway-proxy)"></a>ç½‘å…³ä»£ç†(device-gateway-proxy)</h5><p>ç½‘å…³ä»£ç†ä¸»è¦è¿ç”¨äºä»£ç†æ— æ³•è®¿é—®å…¬ç½‘çš„åœºæ™¯(æœ‰ç«å¢™), å®ƒåœ¨æœ¬åœ°ç½‘ç»œä¸­æ‰®æ¼”ç€äº‘ç«¯ç½‘å…³çš„è§’è‰², æ§åˆ¶ç€æ‰€æœ‰è®¾å¤‡çš„è¿æ¥, å› ä¸ºä»–æ˜¯ä»£ç†, æ‰€æœ‰ç›¸å…³æ§åˆ¶ä¿¡æ¯å‡ä»äº‘ç«¯ç½‘å…³è·å–ã€‚<br>ç½‘å…³ä»£ç†åœ¨è®¾è®¡æ—¶éœ€è¦æ»¡è¶³å¦‚ä¸‹åŸåˆ™:</p>
<ul>
<li>é€æ˜æ€§: å¯¹äºäº‘ç«¯æ¥è¯´, ä¸èƒ½å› ä¸ºä»£ç†è€Œå¸¦æ¥è®¾å¤‡å¤„ç†çš„å·®å¼‚æ€§, å› æ­¤ä»£ç†ä¸»è¦åŠŸèƒ½æ˜¯ä»£ç†è®¾å¤‡ ä¸ äº‘ç«¯é€šä¿¡, å¯¹äºäº‘ç½‘å…³æ¥è¯´ çœ‹åˆ°çš„ä¾ç„¶æ˜¯è®¾å¤‡,è€Œä¸æ˜¯ä»£ç†ã€‚</li>
<li>ç¼“å­˜æ€§: ä»£ç†éœ€è¦é¢ä¸´ç½‘ç»œä¸­æ–­,æ‰€ä»¥éœ€è¦æœ‰æ•°æ®ç¼“å­˜æœºåˆ¶, å¹¶ä¸”å¯ä»¥é…ç½®å­˜å‚¨ç­–ç•¥ã€‚<br>ä»¥ä¸‹æ˜¯gateway-proxyçš„æ ¸å¿ƒåŠŸèƒ½æ¦‚è¿°:</li>
<li>æ•°æ®ä¸ŠæŠ¥:<ol>
<li>æ£€æŸ¥è®¾å¤‡åˆæ³•æ€§: ç½‘å…³ä»£ç†èƒ½ä»£ç†é‚£äº›è®¾å¤‡å»ºç«‹è¿æ¥ éœ€è¦ä»äº‘ç«¯ç½‘å…³è·å–, å¦‚æœè®¾å¤‡ä¸åˆæ³•, åˆ™æ‹’ç»ä¸ºè¯¥è®¾å¤‡å»ºç«‹è¿æ¥ã€‚</li>
<li>æ•°æ®ä¸ŠæŠ¥: ç½‘å…³ä»£ç†æ¨¡æ‹Ÿagentä¸çœŸæ­£çš„ç½‘å…³å»ºç«‹è¿æ¥, é€šè¿‡è®¾å¤‡æ•°æ®ä¸ŠæŠ¥é€šé“ä¸ŠæŠ¥æ•°æ®åˆ°äº‘ç«¯ã€‚ </li>
</ol>
</li>
<li>è®¾å¤‡æ§åˆ¶:<ol>
<li>æ§åˆ¶æŒ‡ä»¤ä¸ŠæŠ¥: ä»£ç†è®¾å¤‡å»ºç«‹æ§åˆ¶ä¸Šä¼ é€šé“, ä¸ŠæŠ¥æ§åˆ¶æŒ‡ä»¤åˆ°äº‘ç«¯ã€‚</li>
<li>æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤: ä»£ç†è®¾å¤‡æ¥æ”¶æ§åˆ¶ä¸‹å‘é€šé“é‡Œé¢çš„ æ§åˆ¶æŒ‡ä»¤, è°ƒåº¦ç»™agentæ‰§è¡Œ, å°†ç»“æœè¿”å›åˆ°æ§åˆ¶ä¸Šå»é€šé“ã€‚</li>
</ol>
</li>
<li>å¼‚å¸¸å¤„ç†:<ol>
<li>è®¾å¤‡ä¸‹çº¿å¼‚å¸¸: ç”±äºè®¾å¤‡ä¸‹çº¿æ— æ³•å’Œè®¾å¤‡å»ºç«‹è¿æ¥, æ— æ³•é‡‡é›†æ•°æ®(DeviceOffLineError), é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ä¸ŠæŠ¥</li>
<li>ç‚¹ä½é‡‡é›†å¼‚å¸¸: ç”±äºè®¾å¤‡æ²¡æœ‰è¯¥ç‚¹ä½, æ— æ³•è·å–åˆ°è¯¥ç‚¹ä½æ•°æ®(NoPointError), é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ä¸ŠæŠ¥</li>
</ol>
</li>
<li>ç½‘å…³ä»£ç†æ§åˆ¶:<ol>
<li>proxyé…ç½®: é€šè¿‡proxyçš„æ§åˆ¶ä¸Šä¼ é€šé“ è¯·æ±‚ proxyçš„é…ç½®ä¿¡æ¯, é…ç½®proxyéœ€è¦ä»£ç†çš„è®¾å¤‡åˆ—è¡¨</li>
<li>proxyä»å¯: é€šè¿‡proxyçš„æ§åˆ¶ä¸‹å‘é€šé“ æ‰§è¡Œäº‘ç«¯å¯¹proxyçš„æ“ä½œ</li>
<li>proxyçŠ¶æ€ä¸ŠæŠ¥: proxyé€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ ä¸ŠæŠ¥è‡ªèº«çŠ¶æ€</li>
<li>agentçŠ¶æ€ä»£ç†ä¸ŠæŠ¥: proxyä»£ç†agent ä¸ŠæŠ¥çŠ¶æ€(proxyæ§åˆ¶ä¸Šä¼ é€šé“)</li>
<li>agentå¼‚å¸¸ä»£ç†ä¸ŠæŠ¥: proxyä»£ç†agent ä¸ŠæŠ¥å¼‚å¸¸(proxyæ§åˆ¶ä¸Šä¼ é€šé“)</li>
</ol>
</li>
<li>ç½‘å…³ä»£ç†å¼‚å¸¸:<ol>
<li>proxyè¿è¡Œå¼‚å¸¸: åŠæ—¶å‘äº‘ç«¯ä¸ŠæŠ¥(ProxyRuntimeError), é€šè¿‡proxyæ§åˆ¶ä¸Šä¼ é€šé“</li>
</ol>
</li>
</ul>
<h4 id="äº‘ç«¯-device-gateway"><a href="#äº‘ç«¯-device-gateway" class="headerlink" title="äº‘ç«¯(device-gateway)"></a>äº‘ç«¯(device-gateway)</h4><p>äº‘ç«¯è´Ÿè´£è®¾å¤‡çš„è¿æ¥çš„ç»„ä»¶æˆ‘ä»¬ç§°ä¹‹ä¸ºè®¾å¤‡ç½‘å…³(device-gateway), å®ƒè´Ÿè´£æ¥æ”¶è®¾å¤‡ä¸Šä¼ çš„æ•°æ®ä¸è®¾å¤‡çš„æ§åˆ¶ã€‚<br>è®¾å¤‡ç½‘å…³åœ¨è®¾è®¡æ—¶éœ€è¦æ»¡è¶³å¦‚ä¸‹åŸåˆ™:</p>
<ul>
<li>æ•°æ®å®‰å…¨: ä¸ºäº†ç¡®ä¿ç½‘å…³å’Œæ•°æ®ä¸ŠæŠ¥è€…ä¹‹é—´è¿™æ®µå…¬ç½‘æ•°æ®é“¾è·¯çš„å®‰å…¨, éœ€é‡‡ç”¨TLSè¿›è¡ŒåŠ å¯†å’ŒåŒå‘è®¤è¯ã€‚ æ•°æ®ç½‘å…³éœ€å……å½“CAçš„è§’è‰², å‘agentæˆ–è€…é¢å‘æ•°å­—è¯ä¹¦ </li>
<li>æ¥å…¥è®¾å¤‡èµ„äº§çš„ç®¡ç†</li>
<li>æ•°æ®å­˜å‚¨: åœ¨æ•°æ®å­˜å…¥æ•°æ®åº“ä¹‹å‰,è¿™äº›æ•°æ®è¢«ç§°ä¸ºäº‹ä»¶, æ•°æ®è¢«å­˜å‚¨ä¹‹åæˆä¸ºå†å²æ•°æ®, äº‹ä»¶å’Œå†å²æ•°æ®åˆ†åˆ«å¯¹åº”ä¸åŒçš„åœºæ™¯<br>device-gatewayçš„æ§åˆ¶å±‚åŠŸèƒ½æ¦‚è¿°:</li>
<li>ç±»å‹ç®¡ç†:<br>è¿æ¥ä¸Šäº‘ç«¯çš„è®¾å¤‡å¿…é¡»è¦æŒ‡æ˜è®¾å¤‡çš„ç±»å‹, è®¾å¤‡ç±»å‹ç”¨äºæ ¡éªŒ è®¾å¤‡ä¸Šä¼ çš„æ•°æ® æ˜¯å¦åˆè§„, å¦‚æœä¸åˆè§„,å°±ä¸¢å¼ƒæ‰, ä½†æ˜¯éœ€è¦è®°å½•æ—¥å¿—, è®©ç”¨æˆ·å¯ä»¥æŸ¥çœ‹<br>ç±»å‹çš„å®šä¹‰ä»¥Jsonä¸ºä¸», éœ€è¦å®šä¹‰ å±æ€§åç§°(å­—æ®µåç§°), å­—æ®µçš„å€¼çš„æ•°æ®ç±»å‹, ä»¥åŠå…¶ä»–å­—æ®µçš„ç›¸å…³ä¿¡æ¯ã€‚<ol>
<li>ç±»å‹çš„å¢åˆ æ”¹æŸ¥</li>
</ol>
</li>
<li>è®¾å¤‡ç®¡ç†<ol>
<li>è®¾å¤‡åˆ›å»º: å¿…é¡»å‚æ•°å‚æ•°: è®¾å¤‡åç§°, æ¥å…¥æ–¹å¼(é€šè¿‡agentæ¥å…¥è¿˜æ˜¯é€šè¿‡proxyæ¥å…¥), è®¾å¤‡ç±»å‹(å…ˆå®šä¹‰ç±»å‹)  å¯é€‰å‚æ•°: åœ°ç†ä½ç½®, è®¾å¤‡æ ‡ç­¾, å…¶ä»–å±æ€§,<br>çœŸæ­£åˆ›å»ºæ—¶æˆ‘ä»¬éœ€è¦è€ƒè™‘:<ol>
<li>é…é¢æ£€æŸ¥(é™åˆ¶ä¸€ä¸ªç”¨æˆ·å¯ä»¥åˆ›å»ºçš„è®¾å¤‡æ•°)</li>
<li>å¦‚æœé€šè¿‡agentæ¥å…¥, ä¸ºagenté¢å‘è®¾å¤‡æ¥å…¥è¯ä¹¦å’Œç§é’¥</li>
<li>ç”Ÿæˆæ¥å…¥äº‘ç«¯çš„ç”¨æˆ·å’Œå¯†ç </li>
<li>é…ç½®è®¾å¤‡å’Œäº‘ç«¯é€šä¿¡çš„é€šé“</li>
<li>äº‘ç«¯è®¢é˜…è¿™äº›é€šé“, ç­‰å¾…æ•°æ®ä¸ŠæŠ¥æˆ–è€…æ¥è‡ªagentçš„è¯·æ±‚</li>
</ol>
</li>
<li>æŸ¥çœ‹è®¾å¤‡:<br>è®¾å¤‡åˆ›å»ºæˆåŠŸè¿‡åç”¨æˆ·å¯ä»¥æŸ¥çœ‹åˆ°:<ol>
<li>è®¾å¤‡çš„åŸºæœ¬ä¿¡æ¯, æ¯”å¦‚åç§°, ID, æ¥å…¥æ–¹å¼, åœ°ç†ä½ç½®, åˆ›å»ºæ—¶é—´</li>
<li>è®¾å¤‡æ ‡ç­¾ä¿¡æ¯, è¿™æ˜¯ç®€å•çš„èµ„äº§, ç”¨äºé€šè¿‡æ ‡ç­¾åˆ†ç±»è®¾å¤‡, ç®€å•çš„èµ„äº§åˆ†ç±»ç®¡ç†</li>
<li>è®¾å¤‡é€šé“ä¿¡æ¯, æ•°æ®ä¸ŠæŠ¥é€šé“å’Œè®¾å¤‡æ§åˆ¶é€šé“çš„åç§°</li>
<li>æ¥å…¥ä¿¡æ¯, æ¥å…¥äº‘ç«¯çš„ç”¨æˆ·åå’Œå¯†ç </li>
<li>è®¾å¤‡çŠ¶æ€ä¿¡æ¯, è®¾å¤‡æ˜¯å¦ä¸‹çº¿, èƒ½å¦å’Œè®¾å¤‡é€šä¿¡</li>
<li>agentçŠ¶æ€ä¿¡æ¯, agentæ˜¯å¦è¿è¡Œ</li>
<li>å¦‚æœæ˜¯é€šè¿‡proxyæ¥å…¥, æ˜¾ç¤ºproxyåç§°å’ŒçŠ¶æ€ä¿¡æ¯</li>
</ol>
</li>
<li>ä¿®æ”¹è®¾å¤‡:<br>  æä¾›è®¾å¤‡åŸºæœ¬ä¿¡æ¯çš„ä¿®æ”¹:<ol>
<li>è®¾å¤‡åç§°, æ¥å…¥æ–¹å¼, åœ°ç†ä½ç½®, ä»¥åŠå…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰å±æ€§çš„ä¿®æ”¹</li>
</ol>
</li>
<li>ç¦ç”¨è®¾å¤‡:<br>  ç¦ç”¨è®¾å¤‡å, å°†ç¦æ­¢è®¾å¤‡ä¸äº‘ç«¯å»ºç«‹è¿æ¥:<ol>
<li>å¦‚æœæ˜¯agentæ¥å…¥, å‰”é™¤è¯¥agentçš„å›è¯, å¹¶ç¦æ­¢è¯¥è®¾å¤‡ ä¸äº‘ç«¯å»ºç«‹è¿æ¥</li>
<li>å¦‚æœæ˜¯proxyæ¥å…¥, é€šçŸ¥proxy, åœæ­¢ä¸ºè¯¥è®¾å¤‡å»ºç«‹ä¸äº‘ç«¯çš„è¿æ¥</li>
</ol>
</li>
<li>å¯ç”¨è®¾å¤‡:<br>  å¯ç”¨è®¾å¤‡å, æ¢å¤å…è®¸è®¾å¤‡ä¸äº‘ç«¯å»ºç«‹è¿æ¥:<ol>
<li>å¦‚æœæ˜¯agentæ¥å…¥, æ’¤é”€è®¾å¤‡ç¦æ­¢æ¥å…¥äº‘ç«¯çš„æ§åˆ¶</li>
<li>å¦‚æœæ˜¯proxyæ¥å…¥, é€šçŸ¥proxy, é‡æ–°ä¸ºè¯¥è®¾å¤‡å»ºç«‹ä¸äº‘ç«¯çš„è¿æ¥</li>
</ol>
</li>
<li>åˆ é™¤è®¾å¤‡:<br>  åˆ é™¤è®¾å¤‡å, ä¸è®¾å¤‡ç›¸å…³çš„æ‰€æœ‰è¿æ¥éƒ½å°†æ–­å¼€, è¯¥è®¾å¤‡ä»æ­¤ä»¥åå°†æ— æ³•ä¸äº‘ç«¯å»ºç«‹è¿æ¥<ol>
<li>å–æ¶ˆè¯¥è®¾å¤‡é€šé“çš„æ‰€æœ‰å¤„ç†</li>
<li>æ¸…é™¤æ¥å…¥ç”¨æˆ·ä¿¡æ¯, ç”¨æˆ·æ— æ³•å’Œäº‘ç«¯å»ºç«‹è¿æ¥</li>
<li>å¦‚æœæ˜¯proxyæ¥å…¥, é€šçŸ¥ä»£ç† è¯¥è®¾å¤‡å·²ç»åˆ é™¤, æ›´æ–°ä»£ç†åˆ—è¡¨, åœæ­¢ä¸ºè¯¥è®¾å¤‡ä»£ç†</li>
<li>æ¸…é™¤è®¾å¤‡ç›¸å…³å…ƒæ•°æ®</li>
</ol>
</li>
<li>è®¾å¤‡é…é¢ç®¡ç†:<br>  é™åˆ¶ç”¨æˆ·å¯ä»¥åˆ›å»ºçš„è®¾å¤‡æ•°é‡<ol>
<li>æŸ¥è¯¢é…ç½®:</li>
<li>ä¿®æ”¹é…é¢: ç”±ç®¡ç†å‘˜ä¿®æ”¹é…é¢</li>
</ol>
</li>
<li>è®¾å¤‡æ ‡ç­¾ç®¡ç†:<br>  åŸºäºæ ‡ç­¾çš„èµ„äº§ç®¡ç†<ol>
<li>æ ‡ç­¾çš„åˆ›å»º,æŸ¥çœ‹,ä¿®æ”¹,åˆ é™¤</li>
<li>ä¸ºè®¾å¤‡æ·»åŠ æ ‡ç­¾</li>
<li>ç§»é™¤è®¾å¤‡çš„æ ‡ç­¾</li>
</ol>
</li>
<li>è®¾å¤‡çŠ¶æ€å½±å­:<ol>
<li>æŸ¥çœ‹è®¾å¤‡æœ€æ–°çŠ¶æ€, è®¾å¤‡æ•°æ®æ¥å…¥äº‘ç«¯æ—¶éœ€è¦é€šè¿‡ è®¾å¤‡ç±»å‹ æ£€æŸ¥è®¾å¤‡çš„ä¸ŠæŠ¥çš„æ•°æ®æ˜¯å¦åˆæ³•, å¹¶ä¸”ç»æœ€æ–°çŠ¶æ€ å½•å…¥, ç”¨æˆ·å¯ä»¥çœ‹åˆ°è¯¥è®¾å¤‡çš„ æœ€æ–°çŠ¶æ€æ•°æ®.</li>
</ol>
</li>
</ol>
</li>
<li>è®¾å¤‡çš„åå‘æ§åˆ¶:<ol>
<li>æ§åˆ¶æŒ‡ä»¤æŸ¥çœ‹<br>æ§åˆ¶æŒ‡ä»¤ç”±agentçš„æ§åˆ¶å™¨å®ç°, åœ¨agentå¯åŠ¨æ—¶ä¸ŠæŠ¥ç»™äº‘ç«¯:<ol>
<li>æ§åˆ¶æŒ‡ä»¤çš„åŸºæœ¬ä¿¡æ¯: æ§åˆ¶æŒ‡ä»¤çš„åç§°, åŠŸèƒ½è¯´æ˜, ä½¿ç”¨æ–¹å¼, é¢„æœŸç»“æœ, å¼‚å¸¸è¯´æ˜ã€‚</li>
<li>æ§åˆ¶æŒ‡ä»¤çš„ä¸ŠæŠ¥æ—¶é—´, æ‰§è¡Œæƒä½¿ç”¨è€…åˆ—è¡¨</li>
<li>æ§åˆ¶æŒ‡ä»¤çš„æ‰§è¡Œè®°å½•</li>
</ol>
</li>
<li>æ‰§è¡Œæƒåˆ†é…<br>å°†æ§åˆ¶æŒ‡ä»¤çš„æ‰§è¡Œæƒåˆ†é…ç»™æœ‰ä¸ªç”¨æˆ·, è¯¥ç”¨æˆ·å¯ä»¥æ‰§è¡Œè¯¥æ§åˆ¶æŒ‡ä»¤</li>
<li>æ‰§è¡Œæƒå›æ”¶<br>å°†æ§åˆ¶æŒ‡ä»¤çš„æ‰§è¡Œæƒå›æ”¶ã€‚ç”¨æˆ·å°†æ²¡æœ‰æ”¹æŒ‡ä»¤çš„æ‰§è¡Œæƒ</li>
<li>æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤<br>é»˜è®¤ä»…æœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤, æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤, å¾—åˆ°æ‰§è¡Œç»“æœ</li>
<li>ç¦ç”¨æ§åˆ¶æŒ‡ä»¤<br> ç”±ç®¡ç†å‘˜å†³å®šæ˜¯å¦ç¦ç”¨è¯¥æ§åˆ¶æŒ‡ä»¤</li>
<li>å¯ç”¨æ§åˆ¶æŒ‡ä»¤<br>ç”±ç®¡ç†å‘˜å†³å®šæ˜¯å¦å¯ç”¨è¯¥æ§åˆ¶æŒ‡ä»¤</li>
</ol>
</li>
<li>proxyç®¡ç†:<ol>
<li>åˆ›å»ºä»£ç†: å¿…é¡»å‚æ•°: ä»£ç†åç§°, å¯é€‰å‚æ•°: åœ°ç†ä½ç½®, å…¶ä»–åˆ›å»ºå±æ€§</li>
<li>æŸ¥çœ‹ä»£ç†:<ol>
<li>åç§°, åœ°ç†ä½ç½®, å…¶ä»–å±æ€§, åˆ›å»ºæ—¶é—´</li>
<li>ä»£ç†çŠ¶æ€: æœªæ¥å…¥, è¿è¡Œä¸­, ç¦ç”¨</li>
<li>ä»£ç†çš„ æ•°å­—ç­¾åè¯ä¹¦, CAè¯ä¹¦, ä»£ç†ç§é’¥</li>
<li>ä»£ç†è‡ªå·±ä½¿ç”¨çš„æ§åˆ¶é€šé“(ä»£ç†å’Œäº‘ç«¯é€šä¿¡çš„æ¥å£), å’Œå¼‚å¸¸ä¸ŠæŠ¥é€šé“</li>
</ol>
</li>
<li>ä¿®æ”¹ä»£ç†:<br>åç§°, åœ°ç†ä½ç½®, å…¶ä»–å±æ€§</li>
<li>åˆ é™¤ä»£ç†:<ol>
<li>ç¡®è®¤è¯¥ä»£ç†ä¸‹é¢æ²¡æœ‰è®¾å¤‡åæ–¹å¯ä»¥åˆ é™¤, ç§»é™¤åçš„è®¾å¤‡å±äºæ— ä¸ŠæŠ¥æ–¹å¼çš„è®¾å¤‡, </li>
<li>åŠé”€ä»£ç†çš„è¯ä¹¦</li>
<li>å‰”é™¤ä»£ç† çš„ä¸ŠæŠ¥å›è¯(éå¸¸å±é™©, å¦‚æœä»£ç†æ­£åœ¨ä¸ŠæŠ¥æ•°æ®)</li>
<li>æ¸…é™¤ä»£ç†ä¿¡æ¯</li>
</ol>
</li>
<li>ç¦ç”¨ä»£ç†: ç¦æ­¢è¯¥ä»£ç†å‘å¸ƒæ•°æ®åˆ°äº‘ç«¯(çš„æ•°æ®ç®¡é“)</li>
<li>å¯ç”¨ä»£ç†: ç¦æ­¢è¯¥ä»£ç†å‘å¸ƒæ•°æ®åˆ°äº‘ç«¯(çš„æ•°æ®ç®¡é“)</li>
<li>æŸ¥çœ‹ä»£ç†ä¸‹çš„è®¾å¤‡: åˆ—å‡ºè¯¥ä»£ç†ä¸‹é¢çš„è®¾å¤‡åˆ—è¡¨</li>
<li>æ·»åŠ è®¾å¤‡åˆ°è¯¥ä»£ç†ä¸‹é¢</li>
<li>ç§»é™¤è¯¥ä»£ç†ä¸‹é¢çš„è®¾å¤‡</li>
</ol>
</li>
</ul>
<p>device-gatewayåå°åŠŸèƒ½æ¦‚è¿°:</p>
<ul>
<li>æ•°æ®å­˜å‚¨<br>è´Ÿè´£å°†æ•°æ®å­˜å‚¨åˆ°åç«¯å­˜å‚¨<ol>
<li>çŠ¶æ€æ•°æ®å­˜å‚¨</li>
<li>çƒ­æ•°æ®å­˜å‚¨</li>
<li>å†å²æ•°æ®å­˜å‚¨</li>
</ol>
</li>
</ul>
<h3 id="æ•°æ®å¯è§†åŒ–ä¸è¿è¥-data-manager"><a href="#æ•°æ®å¯è§†åŒ–ä¸è¿è¥-data-manager" class="headerlink" title="æ•°æ®å¯è§†åŒ–ä¸è¿è¥(data-manager)"></a>æ•°æ®å¯è§†åŒ–ä¸è¿è¥(data-manager)</h3><p>ä¸»è¦è´Ÿè´£æ•°æ®çš„ç®¡ç†å’ŒæŸ¥çœ‹, æ•°æ®ä»¥ç±»å‹ç»„ç»‡åœ¨ä¸€èµ·, ä»¥ç‚¹ä½ä¸ºæ ¸å¿ƒ, ç”¨æˆ·é€šè¿‡ä¸ºè¿™äº› æ•°æ®æ·»åŠ æ ‡ç­¾ æ¥æ·»åŠ  æ•°æ®ç»´åº¦, æ–¹ä¾¿ä¸šåŠ¡ä½¿ç”¨ã€‚</p>
<ul>
<li>æ•°æ®åˆ†ç±»<br>æä¾›æ•°æ®çš„æŸ¥çœ‹ä¸è¿è¥ç®¡ç†, æ•°æ®ä»¥æŒ‡æ ‡çš„æ–¹å¼å­˜å‚¨, ç”¨æˆ·é€šè¿‡æ ‡ç­¾æ¥è¿è¥æ•°æ®ã€‚è¿è¥çš„æ•°æ®ä¸»è¦ç”±2ç±»æ„æˆ: </li>
</ul>
<ol>
<li>ç‰©ç†æŒ‡æ ‡æ•°æ®: é‡‡é›†ä¸Šæ¥çš„åŸå§‹æ•°æ®, ä»¥ç‚¹ä½çš„æœ€å°é€»è¾‘å•å…ƒä¸ºæŒ‡æ ‡,æ¯”å¦‚ é½¿è½®ç®±ç­‰ã€‚</li>
<li>åˆ†æè¿‡åçš„æŒ‡æ ‡æ•°æ®: ç»è¿‡åˆ†æè¿‡åçš„æ•°æ® ä»¥ç®—æ³•ä¸ºæŒ‡æ ‡, åˆ†ææ ¹æ®éœ€è¦ä¸ºè¿™äº›æ•°æ®æ‰“ç®—æ ‡ç­¾ã€‚(æ¯”å¦‚æ‰“ç®—è®¾å¤‡æ ‡ç­¾)</li>
</ol>
<ul>
<li>æ•°æ®æŸ¥çœ‹<br>æä¾›å¯¹æ•°æ®çš„åŸºæœ¬å±•ç°çš„æ”¯æŒ, ä½†ä¸æä¾›å¤§é‡åŸå§‹æ•°æ®çš„å¯¼å‡ºåŠŸèƒ½, å¤§é‡åŸå§‹æ•°æ®æ˜¯ç•™ç»™è®¡ç®—å¹³å°ä½¿ç”¨çš„, å¦‚éœ€å¯¼å‡ºè¯·ä½¿ç”¨å¯¼å‡ºå·¥å…·è¿›è¡Œå¯¼å‡ºã€‚</li>
</ul>
<ol>
<li>æ•°æ®æŸ¥è¯¢é…ç½®æŸ¥çœ‹: <ol>
<li>å†å²æ•°æ®åˆ†å±‚é…ç½®: 1. æŒ‰æ—¶é—´ä¸ºç»´åº¦è¿›è¡Œåˆ’åˆ†, é»˜è®¤ä¸º3ä¸ªæœˆ 2. æŒ‰å®¹é‡è¿›è¡Œåˆ’åˆ†, é»˜è®¤ä¸ºæœ€è¿‘1wæ¡æ•°æ®, é»˜è®¤æŒ‰è§„åˆ™1æ‰§è¡Œã€‚</li>
<li>çŠ¶æ€æ•°æ®æŸ¥è¯¢å®¹é‡é™åˆ¶: é»˜è®¤ä¸º1000æ¡æ•°æ®, åŠè®¾å¤‡ç‚¹ä½ä¸å¾—é»˜è®¤ä¸å¾—è¶…è¿‡1000</li>
<li>å†å²æ•°æ®æŸ¥è¯¢å®¹é‡é™åˆ¶: é»˜è®¤ä¸º100 * 100æ¡æ•°æ®, åŠè®¾å¤‡ç‚¹ä½ä¸èƒ½è¶…è¿‡100ä¸ªï¼Œæ¯ä¸ªç‚¹ä½çš„æ•°æ®ä¸å¾—è¶…è¿‡100æ¡</li>
</ol>
</li>
<li>æ•°æ®æŸ¥è¯¢é…ç½®ä¿®æ”¹: ä¿®æ”¹ä»¥ä¸Šé‚£äº›é»˜è®¤é…ç½®</li>
<li>æŸ¥è¯¢æ•°æ®: <ol>
<li>çŠ¶æ€æŸ¥è¯¢:  ä¹Ÿå°±æ˜¯å½“å‰æ¥å…¥äº‹ä»¶çš„æŸ¥è¯¢(ç”¨äºæŸ¥çœ‹å½“ä¸‹æ¥å…¥çš„æ•°æ®, ä¸èƒ½æŸ¥çœ‹å†å²æ•°æ®), å¦‚æœè®¾å¤‡æ¥å…¥å¼‚å¸¸ è¯·æ˜¾ç¤ºæ¥å…¥å¼‚å¸¸ä¿¡æ¯, ä»¥websocket è¿›è¡Œå®æ—¶æä¾›</li>
<li>å†å²æŸ¥è¯¢: ä¹Ÿå°±æ˜¯è¶‹åŠ¿æŸ¥è¯¢<ol>
<li>çƒ­æ•°æ®æŸ¥è¯¢:   å¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œéœ€è¦åˆ†ç»„è¿›è¡Œèšåˆ</li>
<li>å†·æ•°æ®æŸ¥è¯¢:   å¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œéœ€è¦åˆ†ç»„è¿›è¡Œèšåˆ</li>
</ol>
</li>
</ol>
</li>
</ol>
<ul>
<li>æ•°æ®æ ‡ç­¾ç®¡ç†<ol>
<li>æ•°æ®æ ‡ç­¾æŸ¥è¯¢, é»˜è®¤æ ‡ç­¾å±äºç³»ç»Ÿæ ‡ç­¾(æ¯”å¦‚æ•°æ®å±äºé‚£å°è®¾å¤‡, æ•°æ®æ˜¯ç”±é‚£ä¸ªé‡‡é›†å™¨é‡‡é›†ä¸Šæ¥çš„), ç¦æ­¢ä¿®æ”¹, ä¸ºåªè¯»çŠ¶æ€, å…¶ä»–æ˜¯ç”¨æˆ·ä¸ºæ•°æ® è¿›è¡Œçš„è‡ªå®šä¹‰æ ‡ç­¾</li>
<li>æ·»åŠ æ ‡ç­¾: ä¸ºæ•°æ® æ·»åŠ æ ‡ç­¾ï¼Œ æ ‡ç­¾æœ‰é•¿åº¦é™åˆ¶(æœ€é•¿ä¸å¾—è¶…è¿‡16ä¸ªå­—ç¬¦)</li>
<li>åˆ é™¤æ ‡ç­¾: åˆ é™¤æ ‡ç­¾,ä½†æ˜¯åˆ é™¤ä¹‹å‰ éœ€è¦ç¡®è®¤æ•°æ®æ˜¯å¦å·²ç»æˆæƒ, å¦‚æœå·²ç»æˆæƒåˆ†äº«, éœ€è¦æ’¤é”€åˆ†äº« æ‰èƒ½åˆ é™¤</li>
</ol>
</li>
<li>æ•°æ®æˆæƒ<br> ç”¨æˆ·æŒ‰ç…§è‡ªå·±çš„éœ€è¦ å°†æ•°æ®æ‰“ä¸Šæ ‡ç­¾, æˆ–è€…ä½¿ç”¨é»˜è®¤æ ‡ç­¾, å°†å¯¹åº”çš„æ•°æ® åˆ†æç»™å…¶ä»–ç”¨æˆ·è®¿é—®.<ol>
<li>æ•°æ®åˆ†äº«æŸ¥è¯¢: æŸ¥è¯¢é‚£äº›æ•°æ®,è¢«åˆ†æç»™äº†é‚£äº›ç”¨æˆ·</li>
<li>åˆ†äº«æƒé™æ’¤é”€: æ’¤é”€å·²ç»åˆ†æå‡ºå»çš„æ•°æ®æˆæƒ</li>
<li>æ•°æ®åˆ†äº«: æŒ‡å®šæŸäº›ç”¨æˆ·å¯ä»¥è®¿é—®é‚£äº›æ ‡ç­¾çš„æ•°æ®ã€‚</li>
</ol>
</li>
</ul>
<h3 id="æ•°æ®åˆ†æ"><a href="#æ•°æ®åˆ†æ" class="headerlink" title="æ•°æ®åˆ†æ"></a>æ•°æ®åˆ†æ</h3><p>æ•°æ®åˆ†æå›´ç»•ç®—æ³•å’Œä»»åŠ¡è¿›è¡Œå±•å¼€, å…³é”®çš„åœ¨äº ç®—æ³•çš„é«˜åº¦å¯å®šåˆ¶åŒ–, ç®—æ³•æµ‹è¯•, è¿è¡Œæ—¶æ£€æŸ¥, ä»¥åŠç®—æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ä»»åŠ¡çš„å¯è§†åŒ–ã€‚åŠŸèƒ½æ˜¯æ»¡è¶³é«˜çº§ç”¨æˆ· å¯¹äºæ•°æ®åˆ†æçš„éœ€æ±‚ã€‚ é€šè¿‡ç®—æ³•å¯¹æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æçš„åŠŸèƒ½ã€‚</p>
<ul>
<li>å®æ—¶è®¡ç®—</li>
<li>ç¦»çº¿è®¡ç®—(æŠ¥è¡¨ç»Ÿè®¡å’Œæ·±åº¦å­¦ä¹ , æ·±åº¦éœ€è¦ä¾èµ–å¤§é‡æ•°æ®è®­ç»ƒå‡ºæ¨¡å‹ï¼Œç„¶åé€šè¿‡æ¨¡å‹ åº”ç”¨åˆ°äº‹ä»¶åˆ†æ, è¾¾åˆ°æ™ºèƒ½åˆ†æçš„ç›®çš„)</li>
<li>æ··åˆè®¡ç®—: æ¯”å¦‚å…ˆä½¿ç”¨ç¦»çº¿è®¡ç®—è®­ç»ƒæ¨¡å‹, ç„¶åå°†æ¨¡å‹ åº”ç”¨åˆ°å®æ—¶è®¡ç®—, æˆ–è€…ä½¿ç”¨å®æ—¶è®¡ç®—ä½œä¸ºæµ‹è¯•æ•°æ®,ä»¥å†å²æ•°æ®ä½œä¸ºè®­ç»ƒæ•°æ® è¿›è¡Œäº¤å‰éªŒè¯,ä»¥ä¾¿è®­ç»ƒå‡†ç¡®çš„æ¨¡å‹ã€‚</li>
</ul>
<h4 id="ç®—æ³•ç®¡"><a href="#ç®—æ³•ç®¡" class="headerlink" title="ç®—æ³•ç®¡"></a>ç®—æ³•ç®¡</h4><p>ç®¡ç†ç®—æ³•æ–‡ä»¶, ç®—æ³•æ–‡ä»¶è¡¨ç°ä¸ºä¸€ä¸ªè„šæœ¬æ–‡ä»¶, å¯¹äºstorm å¹³å°è€Œå·², ç®—æ³•æ–‡ä»¶æ˜¯grooveè„šæœ¬, å¯¹äºspark å¹³å°è€Œè¨€, ç®—æ³•æ–‡ä»¶ å¯ä»¥æ˜¯sparkæ”¯æŒçš„å¤šç§è¯­è¨€çš„è„šæœ¬ã€‚</p>
<ul>
<li>ä¸Šä¼ ç®—æ³•: ä¸Šä¼ è„šæœ¬æ–‡ä»¶,  ç®—æ³•åç§°(é»˜è®¤æ˜¯ç®—æ³•æ–‡ä»¶çš„åç§°,å»æ‰åç¼€), ç®—æ³•æè¿°ä¿¡æ¯(åŒ…å«ç®—æ³•è¦è§£å†³çš„é—®é¢˜, è¾“å…¥å‚æ•°çš„è§£é‡Šå’Œè¾“å‡ºå‚æ•°çš„è§£é‡Š), ç®—æ³•è¿è¡Œå¹³å°()</li>
<li>ä¸‹è½½ç®—æ³•: ä¸‹è½½ç®—æ³•æ–‡ä»¶ã€‚</li>
<li>åˆ é™¤ç®—æ³•: åˆ é™¤ç®—æ³•æ–‡ä»¶.</li>
<li>æ›´æ–°ç®—æ³•å…ƒæ•°æ®: æ›´æ–°ç®—æ³•çš„åç§° æˆ–è€…ç®—æ³•çš„æè¿°ä¿¡æ¯</li>
<li>æŸ¥çœ‹ç®—æ³•: æŸ¥çœ‹æ‰€æœ‰ç®—æ³•ã€‚</li>
<li>ç®—æ³•è®¿é—®æˆæƒ: æˆæƒç®—æ³•ç»™æŸä¸ªç”¨æˆ·è®¿é—®ã€‚</li>
<li>ç®—æ³•æˆæƒæ’¤é”€: æ’¤é”€æŸä¸ªç”¨æˆ·è®¿é—®æŸä¸ªç®—æ³•çš„æƒé™ã€‚</li>
</ul>
<h4 id="ä»»åŠ¡æ‰§è¡Œ"><a href="#ä»»åŠ¡æ‰§è¡Œ" class="headerlink" title="ä»»åŠ¡æ‰§è¡Œ"></a>ä»»åŠ¡æ‰§è¡Œ</h4><p>ç®—æ³• è¿è¡Œæ—¶äº§ç”Ÿä¸€ä¸ªçœŸæ­£çš„ä»»åŠ¡, å› æ­¤è¿è¡Œç®—æ³• éœ€è¦æœ‰ä»¥ä¸‹è¿™äº›å‚æ•°:</p>
<ul>
<li>ç®—æ³•æ–‡ä»¶, é€šè¿‡æŒ‡å®šç®—æ³•æ–‡ä»¶çš„idæ¥å®Œæˆ</li>
<li>ç®—æ³•çš„è¾“å…¥å’Œè¾“å‡º:<ol>
<li>æ‰«æè·å–ç®—æ³•æ–‡ä»¶çš„ è¾“å…¥å’Œè¾“å‡ºå½¢å‚()</li>
<li>é€‰å®šè¾“å…¥æºçš„å½¢å‚å¯¹åº”çš„æ•°æ®, é€šè¿‡å»è¾“å…¥æº æŸ¥çœ‹å¾—å‡º, é€‰æ‹©è¾“å‡ºæº å¯¹åº”çš„åç§°ã€‚(å¯ä»¥æ£€æŸ¥è¾“å…¥æºæ˜¯å¦æœ‰æ•°æ®)</li>
</ol>
</li>
<li>æ‰§è¡Œå¹³å°, æ ¹æ®ç®—æ³•æ–‡ä»¶id, å¾—çŸ¥è¯¥ç®—æ³•è°ƒåº¦åˆ°é‚£ä¸ªå¹³å°ä¸Šè¿è¡Œ(jstrom, spark), å¦‚æœæ²¡æœ‰å¯¹åº”å¹³å°æ”¯æŒ,  åˆ™æŠ¥é”™</li>
</ul>
<h2 id="ç°æœ‰ç‰©è”ç½‘å¹³å°å‚è€ƒ"><a href="#ç°æœ‰ç‰©è”ç½‘å¹³å°å‚è€ƒ" class="headerlink" title="ç°æœ‰ç‰©è”ç½‘å¹³å°å‚è€ƒ"></a>ç°æœ‰ç‰©è”ç½‘å¹³å°å‚è€ƒ</h2><p><a href="http://www.cnblogs.com/kinging/category/881401.html" target="_blank" rel="external">å›½å†…å¤–ç‰©è”ç½‘å¹³å°æ¶æ„</a><br><a href="http://www.chengshiluntan.com/wg/a/20160907/503c29c323fd2d59999501e91099ecf7.html" target="_blank" rel="external">å¾®è½¯Azure IoT</a><br><a href="http://www.cnblogs.com/kinging/articles/5865116.html" target="_blank" rel="external">äºšé©¬é€ŠAWS IoT</a><br><a href="http://www.cnblogs.com/kinging/articles/5865139.html" target="_blank" rel="external">IBM Watson IOT</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘å¼€å‘äº†ä¸€æ¬¡IOTç»„ä»¶, åœ¨æ­¤æœŸé—´ä¹Ÿå‚è€ƒäº†ä¸‹å…¶ä»–IOTå¹³å°çš„è®¾è®¡æ¶æ„, æœ‰æ‰€æ„Ÿæƒ³, å› æ­¤å°†å…¶è®°å½•ä¸‹æ¥, å’Œå¤§å®¶åˆ†äº«, æ¬¢è¿äº¤æµã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="iot" scheme="https://blog.yumaojun.net/tags/iot/"/>
    
  </entry>
  
  <entry>
    <title>Pythonçš„mqttå®¢æˆ·ç«¯ä½¿ç”¨è¯´æ˜</title>
    <link href="https://blog.yumaojun.net/2017/07/04/mqtt-reconnect/"/>
    <id>https://blog.yumaojun.net/2017/07/04/mqtt-reconnect/</id>
    <published>2017-07-04T07:21:58.000Z</published>
    <updated>2017-08-08T03:16:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ä½¿ç”¨Pythonå†™ä¸€ä¸ªåå°æœåŠ¡å¤„ç†mqtté‡Œé¢çš„äº‹ä»¶æ—¶é‡åˆ°äº†ä¸€ä¸ªéº»çƒ¦: mqttè¿æ¥é‡ç½®æ—¶(é‡å¯mqttæœåŠ¡å), ä¹‹å‰pubæ¶ˆæ¯çš„çº¿ç¨‹ä¸èƒ½æ­£å¸¸å·¥ä½œäº†, ç»è¿‡å¤šæ¬¡è¸©å‘, ç»ˆäºè§£å†³. å¼•å‘é—®é¢˜çš„åŸå› æ˜¯æˆ‘ä½¿ç”¨å§¿åŠ¿ä¸å¯¹é€ æˆçš„, ä¸€æ—¦ä½ ä½¿ç”¨å§¿åŠ¿ä¸å¯¹ ä¼šé€ æˆä¸€äº›å¥‡æ€ªçš„é—®é¢˜,å¹¶ä¸”å¾ˆéš¾è§£å†³ã€‚ å› æ­¤è¯·æ­£ç¡®ä½¿ç”¨mqttã€‚<br><a id="more"></a></p>
<h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>å…³äºMQTTåè®®çš„ä»‹ç»è¯·å‚è€ƒä¹‹å‰åšå®¢: <a href="/2017/07/02/mqtt-introduce/" title="ç‰©è”ç½‘ä¹‹MQTT">ç‰©è”ç½‘ä¹‹MQTT</a>, åªæœ‰åœ¨äº†è§£MQTTåè®®è¿‡å, æˆ‘ä»¬æ‰èƒ½ä»¥æ­£ç¡®çš„å§¿åŠ¿ä½¿ç”¨å¥¹, ä»¥ä¸‹æ˜¯æˆ‘è§‰å¾—éœ€è¦æ³¨æ„çš„åœ°æ–¹:</p>
<ul>
<li>æŒ‰éœ€ä½¿ç”¨MQTTçš„Qos, å½“Qos=2æ—¶å¯é æ€§æœ€é«˜, ä½†æ˜¯ä¼šæŸå¤±æ€§èƒ½ã€‚</li>
<li>å°½é‡ä½¿ç”¨<code>client_id</code>æ¥æ ‡ç¤ºå®¢æˆ·ç«¯, ä½†æ˜¯æ³¨æ„ å¦‚æœ2ä¸ªå®¢æˆ·ç«¯ä½¿ç”¨åŒä¸€ä¸ª<code>client_id</code>, ä¼šå‡ºç°clientäº‰æŠ¢è¿æ¥çš„çŠ¶æ€, æ‰€ä»¥å…¨å±€æŒæœ‰ä¸€ä¸ªclientæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</li>
<li>æ³¨æ„å¼‚æ­¥å¤„ç†, åœ¨å›è°ƒå‡½æ•°ä¸­ä¸èƒ½é˜»å¡ã€‚</li>
<li>å°†æ‰€æœ‰æ•°æ®å¤„ç†é€»è¾‘æ”¾åˆ°å›è°ƒå‡½æ•°é‡Œé¢, é˜²æ­¢é“¾æ¥é‡ç½®æ—¶ï¼Œæ¼æ‰å¤„ç†é€»</li>
<li>åœ¨on_messageçš„å›è°ƒé‡Œé¢ å¤„ç†æ‰€æœ‰çš„è®¢é˜…æ¶ˆæ¯</li>
<li>æ–­å¼€è¿æ¥æ—¶å°½é‡ä»æ–°è¿æ¥, é¿å…mqttç¦»çº¿å, é‡æ–°ä¸Šçº¿, é€ æˆæœåŠ¡è¿æ¥å¼‚å¸¸ã€‚(æ³¨æ„loopçš„è¿”å›, ä¿è¯loopç½‘ç»œäº‹ä»¶æŒç»­å¤„ç†ä¸­)</li>
</ul>
<h2 id="ç¯å¢ƒä»‹ç»"><a href="#ç¯å¢ƒä»‹ç»" class="headerlink" title="ç¯å¢ƒä»‹ç»"></a>ç¯å¢ƒä»‹ç»</h2><p>ä»‹ç»ä¸‹æˆ‘çš„æµ‹è¯•ç¯å¢ƒ:</p>
<ul>
<li>Python Version: 3.6</li>
<li>MQTT Server: emqttserver:2.2-rc1</li>
<li>MQTT Client: paho-mqtt: 1.3.0</li>
</ul>
<p>emqtt serverå®‰è£…å‚è€ƒ<a href="http://emqtt.io/docs/v2/install.html#install-via-docker-image" target="_blank" rel="external">emqtt dockerå®‰è£…</a><br>python mqttå®¢æˆ·ç«¯çš„å®‰è£…è¯·å‚è€ƒ<a href="https://github.com/eclipse/paho.mqtt.python" target="_blank" rel="external">Githubåœ°å€</a></p>
<h2 id="å®¢æˆ·ç«¯ä½¿ç”¨ä»‹ç»"><a href="#å®¢æˆ·ç«¯ä½¿ç”¨ä»‹ç»" class="headerlink" title="å®¢æˆ·ç«¯ä½¿ç”¨ä»‹ç»"></a>å®¢æˆ·ç«¯ä½¿ç”¨ä»‹ç»</h2><p>paho-mqttæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯ç±», æˆ‘ä»¬ä¸»è¦ä½¿ç”¨è¯¥ç±»æ¥å’Œmqttserverè¿›è¡Œäº¤äº’, é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨è¿™ä¸ªç±»å–ƒ: </p>
<ul>
<li>å»ºç«‹è¿æ¥: ä½¿ç”¨connect()/connect_async()æ¥é“¾æ¥åˆ°broker(mqtt server)</li>
<li>æ–­å¼€è¿æ¥: ä½¿ç”¨disconnect()æ–¹æ³•æ¥æ–­å¼€å’Œbroker(mqtt server)ä¹‹é—´çš„ç½‘ç»œè¿æ¥ã€‚</li>
<li>å¤„ç†ç½‘ç»œäº‹ä»¶: è¯·é¢‘ç¹è°ƒç”¨loop()æ¥ç»´æŒå’Œbroker(mqtt server)ä¹‹é—´çš„ç½‘ç»œäº‹ä»¶ã€‚å¦‚æœä¸æƒ³è‡ªå·±é¢‘ç¹çš„è°ƒç”¨loopæ¥ç»´æŠ¤ç½‘ç»œäº‹ä»¶, å¯ä»¥ä½¿ç”¨loop_forever()æ–¹æ³•æ¥å¤„ç†,è¯¥æ–¹æ³•ä¼šå¸®ä½ å¾ªç¯è°ƒç”¨loop, å› æ­¤è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªé˜»å¡çš„æ–¹æ³•ã€‚å¦‚æœä¸æƒ³åœ¨ç¨‹åºé‡Œé¢é˜»å¡,å¯ä»¥ä½¿ç”¨loop_start()æ–¹æ³•,è¯¥æ–¹æ³•ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹åœ¨åå°æ‰§è¡Œloop_foreverã€‚</li>
<li>è®¢é˜…æ¶ˆæ¯: ä½¿ç”¨subscribe()æ–¹æ³•æ¥è®¢é˜…topicå’Œæ¥æ”¶æ•°æ®</li>
<li>å‘å¸ƒæ¶ˆæ¯: ä½¿ç”¨publish()æ–¹æ³•æ¥å‘å¸ƒæ¶ˆæ¯</li>
</ul>
<p>mqttçš„é€šä¿¡æ˜¯å¼‚æ­¥çš„, é€šè¿‡ç½‘ç»œäº‹ä»¶æ¥è¿›è¡Œå›è°ƒå¤„ç†, å› æ­¤æˆ‘ä»¬åŸºæœ¬é‡‡ç”¨å›è°ƒæ¥ç¼–ç¨‹, å›è°ƒå‡½æ•°çš„ç­¾åå¦‚ä¸‹, æ‰€æœ‰çš„å›è°ƒå‡½æ•°éƒ½2ä¸ªå›ºå®šå‚æ•°: </p>
<blockquote>
<ol>
<li>client: å›è°ƒæ—¶ä¼ é€’æ¥çš„å®¢æˆ·ç«¯å®ä¾‹ </li>
<li>userdata: userçš„ä»»ä½•ç±»å‹çš„æ•°æ®, å®ä¾‹åŒ–clientæ—¶ä¼ å…¥, ç”¨æˆ·è‡ªå·±ä½¿ç”¨ã€‚</li>
</ol>
</blockquote>
<h3 id="on-connect-client-userdata-flags-rc"><a href="#on-connect-client-userdata-flags-rc" class="headerlink" title="on_connect(client, userdata, flags, rc)"></a>on_connect(client, userdata, flags, rc)</h3><p>å½“brokerå“åº”äº†æˆ‘ä»¬é“¾æ¥ä¹‹åè°ƒç”¨, æ¶‰åŠåˆ°çš„å‚æ•°:</p>
<ul>
<li><p>flags: æ˜¯ä¸€ä¸ªå­—å…¸, åŒ…å«brokerè¿”å›çš„å“åº”æ ‡å¿—<br>ç°åœ¨åªæœ‰1ä¸­æ ‡å¿—: session present, é€šè¿‡flags[â€˜session presentâ€™]è·å–åˆ°è¯¥æ ‡å¿—é‡Œé¢çš„å†…å®¹, å½“clean sessionä¸º0æ—¶(clean_session=False), brokerä¼šä¿å­˜clientçš„çš„sessionä¿¡æ¯, è¯¥ä¿¡æ¯ä¼šåœ¨clienté‡æ–°ä¸Šçº¿æ—¶, é€šè¿‡session presentè¿™ä¸ªæ ‡å¿— è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
</li>
<li><p>rc: retrun code, è¿”å›çŠ¶æ€ç </p>
</li>
</ul>
<table>
<thead>
<tr>
<th>RC</th>
<th style="text-align:center">Status</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td style="text-align:center">successful</td>
<td style="text-align:center">connected</td>
</tr>
<tr>
<td>1</td>
<td style="text-align:center">refused</td>
<td style="text-align:center">incorrect protocol version</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:center">refused</td>
<td style="text-align:center">invalid client identifier</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:center">refused</td>
<td style="text-align:center">server unavailable</td>
</tr>
<tr>
<td>4</td>
<td style="text-align:center">refused</td>
<td style="text-align:center">bad username or password</td>
</tr>
<tr>
<td>5</td>
<td style="text-align:center">refused</td>
<td style="text-align:center">not authorised</td>
</tr>
<tr>
<td>6-255</td>
<td style="text-align:center">refused</td>
<td style="text-align:center">Currently unused</td>
</tr>
</tbody>
</table>
<h3 id="on-disconnect-client-userdata-rc"><a href="#on-disconnect-client-userdata-rc" class="headerlink" title="on_disconnect(client, userdata, rc)"></a>on_disconnect(client, userdata, rc)</h3><p>å½“clientå’Œbrokeræ–­å¼€è¿æ¥æ—¶è°ƒç”¨. rcè¡¨ç¤ºæ–­å¼€è¿æ¥æ˜¯çš„çŠ¶æ€</p>
<table>
<thead>
<tr>
<th>RC</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td style="text-align:center">MQTT_ERR_SUCCESS, å®¢æˆ·ç«¯è°ƒç”¨disconnect()æ–¹æ³•æ–­å¼€è¿æ¥, å±äºæ­£å¸¸æ–­å¼€</td>
</tr>
<tr>
<td>1</td>
<td style="text-align:center">ç½‘ç»œç­‰å…¶ä»–åŸå› ç…§æˆçš„è¿æ¥æ–­å¼€, å¼‚å¸¸æ–­å¼€</td>
</tr>
</tbody>
</table>
<h3 id="on-message-client-userdata-message"><a href="#on-message-client-userdata-message" class="headerlink" title="on_message(client, userdata, message)"></a>on_message(client, userdata, message)</h3><p>å½“å®¢æˆ·ç«¯è®¢é˜…çš„topicä¸Šæœ‰æ•°æ® è¢«æ¥æ”¶æ—¶è°ƒç”¨, messageæ˜¯ä¸€ä¸ªMQTTMessageçš„ç±», è¯¥ç±»åŒ…å«äº†messageçš„æ‰€æœ‰æ•°æ®:</p>
<ul>
<li>topic: æ•°æ®æ‰€åœ¨çš„topic</li>
<li>payload: messageçš„æ•°æ®éƒ¨åˆ†</li>
<li>qos: è¯¥æ¶ˆæ¯çš„è´¨é‡: 0, 1, 2</li>
<li>retain: è¯¥æ¶ˆæ¯æ˜¯å¦æ˜¯ä¿ç•™æ¶ˆæ¯, å¦‚æœä¸ºTrue è¿™ä¸ºä¿ç•™æ¶ˆæ¯, å¦‚æœä¸ºFalseå°±æ˜¯æœ€æ–°çš„æ¶ˆæ¯ã€‚</li>
<li>mid: message id</li>
</ul>
<h3 id="on-publish-client-userdata-mid"><a href="#on-publish-client-userdata-mid" class="headerlink" title="on_publish(client, userdata, mid)"></a>on_publish(client, userdata, mid)</h3><p>å½“ä½¿ç”¨publishæ–¹æ³•å°†messageä¼ è¾“åˆ°brokeråè°ƒç”¨, ä½†æ˜¯è¿™è¦é’ˆå¯¹ä¸åŒçš„qos, å¯¹äºqos1å’Œ2è€Œè¨€, è¿™è¡¨ç¤ºæ¶ˆæ¯å·²ç»åˆ°è¾¾åçš„å›è°ƒ, å¦‚æœqosæ˜¯0é‚£ä¹ˆä»…ä»…è¡¨ç¤ºæ¶ˆæ¯ç¦»å¼€äº†å®¢æˆ·ç«¯ä¹‹åçš„å›è°ƒã€‚è¿™ä¸ªå›è°ƒå¾ˆé‡è¦ï¼Œå› ä¸ºå³ä½¿publish()è°ƒç”¨è¿”å›æˆåŠŸï¼Œå¹¶ä¸æ€»æ˜¯æ„å‘³ç€å·²ç»å‘é€äº†æ¶ˆæ¯</p>
<ul>
<li>mid: è¡¨ç¤ºå·²ç»publishå‡ºå»çš„æ¶ˆæ¯çš„message id</li>
</ul>
<h3 id="on-subscribe-client-userdata-mid-granted-qos"><a href="#on-subscribe-client-userdata-mid-granted-qos" class="headerlink" title="on_subscribe(client, userdata, mid, granted_qos)"></a>on_subscribe(client, userdata, mid, granted_qos)</h3><p>å½“brokerå“åº”äº†subscribeè¯·æ±‚ä¹‹åè°ƒç”¨ã€‚</p>
<ul>
<li>mid: è¢«è®¢é˜…æ¶ˆæ¯çš„message id</li>
<li>granted_qos: brokerä¸ºä¸åŒçš„è®¢é˜…è¯·æ±‚æˆæƒçš„qosçº§åˆ«ã€‚æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚</li>
</ul>
<h3 id="on-unsubscribe-client-userdata-mid"><a href="#on-unsubscribe-client-userdata-mid" class="headerlink" title="on_unsubscribe(client, userdata, mid)"></a>on_unsubscribe(client, userdata, mid)</h3><p>å½“brokerå“åº”äº†å–æ¶ˆè®¢é˜…çš„è¯·æ±‚è¿‡åè°ƒç”¨ã€‚</p>
<ul>
<li>mid: å–æ¶ˆè®¢é˜…çš„æ¶ˆæ¯çš„message id</li>
</ul>
<h3 id="on-log-client-userdata-level-buf"><a href="#on-log-client-userdata-level-buf" class="headerlink" title="on_log(client, userdata, level, buf)"></a>on_log(client, userdata, level, buf)</h3><p>MQTTé€šä¿¡è¿‡ç¨‹ä¸­çš„ä¸€äº›Debugä¿¡æ¯</p>
<ul>
<li>level: æ—¥å¿—çº§åˆ«MQTT_LOG_INFO, MQTT_LOG_NOTICE, MQTT_LOG_WARNING, MQTT_LOG_ERR, and MQTT_LOG_DEBUG</li>
<li>buf: message buffer, debugä¿¡æ¯æœ¬èº«ã€‚</li>
</ul>
<h2 id="ç¤ºä¾‹ä»£ç "><a href="#ç¤ºä¾‹ä»£ç " class="headerlink" title="ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h2><p>æˆ‘Githubä¸Šæœ‰: <a href="https://github.com/yumaojun03/python/blob/master/mqtt/main.py" target="_blank" rel="external">å®Œæ•´ç¤ºä¾‹ä»£ç </a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment"># -*- coding: utf8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="keyword">from</span> paho.mqtt.client <span class="keyword">import</span> Client</div><div class="line"></div><div class="line">FORMAT = <span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span></div><div class="line">logging.basicConfig(format=FORMAT, level=logging.INFO)</div><div class="line">logger = logging.getLogger()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">pub_topic_test01</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        client.publish(topic=<span class="string">"test01"</span>, qos=<span class="number">2</span>, payload=<span class="string">"test01 topic data"</span>)</div><div class="line">        time.sleep(<span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">pub_topic_test02</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        client.publish(topic=<span class="string">"test02"</span>, qos=<span class="number">2</span>, payload=<span class="string">"test02 topic data"</span>)</div><div class="line">        time.sleep(<span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMQTTClass</span><span class="params">(Client)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    mqtt client for deal data</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        super(MyMQTTClass, self).__init__(client_id=<span class="string">"test client"</span>, clean_session=<span class="keyword">False</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_connect</span><span class="params">(self, client, obj, flags, rc)</span>:</span></div><div class="line">        logger.info(<span class="string">"on connect, rc: %s"</span> % rc)</div><div class="line"></div><div class="line">        <span class="comment"># é“¾æ¥è¿‡åå…ˆå¤„ç†sub</span></div><div class="line">        client.subscribe(topic=<span class="string">"test01"</span>, qos=<span class="number">2</span>)</div><div class="line">        client.subscribe(topic=<span class="string">"test02"</span>, qos=<span class="number">2</span>)</div><div class="line"></div><div class="line">        logger.info(<span class="string">"start topic service1..."</span>)</div><div class="line">        t1 = threading.Thread(target=pub_topic_test01, args=(client,))</div><div class="line">        t1.start()</div><div class="line">        self.worker1 = t1</div><div class="line"></div><div class="line">        logger.info(<span class="string">"start topic service2..."</span>)</div><div class="line">        t2 = threading.Thread(target=pub_topic_test02, args=(client,))</div><div class="line">        t2.start()</div><div class="line">        self.worker2 = t2</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(self, client, obj, msg)</span>:</span></div><div class="line">        logger.debug(<span class="string">"on message, topic: %s, qos: %s, data: %s"</span> % (msg.topic, msg.qos, msg.payload))</div><div class="line"></div><div class="line">        <span class="keyword">if</span> msg.topic == <span class="string">"test01"</span>:</div><div class="line">            logger.info(<span class="string">"deal test01, data: %s"</span> % msg.payload)</div><div class="line"></div><div class="line">        <span class="keyword">elif</span> msg.topic == <span class="string">"test02"</span>:</div><div class="line">            logger.info(<span class="string">"deal test02, data: %s"</span> % msg.payload)</div><div class="line"></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            logger.info(<span class="string">"other topic %s, data: %s"</span> %(msg.topic, msg.payload))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_publish</span><span class="params">(self, client, obj, mid)</span>:</span></div><div class="line">        logger.debug(<span class="string">"publish -&gt; ,mid: %s"</span> % mid)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_subscribe</span><span class="params">(self, client, obj, mid, granted_qos)</span>:</span></div><div class="line">        logger.debug(<span class="string">"subscribed &lt;- ,mid: %s, qos: %s"</span> %(mid, granted_qos))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_log</span><span class="params">(self, mqttc, obj, level, string)</span>:</span></div><div class="line">        logger.debug(<span class="string">"mqtt debug: %s"</span> % string)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_disconnect</span><span class="params">(self, client, userdata, rc)</span>:</span></div><div class="line">        logger.info(<span class="string">"disconnect: %s"</span> % rc)</div><div class="line"></div><div class="line">        <span class="keyword">while</span> rc == <span class="number">1</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                client.reconnect()</div><div class="line">                logger.info(<span class="string">"reconnect success"</span>)</div><div class="line">                rc = <span class="number">0</span></div><div class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                logger.error(<span class="string">"reconnect error, %s retry after 3s"</span> % e)</div><div class="line">                time.sleep(<span class="number">3</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        self.connect(<span class="string">"172.16.112.251"</span>, <span class="number">1883</span>, <span class="number">60</span>)</div><div class="line"></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            rc = self.loop()</div><div class="line">            <span class="keyword">if</span> rc != <span class="number">0</span>:</div><div class="line">                time.sleep(<span class="number">1</span>)</div><div class="line">                rc = self.loop()</div><div class="line">                logger.info(<span class="string">"recovery from error loop, %s"</span> % rc)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    client = MyMQTTClass()</div><div class="line">    client.run()</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘ä½¿ç”¨Pythonå†™ä¸€ä¸ªåå°æœåŠ¡å¤„ç†mqtté‡Œé¢çš„äº‹ä»¶æ—¶é‡åˆ°äº†ä¸€ä¸ªéº»çƒ¦: mqttè¿æ¥é‡ç½®æ—¶(é‡å¯mqttæœåŠ¡å), ä¹‹å‰pubæ¶ˆæ¯çš„çº¿ç¨‹ä¸èƒ½æ­£å¸¸å·¥ä½œäº†, ç»è¿‡å¤šæ¬¡è¸©å‘, ç»ˆäºè§£å†³. å¼•å‘é—®é¢˜çš„åŸå› æ˜¯æˆ‘ä½¿ç”¨å§¿åŠ¿ä¸å¯¹é€ æˆçš„, ä¸€æ—¦ä½ ä½¿ç”¨å§¿åŠ¿ä¸å¯¹ ä¼šé€ æˆä¸€äº›å¥‡æ€ªçš„é—®é¢˜,å¹¶ä¸”å¾ˆéš¾è§£å†³ã€‚ å› æ­¤è¯·æ­£ç¡®ä½¿ç”¨mqttã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Python" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Python/"/>
    
    
      <category term="mqtt" scheme="https://blog.yumaojun.net/tags/mqtt/"/>
    
  </entry>
  
  <entry>
    <title>ç‰©è”ç½‘ä¹‹MQTT</title>
    <link href="https://blog.yumaojun.net/2017/07/02/mqtt-introduce/"/>
    <id>https://blog.yumaojun.net/2017/07/02/mqtt-introduce/</id>
    <published>2017-07-02T04:46:42.000Z</published>
    <updated>2017-08-08T03:16:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç‰©è”ç½‘ç‰©æ¥å…¥åè®®MQTT<br><a id="more"></a></p>
<p>ç›¸å¯¹æ¥è¯´ï¼ŒIoTçš„æŠ€æœ¯æŒ‘æˆ˜ï¼Œä¸»è¦åœ¨å®‰å…¨éšæ‚£ã€è¿æ¥ç®¡ç†ã€æµ·é‡æ•°æ®ç®¡ç†ï¼Œç”¨å…³é”®å­—æ¥è¯´å°±æ˜¯æµ·é‡ã€é€šç”¨ã€å¯æ‰©å±•ã€ç®€å•ã€‚<br>ç‰©æ¥å…¥äº‘ç«¯ï¼Œæœ‰å¾ˆå¤šæŒ‘æˆ˜, æ•°æ®çš„å®‰å…¨å°¤ä¸ºé‡è¦ </p>
<h2 id="åè®®æ¯”è¾ƒ"><a href="#åè®®æ¯”è¾ƒ" class="headerlink" title="åè®®æ¯”è¾ƒ"></a>åè®®æ¯”è¾ƒ</h2><p><a href="http://www.365yg.com/group/6408407122584879362/" target="_blank" rel="external">åè®®æ¯”è¾ƒ</a></p>
<h2 id="MQTTç®€ä»‹"><a href="#MQTTç®€ä»‹" class="headerlink" title="MQTTç®€ä»‹"></a>MQTTç®€ä»‹</h2><p>MQTTæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯æœåŠ¡ç«¯æ¶æ„çš„å‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯ä¼ è¾“åè®®ã€‚å®ƒçš„è®¾è®¡æ€æƒ³æ˜¯è½»å·§ã€å¼€æ”¾ã€ç®€å•ã€è§„èŒƒï¼Œæ˜“äºå®ç°ã€‚è¿™äº›ç‰¹ç‚¹ä½¿å¾—å®ƒå¯¹å¾ˆå¤šåœºæ™¯æ¥è¯´éƒ½æ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå—é™çš„ç¯å¢ƒå¦‚æœºå™¨ä¸æœºå™¨çš„é€šä¿¡(M2M)ä»¥åŠç‰©è”ç½‘ç¯å¢ƒ(IoT)ã€‚<br>æ€»ä½“æ¥è¯´MQTTæœ‰å¦‚ä¸‹ç‰¹æ€§:</p>
<ul>
<li>è½»é‡çº§çš„ machine-to-machine é€šä¿¡åè®®ã€‚</li>
<li>publish/subscribeæ¨¡å¼ã€‚</li>
<li>åŸºäºTCP/IPã€‚</li>
<li>æ”¯æŒQoSã€‚</li>
<li>é€‚åˆäºä½å¸¦å®½ã€ä¸å¯é è¿æ¥ã€åµŒå…¥å¼è®¾å¤‡ã€CPUå†…å­˜èµ„æºç´§å¼ ã€‚</li>
<li>æ˜¯ä¸€ç§æ¯”è¾ƒä¸é”™çš„Androidæ¶ˆæ¯æ¨é€æ–¹æ¡ˆã€‚</li>
<li>FacebookMessengeré‡‡ç”¨äº†MQTTã€‚</li>
<li>MQTTæœ‰å¯èƒ½æˆä¸ºç‰©è”ç½‘çš„é‡è¦åè®®</li>
</ul>
<p><a href="http://dataguild.org/?p=6817" target="_blank" rel="external">mqttåè®®ç®€ä»‹</a></p>
<p><a href="http://www.cnblogs.com/caca/p/mqtt.html" target="_blank" rel="external">åè®®ç®€ä»‹</a></p>
<h2 id="æŠ¥æ–‡æ ¼å¼"><a href="#æŠ¥æ–‡æ ¼å¼" class="headerlink" title="æŠ¥æ–‡æ ¼å¼"></a>æŠ¥æ–‡æ ¼å¼</h2><table class="tg"><tr><th class="tg-baqh">bit</th><th class="tg-yw4l">7</th><th class="tg-yw4l">6</th><th class="tg-yw4l">5</th><th class="tg-yw4l">4</th><th class="tg-yw4l">3</th><th class="tg-yw4l">2</th><th class="tg-yw4l">1</th><th class="tg-yw4l">0</th></tr><tr><td class="tg-q1yk">byte 1</td><td class="tg-6k2t" colspan="4">Message type</td><td class="tg-6k2t">DUP</td><td class="tg-6k2t" colspan="2">QoS level</td><td class="tg-6k2t">RETAIN</td></tr><tr><td class="tg-jogk">byte 2</td><td class="tg-yw4l" colspan="8">Message length (between one and four bytes)</td></tr><tr><td class="tg-r78f">byte 3</td><td class="tg-j0tj" colspan="8">â€¦ if needed to encode message length</td></tr><tr><td class="tg-574v">byte 4</td><td class="tg-baqh" colspan="8">â€¦ if needed to encode message length</td></tr><tr><td class="tg-r78f">byte 5</td><td class="tg-j0tj" colspan="8">â€¦ if needed to encode message length</td></tr></table>

<h2 id="æ§åˆ¶æŒ‡ä»¤"><a href="#æ§åˆ¶æŒ‡ä»¤" class="headerlink" title="æ§åˆ¶æŒ‡ä»¤"></a>æ§åˆ¶æŒ‡ä»¤</h2><table>
<thead>
<tr>
<th>Message Type</th>
<th style="text-align:center">Value</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CONNECT</td>
<td style="text-align:center">1</td>
<td style="text-align:center">Client request to connect to Server</td>
</tr>
<tr>
<td>CONNACK</td>
<td style="text-align:center">2</td>
<td style="text-align:center">Connect Acknowledgment</td>
</tr>
<tr>
<td>PUBLISH</td>
<td style="text-align:center">3</td>
<td style="text-align:center">Publish message</td>
</tr>
<tr>
<td>PUBACK</td>
<td style="text-align:center">4</td>
<td style="text-align:center">Publish Acknowledgment</td>
</tr>
<tr>
<td>PUBREC</td>
<td style="text-align:center">5</td>
<td style="text-align:center">Publish Received (assured delivery part 1)</td>
</tr>
<tr>
<td>PUBREL</td>
<td style="text-align:center">6</td>
<td style="text-align:center">Publish Release (assured delivery part 2)</td>
</tr>
<tr>
<td>PUBCOMP</td>
<td style="text-align:center">7</td>
<td style="text-align:center">Publish Complete (assured delivery part 3)</td>
</tr>
<tr>
<td>SUBSCRIBE</td>
<td style="text-align:center">8</td>
<td style="text-align:center">Client Subscribe request</td>
</tr>
<tr>
<td>SUBACK</td>
<td style="text-align:center">9</td>
<td style="text-align:center">Subscribe Acknowledgment</td>
</tr>
<tr>
<td>UNSUBSCRIBE</td>
<td style="text-align:center">10</td>
<td style="text-align:center">Client Unsubscribe request</td>
</tr>
<tr>
<td>UNSUBACK</td>
<td style="text-align:center">11</td>
<td style="text-align:center">Unsubscribe Acknowledgment</td>
</tr>
<tr>
<td>PINGREQ</td>
<td style="text-align:center">12</td>
<td style="text-align:center">PING Request</td>
</tr>
<tr>
<td>PINGRESP</td>
<td style="text-align:center">13</td>
<td style="text-align:center">PING Response</td>
</tr>
<tr>
<td>DISCONNECT</td>
<td style="text-align:center">14</td>
<td style="text-align:center">Client is Disconnecting</td>
</tr>
</tbody>
</table>
<h2 id="Qos"><a href="#Qos" class="headerlink" title="Qos"></a>Qos</h2><p><img src="https://image.slidesharecdn.com/mqttiotprotocolscomparison-140219090749-phpapp01/95/mqtt-iot-protocols-comparison-8-638.jpg?cb=1392817944" alt=""></p>
<h2 id="mqttçš„çŠ¶æ€æœº"><a href="#mqttçš„çŠ¶æ€æœº" class="headerlink" title="mqttçš„çŠ¶æ€æœº"></a>mqttçš„çŠ¶æ€æœº</h2><p><img src="http://www.sharetechnote.com/html/IoT/image/IoT_MQTT_ProtocolOverview_01.png" alt=""><br>wo </p>
<p><img src="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.iotsdk.v0.9.0/msc_mqtt.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç‰©è”ç½‘ç‰©æ¥å…¥åè®®MQTT&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Python" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Python/"/>
    
    
      <category term="iot" scheme="https://blog.yumaojun.net/tags/iot/"/>
    
      <category term="mqtt" scheme="https://blog.yumaojun.net/tags/mqtt/"/>
    
  </entry>
  
  <entry>
    <title>Pythonç¼–ç é£æ ¼</title>
    <link href="https://blog.yumaojun.net/2017/06/24/python-style-pep8/"/>
    <id>https://blog.yumaojun.net/2017/06/24/python-style-pep8/</id>
    <published>2017-06-24T10:49:39.000Z</published>
    <updated>2017-06-27T05:33:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åšé¡¹ç›®ä¸€ç›´ä½¿ç”¨Golang, è·ç¦»ä¸Šæ¬¡ä½¿ç”¨Pythonå·²ç»åŠå¹´ä¹‹ä¹…äº†, å¯¹äºGoæ¥è¯´æœ‰fmtå¸®å¿™æ ¼å¼åŒ–, è§£å†³äº†ç»å¤§éƒ¨åˆ†ç¼–ç é£æ ¼é—®é¢˜, è€ŒPythonåˆ™éœ€è¦è‡ªå·±æ³¨æ„,æ ¹æ®å®˜æ–¹æŒ‡å¯¼PEP8æˆ–è€…ä¸€äº›æœ€ä½³å®è·µæ¯”å¦‚Google Styleæ¥æ§åˆ¶é£æ ¼ã€‚æ—¶é—´ä¹…äº† ä¸€äº›ç»†èŠ‚éƒ¨åˆ†å°±å¿˜è®°äº†, äºæ˜¯ç¿»é˜…ä¹‹å‰å†™çš„åšå®¢, å—ç›Šè‰¯å¤š, äºæ˜¯æ‰“ç®—æŠŠä¹‹å‰çš„è¿™å‡ ç¯‡åšå®¢è¿ç§»è¿‡æ¥, é¡ºä¾¿æ›´æ–°, æ–¹ä¾¿ä»¥åæŸ¥é˜…ã€‚<br><a id="more"></a></p>
<h2 id="å…³äºæœ¬æ–‡"><a href="#å…³äºæœ¬æ–‡" class="headerlink" title="å…³äºæœ¬æ–‡"></a>å…³äºæœ¬æ–‡</h2><p>æœ¬æ–‡ä¸»è¦å‚è€ƒPEP8(Pythonç‰ˆæœ¬æ ‡å‡†åº“çš„ç¼–ç çº¦å®š),ä»¥åŠGoogle Styleç¼–ç é£æ ¼, ä½†å´ä¸ä¼šå®Œå…¨æŒ‰ç…§PEP8è¿›è¡Œç¿»è¯‘, æˆ‘ä¸ä¼šè´´å‡ºä¸åˆè§„èŒƒçš„ä»£ç , å°½é‡ç®€æ´æ˜“æ‡‚, æ–¹ä¾¿å¿«é€Ÿé˜…è¯», å¦‚æœæƒ³çœ‹å®Œæ•´ç‰ˆæœ¬çš„PEP8ç›¸å…³æ–‡æ¡£, è¯·ç§»æ­¥å‚è€ƒæ–‡æ¡£éƒ¨åˆ†ã€‚ </p>
<h2 id="é£æ ¼æŒ‡å—çš„ç›®çš„"><a href="#é£æ ¼æŒ‡å—çš„ç›®çš„" class="headerlink" title="é£æ ¼æŒ‡å—çš„ç›®çš„"></a>é£æ ¼æŒ‡å—çš„ç›®çš„</h2><p>é£æ ¼æŒ‡å—çš„ç›®çš„åœ¨äºç»Ÿä¸€ç¼–ç é£æ ¼,è®©ä»£ç æœ‰è§„å¯å¾ª,è¿™æ ·äººä»¬å°±å¯ä»¥ä¸“æ³¨äºâ€ä½ åœ¨è¯´ä»€ä¹ˆâ€, è€Œä¸æ˜¯â€ä½ åœ¨æ€ä¹ˆè¯´â€.ä»è€Œæ”¹å–„Pythonä»£ç çš„å¯è¯»æ€§,å³<a href="https://www.python.org/dev/peps/pep-0020/" target="_blank" rel="external">PEP 20</a>æ‰€è¯´çš„â€œå¯è¯»æ€§è®¡æ•°â€(Readability counts).</p>
<p>é£æ ¼æŒ‡é’ˆåœ¨äºç»Ÿä¸€é£æ ¼, PEP8ä»…ä»…æ˜¯å®˜æ–¹æŒ‡å¯¼, æœ¬åœ°ç¼–ç é£æ ¼åŒæ ·é‡è¦, å¦‚æœæ»¡è¶³å¯è¯»æ€§, ä¼˜å…ˆä¿æŒæœ¬åœ°é£æ ¼, ä½¿å¾—ä½ æ•´ä½“é¡¹ç›®çš„ä»£ç é£æ ¼ä¸€è‡´ã€‚ </p>
<h2 id="ä»£ç å¸ƒå±€"><a href="#ä»£ç å¸ƒå±€" class="headerlink" title="ä»£ç å¸ƒå±€"></a>ä»£ç å¸ƒå±€</h2><ol>
<li><p>æ¯çº§ç¼©è¿›ç”¨4ä¸ªç©ºæ ¼(å¼ºçƒˆå»ºè®®ä½¿ç”¨4ä¸ªç©ºæ ¼ä½œä¸ºç¼©è¿›), ä¸è¦æ··ç”¨ç©ºæ ¼å’ŒTab, Python3ä¸­ä¸å…è®¸æ··åˆä½¿ç”¨Tabå’Œç©ºæ ¼ç¼©è¿›</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_version</span><span class="params">(version=None)</span>:</span></div><div class="line">    <span class="string">"Returns a PEP 386-compliant version number from VERSION."</span></div><div class="line">    version = get_complete_version(version)</div></pre></td></tr></table></figure>
</li>
<li><p>æ‹¬å·ä¸­ä½¿ç”¨å‚ç›´éšå¼ç¼©è¿›æˆ–ä½¿ç”¨æ‚¬æŒ‚ç¼©è¿›ï¼ˆå¯¹å‡†å·¦æ‹¬å·ï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">foo = long_function_name(var_one, var_two,</div><div class="line">                         var_three, var_four)</div></pre></td></tr></table></figure>
</li>
<li><p>ifè¯­å¥è·¨è¡Œæ—¶ï¼Œä¸¤ä¸ªå­—ç¬¦å…³é”®å­—(æ¯”å¦‚if)åŠ ä¸Šä¸€ä¸ªç©ºæ ¼ï¼Œå†åŠ ä¸Šå·¦æ‹¬å·æ„æˆäº†å¾ˆå¥½çš„ç¼©è¿›ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Add some extra indentation on the conditional continuation line.</span></div><div class="line"><span class="keyword">if</span> (this_is_one_thing</div><div class="line">        <span class="keyword">and</span> that_is_another_thing):</div><div class="line">    do_something()</div></pre></td></tr></table></figure>
</li>
<li><p>å³è¾¹æ‹¬å·ä¹Ÿå¯ä»¥å¦èµ·ä¸€è¡Œï¼ˆå³æ‹¬å·å›é€€ï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">my_list = [</div><div class="line">    <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>,</div><div class="line">    <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>,</div><div class="line">]</div><div class="line">result = some_function_that_takes_arguments(</div><div class="line">    <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>,</div><div class="line">    <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="æœ€å¤§è¡Œå®½"><a href="#æœ€å¤§è¡Œå®½" class="headerlink" title="æœ€å¤§è¡Œå®½"></a>æœ€å¤§è¡Œå®½</h2><p>é™åˆ¶æ‰€æœ‰è¡Œçš„æœ€å¤§è¡Œå®½ä¸º79å­—ç¬¦ã€‚æ–‡æœ¬é•¿å—ï¼Œæ¯”å¦‚æ–‡æ¡£å­—ç¬¦ä¸²æˆ–æ³¨é‡Šï¼Œè¡Œé•¿åº¦åº”é™åˆ¶ä¸º72ä¸ªå­—ç¬¦ã€‚<br>ç»­è¡Œçš„é¦–é€‰æ–¹æ³•æ˜¯ä½¿ç”¨å°æ‹¬å·ã€ä¸­æ‹¬å·å’Œå¤§æ‹¬å·åæ–œçº¿ä»å¯èƒ½åœ¨é€‚å½“çš„æ—¶å€™ã€‚å…¶æ¬¡æ˜¯åæ–œæ ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> open(<span class="string">'/path/to/some/file/you/want/to/read'</span>) <span class="keyword">as</span> file_1, \</div><div class="line">     open(<span class="string">'/path/to/some/file/being/written'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> file_2:</div><div class="line">    file_2.write(file_1.read())</div></pre></td></tr></table></figure></p>
<h2 id="ç©ºè¡Œ"><a href="#ç©ºè¡Œ" class="headerlink" title="ç©ºè¡Œ"></a>ç©ºè¡Œ</h2><ul>
<li>ç©ºäºŒè¡Œ: é¡¶çº§å®šä¹‰ä¹‹é—´ç©ºä¸¤è¡Œ, æ¯”å¦‚å‡½æ•°æˆ–è€…ç±»å®šä¹‰. </li>
<li>ç©ºä¸€è¡Œ: æ–¹æ³•å®šä¹‰, ç±»å®šä¹‰ä¸ç¬¬ä¸€ä¸ªæ–¹æ³•ä¹‹é—´, éƒ½åº”è¯¥ç©ºä¸€è¡Œ. å‡½æ•°æˆ–æ–¹æ³•ä¸­, æŸäº›åœ°æ–¹è¦æ˜¯ä½ è§‰å¾—åˆé€‚, å°±ç©ºä¸€è¡Œ.<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamingHttpResponse</span><span class="params">(HttpResponseBase)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    A streaming HTTP response class with an iterator as content.</div><div class="line"> </div><div class="line">    This should only be iterated once, when the response is streamed to the</div><div class="line">    client. However, it can be appended to or replaced with a new iterator</div><div class="line">    that wraps the original content (or yields entirely new content).</div><div class="line">    """</div><div class="line"> </div><div class="line">    streaming = <span class="keyword">True</span></div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, streaming_content=<span class="params">()</span>, *args, **kwargs)</span>:</span></div><div class="line">        super(StreamingHttpResponse, self).__init__(*args, **kwargs)</div><div class="line">        <span class="comment"># `streaming_content` should be an iterable of bytestrings.</span></div><div class="line">        <span class="comment"># See the `streaming_content` property methods.</span></div><div class="line">        self.streaming_content = streaming_content</div><div class="line"> </div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">content</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">"This %s instance has no `content` attribute. "</span></div><div class="line">            <span class="string">"Use `streaming_content` instead."</span> % self.__class__.__name__)</div><div class="line"> </div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">streaming_content</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> map(self.make_bytes, self._iterator)</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="æ¨¡å—å¯¼å…¥"><a href="#æ¨¡å—å¯¼å…¥" class="headerlink" title="æ¨¡å—å¯¼å…¥"></a>æ¨¡å—å¯¼å…¥</h2><ul>
<li>å¯¼å…¥åœ¨å•ç‹¬æˆè¡Œ, åŒä¸€ä¸ªæ¨¡å—çš„å¤šä¸ªå¯¹è±¡è¢«å¯¼å‡ºæ—¶ä½¿ç”¨()</li>
<li>å¯¼å…¥å§‹ç»ˆåœ¨æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œåœ¨æ¨¡å—æ³¨é‡Šå’Œæ–‡æ¡£å­—ç¬¦ä¸²ä¹‹åï¼Œåœ¨æ¨¡å—å…¨å±€å˜é‡å’Œå¸¸é‡ä¹‹å‰ã€‚</li>
<li>æ¨èç»å¯¹è·¯å¾„å¯¼å…¥ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æ›´å¯è¯»ï¼Œè€Œä¸”å¾€å¾€æ˜¯è¡¨ç°æ›´å¥½çš„ï¼ˆæˆ–è‡³å°‘æä¾›æ›´å¥½çš„é”™è¯¯æ¶ˆæ¯ã€‚</li>
<li>ç¦æ­¢ä½¿ç”¨é€šé…ç¬¦å¯¼å…¥ã€‚</li>
<li>å¯¼å…¥é¡ºåºå¦‚ä¸‹ï¼šæ ‡å‡†åº“è¿›å£,ç›¸å…³çš„ç¬¬ä¸‰æ–¹åº“ï¼Œæœ¬åœ°åº“ã€‚å„ç»„çš„å¯¼å…¥ä¹‹é—´è¦æœ‰ç©ºè¡Œã€‚<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æ ‡å‡†åº“</span></div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> traceback</div><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</div><div class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> isawaitable</div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</div><div class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> (</div><div class="line">    SIGTERM, SIGINT,</div><div class="line">    signal <span class="keyword">as</span> signal_func,</div><div class="line">    Signals</div><div class="line">)</div><div class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> (</div><div class="line">    socket,</div><div class="line">    SOL_SOCKET,</div><div class="line">    SO_REUSEADDR,</div><div class="line">)</div><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="comment"># ç¬¬ä¸‰æ–¹åº“</span></div><div class="line"><span class="keyword">from</span> httptools <span class="keyword">import</span> HttpRequestParser</div><div class="line"><span class="keyword">from</span> httptools.parser.errors <span class="keyword">import</span> HttpParserError</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">import</span> uvloop <span class="keyword">as</span> async_loop</div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">    async_loop = asyncio</div><div class="line"></div><div class="line"><span class="comment"># æœ¬åœ°åº“</span></div><div class="line"><span class="keyword">from</span> sanic.log <span class="keyword">import</span> log, netlog</div><div class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> HTTPResponse</div><div class="line"><span class="keyword">from</span> sanic.request <span class="keyword">import</span> Request</div><div class="line"><span class="keyword">from</span> sanic.exceptions <span class="keyword">import</span> (</div><div class="line">    RequestTimeout, PayloadTooLarge, InvalidUsage, ServerError)</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="å­—ç¬¦ä¸²å¼•ç”¨"><a href="#å­—ç¬¦ä¸²å¼•ç”¨" class="headerlink" title="å­—ç¬¦ä¸²å¼•ç”¨"></a>å­—ç¬¦ä¸²å¼•ç”¨</h2><p>Pythonä¸­å•å¼•å·å­—ç¬¦ä¸²å’ŒåŒå¼•å·å­—ç¬¦ä¸²éƒ½æ˜¯ç›¸åŒçš„ã€‚æ³¨æ„å°½é‡é¿å…åœ¨å­—ç¬¦ä¸²ä¸­çš„åæ–œæ ä»¥æé«˜å¯è¯»æ€§ã€‚<br>æ¯”å¦‚ä¸€æ®µå­—ç¬¦ä¸²é‡Œé¢æ—¢æœ‰å•å¼•å·ï¼Œåˆæœ‰åŒå¼•å·ï¼Œå°±çš„ä½¿ç”¨ å¤šè¡Œå­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œé¿å…ä½¿ç”¨ \â€ æˆ–\â€™<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">error = <span class="string">"""My Class hasn't "test" attribute."""</span></div></pre></td></tr></table></figure></p>
<h2 id="è¡¨è¾¾å¼å’Œè¯­å¥ä¸­çš„ç©ºæ ¼"><a href="#è¡¨è¾¾å¼å’Œè¯­å¥ä¸­çš„ç©ºæ ¼" class="headerlink" title="è¡¨è¾¾å¼å’Œè¯­å¥ä¸­çš„ç©ºæ ¼"></a>è¡¨è¾¾å¼å’Œè¯­å¥ä¸­çš„ç©ºæ ¼</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æ‹¬å·é‡Œè¾¹é¿å…ç©ºæ ¼ </span></div><div class="line">spam(ham[<span class="number">1</span>], &#123;eggs: <span class="number">2</span>&#125;)</div><div class="line"><span class="comment"># é€—å·ï¼Œå†’å·ï¼Œåˆ†å·ä¹‹å‰é¿å…ç©ºæ ¼</span></div><div class="line"><span class="keyword">if</span> x == <span class="number">4</span>: <span class="keyword">print</span> x, y; x, y = y, x</div><div class="line"><span class="comment"># ç´¢å¼•æ“ä½œç¬¦ä¸ç•™ç©ºæ ¼</span></div><div class="line">ham[<span class="number">1</span>:<span class="number">9</span>:<span class="number">3</span>]</div><div class="line"><span class="comment"># å‡½æ•°è°ƒç”¨çš„å·¦æ‹¬å·ä¹‹å‰ä¸èƒ½æœ‰ç©ºæ ¼</span></div><div class="line">spam(<span class="number">1</span>)</div><div class="line"><span class="comment"># äºŒå…ƒæ“ä½œç¬¦ä¸¤è¾¹ç•™ä¸€ä¸ªç©ºæ ¼,æ¶‰åŠ =ã€ç¬¦åˆæ“ä½œç¬¦ ( += , -=ç­‰)ã€æ¯”è¾ƒ( == , &lt; , &gt; , != , &lt;&gt; , &lt;= , &gt;= , in , not in , is , is not )ã€å¸ƒå°”( and , or , not )</span></div><div class="line">x = <span class="number">1</span></div><div class="line"><span class="comment"># æä¼˜å…ˆçº§è¿ç®—ç¬¦å‰åä¸ç•™ç©ºæ ¼</span></div><div class="line">hypot2 = x*x + y*y</div><div class="line">c = (a+b) * (a-b)</div><div class="line"><span class="comment"># å…³é”®å­—å‚æ•°å’Œé»˜è®¤å€¼å‚æ•°çš„å‰åä¸è¦åŠ ç©ºæ ¼</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">complex</span><span class="params">(real, imag=<span class="number">0.0</span>)</span>:</span></div><div class="line">    <span class="keyword">return</span> magic(r=real, i=imag)</div><div class="line"><span class="comment"># å‡½æ•°æ³¨é‡Šä¸­ï¼Œ=å‰åè¦æœ‰ç©ºæ ¼ï¼Œå†’å·å’Œ"-&gt;"çš„å‰é¢æ— ç©ºæ ¼ï¼Œåé¢æœ‰ç©ºæ ¼ã€‚</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">munge</span><span class="params">(sep: AnyStr = None)</span>:</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">munge</span><span class="params">()</span> -&gt; AnyStr:</span></div><div class="line"><span class="comment"># å°½é‡ä¸ä½¿ç”¨å¤åˆè¯­å¥(Compound statements: å¤šæ¡è¯­å¥å†™åœ¨åŒä¸€è¡Œ)</span></div><div class="line"><span class="keyword">if</span> foo == <span class="string">'blah'</span>:</div><div class="line">    do_blah_thing()</div></pre></td></tr></table></figure>
<h2 id="æ™®é€šæ³¨é‡Š"><a href="#æ™®é€šæ³¨é‡Š" class="headerlink" title="æ™®é€šæ³¨é‡Š"></a>æ™®é€šæ³¨é‡Š</h2><p>é€šç”¨è§„åˆ™:</p>
<ul>
<li>ä¸ä»£ç è‡ªç›¸çŸ›ç›¾çš„æ³¨é‡Šæ¯”æ²¡æ³¨é‡Šæ›´å·®ã€‚ä¿®æ”¹ä»£ç æ—¶è¦ä¼˜å…ˆæ›´æ–°æ³¨é‡Šï¼</li>
<li>æ³¨é‡Šæ˜¯å®Œæ•´çš„å¥å­ã€‚å¦‚æœæ³¨é‡Šæ˜¯æ–­å¥ï¼Œé¦–å­—æ¯åº”è¯¥å¤§å†™ï¼Œé™¤éå®ƒæ˜¯å°å†™å­—æ¯å¼€å¤´çš„æ ‡è¯†ç¬¦(æ°¸è¿œä¸è¦ä¿®æ”¹æ ‡è¯†ç¬¦çš„å¤§å°å†™)ã€‚</li>
<li>å¦‚æœæ³¨é‡Šå¾ˆçŸ­ï¼Œå¯ä»¥çœç•¥æœ«å°¾çš„å¥å·ã€‚æ³¨é‡Šå—é€šå¸¸ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ®µè½ç»„æˆã€‚æ®µè½ç”±å®Œæ•´çš„å¥å­æ„æˆä¸”æ¯ä¸ªå¥å­åº”è¯¥ä»¥ç‚¹å·(åé¢è¦æœ‰ä¸¤ä¸ªç©ºæ ¼)ç»“æŸï¼Œå¹¶æ³¨æ„æ–­è¯å’Œç©ºæ ¼ã€‚</li>
<li>éè‹±è¯­å›½å®¶çš„ç¨‹åºå‘˜è¯·ç”¨è‹±è¯­ä¹¦å†™ä½ çš„æ³¨é‡Šï¼Œé™¤éä½ 200%ç¡®ä¿¡ä»£ç æ°¸è¿œä¸ä¼šè¢«ä¸æ‡‚ä½ çš„è¯­è¨€çš„äººé˜…è¯»ã€‚</li>
</ul>
<p>æ³¨é‡Šå—:</p>
<ul>
<li>æ³¨é‡Šå—é€šå¸¸åº”ç”¨åœ¨ä»£ç å‰ï¼Œå¹¶å’Œè¿™äº›ä»£ç æœ‰åŒæ ·çš„ç¼©è¿›ã€‚æ¯è¡Œä»¥ â€˜# â€˜(é™¤éå®ƒæ˜¯æ³¨é‡Šå†…çš„ç¼©è¿›æ–‡æœ¬ï¼Œæ³¨æ„#åé¢æœ‰ç©ºæ ¼)ã€‚</li>
<li>æ³¨é‡Šå—å†…çš„æ®µè½ç”¨ä»…åŒ…å«å•ä¸ª â€˜#â€™ çš„è¡Œåˆ†å‰²ã€‚</li>
</ul>
<p>è¡Œå†…æ³¨é‡Š:</p>
<ul>
<li>æ…ç”¨è¡Œå†…æ³¨é‡Š(Inline Comments) èŠ‚ä¿­ä½¿ç”¨è¡Œå†…æ³¨é‡Šã€‚ è¡Œå†…æ³¨é‡Šæ˜¯å’Œè¯­å¥åœ¨åŒä¸€è¡Œï¼Œè‡³å°‘ç”¨ä¸¤ä¸ªç©ºæ ¼å’Œè¯­å¥åˆ†å¼€ã€‚è¡Œå†…æ³¨é‡Šä¸æ˜¯å¿…éœ€çš„ï¼Œé‡å¤ç½—å—¦ä¼šä½¿äººåˆ†å¿ƒã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># We use a weighted dictionary search to find out where i is in</span></div><div class="line"><span class="comment"># the array.  We extrapolate position based on the largest num</span></div><div class="line"><span class="comment"># in the array and the array size and then do binary search to</span></div><div class="line"><span class="comment"># get the exact number.</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> i &amp; (i<span class="number">-1</span>) == <span class="number">0</span>:        <span class="comment"># true iff i is a power of 2</span></div></pre></td></tr></table></figure>
<h2 id="æ–‡æ¡£æ³¨é‡Š"><a href="#æ–‡æ¡£æ³¨é‡Š" class="headerlink" title="æ–‡æ¡£æ³¨é‡Š"></a>æ–‡æ¡£æ³¨é‡Š</h2><p>è¿™éƒ¨åˆ†å¾ˆé‡è¦, ä»–æ˜¯Pythonç‹¬æœ‰çš„, ä¸ºæ‰€æœ‰å…¬å…±æ¨¡å—ã€å‡½æ•°ã€ç±»å’Œæ–¹æ³•ä¹¦å†™æ–‡æ¡£å­—ç¬¦ä¸²ã€‚éå…¬å¼€æ–¹æ³•ä¸ä¸€å®šæœ‰æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œå»ºè®®æœ‰æ³¨é‡Š(å‡ºç°åœ¨defè¡Œä¹‹å)æ¥æè¿°è¿™ä¸ªæ–¹æ³•åšä»€ä¹ˆ, è¯¦æƒ…å‚è€ƒ<a href="https://www.python.org/dev/peps/pep-0257/" target="_blank" rel="external">PEP 257 æ–‡æ¡£å­—ç¬¦ä¸²çº¦å®š</a><br>, ä½†æ˜¯è¿™éƒ¨åˆ†æˆ‘æ¯”è¾ƒæ¨å´‡Google Styleé£æ ¼ã€‚</p>
<h3 id="æ–‡æ¡£å­—ç¬¦ä¸²"><a href="#æ–‡æ¡£å­—ç¬¦ä¸²" class="headerlink" title="æ–‡æ¡£å­—ç¬¦ä¸²"></a>æ–‡æ¡£å­—ç¬¦ä¸²</h3><p>ä»€ä¹ˆæ˜¯æ–‡æ¡£å­—ç¬¦ä¸²(Document String):<br>æ–‡æ¡£å­—ç¬¦ä¸²æ˜¯åŒ…, æ¨¡å—, ç±»æˆ–å‡½æ•°é‡Œçš„ç¬¬ä¸€ä¸ªè¯­å¥. è¿™äº›å­—ç¬¦ä¸²å¯ä»¥é€šè¿‡å¯¹è±¡çš„<code>__doc__</code>æˆå‘˜è¢«è‡ªåŠ¨æå–, å¹¶ä¸”è¢«pydocæ‰€ç”¨.</p>
<p>æ–‡æ¡£å­—ç¬¦ä¸²çš„æ ¼å¼:<br>é¦–å…ˆæ˜¯ä¸€è¡Œä»¥å¥å·, é—®å·æˆ–æƒŠå¹å·ç»“å°¾çš„æ¦‚è¿°(æˆ–è€…è¯¥æ–‡æ¡£å­—ç¬¦ä¸²å•çº¯åªæœ‰ä¸€è¡Œ). æ¥ç€æ˜¯ä¸€ä¸ªç©ºè¡Œ. æ¥ç€æ˜¯æ–‡æ¡£å­—ç¬¦ä¸²å‰©ä¸‹çš„éƒ¨åˆ†,å®ƒåº”è¯¥ä¸æ–‡æ¡£å­—ç¬¦ä¸²çš„ç¬¬ä¸€è¡Œçš„ç¬¬ä¸€ä¸ªå¼•å·å¯¹é½. ä¸‹é¢æœ‰æ›´å¤šæ–‡æ¡£å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–è§„èŒƒ.</p>
<h3 id="æ¨¡å—æ–‡æ¡£"><a href="#æ¨¡å—æ–‡æ¡£" class="headerlink" title="æ¨¡å—æ–‡æ¡£"></a>æ¨¡å—æ–‡æ¡£</h3><p>æ¨¡å—è¯´æ˜: å¯¹è¿™ä¸ªæ¨¡å—è¿›è¡Œæ¦‚è²Œæ€§çš„æè¿°, æ¯”å¦‚Jsonåº“çš„è¯´æ˜<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="string">r"""JSON (JavaScript Object Notation) &lt;http://json.org&gt; is a subset of</span></div><div class="line">JavaScript syntax (ECMA-262 3rd edition) used as a lightweight data</div><div class="line">interchange format.</div><div class="line"></div><div class="line">:mod:`json` exposes an API familiar to users of the standard library</div><div class="line">:mod:`marshal` and :mod:`pickle` modules. It is the externally maintained</div><div class="line">version of the :mod:`json` library contained in Python 2.6, but maintains</div><div class="line">compatibility with Python 2.4 and Python 2.5 and (currently) has</div><div class="line">significant performance advantages, even without using the optional C</div><div class="line">extension for speedups.</div><div class="line"></div><div class="line">Compact encoding::</div><div class="line"></div><div class="line">    &gt;&gt;&gt; import json</div><div class="line">    &gt;&gt;&gt; json.dumps([1,2,3,&#123;'4': 5, '6': 7&#125;], sort_keys=True, separators=(',',':'))</div><div class="line">    '[1,2,3,&#123;"4":5,"6":7&#125;]'</div><div class="line"></div><div class="line">Using json.tool from the shell to validate and pretty-print::</div><div class="line"></div><div class="line">    $ echo '&#123;"json":"obj"&#125;' | python -m json.tool</div><div class="line">    &#123;</div><div class="line">        "json": "obj"</div><div class="line">    &#125;</div><div class="line">    $ echo '&#123; 1.2:3.4&#125;' | python -m json.tool</div><div class="line">    Expecting property name enclosed in double quotes: line 1 column 3 (char 2)</div><div class="line">"""</div></pre></td></tr></table></figure></p>
<h3 id="å‡½æ•°å’Œæ–¹æ³•æ–‡æ¡£"><a href="#å‡½æ•°å’Œæ–¹æ³•æ–‡æ¡£" class="headerlink" title="å‡½æ•°å’Œæ–¹æ³•æ–‡æ¡£"></a>å‡½æ•°å’Œæ–¹æ³•æ–‡æ¡£</h3><p>è¿™é‡Œè¯´çš„å‡½æ•°,åŒ…æ‹¬å‡½æ•°, æ–¹æ³•, ä»¥åŠç”Ÿæˆå™¨ã€‚ ä¸€ä¸ªå‡½æ•°å¿…é¡»è¦æœ‰æ–‡æ¡£å­—ç¬¦ä¸², é™¤éå®ƒæ»¡è¶³ä»¥ä¸‹æ¡ä»¶:</p>
<ul>
<li>å¤–éƒ¨ä¸å¯è§</li>
<li>éå¸¸çŸ­å°</li>
<li>ç®€å•æ˜äº†</li>
</ul>
<p>æ–‡æ¡£å­—ç¬¦ä¸²åº”è¯¥æä¾›è¶³å¤Ÿçš„ä¿¡æ¯, å½“åˆ«äººç¼–å†™ä»£ç è°ƒç”¨è¯¥å‡½æ•°æ—¶, ä»–ä¸éœ€è¦çœ‹ä¸€è¡Œä»£ç , åªè¦çœ‹æ–‡æ¡£å­—ç¬¦ä¸²å°±å¯ä»¥äº†.å› æ­¤éœ€è¦æè¿°æ¸…æ¥šä»¥ä¸‹å‡ ç‚¹:</p>
<ul>
<li><p>å‡½æ•°å‚æ•°: Args<br>åˆ—å‡ºæ¯ä¸ªå‚æ•°çš„åå­—, å¹¶åœ¨åå­—åä½¿ç”¨ä¸€ä¸ªå†’å·å’Œä¸€ä¸ªç©ºæ ¼, åˆ†éš”å¯¹è¯¥å‚æ•°çš„æè¿°.å¦‚æœæè¿°å¤ªé•¿è¶…è¿‡äº†å•è¡Œ80å­—ç¬¦,ä½¿ç”¨2æˆ–è€…4ä¸ªç©ºæ ¼çš„æ‚¬æŒ‚ç¼©è¿›(ä¸æ–‡ä»¶å…¶ä»–éƒ¨åˆ†ä¿æŒä¸€è‡´). æè¿°åº”è¯¥åŒ…æ‹¬æ‰€éœ€çš„ç±»å‹å’Œå«ä¹‰. å¦‚æœä¸€ä¸ªå‡½æ•°æ¥å—<em>foo(å¯å˜é•¿åº¦å‚æ•°åˆ—è¡¨)æˆ–è€…**bar (ä»»æ„å…³é”®å­—å‚æ•°), åº”è¯¥è¯¦ç»†åˆ—å‡º</em>fooå’Œ**bar.</p>
</li>
<li><p>æ­£å¸¸è¿”å›: Returns/Yields<br>æè¿°è¿”å›å€¼çš„ç±»å‹å’Œè¯­ä¹‰. å¦‚æœå‡½æ•°è¿”å›None, è¿™ä¸€éƒ¨åˆ†å¯ä»¥çœç•¥.</p>
</li>
<li><p>å¼‚å¸¸è¿”å›: Raises:<br>åˆ—å‡ºä¸æ¥å£æœ‰å…³çš„æ‰€æœ‰å¼‚å¸¸.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_bigtable_rows</span><span class="params">(big_table, keys, other_silly_variable=None)</span>:</span></div><div class="line">    <span class="string">"""Fetches rows from a Bigtable.</span></div><div class="line"></div><div class="line">    Retrieves rows pertaining to the given keys from the Table instance</div><div class="line">    represented by big_table.  Silly things may happen if</div><div class="line">    other_silly_variable is not None.</div><div class="line"></div><div class="line">    Args:</div><div class="line">        big_table: An open Bigtable Table instance.</div><div class="line">        keys: A sequence of strings representing the key of each table row</div><div class="line">            to fetch.</div><div class="line">        other_silly_variable: Another optional variable, that has a much</div><div class="line">            longer name than the other args, and which does nothing.</div><div class="line"></div><div class="line">    Returns:</div><div class="line">        A dict mapping keys to the corresponding table row data</div><div class="line">        fetched. Each row is represented as a tuple of strings. For</div><div class="line">        example:</div><div class="line"></div><div class="line">        &#123;'Serak': ('Rigel VII', 'Preparer'),</div><div class="line">         'Zim': ('Irk', 'Invader'),</div><div class="line">         'Lrrr': ('Omicron Persei 8', 'Emperor')&#125;</div><div class="line"></div><div class="line">        If a key from the keys argument is missing from the dictionary,</div><div class="line">        then that row was not found in the table.</div><div class="line"></div><div class="line">    Raises:</div><div class="line">        IOError: An error occurred accessing the bigtable.Table object.</div><div class="line">    """</div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ç±»æ–‡æ¡£"><a href="#ç±»æ–‡æ¡£" class="headerlink" title="ç±»æ–‡æ¡£"></a>ç±»æ–‡æ¡£</h3><p>åŒç†ç±»ä¹Ÿéœ€è¦åšè¯¦å°½çš„æè¿°:</p>
<ul>
<li>è¯¥ç±»çš„ç›®çš„, ä»¥åŠæ¦‚è²Œæè¿°</li>
<li>ç±»æœ‰å…¬å…±å±æ€§(Attributes), éœ€è¦æè¿°å…¶æ„ä¹‰</li>
<li>æ³¨æ„äº‹é¡¹</li>
<li>ç»§æ‰¿object, å› ä¸ºobjectå®ç°äº†ä¸€äº›å†…ç½®æ–¹æ³•,æ–¹ä¾¿å…¼å®¹ã€‚ <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SampleClass</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Summary of class here.</span></div><div class="line"></div><div class="line">    Longer class information....</div><div class="line">    Longer class information....</div><div class="line"></div><div class="line">    Attributes:</div><div class="line">        likes_spam: A boolean indicating if we like SPAM or not.</div><div class="line">        eggs: An integer count of the eggs we have laid.</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, likes_spam=False)</span>:</span></div><div class="line">        <span class="string">"""Inits SampleClass with blah."""</span></div><div class="line">        self.likes_spam = likes_spam</div><div class="line">        self.eggs = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">public_method</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Performs operation blah."""</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="TODOæ³¨é‡Š"><a href="#TODOæ³¨é‡Š" class="headerlink" title="TODOæ³¨é‡Š"></a>TODOæ³¨é‡Š</h3><p>å¦‚æœç±»æˆ–è€…æ–¹æ³•ï¼Œå‡½æ•° æ²¡æœ‰å®ç°å®Œæ•´åŠŸèƒ½, è¯·ä½¿ç”¨TODOæ ‡è®°, å¾ˆå¤šIDEéƒ½èƒ½æ‰¾åˆ°è¿™ä¸ªæ ‡è®°, æ–¹ä¾¿ä»¥åæ”¹è¿›, åˆ«ç•™å‘.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># TODO(kl@gmail.com): Use a "*" here for string repetition.</span></div><div class="line"><span class="comment"># TODO(Zeke) Change this to use relations.</span></div></pre></td></tr></table></figure></p>
<h2 id="è®¿é—®æ§åˆ¶"><a href="#è®¿é—®æ§åˆ¶" class="headerlink" title="è®¿é—®æ§åˆ¶"></a>è®¿é—®æ§åˆ¶</h2><p>åˆç†çš„è®¿é—®æ§åˆ¶ä¼šä½¿å¾—ä»£ç æ›´åŠ å¥å£®</p>
<ul>
<li><code>__slots__</code>: æ§åˆ¶å¯¹è±¡å¯ä»¥ç»‘å®šçš„å±æ€§, é¿å…å¯¹è±¡è¢«ä¸´æ—¶æ·»åŠ å±æ€§ï¼Œé€ æˆå¯¹è±¡çš„ä¸å¯é¢„æœŸè¡Œä¸ºã€‚</li>
<li><code>@property</code>: é€šè¿‡å±æ€§è£…é¥°å™¨æ§åˆ¶å±æ€§çš„è¯»å’Œå†™çš„è¡Œä¸º, é˜²æ­¢ä¸ç¬¦åˆè§„èŒƒæ•°æ®çš„å½•å…¥ã€‚</li>
<li><code>__</code>æˆ–è€…<code>_</code>: ä½¿ç”¨ä¸‹åˆ’çº¿å¼€å¤´çš„å˜é‡ï¼Œä¸ºç§æœ‰å˜é‡(åªæ˜¯åˆ«åäº†, ä½ çœŸæƒ³è®¿é—®è¿˜æ˜¯æœ‰åŠæ³•çš„, ä½†æ˜¯è¯·ä¸è¦è¿™æ ·åš)ã€‚</li>
<li><code>__all__</code>: å¯¹äºfrom importæ¥è¯´, å¯¼å‡ºæŒ‡å®šå¯¹è±¡, é˜²æ­¢å¯¼å‡ºå…¨å±€å˜é‡ã€‚</li>
</ul>
<p>æ³¨æ„: å¯¹æš´éœ²å‡ºå»çš„å…±æœ‰å˜é‡è¯·æ…é‡, å› ä¸ºå¦‚æœä½ æš´éœ²å‡ºå»è¿‡ä¼š, ä¸‹æ¬¡åœ¨è°ƒæ•´å°±éœ€è¦è€ƒè™‘åˆ°å…¼å®¹æ€§äº†, æ‰€ä»¥ä¼˜å…ˆä½¿ç”¨ç§æœ‰å˜é‡(<code>__</code>æˆ–è€…<code>_</code>)ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    __slots__ = [<span class="string">'birth'</span>, <span class="string">'age'</span>]</div><div class="line"></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">birth</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._birth</div><div class="line"></div><div class="line"><span class="meta">    @birth.setter</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">birth</span><span class="params">(self, value)</span>:</span></div><div class="line">        self._birth = value</div><div class="line"></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="number">2015</span> - self._birth</div></pre></td></tr></table></figure>
<h2 id="å‘½åçº¦å®š"><a href="#å‘½åçº¦å®š" class="headerlink" title="å‘½åçº¦å®š"></a>å‘½åçº¦å®š</h2><p>Pythonåº“çš„å‘½åçº¦å®šæœ‰ç‚¹æ··ä¹±ï¼Œä¸å¯èƒ½å®Œå…¨ä¸€è‡´ã€‚ä½†ä¾ç„¶æœ‰äº›æ™®éæ¨èçš„å‘½åè§„èŒƒçš„ã€‚æ–°çš„æ¨¡å—å’ŒåŒ… (åŒ…æ‹¬ç¬¬ä¸‰æ–¹çš„æ¡†æ¶) åº”è¯¥éµå¾ªè¿™äº›æ ‡å‡†ã€‚å¯¹ä¸åŒé£æ ¼çš„å·²æœ‰çš„åº“ï¼Œå»ºè®®ä¿æŒå†…éƒ¨çš„ä¸€è‡´æ€§ã€‚</p>
<ul>
<li>åŒ…å’Œæ¨¡å—å: æ¨¡å—åè¦ç®€çŸ­ï¼Œå…¨éƒ¨ç”¨å°å†™å­—æ¯ï¼Œå¯ä½¿ç”¨ä¸‹åˆ’çº¿ä»¥æé«˜å¯è¯»æ€§ã€‚åŒ…åå’Œæ¨¡å—åç±»ä¼¼ï¼Œä½†ä¸æ¨èä½¿ç”¨ä¸‹åˆ’çº¿</li>
<li>ç±»å: éµå¾ªCapWordã€‚</li>
<li>å‡½æ•°å’Œæ–¹æ³•çš„å‚æ•°: å®ä¾‹æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ â€˜selfâ€™ã€‚ç±»æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ â€˜clsâ€™ã€‚å¦‚æœå‡½æ•°çš„å‚æ•°åä¸ä¿ç•™å…³é”®å­—å†²çªï¼Œé€šå¸¸åœ¨å‚æ•°åååŠ ä¸€ä¸ªä¸‹åˆ’çº¿ã€‚</li>
<li>æ–¹æ³•åå’Œå®ä¾‹å˜é‡: åŒå‡½æ•°å‘½åè§„åˆ™ã€‚</li>
<li>éå…¬å¼€æ–¹æ³•å’Œå®ä¾‹å˜é‡å¢åŠ ä¸€ä¸ªå‰ç½®ä¸‹åˆ’çº¿ã€‚</li>
<li>ä¸ºé¿å…ä¸å­ç±»å‘½åå†²çªï¼Œé‡‡ç”¨ä¸¤ä¸ªå‰ç½®ä¸‹åˆ’çº¿æ¥è§¦å‘é‡æ•´ã€‚ç±»Fooå±æ€§åä¸º<code>__a</code>ï¼Œ ä¸èƒ½ä»¥ <code>Foo.__a</code>è®¿é—®ã€‚(æ‰§è‘—çš„ç”¨æˆ·è¿˜æ˜¯å¯ä»¥é€šè¿‡<code>Foo._Foo__a</code>ã€‚) é€šå¸¸åŒå‰ç½®ä¸‹åˆ’çº¿ä»…è¢«ç”¨æ¥é¿å…ä¸åŸºç±»çš„å±æ€§å‘ç”Ÿå‘½åå†²çªã€‚</li>
<li>å‡½æ•°å: å‡½æ•°ååº”è¯¥ä¸ºå°å†™ï¼Œå¿…è¦æ—¶å¯ç”¨ä¸‹åˆ’çº¿åˆ†éš”å•è¯ä»¥å¢åŠ å¯è¯»æ€§ã€‚ mixedCase(æ··åˆå¤§å°å†™)ä»…è¢«å…è®¸ç”¨äºå…¼å®¹æ€§è€ƒè™‘(å¦‚: threading.py)ã€‚</li>
<li>å¼‚å¸¸å: å¦‚æœç¡®å®æ˜¯é”™è¯¯ï¼Œéœ€è¦åœ¨ç±»åæ·»åŠ åç¼€ â€œErrorâ€ã€‚</li>
<li>å…¨å±€å˜é‡å: å˜é‡å°½é‡åªç”¨äºæ¨¡å—å†…éƒ¨ï¼Œçº¦å®šç±»ä¼¼å‡½æ•°ã€‚</li>
<li>å¯¹è®¾è®¡ä¸ºé€šè¿‡ â€œfrom M import â€ æ¥ä½¿ç”¨çš„æ¨¡å—ï¼Œåº”é‡‡ç”¨<code>__all__</code>æœºåˆ¶æ¥é˜²æ­¢å¯¼å…¥å…¨å±€å˜é‡ï¼›æˆ–è€…ä¸ºå…¨å±€å˜é‡åŠ ä¸€ä¸ªå‰ç½®ä¸‹åˆ’çº¿ã€‚</li>
<li>å¸¸é‡: å¸¸é‡é€šå¸¸åœ¨æ¨¡å—çº§å®šä¹‰,ç”±å¤§å†™å­—æ¯ç”¨ä¸‹åˆ’çº¿åˆ†éš”ç»„æˆã€‚æ¯”å¦‚æ‹¬MAX_OVERFLOWå’ŒTOTALã€‚</li>
</ul>
<h2 id="åˆç†çš„è®¾è®¡"><a href="#åˆç†çš„è®¾è®¡" class="headerlink" title="åˆç†çš„è®¾è®¡"></a>åˆç†çš„è®¾è®¡</h2><h3 id="æ¥å£è®¾è®¡"><a href="#æ¥å£è®¾è®¡" class="headerlink" title="æ¥å£è®¾è®¡"></a>æ¥å£è®¾è®¡</h3><p>è€ƒè™‘ç±»çš„æ–¹æ³•å’Œå®ä¾‹å˜é‡(ç»Ÿç§°ä¸ºå±æ€§)æ˜¯å¦å…¬å¼€ã€‚å¦‚æœæœ‰ç–‘é—®ï¼Œé€‰æ‹©ä¸å…¬å¼€ï¼›æŠŠå…¶æ”¹ä¸ºå…¬å¼€æ¯”æŠŠå…¬å¼€å±æ€§æ”¹ä¸ºéå…¬å¼€è¦å®¹æ˜“ã€‚<br>å…¬å¼€å±æ€§å¯ä¾›æ‰€æœ‰äººä½¿ç”¨ï¼Œå¹¶é€šå¸¸å‘åå…¼å®¹ã€‚éå…¬å¼€å±æ€§ä¸ç»™ç¬¬ä¸‰æ–¹ä½¿ç”¨ã€å¯å˜ç”šè‡³è¢«ç§»é™¤ã€‚<br>è¿™é‡Œä¸ä½¿ç”¨æœ¯è¯­â€privateâ€ï¼Œ Pythonä¸­æ²¡æœ‰å±æ€§æ˜¯çœŸæ­£ç§æœ‰çš„ã€‚<br>å¦ä¸€ç±»å±æ€§æ˜¯å­ç±»API(åœ¨å…¶ä»–è¯­è¨€ä¸­é€šå¸¸ç§°ä¸º â€œprotectedâ€)ã€‚ ä¸€äº›ç±»è¢«è®¾è®¡ä¸ºåŸºç±»ï¼Œå¯ä»¥æ‰©å±•å’Œä¿®æ”¹ã€‚</p>
<p>è°¨è®°è¿™äº›PythonæŒ‡å—ï¼š</p>
<ul>
<li>å…¬å¼€å±æ€§åº”è¯¥æ²¡æœ‰å‰å¯¼ä¸‹åˆ’çº¿</li>
<li>å¦‚æœå…¬å¼€å±æ€§åå’Œä¿ç•™å…³é”®å­—å†²çªï¼Œå¯ä»¥æ·»åŠ åç½®ä¸‹åˆ’çº¿</li>
<li>ç®€å•çš„å…¬å¼€æ•°æ®å±æ€§ï¼Œæœ€å¥½åªå…¬å¼€å±æ€§åï¼Œæ²¡æœ‰å¤æ‚çš„è®¿é—®/ä¿®æ”¹æ–¹æ³•ï¼Œpythonçš„Propertyæä¾›äº†å¾ˆå¥½çš„å°è£…æ–¹æ³•ã€‚ å¦‚æœä¸å¸Œæœ›å­ç±»ä½¿ç”¨çš„å±æ€§ï¼Œè€ƒè™‘ç”¨ä¸¤ä¸ªå‰ç½®ä¸‹åˆ’çº¿(æ²¡æœ‰åç½®ä¸‹åˆ’çº¿)å‘½å</li>
<li>ä»»ä½•å‘åå…¼å®¹çš„ä¿è¯åªé€‚ç”¨äºå…¬å…±æ¥å£ã€‚</li>
<li>æ–‡æ¡£åŒ–çš„æ¥å£é€šå¸¸æ˜¯å…¬å…±çš„ï¼Œé™¤éæ˜è¯´æ˜æ˜¯ä¸´æ—¶çš„æˆ–ä¸ºå†…éƒ¨æ¥å£ã€å…¶ä»–æ‰€æœ‰æ¥å£é»˜è®¤æ˜¯å†…éƒ¨çš„ã€‚</li>
<li>ä¸ºäº†æ›´å¥½åœ°æ”¯æŒå†…çœï¼Œæ¨¡å—è¦åœ¨<code>__all__</code>å±æ€§åˆ—å‡ºå…¬å…±APIã€‚</li>
<li>å†…éƒ¨æ¥å£è¦æœ‰å‰ç½®ä¸‹åˆ’çº¿ã€‚</li>
<li>å¦‚æœå‘½åç©ºé—´(åŒ…ã€æ¨¡å—æˆ–ç±»)æ˜¯å†…éƒ¨çš„ï¼Œé‡Œé¢çš„æ¥å£ä¹Ÿæ˜¯å†…éƒ¨çš„ã€‚</li>
<li>å¯¼å…¥åç§°åº”è§†ä¸ºå®ç°ç»†èŠ‚ã€‚å…¶ä»–æ¨¡å—ä¸èƒ½é—´æ¥è®¿åå­—ï¼Œé™¤éåœ¨æ¨¡å—çš„APIæ–‡æ¡£ä¸­æ˜ç¡®è®°è½½ï¼Œå¦‚os.pathä¸­æˆ–åŒ…çš„<code>__init__</code>æš´éœ²äº†å­æ¨¡å—ã€‚</li>
</ul>
<h3 id="å‡½æ•°è®¾è®¡"><a href="#å‡½æ•°è®¾è®¡" class="headerlink" title="å‡½æ•°è®¾è®¡"></a>å‡½æ•°è®¾è®¡</h3><p>å½“æµç¨‹è¶³å¤Ÿç¹æ‚æ—¶ï¼Œå°±è¦è€ƒè™‘å‡½æ•°ï¼ŒåŠå¦‚ä½•å°†å‡½æ•°ç»„åˆåœ¨ä¸€èµ·ã€‚åœ¨Pythonä¸­åšå‡½æ•°è®¾è®¡ï¼Œä¸»è¦è€ƒè™‘åˆ°å‡½æ•°å¤§å°ã€èšåˆæ€§ã€è€¦åˆæ€§ä¸‰ä¸ªæ–¹é¢ï¼Œè¿™ä¸‰è€…åº”è¯¥å½’ç»“äºè§„åˆ’ä¸è®¾è®¡çš„èŒƒç•´ã€‚é«˜å†…èšã€ä½è€¦åˆåˆ™æ˜¯ä»»ä½•è¯­è¨€å‡½æ•°è®¾è®¡çš„æ€»ä½“åŸåˆ™ã€‚</p>
<ul>
<li>å¦‚ä½•å°†ä»»åŠ¡åˆ†è§£æˆæ›´æœ‰é’ˆå¯¹æ€§çš„å‡½æ•°ä»è€Œå¯¼è‡´äº†èšåˆæ€§</li>
<li>å¦‚ä½•è®¾è®¡å‡½æ•°é—´çš„é€šä¿¡åˆ™åˆæ¶‰åŠåˆ°è€¦åˆæ€§</li>
<li>å¦‚ä½•è®¾è®¡å‡½æ•°çš„å¤§å°ç”¨ä»¥åŠ å¼ºå…¶èšåˆæ€§åŠé™ä½å…¶è€¦åˆæ€§</li>
</ul>
<p>èšåˆ</p>
<ul>
<li>å®Œç¾çš„ç¨‹åºè®¾è®¡ï¼Œæ¯ä¸ªå‡½æ•°åº”è¯¥è€Œä¸”åªéœ€åšä¸€ä»¶äº‹</li>
<li>æ¯”å¦‚è¯´:æŠŠå¤§è±¡æ”¾è¿›å†°ç®±åˆ†ä¸‰æ­¥:æŠŠé—¨æ‰“å¼€ã€æŠŠå¤§è±¡æ”¾è¿›å»ã€æŠŠé—¨å…³ä¸Šã€‚</li>
<li>è¿™æ ·å°±åº”è¯¥å†™ä¸‰ä¸ªå‡½æ•°è€Œä¸æ˜¯ä¸€ä¸ªå‡½æ•°æ‹¿æ‰€æœ‰çš„äº‹å…¨åšäº†ã€‚è¿™æ ·ç»“æ„æ¸…æ™°ï¼Œå±‚æ¬¡åˆ†æ˜ï¼Œä¹Ÿå¥½ç†è§£ï¼</li>
</ul>
<p>å¤§å°</p>
<ul>
<li>Pythonä»£ç ä»¥ç®€å•æ˜äº†è‘—ç§°ï¼Œä¸€ä¸ªè¿‡é•¿æˆ–è€…æœ‰ç€æ·±å±‚åµŒå¥—çš„å‡½æ•°å¾€å¾€æˆä¸ºè®¾è®¡ç¼ºé™·çš„å¾å…†ã€‚</li>
<li>å¦‚æœé¡¹ç›®ä¸­è®¾è®¡çš„ä¸€ä¸ªå‡½æ•°éœ€è¦ç¿»é¡µæ‰èƒ½çœ‹å®Œçš„è¯ï¼Œå°±è¦è€ƒè™‘å°†å‡½æ•°æ‹†åˆ†äº†ã€‚</li>
</ul>
<p>è€¦åˆ</p>
<ul>
<li>å‚æ•°ä¼ å…¥ï¼Œreturnç»“æœ, è¿™æ ·åšå¯ä»¥è®©å‡½æ•°ç‹¬ç«‹äºå®ƒå¤–éƒ¨çš„ä¸œè¥¿ã€‚å‚æ•°å’Œreturnè¯­å¥å°±æ˜¯éš”ç¦»å¤–éƒ¨ä¾èµ–çš„æœ€å¥½çš„åŠæ³•ã€‚</li>
<li>æ…ç”¨å…¨å±€å˜é‡, å…¨å±€å˜é‡é€šå¸¸æ˜¯ä¸€ç§è¹©è„šçš„å‡½æ•°é—´çš„è¿›è¡Œé€šä¿¡çš„æ–¹å¼ã€‚å®ƒä¼šå¼•å‘ä¾èµ–å…³ç³»å’Œè®¡æ—¶çš„é—®é¢˜ï¼Œä»è€Œä¼šå¯¼è‡´ç¨‹åºè°ƒè¯•å’Œä¿®æ”¹çš„å›°éš¾ã€‚è€Œä¸”ä»ä»£ç åŠæ€§èƒ½ä¼˜åŒ–æ¥è€ƒè™‘ï¼Œæœ¬åœ°å˜é‡è¿œæ¯”å…¨å±€å˜é‡å¿«ã€‚</li>
<li>é¿å…ä¿®æ”¹å¯å˜ç±»å‹çš„å‚æ•°ï¼ˆæˆ–è€…ç›´æ¥é¿å…ä¼ å…¥å¯å˜ç±»å‹çš„å‚æ•°ï¼Œè€Œä½¿ç”¨<em>argsï¼Œ æˆ–è€…*</em>kwargs æ”¶é›†ï¼‰Pythonæ•°æ®ç±»å‹æ¯”å¦‚è¯´åˆ—è¡¨ã€å­—å…¸å±äºå¯å˜å¯¹è±¡ã€‚åœ¨ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°æ—¶ï¼Œæœ‰æ—¶ä¼šåƒå…¨å±€å˜é‡ä¸€æ ·è¢«ä¿®æ”¹ã€‚è¿™æ ·åšçš„åå¤„æ˜¯ï¼šå¢å¼ºäº†å‡½æ•°ä¹‹é—´çš„è€¦åˆæ€§ï¼Œä»è€Œå¯¼è‡´å‡½æ•°è¿‡äºç‰¹æ®Šå’Œä¸å‹å¥½ã€‚ç»´æŠ¤èµ·æ¥ä¹Ÿå›°éš¾ã€‚è¿™ä¸ªæ—¶å€™å°±è¦è€ƒè™‘ä½¿ç”¨åˆ‡ç‰‡S[:]å’Œcopyæ¨¡å—ä¸­çš„copy()å‡½æ•°å’Œdeepcopy()å‡½æ•°æ¥åšä¸ªæ‹·è´ï¼Œé¿å…ä¿®æ”¹å¯å˜å¯¹è±¡</li>
</ul>
<h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><ul>
<li><a href="https://www.python.org/dev/peps/pep-0008/" target="_blank" rel="external">PEP8å®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://my.oschina.net/u/1433482/blog/464444" target="_blank" rel="external">PEP8ä¸­æ–‡ç¿»è¯‘</a></li>
<li><a href="http://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/background/" target="_blank" rel="external">Google Pythoné£æ ¼æŒ‡å—</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åšé¡¹ç›®ä¸€ç›´ä½¿ç”¨Golang, è·ç¦»ä¸Šæ¬¡ä½¿ç”¨Pythonå·²ç»åŠå¹´ä¹‹ä¹…äº†, å¯¹äºGoæ¥è¯´æœ‰fmtå¸®å¿™æ ¼å¼åŒ–, è§£å†³äº†ç»å¤§éƒ¨åˆ†ç¼–ç é£æ ¼é—®é¢˜, è€ŒPythonåˆ™éœ€è¦è‡ªå·±æ³¨æ„,æ ¹æ®å®˜æ–¹æŒ‡å¯¼PEP8æˆ–è€…ä¸€äº›æœ€ä½³å®è·µæ¯”å¦‚Google Styleæ¥æ§åˆ¶é£æ ¼ã€‚æ—¶é—´ä¹…äº† ä¸€äº›ç»†èŠ‚éƒ¨åˆ†å°±å¿˜è®°äº†, äºæ˜¯ç¿»é˜…ä¹‹å‰å†™çš„åšå®¢, å—ç›Šè‰¯å¤š, äºæ˜¯æ‰“ç®—æŠŠä¹‹å‰çš„è¿™å‡ ç¯‡åšå®¢è¿ç§»è¿‡æ¥, é¡ºä¾¿æ›´æ–°, æ–¹ä¾¿ä»¥åæŸ¥é˜…ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Python" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Python/"/>
    
    
      <category term="pythonic" scheme="https://blog.yumaojun.net/tags/pythonic/"/>
    
  </entry>
  
  <entry>
    <title>MySQLæ‰¹é‡æ›´æ–°ä¸æ’å…¥</title>
    <link href="https://blog.yumaojun.net/2017/06/19/mysql-performance-for-bulk-action/"/>
    <id>https://blog.yumaojun.net/2017/06/19/mysql-performance-for-bulk-action/</id>
    <published>2017-06-19T02:09:57.000Z</published>
    <updated>2017-06-21T06:24:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ä¸€ç›´ä½¿ç”¨gormæ¥æ“ä½œæ•°æ®åº“, ä½†å½“é‡åˆ°ä¸€äº›æ‰¹é‡æ“ä½œæ—¶,æ„Ÿè§‰æ€§èƒ½å¾ˆå·®, åŸå› å¾ˆç®€å•, gormæ˜¯ä¸€æ¡ä¸€æ¡çš„æ‰§è¡Œçš„,æ•ˆç‡å¾ˆä½, æ‰€ä»¥å¯¹äºæ‰¹é‡æ“ä½œ, ç‰¹åˆ«æ˜¯å¯¹äºå¤§é‡recordéœ€è¦åˆ›å»ºæˆ–è€…ä¿®æ”¹æ—¶, ç›´æ¥ä½¿ç”¨SQL, æ‰æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚<br><a id="more"></a></p>
<h2 id="è°ƒæ•´MySQLé…ç½®-MariaDB10"><a href="#è°ƒæ•´MySQLé…ç½®-MariaDB10" class="headerlink" title="è°ƒæ•´MySQLé…ç½®(MariaDB10)"></a>è°ƒæ•´MySQLé…ç½®(MariaDB10)</h2><ul>
<li>bulk_insert_buffer_size: è°ƒæ•´æ‰¹é‡æ’å…¥ç¼“å†²ï¼Œ é»˜è®¤æ˜¯16M, ä¸ºäº†èƒ½æ”¯æŒæ›´å¤§æ•°æ®çš„æ‰¹é‡æ’å…¥, æŒ‰éœ€è°ƒæ•´, æˆ‘è¿™é‡Œè°ƒæ•´åˆ°128M</li>
<li>net_buffer_length: å®¢æˆ·å‘å‡ºçš„SQLè¯­å¥æœŸæœ›çš„é•¿åº¦, é»˜è®¤æ˜¯16Kã€‚å¦‚æœè¯­å¥è¶…è¿‡è¿™ä¸ªé•¿åº¦ï¼Œç¼“å†²åŒºè‡ªåŠ¨åœ°è¢«æ‰©å¤§ï¼Œç›´åˆ°max_allowed_packetä¸ªå­—èŠ‚, æˆ‘è°ƒæ•´åˆ°128K</li>
<li>max_allowed_packet: ä¸€ä¸ªåŒ…çš„æœ€å¤§å°ºå¯¸, é»˜è®¤ä¹Ÿæ˜¯16Mã€‚æ¶ˆæ¯ç¼“å†²åŒºè¢«åˆå§‹åŒ–ä¸ºnet_buffer_lengthå­—èŠ‚ï¼Œä½†æ˜¯å¯åœ¨éœ€è¦æ—¶å¢åŠ åˆ°max_allowed_packetä¸ªå­—èŠ‚, æˆ‘ä¹Ÿè°ƒæ•´åˆ°128M</li>
</ul>
<p>å°†è¿™äº›é…ç½®å†™å…¥MySQLçš„é…ç½®æ–‡ä»¶ä¸­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bulk_insert_buffer_size = 128M</div><div class="line">net_buffer_length = 128K</div><div class="line">max_allowed_packet = 128M</div></pre></td></tr></table></figure></p>
<p>ä»å¯MySQLæŸ¥çœ‹è¿™äº›å…¨å±€å˜é‡æ˜¯å¦ç”Ÿæ•ˆ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</div><div class="line">Your MariaDB connection id is 142</div><div class="line">Server version: 10.1.21-MariaDB-1~jessie mariadb.org binary distribution</div><div class="line"></div><div class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</div><div class="line"></div><div class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> to clear the current input statement.</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; show variables like <span class="string">"bulk_insert_buffer_size"</span>;</div><div class="line">+-------------------------+----------+</div><div class="line">| Variable_name           | Value    |</div><div class="line">+-------------------------+----------+</div><div class="line">| bulk_insert_buffer_size | 16777216 |</div><div class="line">+-------------------------+----------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; show variables like <span class="string">"net_buffer_length"</span>;</div><div class="line">+-------------------+-------+</div><div class="line">| Variable_name     | Value |</div><div class="line">+-------------------+-------+</div><div class="line">| net_buffer_length | 16384 |</div><div class="line">+-------------------+-------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; show variables like <span class="string">"max_allowed_packet"</span>;</div><div class="line">+--------------------+----------+</div><div class="line">| Variable_name      | Value    |</div><div class="line">+--------------------+----------+</div><div class="line">| max_allowed_packet | 16777216 |</div><div class="line">+--------------------+----------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure></p>
<h2 id="ä½¿ç”¨äº‹åŠ¡"><a href="#ä½¿ç”¨äº‹åŠ¡" class="headerlink" title="ä½¿ç”¨äº‹åŠ¡"></a>ä½¿ç”¨äº‹åŠ¡</h2><p>æ‰¹é‡åˆ›å»ºå’Œä¿®æ”¹å¤šæ¡è®°å½•æ—¶, å¦‚æœä½¿ç”¨äº†å¤šæ¡è¯­å¥, è¯·ä¸€å®šä½¿ç”¨äº‹ç‰©, å› ä¸ºè¿™äº›åŠ¨ä½œæ˜¯ä¸€ä¸ªäº‹ç‰©, é¿å…éƒ¨åˆ†æˆåŠŸ,éƒ¨åˆ†å¤±è´¥ é€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tx,_ := db.Begin()  </div><div class="line">stm,_ := Tx.Preapare(<span class="string">"insert into test values(?,null)"</span>)  </div><div class="line">result,err := stm.Exec(<span class="string">'123'</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">    tx.Commit()</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    tx.Rollback()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="æ‰¹é‡æ’å…¥"><a href="#æ‰¹é‡æ’å…¥" class="headerlink" title="æ‰¹é‡æ’å…¥"></a>æ‰¹é‡æ’å…¥</h2><p>æ‰¹é‡æ’å…¥çš„æ–¹æ³•ä¸€èˆ¬åŒ…å«: </p>
<ul>
<li>ç›´æ¥å¾ªç¯æä¾›(éå¸¸ä¸æ¨è)</li>
<li>åŸºäºäº‹ç‰©çš„å¾ªç¯æäº¤</li>
<li>åˆ©ç”¨INSERT INTOçš„å¤šå€¼æ’å…¥è¯­å¥</li>
</ul>
<p>è¿™é‡Œä»¥æ’å…¥10000æ¡æ•°æ®ä¸ºä¾‹è¿›è¡Œæµ‹è¯•, å…³äºä¸‹é¢çš„æµ‹è¯•ä»£ç è§: <a href="https://github.com/yumaojun03/golang/blob/master/mysql/bulk_perf_test.go" target="_blank" rel="external">æµ‹è¯•ä»£ç å®Œæ•´ç¤ºä¾‹</a></p>
<h3 id="ç›´æ¥å¾ªç¯æäº¤"><a href="#ç›´æ¥å¾ªç¯æäº¤" class="headerlink" title="ç›´æ¥å¾ªç¯æäº¤"></a>ç›´æ¥å¾ªç¯æäº¤</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ä½¿ç”¨Forå¾ªç¯æ‰§è¡Œ</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">forInsert</span><span class="params">()</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line"></div><div class="line">	stmt, err := db.Prepare(<span class="string">`INSERT user (user_name,user_age,user_sex) values (?,?,?)`</span>)</div><div class="line">	checkErr(err)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</div><div class="line">		name := <span class="string">"tony"</span> + strconv.Itoa(i)</div><div class="line">		_, err := stmt.Exec(name, i, <span class="number">1</span>)</div><div class="line">		checkErr(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	delta := time.Now().Sub(start).String()</div><div class="line">	fmt.Println(<span class="string">"For Insert Total Time: "</span>, delta)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="åŸºäºäº‹ç‰©å¾ªç¯æäº¤"><a href="#åŸºäºäº‹ç‰©å¾ªç¯æäº¤" class="headerlink" title="åŸºäºäº‹ç‰©å¾ªç¯æäº¤"></a>åŸºäºäº‹ç‰©å¾ªç¯æäº¤</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åœ¨ä¸€ä¸ªäº‹ç‰©å†…å¾ªç¯æ‰§è¡Œ</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">withTxInsert</span><span class="params">()</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line"></div><div class="line">	tx, err := db.Begin()</div><div class="line">	checkErr(err)</div><div class="line"></div><div class="line">	stmt, err := tx.Prepare(<span class="string">`INSERT user (user_name,user_age,user_sex) values (?,?,?)`</span>)</div><div class="line">	checkErr(err)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</div><div class="line">		name := <span class="string">"tony"</span> + strconv.Itoa(i)</div><div class="line">		_, err := stmt.Exec(name, i, <span class="number">1</span>)</div><div class="line">		checkErr(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		err := tx.Rollback()</div><div class="line">		checkErr(err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	err = tx.Commit()</div><div class="line">	checkErr(err)</div><div class="line"></div><div class="line">	delta := time.Now().Sub(start).String()</div><div class="line">	fmt.Println(<span class="string">"Bulk With Transaction Insert Total Time: "</span>, delta)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ„é€ æˆä¸€æ¡è¯­å¥æäº¤"><a href="#æ„é€ æˆä¸€æ¡è¯­å¥æäº¤" class="headerlink" title="æ„é€ æˆä¸€æ¡è¯­å¥æäº¤"></a>æ„é€ æˆä¸€æ¡è¯­å¥æäº¤</h3><p>SQLæ ·ä¾‹: â€œINSERT INTO table (field1,field2,field3) VALUES (â€˜aâ€™,â€™bâ€™,â€™câ€™), (â€˜aâ€™,â€™bâ€™,â€™câ€™),(â€˜aâ€™,â€™bâ€™,â€™câ€™);â€<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ„é€ ä¸€æ¡Insertè¯­å¥æ‰¹é‡æäº¤</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">bulkoneInsert</span><span class="params">()</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line"></div><div class="line">	sql := <span class="string">"INSERT INTO `user` (`user_name`,`user_age`,`user_sex`) VALUES "</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</div><div class="line">		name := <span class="string">"tony"</span> + strconv.Itoa(i)</div><div class="line">		<span class="keyword">if</span> i &lt; <span class="number">10000</span> &#123;</div><div class="line">			sql += fmt.Sprintf(<span class="string">"('%s','%d','%d'),"</span>, name, i, <span class="number">1</span>)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			sql += fmt.Sprintf(<span class="string">"('%s','%d','%d');"</span>, name, i, <span class="number">1</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// fmt.Println(sql)</span></div><div class="line">	tx, err := db.Begin()</div><div class="line">	checkErr(err)</div><div class="line">	_, err = tx.Exec(sql)</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		tx.Commit()</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">		tx.Rollback()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	delta := time.Now().Sub(start).String()</div><div class="line">	fmt.Println(<span class="string">"Bulk One Insert Total Time: "</span>, delta)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ€å¯¹3ç§çŠ¶å†µçš„æ’å…¥æ—¶é—´æ’å:</p>
<table>
<thead>
<tr>
<th>Ranking</th>
<th style="text-align:center">Function Name</th>
<th style="text-align:center">Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align:center">bulkoneInsert</td>
<td style="text-align:center">283.548003ms</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:center">withTxInsert</td>
<td style="text-align:center">4.047390845s</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:center">forInsert</td>
<td style="text-align:center">1m55.580310398s</td>
</tr>
</tbody>
</table>
<p>ç»“è®ºå¾ˆæ˜æ˜¾: <strong>æ„é€ ä¸€æ¡SQLæ’å…¥æ•ˆç‡é«˜å¾ˆå¤š</strong></p>
<h2 id="æ‰¹é‡æ›´æ–°"><a href="#æ‰¹é‡æ›´æ–°" class="headerlink" title="æ‰¹é‡æ›´æ–°"></a>æ‰¹é‡æ›´æ–°</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ª<code>UPDATE</code>è¯­å¥æ‰¹é‡æäº¤, åŒæ—¶MySQLä¹Ÿæ”¯æŒä¸€ä¸ªSQLè¯­å¥æ‰¹é‡æ›´æ–°å¤šæ¡è®°å½•, æ ‡å‡†çš„SQLæ˜¯ä½¿ç”¨<code>UPDATE WHEN</code>æ¥å®ç°, é™¤æ­¤ä¹‹å¤– ä»–çš„SQLæ‰©å±•è¿˜æ”¯æŒ<code>INSERT INTO</code> å’Œ<code>REPLACE INTO</code>ç”¨äºrecordçš„æ‰¹é‡æ›´æ–°, ä½†æ˜¯æœ€å¥½åˆ«ç”¨REPLACE INTO, å› ä¸ºä»–æ˜¯å…ˆåˆ é™¤å†æ–°å¢, å› æ­¤æœ¬è´¨ä¸Šå®ƒä¸æ˜¯æ›´æ–°æ“ä½œ, <code>å› ä¸ºåˆ é™¤å, æ›´æ–°æ—¶ç¼ºå°‘æŸäº›å­—æ®µçš„è¯, ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±, è¿™åœ¨ä¸šåŠ¡ä¸Šæ˜¯ç»å¯¹ä¸å…è®¸çš„, è¯·è°¨æ…ä½¿ç”¨ REPLACE INTO</code>ã€‚è€ŒINSERT INTOåˆ™ä¸ä¼šè¿™æ ·ã€‚ æœ€åä½¿ç”¨ä¸´æ—¶è¡¨ä¹Ÿèƒ½è¿›è¡Œæ‰¹é‡æ›´æ–°(å…ˆæ›´æ–°ä¸´æ—¶è¡¨ï¼Œç„¶åä»ä¸´æ—¶è¡¨ä¸­update),æ•ˆç‡ä¹Ÿç›¸å½“ä¸é”™,ä½†æ˜¯éœ€è¦ç”¨æˆ·æœ‰temporaryè¡¨çš„createæƒé™, å› æ­¤ä½¿ç”¨ä¹Ÿå—é™ã€‚<br>æˆ‘ä¸€èˆ¬ä¼šä½¿ç”¨INSERT INTOæ¥æ„é€ æ‰¹é‡æ›´æ–°çš„SQL, å› ä¸ºè¯¥è¯­æ³•æ–¹ä¾¿æ„é€ , ä¸‹é¢ä¼šå¯¹å„ç§æ“ä½œåšç®€å•çš„æ€§èƒ½å¯¹æ¯”ã€‚</p>
<p>è¿™é‡Œä»¥æ›´æ–°10000æ¡æ•°æ®ä¸ºä¾‹è¿›è¡Œæµ‹è¯•(åŸºäºä¸Šé¢æ’å…¥çš„æ•°æ®), å…³äºä¸‹é¢çš„æµ‹è¯•ä»£ç è§: <a href="https://github.com/yumaojun03/golang/blob/master/mysql/bulk_perf_test.go" target="_blank" rel="external">æµ‹è¯•ä»£ç å®Œæ•´ç¤ºä¾‹</a></p>
<h3 id="å¾ªç¯æ›´æ–°"><a href="#å¾ªç¯æ›´æ–°" class="headerlink" title="å¾ªç¯æ›´æ–°"></a>å¾ªç¯æ›´æ–°</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å¾ªç¯æ›´æ–°</span></div><div class="line"><span class="comment">// UPDATE table SET column1=?,column2=? WHERE column=?</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">withTxUpdate</span><span class="params">()</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line"></div><div class="line">	tx, err := db.Begin()</div><div class="line">	checkErr(err)</div><div class="line"></div><div class="line">	stmt, err := tx.Prepare(<span class="string">"UPDATE `user` SET `user_name`=? WHERE `user_id`=?;"</span>)</div><div class="line">	checkErr(err)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</div><div class="line">		name := <span class="string">"forupdate"</span> + strconv.Itoa(i)</div><div class="line">		_, err := stmt.Exec(name, i+<span class="number">1</span>)</div><div class="line">		checkErr(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		err := tx.Rollback()</div><div class="line">		checkErr(err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	err = tx.Commit()</div><div class="line">	checkErr(err)</div><div class="line"></div><div class="line">	delta := time.Now().Sub(start).String()</div><div class="line">	fmt.Println(<span class="string">"Bulk With Transaction Update Total Time: "</span>, delta)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ ‡å‡†çš„UPDATEè¯­å¥æ‰¹é‡æ›´æ–°"><a href="#æ ‡å‡†çš„UPDATEè¯­å¥æ‰¹é‡æ›´æ–°" class="headerlink" title="æ ‡å‡†çš„UPDATEè¯­å¥æ‰¹é‡æ›´æ–°"></a>æ ‡å‡†çš„UPDATEè¯­å¥æ‰¹é‡æ›´æ–°</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ ‡å‡†Updateè¯­å¥æ›´æ–°</span></div><div class="line"><span class="comment">// UPDATE categories</span></div><div class="line"><span class="comment">//     SET dingdan = CASE id</span></div><div class="line"><span class="comment">//         WHEN 1 THEN 3</span></div><div class="line"><span class="comment">//         WHEN 2 THEN 4</span></div><div class="line"><span class="comment">//         WHEN 3 THEN 5</span></div><div class="line"><span class="comment">//     END,</span></div><div class="line"><span class="comment">//     title = CASE id</span></div><div class="line"><span class="comment">//         WHEN 1 THEN 'New Title 1'</span></div><div class="line"><span class="comment">//         WHEN 2 THEN 'New Title 2'</span></div><div class="line"><span class="comment">//         WHEN 3 THEN 'New Title 3'</span></div><div class="line"><span class="comment">//     END</span></div><div class="line"><span class="comment">// WHERE id IN (1,2,3)</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">bulkStandardUpdate</span><span class="params">()</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line"></div><div class="line">	core := <span class="string">""</span></div><div class="line">	where := <span class="string">""</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</div><div class="line">		name := <span class="string">"standardupdate"</span> + strconv.Itoa(i)</div><div class="line">		core += fmt.Sprintf(<span class="string">"WHEN '%d' THEN '%s' "</span>, i+<span class="number">1</span>, name)</div><div class="line">		<span class="keyword">if</span> i == <span class="number">0</span> &#123;</div><div class="line">			where += fmt.Sprintf(<span class="string">"'%d'"</span>, i+<span class="number">1</span>)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			where += fmt.Sprintf(<span class="string">",'%d'"</span>, i+<span class="number">1</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sql := fmt.Sprintf(<span class="string">"UPDATE `user` SET `user_name`= CASE `user_id` %s END WHERE `user_id` IN (%s)"</span>, core, where)</div><div class="line"></div><div class="line">	tx, err := db.Begin()</div><div class="line">	checkErr(err)</div><div class="line">	_, err = tx.Exec(sql)</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		tx.Commit()</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">		tx.Rollback()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	delta := time.Now().Sub(start).String()</div><div class="line">	fmt.Println(<span class="string">"Bulk Standard Update Total Time: "</span>, delta)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SQLæ‰©å±•-INSERT-INTO-â€¦-ON-DUPLICATE-KEY-UPDATE"><a href="#SQLæ‰©å±•-INSERT-INTO-â€¦-ON-DUPLICATE-KEY-UPDATE" class="headerlink" title="SQLæ‰©å±•(INSERT INTO â€¦ ON DUPLICATE KEY UPDATE)"></a>SQLæ‰©å±•(INSERT INTO â€¦ ON DUPLICATE KEY UPDATE)</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// insert intoè¯­å¥æ›´æ–°</span></div><div class="line"><span class="comment">// INSERT INTO test_tbl (id,dr) VALUES (1,'2'),(2,'3'),...(x,'y') ON DUPLICATE KEY UPDATE dr=values(dr);</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">bulkInsertIntoUpdate</span><span class="params">()</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line"></div><div class="line">	core := <span class="string">""</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</div><div class="line">		name := <span class="string">"insertintoupdate"</span> + strconv.Itoa(i)</div><div class="line">		<span class="keyword">if</span> i == <span class="number">0</span> &#123;</div><div class="line">			core += fmt.Sprintf(<span class="string">"('%d', '%s')"</span>, i+<span class="number">1</span>, name)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			core += fmt.Sprintf(<span class="string">",('%d', '%s')"</span>, i+<span class="number">1</span>, name)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sql := fmt.Sprintf(<span class="string">"INSERT INTO `user` (`user_id`, `user_name`) VALUES %s ON DUPLICATE KEY UPDATE `user_name`=values(`user_name`);"</span>, core)</div><div class="line"></div><div class="line">	tx, err := db.Begin()</div><div class="line">	checkErr(err)</div><div class="line">	_, err = tx.Exec(sql)</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		tx.Commit()</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">		tx.Rollback()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	delta := time.Now().Sub(start).String()</div><div class="line">	fmt.Println(<span class="string">"Bulk Insert Into Update Total Time: "</span>, delta)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SQLæ‰©å±•-REPLACE-INTO"><a href="#SQLæ‰©å±•-REPLACE-INTO" class="headerlink" title="SQLæ‰©å±•(REPLACE INTO)"></a>SQLæ‰©å±•(REPLACE INTO)</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// replace inotè¯­å¥æ›´æ–°</span></div><div class="line"><span class="comment">// REPLACE INTO test_tbl (id,dr) VALUES (1,'2'),(2,'3'),...(x,'y');</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">bulkReplaceIntoUpdate</span><span class="params">()</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line"></div><div class="line">	core := <span class="string">""</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</div><div class="line">		name := <span class="string">"replaceintoupdate"</span> + strconv.Itoa(i)</div><div class="line">		<span class="keyword">if</span> i == <span class="number">0</span> &#123;</div><div class="line">			core += fmt.Sprintf(<span class="string">"('%d', '%s')"</span>, i+<span class="number">1</span>, name)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			core += fmt.Sprintf(<span class="string">",('%d', '%s')"</span>, i+<span class="number">1</span>, name)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sql := fmt.Sprintf(<span class="string">"REPLACE INTO `user` (`user_id`, `user_name`) VALUES %s;"</span>, core)</div><div class="line"></div><div class="line">	tx, err := db.Begin()</div><div class="line">	checkErr(err)</div><div class="line">	_, err = tx.Exec(sql)</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		tx.Commit()</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">		tx.Rollback()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	delta := time.Now().Sub(start).String()</div><div class="line">	fmt.Println(<span class="string">"Bulk Replace Into Update Total Time: "</span>, delta)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ€å¯¹4ç§çŠ¶å†µçš„æ’å…¥æ—¶é—´æ’å:</p>
<table>
<thead>
<tr>
<th>Ranking</th>
<th style="text-align:center">Function Name</th>
<th style="text-align:center">Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align:center">bulkInsertIntoUpdate</td>
<td style="text-align:center">462.575115ms</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:center">bulkReplaceIntoUpdate</td>
<td style="text-align:center">564.974107ms</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:center">bulkStandardUpdate</td>
<td style="text-align:center">3.160858907s</td>
</tr>
<tr>
<td>4</td>
<td style="text-align:center">withTxUpdate</td>
<td style="text-align:center">3.998437161s</td>
</tr>
</tbody>
</table>
<p>ç»“è®ºå¾ˆæ˜æ˜¾: <strong>InsertIntoæ›´æ–°æ•ˆç‡é«˜å¾ˆå¤š</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘ä¸€ç›´ä½¿ç”¨gormæ¥æ“ä½œæ•°æ®åº“, ä½†å½“é‡åˆ°ä¸€äº›æ‰¹é‡æ“ä½œæ—¶,æ„Ÿè§‰æ€§èƒ½å¾ˆå·®, åŸå› å¾ˆç®€å•, gormæ˜¯ä¸€æ¡ä¸€æ¡çš„æ‰§è¡Œçš„,æ•ˆç‡å¾ˆä½, æ‰€ä»¥å¯¹äºæ‰¹é‡æ“ä½œ, ç‰¹åˆ«æ˜¯å¯¹äºå¤§é‡recordéœ€è¦åˆ›å»ºæˆ–è€…ä¿®æ”¹æ—¶, ç›´æ¥ä½¿ç”¨SQL, æ‰æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘è¯­è¨€" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
      <category term="Golang" scheme="https://blog.yumaojun.net/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Golang/"/>
    
    
      <category term="MySQL" scheme="https://blog.yumaojun.net/tags/MySQL/"/>
    
  </entry>
  
</feed>
